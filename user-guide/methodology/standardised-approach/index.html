
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Documentation for the UK Credit Risk RWA Calculator - supporting CRR and Basel 3.1 frameworks" name="description"/>
<meta content="OpenAfterHours" name="author"/>
<link href="../" rel="prev"/>
<link href="../irb-approach/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Standardised Approach - UK Credit Risk RWA Calculator</title>
<link href="../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../assets/_mkdocstrings.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#standardised-approach">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="UK Credit Risk RWA Calculator" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="UK Credit Risk RWA Calculator">
<img alt="logo" src="../../../assets/openafterhours-logo.svg"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            UK Credit Risk RWA Calculator
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Standardised Approach
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/OpenAfterHours/rwa_calculator" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../getting-started/">
          
  
  
    
  
  Getting Started

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
    
  
  User Guide

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../architecture/">
          
  
  
    
  
  Architecture

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../data-model/">
          
  
  
    
  
  Data Model

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../api/">
          
  
  
    
  
  API Reference

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../development/">
          
  
  
    
  
  Development

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../appendix/">
          
  
  
    
  
  Appendix

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="UK Credit Risk RWA Calculator" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="UK Credit Risk RWA Calculator">
<img alt="logo" src="../../../assets/openafterhours-logo.svg"/>
</a>
    UK Credit Risk RWA Calculator
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/OpenAfterHours/rwa_calculator" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../getting-started/">
<span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting-started/installation/">
<span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting-started/quickstart/">
<span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../getting-started/concepts/">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../interactive-ui/">
<span class="md-ellipsis">
    
  
    Interactive UI
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../regulatory/">
<span class="md-ellipsis">
    
  
    Regulatory Frameworks
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Regulatory Frameworks
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../regulatory/crr/">
<span class="md-ellipsis">
    
  
    CRR (Basel 3.0)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../regulatory/basel31/">
<span class="md-ellipsis">
    
  
    Basel 3.1
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../regulatory/comparison/">
<span class="md-ellipsis">
    
  
    Framework Comparison
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    Calculation Methodology
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            
  
    Calculation Methodology
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Standardised Approach
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Standardised Approach
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#risk-weight-determination">
<span class="md-ellipsis">
      
        Risk Weight Determination
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credit-quality-steps-cqs">
<span class="md-ellipsis">
      
        Credit Quality Steps (CQS)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#risk-weights-by-exposure-class">
<span class="md-ellipsis">
      
        Risk Weights by Exposure Class
      
    </span>
</a>
<nav aria-label="Risk Weights by Exposure Class" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sovereign-exposures">
<span class="md-ellipsis">
      
        Sovereign Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#institution-exposures">
<span class="md-ellipsis">
      
        Institution Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#corporate-exposures">
<span class="md-ellipsis">
      
        Corporate Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#retail-exposures">
<span class="md-ellipsis">
      
        Retail Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#defaulted-exposures">
<span class="md-ellipsis">
      
        Defaulted Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#equity-exposures">
<span class="md-ellipsis">
      
        Equity Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#commercial-real-estate">
<span class="md-ellipsis">
      
        Commercial Real Estate
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ead-calculation">
<span class="md-ellipsis">
      
        EAD Calculation
      
    </span>
</a>
<nav aria-label="EAD Calculation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#on-balance-sheet">
<span class="md-ellipsis">
      
        On-Balance Sheet
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#off-balance-sheet">
<span class="md-ellipsis">
      
        Off-Balance Sheet
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credit-risk-mitigation">
<span class="md-ellipsis">
      
        Credit Risk Mitigation
      
    </span>
</a>
<nav aria-label="Credit Risk Mitigation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#financial-collateral-simple-method">
<span class="md-ellipsis">
      
        Financial Collateral Simple Method
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#financial-collateral-comprehensive-method">
<span class="md-ellipsis">
      
        Financial Collateral Comprehensive Method
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#guarantees-substitution-approach">
<span class="md-ellipsis">
      
        Guarantees (Substitution Approach)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#supporting-factors-crr-only">
<span class="md-ellipsis">
      
        Supporting Factors (CRR Only)
      
    </span>
</a>
<nav aria-label="Supporting Factors (CRR Only)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sme-supporting-factor">
<span class="md-ellipsis">
      
        SME Supporting Factor
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#infrastructure-factor">
<span class="md-ellipsis">
      
        Infrastructure Factor
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#calculation-example">
<span class="md-ellipsis">
      
        Calculation Example
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-notes">
<span class="md-ellipsis">
      
        Implementation Notes
      
    </span>
</a>
<nav aria-label="Implementation Notes" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#calculator-usage">
<span class="md-ellipsis">
      
        Calculator Usage
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rwa_calc.engine.sa.calculator.SACalculator">
<span class="md-ellipsis">
      
        SACalculator
      
    </span>
</a>
<nav aria-label="SACalculator" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#rwa_calc.engine.sa.calculator.SACalculator.calculate_single_exposure">
<span class="md-ellipsis">
      
        calculate_single_exposure
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#risk-weight-lookup">
<span class="md-ellipsis">
      
        Risk Weight Lookup
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#regulatory-references">
<span class="md-ellipsis">
      
        Regulatory References
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#next-steps">
<span class="md-ellipsis">
      
        Next Steps
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../irb-approach/">
<span class="md-ellipsis">
    
  
    IRB Approach
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../specialised-lending/">
<span class="md-ellipsis">
    
  
    Specialised Lending
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../crm/">
<span class="md-ellipsis">
    
  
    Credit Risk Mitigation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../supporting-factors/">
<span class="md-ellipsis">
    
  
    Supporting Factors
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../exposure-classes/">
<span class="md-ellipsis">
    
  
    Exposure Classes
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    Exposure Classes
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../exposure-classes/sovereign/">
<span class="md-ellipsis">
    
  
    Sovereign
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../exposure-classes/institution/">
<span class="md-ellipsis">
    
  
    Institution
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../exposure-classes/corporate/">
<span class="md-ellipsis">
    
  
    Corporate
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../exposure-classes/retail/">
<span class="md-ellipsis">
    
  
    Retail
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../exposure-classes/other/">
<span class="md-ellipsis">
    
  
    Other Classes
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../configuration/">
<span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../architecture/">
<span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/design-principles/">
<span class="md-ellipsis">
    
  
    Design Principles
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/pipeline/">
<span class="md-ellipsis">
    
  
    Pipeline Architecture
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/data-flow/">
<span class="md-ellipsis">
    
  
    Data Flow
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/components/">
<span class="md-ellipsis">
    
  
    Component Overview
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../data-model/">
<span class="md-ellipsis">
    
  
    Data Model
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            
  
    Data Model
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../data-model/input-schemas/">
<span class="md-ellipsis">
    
  
    Input Schemas
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../data-model/data-validation/">
<span class="md-ellipsis">
    
  
    Data Validation
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../data-model/intermediate-schemas/">
<span class="md-ellipsis">
    
  
    Intermediate Schemas
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../data-model/output-schemas/">
<span class="md-ellipsis">
    
  
    Output Schemas
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../data-model/regulatory-tables/">
<span class="md-ellipsis">
    
  
    Regulatory Tables
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../api/">
<span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/pipeline/">
<span class="md-ellipsis">
    
  
    Pipeline
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/configuration/">
<span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/engine/">
<span class="md-ellipsis">
    
  
    Engine Components
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/contracts/">
<span class="md-ellipsis">
    
  
    Data Contracts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/domain/">
<span class="md-ellipsis">
    
  
    Domain Enums
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../development/">
<span class="md-ellipsis">
    
  
    Development
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../development/testing/">
<span class="md-ellipsis">
    
  
    Testing Guide
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../development/workbooks/">
<span class="md-ellipsis">
    
  
    Workbooks &amp; UI
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../development/benchmarks/">
<span class="md-ellipsis">
    
  
    Benchmark Tests
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../development/extending/">
<span class="md-ellipsis">
    
  
    Adding Features
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../development/code-style/">
<span class="md-ellipsis">
    
  
    Code Style
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../development/documentation-conventions/">
<span class="md-ellipsis">
    
  
    Documentation Conventions
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_8" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../appendix/">
<span class="md-ellipsis">
    
  
    Appendix
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            
  
    Appendix
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../appendix/glossary/">
<span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../appendix/regulatory-references/">
<span class="md-ellipsis">
    
  
    Regulatory References
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../appendix/changelog/">
<span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      
        Overview
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#risk-weight-determination">
<span class="md-ellipsis">
      
        Risk Weight Determination
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credit-quality-steps-cqs">
<span class="md-ellipsis">
      
        Credit Quality Steps (CQS)
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#risk-weights-by-exposure-class">
<span class="md-ellipsis">
      
        Risk Weights by Exposure Class
      
    </span>
</a>
<nav aria-label="Risk Weights by Exposure Class" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sovereign-exposures">
<span class="md-ellipsis">
      
        Sovereign Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#institution-exposures">
<span class="md-ellipsis">
      
        Institution Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#corporate-exposures">
<span class="md-ellipsis">
      
        Corporate Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#retail-exposures">
<span class="md-ellipsis">
      
        Retail Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#defaulted-exposures">
<span class="md-ellipsis">
      
        Defaulted Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#equity-exposures">
<span class="md-ellipsis">
      
        Equity Exposures
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#commercial-real-estate">
<span class="md-ellipsis">
      
        Commercial Real Estate
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ead-calculation">
<span class="md-ellipsis">
      
        EAD Calculation
      
    </span>
</a>
<nav aria-label="EAD Calculation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#on-balance-sheet">
<span class="md-ellipsis">
      
        On-Balance Sheet
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#off-balance-sheet">
<span class="md-ellipsis">
      
        Off-Balance Sheet
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#credit-risk-mitigation">
<span class="md-ellipsis">
      
        Credit Risk Mitigation
      
    </span>
</a>
<nav aria-label="Credit Risk Mitigation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#financial-collateral-simple-method">
<span class="md-ellipsis">
      
        Financial Collateral Simple Method
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#financial-collateral-comprehensive-method">
<span class="md-ellipsis">
      
        Financial Collateral Comprehensive Method
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#guarantees-substitution-approach">
<span class="md-ellipsis">
      
        Guarantees (Substitution Approach)
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#supporting-factors-crr-only">
<span class="md-ellipsis">
      
        Supporting Factors (CRR Only)
      
    </span>
</a>
<nav aria-label="Supporting Factors (CRR Only)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sme-supporting-factor">
<span class="md-ellipsis">
      
        SME Supporting Factor
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#infrastructure-factor">
<span class="md-ellipsis">
      
        Infrastructure Factor
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#calculation-example">
<span class="md-ellipsis">
      
        Calculation Example
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-notes">
<span class="md-ellipsis">
      
        Implementation Notes
      
    </span>
</a>
<nav aria-label="Implementation Notes" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#calculator-usage">
<span class="md-ellipsis">
      
        Calculator Usage
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rwa_calc.engine.sa.calculator.SACalculator">
<span class="md-ellipsis">
      
        SACalculator
      
    </span>
</a>
<nav aria-label="SACalculator" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#rwa_calc.engine.sa.calculator.SACalculator.calculate_single_exposure">
<span class="md-ellipsis">
      
        calculate_single_exposure
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#risk-weight-lookup">
<span class="md-ellipsis">
      
        Risk Weight Lookup
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#regulatory-references">
<span class="md-ellipsis">
      
        Regulatory References
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#next-steps">
<span class="md-ellipsis">
      
        Next Steps
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<nav aria-label="Navigation" class="md-path">
<ol class="md-path__list">
<li class="md-path__item">
<a class="md-path__link" href="../../..">
<span class="md-ellipsis">
    Home
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="../../">
<span class="md-ellipsis">
    User Guide
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="../">
<span class="md-ellipsis">
    Calculation Methodology
  </span>
</a>
</li>
</ol>
</nav>
<article class="md-content__inner md-typeset">
<h1 id="standardised-approach">Standardised Approach<a class="headerlink" href="#standardised-approach" title="Permanent link">¶</a></h1>
<p>The <strong>Standardised Approach (SA)</strong> uses regulatory-prescribed risk weights based on external credit ratings and exposure characteristics. It is the default approach for institutions without IRB approval.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¶</a></h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>RWA = EAD × Risk Weight × Supporting Factors
</span></code></pre></div>
<p>The SA calculation involves:
1. Determining the <strong>Exposure Class</strong>
2. Mapping to a <strong>Credit Quality Step (CQS)</strong> if rated
3. Looking up the <strong>Risk Weight</strong>
4. Applying <strong>Supporting Factors</strong> (CRR only)</p>
<h2 id="risk-weight-determination">Risk Weight Determination<a class="headerlink" href="#risk-weight-determination" title="Permanent link">¶</a></h2>
<pre class="mermaid"><code>flowchart TD
    A[Exposure] --&gt; B{Has External Rating?}
    B --&gt;|Yes| C[Map to CQS]
    B --&gt;|No| D[Unrated Treatment]
    C --&gt; E[Lookup RW by Class + CQS]
    D --&gt; F[Default RW for Class]
    E --&gt; G[Apply Supporting Factors]
    F --&gt; G
    G --&gt; H[Calculate RWA]</code></pre>
<h2 id="credit-quality-steps-cqs">Credit Quality Steps (CQS)<a class="headerlink" href="#credit-quality-steps-cqs" title="Permanent link">¶</a></h2>
<p>External ratings are mapped to Credit Quality Steps:</p>
<table>
<thead>
<tr>
<th>CQS</th>
<th>S&amp;P/Fitch</th>
<th>Moody's</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CQS 1</td>
<td>AAA to AA-</td>
<td>Aaa to Aa3</td>
<td>Prime/High Grade</td>
</tr>
<tr>
<td>CQS 2</td>
<td>A+ to A-</td>
<td>A1 to A3</td>
<td>Upper Medium Grade</td>
</tr>
<tr>
<td>CQS 3</td>
<td>BBB+ to BBB-</td>
<td>Baa1 to Baa3</td>
<td>Lower Medium Grade</td>
</tr>
<tr>
<td>CQS 4</td>
<td>BB+ to BB-</td>
<td>Ba1 to Ba3</td>
<td>Non-Investment Grade</td>
</tr>
<tr>
<td>CQS 5</td>
<td>B+ to B-</td>
<td>B1 to B3</td>
<td>Highly Speculative</td>
</tr>
<tr>
<td>CQS 6</td>
<td>CCC+ and below</td>
<td>Caa1 and below</td>
<td>Substantial Risk</td>
</tr>
</tbody>
</table>
<h2 id="risk-weights-by-exposure-class">Risk Weights by Exposure Class<a class="headerlink" href="#risk-weights-by-exposure-class" title="Permanent link">¶</a></h2>
<h3 id="sovereign-exposures">Sovereign Exposures<a class="headerlink" href="#sovereign-exposures" title="Permanent link">¶</a></h3>
<p>Exposures to governments and central banks:</p>
<table>
<thead>
<tr>
<th>CQS</th>
<th>Risk Weight</th>
</tr>
</thead>
<tbody>
<tr>
<td>CQS 1</td>
<td>0%</td>
</tr>
<tr>
<td>CQS 2</td>
<td>20%</td>
</tr>
<tr>
<td>CQS 3</td>
<td>50%</td>
</tr>
<tr>
<td>CQS 4</td>
<td>100%</td>
</tr>
<tr>
<td>CQS 5</td>
<td>100%</td>
</tr>
<tr>
<td>CQS 6</td>
<td>150%</td>
</tr>
<tr>
<td>Unrated</td>
<td>100%</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">UK Government</p>
<p>UK Government (HM Treasury) exposures receive 0% risk weight as a CQS 1 sovereign.</p>
</div>
<h3 id="institution-exposures">Institution Exposures<a class="headerlink" href="#institution-exposures" title="Permanent link">¶</a></h3>
<p>Exposures to banks and investment firms:</p>
<table>
<thead>
<tr>
<th>CQS</th>
<th>CRR Risk Weight</th>
<th>Basel 3.1 (ECRA)</th>
</tr>
</thead>
<tbody>
<tr>
<td>CQS 1</td>
<td>20%</td>
<td>20%</td>
</tr>
<tr>
<td>CQS 2</td>
<td>30%*</td>
<td>30%</td>
</tr>
<tr>
<td>CQS 3</td>
<td>50%</td>
<td>50%</td>
</tr>
<tr>
<td>CQS 4</td>
<td>100%</td>
<td>100%</td>
</tr>
<tr>
<td>CQS 5</td>
<td>100%</td>
<td>100%</td>
</tr>
<tr>
<td>CQS 6</td>
<td>150%</td>
<td>150%</td>
</tr>
</tbody>
</table>
<p>*UK deviation from standard 50% Basel weight</p>
<p><strong>Unrated Institutions:</strong>
- CRR: Apply due diligence assessment
- Basel 3.1: Use Standardised Credit Risk Assessment (SCRA)</p>
<h3 id="corporate-exposures">Corporate Exposures<a class="headerlink" href="#corporate-exposures" title="Permanent link">¶</a></h3>
<p>Exposures to non-financial corporates:</p>
<table>
<thead>
<tr>
<th>CQS</th>
<th>CRR</th>
<th>Basel 3.1</th>
</tr>
</thead>
<tbody>
<tr>
<td>CQS 1</td>
<td>20%</td>
<td>20%</td>
</tr>
<tr>
<td>CQS 2</td>
<td>50%</td>
<td>50%</td>
</tr>
<tr>
<td>CQS 3</td>
<td>75%</td>
<td>75%</td>
</tr>
<tr>
<td>CQS 4</td>
<td>100%</td>
<td>100%</td>
</tr>
<tr>
<td>CQS 5</td>
<td>150%</td>
<td>100%</td>
</tr>
<tr>
<td>CQS 6</td>
<td>150%</td>
<td>150%</td>
</tr>
<tr>
<td>Unrated</td>
<td>100%</td>
<td>100%</td>
</tr>
</tbody>
</table>
<p><strong>Corporate SME:</strong>
- Same risk weights as Corporate
- SME Supporting Factor may apply (CRR only)</p>
<h3 id="retail-exposures">Retail Exposures<a class="headerlink" href="#retail-exposures" title="Permanent link">¶</a></h3>
<p><strong>Residential Mortgages (CRR):</strong></p>
<table>
<thead>
<tr>
<th>Criterion</th>
<th>Risk Weight</th>
</tr>
</thead>
<tbody>
<tr>
<td>LTV ≤ 80%, performing</td>
<td>35%</td>
</tr>
<tr>
<td>LTV &gt; 80% or other</td>
<td>75%</td>
</tr>
</tbody>
</table>
<p><strong>Residential Mortgages (Basel 3.1):</strong></p>
<table>
<thead>
<tr>
<th>LTV</th>
<th>Whole Loan</th>
<th>Income-Producing</th>
</tr>
</thead>
<tbody>
<tr>
<td>≤ 50%</td>
<td>20%</td>
<td>30%</td>
</tr>
<tr>
<td>50-60%</td>
<td>25%</td>
<td>35%</td>
</tr>
<tr>
<td>60-70%</td>
<td>30%</td>
<td>45%</td>
</tr>
<tr>
<td>70-80%</td>
<td>40%</td>
<td>60%</td>
</tr>
<tr>
<td>80-90%</td>
<td>50%</td>
<td>75%</td>
</tr>
<tr>
<td>90-100%</td>
<td>70%</td>
<td>105%</td>
</tr>
<tr>
<td>&gt; 100%</td>
<td>Cpty RW</td>
<td>Cpty RW</td>
</tr>
</tbody>
</table>
<p><strong>QRRE (Qualifying Revolving Retail Exposures):</strong></p>
<table>
<thead>
<tr>
<th>Framework</th>
<th>Risk Weight</th>
</tr>
</thead>
<tbody>
<tr>
<td>CRR</td>
<td>75%</td>
</tr>
<tr>
<td>Basel 3.1</td>
<td>45-75% (depends on transactor status)</td>
</tr>
</tbody>
</table>
<p><strong>Other Retail:</strong></p>
<table>
<thead>
<tr>
<th>Framework</th>
<th>Risk Weight</th>
</tr>
</thead>
<tbody>
<tr>
<td>CRR</td>
<td>75%</td>
</tr>
<tr>
<td>Basel 3.1</td>
<td>75%</td>
</tr>
</tbody>
</table>
<h3 id="defaulted-exposures">Defaulted Exposures<a class="headerlink" href="#defaulted-exposures" title="Permanent link">¶</a></h3>
<p>Exposures where the counterparty is in default:</p>
<table>
<thead>
<tr>
<th>Provision Coverage</th>
<th>CRR</th>
<th>Basel 3.1</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt; 20%</td>
<td>150%</td>
<td>150%</td>
</tr>
<tr>
<td>20-50%</td>
<td>100%</td>
<td>100%</td>
</tr>
<tr>
<td>≥ 50%</td>
<td>100%</td>
<td>50-100%</td>
</tr>
</tbody>
</table>
<h3 id="equity-exposures">Equity Exposures<a class="headerlink" href="#equity-exposures" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Type</th>
<th>CRR</th>
<th>Basel 3.1</th>
</tr>
</thead>
<tbody>
<tr>
<td>Exchange-traded</td>
<td>100%</td>
<td>100%</td>
</tr>
<tr>
<td>Other equity</td>
<td>150%</td>
<td>250%</td>
</tr>
<tr>
<td>Private equity</td>
<td>150%</td>
<td>400%</td>
</tr>
</tbody>
</table>
<h3 id="commercial-real-estate">Commercial Real Estate<a class="headerlink" href="#commercial-real-estate" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>CRR</th>
<th>Basel 3.1</th>
</tr>
</thead>
<tbody>
<tr>
<td>Standard</td>
<td>100%</td>
<td>100%</td>
</tr>
<tr>
<td>Income-Producing (LTV ≤ 60%)</td>
<td>100%</td>
<td>70%</td>
</tr>
<tr>
<td>Income-Producing (LTV &gt; 60%)</td>
<td>100%</td>
<td>110%</td>
</tr>
</tbody>
</table>
<h2 id="ead-calculation">EAD Calculation<a class="headerlink" href="#ead-calculation" title="Permanent link">¶</a></h2>
<h3 id="on-balance-sheet">On-Balance Sheet<a class="headerlink" href="#on-balance-sheet" title="Permanent link">¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">EAD</span> <span class="o">=</span> <span class="n">Gross_Carrying_Amount</span> <span class="o">-</span> <span class="n">Specific_Provisions</span>
</span></code></pre></div>
<h3 id="off-balance-sheet">Off-Balance Sheet<a class="headerlink" href="#off-balance-sheet" title="Permanent link">¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">EAD</span> <span class="o">=</span> <span class="n">Committed_Amount</span> <span class="err">×</span> <span class="n">CCF</span>
</span></code></pre></div>
<p><strong>Credit Conversion Factors by Risk Type (CRR Art. 111):</strong></p>
<p>The <code>risk_type</code> column determines the CCF for off-balance sheet exposures:</p>
<table>
<thead>
<tr>
<th>Risk Type</th>
<th>Code</th>
<th>SA CCF</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Full Risk</td>
<td>FR</td>
<td>100%</td>
<td>Guarantees, acceptances, credit derivatives</td>
</tr>
<tr>
<td>Medium Risk</td>
<td>MR</td>
<td>50%</td>
<td>NIFs, RUFs, standby LCs, committed undrawn</td>
</tr>
<tr>
<td>Medium-Low Risk</td>
<td>MLR</td>
<td>20%</td>
<td>Documentary credits, short-term trade finance</td>
</tr>
<tr>
<td>Low Risk</td>
<td>LR</td>
<td>0%</td>
<td>Unconditionally cancellable commitments</td>
</tr>
</tbody>
</table>
<p><strong>Basel 3.1 Changes:</strong></p>
<table>
<thead>
<tr>
<th>Item Type</th>
<th>CRR CCF</th>
<th>Basel 3.1 CCF</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unconditionally Cancellable</td>
<td>0%</td>
<td>10%</td>
</tr>
<tr>
<td>Trade Finance (ST)</td>
<td>20%</td>
<td>20%</td>
</tr>
<tr>
<td>Undrawn Commitments (&lt;1yr)</td>
<td>20%</td>
<td>40%</td>
</tr>
<tr>
<td>Undrawn Commitments (≥1yr)</td>
<td>50%</td>
<td>40%</td>
</tr>
<tr>
<td>NIFs/RUFs</td>
<td>50%</td>
<td>50%</td>
</tr>
<tr>
<td>Direct Credit Substitutes</td>
<td>100%</td>
<td>100%</td>
</tr>
</tbody>
</table>
<h2 id="credit-risk-mitigation">Credit Risk Mitigation<a class="headerlink" href="#credit-risk-mitigation" title="Permanent link">¶</a></h2>
<p>SA allows several CRM techniques:</p>
<h3 id="financial-collateral-simple-method">Financial Collateral Simple Method<a class="headerlink" href="#financial-collateral-simple-method" title="Permanent link">¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># Reduce RW based on collateral</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">Collateral_RW</span> <span class="o">=</span> <span class="n">Risk_Weight_of_Collateral_Issuer</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="c1"># Apply lower of exposure RW or collateral RW</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="n">Effective_RW</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Exposure_RW</span><span class="p">,</span> <span class="n">Collateral_RW</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="financial-collateral-comprehensive-method">Financial Collateral Comprehensive Method<a class="headerlink" href="#financial-collateral-comprehensive-method" title="Permanent link">¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1"># Calculate adjusted values</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">E_adjusted</span> <span class="o">=</span> <span class="n">Exposure</span> <span class="err">×</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">H_e</span><span class="p">)</span>  <span class="c1"># Exposure haircut</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="n">C_adjusted</span> <span class="o">=</span> <span class="n">Collateral</span> <span class="err">×</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">H_c</span> <span class="o">-</span> <span class="n">H_fx</span><span class="p">)</span>  <span class="c1"># Collateral haircut</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="c1"># Net exposure</span>
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="n">E_star</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">E_adjusted</span> <span class="o">-</span> <span class="n">C_adjusted</span><span class="p">)</span>
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="c1"># RWA on net exposure</span>
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="n">RWA</span> <span class="o">=</span> <span class="n">E_star</span> <span class="err">×</span> <span class="n">Risk_Weight</span>
</span></code></pre></div>
<p><strong>Supervisory Haircuts:</strong></p>
<table>
<thead>
<tr>
<th>Collateral Type</th>
<th>Haircut</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cash (same currency)</td>
<td>0%</td>
</tr>
<tr>
<td>Government bonds ≤1yr</td>
<td>0.5%</td>
</tr>
<tr>
<td>Government bonds 1-5yr</td>
<td>2%</td>
</tr>
<tr>
<td>Government bonds &gt;5yr</td>
<td>4%</td>
</tr>
<tr>
<td>Corporate bonds AAA-AA ≤1yr</td>
<td>1%</td>
</tr>
<tr>
<td>Corporate bonds AAA-AA 1-5yr</td>
<td>4%</td>
</tr>
<tr>
<td>Corporate bonds AAA-AA &gt;5yr</td>
<td>8%</td>
</tr>
<tr>
<td>Main index equity</td>
<td>15%</td>
</tr>
<tr>
<td>Other equity</td>
<td>25%</td>
</tr>
<tr>
<td><strong>Currency mismatch add-on</strong></td>
<td><strong>+8%</strong></td>
</tr>
</tbody>
</table>
<h3 id="guarantees-substitution-approach">Guarantees (Substitution Approach)<a class="headerlink" href="#guarantees-substitution-approach" title="Permanent link">¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># Guaranteed portion treated as exposure to guarantor</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">Guaranteed_RWA</span> <span class="o">=</span> <span class="n">Guaranteed_Amount</span> <span class="err">×</span> <span class="n">Guarantor_RW</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="c1"># Unguaranteed portion at counterparty RW</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="n">Unguaranteed_RWA</span> <span class="o">=</span> <span class="p">(</span><span class="n">EAD</span> <span class="o">-</span> <span class="n">Guaranteed_Amount</span><span class="p">)</span> <span class="err">×</span> <span class="n">Counterparty_RW</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>
</span><span id="__span-5-7"><a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="c1"># Total RWA</span>
</span><span id="__span-5-8"><a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="n">RWA</span> <span class="o">=</span> <span class="n">Guaranteed_RWA</span> <span class="o">+</span> <span class="n">Unguaranteed_RWA</span>
</span></code></pre></div>
<h2 id="supporting-factors-crr-only">Supporting Factors (CRR Only)<a class="headerlink" href="#supporting-factors-crr-only" title="Permanent link">¶</a></h2>
<p>Supporting factors are implemented in <a href="https://github.com/OpenAfterHours/rwa_calculator/blob/master/src/rwa_calc/engine/sa/supporting_factors.py"><code>sa/supporting_factors.py</code></a>.</p>
<h3 id="sme-supporting-factor">SME Supporting Factor<a class="headerlink" href="#sme-supporting-factor" title="Permanent link">¶</a></h3>
<p>Reduces RWA for SME exposures (CRR Art. 501):</p>
<div class="admonition info">
<p class="admonition-title">Conceptual Logic</p>
<p>The following illustrates the SME factor calculation. See the actual implementation for
the full Polars-based processing.</p>
</div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1"># Check eligibility</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="k">if</span> <span class="n">turnover</span> <span class="o">&lt;=</span> <span class="n">EUR_50m</span> <span class="ow">and</span> <span class="n">is_sme</span><span class="p">:</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="n">threshold</span> <span class="o">=</span> <span class="n">EUR_2</span><span class="mf">.5</span><span class="n">m</span>  <span class="c1"># GBP 2.2m</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="k">if</span> <span class="n">exposure</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>        <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.7619</span>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>        <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">threshold</span> <span class="o">*</span> <span class="mf">0.7619</span> <span class="o">+</span> <span class="p">(</span><span class="n">exposure</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.85</span><span class="p">)</span> <span class="o">/</span> <span class="n">exposure</span>
</span><span id="__span-6-9"><a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>
</span><span id="__span-6-10"><a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>    <span class="n">RWA</span> <span class="o">=</span> <span class="n">RWA</span> <span class="o">*</span> <span class="n">factor</span>
</span></code></pre></div>
<details class="example">
<summary>Actual Implementation (supporting_factors.py)</summary>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="sd">"""</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="sd">CRR Supporting Factors for SA calculator (CRR2 Art. 501).</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>
</span><span id="__span-7-4"><a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="sd">Applies SME and infrastructure supporting factors to RWA calculations.</span>
</span><span id="__span-7-5"><a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="sd">These factors are CRR-specific and NOT available under Basel 3.1.</span>
</span><span id="__span-7-6"><a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>
</span><span id="__span-7-7"><a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="sd">SME Supporting Factor - Tiered Approach (CRR2 Art. 501):</span>
</span><span id="__span-7-8"><a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="sd">- Exposures up to EUR 2.5m (GBP 2.2m): factor of 0.7619</span>
</span><span id="__span-7-9"><a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="sd">- Exposures above EUR 2.5m (GBP 2.2m): factor of 0.85</span>
</span><span id="__span-7-10"><a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>
</span><span id="__span-7-11"><a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="sd">Formula:</span>
</span><span id="__span-7-12"><a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="sd">    factor = [min(E, threshold) × 0.7619 + max(E - threshold, 0) × 0.85] / E</span>
</span><span id="__span-7-13"><a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>
</span><span id="__span-7-14"><a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="sd">Infrastructure Supporting Factor (CRR Art. 501a):</span>
</span><span id="__span-7-15"><a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="sd">- Qualifying infrastructure: factor of 0.75</span>
</span><span id="__span-7-16"><a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>
</span><span id="__span-7-17"><a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="sd">References:</span>
</span><span id="__span-7-18"><a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="sd">- CRR2 Art. 501 (EU 2019/876 amending EU 575/2013)</span>
</span><span id="__span-7-19"><a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="sd">- CRR Art. 501a: Infrastructure supporting factor</span>
</span><span id="__span-7-20"><a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="sd">"""</span>
</span><span id="__span-7-21"><a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a>
</span><span id="__span-7-22"><a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="__span-7-23"><a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a>
</span><span id="__span-7-24"><a href="#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-7-25"><a href="#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
</span><span id="__span-7-26"><a href="#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="__span-7-27"><a href="#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a>
</span><span id="__span-7-28"><a href="#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
</span><span id="__span-7-29"><a href="#__codelineno-7-29" id="__codelineno-7-29" name="__codelineno-7-29"></a>
</span><span id="__span-7-30"><a href="#__codelineno-7-30" id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="__span-7-31"><a href="#__codelineno-7-31" id="__codelineno-7-31" name="__codelineno-7-31"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">rwa_calc.contracts.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalculationConfig</span>
</span><span id="__span-7-32"><a href="#__codelineno-7-32" id="__codelineno-7-32" name="__codelineno-7-32"></a>
</span><span id="__span-7-33"><a href="#__codelineno-7-33" id="__codelineno-7-33" name="__codelineno-7-33"></a>
</span><span id="__span-7-34"><a href="#__codelineno-7-34" id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="nd">@dataclass</span>
</span><span id="__span-7-35"><a href="#__codelineno-7-35" id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="k">class</span><span class="w"> </span><span class="nc">SupportingFactorResult</span><span class="p">:</span>
</span><span id="__span-7-36"><a href="#__codelineno-7-36" id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">    </span><span class="sd">"""Result of supporting factor calculation."""</span>
</span><span id="__span-7-37"><a href="#__codelineno-7-37" id="__codelineno-7-37" name="__codelineno-7-37"></a>
</span><span id="__span-7-38"><a href="#__codelineno-7-38" id="__codelineno-7-38" name="__codelineno-7-38"></a>    <span class="n">factor</span><span class="p">:</span> <span class="n">Decimal</span>
</span><span id="__span-7-39"><a href="#__codelineno-7-39" id="__codelineno-7-39" name="__codelineno-7-39"></a>    <span class="n">was_applied</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-7-40"><a href="#__codelineno-7-40" id="__codelineno-7-40" name="__codelineno-7-40"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-7-41"><a href="#__codelineno-7-41" id="__codelineno-7-41" name="__codelineno-7-41"></a>
</span><span id="__span-7-42"><a href="#__codelineno-7-42" id="__codelineno-7-42" name="__codelineno-7-42"></a>
</span><span id="__span-7-43"><a href="#__codelineno-7-43" id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">SupportingFactorCalculator</span><span class="p">:</span>
</span><span id="__span-7-44"><a href="#__codelineno-7-44" id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="w">    </span><span class="sd">"""</span>
</span><span id="__span-7-45"><a href="#__codelineno-7-45" id="__codelineno-7-45" name="__codelineno-7-45"></a><span class="sd">    Calculate SME and infrastructure supporting factors for CRR.</span>
</span><span id="__span-7-46"><a href="#__codelineno-7-46" id="__codelineno-7-46" name="__codelineno-7-46"></a>
</span><span id="__span-7-47"><a href="#__codelineno-7-47" id="__codelineno-7-47" name="__codelineno-7-47"></a><span class="sd">    The supporting factors reduce RWA for qualifying exposures:</span>
</span><span id="__span-7-48"><a href="#__codelineno-7-48" id="__codelineno-7-48" name="__codelineno-7-48"></a><span class="sd">    - SME: Tiered factor (0.7619 up to threshold, 0.85 above)</span>
</span><span id="__span-7-49"><a href="#__codelineno-7-49" id="__codelineno-7-49" name="__codelineno-7-49"></a><span class="sd">    - Infrastructure: Flat 0.75 factor</span>
</span><span id="__span-7-50"><a href="#__codelineno-7-50" id="__codelineno-7-50" name="__codelineno-7-50"></a>
</span><span id="__span-7-51"><a href="#__codelineno-7-51" id="__codelineno-7-51" name="__codelineno-7-51"></a><span class="sd">    Under Basel 3.1, these factors are not available (returns 1.0).</span>
</span><span id="__span-7-52"><a href="#__codelineno-7-52" id="__codelineno-7-52" name="__codelineno-7-52"></a><span class="sd">    """</span>
</span><span id="__span-7-53"><a href="#__codelineno-7-53" id="__codelineno-7-53" name="__codelineno-7-53"></a>
</span><span id="__span-7-54"><a href="#__codelineno-7-54" id="__codelineno-7-54" name="__codelineno-7-54"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_sme_factor</span><span class="p">(</span>
</span><span id="__span-7-55"><a href="#__codelineno-7-55" id="__codelineno-7-55" name="__codelineno-7-55"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-7-56"><a href="#__codelineno-7-56" id="__codelineno-7-56" name="__codelineno-7-56"></a>        <span class="n">total_exposure</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
</span><span id="__span-7-57"><a href="#__codelineno-7-57" id="__codelineno-7-57" name="__codelineno-7-57"></a>        <span class="n">config</span><span class="p">:</span> <span class="n">CalculationConfig</span><span class="p">,</span>
</span><span id="__span-7-58"><a href="#__codelineno-7-58" id="__codelineno-7-58" name="__codelineno-7-58"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="__span-7-59"><a href="#__codelineno-7-59" id="__codelineno-7-59" name="__codelineno-7-59"></a><span class="w">        </span><span class="sd">"""</span>
</span><span id="__span-7-60"><a href="#__codelineno-7-60" id="__codelineno-7-60" name="__codelineno-7-60"></a><span class="sd">        Calculate SME supporting factor based on total exposure.</span>
</span><span id="__span-7-61"><a href="#__codelineno-7-61" id="__codelineno-7-61" name="__codelineno-7-61"></a>
</span><span id="__span-7-62"><a href="#__codelineno-7-62" id="__codelineno-7-62" name="__codelineno-7-62"></a><span class="sd">        Args:</span>
</span><span id="__span-7-63"><a href="#__codelineno-7-63" id="__codelineno-7-63" name="__codelineno-7-63"></a><span class="sd">            total_exposure: Total exposure amount to the SME</span>
</span><span id="__span-7-64"><a href="#__codelineno-7-64" id="__codelineno-7-64" name="__codelineno-7-64"></a><span class="sd">            config: Calculation configuration</span>
</span><span id="__span-7-65"><a href="#__codelineno-7-65" id="__codelineno-7-65" name="__codelineno-7-65"></a>
</span><span id="__span-7-66"><a href="#__codelineno-7-66" id="__codelineno-7-66" name="__codelineno-7-66"></a><span class="sd">        Returns:</span>
</span><span id="__span-7-67"><a href="#__codelineno-7-67" id="__codelineno-7-67" name="__codelineno-7-67"></a><span class="sd">            Effective supporting factor (0.7619 to 0.85)</span>
</span><span id="__span-7-68"><a href="#__codelineno-7-68" id="__codelineno-7-68" name="__codelineno-7-68"></a><span class="sd">        """</span>
</span><span id="__span-7-69"><a href="#__codelineno-7-69" id="__codelineno-7-69" name="__codelineno-7-69"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span id="__span-7-70"><a href="#__codelineno-7-70" id="__codelineno-7-70" name="__codelineno-7-70"></a>            <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"1.0"</span><span class="p">)</span>
</span><span id="__span-7-71"><a href="#__codelineno-7-71" id="__codelineno-7-71" name="__codelineno-7-71"></a>
</span><span id="__span-7-72"><a href="#__codelineno-7-72" id="__codelineno-7-72" name="__codelineno-7-72"></a>        <span class="k">if</span> <span class="n">total_exposure</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-7-73"><a href="#__codelineno-7-73" id="__codelineno-7-73" name="__codelineno-7-73"></a>            <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"1.0"</span><span class="p">)</span>
</span><span id="__span-7-74"><a href="#__codelineno-7-74" id="__codelineno-7-74" name="__codelineno-7-74"></a>
</span><span id="__span-7-75"><a href="#__codelineno-7-75" id="__codelineno-7-75" name="__codelineno-7-75"></a>        <span class="c1"># Get thresholds and factors from config</span>
</span><span id="__span-7-76"><a href="#__codelineno-7-76" id="__codelineno-7-76" name="__codelineno-7-76"></a>        <span class="n">threshold_eur</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">sme_exposure_threshold_eur</span>
</span><span id="__span-7-77"><a href="#__codelineno-7-77" id="__codelineno-7-77" name="__codelineno-7-77"></a>        <span class="n">threshold_gbp</span> <span class="o">=</span> <span class="n">threshold_eur</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">eur_gbp_rate</span>
</span><span id="__span-7-78"><a href="#__codelineno-7-78" id="__codelineno-7-78" name="__codelineno-7-78"></a>
</span><span id="__span-7-79"><a href="#__codelineno-7-79" id="__codelineno-7-79" name="__codelineno-7-79"></a>        <span class="n">factor_tier1</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">sme_factor_under_threshold</span>
</span><span id="__span-7-80"><a href="#__codelineno-7-80" id="__codelineno-7-80" name="__codelineno-7-80"></a>        <span class="n">factor_tier2</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">sme_factor_above_threshold</span>
</span><span id="__span-7-81"><a href="#__codelineno-7-81" id="__codelineno-7-81" name="__codelineno-7-81"></a>
</span><span id="__span-7-82"><a href="#__codelineno-7-82" id="__codelineno-7-82" name="__codelineno-7-82"></a>        <span class="c1"># Use GBP threshold for GBP currency (default)</span>
</span><span id="__span-7-83"><a href="#__codelineno-7-83" id="__codelineno-7-83" name="__codelineno-7-83"></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_gbp</span>
</span><span id="__span-7-84"><a href="#__codelineno-7-84" id="__codelineno-7-84" name="__codelineno-7-84"></a>
</span><span id="__span-7-85"><a href="#__codelineno-7-85" id="__codelineno-7-85" name="__codelineno-7-85"></a>        <span class="c1"># Calculate tiered factor</span>
</span><span id="__span-7-86"><a href="#__codelineno-7-86" id="__codelineno-7-86" name="__codelineno-7-86"></a>        <span class="n">tier1_amount</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">total_exposure</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
</span><span id="__span-7-87"><a href="#__codelineno-7-87" id="__codelineno-7-87" name="__codelineno-7-87"></a>        <span class="n">tier2_amount</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">total_exposure</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"0"</span><span class="p">))</span>
</span><span id="__span-7-88"><a href="#__codelineno-7-88" id="__codelineno-7-88" name="__codelineno-7-88"></a>
</span><span id="__span-7-89"><a href="#__codelineno-7-89" id="__codelineno-7-89" name="__codelineno-7-89"></a>        <span class="n">weighted_factor</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-7-90"><a href="#__codelineno-7-90" id="__codelineno-7-90" name="__codelineno-7-90"></a>            <span class="n">tier1_amount</span> <span class="o">*</span> <span class="n">factor_tier1</span> <span class="o">+</span>
</span><span id="__span-7-91"><a href="#__codelineno-7-91" id="__codelineno-7-91" name="__codelineno-7-91"></a>            <span class="n">tier2_amount</span> <span class="o">*</span> <span class="n">factor_tier2</span>
</span><span id="__span-7-92"><a href="#__codelineno-7-92" id="__codelineno-7-92" name="__codelineno-7-92"></a>        <span class="p">)</span>
</span><span id="__span-7-93"><a href="#__codelineno-7-93" id="__codelineno-7-93" name="__codelineno-7-93"></a>
</span><span id="__span-7-94"><a href="#__codelineno-7-94" id="__codelineno-7-94" name="__codelineno-7-94"></a>        <span class="k">return</span> <span class="n">weighted_factor</span> <span class="o">/</span> <span class="n">total_exposure</span>
</span><span id="__span-7-95"><a href="#__codelineno-7-95" id="__codelineno-7-95" name="__codelineno-7-95"></a>
</span><span id="__span-7-96"><a href="#__codelineno-7-96" id="__codelineno-7-96" name="__codelineno-7-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_infrastructure_factor</span><span class="p">(</span>
</span><span id="__span-7-97"><a href="#__codelineno-7-97" id="__codelineno-7-97" name="__codelineno-7-97"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-7-98"><a href="#__codelineno-7-98" id="__codelineno-7-98" name="__codelineno-7-98"></a>        <span class="n">config</span><span class="p">:</span> <span class="n">CalculationConfig</span><span class="p">,</span>
</span><span id="__span-7-99"><a href="#__codelineno-7-99" id="__codelineno-7-99" name="__codelineno-7-99"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="__span-7-100"><a href="#__codelineno-7-100" id="__codelineno-7-100" name="__codelineno-7-100"></a><span class="w">        </span><span class="sd">"""</span>
</span><span id="__span-7-101"><a href="#__codelineno-7-101" id="__codelineno-7-101" name="__codelineno-7-101"></a><span class="sd">        Get infrastructure supporting factor.</span>
</span><span id="__span-7-102"><a href="#__codelineno-7-102" id="__codelineno-7-102" name="__codelineno-7-102"></a>
</span><span id="__span-7-103"><a href="#__codelineno-7-103" id="__codelineno-7-103" name="__codelineno-7-103"></a><span class="sd">        Args:</span>
</span><span id="__span-7-104"><a href="#__codelineno-7-104" id="__codelineno-7-104" name="__codelineno-7-104"></a><span class="sd">            config: Calculation configuration</span>
</span><span id="__span-7-105"><a href="#__codelineno-7-105" id="__codelineno-7-105" name="__codelineno-7-105"></a>
</span><span id="__span-7-106"><a href="#__codelineno-7-106" id="__codelineno-7-106" name="__codelineno-7-106"></a><span class="sd">        Returns:</span>
</span><span id="__span-7-107"><a href="#__codelineno-7-107" id="__codelineno-7-107" name="__codelineno-7-107"></a><span class="sd">            Infrastructure factor (0.75 for CRR, 1.0 for Basel 3.1)</span>
</span><span id="__span-7-108"><a href="#__codelineno-7-108" id="__codelineno-7-108" name="__codelineno-7-108"></a><span class="sd">        """</span>
</span><span id="__span-7-109"><a href="#__codelineno-7-109" id="__codelineno-7-109" name="__codelineno-7-109"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span id="__span-7-110"><a href="#__codelineno-7-110" id="__codelineno-7-110" name="__codelineno-7-110"></a>            <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"1.0"</span><span class="p">)</span>
</span><span id="__span-7-111"><a href="#__codelineno-7-111" id="__codelineno-7-111" name="__codelineno-7-111"></a>
</span><span id="__span-7-112"><a href="#__codelineno-7-112" id="__codelineno-7-112" name="__codelineno-7-112"></a>        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">infrastructure_factor</span>
</span><span id="__span-7-113"><a href="#__codelineno-7-113" id="__codelineno-7-113" name="__codelineno-7-113"></a>
</span><span id="__span-7-114"><a href="#__codelineno-7-114" id="__codelineno-7-114" name="__codelineno-7-114"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_effective_factor</span><span class="p">(</span>
</span><span id="__span-7-115"><a href="#__codelineno-7-115" id="__codelineno-7-115" name="__codelineno-7-115"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-7-116"><a href="#__codelineno-7-116" id="__codelineno-7-116" name="__codelineno-7-116"></a>        <span class="n">is_sme</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="__span-7-117"><a href="#__codelineno-7-117" id="__codelineno-7-117" name="__codelineno-7-117"></a>        <span class="n">is_infrastructure</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="__span-7-118"><a href="#__codelineno-7-118" id="__codelineno-7-118" name="__codelineno-7-118"></a>        <span class="n">total_exposure</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
</span><span id="__span-7-119"><a href="#__codelineno-7-119" id="__codelineno-7-119" name="__codelineno-7-119"></a>        <span class="n">config</span><span class="p">:</span> <span class="n">CalculationConfig</span><span class="p">,</span>
</span><span id="__span-7-120"><a href="#__codelineno-7-120" id="__codelineno-7-120" name="__codelineno-7-120"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="__span-7-121"><a href="#__codelineno-7-121" id="__codelineno-7-121" name="__codelineno-7-121"></a><span class="w">        </span><span class="sd">"""</span>
</span><span id="__span-7-122"><a href="#__codelineno-7-122" id="__codelineno-7-122" name="__codelineno-7-122"></a><span class="sd">        Get the most beneficial supporting factor.</span>
</span><span id="__span-7-123"><a href="#__codelineno-7-123" id="__codelineno-7-123" name="__codelineno-7-123"></a>
</span><span id="__span-7-124"><a href="#__codelineno-7-124" id="__codelineno-7-124" name="__codelineno-7-124"></a><span class="sd">        If both SME and infrastructure apply, returns the lower factor</span>
</span><span id="__span-7-125"><a href="#__codelineno-7-125" id="__codelineno-7-125" name="__codelineno-7-125"></a><span class="sd">        (more beneficial to the bank).</span>
</span><span id="__span-7-126"><a href="#__codelineno-7-126" id="__codelineno-7-126" name="__codelineno-7-126"></a>
</span><span id="__span-7-127"><a href="#__codelineno-7-127" id="__codelineno-7-127" name="__codelineno-7-127"></a><span class="sd">        Args:</span>
</span><span id="__span-7-128"><a href="#__codelineno-7-128" id="__codelineno-7-128" name="__codelineno-7-128"></a><span class="sd">            is_sme: Whether exposure qualifies for SME factor</span>
</span><span id="__span-7-129"><a href="#__codelineno-7-129" id="__codelineno-7-129" name="__codelineno-7-129"></a><span class="sd">            is_infrastructure: Whether exposure qualifies for infrastructure</span>
</span><span id="__span-7-130"><a href="#__codelineno-7-130" id="__codelineno-7-130" name="__codelineno-7-130"></a><span class="sd">            total_exposure: Total exposure amount (for SME tier calculation)</span>
</span><span id="__span-7-131"><a href="#__codelineno-7-131" id="__codelineno-7-131" name="__codelineno-7-131"></a><span class="sd">            config: Calculation configuration</span>
</span><span id="__span-7-132"><a href="#__codelineno-7-132" id="__codelineno-7-132" name="__codelineno-7-132"></a>
</span><span id="__span-7-133"><a href="#__codelineno-7-133" id="__codelineno-7-133" name="__codelineno-7-133"></a><span class="sd">        Returns:</span>
</span><span id="__span-7-134"><a href="#__codelineno-7-134" id="__codelineno-7-134" name="__codelineno-7-134"></a><span class="sd">            Most beneficial factor (lowest value)</span>
</span><span id="__span-7-135"><a href="#__codelineno-7-135" id="__codelineno-7-135" name="__codelineno-7-135"></a><span class="sd">        """</span>
</span><span id="__span-7-136"><a href="#__codelineno-7-136" id="__codelineno-7-136" name="__codelineno-7-136"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span id="__span-7-137"><a href="#__codelineno-7-137" id="__codelineno-7-137" name="__codelineno-7-137"></a>            <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"1.0"</span><span class="p">)</span>
</span><span id="__span-7-138"><a href="#__codelineno-7-138" id="__codelineno-7-138" name="__codelineno-7-138"></a>
</span><span id="__span-7-139"><a href="#__codelineno-7-139" id="__codelineno-7-139" name="__codelineno-7-139"></a>        <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">"1.0"</span><span class="p">)]</span>
</span><span id="__span-7-140"><a href="#__codelineno-7-140" id="__codelineno-7-140" name="__codelineno-7-140"></a>
</span><span id="__span-7-141"><a href="#__codelineno-7-141" id="__codelineno-7-141" name="__codelineno-7-141"></a>        <span class="k">if</span> <span class="n">is_sme</span><span class="p">:</span>
</span><span id="__span-7-142"><a href="#__codelineno-7-142" id="__codelineno-7-142" name="__codelineno-7-142"></a>            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_sme_factor</span><span class="p">(</span><span class="n">total_exposure</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>
</span><span id="__span-7-143"><a href="#__codelineno-7-143" id="__codelineno-7-143" name="__codelineno-7-143"></a>
</span><span id="__span-7-144"><a href="#__codelineno-7-144" id="__codelineno-7-144" name="__codelineno-7-144"></a>        <span class="k">if</span> <span class="n">is_infrastructure</span><span class="p">:</span>
</span><span id="__span-7-145"><a href="#__codelineno-7-145" id="__codelineno-7-145" name="__codelineno-7-145"></a>            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_infrastructure_factor</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span><span id="__span-7-146"><a href="#__codelineno-7-146" id="__codelineno-7-146" name="__codelineno-7-146"></a>
</span><span id="__span-7-147"><a href="#__codelineno-7-147" id="__codelineno-7-147" name="__codelineno-7-147"></a>        <span class="c1"># Return lowest factor (most beneficial)</span>
</span><span id="__span-7-148"><a href="#__codelineno-7-148" id="__codelineno-7-148" name="__codelineno-7-148"></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
</span><span id="__span-7-149"><a href="#__codelineno-7-149" id="__codelineno-7-149" name="__codelineno-7-149"></a>
</span><span id="__span-7-150"><a href="#__codelineno-7-150" id="__codelineno-7-150" name="__codelineno-7-150"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_factors</span><span class="p">(</span>
</span><span id="__span-7-151"><a href="#__codelineno-7-151" id="__codelineno-7-151" name="__codelineno-7-151"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-7-152"><a href="#__codelineno-7-152" id="__codelineno-7-152" name="__codelineno-7-152"></a>        <span class="n">exposures</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
</span><span id="__span-7-153"><a href="#__codelineno-7-153" id="__codelineno-7-153" name="__codelineno-7-153"></a>        <span class="n">config</span><span class="p">:</span> <span class="n">CalculationConfig</span><span class="p">,</span>
</span><span id="__span-7-154"><a href="#__codelineno-7-154" id="__codelineno-7-154" name="__codelineno-7-154"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="__span-7-155"><a href="#__codelineno-7-155" id="__codelineno-7-155" name="__codelineno-7-155"></a><span class="w">        </span><span class="sd">"""</span>
</span><span id="__span-7-156"><a href="#__codelineno-7-156" id="__codelineno-7-156" name="__codelineno-7-156"></a><span class="sd">        Apply supporting factors to exposures LazyFrame.</span>
</span><span id="__span-7-157"><a href="#__codelineno-7-157" id="__codelineno-7-157" name="__codelineno-7-157"></a>
</span><span id="__span-7-158"><a href="#__codelineno-7-158" id="__codelineno-7-158" name="__codelineno-7-158"></a><span class="sd">        Expects columns:</span>
</span><span id="__span-7-159"><a href="#__codelineno-7-159" id="__codelineno-7-159" name="__codelineno-7-159"></a><span class="sd">        - is_sme: bool</span>
</span><span id="__span-7-160"><a href="#__codelineno-7-160" id="__codelineno-7-160" name="__codelineno-7-160"></a><span class="sd">        - is_infrastructure: bool</span>
</span><span id="__span-7-161"><a href="#__codelineno-7-161" id="__codelineno-7-161" name="__codelineno-7-161"></a><span class="sd">        - ead_final: float (exposure amount for tier calculation)</span>
</span><span id="__span-7-162"><a href="#__codelineno-7-162" id="__codelineno-7-162" name="__codelineno-7-162"></a><span class="sd">        - rwa_pre_factor: float (RWA before supporting factor)</span>
</span><span id="__span-7-163"><a href="#__codelineno-7-163" id="__codelineno-7-163" name="__codelineno-7-163"></a>
</span><span id="__span-7-164"><a href="#__codelineno-7-164" id="__codelineno-7-164" name="__codelineno-7-164"></a><span class="sd">        Adds columns:</span>
</span><span id="__span-7-165"><a href="#__codelineno-7-165" id="__codelineno-7-165" name="__codelineno-7-165"></a><span class="sd">        - supporting_factor: float</span>
</span><span id="__span-7-166"><a href="#__codelineno-7-166" id="__codelineno-7-166" name="__codelineno-7-166"></a><span class="sd">        - rwa_post_factor: float (RWA after supporting factor)</span>
</span><span id="__span-7-167"><a href="#__codelineno-7-167" id="__codelineno-7-167" name="__codelineno-7-167"></a><span class="sd">        - supporting_factor_applied: bool</span>
</span><span id="__span-7-168"><a href="#__codelineno-7-168" id="__codelineno-7-168" name="__codelineno-7-168"></a>
</span><span id="__span-7-169"><a href="#__codelineno-7-169" id="__codelineno-7-169" name="__codelineno-7-169"></a><span class="sd">        Args:</span>
</span><span id="__span-7-170"><a href="#__codelineno-7-170" id="__codelineno-7-170" name="__codelineno-7-170"></a><span class="sd">            exposures: Exposures with RWA calculated</span>
</span><span id="__span-7-171"><a href="#__codelineno-7-171" id="__codelineno-7-171" name="__codelineno-7-171"></a><span class="sd">            config: Calculation configuration</span>
</span><span id="__span-7-172"><a href="#__codelineno-7-172" id="__codelineno-7-172" name="__codelineno-7-172"></a>
</span><span id="__span-7-173"><a href="#__codelineno-7-173" id="__codelineno-7-173" name="__codelineno-7-173"></a><span class="sd">        Returns:</span>
</span><span id="__span-7-174"><a href="#__codelineno-7-174" id="__codelineno-7-174" name="__codelineno-7-174"></a><span class="sd">            Exposures with supporting factors applied</span>
</span><span id="__span-7-175"><a href="#__codelineno-7-175" id="__codelineno-7-175" name="__codelineno-7-175"></a><span class="sd">        """</span>
</span><span id="__span-7-176"><a href="#__codelineno-7-176" id="__codelineno-7-176" name="__codelineno-7-176"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span id="__span-7-177"><a href="#__codelineno-7-177" id="__codelineno-7-177" name="__codelineno-7-177"></a>            <span class="c1"># Basel 3.1: No supporting factors</span>
</span><span id="__span-7-178"><a href="#__codelineno-7-178" id="__codelineno-7-178" name="__codelineno-7-178"></a>            <span class="k">return</span> <span class="n">exposures</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-7-179"><a href="#__codelineno-7-179" id="__codelineno-7-179" name="__codelineno-7-179"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"supporting_factor"</span><span class="p">),</span>
</span><span id="__span-7-180"><a href="#__codelineno-7-180" id="__codelineno-7-180" name="__codelineno-7-180"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"rwa_pre_factor"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"rwa_post_factor"</span><span class="p">),</span>
</span><span id="__span-7-181"><a href="#__codelineno-7-181" id="__codelineno-7-181" name="__codelineno-7-181"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"supporting_factor_applied"</span><span class="p">),</span>
</span><span id="__span-7-182"><a href="#__codelineno-7-182" id="__codelineno-7-182" name="__codelineno-7-182"></a>            <span class="p">])</span>
</span><span id="__span-7-183"><a href="#__codelineno-7-183" id="__codelineno-7-183" name="__codelineno-7-183"></a>
</span><span id="__span-7-184"><a href="#__codelineno-7-184" id="__codelineno-7-184" name="__codelineno-7-184"></a>        <span class="c1"># Get threshold in GBP</span>
</span><span id="__span-7-185"><a href="#__codelineno-7-185" id="__codelineno-7-185" name="__codelineno-7-185"></a>        <span class="n">threshold_gbp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
</span><span id="__span-7-186"><a href="#__codelineno-7-186" id="__codelineno-7-186" name="__codelineno-7-186"></a>            <span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">sme_exposure_threshold_eur</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">eur_gbp_rate</span>
</span><span id="__span-7-187"><a href="#__codelineno-7-187" id="__codelineno-7-187" name="__codelineno-7-187"></a>        <span class="p">)</span>
</span><span id="__span-7-188"><a href="#__codelineno-7-188" id="__codelineno-7-188" name="__codelineno-7-188"></a>        <span class="n">factor_tier1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">sme_factor_under_threshold</span><span class="p">)</span>
</span><span id="__span-7-189"><a href="#__codelineno-7-189" id="__codelineno-7-189" name="__codelineno-7-189"></a>        <span class="n">factor_tier2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">sme_factor_above_threshold</span><span class="p">)</span>
</span><span id="__span-7-190"><a href="#__codelineno-7-190" id="__codelineno-7-190" name="__codelineno-7-190"></a>        <span class="n">infra_factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">supporting_factors</span><span class="o">.</span><span class="n">infrastructure_factor</span><span class="p">)</span>
</span><span id="__span-7-191"><a href="#__codelineno-7-191" id="__codelineno-7-191" name="__codelineno-7-191"></a>
</span><span id="__span-7-192"><a href="#__codelineno-7-192" id="__codelineno-7-192" name="__codelineno-7-192"></a>        <span class="c1"># Check for required columns</span>
</span><span id="__span-7-193"><a href="#__codelineno-7-193" id="__codelineno-7-193" name="__codelineno-7-193"></a>        <span class="n">schema</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span>
</span><span id="__span-7-194"><a href="#__codelineno-7-194" id="__codelineno-7-194" name="__codelineno-7-194"></a>        <span class="n">has_sme</span> <span class="o">=</span> <span class="s2">"is_sme"</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
</span><span id="__span-7-195"><a href="#__codelineno-7-195" id="__codelineno-7-195" name="__codelineno-7-195"></a>        <span class="n">has_infra</span> <span class="o">=</span> <span class="s2">"is_infrastructure"</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
</span><span id="__span-7-196"><a href="#__codelineno-7-196" id="__codelineno-7-196" name="__codelineno-7-196"></a>
</span><span id="__span-7-197"><a href="#__codelineno-7-197" id="__codelineno-7-197" name="__codelineno-7-197"></a>        <span class="c1"># Build SME factor expression inline</span>
</span><span id="__span-7-198"><a href="#__codelineno-7-198" id="__codelineno-7-198" name="__codelineno-7-198"></a>        <span class="k">if</span> <span class="n">has_sme</span><span class="p">:</span>
</span><span id="__span-7-199"><a href="#__codelineno-7-199" id="__codelineno-7-199" name="__codelineno-7-199"></a>            <span class="n">tier1_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ead_final"</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold_gbp</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
</span><span id="__span-7-200"><a href="#__codelineno-7-200" id="__codelineno-7-200" name="__codelineno-7-200"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ead_final"</span><span class="p">)</span>
</span><span id="__span-7-201"><a href="#__codelineno-7-201" id="__codelineno-7-201" name="__codelineno-7-201"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">threshold_gbp</span><span class="p">))</span>
</span><span id="__span-7-202"><a href="#__codelineno-7-202" id="__codelineno-7-202" name="__codelineno-7-202"></a>
</span><span id="__span-7-203"><a href="#__codelineno-7-203" id="__codelineno-7-203" name="__codelineno-7-203"></a>            <span class="n">tier2_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ead_final"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold_gbp</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
</span><span id="__span-7-204"><a href="#__codelineno-7-204" id="__codelineno-7-204" name="__codelineno-7-204"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ead_final"</span><span class="p">)</span> <span class="o">-</span> <span class="n">threshold_gbp</span>
</span><span id="__span-7-205"><a href="#__codelineno-7-205" id="__codelineno-7-205" name="__codelineno-7-205"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</span><span id="__span-7-206"><a href="#__codelineno-7-206" id="__codelineno-7-206" name="__codelineno-7-206"></a>
</span><span id="__span-7-207"><a href="#__codelineno-7-207" id="__codelineno-7-207" name="__codelineno-7-207"></a>            <span class="n">sme_factor_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
</span><span id="__span-7-208"><a href="#__codelineno-7-208" id="__codelineno-7-208" name="__codelineno-7-208"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"is_sme"</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ead_final"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-7-209"><a href="#__codelineno-7-209" id="__codelineno-7-209" name="__codelineno-7-209"></a>            <span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
</span><span id="__span-7-210"><a href="#__codelineno-7-210" id="__codelineno-7-210" name="__codelineno-7-210"></a>                <span class="p">(</span><span class="n">tier1_expr</span> <span class="o">*</span> <span class="n">factor_tier1</span> <span class="o">+</span> <span class="n">tier2_expr</span> <span class="o">*</span> <span class="n">factor_tier2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ead_final"</span><span class="p">)</span>
</span><span id="__span-7-211"><a href="#__codelineno-7-211" id="__codelineno-7-211" name="__codelineno-7-211"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</span><span id="__span-7-212"><a href="#__codelineno-7-212" id="__codelineno-7-212" name="__codelineno-7-212"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-213"><a href="#__codelineno-7-213" id="__codelineno-7-213" name="__codelineno-7-213"></a>            <span class="n">sme_factor_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-7-214"><a href="#__codelineno-7-214" id="__codelineno-7-214" name="__codelineno-7-214"></a>
</span><span id="__span-7-215"><a href="#__codelineno-7-215" id="__codelineno-7-215" name="__codelineno-7-215"></a>        <span class="c1"># Build infrastructure factor expression inline</span>
</span><span id="__span-7-216"><a href="#__codelineno-7-216" id="__codelineno-7-216" name="__codelineno-7-216"></a>        <span class="k">if</span> <span class="n">has_infra</span><span class="p">:</span>
</span><span id="__span-7-217"><a href="#__codelineno-7-217" id="__codelineno-7-217" name="__codelineno-7-217"></a>            <span class="n">infra_factor_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"is_infrastructure"</span><span class="p">))</span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
</span><span id="__span-7-218"><a href="#__codelineno-7-218" id="__codelineno-7-218" name="__codelineno-7-218"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">infra_factor</span><span class="p">)</span>
</span><span id="__span-7-219"><a href="#__codelineno-7-219" id="__codelineno-7-219" name="__codelineno-7-219"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</span><span id="__span-7-220"><a href="#__codelineno-7-220" id="__codelineno-7-220" name="__codelineno-7-220"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-221"><a href="#__codelineno-7-221" id="__codelineno-7-221" name="__codelineno-7-221"></a>            <span class="n">infra_factor_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-7-222"><a href="#__codelineno-7-222" id="__codelineno-7-222" name="__codelineno-7-222"></a>
</span><span id="__span-7-223"><a href="#__codelineno-7-223" id="__codelineno-7-223" name="__codelineno-7-223"></a>        <span class="c1"># Compute minimum (most beneficial) factor</span>
</span><span id="__span-7-224"><a href="#__codelineno-7-224" id="__codelineno-7-224" name="__codelineno-7-224"></a>        <span class="n">min_factor_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">min_horizontal</span><span class="p">(</span><span class="n">sme_factor_expr</span><span class="p">,</span> <span class="n">infra_factor_expr</span><span class="p">)</span>
</span><span id="__span-7-225"><a href="#__codelineno-7-225" id="__codelineno-7-225" name="__codelineno-7-225"></a>
</span><span id="__span-7-226"><a href="#__codelineno-7-226" id="__codelineno-7-226" name="__codelineno-7-226"></a>        <span class="c1"># Single with_columns call for maximum performance</span>
</span><span id="__span-7-227"><a href="#__codelineno-7-227" id="__codelineno-7-227" name="__codelineno-7-227"></a>        <span class="k">return</span> <span class="n">exposures</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-7-228"><a href="#__codelineno-7-228" id="__codelineno-7-228" name="__codelineno-7-228"></a>            <span class="n">min_factor_expr</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"supporting_factor"</span><span class="p">),</span>
</span><span id="__span-7-229"><a href="#__codelineno-7-229" id="__codelineno-7-229" name="__codelineno-7-229"></a>            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"rwa_pre_factor"</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_factor_expr</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"rwa_post_factor"</span><span class="p">),</span>
</span><span id="__span-7-230"><a href="#__codelineno-7-230" id="__codelineno-7-230" name="__codelineno-7-230"></a>            <span class="p">(</span><span class="n">min_factor_expr</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"supporting_factor_applied"</span><span class="p">),</span>
</span><span id="__span-7-231"><a href="#__codelineno-7-231" id="__codelineno-7-231" name="__codelineno-7-231"></a>        <span class="p">])</span>
</span><span id="__span-7-232"><a href="#__codelineno-7-232" id="__codelineno-7-232" name="__codelineno-7-232"></a>
</span><span id="__span-7-233"><a href="#__codelineno-7-233" id="__codelineno-7-233" name="__codelineno-7-233"></a>
</span><span id="__span-7-234"><a href="#__codelineno-7-234" id="__codelineno-7-234" name="__codelineno-7-234"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_supporting_factor_calculator</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SupportingFactorCalculator</span><span class="p">:</span>
</span><span id="__span-7-235"><a href="#__codelineno-7-235" id="__codelineno-7-235" name="__codelineno-7-235"></a><span class="w">    </span><span class="sd">"""Create a SupportingFactorCalculator instance."""</span>
</span><span id="__span-7-236"><a href="#__codelineno-7-236" id="__codelineno-7-236" name="__codelineno-7-236"></a>    <span class="k">return</span> <span class="n">SupportingFactorCalculator</span><span class="p">()</span>
</span></code></pre></div>
</details>
<h3 id="infrastructure-factor">Infrastructure Factor<a class="headerlink" href="#infrastructure-factor" title="Permanent link">¶</a></h3>
<p>Reduces RWA for qualifying infrastructure (CRR Art. 501a):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">if</span> <span class="n">is_qualifying_infrastructure</span><span class="p">:</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="n">RWA</span> <span class="o">=</span> <span class="n">RWA</span> <span class="o">*</span> <span class="mf">0.75</span>
</span></code></pre></div>
<h2 id="calculation-example">Calculation Example<a class="headerlink" href="#calculation-example" title="Permanent link">¶</a></h2>
<p><strong>Exposure:</strong>
- Corporate loan, £10m drawn
- Rated A+ (CQS 2)
- SME counterparty (turnover £30m)
- Unsecured</p>
<p><strong>Calculation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1"># Step 1: EAD</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="n">EAD</span> <span class="o">=</span> <span class="err">£</span><span class="mi">10</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="c1"># Step 2: Risk Weight (CQS 2 Corporate)</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="n">RW</span> <span class="o">=</span> <span class="mi">50</span><span class="o">%</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="c1"># Step 3: Base RWA</span>
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="n">Base_RWA</span> <span class="o">=</span> <span class="err">£</span><span class="mi">10</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span> <span class="err">×</span> <span class="mi">50</span><span class="o">%</span> <span class="o">=</span> <span class="err">£</span><span class="mi">5</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span>
</span><span id="__span-9-9"><a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>
</span><span id="__span-9-10"><a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="c1"># Step 4: SME Factor (CRR only)</span>
</span><span id="__span-9-11"><a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="c1"># Exposure &gt; threshold, so tiered</span>
</span><span id="__span-9-12"><a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="n">threshold</span> <span class="o">=</span> <span class="err">£</span><span class="mi">2</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">000</span>
</span><span id="__span-9-13"><a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">000</span> <span class="err">×</span> <span class="mf">0.7619</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span><span class="mi">800</span><span class="p">,</span><span class="mi">000</span> <span class="err">×</span> <span class="mf">0.85</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span>
</span><span id="__span-9-14"><a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">676</span><span class="p">,</span><span class="mi">180</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span><span class="mi">630</span><span class="p">,</span><span class="mi">000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span>
</span><span id="__span-9-15"><a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="n">factor</span> <span class="o">=</span> <span class="mf">0.831</span>
</span><span id="__span-9-16"><a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a>
</span><span id="__span-9-17"><a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="c1"># Step 5: Final RWA (CRR)</span>
</span><span id="__span-9-18"><a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="n">Final_RWA</span> <span class="o">=</span> <span class="err">£</span><span class="mi">5</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span> <span class="err">×</span> <span class="mf">0.831</span> <span class="o">=</span> <span class="err">£</span><span class="mi">4</span><span class="p">,</span><span class="mi">153</span><span class="p">,</span><span class="mi">090</span>
</span><span id="__span-9-19"><a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a>
</span><span id="__span-9-20"><a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="c1"># Basel 3.1 (no SME factor)</span>
</span><span id="__span-9-21"><a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="n">Final_RWA_B31</span> <span class="o">=</span> <span class="err">£</span><span class="mi">5</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span>
</span></code></pre></div></p>
<h2 id="implementation-notes">Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permanent link">¶</a></h2>
<h3 id="calculator-usage">Calculator Usage<a class="headerlink" href="#calculator-usage" title="Permanent link">¶</a></h3>
<p>The SA calculator is implemented in <a href="https://github.com/OpenAfterHours/rwa_calculator/blob/master/src/rwa_calc/engine/sa/calculator.py"><code>sa/calculator.py</code></a>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rwa_calc.engine.sa.calculator</span><span class="w"> </span><span class="kn">import</span> <span class="n">SACalculator</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rwa_calc.contracts.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalculationConfig</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="c1"># Create SA calculator</span>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="n">calculator</span> <span class="o">=</span> <span class="n">SACalculator</span><span class="p">()</span>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="c1"># Calculate RWA for a single exposure (convenience method)</span>
</span><span id="__span-10-9"><a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_single_exposure</span><span class="p">(</span>
</span><span id="__span-10-10"><a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>    <span class="n">ead</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">"10000000"</span><span class="p">),</span>
</span><span id="__span-10-11"><a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>    <span class="n">exposure_class</span><span class="o">=</span><span class="s2">"CORPORATE"</span><span class="p">,</span>
</span><span id="__span-10-12"><a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>    <span class="n">cqs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-10-13"><a href="#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>    <span class="n">is_sme</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-10-14"><a href="#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a>    <span class="n">config</span><span class="o">=</span><span class="n">CalculationConfig</span><span class="o">.</span><span class="n">crr</span><span class="p">(</span><span class="n">reporting_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2026</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">))</span>
</span><span id="__span-10-15"><a href="#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="p">)</span>
</span><span id="__span-10-16"><a href="#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>
</span><span id="__span-10-17"><a href="#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="c1"># Access results</span>
</span><span id="__span-10-18"><a href="#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Risk Weight: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">'risk_weight'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-10-19"><a href="#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"RWA: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">'rwa'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-10-20"><a href="#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Supporting Factor: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">'supporting_factor_applied'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span></code></pre></div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="rwa_calc.engine.sa.calculator.SACalculator">
<code>rwa_calc.engine.sa.calculator.SACalculator</code>
<a class="headerlink" href="#rwa_calc.engine.sa.calculator.SACalculator" title="Permanent link">¶</a></h2>
<div class="doc doc-contents first">
<p>Calculate RWA using Standardised Approach.</p>
<p>Implements SACalculatorProtocol for:
- CQS-based risk weight lookup (sovereign, institution, corporate)
- Fixed retail risk weight (75%)
- LTV-based real estate risk weights
- Supporting factor application (CRR only)</p>
<details class="usage" open="">
<summary>Usage</summary>
<p>calculator = SACalculator()
result = calculator.calculate(crm_bundle, config)</p>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="rwa_calc.engine.sa.calculator.SACalculator.calculate_single_exposure">
<code class="highlight language-python"><span class="n">calculate_single_exposure</span><span class="p">(</span><span class="n">ead</span><span class="p">,</span> <span class="n">exposure_class</span><span class="p">,</span> <span class="n">cqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ltv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_sme</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_infrastructure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_managed_as_retail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<a class="headerlink" href="#rwa_calc.engine.sa.calculator.SACalculator.calculate_single_exposure" title="Permanent link">¶</a></h3>
<div class="doc doc-contents">
<p>Calculate RWA for a single exposure (convenience method).</p>
<p><span class="doc-section-title">Parameters:</span></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr class="doc-section-item">
<td>
<code>ead</code>
</td>
<td>
<code><span title="decimal.Decimal">Decimal</span></code>
</td>
<td>
<div class="doc-md-description">
<p>Exposure at default</p>
</div>
</td>
<td>
<em>required</em>
</td>
</tr>
<tr class="doc-section-item">
<td>
<code>exposure_class</code>
</td>
<td>
<code><span title="str">str</span></code>
</td>
<td>
<div class="doc-md-description">
<p>Exposure class</p>
</div>
</td>
<td>
<em>required</em>
</td>
</tr>
<tr class="doc-section-item">
<td>
<code>cqs</code>
</td>
<td>
<code><span title="int">int</span> | None</code>
</td>
<td>
<div class="doc-md-description">
<p>Credit quality step (1-6 or None for unrated)</p>
</div>
</td>
<td>
<code>None</code>
</td>
</tr>
<tr class="doc-section-item">
<td>
<code>ltv</code>
</td>
<td>
<code><span title="decimal.Decimal">Decimal</span> | None</code>
</td>
<td>
<div class="doc-md-description">
<p>Loan-to-value ratio (for real estate)</p>
</div>
</td>
<td>
<code>None</code>
</td>
</tr>
<tr class="doc-section-item">
<td>
<code>is_sme</code>
</td>
<td>
<code><span title="bool">bool</span></code>
</td>
<td>
<div class="doc-md-description">
<p>Whether SME supporting factor applies</p>
</div>
</td>
<td>
<code>False</code>
</td>
</tr>
<tr class="doc-section-item">
<td>
<code>is_infrastructure</code>
</td>
<td>
<code><span title="bool">bool</span></code>
</td>
<td>
<div class="doc-md-description">
<p>Whether infrastructure factor applies</p>
</div>
</td>
<td>
<code>False</code>
</td>
</tr>
<tr class="doc-section-item">
<td>
<code>is_managed_as_retail</code>
</td>
<td>
<code><span title="bool">bool</span></code>
</td>
<td>
<div class="doc-md-description">
<p>Whether SME is managed on pooled retail basis (CRR Art. 123)</p>
</div>
</td>
<td>
<code>False</code>
</td>
</tr>
<tr class="doc-section-item">
<td>
<code>config</code>
</td>
<td>
<code><span title="rwa_calc.contracts.config.CalculationConfig">CalculationConfig</span> | None</code>
</td>
<td>
<div class="doc-md-description">
<p>Calculation configuration (defaults to CRR)</p>
</div>
</td>
<td>
<code>None</code>
</td>
</tr>
</tbody>
</table>
<p><span class="doc-section-title">Returns:</span></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="doc-section-item">
<td>
<code><span title="dict">dict</span></code>
</td>
<td>
<div class="doc-md-description">
<p>Dictionary with calculation results</p>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div><h3 id="risk-weight-lookup">Risk Weight Lookup<a class="headerlink" href="#risk-weight-lookup" title="Permanent link">¶</a></h3>
<p>Risk weights are defined in <a href="https://github.com/OpenAfterHours/rwa_calculator/blob/master/src/rwa_calc/data/tables/crr_risk_weights.py"><code>data/tables/crr_risk_weights.py</code></a>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rwa_calc.data.tables.crr_risk_weights</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_combined_cqs_risk_weights</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="c1"># Get risk weight lookup table</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="n">rw_table</span> <span class="o">=</span> <span class="n">get_combined_cqs_risk_weights</span><span class="p">(</span><span class="n">use_uk_deviation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="c1"># Table includes: exposure_class, cqs, risk_weight</span>
</span><span id="__span-11-7"><a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="c1"># Example: CORPORATE, CQS 2 -&gt; 50%</span>
</span></code></pre></div>
<details class="example">
<summary>Actual Risk Weight Application (calculator.py)</summary>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_risk_weights</span><span class="p">(</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a>        <span class="n">exposures</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>        <span class="n">config</span><span class="p">:</span> <span class="n">CalculationConfig</span><span class="p">,</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">        </span><span class="sd">"""</span>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="sd">        Look up and apply risk weights based on exposure class.</span>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="sd">        Handles:</span>
</span><span id="__span-12-10"><a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="sd">        - CQS-based lookups (sovereign, institution, corporate)</span>
</span><span id="__span-12-11"><a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="sd">        - Fixed retail (75%)</span>
</span><span id="__span-12-12"><a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="sd">        - LTV-based real estate (split treatment)</span>
</span><span id="__span-12-13"><a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a>
</span><span id="__span-12-14"><a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="sd">        Args:</span>
</span><span id="__span-12-15"><a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="sd">            exposures: SA exposures with classification</span>
</span><span id="__span-12-16"><a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="sd">            config: Calculation configuration</span>
</span><span id="__span-12-17"><a href="#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a>
</span><span id="__span-12-18"><a href="#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="sd">        Returns:</span>
</span><span id="__span-12-19"><a href="#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="sd">            Exposures with risk_weight column added</span>
</span><span id="__span-12-20"><a href="#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="sd">        """</span>
</span><span id="__span-12-21"><a href="#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a>        <span class="c1"># Get CQS-based risk weight table (includes UK deviation for institutions)</span>
</span><span id="__span-12-22"><a href="#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a>        <span class="n">use_uk_deviation</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">base_currency</span> <span class="o">==</span> <span class="s2">"GBP"</span>
</span><span id="__span-12-23"><a href="#__codelineno-12-23" id="__codelineno-12-23" name="__codelineno-12-23"></a>        <span class="n">rw_table</span> <span class="o">=</span> <span class="n">get_combined_cqs_risk_weights</span><span class="p">(</span><span class="n">use_uk_deviation</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
</span><span id="__span-12-24"><a href="#__codelineno-12-24" id="__codelineno-12-24" name="__codelineno-12-24"></a>
</span><span id="__span-12-25"><a href="#__codelineno-12-25" id="__codelineno-12-25" name="__codelineno-12-25"></a>        <span class="c1"># Ensure required columns exist</span>
</span><span id="__span-12-26"><a href="#__codelineno-12-26" id="__codelineno-12-26" name="__codelineno-12-26"></a>        <span class="n">schema</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span>
</span><span id="__span-12-27"><a href="#__codelineno-12-27" id="__codelineno-12-27" name="__codelineno-12-27"></a>        <span class="k">if</span> <span class="s2">"ltv"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
</span><span id="__span-12-28"><a href="#__codelineno-12-28" id="__codelineno-12-28" name="__codelineno-12-28"></a>            <span class="n">exposures</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-12-29"><a href="#__codelineno-12-29" id="__codelineno-12-29" name="__codelineno-12-29"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"ltv"</span><span class="p">),</span>
</span><span id="__span-12-30"><a href="#__codelineno-12-30" id="__codelineno-12-30" name="__codelineno-12-30"></a>            <span class="p">])</span>
</span><span id="__span-12-31"><a href="#__codelineno-12-31" id="__codelineno-12-31" name="__codelineno-12-31"></a>        <span class="k">if</span> <span class="s2">"has_income_cover"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
</span><span id="__span-12-32"><a href="#__codelineno-12-32" id="__codelineno-12-32" name="__codelineno-12-32"></a>            <span class="n">exposures</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-12-33"><a href="#__codelineno-12-33" id="__codelineno-12-33" name="__codelineno-12-33"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"has_income_cover"</span><span class="p">),</span>
</span><span id="__span-12-34"><a href="#__codelineno-12-34" id="__codelineno-12-34" name="__codelineno-12-34"></a>            <span class="p">])</span>
</span><span id="__span-12-35"><a href="#__codelineno-12-35" id="__codelineno-12-35" name="__codelineno-12-35"></a>        <span class="k">if</span> <span class="s2">"book_code"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
</span><span id="__span-12-36"><a href="#__codelineno-12-36" id="__codelineno-12-36" name="__codelineno-12-36"></a>            <span class="n">exposures</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-12-37"><a href="#__codelineno-12-37" id="__codelineno-12-37" name="__codelineno-12-37"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"book_code"</span><span class="p">),</span>
</span><span id="__span-12-38"><a href="#__codelineno-12-38" id="__codelineno-12-38" name="__codelineno-12-38"></a>            <span class="p">])</span>
</span><span id="__span-12-39"><a href="#__codelineno-12-39" id="__codelineno-12-39" name="__codelineno-12-39"></a>        <span class="k">if</span> <span class="s2">"cp_is_managed_as_retail"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
</span><span id="__span-12-40"><a href="#__codelineno-12-40" id="__codelineno-12-40" name="__codelineno-12-40"></a>            <span class="n">exposures</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-12-41"><a href="#__codelineno-12-41" id="__codelineno-12-41" name="__codelineno-12-41"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"cp_is_managed_as_retail"</span><span class="p">),</span>
</span><span id="__span-12-42"><a href="#__codelineno-12-42" id="__codelineno-12-42" name="__codelineno-12-42"></a>            <span class="p">])</span>
</span><span id="__span-12-43"><a href="#__codelineno-12-43" id="__codelineno-12-43" name="__codelineno-12-43"></a>
</span><span id="__span-12-44"><a href="#__codelineno-12-44" id="__codelineno-12-44" name="__codelineno-12-44"></a>        <span class="c1"># Prepare exposures for join</span>
</span><span id="__span-12-45"><a href="#__codelineno-12-45" id="__codelineno-12-45" name="__codelineno-12-45"></a>        <span class="c1"># Normalize exposure class names for matching</span>
</span><span id="__span-12-46"><a href="#__codelineno-12-46" id="__codelineno-12-46" name="__codelineno-12-46"></a>        <span class="c1"># Use sentinel value -1 for null CQS to allow join (null != null in joins)</span>
</span><span id="__span-12-47"><a href="#__codelineno-12-47" id="__codelineno-12-47" name="__codelineno-12-47"></a>        <span class="n">exposures</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-12-48"><a href="#__codelineno-12-48" id="__codelineno-12-48" name="__codelineno-12-48"></a>            <span class="c1"># Map detailed classes to lookup classes</span>
</span><span id="__span-12-49"><a href="#__codelineno-12-49" id="__codelineno-12-49" name="__codelineno-12-49"></a>            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"(?i)sovereign"</span><span class="p">))</span>
</span><span id="__span-12-50"><a href="#__codelineno-12-50" id="__codelineno-12-50" name="__codelineno-12-50"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">"SOVEREIGN"</span><span class="p">))</span>
</span><span id="__span-12-51"><a href="#__codelineno-12-51" id="__codelineno-12-51" name="__codelineno-12-51"></a>            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"(?i)institution"</span><span class="p">))</span>
</span><span id="__span-12-52"><a href="#__codelineno-12-52" id="__codelineno-12-52" name="__codelineno-12-52"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">"INSTITUTION"</span><span class="p">))</span>
</span><span id="__span-12-53"><a href="#__codelineno-12-53" id="__codelineno-12-53" name="__codelineno-12-53"></a>            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"(?i)corporate"</span><span class="p">))</span>
</span><span id="__span-12-54"><a href="#__codelineno-12-54" id="__codelineno-12-54" name="__codelineno-12-54"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">"CORPORATE"</span><span class="p">))</span>
</span><span id="__span-12-55"><a href="#__codelineno-12-55" id="__codelineno-12-55" name="__codelineno-12-55"></a>            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">to_uppercase</span><span class="p">())</span>
</span><span id="__span-12-56"><a href="#__codelineno-12-56" id="__codelineno-12-56" name="__codelineno-12-56"></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"_lookup_class"</span><span class="p">),</span>
</span><span id="__span-12-57"><a href="#__codelineno-12-57" id="__codelineno-12-57" name="__codelineno-12-57"></a>
</span><span id="__span-12-58"><a href="#__codelineno-12-58" id="__codelineno-12-58" name="__codelineno-12-58"></a>            <span class="c1"># Use -1 as sentinel for null CQS (for join matching)</span>
</span><span id="__span-12-59"><a href="#__codelineno-12-59" id="__codelineno-12-59" name="__codelineno-12-59"></a>            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"cqs"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"_lookup_cqs"</span><span class="p">),</span>
</span><span id="__span-12-60"><a href="#__codelineno-12-60" id="__codelineno-12-60" name="__codelineno-12-60"></a>        <span class="p">])</span>
</span><span id="__span-12-61"><a href="#__codelineno-12-61" id="__codelineno-12-61" name="__codelineno-12-61"></a>
</span><span id="__span-12-62"><a href="#__codelineno-12-62" id="__codelineno-12-62" name="__codelineno-12-62"></a>        <span class="c1"># Prepare risk weight table with same sentinel for null CQS</span>
</span><span id="__span-12-63"><a href="#__codelineno-12-63" id="__codelineno-12-63" name="__codelineno-12-63"></a>        <span class="n">rw_table</span> <span class="o">=</span> <span class="n">rw_table</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-12-64"><a href="#__codelineno-12-64" id="__codelineno-12-64" name="__codelineno-12-64"></a>            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"cqs"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int8</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"cqs"</span><span class="p">),</span>
</span><span id="__span-12-65"><a href="#__codelineno-12-65" id="__codelineno-12-65" name="__codelineno-12-65"></a>        <span class="p">])</span>
</span><span id="__span-12-66"><a href="#__codelineno-12-66" id="__codelineno-12-66" name="__codelineno-12-66"></a>
</span><span id="__span-12-67"><a href="#__codelineno-12-67" id="__codelineno-12-67" name="__codelineno-12-67"></a>        <span class="c1"># Join risk weight table</span>
</span><span id="__span-12-68"><a href="#__codelineno-12-68" id="__codelineno-12-68" name="__codelineno-12-68"></a>        <span class="n">exposures</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-12-69"><a href="#__codelineno-12-69" id="__codelineno-12-69" name="__codelineno-12-69"></a>            <span class="n">rw_table</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">"exposure_class"</span><span class="p">,</span> <span class="s2">"cqs"</span><span class="p">,</span> <span class="s2">"risk_weight"</span><span class="p">]),</span>
</span><span id="__span-12-70"><a href="#__codelineno-12-70" id="__codelineno-12-70" name="__codelineno-12-70"></a>            <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">"_lookup_class"</span><span class="p">,</span> <span class="s2">"_lookup_cqs"</span><span class="p">],</span>
</span><span id="__span-12-71"><a href="#__codelineno-12-71" id="__codelineno-12-71" name="__codelineno-12-71"></a>            <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">"exposure_class"</span><span class="p">,</span> <span class="s2">"cqs"</span><span class="p">],</span>
</span><span id="__span-12-72"><a href="#__codelineno-12-72" id="__codelineno-12-72" name="__codelineno-12-72"></a>            <span class="n">how</span><span class="o">=</span><span class="s2">"left"</span><span class="p">,</span>
</span><span id="__span-12-73"><a href="#__codelineno-12-73" id="__codelineno-12-73" name="__codelineno-12-73"></a>            <span class="n">suffix</span><span class="o">=</span><span class="s2">"_rw"</span><span class="p">,</span>
</span><span id="__span-12-74"><a href="#__codelineno-12-74" id="__codelineno-12-74" name="__codelineno-12-74"></a>        <span class="p">)</span>
</span><span id="__span-12-75"><a href="#__codelineno-12-75" id="__codelineno-12-75" name="__codelineno-12-75"></a>
</span><span id="__span-12-76"><a href="#__codelineno-12-76" id="__codelineno-12-76" name="__codelineno-12-76"></a>        <span class="c1"># Apply class-specific risk weights</span>
</span><span id="__span-12-77"><a href="#__codelineno-12-77" id="__codelineno-12-77" name="__codelineno-12-77"></a>        <span class="n">retail_rw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">RETAIL_RISK_WEIGHT</span><span class="p">)</span>
</span><span id="__span-12-78"><a href="#__codelineno-12-78" id="__codelineno-12-78" name="__codelineno-12-78"></a>        <span class="n">resi_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">RESIDENTIAL_MORTGAGE_PARAMS</span><span class="p">[</span><span class="s2">"ltv_threshold"</span><span class="p">])</span>
</span><span id="__span-12-79"><a href="#__codelineno-12-79" id="__codelineno-12-79" name="__codelineno-12-79"></a>        <span class="n">resi_rw_low</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">RESIDENTIAL_MORTGAGE_PARAMS</span><span class="p">[</span><span class="s2">"rw_low_ltv"</span><span class="p">])</span>
</span><span id="__span-12-80"><a href="#__codelineno-12-80" id="__codelineno-12-80" name="__codelineno-12-80"></a>        <span class="n">resi_rw_high</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">RESIDENTIAL_MORTGAGE_PARAMS</span><span class="p">[</span><span class="s2">"rw_high_ltv"</span><span class="p">])</span>
</span><span id="__span-12-81"><a href="#__codelineno-12-81" id="__codelineno-12-81" name="__codelineno-12-81"></a>        <span class="n">cre_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">COMMERCIAL_RE_PARAMS</span><span class="p">[</span><span class="s2">"ltv_threshold"</span><span class="p">])</span>
</span><span id="__span-12-82"><a href="#__codelineno-12-82" id="__codelineno-12-82" name="__codelineno-12-82"></a>        <span class="n">cre_rw_low</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">COMMERCIAL_RE_PARAMS</span><span class="p">[</span><span class="s2">"rw_low_ltv"</span><span class="p">])</span>
</span><span id="__span-12-83"><a href="#__codelineno-12-83" id="__codelineno-12-83" name="__codelineno-12-83"></a>        <span class="n">cre_rw_standard</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">COMMERCIAL_RE_PARAMS</span><span class="p">[</span><span class="s2">"rw_standard"</span><span class="p">])</span>
</span><span id="__span-12-84"><a href="#__codelineno-12-84" id="__codelineno-12-84" name="__codelineno-12-84"></a>
</span><span id="__span-12-85"><a href="#__codelineno-12-85" id="__codelineno-12-85" name="__codelineno-12-85"></a>        <span class="n">exposures</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
</span><span id="__span-12-86"><a href="#__codelineno-12-86" id="__codelineno-12-86" name="__codelineno-12-86"></a>            <span class="c1"># Order matters: check specific classes before generic ones</span>
</span><span id="__span-12-87"><a href="#__codelineno-12-87" id="__codelineno-12-87" name="__codelineno-12-87"></a>            <span class="c1"># 1. Residential mortgage: LTV-based (must come before retail)</span>
</span><span id="__span-12-88"><a href="#__codelineno-12-88" id="__codelineno-12-88" name="__codelineno-12-88"></a>            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"(?i)mortgage|residential"</span><span class="p">))</span>
</span><span id="__span-12-89"><a href="#__codelineno-12-89" id="__codelineno-12-89" name="__codelineno-12-89"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span>
</span><span id="__span-12-90"><a href="#__codelineno-12-90" id="__codelineno-12-90" name="__codelineno-12-90"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ltv"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">resi_threshold</span><span class="p">)</span>
</span><span id="__span-12-91"><a href="#__codelineno-12-91" id="__codelineno-12-91" name="__codelineno-12-91"></a>                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">resi_rw_low</span><span class="p">))</span>
</span><span id="__span-12-92"><a href="#__codelineno-12-92" id="__codelineno-12-92" name="__codelineno-12-92"></a>                <span class="c1"># High LTV: weighted average</span>
</span><span id="__span-12-93"><a href="#__codelineno-12-93" id="__codelineno-12-93" name="__codelineno-12-93"></a>                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span>
</span><span id="__span-12-94"><a href="#__codelineno-12-94" id="__codelineno-12-94" name="__codelineno-12-94"></a>                    <span class="c1"># portion_low = threshold / ltv</span>
</span><span id="__span-12-95"><a href="#__codelineno-12-95" id="__codelineno-12-95" name="__codelineno-12-95"></a>                    <span class="c1"># portion_high = (ltv - threshold) / ltv</span>
</span><span id="__span-12-96"><a href="#__codelineno-12-96" id="__codelineno-12-96" name="__codelineno-12-96"></a>                    <span class="c1"># avg_rw = rw_low * portion_low + rw_high * portion_high</span>
</span><span id="__span-12-97"><a href="#__codelineno-12-97" id="__codelineno-12-97" name="__codelineno-12-97"></a>                    <span class="p">(</span><span class="n">resi_rw_low</span> <span class="o">*</span> <span class="n">resi_threshold</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ltv"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span>
</span><span id="__span-12-98"><a href="#__codelineno-12-98" id="__codelineno-12-98" name="__codelineno-12-98"></a>                     <span class="n">resi_rw_high</span> <span class="o">*</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ltv"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">resi_threshold</span><span class="p">)</span> <span class="o">/</span>
</span><span id="__span-12-99"><a href="#__codelineno-12-99" id="__codelineno-12-99" name="__codelineno-12-99"></a>                     <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ltv"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</span><span id="__span-12-100"><a href="#__codelineno-12-100" id="__codelineno-12-100" name="__codelineno-12-100"></a>                <span class="p">)</span>
</span><span id="__span-12-101"><a href="#__codelineno-12-101" id="__codelineno-12-101" name="__codelineno-12-101"></a>            <span class="p">)</span>
</span><span id="__span-12-102"><a href="#__codelineno-12-102" id="__codelineno-12-102" name="__codelineno-12-102"></a>
</span><span id="__span-12-103"><a href="#__codelineno-12-103" id="__codelineno-12-103" name="__codelineno-12-103"></a>            <span class="c1"># 2. Commercial RE: LTV + income cover based</span>
</span><span id="__span-12-104"><a href="#__codelineno-12-104" id="__codelineno-12-104" name="__codelineno-12-104"></a>            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"(?i)commercial.*re|cre"</span><span class="p">))</span>
</span><span id="__span-12-105"><a href="#__codelineno-12-105" id="__codelineno-12-105" name="__codelineno-12-105"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span>
</span><span id="__span-12-106"><a href="#__codelineno-12-106" id="__codelineno-12-106" name="__codelineno-12-106"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
</span><span id="__span-12-107"><a href="#__codelineno-12-107" id="__codelineno-12-107" name="__codelineno-12-107"></a>                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ltv"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">cre_threshold</span><span class="p">)</span> <span class="o">&amp;</span>
</span><span id="__span-12-108"><a href="#__codelineno-12-108" id="__codelineno-12-108" name="__codelineno-12-108"></a>                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"has_income_cover"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-12-109"><a href="#__codelineno-12-109" id="__codelineno-12-109" name="__codelineno-12-109"></a>                <span class="p">)</span>
</span><span id="__span-12-110"><a href="#__codelineno-12-110" id="__codelineno-12-110" name="__codelineno-12-110"></a>                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">cre_rw_low</span><span class="p">))</span>
</span><span id="__span-12-111"><a href="#__codelineno-12-111" id="__codelineno-12-111" name="__codelineno-12-111"></a>                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">cre_rw_standard</span><span class="p">))</span>
</span><span id="__span-12-112"><a href="#__codelineno-12-112" id="__codelineno-12-112" name="__codelineno-12-112"></a>            <span class="p">)</span>
</span><span id="__span-12-113"><a href="#__codelineno-12-113" id="__codelineno-12-113" name="__codelineno-12-113"></a>
</span><span id="__span-12-114"><a href="#__codelineno-12-114" id="__codelineno-12-114" name="__codelineno-12-114"></a>            <span class="c1"># 3. SME managed as retail: 75% RW (CRR Art. 123)</span>
</span><span id="__span-12-115"><a href="#__codelineno-12-115" id="__codelineno-12-115" name="__codelineno-12-115"></a>            <span class="o">.</span><span class="n">when</span><span class="p">(</span>
</span><span id="__span-12-116"><a href="#__codelineno-12-116" id="__codelineno-12-116" name="__codelineno-12-116"></a>                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"(?i)sme"</span><span class="p">))</span> <span class="o">&amp;</span>
</span><span id="__span-12-117"><a href="#__codelineno-12-117" id="__codelineno-12-117" name="__codelineno-12-117"></a>                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"cp_is_managed_as_retail"</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: E712</span>
</span><span id="__span-12-118"><a href="#__codelineno-12-118" id="__codelineno-12-118" name="__codelineno-12-118"></a>            <span class="p">)</span>
</span><span id="__span-12-119"><a href="#__codelineno-12-119" id="__codelineno-12-119" name="__codelineno-12-119"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">retail_rw</span><span class="p">))</span>
</span><span id="__span-12-120"><a href="#__codelineno-12-120" id="__codelineno-12-120" name="__codelineno-12-120"></a>
</span><span id="__span-12-121"><a href="#__codelineno-12-121" id="__codelineno-12-121" name="__codelineno-12-121"></a>            <span class="c1"># 4. Corporate SME: 100% RW (then reduced by SME supporting factor)</span>
</span><span id="__span-12-122"><a href="#__codelineno-12-122" id="__codelineno-12-122" name="__codelineno-12-122"></a>            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"(?i)corporate.*sme|sme.*corporate"</span><span class="p">))</span>
</span><span id="__span-12-123"><a href="#__codelineno-12-123" id="__codelineno-12-123" name="__codelineno-12-123"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</span><span id="__span-12-124"><a href="#__codelineno-12-124" id="__codelineno-12-124" name="__codelineno-12-124"></a>
</span><span id="__span-12-125"><a href="#__codelineno-12-125" id="__codelineno-12-125" name="__codelineno-12-125"></a>            <span class="c1"># 5. Retail (non-mortgage): 75% flat</span>
</span><span id="__span-12-126"><a href="#__codelineno-12-126" id="__codelineno-12-126" name="__codelineno-12-126"></a>            <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"exposure_class"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"(?i)retail"</span><span class="p">))</span>
</span><span id="__span-12-127"><a href="#__codelineno-12-127" id="__codelineno-12-127" name="__codelineno-12-127"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">retail_rw</span><span class="p">))</span>
</span><span id="__span-12-128"><a href="#__codelineno-12-128" id="__codelineno-12-128" name="__codelineno-12-128"></a>
</span><span id="__span-12-129"><a href="#__codelineno-12-129" id="__codelineno-12-129" name="__codelineno-12-129"></a>            <span class="c1"># 5. Default: use joined CQS-based risk weight, or 100%</span>
</span><span id="__span-12-130"><a href="#__codelineno-12-130" id="__codelineno-12-130" name="__codelineno-12-130"></a>            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"risk_weight"</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</span><span id="__span-12-131"><a href="#__codelineno-12-131" id="__codelineno-12-131" name="__codelineno-12-131"></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"risk_weight"</span><span class="p">),</span>
</span><span id="__span-12-132"><a href="#__codelineno-12-132" id="__codelineno-12-132" name="__codelineno-12-132"></a>        <span class="p">])</span>
</span><span id="__span-12-133"><a href="#__codelineno-12-133" id="__codelineno-12-133" name="__codelineno-12-133"></a>
</span><span id="__span-12-134"><a href="#__codelineno-12-134" id="__codelineno-12-134" name="__codelineno-12-134"></a>        <span class="c1"># Clean up temporary columns</span>
</span><span id="__span-12-135"><a href="#__codelineno-12-135" id="__codelineno-12-135" name="__codelineno-12-135"></a>        <span class="n">exposures</span> <span class="o">=</span> <span class="n">exposures</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span>
</span><span id="__span-12-136"><a href="#__codelineno-12-136" id="__codelineno-12-136" name="__codelineno-12-136"></a>            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"_lookup_class"</span><span class="p">,</span> <span class="s2">"_lookup_cqs"</span><span class="p">,</span> <span class="s2">"risk_weight_rw"</span><span class="p">]</span>
</span><span id="__span-12-137"><a href="#__codelineno-12-137" id="__codelineno-12-137" name="__codelineno-12-137"></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">exposures</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
</span><span id="__span-12-138"><a href="#__codelineno-12-138" id="__codelineno-12-138" name="__codelineno-12-138"></a>        <span class="p">])</span>
</span><span id="__span-12-139"><a href="#__codelineno-12-139" id="__codelineno-12-139" name="__codelineno-12-139"></a>
</span><span id="__span-12-140"><a href="#__codelineno-12-140" id="__codelineno-12-140" name="__codelineno-12-140"></a>        <span class="k">return</span> <span class="n">exposures</span>
</span></code></pre></div>
</details>
<h2 id="regulatory-references">Regulatory References<a class="headerlink" href="#regulatory-references" title="Permanent link">¶</a></h2>
<table>
<thead>
<tr>
<th>Topic</th>
<th>CRR Article</th>
<th>BCBS CRE</th>
</tr>
</thead>
<tbody>
<tr>
<td>Risk weight assignment</td>
<td>Art. 113-134</td>
<td>CRE20-22</td>
</tr>
<tr>
<td>CCFs</td>
<td>Art. 111</td>
<td>CRE20.10</td>
</tr>
<tr>
<td>CRM</td>
<td>Art. 192-241</td>
<td>CRE22</td>
</tr>
<tr>
<td>SME factor</td>
<td>Art. 501</td>
<td>N/A</td>
</tr>
<tr>
<td>Real estate</td>
<td>Art. 124-125</td>
<td>CRE20.70-90</td>
</tr>
</tbody>
</table>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">¶</a></h2>
<ul>
<li><a href="../irb-approach/">IRB Approach</a> - Internal ratings-based methodology</li>
<li><a href="../crm/">Credit Risk Mitigation</a> - CRM techniques in detail</li>
<li><a href="../supporting-factors/">Supporting Factors</a> - SME and infrastructure factors</li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/OpenAfterHours/rwa_calculator" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.path", "navigation.indexes", "toc.follow", "search.suggest", "search.highlight", "content.tabs.link", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
</body>
</html>