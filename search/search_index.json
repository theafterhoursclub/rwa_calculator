{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"UK Credit Risk RWA Calculator","text":"<p>Welcome to the documentation for the UK Credit Risk RWA Calculator - a high-performance system for calculating Risk-Weighted Assets (RWA) for UK credit risk exposures.</p> <p>Development Status</p> <p>This package is still in development and is not yet production ready. APIs may change between versions.</p> <p>Documentation: https://OpenAfterHours.github.io/rwa_calculator/</p> <p>Source Code: https://github.com/OpenAfterHours/rwa_calculator</p>"},{"location":"#overview","title":"Overview","text":"<p>This calculator supports both current and forthcoming UK regulatory frameworks:</p> Framework Status Effective Date CRR (Basel 3.0) Active Until 31 December 2026 Basel 3.1 (PRA PS9/24) Planned From 1 January 2027 <p>The system provides accurate, auditable RWA calculations across all major exposure classes using both the Standardised Approach (SA) and Internal Ratings-Based (IRB) approaches.</p>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>Dual-Framework Support: Single codebase supporting both CRR and Basel 3.1 regulations</li> <li>High Performance: Built on Polars LazyFrames for vectorized operations, achieving 50-100x performance improvements</li> <li>Full Regulatory Coverage: Implements all exposure classes including Central Govt / Central Bank, Institution, Corporate, Retail, and Specialised Lending</li> <li>Credit Risk Mitigation: Complete CRM support including collateral, guarantees, and provisions</li> <li>Audit Trail: Error accumulation and full traceability for regulatory compliance</li> <li>Extensible Architecture: Protocol-based design enabling easy customization</li> </ul>"},{"location":"#who-is-this-documentation-for","title":"Who Is This Documentation For?","text":"<p>This documentation serves multiple audiences:</p>"},{"location":"#for-engineers","title":"For Engineers","text":"<ul> <li>Architecture Guide - Understand the system design and components</li> <li>API Reference - Complete API documentation for all modules</li> <li>Development Guide - Testing, extending, and contributing</li> </ul>"},{"location":"#for-risk-audit-teams","title":"For Risk &amp; Audit Teams","text":"<ul> <li>Regulatory Frameworks - Detailed coverage of CRR and Basel 3.1 requirements</li> <li>Calculation Methodology - How RWAs are calculated</li> <li>Exposure Classes - Classification and treatment of exposures</li> </ul>"},{"location":"#for-business-users","title":"For Business Users","text":"<ul> <li>Getting Started - Quick introduction and setup</li> <li>User Guide - Comprehensive usage documentation</li> <li>Glossary - Terminology and definitions</li> </ul>"},{"location":"#quick-navigation","title":"Quick Navigation","text":"<ul> <li> <p> Getting Started</p> <p>Install the calculator and run your first RWA calculation</p> <p> Quick Start</p> </li> <li> <p> Regulatory Frameworks</p> <p>Understand CRR and Basel 3.1 regulatory requirements</p> <p> Regulations</p> </li> <li> <p> Calculation Methods</p> <p>Learn how SA, IRB, and CRM calculations work</p> <p> Methodology</p> </li> <li> <p> API Reference</p> <p>Complete technical documentation for developers</p> <p> API Docs</p> </li> </ul>"},{"location":"#calculation-pipeline-overview","title":"Calculation Pipeline Overview","text":"<p>The RWA calculator processes exposures through a well-defined pipeline:</p> <pre><code>graph LR\n    A[Raw Data] --&gt; B[Loader]\n    B --&gt; C[Hierarchy Resolver]\n    C --&gt; D[Classifier]\n    D --&gt; E[CRM Processor]\n    E --&gt; F{Approach}\n    F --&gt;|SA| G[SA Calculator]\n    F --&gt;|IRB| H[IRB Calculator]\n    F --&gt;|Slotting| I[Slotting Calculator]\n    F --&gt;|Equity| L[Equity Calculator]\n    G --&gt; J[Aggregator]\n    H --&gt; J\n    I --&gt; J\n    L --&gt; J\n    J --&gt; K[Final RWA]</code></pre>"},{"location":"#supported-calculations","title":"Supported Calculations","text":""},{"location":"#by-approach","title":"By Approach","text":"Approach Description Framework Support Standardised (SA) Risk weights based on external ratings and exposure characteristics CRR, Basel 3.1 Foundation IRB (F-IRB) Bank-estimated PD, supervisory LGD CRR, Basel 3.1 Advanced IRB (A-IRB) Bank-estimated PD, LGD, and EAD CRR, Basel 3.1 Slotting Category-based approach for specialised lending CRR, Basel 3.1 Equity Risk weights for equity holdings (Art. 133 SA / Art. 155 IRB Simple) CRR, Basel 3.1"},{"location":"#by-exposure-class","title":"By Exposure Class","text":"Class SA F-IRB A-IRB Slotting Central Govt / Central Bank Institution Corporate Corporate SME Retail Mortgage Retail QRRE Retail Other Specialised Lending Equity"},{"location":"#technology-stack","title":"Technology Stack","text":"<p>The calculator is built using modern, high-performance technologies:</p> <ul> <li>Python 3.13+ - Latest Python features</li> <li>Polars - Vectorized DataFrame operations with LazyFrame optimization</li> <li>Pydantic - Data validation and type safety</li> <li>polars-normal-stats - Pure Polars statistical functions for IRB formulas</li> <li>Pytest - Comprehensive test coverage (1,188+ tests)</li> </ul>"},{"location":"#regulatory-references","title":"Regulatory References","text":"<p>This implementation follows:</p> <ul> <li>PRA Rulebook - CRR Firms rules</li> <li>UK CRR - EU 575/2013 as onshored</li> <li>PRA PS9/24 - Basel 3.1 implementation policy statement</li> <li>BCBS CRE Standards - Basel Committee credit risk standards</li> </ul> <p>See the Regulatory References appendix for complete documentation links.</p>"},{"location":"#version-information","title":"Version Information","text":"Component Version Calculator 0.1.21 CRR Support Full Basel 3.1 Support In Development Python Required &gt;= 3.13"},{"location":"api/","title":"API Reference","text":"<p>This section provides complete API documentation for the RWA calculator modules.</p>"},{"location":"api/#module-overview","title":"Module Overview","text":"Module Purpose Pipeline Main orchestration and entry points Configuration Configuration classes and factories Engine Calculation components Contracts Interfaces and data contracts Domain Enumerations and core types"},{"location":"api/#quick-reference","title":"Quick Reference","text":""},{"location":"api/#main-entry-point","title":"Main Entry Point","text":"<pre><code>from rwa_calc.engine.pipeline import create_pipeline\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# Create and run pipeline\npipeline = create_pipeline()\nconfig = CalculationConfig.crr(date(2026, 12, 31))\nresult = pipeline.run(config)\n</code></pre>"},{"location":"api/#configuration","title":"Configuration","text":"<pre><code>from rwa_calc.contracts.config import CalculationConfig\n\n# CRR configuration\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=True,\n)\n\n# Basel 3.1 configuration\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2027, 1, 1),\n    output_floor_percentage=0.725,\n)\n</code></pre>"},{"location":"api/#enumerations","title":"Enumerations","text":"<pre><code>from rwa_calc.domain.enums import (\n    RegulatoryFramework,\n    ExposureClass,\n    ApproachType,\n    CQS,\n    CollateralType,\n)\n</code></pre>"},{"location":"api/#data-contracts","title":"Data Contracts","text":"<pre><code>from rwa_calc.contracts.bundles import (\n    RawDataBundle,\n    ResolvedHierarchyBundle,\n    ClassifiedExposuresBundle,\n    CRMAdjustedBundle,\n    SAResultBundle,\n    IRBResultBundle,\n    SlottingResultBundle,\n    AggregatedResultBundle,\n)\n</code></pre>"},{"location":"api/#api-sections","title":"API Sections","text":"<ul> <li>Pipeline API - Pipeline creation and execution</li> <li>Configuration API - Configuration classes</li> <li>Engine API - Calculation components</li> <li>Contracts API - Data contracts and protocols</li> <li>Domain API - Enumerations and types</li> </ul>"},{"location":"api/configuration/","title":"Configuration API","text":"<p>The configuration module provides classes for controlling calculation behavior.</p>"},{"location":"api/configuration/#module-rwa_calccontractsconfig","title":"Module: <code>rwa_calc.contracts.config</code>","text":""},{"location":"api/configuration/#calculationconfig","title":"<code>CalculationConfig</code>","text":"<pre><code>@dataclass(frozen=True)\nclass CalculationConfig:\n    \"\"\"\n    Main configuration for RWA calculations.\n\n    Attributes:\n        framework: Regulatory framework (CRR or BASEL_3_1).\n        reporting_date: Calculation reference date.\n        scaling_factor: IRB scaling factor (1.06 for CRR, 1.0 for Basel 3.1).\n        pd_floors: PD floor values by exposure class.\n        lgd_floors: LGD floor values (Basel 3.1 A-IRB only).\n        supporting_factors: Supporting factor configuration.\n        output_floor_config: Output floor configuration (Basel 3.1 only).\n        eur_gbp_rate: EUR to GBP conversion rate.\n    \"\"\"\n\n    framework: RegulatoryFramework\n    reporting_date: date\n    scaling_factor: Decimal\n    pd_floors: PDFloors\n    lgd_floors: LGDFloors | None\n    supporting_factors: SupportingFactors\n    output_floor_config: OutputFloorConfig | None\n    eur_gbp_rate: Decimal\n\n    @classmethod\n    def crr(\n        cls,\n        reporting_date: date,\n        apply_sme_supporting_factor: bool = True,\n        apply_infrastructure_factor: bool = True,\n        eur_gbp_rate: Decimal = Decimal(\"0.88\"),\n    ) -&gt; \"CalculationConfig\":\n        \"\"\"\n        Create CRR (Basel 3.0) configuration.\n\n        Args:\n            reporting_date: Calculation reference date.\n            apply_sme_supporting_factor: Apply SME factor (Art. 501).\n            apply_infrastructure_factor: Apply infrastructure factor.\n            eur_gbp_rate: EUR to GBP conversion rate.\n\n        Returns:\n            CalculationConfig: CRR configuration.\n\n        Example:\n            &gt;&gt;&gt; config = CalculationConfig.crr(\n            ...     reporting_date=date(2026, 12, 31),\n            ...     apply_sme_supporting_factor=True,\n            ... )\n        \"\"\"\n\n    @classmethod\n    def basel_3_1(\n        cls,\n        reporting_date: date,\n        output_floor_percentage: float = 0.725,\n        transitional_floor_year: int | None = None,\n        eur_gbp_rate: Decimal = Decimal(\"0.88\"),\n    ) -&gt; \"CalculationConfig\":\n        \"\"\"\n        Create Basel 3.1 configuration.\n\n        Args:\n            reporting_date: Calculation reference date.\n            output_floor_percentage: Output floor (default 72.5%).\n            transitional_floor_year: Year for transitional phase-in.\n            eur_gbp_rate: EUR to GBP conversion rate.\n\n        Returns:\n            CalculationConfig: Basel 3.1 configuration.\n\n        Example:\n            &gt;&gt;&gt; config = CalculationConfig.basel_3_1(\n            ...     reporting_date=date(2027, 1, 1),\n            ...     output_floor_percentage=0.725,\n            ... )\n        \"\"\"\n</code></pre>"},{"location":"api/configuration/#pdfloors","title":"<code>PDFloors</code>","text":"<pre><code>@dataclass(frozen=True)\nclass PDFloors:\n    \"\"\"\n    PD floor values by exposure class.\n\n    Attributes:\n        corporate: Corporate PD floor.\n        institution: Institution PD floor.\n        retail_mortgage: Retail mortgage PD floor.\n        retail_qrre_transactor: QRRE transactor PD floor.\n        retail_qrre_revolver: QRRE revolver PD floor.\n        retail_other: Other retail PD floor.\n    \"\"\"\n\n    corporate: Decimal\n    institution: Decimal\n    retail_mortgage: Decimal\n    retail_qrre_transactor: Decimal\n    retail_qrre_revolver: Decimal\n    retail_other: Decimal\n\n    @classmethod\n    def crr(cls) -&gt; \"PDFloors\":\n        \"\"\"Create CRR PD floors (uniform 0.03%).\"\"\"\n        return cls(\n            corporate=Decimal(\"0.0003\"),\n            institution=Decimal(\"0.0003\"),\n            retail_mortgage=Decimal(\"0.0003\"),\n            retail_qrre_transactor=Decimal(\"0.0003\"),\n            retail_qrre_revolver=Decimal(\"0.0003\"),\n            retail_other=Decimal(\"0.0003\"),\n        )\n\n    @classmethod\n    def basel_3_1(cls) -&gt; \"PDFloors\":\n        \"\"\"Create Basel 3.1 PD floors (differentiated).\"\"\"\n        return cls(\n            corporate=Decimal(\"0.0005\"),\n            institution=Decimal(\"0.0005\"),\n            retail_mortgage=Decimal(\"0.0005\"),\n            retail_qrre_transactor=Decimal(\"0.0003\"),\n            retail_qrre_revolver=Decimal(\"0.0010\"),\n            retail_other=Decimal(\"0.0005\"),\n        )\n\n    def get_floor(self, exposure_class: ExposureClass) -&gt; Decimal:\n        \"\"\"Get PD floor for exposure class.\"\"\"\n</code></pre>"},{"location":"api/configuration/#lgdfloors","title":"<code>LGDFloors</code>","text":"<pre><code>@dataclass(frozen=True)\nclass LGDFloors:\n    \"\"\"\n    LGD floor values by collateral type (Basel 3.1 A-IRB).\n\n    Attributes:\n        unsecured_senior: Unsecured senior debt floor.\n        unsecured_subordinated: Subordinated debt floor.\n        financial_collateral: Financial collateral floor.\n        receivables: Receivables floor.\n        cre: Commercial real estate floor.\n        rre: Residential real estate floor.\n        other_physical: Other physical collateral floor.\n    \"\"\"\n\n    unsecured_senior: Decimal = Decimal(\"0.25\")\n    unsecured_subordinated: Decimal = Decimal(\"0.50\")\n    financial_collateral: Decimal = Decimal(\"0.00\")\n    receivables: Decimal = Decimal(\"0.15\")\n    cre: Decimal = Decimal(\"0.15\")\n    rre: Decimal = Decimal(\"0.10\")\n    other_physical: Decimal = Decimal(\"0.20\")\n\n    def get_floor(self, collateral_type: CollateralType) -&gt; Decimal:\n        \"\"\"Get LGD floor for collateral type.\"\"\"\n</code></pre>"},{"location":"api/configuration/#supportingfactors","title":"<code>SupportingFactors</code>","text":"<pre><code>@dataclass(frozen=True)\nclass SupportingFactors:\n    \"\"\"\n    Supporting factor configuration.\n\n    Attributes:\n        apply_sme_factor: Apply SME supporting factor.\n        apply_infrastructure_factor: Apply infrastructure factor.\n        sme_threshold: EUR exposure threshold for tiered factor.\n        sme_factor_below: Factor for exposure below threshold.\n        sme_factor_above: Factor for exposure above threshold.\n        infrastructure_factor: Infrastructure factor value.\n    \"\"\"\n\n    apply_sme_factor: bool\n    apply_infrastructure_factor: bool\n    sme_threshold: Decimal\n    sme_factor_below: Decimal\n    sme_factor_above: Decimal\n    infrastructure_factor: Decimal\n\n    @classmethod\n    def crr(\n        cls,\n        apply_sme: bool = True,\n        apply_infrastructure: bool = True,\n    ) -&gt; \"SupportingFactors\":\n        \"\"\"Create CRR supporting factors.\"\"\"\n        return cls(\n            apply_sme_factor=apply_sme,\n            apply_infrastructure_factor=apply_infrastructure,\n            sme_threshold=Decimal(\"2500000\"),\n            sme_factor_below=Decimal(\"0.7619\"),\n            sme_factor_above=Decimal(\"0.85\"),\n            infrastructure_factor=Decimal(\"0.75\"),\n        )\n\n    @classmethod\n    def none(cls) -&gt; \"SupportingFactors\":\n        \"\"\"Create configuration with no supporting factors.\"\"\"\n        return cls(\n            apply_sme_factor=False,\n            apply_infrastructure_factor=False,\n            sme_threshold=Decimal(\"0\"),\n            sme_factor_below=Decimal(\"1.0\"),\n            sme_factor_above=Decimal(\"1.0\"),\n            infrastructure_factor=Decimal(\"1.0\"),\n        )\n</code></pre>"},{"location":"api/configuration/#outputfloorconfig","title":"<code>OutputFloorConfig</code>","text":"<pre><code>@dataclass(frozen=True)\nclass OutputFloorConfig:\n    \"\"\"\n    Output floor configuration (Basel 3.1).\n\n    Attributes:\n        floor_percentage: Floor as percentage of SA RWA.\n        is_transitional: Whether using transitional phase-in.\n        transitional_year: Year for phase-in calculation.\n    \"\"\"\n\n    floor_percentage: Decimal\n    is_transitional: bool = False\n    transitional_year: int | None = None\n\n    @classmethod\n    def full(cls) -&gt; \"OutputFloorConfig\":\n        \"\"\"Create fully phased-in floor (72.5%).\"\"\"\n        return cls(floor_percentage=Decimal(\"0.725\"))\n\n    @classmethod\n    def transitional(cls, year: int) -&gt; \"OutputFloorConfig\":\n        \"\"\"Create transitional floor for given year.\"\"\"\n        phase_in = {\n            2027: Decimal(\"0.50\"),\n            2028: Decimal(\"0.55\"),\n            2029: Decimal(\"0.60\"),\n            2030: Decimal(\"0.65\"),\n            2031: Decimal(\"0.70\"),\n        }\n        return cls(\n            floor_percentage=phase_in.get(year, Decimal(\"0.725\")),\n            is_transitional=True,\n            transitional_year=year,\n        )\n</code></pre>"},{"location":"api/configuration/#usage-examples","title":"Usage Examples","text":""},{"location":"api/configuration/#crr-configuration","title":"CRR Configuration","text":"<pre><code>from datetime import date\nfrom decimal import Decimal\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# Full CRR with all options\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=True,\n    apply_infrastructure_factor=True,\n    eur_gbp_rate=Decimal(\"0.88\"),\n)\n\n# Access configuration\nprint(f\"Framework: {config.framework}\")\nprint(f\"Scaling factor: {config.scaling_factor}\")\nprint(f\"SME factor enabled: {config.supporting_factors.apply_sme_factor}\")\n</code></pre>"},{"location":"api/configuration/#basel-31-configuration","title":"Basel 3.1 Configuration","text":"<pre><code># Full phase-in\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2032, 1, 1),\n    output_floor_percentage=0.725,\n)\n\n# Transitional (2027)\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2027, 6, 30),\n    transitional_floor_year=2027,  # 50% floor\n)\n</code></pre>"},{"location":"api/configuration/#accessing-floors","title":"Accessing Floors","text":"<pre><code>from rwa_calc.domain.enums import ExposureClass, CollateralType\n\n# PD floor lookup\npd_floor = config.pd_floors.get_floor(ExposureClass.CORPORATE)\nprint(f\"Corporate PD floor: {pd_floor:.4%}\")\n\n# LGD floor lookup (Basel 3.1 only)\nif config.lgd_floors:\n    lgd_floor = config.lgd_floors.get_floor(CollateralType.RESIDENTIAL_REAL_ESTATE)\n    print(f\"RRE LGD floor: {lgd_floor:.0%}\")\n</code></pre>"},{"location":"api/configuration/#related","title":"Related","text":"<ul> <li>Pipeline API</li> <li>Configuration Guide</li> <li>Framework Comparison</li> </ul>"},{"location":"api/contracts/","title":"Contracts API","text":"<p>The contracts module defines interfaces and data contracts.</p>"},{"location":"api/contracts/#data-bundles","title":"Data Bundles","text":""},{"location":"api/contracts/#module-rwa_calccontractsbundles","title":"Module: <code>rwa_calc.contracts.bundles</code>","text":""},{"location":"api/contracts/#rawdatabundle","title":"<code>RawDataBundle</code>","text":"<pre><code>@dataclass(frozen=True)\nclass RawDataBundle:\n    \"\"\"\n    Raw data loaded from source files.\n\n    Attributes:\n        counterparties: Counterparty master data.\n        facilities: Credit facility data.\n        loans: Individual loan data.\n        contingents: Off-balance sheet items (optional).\n        collateral: Collateral data (optional).\n        guarantees: Guarantee data (optional).\n        provisions: Provision data (optional).\n        ratings: Rating data (optional).\n        org_mapping: Organization hierarchy (optional).\n        lending_mapping: Retail lending groups (optional).\n    \"\"\"\n\n    counterparties: pl.LazyFrame\n    facilities: pl.LazyFrame\n    loans: pl.LazyFrame\n    contingents: pl.LazyFrame | None = None\n    collateral: pl.LazyFrame | None = None\n    guarantees: pl.LazyFrame | None = None\n    provisions: pl.LazyFrame | None = None\n    ratings: pl.LazyFrame | None = None\n    org_mapping: pl.LazyFrame | None = None\n    lending_mapping: pl.LazyFrame | None = None\n</code></pre>"},{"location":"api/contracts/#resolvedhierarchybundle","title":"<code>ResolvedHierarchyBundle</code>","text":"<pre><code>@dataclass(frozen=True)\nclass ResolvedHierarchyBundle:\n    \"\"\"\n    Data with resolved hierarchies.\n\n    Attributes:\n        counterparties: Counterparties with resolved parents.\n        facilities: Facilities data.\n        loans: Loans data.\n        exposures: Flattened exposure view.\n    \"\"\"\n\n    counterparties: pl.LazyFrame\n    facilities: pl.LazyFrame\n    loans: pl.LazyFrame\n    exposures: pl.LazyFrame\n</code></pre>"},{"location":"api/contracts/#classifiedexposuresbundle","title":"<code>ClassifiedExposuresBundle</code>","text":"<pre><code>@dataclass(frozen=True)\nclass ClassifiedExposuresBundle:\n    \"\"\"\n    Classified exposures split by approach.\n\n    Attributes:\n        all_exposures: All classified exposures.\n        sa_exposures: Exposures for SA calculation.\n        irb_exposures: Exposures for IRB calculation.\n        slotting_exposures: Exposures for Slotting calculation.\n    \"\"\"\n\n    all_exposures: pl.LazyFrame\n    sa_exposures: pl.LazyFrame\n    irb_exposures: pl.LazyFrame\n    slotting_exposures: pl.LazyFrame\n</code></pre>"},{"location":"api/contracts/#crmadjustedbundle","title":"<code>CRMAdjustedBundle</code>","text":"<pre><code>@dataclass(frozen=True)\nclass CRMAdjustedBundle:\n    \"\"\"\n    Exposures after CRM application.\n\n    Attributes:\n        sa_exposures: SA exposures after CRM.\n        irb_exposures: IRB exposures after CRM.\n        slotting_exposures: Slotting exposures after CRM.\n    \"\"\"\n\n    sa_exposures: pl.LazyFrame\n    irb_exposures: pl.LazyFrame\n    slotting_exposures: pl.LazyFrame\n</code></pre>"},{"location":"api/contracts/#result-bundles","title":"Result Bundles","text":"<pre><code>@dataclass(frozen=True)\nclass SAResultBundle:\n    \"\"\"SA calculation results.\"\"\"\n    data: pl.LazyFrame\n    errors: list[CalculationError] = field(default_factory=list)\n\n@dataclass(frozen=True)\nclass IRBResultBundle:\n    \"\"\"IRB calculation results.\"\"\"\n    data: pl.LazyFrame\n    errors: list[CalculationError] = field(default_factory=list)\n\n@dataclass(frozen=True)\nclass SlottingResultBundle:\n    \"\"\"Slotting calculation results.\"\"\"\n    data: pl.LazyFrame\n    errors: list[CalculationError] = field(default_factory=list)\n\n@dataclass(frozen=True)\nclass EquityResultBundle:\n    \"\"\"Equity calculation results.\"\"\"\n    results: pl.LazyFrame\n    calculation_audit: pl.LazyFrame | None = None\n    approach: str = \"sa\"  # \"sa\" (Article 133) or \"irb_simple\" (Article 155)\n    errors: list = field(default_factory=list)\n</code></pre>"},{"location":"api/contracts/#aggregatedresultbundle","title":"<code>AggregatedResultBundle</code>","text":"<pre><code>@dataclass(frozen=True)\nclass AggregatedResultBundle:\n    \"\"\"\n    Final aggregated calculation results.\n\n    Attributes:\n        data: Detailed exposure-level results.\n        errors: Any calculation errors.\n        warnings: Any calculation warnings.\n    \"\"\"\n\n    data: pl.LazyFrame\n    errors: list[CalculationError] = field(default_factory=list)\n    warnings: list[CalculationWarning] = field(default_factory=list)\n\n    @property\n    def total_rwa(self) -&gt; float:\n        \"\"\"Total risk-weighted assets.\"\"\"\n\n    @property\n    def total_ead(self) -&gt; float:\n        \"\"\"Total exposure at default.\"\"\"\n\n    @property\n    def sa_rwa(self) -&gt; float:\n        \"\"\"Standardised Approach RWA.\"\"\"\n\n    @property\n    def irb_rwa(self) -&gt; float:\n        \"\"\"IRB RWA.\"\"\"\n\n    @property\n    def slotting_rwa(self) -&gt; float:\n        \"\"\"Slotting RWA.\"\"\"\n\n    @property\n    def total_expected_loss(self) -&gt; float:\n        \"\"\"Total expected loss (IRB only).\"\"\"\n\n    @property\n    def has_errors(self) -&gt; bool:\n        \"\"\"Whether any errors occurred.\"\"\"\n\n    @property\n    def has_warnings(self) -&gt; bool:\n        \"\"\"Whether any warnings occurred.\"\"\"\n\n    def to_dataframe(self) -&gt; pl.DataFrame:\n        \"\"\"Materialize results as DataFrame.\"\"\"\n\n    def to_parquet(self, path: str) -&gt; None:\n        \"\"\"Export results to Parquet.\"\"\"\n\n    def to_csv(self, path: str) -&gt; None:\n        \"\"\"Export results to CSV.\"\"\"\n\n    def to_json(self, path: str) -&gt; None:\n        \"\"\"Export results to JSON.\"\"\"\n\n    def by_exposure_class(self) -&gt; pl.DataFrame:\n        \"\"\"Get breakdown by exposure class.\"\"\"\n\n    def by_approach(self) -&gt; pl.DataFrame:\n        \"\"\"Get breakdown by approach.\"\"\"\n\n    def by_counterparty(self) -&gt; pl.DataFrame:\n        \"\"\"Get breakdown by counterparty.\"\"\"\n</code></pre>"},{"location":"api/contracts/#protocols","title":"Protocols","text":""},{"location":"api/contracts/#module-rwa_calccontractsprotocols","title":"Module: <code>rwa_calc.contracts.protocols</code>","text":"<pre><code>from typing import Protocol\n\nclass LoaderProtocol(Protocol):\n    \"\"\"Protocol for data loaders.\"\"\"\n\n    def load(self, path: Path) -&gt; RawDataBundle:\n        \"\"\"Load raw data from path.\"\"\"\n        ...\n\nclass HierarchyResolverProtocol(Protocol):\n    \"\"\"Protocol for hierarchy resolvers.\"\"\"\n\n    def resolve(\n        self,\n        raw_data: RawDataBundle,\n        config: CalculationConfig,\n    ) -&gt; ResolvedHierarchyBundle:\n        \"\"\"Resolve hierarchies.\"\"\"\n        ...\n\nclass ClassifierProtocol(Protocol):\n    \"\"\"Protocol for classifiers.\"\"\"\n\n    def classify(\n        self,\n        resolved: ResolvedHierarchyBundle,\n        config: CalculationConfig,\n    ) -&gt; ClassifiedExposuresBundle:\n        \"\"\"Classify exposures.\"\"\"\n        ...\n\nclass CRMProcessorProtocol(Protocol):\n    \"\"\"Protocol for CRM processors.\"\"\"\n\n    def process(\n        self,\n        classified: ClassifiedExposuresBundle,\n        config: CalculationConfig,\n    ) -&gt; CRMAdjustedBundle:\n        \"\"\"Process CRM.\"\"\"\n        ...\n\nclass SACalculatorProtocol(Protocol):\n    \"\"\"Protocol for SA calculators.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; SAResultBundle:\n        \"\"\"Calculate SA RWA.\"\"\"\n        ...\n\nclass IRBCalculatorProtocol(Protocol):\n    \"\"\"Protocol for IRB calculators.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; IRBResultBundle:\n        \"\"\"Calculate IRB RWA.\"\"\"\n        ...\n\nclass SlottingCalculatorProtocol(Protocol):\n    \"\"\"Protocol for Slotting calculators.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; SlottingResultBundle:\n        \"\"\"Calculate Slotting RWA.\"\"\"\n        ...\n\nclass EquityCalculatorProtocol(Protocol):\n    \"\"\"Protocol for Equity calculators.\"\"\"\n\n    def calculate(\n        self,\n        data: CRMAdjustedBundle,\n        config: CalculationConfig,\n    ) -&gt; LazyFrameResult:\n        \"\"\"Calculate equity RWA.\"\"\"\n        ...\n\n    def get_equity_result_bundle(\n        self,\n        data: CRMAdjustedBundle,\n        config: CalculationConfig,\n    ) -&gt; EquityResultBundle:\n        \"\"\"Calculate equity RWA and return as bundle.\"\"\"\n        ...\n\nclass OutputAggregatorProtocol(Protocol):\n    \"\"\"Protocol for output aggregators.\"\"\"\n\n    def aggregate(\n        self,\n        sa_result: SAResultBundle,\n        irb_result: IRBResultBundle,\n        slotting_result: SlottingResultBundle,\n        equity_result: EquityResultBundle,\n        config: CalculationConfig,\n    ) -&gt; AggregatedResultBundle:\n        \"\"\"Aggregate results.\"\"\"\n        ...\n</code></pre>"},{"location":"api/contracts/#error-handling","title":"Error Handling","text":""},{"location":"api/contracts/#module-rwa_calccontractserrors","title":"Module: <code>rwa_calc.contracts.errors</code>","text":"<pre><code>@dataclass\nclass CalculationError:\n    \"\"\"\n    Calculation error details.\n\n    Attributes:\n        exposure_id: Affected exposure identifier.\n        stage: Pipeline stage where error occurred.\n        message: Error description.\n        details: Additional error details.\n    \"\"\"\n\n    exposure_id: str | None\n    stage: str\n    message: str\n    details: dict[str, Any] | None = None\n\n@dataclass\nclass CalculationWarning:\n    \"\"\"\n    Calculation warning details.\n\n    Attributes:\n        exposure_id: Affected exposure identifier.\n        message: Warning description.\n    \"\"\"\n\n    exposure_id: str | None\n    message: str\n\n@dataclass\nclass LazyFrameResult:\n    \"\"\"\n    Result wrapper with error accumulation.\n\n    Attributes:\n        data: Result LazyFrame.\n        errors: Accumulated errors.\n        warnings: Accumulated warnings.\n    \"\"\"\n\n    data: pl.LazyFrame\n    errors: list[CalculationError] = field(default_factory=list)\n    warnings: list[CalculationWarning] = field(default_factory=list)\n\n    @property\n    def has_errors(self) -&gt; bool:\n        \"\"\"Whether any errors occurred.\"\"\"\n        return len(self.errors) &gt; 0\n</code></pre>"},{"location":"api/contracts/#related","title":"Related","text":"<ul> <li>Domain API</li> <li>Engine API</li> <li>Architecture - Design Principles</li> </ul>"},{"location":"api/domain/","title":"Domain API","text":"<p>The domain module contains core enumerations and types.</p>"},{"location":"api/domain/#module-rwa_calcdomainenums","title":"Module: <code>rwa_calc.domain.enums</code>","text":""},{"location":"api/domain/#regulatoryframework","title":"<code>RegulatoryFramework</code>","text":"<pre><code>class RegulatoryFramework(str, Enum):\n    \"\"\"Regulatory framework for calculations.\"\"\"\n\n    CRR = \"CRR\"           # Current CRR (Basel 3.0)\n    BASEL_3_1 = \"BASEL_3_1\"  # Basel 3.1 (from Jan 2027)\n</code></pre>"},{"location":"api/domain/#exposureclass","title":"<code>ExposureClass</code>","text":"<p>Regulatory exposure classes for SA and IRB approaches. The exposure class is determined by the counterparty's <code>entity_type</code> field.</p> <pre><code>class ExposureClass(str, Enum):\n    \"\"\"Regulatory exposure classes.\"\"\"\n\n    CENTRAL_GOVT_CENTRAL_BANK = \"CENTRAL_GOVT_CENTRAL_BANK\"\n    INSTITUTION = \"INSTITUTION\"\n    CORPORATE = \"CORPORATE\"\n    CORPORATE_SME = \"CORPORATE_SME\"\n    RETAIL_MORTGAGE = \"RETAIL_MORTGAGE\"\n    RETAIL_QRRE = \"RETAIL_QRRE\"\n    RETAIL_OTHER = \"RETAIL_OTHER\"\n    SPECIALISED_LENDING = \"SPECIALISED_LENDING\"\n    EQUITY = \"EQUITY\"\n    DEFAULTED = \"DEFAULTED\"\n    PSE = \"PSE\"  # Public Sector Entity\n    MDB = \"MDB\"  # Multilateral Development Bank\n    RGLA = \"RGLA\"  # Regional Government/Local Authority\n    OTHER = \"OTHER\"\n</code></pre> <p>Note: Each counterparty <code>entity_type</code> maps to both an SA and IRB exposure class. For example: - <code>pse_sovereign</code> \u2192 SA: PSE, IRB: CENTRAL_GOVT_CENTRAL_BANK - <code>rgla_institution</code> \u2192 SA: RGLA, IRB: INSTITUTION</p> <p>See Classification for the complete entity type to exposure class mapping.</p>"},{"location":"api/domain/#approachtype","title":"<code>ApproachType</code>","text":"<pre><code>class ApproachType(str, Enum):\n    \"\"\"RWA calculation approaches.\"\"\"\n\n    SA = \"SA\"           # Standardised Approach\n    FIRB = \"FIRB\"       # Foundation IRB\n    AIRB = \"AIRB\"       # Advanced IRB\n    SLOTTING = \"SLOTTING\"  # Slotting Approach\n</code></pre>"},{"location":"api/domain/#cqs","title":"<code>CQS</code>","text":"<pre><code>class CQS(int, Enum):\n    \"\"\"Credit Quality Steps (1-6 plus unrated).\"\"\"\n\n    CQS_1 = 1  # AAA to AA-\n    CQS_2 = 2  # A+ to A-\n    CQS_3 = 3  # BBB+ to BBB-\n    CQS_4 = 4  # BB+ to BB-\n    CQS_5 = 5  # B+ to B-\n    CQS_6 = 6  # CCC+ and below\n    UNRATED = 0  # No external rating\n</code></pre>"},{"location":"api/domain/#collateraltype","title":"<code>CollateralType</code>","text":"<pre><code>class CollateralType(str, Enum):\n    \"\"\"Types of eligible collateral.\"\"\"\n\n    CASH = \"CASH\"\n    GOVERNMENT_BOND = \"GOVERNMENT_BOND\"\n    CORPORATE_BOND = \"CORPORATE_BOND\"\n    COVERED_BOND = \"COVERED_BOND\"\n    EQUITY_MAIN_INDEX = \"EQUITY_MAIN_INDEX\"\n    EQUITY_OTHER = \"EQUITY_OTHER\"\n    RESIDENTIAL_REAL_ESTATE = \"RESIDENTIAL_REAL_ESTATE\"\n    COMMERCIAL_REAL_ESTATE = \"COMMERCIAL_REAL_ESTATE\"\n    RECEIVABLES = \"RECEIVABLES\"\n    OTHER_PHYSICAL = \"OTHER_PHYSICAL\"\n    GOLD = \"GOLD\"\n</code></pre>"},{"location":"api/domain/#guarantortype","title":"<code>GuarantorType</code>","text":"<pre><code>class GuarantorType(str, Enum):\n    \"\"\"Types of guarantors.\"\"\"\n\n    SOVEREIGN = \"SOVEREIGN\"\n    INSTITUTION = \"INSTITUTION\"\n    CORPORATE = \"CORPORATE\"\n    PARENT = \"PARENT\"\n</code></pre>"},{"location":"api/domain/#provisiontype","title":"<code>ProvisionType</code>","text":"<pre><code>class ProvisionType(str, Enum):\n    \"\"\"Types of provisions.\"\"\"\n\n    SCRA = \"SCRA\"  # Specific Credit Risk Adjustment\n    GCRA = \"GCRA\"  # General Credit Risk Adjustment\n</code></pre>"},{"location":"api/domain/#ifrsstage","title":"<code>IFRSStage</code>","text":"<pre><code>class IFRSStage(str, Enum):\n    \"\"\"IFRS 9 impairment stages.\"\"\"\n\n    STAGE_1 = \"STAGE_1\"  # Performing, 12-month ECL\n    STAGE_2 = \"STAGE_2\"  # Performing, lifetime ECL\n    STAGE_3 = \"STAGE_3\"  # Non-performing, lifetime ECL\n</code></pre>"},{"location":"api/domain/#specialisedlendingtype","title":"<code>SpecialisedLendingType</code>","text":"<pre><code>class SpecialisedLendingType(str, Enum):\n    \"\"\"Types of specialised lending.\"\"\"\n\n    PROJECT_FINANCE = \"PROJECT_FINANCE\"\n    OBJECT_FINANCE = \"OBJECT_FINANCE\"\n    COMMODITIES_FINANCE = \"COMMODITIES_FINANCE\"\n    IPRE = \"IPRE\"  # Income-Producing Real Estate\n    HVCRE = \"HVCRE\"  # High Volatility Commercial Real Estate\n</code></pre>"},{"location":"api/domain/#slottingcategory","title":"<code>SlottingCategory</code>","text":"<pre><code>class SlottingCategory(str, Enum):\n    \"\"\"Slotting categories for specialised lending.\"\"\"\n\n    STRONG = \"STRONG\"\n    GOOD = \"GOOD\"\n    SATISFACTORY = \"SATISFACTORY\"\n    WEAK = \"WEAK\"\n    DEFAULT = \"DEFAULT\"\n</code></pre>"},{"location":"api/domain/#facilitytype","title":"<code>FacilityType</code>","text":"<pre><code>class FacilityType(str, Enum):\n    \"\"\"Types of credit facilities.\"\"\"\n\n    RCF = \"RCF\"  # Revolving Credit Facility\n    TERM = \"TERM\"  # Term Loan\n    MORTGAGE = \"MORTGAGE\"  # Mortgage\n    OVERDRAFT = \"OVERDRAFT\"  # Overdraft\n    CREDIT_CARD = \"CREDIT_CARD\"  # Credit Card\n    TRADE_FINANCE = \"TRADE_FINANCE\"  # Trade Finance\n    GUARANTEE = \"GUARANTEE\"  # Guarantee Facility\n    PROJECT_FINANCE = \"PROJECT_FINANCE\"  # Project Finance\n</code></pre>"},{"location":"api/domain/#counterpartytype","title":"<code>CounterpartyType</code>","text":"<p>Note: This enum is used for high-level counterparty categorisation. For exposure class determination, the counterparty schema uses the <code>entity_type</code> string field which supports 17 distinct values with granular SA/IRB class mappings. See Classification for details.</p> <pre><code>class CounterpartyType(str, Enum):\n    \"\"\"Types of counterparties (high-level).\"\"\"\n\n    SOVEREIGN = \"SOVEREIGN\"\n    CENTRAL_BANK = \"CENTRAL_BANK\"\n    INSTITUTION = \"INSTITUTION\"\n    CORPORATE = \"CORPORATE\"\n    INDIVIDUAL = \"INDIVIDUAL\"\n    PSE = \"PSE\"\n    MDB = \"MDB\"\n    PROJECT_ENTITY = \"PROJECT_ENTITY\"\n</code></pre>"},{"location":"api/domain/#usage-examples","title":"Usage Examples","text":""},{"location":"api/domain/#classification","title":"Classification","text":"<pre><code>from rwa_calc.domain.enums import ExposureClass, ApproachType\n\n# Check exposure class\nif exposure_class == ExposureClass.CORPORATE_SME:\n    # Apply SME treatment\n    pass\n\n# Check approach\nif approach == ApproachType.FIRB:\n    # Use supervisory LGD\n    lgd = 0.45\n</code></pre>"},{"location":"api/domain/#risk-weight-lookup","title":"Risk Weight Lookup","text":"<pre><code>from rwa_calc.domain.enums import ExposureClass, CQS\n\ndef get_corporate_rw(cqs: CQS) -&gt; float:\n    \"\"\"Get corporate risk weight by CQS.\"\"\"\n    weights = {\n        CQS.CQS_1: 0.20,\n        CQS.CQS_2: 0.50,\n        CQS.CQS_3: 0.75,\n        CQS.CQS_4: 1.00,\n        CQS.CQS_5: 1.50,\n        CQS.CQS_6: 1.50,\n        CQS.UNRATED: 1.00,\n    }\n    return weights[cqs]\n</code></pre>"},{"location":"api/domain/#collateral-handling","title":"Collateral Handling","text":"<pre><code>from rwa_calc.domain.enums import CollateralType\n\ndef get_haircut(collateral_type: CollateralType) -&gt; float:\n    \"\"\"Get base haircut for collateral type.\"\"\"\n    if collateral_type == CollateralType.CASH:\n        return 0.0\n    elif collateral_type == CollateralType.GOVERNMENT_BOND:\n        return 0.02  # Varies by maturity\n    elif collateral_type == CollateralType.EQUITY_MAIN_INDEX:\n        return 0.15\n    # ...\n</code></pre>"},{"location":"api/domain/#related","title":"Related","text":"<ul> <li>Contracts API</li> <li>Engine API</li> <li>Data Model</li> </ul>"},{"location":"api/engine/","title":"Engine API","text":"<p>The engine module contains all calculation components.</p>"},{"location":"api/engine/#loader","title":"Loader","text":""},{"location":"api/engine/#module-rwa_calcengineloader","title":"Module: <code>rwa_calc.engine.loader</code>","text":"<pre><code>class ParquetLoader:\n    \"\"\"Load data from Parquet files.\"\"\"\n\n    def load(self, path: Path) -&gt; RawDataBundle:\n        \"\"\"\n        Load all data files from directory.\n\n        Args:\n            path: Directory containing Parquet files.\n\n        Returns:\n            RawDataBundle: Loaded data.\n\n        Example:\n            &gt;&gt;&gt; loader = ParquetLoader()\n            &gt;&gt;&gt; data = loader.load(Path(\"./data\"))\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#hierarchy-resolver","title":"Hierarchy Resolver","text":""},{"location":"api/engine/#module-rwa_calcenginehierarchy","title":"Module: <code>rwa_calc.engine.hierarchy</code>","text":"<pre><code>class HierarchyResolver:\n    \"\"\"Resolve counterparty and facility hierarchies.\"\"\"\n\n    def resolve(\n        self,\n        raw_data: RawDataBundle,\n        config: CalculationConfig,\n    ) -&gt; ResolvedHierarchyBundle:\n        \"\"\"\n        Resolve hierarchies and inherit attributes.\n\n        Args:\n            raw_data: Raw data bundle.\n            config: Calculation configuration.\n\n        Returns:\n            ResolvedHierarchyBundle: Resolved data.\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#module-rwa_calcenginehierarchy_namespace","title":"Module: <code>rwa_calc.engine.hierarchy_namespace</code>","text":"<p>The Hierarchy module provides Polars namespace extensions for counterparty and facility hierarchy resolution.</p>"},{"location":"api/engine/#hierarchylazyframe-namespace","title":"HierarchyLazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"hierarchy\")\nclass HierarchyLazyFrame:\n    \"\"\"LazyFrame namespace for hierarchy operations.\"\"\"\n\n    def resolve_ultimate_parent(\n        self,\n        org_mappings: pl.LazyFrame,\n        max_depth: int = 10,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Resolve ultimate parent for each counterparty.\n\n        Uses iterative join-based traversal (not recursive Python).\n\n        Adds columns:\n        - ultimate_parent_reference: The root parent\n        - hierarchy_depth: Number of levels to root\n        \"\"\"\n\n    def calculate_hierarchy_depth(self) -&gt; pl.LazyFrame:\n        \"\"\"Calculate depth in hierarchy for each entity.\"\"\"\n\n    def inherit_ratings(\n        self,\n        ratings: pl.LazyFrame,\n        ultimate_parents: pl.LazyFrame | None = None,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Inherit ratings from ultimate parent.\n\n        If entity has own rating, use it.\n        Otherwise, inherit from ultimate parent.\n\n        Adds columns:\n        - cqs: Credit quality step (own or inherited)\n        - pd: Probability of default (own or inherited)\n        - rating_value: Rating value (own or inherited)\n        \"\"\"\n\n    def coalesce_ratings(self) -&gt; pl.LazyFrame:\n        \"\"\"Coalesce own rating with inherited rating.\"\"\"\n\n    def calculate_lending_group_totals(\n        self,\n        lending_mappings: pl.LazyFrame,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Calculate aggregate exposure for lending groups.\n\n        Adds columns:\n        - total_exposure: Sum of exposures in lending group\n        - exposure_count: Number of exposures in group\n        \"\"\"\n\n    def add_lending_group_reference(\n        self,\n        lending_mappings: pl.LazyFrame,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"Add lending group reference to exposures.\"\"\"\n\n    def add_collateral_ltv(self, collateral: pl.LazyFrame) -&gt; pl.LazyFrame:\n        \"\"\"Add LTV from collateral to exposures.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nimport rwa_calc.engine.hierarchy_namespace  # Registers namespace\n\n# Resolve ultimate parents\ncounterparties_with_parents = (\n    counterparties\n    .hierarchy.resolve_ultimate_parent(org_mappings, max_depth=10)\n)\n\n# Inherit ratings from parents\ncounterparties_with_ratings = (\n    counterparties\n    .hierarchy.inherit_ratings(ratings, ultimate_parents)\n)\n\n# Calculate lending group totals\nexposures_with_groups = (\n    exposures\n    .hierarchy.calculate_lending_group_totals(lending_mappings)\n)\n</code></pre>"},{"location":"api/engine/#classifier","title":"Classifier","text":""},{"location":"api/engine/#module-rwa_calcengineclassifier","title":"Module: <code>rwa_calc.engine.classifier</code>","text":"<pre><code>class ExposureClassifier:\n    \"\"\"Classify exposures by regulatory class and approach.\"\"\"\n\n    def classify(\n        self,\n        resolved: ResolvedHierarchyBundle,\n        config: CalculationConfig,\n    ) -&gt; ClassifiedExposuresBundle:\n        \"\"\"\n        Classify all exposures.\n\n        Args:\n            resolved: Resolved hierarchy bundle.\n            config: Calculation configuration.\n\n        Returns:\n            ClassifiedExposuresBundle: Classified exposures.\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#ccf-calculator","title":"CCF Calculator","text":""},{"location":"api/engine/#module-rwa_calcengineccf","title":"Module: <code>rwa_calc.engine.ccf</code>","text":"<pre><code>def get_ccf(\n    item_type: str,\n    is_unconditionally_cancellable: bool,\n    original_maturity_years: float,\n    framework: RegulatoryFramework,\n) -&gt; float:\n    \"\"\"\n    Get credit conversion factor.\n\n    Args:\n        item_type: Type of off-balance sheet item.\n        is_unconditionally_cancellable: Whether unconditionally cancellable.\n        original_maturity_years: Original maturity in years.\n        framework: Regulatory framework.\n\n    Returns:\n        float: Credit conversion factor (0.0 to 1.0).\n\n    Example:\n        &gt;&gt;&gt; ccf = get_ccf(\n        ...     item_type=\"UNDRAWN_COMMITMENT\",\n        ...     is_unconditionally_cancellable=False,\n        ...     original_maturity_years=3,\n        ...     framework=RegulatoryFramework.CRR,\n        ... )\n        &gt;&gt;&gt; print(f\"CCF: {ccf:.0%}\")\n        CCF: 50%\n    \"\"\"\n</code></pre>"},{"location":"api/engine/#crm-processor","title":"CRM Processor","text":""},{"location":"api/engine/#module-rwa_calcenginecrmprocessor","title":"Module: <code>rwa_calc.engine.crm.processor</code>","text":"<pre><code>class CRMProcessor:\n    \"\"\"Process credit risk mitigation.\"\"\"\n\n    def process(\n        self,\n        classified: ClassifiedExposuresBundle,\n        config: CalculationConfig,\n    ) -&gt; CRMAdjustedBundle:\n        \"\"\"\n        Apply CRM to all exposures.\n\n        Args:\n            classified: Classified exposures.\n            config: Calculation configuration.\n\n        Returns:\n            CRMAdjustedBundle: CRM-adjusted exposures.\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#module-rwa_calcenginecrmnamespace","title":"Module: <code>rwa_calc.engine.crm.namespace</code>","text":"<p>The CRM module provides Polars namespace extensions for fluent EAD waterfall processing.</p>"},{"location":"api/engine/#crmlazyframe-namespace","title":"CRMLazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"crm\")\nclass CRMLazyFrame:\n    \"\"\"LazyFrame namespace for CRM/EAD calculations.\"\"\"\n\n    def initialize_ead_waterfall(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Initialize EAD waterfall columns.\n\n        Adds columns:\n        - ead_gross: Copy of ead_pre_crm\n        - ead_after_collateral: Initialized to ead_gross\n        - ead_after_guarantee: Initialized to ead_gross\n        - ead_final: Initialized to ead_gross\n        - collateral_adjusted_value: Initialized to 0\n        - guarantee_amount: Initialized to 0\n        - provision_allocated: Initialized to 0\n        \"\"\"\n\n    def apply_collateral(\n        self,\n        collateral: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply collateral to reduce EAD (SA) or adjust LGD (IRB).\n\n        SA approach: Reduces EAD directly\n        IRB approach: Affects LGD calculation\n        \"\"\"\n\n    def apply_guarantees(\n        self,\n        guarantees: pl.LazyFrame,\n        counterparty_lookup: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply guarantee substitution.\n\n        Calculates guarantee coverage and applies risk weight substitution\n        based on guarantor type and CQS.\n        \"\"\"\n\n    def apply_provisions(\n        self,\n        provisions: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply provision allocation (SA only).\n\n        SA: Deducts provisions from EAD\n        IRB: No deduction (EL comparison handled separately)\n        \"\"\"\n\n    def finalize_ead(self) -&gt; pl.LazyFrame:\n        \"\"\"Finalize EAD calculation ensuring non-negative values.\"\"\"\n\n    def apply_all_crm(\n        self,\n        collateral: pl.LazyFrame,\n        guarantees: pl.LazyFrame,\n        provisions: pl.LazyFrame,\n        counterparty_lookup: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"Apply complete CRM pipeline.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.crm.namespace  # Registers namespace\n\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Fluent CRM pipeline\nresult = (\n    exposures\n    .crm.initialize_ead_waterfall()\n    .crm.apply_collateral(collateral, config)\n    .crm.apply_guarantees(guarantees, counterparty_lookup, config)\n    .crm.apply_provisions(provisions, config)\n    .crm.finalize_ead()\n    .collect()\n)\n</code></pre>"},{"location":"api/engine/#module-rwa_calcenginecrmhaircuts","title":"Module: <code>rwa_calc.engine.crm.haircuts</code>","text":"<pre><code>def get_haircut(\n    collateral_type: CollateralType,\n    cqs: CQS | None,\n    residual_maturity_years: float,\n) -&gt; float:\n    \"\"\"\n    Get supervisory haircut for collateral.\n\n    Args:\n        collateral_type: Type of collateral.\n        cqs: Credit quality step of issuer (for bonds).\n        residual_maturity_years: Residual maturity.\n\n    Returns:\n        float: Haircut percentage (0.0 to 1.0).\n    \"\"\"\n</code></pre>"},{"location":"api/engine/#module-rwa_calcenginecrmhaircuts_namespace","title":"Module: <code>rwa_calc.engine.crm.haircuts_namespace</code>","text":"<p>The Haircuts module provides Polars namespace extensions for collateral haircut calculations.</p>"},{"location":"api/engine/#haircutslazyframe-namespace","title":"HaircutsLazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"haircuts\")\nclass HaircutsLazyFrame:\n    \"\"\"LazyFrame namespace for haircut calculations.\"\"\"\n\n    def classify_maturity_band(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Classify residual maturity into regulatory bands.\n\n        Bands: &lt;=1yr, 1-3yr, 3-5yr, 5-7yr, 7-10yr, &gt;10yr\n        \"\"\"\n\n    def apply_collateral_haircuts(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply supervisory haircuts based on collateral type and CQS.\n\n        Handles:\n        - Cash: 0%\n        - Gold: 15%\n        - Government bonds: 0.5%-15% by CQS and maturity\n        - Corporate bonds: 1%-30% by CQS and maturity\n        - Equities: 15%-25%\n        - Other physical: 40%\n        \"\"\"\n\n    def apply_fx_haircut(self, exposure_currency_col: str) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply FX mismatch haircut (8%) when currencies differ.\n        \"\"\"\n\n    def apply_maturity_mismatch(self, exposure_maturity_col: str) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply maturity mismatch adjustment.\n\n        P_adj = P \u00d7 (t - 0.25) / (T - 0.25)\n        where t = collateral maturity, T = exposure maturity\n        \"\"\"\n\n    def calculate_adjusted_value(self) -&gt; pl.LazyFrame:\n        \"\"\"Calculate final adjusted collateral value after all haircuts.\"\"\"\n\n    def apply_all_haircuts(\n        self,\n        exposure_currency_col: str,\n        exposure_maturity_col: str,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"Apply complete haircut pipeline.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.crm.haircuts_namespace  # Registers namespace\n\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Fluent haircut calculation\nresult = (\n    collateral\n    .haircuts.classify_maturity_band()\n    .haircuts.apply_collateral_haircuts(config)\n    .haircuts.apply_fx_haircut(\"exposure_currency\")\n    .haircuts.apply_maturity_mismatch(\"exposure_maturity\")\n    .haircuts.calculate_adjusted_value()\n    .collect()\n)\n</code></pre>"},{"location":"api/engine/#sa-calculator","title":"SA Calculator","text":""},{"location":"api/engine/#module-rwa_calcenginesacalculator","title":"Module: <code>rwa_calc.engine.sa.calculator</code>","text":"<pre><code>class SACalculator:\n    \"\"\"Calculate Standardised Approach RWA.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; SAResultBundle:\n        \"\"\"\n        Calculate SA RWA for all exposures.\n\n        Args:\n            exposures: CRM-adjusted exposures.\n            config: Calculation configuration.\n\n        Returns:\n            SAResultBundle: SA calculation results.\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#module-rwa_calcenginesanamespace","title":"Module: <code>rwa_calc.engine.sa.namespace</code>","text":"<p>The SA module provides Polars namespace extensions for fluent, chainable SA calculations.</p>"},{"location":"api/engine/#salazyframe-namespace","title":"SALazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"sa\")\nclass SALazyFrame:\n    \"\"\"LazyFrame namespace for SA calculations.\"\"\"\n\n    def prepare_columns(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Ensure required columns exist with sensible defaults.\n\n        Adds columns:\n        - risk_weight: Initialized to 1.0\n        - supporting_factor: Initialized to 1.0\n        \"\"\"\n\n    def apply_risk_weights(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply risk weights based on exposure class and CQS.\n\n        Handles:\n        - Sovereign CQS-based weights\n        - Institution CQS-based weights (with UK deviation for CQS 2)\n        - Corporate CQS-based and unrated weights\n        - Retail flat weights\n        - Residential mortgage LTV-based weights\n        - Commercial real estate weights\n        \"\"\"\n\n    def apply_residential_mortgage_rw(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Apply LTV-based risk weights for residential mortgages.\"\"\"\n\n    def apply_cqs_based_rw(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Apply CQS-based risk weights for sovereigns, institutions, corporates.\"\"\"\n\n    def calculate_rwa(self) -&gt; pl.LazyFrame:\n        \"\"\"Calculate RWA = EAD \u00d7 Risk Weight.\"\"\"\n\n    def apply_supporting_factors(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply SME and infrastructure supporting factors (CRR only).\n\n        SME tiered factor: 0.7619 (\u2264EUR 2.5m) / 0.85 (&gt;EUR 2.5m)\n        Infrastructure factor: 0.75\n        \"\"\"\n\n    def apply_all(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply complete SA calculation pipeline.\n\n        Chains: prepare_columns -&gt; apply_risk_weights -&gt; calculate_rwa\n        -&gt; apply_supporting_factors\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#saexpr-namespace","title":"SAExpr Namespace","text":"<pre><code>@pl.api.register_expr_namespace(\"sa\")\nclass SAExpr:\n    \"\"\"Expression namespace for column-level SA operations.\"\"\"\n\n    def lookup_cqs_rw(\n        self,\n        exposure_class_col: str,\n        config: CalculationConfig,\n    ) -&gt; pl.Expr:\n        \"\"\"Look up risk weight based on CQS and exposure class.\"\"\"\n\n    def apply_ltv_weight(self, ltv_thresholds: list[tuple[float, float]]) -&gt; pl.Expr:\n        \"\"\"Apply LTV-based risk weight from threshold table.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nfrom datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.sa.namespace  # Registers namespace\n\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Fluent SA calculation pipeline\nresult = (\n    exposures\n    .sa.prepare_columns(config)\n    .sa.apply_risk_weights(config)\n    .sa.calculate_rwa()\n    .sa.apply_supporting_factors(config)\n    .collect()\n)\n\n# Or use the convenience method\nresult = exposures.sa.apply_all(config).collect()\n</code></pre>"},{"location":"api/engine/#module-rwa_calcenginesasupporting_factors","title":"Module: <code>rwa_calc.engine.sa.supporting_factors</code>","text":"<pre><code>def calculate_sme_factor(\n    total_exposure: float,\n    threshold: float,\n    factor_below: float = 0.7619,\n    factor_above: float = 0.85,\n) -&gt; float:\n    \"\"\"\n    Calculate SME supporting factor.\n\n    Args:\n        total_exposure: Total exposure to counterparty.\n        threshold: Tiered threshold (EUR 2.5m).\n        factor_below: Factor for exposure below threshold.\n        factor_above: Factor for exposure above threshold.\n\n    Returns:\n        float: SME supporting factor.\n\n    Example:\n        &gt;&gt;&gt; factor = calculate_sme_factor(\n        ...     total_exposure=5_000_000,\n        ...     threshold=2_500_000,\n        ... )\n        &gt;&gt;&gt; print(f\"Factor: {factor:.4f}\")\n        Factor: 0.8110\n    \"\"\"\n</code></pre>"},{"location":"api/engine/#irb-calculator","title":"IRB Calculator","text":""},{"location":"api/engine/#module-rwa_calcengineirbcalculator","title":"Module: <code>rwa_calc.engine.irb.calculator</code>","text":"<pre><code>class IRBCalculator:\n    \"\"\"Calculate IRB RWA.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; IRBResultBundle:\n        \"\"\"\n        Calculate IRB RWA for all exposures.\n\n        Args:\n            exposures: CRM-adjusted exposures.\n            config: Calculation configuration.\n\n        Returns:\n            IRBResultBundle: IRB calculation results.\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#module-rwa_calcengineirbnamespace","title":"Module: <code>rwa_calc.engine.irb.namespace</code>","text":"<p>The IRB module provides Polars namespace extensions for fluent, chainable IRB calculations.</p>"},{"location":"api/engine/#irblazyframe-namespace","title":"IRBLazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"irb\")\nclass IRBLazyFrame:\n    \"\"\"LazyFrame namespace for IRB calculations.\"\"\"\n\n    def classify_approach(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Classify exposures as F-IRB or A-IRB.\n\n        Adds columns:\n        - approach: \"F-IRB\" or \"A-IRB\"\n        - is_airb: Boolean flag\n        \"\"\"\n\n    def apply_firb_lgd(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply supervisory LGD for F-IRB exposures.\n\n        F-IRB supervisory LGD values:\n        - Senior unsecured: 45%\n        - Subordinated: 75%\n        - Financial collateral: 0%\n        - Other secured: 35-40%\n        \"\"\"\n\n    def prepare_columns(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Ensure required columns exist with defaults.\n\n        Sets defaults for missing columns:\n        - pd: 0.01 (1%)\n        - lgd: 0.45 (45%)\n        - maturity: 2.5 years\n        - exposure_class: \"CORPORATE\"\n        \"\"\"\n\n    def apply_all_formulas(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply complete IRB calculation pipeline.\n\n        Chains: apply_pd_floor -&gt; apply_lgd_floor -&gt; calculate_correlation\n        -&gt; calculate_k -&gt; calculate_maturity_adjustment -&gt; calculate_rwa\n        -&gt; calculate_expected_loss\n        \"\"\"\n\n    def apply_pd_floor(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Apply PD floor based on framework (0.03% CRR, 0.05% Basel 3.1).\"\"\"\n\n    def apply_lgd_floor(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Apply LGD floor (Basel 3.1 A-IRB only).\"\"\"\n\n    def calculate_correlation(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Calculate asset correlation with SME adjustment.\"\"\"\n\n    def calculate_k(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Calculate capital requirement K using IRB formula.\"\"\"\n\n    def calculate_maturity_adjustment(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Calculate maturity adjustment (non-retail only).\"\"\"\n\n    def calculate_rwa(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Calculate RWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA \u00d7 [1.06].\"\"\"\n\n    def calculate_expected_loss(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Calculate expected loss = PD \u00d7 LGD \u00d7 EAD.\"\"\"\n\n    def select_expected_loss(self) -&gt; pl.LazyFrame:\n        \"\"\"Select expected loss columns for output.\"\"\"\n\n    def build_audit(self) -&gt; pl.LazyFrame:\n        \"\"\"Build audit trail with intermediate calculation values.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nfrom datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.irb.namespace  # Registers namespace\n\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Fluent IRB calculation pipeline\nresult = (\n    exposures\n    .irb.classify_approach(config)\n    .irb.apply_firb_lgd(config)\n    .irb.prepare_columns(config)\n    .irb.apply_all_formulas(config)\n    .collect()\n)\n</code></pre>"},{"location":"api/engine/#irbexpr-namespace","title":"IRBExpr Namespace","text":"<pre><code>@pl.api.register_expr_namespace(\"irb\")\nclass IRBExpr:\n    \"\"\"Expression namespace for column-level IRB operations.\"\"\"\n\n    def floor_pd(self, floor_value: float) -&gt; pl.Expr:\n        \"\"\"Floor PD values to minimum.\"\"\"\n\n    def floor_lgd(self, floor_value: float) -&gt; pl.Expr:\n        \"\"\"Floor LGD values to minimum.\"\"\"\n\n    def clip_maturity(self, floor: float = 1.0, cap: float = 5.0) -&gt; pl.Expr:\n        \"\"\"Clip maturity to regulatory bounds [1, 5] years.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code># Use expression namespace directly\nresult = lf.with_columns(\n    pl.col(\"pd\").irb.floor_pd(0.0003),\n    pl.col(\"maturity\").irb.clip_maturity(1.0, 5.0),\n)\n</code></pre>"},{"location":"api/engine/#module-rwa_calcengineirbformulas","title":"Module: <code>rwa_calc.engine.irb.formulas</code>","text":"<pre><code>def calculate_k(\n    pd: float,\n    lgd: float,\n    correlation: float,\n) -&gt; float:\n    \"\"\"\n    Calculate IRB capital requirement (K).\n\n    Args:\n        pd: Probability of default.\n        lgd: Loss given default.\n        correlation: Asset correlation.\n\n    Returns:\n        float: Capital requirement K.\n\n    Example:\n        &gt;&gt;&gt; k = calculate_k(pd=0.01, lgd=0.45, correlation=0.20)\n        &gt;&gt;&gt; print(f\"K: {k:.4f}\")\n    \"\"\"\n\ndef calculate_correlation(\n    exposure_class: ExposureClass,\n    pd: float,\n    turnover: float | None = None,\n) -&gt; float:\n    \"\"\"\n    Calculate asset correlation.\n\n    Args:\n        exposure_class: Regulatory exposure class.\n        pd: Probability of default.\n        turnover: Counterparty turnover (for SME adjustment).\n\n    Returns:\n        float: Asset correlation.\n    \"\"\"\n\ndef calculate_maturity_adjustment(\n    pd: float,\n    effective_maturity: float,\n) -&gt; float:\n    \"\"\"\n    Calculate maturity adjustment factor.\n\n    Args:\n        pd: Probability of default.\n        effective_maturity: Effective maturity in years.\n\n    Returns:\n        float: Maturity adjustment factor.\n    \"\"\"\n</code></pre>"},{"location":"api/engine/#slotting-calculator","title":"Slotting Calculator","text":""},{"location":"api/engine/#module-rwa_calcengineslottingcalculator","title":"Module: <code>rwa_calc.engine.slotting.calculator</code>","text":"<pre><code>class SlottingCalculator:\n    \"\"\"Calculate Slotting RWA for specialised lending.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; SlottingResultBundle:\n        \"\"\"\n        Calculate Slotting RWA for all exposures.\n\n        Args:\n            exposures: CRM-adjusted exposures.\n            config: Calculation configuration.\n\n        Returns:\n            SlottingResultBundle: Slotting calculation results.\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#module-rwa_calcengineslottingnamespace","title":"Module: <code>rwa_calc.engine.slotting.namespace</code>","text":"<p>The Slotting module provides Polars namespace extensions for specialised lending calculations.</p>"},{"location":"api/engine/#slottinglazyframe-namespace","title":"SlottingLazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"slotting\")\nclass SlottingLazyFrame:\n    \"\"\"LazyFrame namespace for slotting calculations.\"\"\"\n\n    def prepare_columns(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Ensure required columns exist with defaults.\n\n        Adds columns:\n        - slotting_category: Default \"unrated\"\n        - is_hvcre: Default False\n        - risk_weight: Initialized to 1.0\n        \"\"\"\n\n    def apply_slotting_weights(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply slotting risk weights based on category.\n\n        CRR Risk Weights (Strong=Good=70%, HVCRE same as standard):\n        - Strong: 70%\n        - Good: 70%\n        - Satisfactory: 115%\n        - Weak: 250%\n        - Default: 0% (deducted)\n\n        Basel 3.1 Risk Weights:\n        - Strong: 50% (HVCRE: 70%)\n        - Good: 70% (HVCRE: 95%)\n        - Satisfactory: 100% (HVCRE: 125%)\n        - Weak: 250%\n        - Default: 0%\n        \"\"\"\n\n    def calculate_rwa(self) -&gt; pl.LazyFrame:\n        \"\"\"Calculate RWA = EAD \u00d7 Risk Weight.\"\"\"\n\n    def apply_all(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply complete slotting calculation pipeline.\n\n        Chains: prepare_columns -&gt; apply_slotting_weights -&gt; calculate_rwa\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#slottingexpr-namespace","title":"SlottingExpr Namespace","text":"<pre><code>@pl.api.register_expr_namespace(\"slotting\")\nclass SlottingExpr:\n    \"\"\"Expression namespace for column-level slotting operations.\"\"\"\n\n    def lookup_rw(self, is_hvcre_col: str, config: CalculationConfig) -&gt; pl.Expr:\n        \"\"\"Look up slotting risk weight based on category and HVCRE status.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.slotting.namespace  # Registers namespace\n\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Fluent slotting calculation\nresult = (\n    specialised_lending\n    .slotting.prepare_columns(config)\n    .slotting.apply_slotting_weights(config)\n    .slotting.calculate_rwa()\n    .collect()\n)\n\n# Or use the convenience method\nresult = specialised_lending.slotting.apply_all(config).collect()\n</code></pre>"},{"location":"api/engine/#equity-calculator","title":"Equity Calculator","text":""},{"location":"api/engine/#module-rwa_calcengineequitycalculator","title":"Module: <code>rwa_calc.engine.equity.calculator</code>","text":"<pre><code>class EquityCalculator:\n    \"\"\"\n    Calculate RWA for equity exposures.\n\n    Supports two approaches under CRR:\n    - Article 133: Standardised Approach (100%/250%/400% RW)\n    - Article 155: IRB Simple Risk Weight (190%/290%/370% RW)\n\n    The approach is determined by config.irb_approach_option:\n    - SA_ONLY: Uses Article 133\n    - FIRB/AIRB: Uses Article 155\n    \"\"\"\n\n    def calculate(\n        self,\n        data: CRMAdjustedBundle,\n        config: CalculationConfig,\n    ) -&gt; LazyFrameResult:\n        \"\"\"\n        Calculate RWA for equity exposures.\n\n        Args:\n            data: CRM-adjusted exposures (uses equity_exposures field).\n            config: Calculation configuration.\n\n        Returns:\n            LazyFrameResult with equity RWA calculations.\n        \"\"\"\n\n    def get_equity_result_bundle(\n        self,\n        data: CRMAdjustedBundle,\n        config: CalculationConfig,\n    ) -&gt; EquityResultBundle:\n        \"\"\"\n        Calculate equity RWA and return as a bundle.\n\n        Args:\n            data: CRM-adjusted exposures.\n            config: Calculation configuration.\n\n        Returns:\n            EquityResultBundle with results and audit trail.\n        \"\"\"\n\n    def calculate_single_exposure(\n        self,\n        ead: Decimal,\n        equity_type: str,\n        is_diversified: bool = False,\n        is_speculative: bool = False,\n        is_exchange_traded: bool = False,\n        is_government_supported: bool = False,\n        config: CalculationConfig | None = None,\n    ) -&gt; dict:\n        \"\"\"\n        Calculate RWA for a single equity exposure (convenience method).\n\n        Args:\n            ead: Exposure at default.\n            equity_type: Type of equity exposure.\n            is_diversified: Whether in diversified portfolio (for PE).\n            is_speculative: Whether speculative unlisted.\n            is_exchange_traded: Whether exchange traded.\n            is_government_supported: Whether government supported.\n            config: Calculation configuration (defaults to CRR SA).\n\n        Returns:\n            Dictionary with calculation results.\n\n        Example:\n            &gt;&gt;&gt; calculator = EquityCalculator()\n            &gt;&gt;&gt; result = calculator.calculate_single_exposure(\n            ...     ead=Decimal(\"1000000\"),\n            ...     equity_type=\"private_equity\",\n            ...     is_diversified=True,\n            ... )\n            &gt;&gt;&gt; print(f\"RWA: {result['rwa']:,.0f}\")\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#module-rwa_calcengineequitynamespace","title":"Module: <code>rwa_calc.engine.equity.namespace</code>","text":"<p>The Equity module provides Polars namespace extensions for fluent equity calculations.</p>"},{"location":"api/engine/#equitylazyframe-namespace","title":"EquityLazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"equity\")\nclass EquityLazyFrame:\n    \"\"\"LazyFrame namespace for equity calculations.\"\"\"\n\n    def prepare_columns(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Ensure all required columns exist with defaults.\n\n        Adds/normalizes:\n        - ead_final: Exposure at default (from fair_value/carrying_value)\n        - equity_type: Type of equity exposure\n        - is_diversified_portfolio: Whether in diversified portfolio\n        - is_speculative: Whether speculative unlisted\n        - is_exchange_traded: Whether exchange traded\n        - is_government_supported: Whether government supported\n        \"\"\"\n\n    def apply_equity_weights_sa(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply Article 133 (SA) equity risk weights.\n\n        Risk weights:\n        - Central bank: 0%\n        - Listed/Exchange-traded/Government-supported: 100%\n        - Unlisted/Private equity: 250%\n        - Speculative: 400%\n        \"\"\"\n\n    def apply_equity_weights_irb_simple(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply Article 155 (IRB Simple) equity risk weights.\n\n        Risk weights:\n        - Central bank: 0%\n        - Private equity (diversified portfolio): 190%\n        - Government-supported: 190%\n        - Exchange-traded/Listed: 290%\n        - Other equity: 370%\n        \"\"\"\n\n    def calculate_rwa(self) -&gt; pl.LazyFrame:\n        \"\"\"Calculate RWA = EAD \u00d7 Risk Weight.\"\"\"\n\n    def apply_all_sa(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply full equity SA calculation pipeline.\n\n        Chains: prepare_columns -&gt; apply_equity_weights_sa -&gt; calculate_rwa\n        \"\"\"\n\n    def apply_all_irb_simple(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply full equity IRB Simple calculation pipeline.\n\n        Chains: prepare_columns -&gt; apply_equity_weights_irb_simple -&gt; calculate_rwa\n        \"\"\"\n\n    def build_audit(self, approach: str = \"sa\") -&gt; pl.LazyFrame:\n        \"\"\"\n        Build equity calculation audit trail.\n\n        Format: Equity (Art. 133 SA): Type={type}, RW={rw}%, RWA={rwa}\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#equityexpr-namespace","title":"EquityExpr Namespace","text":"<pre><code>@pl.api.register_expr_namespace(\"equity\")\nclass EquityExpr:\n    \"\"\"Expression namespace for column-level equity operations.\"\"\"\n\n    def lookup_rw(self, approach: str = \"sa\") -&gt; pl.Expr:\n        \"\"\"\n        Look up risk weight based on equity type.\n\n        Args:\n            approach: \"sa\" for Article 133, \"irb_simple\" for Article 155\n\n        Returns:\n            Expression with risk weight\n        \"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nfrom datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.equity.namespace  # Registers namespace\n\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Fluent equity calculation (SA)\nresult = (\n    equity_exposures\n    .equity.prepare_columns(config)\n    .equity.apply_equity_weights_sa()\n    .equity.calculate_rwa()\n    .collect()\n)\n\n# Or use the convenience method for IRB Simple\nresult = equity_exposures.equity.apply_all_irb_simple(config).collect()\n\n# Use expression namespace for lookups\ndf = df.with_columns(\n    pl.col(\"equity_type\").equity.lookup_rw(approach=\"sa\").alias(\"risk_weight\"),\n)\n</code></pre>"},{"location":"api/engine/#aggregator","title":"Aggregator","text":""},{"location":"api/engine/#module-rwa_calcengineaggregator","title":"Module: <code>rwa_calc.engine.aggregator</code>","text":"<pre><code>class OutputAggregator:\n    \"\"\"Aggregate calculation results.\"\"\"\n\n    def aggregate(\n        self,\n        sa_result: SAResultBundle,\n        irb_result: IRBResultBundle,\n        slotting_result: SlottingResultBundle,\n        config: CalculationConfig,\n    ) -&gt; AggregatedResultBundle:\n        \"\"\"\n        Aggregate results and apply final adjustments.\n\n        Args:\n            sa_result: SA calculation results.\n            irb_result: IRB calculation results.\n            slotting_result: Slotting calculation results.\n            config: Calculation configuration.\n\n        Returns:\n            AggregatedResultBundle: Final aggregated results.\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#module-rwa_calcengineaggregator_namespace","title":"Module: <code>rwa_calc.engine.aggregator_namespace</code>","text":"<p>The Aggregator module provides Polars namespace extensions for result combination and output floor application.</p>"},{"location":"api/engine/#aggregatorlazyframe-namespace","title":"AggregatorLazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"aggregator\")\nclass AggregatorLazyFrame:\n    \"\"\"LazyFrame namespace for result aggregation.\"\"\"\n\n    def combine_approach_results(\n        self,\n        sa: pl.LazyFrame | None = None,\n        irb: pl.LazyFrame | None = None,\n        slotting: pl.LazyFrame | None = None,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Combine results from all calculation approaches.\n\n        Adds column:\n        - approach_applied: SA, FIRB, AIRB, or SLOTTING\n        \"\"\"\n\n    def apply_output_floor(\n        self,\n        sa_results: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply Basel 3.1 output floor.\n\n        Floor = floor_pct \u00d7 SA equivalent RWA\n        Final RWA = max(IRB RWA, Floor RWA)\n\n        Adds columns:\n        - floor_rwa: Floor RWA amount\n        - is_floor_binding: Whether floor exceeds IRB RWA\n        - rwa_final: Final RWA after floor\n        \"\"\"\n\n    def calculate_floor_impact(self) -&gt; pl.LazyFrame:\n        \"\"\"Calculate impact of output floor on RWA.\"\"\"\n\n    def generate_summary_by_class(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Generate RWA summary by exposure class.\n\n        Returns:\n        - exposure_class: Regulatory class\n        - exposure_count: Number of exposures\n        - total_ead: Sum of EAD\n        - total_rwa: Sum of RWA\n        - average_rw: Weighted average risk weight\n        \"\"\"\n\n    def generate_summary_by_approach(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Generate RWA summary by calculation approach.\n\n        Returns:\n        - approach_applied: SA, FIRB, AIRB, SLOTTING\n        - exposure_count: Number of exposures\n        - total_ead: Sum of EAD\n        - total_rwa: Sum of RWA\n        \"\"\"\n\n    def generate_supporting_factor_impact(self) -&gt; pl.LazyFrame:\n        \"\"\"Generate summary of supporting factor impact on RWA.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.aggregator_namespace  # Registers namespace\n\nconfig = CalculationConfig.basel_3_1(reporting_date=date(2027, 6, 30))\n\n# Combine results and apply output floor\nfinal_results = (\n    combined_results\n    .aggregator.combine_approach_results(sa=sa_results, irb=irb_results)\n    .aggregator.apply_output_floor(sa_for_floor, config)\n)\n\n# Generate summaries\nby_class = final_results.aggregator.generate_summary_by_class()\nby_approach = final_results.aggregator.generate_summary_by_approach()\n</code></pre>"},{"location":"api/engine/#audit-namespace","title":"Audit Namespace","text":""},{"location":"api/engine/#module-rwa_calcengineaudit_namespace","title":"Module: <code>rwa_calc.engine.audit_namespace</code>","text":"<p>The Audit module provides shared formatting utilities and audit trail builders for all calculation approaches.</p>"},{"location":"api/engine/#auditlazyframe-namespace","title":"AuditLazyFrame Namespace","text":"<pre><code>@pl.api.register_lazyframe_namespace(\"audit\")\nclass AuditLazyFrame:\n    \"\"\"LazyFrame namespace for audit trail generation.\"\"\"\n\n    def build_sa_calculation(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build SA calculation audit trail.\n\n        Format: SA: EAD={ead} \u00d7 RW={rw}% \u00d7 SF={sf}% \u2192 RWA={rwa}\n\n        Adds column: sa_calculation\n        \"\"\"\n\n    def build_irb_calculation(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build IRB calculation audit trail.\n\n        Format: IRB: PD={pd}%, LGD={lgd}%, R={corr}%, K={k}%, MA={ma} \u2192 RWA={rwa}\n\n        Adds column: irb_calculation\n        \"\"\"\n\n    def build_slotting_calculation(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build slotting calculation audit trail.\n\n        Format: Slotting: Category={cat} (HVCRE?), RW={rw}% \u2192 RWA={rwa}\n\n        Adds column: slotting_calculation\n        \"\"\"\n\n    def build_crm_calculation(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build CRM/EAD waterfall audit trail.\n\n        Format: EAD: gross={gross}; coll={coll}; guar={guar}; prov={prov}; final={final}\n\n        Adds column: crm_calculation\n        \"\"\"\n\n    def build_haircut_calculation(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build haircut audit trail.\n\n        Format: MV={mv}; Hc={hc}%; Hfx={hfx}%; Adj={adj}\n\n        Adds column: haircut_calculation\n        \"\"\"\n\n    def build_floor_calculation(self) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build output floor audit trail.\n\n        Format: Floor: IRB RWA={irb}; Floor RWA={floor} ({pct}%); Final={final}; Binding={binding}\n\n        Adds column: floor_calculation\n        \"\"\"\n</code></pre>"},{"location":"api/engine/#auditexpr-namespace","title":"AuditExpr Namespace","text":"<pre><code>@pl.api.register_expr_namespace(\"audit\")\nclass AuditExpr:\n    \"\"\"Expression namespace for audit formatting.\"\"\"\n\n    def format_currency(self, decimals: int = 0) -&gt; pl.Expr:\n        \"\"\"Format value as currency string (no symbol).\"\"\"\n\n    def format_percent(self, decimals: int = 1) -&gt; pl.Expr:\n        \"\"\"Format value as percentage string (e.g., '20.0%').\"\"\"\n\n    def format_ratio(self, decimals: int = 3) -&gt; pl.Expr:\n        \"\"\"Format value as ratio/decimal string.\"\"\"\n\n    def format_bps(self, decimals: int = 0) -&gt; pl.Expr:\n        \"\"\"Format value as basis points string (e.g., '150 bps').\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>import polars as pl\nimport rwa_calc.engine.audit_namespace  # Registers namespace\n\n# Build audit trails for SA exposures\naudited_sa = sa_results.audit.build_sa_calculation()\n\n# Build audit trails for IRB exposures\naudited_irb = irb_results.audit.build_irb_calculation()\n\n# Format individual columns\nformatted = df.with_columns(\n    pl.col(\"ead\").audit.format_currency().alias(\"ead_formatted\"),\n    pl.col(\"risk_weight\").audit.format_percent().alias(\"rw_formatted\"),\n    pl.col(\"pd\").audit.format_bps().alias(\"pd_bps\"),\n)\n</code></pre>"},{"location":"api/engine/#fx-converter","title":"FX Converter","text":""},{"location":"api/engine/#module-rwa_calcenginefx_converter","title":"Module: <code>rwa_calc.engine.fx_converter</code>","text":"<pre><code>class FXConverter:\n    \"\"\"Convert monetary values to base currency.\"\"\"\n\n    def convert_exposures(\n        self,\n        exposures: pl.LazyFrame,\n        fx_rates: pl.LazyFrame,\n        base_currency: str = \"GBP\",\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Convert exposure amounts to base currency.\n\n        Converts drawn_amount, undrawn_amount, nominal_amount.\n        Preserves original values in audit columns.\n\n        Args:\n            exposures: Exposures with currency column.\n            fx_rates: FX rate lookup table.\n            base_currency: Target currency.\n\n        Returns:\n            LazyFrame with converted amounts.\n        \"\"\"\n\n    def convert_collateral(\n        self,\n        collateral: pl.LazyFrame,\n        fx_rates: pl.LazyFrame,\n        base_currency: str = \"GBP\",\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Convert collateral values to base currency.\n\n        Converts market_value, nominal_value.\n        \"\"\"\n\n    def convert_guarantees(\n        self,\n        guarantees: pl.LazyFrame,\n        fx_rates: pl.LazyFrame,\n        base_currency: str = \"GBP\",\n    ) -&gt; pl.LazyFrame:\n        \"\"\"Convert guarantee covered amounts to base currency.\"\"\"\n\n    def convert_provisions(\n        self,\n        provisions: pl.LazyFrame,\n        fx_rates: pl.LazyFrame,\n        base_currency: str = \"GBP\",\n    ) -&gt; pl.LazyFrame:\n        \"\"\"Convert provision amounts to base currency.\"\"\"\n</code></pre> <p>Usage Example:</p> <pre><code>from rwa_calc.engine.fx_converter import create_fx_converter\n\nconverter = create_fx_converter()\n\n# Convert all monetary values to GBP\nconverted_exposures = converter.convert_exposures(\n    exposures, fx_rates, base_currency=\"GBP\"\n)\nconverted_collateral = converter.convert_collateral(\n    collateral, fx_rates, base_currency=\"GBP\"\n)\n</code></pre> <p>Audit Trail: Each conversion adds <code>original_currency</code>, <code>original_amount</code>, and <code>fx_rate_applied</code> columns for traceability.</p>"},{"location":"api/engine/#related","title":"Related","text":"<ul> <li>Pipeline API</li> <li>Contracts API</li> <li>Architecture - Components</li> </ul>"},{"location":"api/pipeline/","title":"Pipeline API","text":"<p>The pipeline module provides the main entry points for RWA calculation. See <code>pipeline.py</code> for the full implementation.</p>"},{"location":"api/pipeline/#module-rwa_calcenginepipeline","title":"Module: <code>rwa_calc.engine.pipeline</code>","text":""},{"location":"api/pipeline/#create_pipeline","title":"<code>create_pipeline</code>","text":"<p>Factory function to create a pipeline with default components:</p> <p>Create a pipeline orchestrator with default components.</p> <p>Parameters:</p> Name Type Description Default <code>data_path</code> <code>str | Path | None</code> <p>Path to data directory (creates ParquetLoader)</p> <code>None</code> <code>loader</code> <code>LoaderProtocol | None</code> <p>Pre-configured loader (overrides data_path)</p> <code>None</code> <p>Returns:</p> Type Description <code>PipelineOrchestrator</code> <p>PipelineOrchestrator ready for use</p> Usage"},{"location":"api/pipeline/#rwa_calc.engine.pipeline.create_pipeline--with-data-path-uses-parquetloader","title":"With data path (uses ParquetLoader)","text":"<p>pipeline = create_pipeline(data_path=\"/path/to/data\")</p>"},{"location":"api/pipeline/#rwa_calc.engine.pipeline.create_pipeline--with-custom-loader","title":"With custom loader","text":"<p>pipeline = create_pipeline(loader=CSVLoader(\"/path/to/data\"))</p>"},{"location":"api/pipeline/#rwa_calc.engine.pipeline.create_pipeline--without-loader-use-run_with_data","title":"Without loader (use run_with_data)","text":"<p>pipeline = create_pipeline()</p>"},{"location":"api/pipeline/#pipelineorchestrator","title":"<code>PipelineOrchestrator</code>","text":"<p>The main pipeline class (note: the class is <code>PipelineOrchestrator</code>, not <code>RWAPipeline</code>):</p> Pipeline Implementation (pipeline.py) <pre><code>class PipelineOrchestrator:\n    \"\"\"\n    Orchestrate the complete RWA calculation pipeline.\n\n    Implements PipelineProtocol for:\n    - Full pipeline execution from data loading to final aggregation\n    - Pre-loaded data execution (bypassing loader)\n    - Component dependency management\n    - Error accumulation across stages\n\n    Pipeline stages:\n    1. Loader: Load raw data from files/databases\n    2. HierarchyResolver: Resolve counterparty and facility hierarchies\n    3. Classifier: Classify exposures and assign approaches\n    4. CRMProcessor: Apply credit risk mitigation\n    5. SACalculator: Calculate SA RWA\n    6. IRBCalculator: Calculate IRB RWA\n    7. SlottingCalculator: Calculate Slotting RWA\n    8. OutputAggregator: Combine results, apply floor, generate summaries\n\n    Usage:\n        orchestrator = PipelineOrchestrator(\n            loader=ParquetLoader(base_path),\n            hierarchy_resolver=HierarchyResolver(),\n            classifier=ExposureClassifier(),\n            crm_processor=CRMProcessor(),\n            sa_calculator=SACalculator(),\n            irb_calculator=IRBCalculator(),\n            slotting_calculator=SlottingCalculator(),\n            aggregator=OutputAggregator(),\n        )\n        result = orchestrator.run(config)\n    \"\"\"\n\n    def __init__(\n        self,\n        loader: LoaderProtocol | None = None,\n        hierarchy_resolver: HierarchyResolverProtocol | None = None,\n        classifier: ClassifierProtocol | None = None,\n        crm_processor: CRMProcessorProtocol | None = None,\n        sa_calculator: SACalculatorProtocol | None = None,\n        irb_calculator: IRBCalculatorProtocol | None = None,\n        slotting_calculator: SlottingCalculatorProtocol | None = None,\n        equity_calculator: EquityCalculatorProtocol | None = None,\n        aggregator: OutputAggregatorProtocol | None = None,\n    ) -&gt; None:\n        \"\"\"\n        Initialize pipeline with components.\n\n        Components can be injected for testing or customization.\n        If not provided, defaults will be created on first use.\n\n        Args:\n            loader: Data loader (optional - required for run())\n            hierarchy_resolver: Hierarchy resolver\n            classifier: Exposure classifier\n            crm_processor: CRM processor\n            sa_calculator: SA calculator\n            irb_calculator: IRB calculator\n            slotting_calculator: Slotting calculator\n            equity_calculator: Equity calculator\n            aggregator: Output aggregator\n        \"\"\"\n        self._loader = loader\n        self._hierarchy_resolver = hierarchy_resolver\n        self._classifier = classifier\n        self._crm_processor = crm_processor\n        self._sa_calculator = sa_calculator\n        self._irb_calculator = irb_calculator\n        self._slotting_calculator = slotting_calculator\n        self._equity_calculator = equity_calculator\n        self._aggregator = aggregator\n        self._errors: list[PipelineError] = []\n\n    # =========================================================================\n    # Public API\n    # =========================================================================\n\n    def run(self, config: CalculationConfig) -&gt; AggregatedResultBundle:\n        \"\"\"\n        Execute the complete RWA calculation pipeline.\n\n        Requires a loader to be configured.\n\n        Args:\n            config: Calculation configuration\n\n        Returns:\n            AggregatedResultBundle with all results and audit trail\n\n        Raises:\n            ValueError: If no loader is configured\n        \"\"\"\n        if self._loader is None:\n            raise ValueError(\n                \"No loader configured. Use run_with_data() or provide a loader.\"\n            )\n\n        # Reset errors for new run\n</code></pre>"},{"location":"api/pipeline/#rwa_calc.engine.pipeline.PipelineOrchestrator","title":"<code>rwa_calc.engine.pipeline.PipelineOrchestrator</code>","text":"<p>Orchestrate the complete RWA calculation pipeline.</p> <p>Implements PipelineProtocol for: - Full pipeline execution from data loading to final aggregation - Pre-loaded data execution (bypassing loader) - Component dependency management - Error accumulation across stages</p> <p>Pipeline stages: 1. Loader: Load raw data from files/databases 2. HierarchyResolver: Resolve counterparty and facility hierarchies 3. Classifier: Classify exposures and assign approaches 4. CRMProcessor: Apply credit risk mitigation 5. SACalculator: Calculate SA RWA 6. IRBCalculator: Calculate IRB RWA 7. SlottingCalculator: Calculate Slotting RWA 8. OutputAggregator: Combine results, apply floor, generate summaries</p> Usage <p>orchestrator = PipelineOrchestrator(     loader=ParquetLoader(base_path),     hierarchy_resolver=HierarchyResolver(),     classifier=ExposureClassifier(),     crm_processor=CRMProcessor(),     sa_calculator=SACalculator(),     irb_calculator=IRBCalculator(),     slotting_calculator=SlottingCalculator(),     aggregator=OutputAggregator(), ) result = orchestrator.run(config)</p>"},{"location":"api/pipeline/#rwa_calc.engine.pipeline.PipelineOrchestrator.run","title":"<code>run(config)</code>","text":"<p>Execute the complete RWA calculation pipeline.</p> <p>Requires a loader to be configured.</p> <p>Parameters:</p> Name Type Description Default <code>config</code> <code>CalculationConfig</code> <p>Calculation configuration</p> required <p>Returns:</p> Type Description <code>AggregatedResultBundle</code> <p>AggregatedResultBundle with all results and audit trail</p> <p>Raises:</p> Type Description <code>ValueError</code> <p>If no loader is configured</p>"},{"location":"api/pipeline/#rwa_calc.engine.pipeline.PipelineOrchestrator.run_with_data","title":"<code>run_with_data(data, config)</code>","text":"<p>Execute pipeline with pre-loaded data.</p> <p>Bypasses the loader stage, useful for testing or when data is already available.</p> <p>Parameters:</p> Name Type Description Default <code>data</code> <code>RawDataBundle</code> <p>Pre-loaded raw data bundle</p> required <code>config</code> <code>CalculationConfig</code> <p>Calculation configuration</p> required <p>Returns:</p> Type Description <code>AggregatedResultBundle</code> <p>AggregatedResultBundle with all results and audit trail</p>"},{"location":"api/pipeline/#usage-examples","title":"Usage Examples","text":""},{"location":"api/pipeline/#basic-usage","title":"Basic Usage","text":"<pre><code>from datetime import date\nfrom rwa_calc.engine.pipeline import create_pipeline\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# Create pipeline\npipeline = create_pipeline()\n\n# Configure for CRR\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=True,\n)\n\n# Run calculation\nresult = pipeline.run(config)\n\n# Access results\nprint(f\"Total RWA: {result.total_rwa:,.0f}\")\nprint(f\"SA RWA: {result.sa_rwa:,.0f}\")\nprint(f\"IRB RWA: {result.irb_rwa:,.0f}\")\n</code></pre>"},{"location":"api/pipeline/#with-custom-data-path","title":"With Custom Data Path","text":"<pre><code>from pathlib import Path\nfrom rwa_calc.engine.loader import ParquetLoader\n\n# Load data from custom path\nloader = ParquetLoader()\nraw_data = loader.load(Path(\"/path/to/data\"))\n\n# Run with pre-loaded data\nresult = pipeline.run_with_data(raw_data, config)\n</code></pre>"},{"location":"api/pipeline/#framework-comparison","title":"Framework Comparison","text":"<pre><code># Run under both frameworks\nconfig_crr = CalculationConfig.crr(date(2026, 12, 31))\nconfig_b31 = CalculationConfig.basel_3_1(date(2027, 1, 1))\n\nresult_crr = pipeline.run(config_crr)\nresult_b31 = pipeline.run(config_b31)\n\n# Compare\nimpact = (result_b31.total_rwa / result_crr.total_rwa - 1) * 100\nprint(f\"Basel 3.1 impact: {impact:+.1f}%\")\n</code></pre>"},{"location":"api/pipeline/#error-handling","title":"Error Handling","text":"<pre><code>result = pipeline.run(config)\n\n# Check for errors\nif result.has_errors:\n    print(\"Calculation completed with errors:\")\n    for error in result.errors:\n        print(f\"  - {error.exposure_id}: {error.message}\")\n\n# Check for warnings\nif result.has_warnings:\n    print(\"Warnings:\")\n    for warning in result.warnings:\n        print(f\"  - {warning.message}\")\n</code></pre>"},{"location":"api/pipeline/#related","title":"Related","text":"<ul> <li>Configuration API</li> <li>Contracts API</li> <li>Architecture - Pipeline</li> </ul>"},{"location":"appendix/","title":"Appendix","text":"<p>This appendix provides reference materials and supplementary information.</p>"},{"location":"appendix/#contents","title":"Contents","text":"<ul> <li>Glossary - Definitions of key terms and acronyms</li> <li>Regulatory References - Links to regulatory documents</li> <li>Changelog - Version history and changes</li> </ul>"},{"location":"appendix/#quick-reference","title":"Quick Reference","text":""},{"location":"appendix/#key-acronyms","title":"Key Acronyms","text":"Acronym Definition RWA Risk-Weighted Assets SA Standardised Approach IRB Internal Ratings-Based F-IRB Foundation IRB A-IRB Advanced IRB CRR Capital Requirements Regulation PD Probability of Default LGD Loss Given Default EAD Exposure at Default CCF Credit Conversion Factor CRM Credit Risk Mitigation CQS Credit Quality Step SME Small and Medium Enterprise"},{"location":"appendix/#key-thresholds","title":"Key Thresholds","text":"Threshold EUR GBP (@ 0.88) SME turnover EUR 50m GBP 44m SME exposure tier EUR 2.5m GBP 2.2m Retail threshold EUR 1m GBP 880k Large corporate EUR 500m GBP 440m"},{"location":"appendix/#key-dates","title":"Key Dates","text":"Date Event 31 Dec 2026 CRR final effective date 1 Jan 2027 Basel 3.1 effective date 2027-2032 Output floor phase-in 1 Jan 2032 Full 72.5% floor"},{"location":"appendix/changelog/","title":"Changelog","text":"<p>All notable changes to the RWA Calculator are documented in this file.</p> <p>The format is based on Keep a Changelog, and this project adheres to Semantic Versioning.</p>"},{"location":"appendix/changelog/#unreleased","title":"[Unreleased]","text":""},{"location":"appendix/changelog/#added","title":"Added","text":"<ul> <li>(Next release changes will go here)</li> </ul>"},{"location":"appendix/changelog/#changed","title":"Changed","text":"<ul> <li>(Next release changes will go here)</li> </ul>"},{"location":"appendix/changelog/#0121-2026-02-16","title":"[0.1.21] - 2026-02-16","text":""},{"location":"appendix/changelog/#added_1","title":"Added","text":""},{"location":"appendix/changelog/#pledge-percentage-for-collateral-valuation","title":"Pledge Percentage for Collateral Valuation","text":"<ul> <li>Introduced <code>pledge_percentage</code> field to allow collateral to be specified as a percentage of the beneficiary's EAD</li> <li>Collateral processing resolves <code>pledge_percentage</code> to absolute market values based on beneficiary type (loan, facility, or counterparty level)</li> <li>Updated input schemas and CRM methodology documentation to reflect the new field</li> <li>403 lines of new tests covering pledge percentage resolution across different beneficiary levels</li> </ul>"},{"location":"appendix/changelog/#0120-2026-02-14","title":"[0.1.20] - 2026-02-14","text":""},{"location":"appendix/changelog/#added_2","title":"Added","text":""},{"location":"appendix/changelog/#equity-exposure-fx-conversion","title":"Equity Exposure FX Conversion","text":"<ul> <li>New <code>convert_equity_exposures()</code> method in FX converter for converting equity exposure values to reporting currency</li> <li>Updated classifier and hierarchy to support equity exposures in FX conversion pipeline</li> <li>Enhanced FX rate configuration with equity-specific handling</li> <li>Comprehensive tests for equity exposure conversion and currency handling</li> </ul>"},{"location":"appendix/changelog/#0119-2026-02-11","title":"[0.1.19] - 2026-02-11","text":""},{"location":"appendix/changelog/#added_3","title":"Added","text":""},{"location":"appendix/changelog/#buy-to-let-flag","title":"Buy-to-Let Flag","text":"<ul> <li>New <code>is_buy_to_let</code> boolean flag in hierarchy and schemas for identifying BTL exposures</li> <li>BTL exposures excluded from SME supporting factor discount</li> <li>Unit tests verifying BTL flag behaviour in supporting factor calculations</li> </ul>"},{"location":"appendix/changelog/#on-balance-ead-helper","title":"On-Balance EAD Helper","text":"<ul> <li>New <code>on_balance_ead()</code> helper function in CCF module calculating EAD as <code>max(0, drawn) + interest</code></li> <li>Updated CRM processor and namespace to use the new helper</li> <li>Comprehensive tests covering various on-balance EAD scenarios</li> </ul>"},{"location":"appendix/changelog/#changed_1","title":"Changed","text":"<ul> <li>Updated implementation plan and roadmap documentation with current test results and fixture completion status</li> </ul>"},{"location":"appendix/changelog/#0118-2026-02-10","title":"[0.1.18] - 2026-02-10","text":""},{"location":"appendix/changelog/#added_4","title":"Added","text":""},{"location":"appendix/changelog/#facility-hierarchy-enhancements","title":"Facility Hierarchy Enhancements","text":"<ul> <li>Facility root lookup and undrawn calculations for full facility hierarchy resolution</li> <li>Include contingent liabilities in facility undrawn calculations</li> <li>Enhanced facility hierarchy resolution logic</li> </ul>"},{"location":"appendix/changelog/#0117-2026-02-10","title":"[0.1.17] - 2026-02-10","text":""},{"location":"appendix/changelog/#added_5","title":"Added","text":"<ul> <li>CCF: handle negative drawn amounts in EAD calculations</li> </ul>"},{"location":"appendix/changelog/#fixed","title":"Fixed","text":"<ul> <li>Hierarchy: resolve duplicate mapping issues in facility calculations</li> </ul>"},{"location":"appendix/changelog/#0116-2026-02-09","title":"[0.1.16] - 2026-02-09","text":""},{"location":"appendix/changelog/#added_6","title":"Added","text":""},{"location":"appendix/changelog/#cross-approach-ccf-substitution","title":"Cross-Approach CCF Substitution","text":"<ul> <li>SA CCF expression and cross-approach substitution for guaranteed IRB exposures</li> <li>When an IRB exposure is guaranteed by an SA counterparty, the guaranteed portion uses SA CCFs</li> <li>New columns: <code>ccf_original</code>, <code>ccf_guaranteed</code>, <code>ccf_unguaranteed</code>, <code>guarantee_ratio</code>, <code>guarantor_approach</code>, <code>guarantor_rating_type</code></li> </ul>"},{"location":"appendix/changelog/#aggregator-enhancements","title":"Aggregator Enhancements","text":"<ul> <li>Updated summaries for post-CRM reporting</li> <li>Enhanced approach handling for IRB results</li> </ul>"},{"location":"appendix/changelog/#0115-2026-02-08","title":"[0.1.15] - 2026-02-08","text":""},{"location":"appendix/changelog/#added_7","title":"Added","text":"<ul> <li>Correlation: rename sovereign exposure class to central govt/central bank</li> <li>CI: add GitHub Actions workflow for documentation deployment</li> </ul>"},{"location":"appendix/changelog/#0114-2026-02-07","title":"[0.1.14] - 2026-02-07","text":""},{"location":"appendix/changelog/#added_8","title":"Added","text":""},{"location":"appendix/changelog/#overcollateralisation-requirements-crr-art-230-cre329-12","title":"Overcollateralisation Requirements (CRR Art. 230 / CRE32.9-12)","text":"<p>Non-financial collateral now requires overcollateralisation to receive CRM benefit:</p> Collateral Type Overcollateralisation Ratio Minimum Threshold Financial 1.0x No minimum Receivables 1.25x No minimum Real estate 1.4x 30% of EAD Other physical 1.4x 30% of EAD <ul> <li><code>effectively_secured = adjusted_value / overcollateralisation_ratio</code></li> <li>Financial vs non-financial collateral tracked separately for threshold checks</li> <li>Multi-level allocation respects overcollateralisation at each level</li> </ul>"},{"location":"appendix/changelog/#changed_2","title":"Changed","text":"<ul> <li>Standardized <code>collateral_type</code> casing and descriptions across codebase</li> </ul>"},{"location":"appendix/changelog/#0113-2026-02-07","title":"[0.1.13] - 2026-02-07","text":""},{"location":"appendix/changelog/#added_9","title":"Added","text":""},{"location":"appendix/changelog/#input-value-validation","title":"Input Value Validation","text":"<ul> <li><code>validate_bundle_values()</code> validates all categorical columns against <code>COLUMN_VALUE_CONSTRAINTS</code></li> <li>Error code <code>DQ006</code> for invalid column values</li> <li>Pipeline calls <code>_validate_input_data()</code> as non-blocking step (errors collected, not raised)</li> </ul>"},{"location":"appendix/changelog/#fixed_1","title":"Fixed","text":"<ul> <li>Prevented row duplication in exposure joins when <code>facility_reference = loan_reference</code> (#71)</li> </ul>"},{"location":"appendix/changelog/#0112-2026-02-02","title":"[0.1.12] - 2026-02-02","text":""},{"location":"appendix/changelog/#added_10","title":"Added","text":""},{"location":"appendix/changelog/#equity-exposure-calculator","title":"Equity Exposure Calculator","text":"<p>Complete equity exposure RWA calculation supporting two regulatory approaches:</p> <p>Article 133 - Standardised Approach (SA): | Equity Type | Risk Weight | |-------------|-------------| | Central bank | 0% | | Listed/Exchange-traded/Government-supported | 100% | | Unlisted/Private equity | 250% | | Speculative | 400% |</p> <p>Article 155 - IRB Simple Risk Weight Method: | Equity Type | Risk Weight | |-------------|-------------| | Central bank | 0% | | Private equity (diversified portfolio) | 190% | | Government-supported | 190% | | Exchange-traded/Listed | 290% | | Other equity | 370% |</p> <p>New Components: - <code>EquityCalculator</code> class (<code>src/rwa_calc/engine/equity/calculator.py</code>) - <code>EquityLazyFrame</code> namespace (<code>lf.equity</code>) for fluent calculations - <code>EquityExpr</code> namespace (<code>expr.equity</code>) for column-level operations - <code>EquityResultBundle</code> for equity calculation results - <code>crr_equity_rw.py</code> lookup tables</p> <p>Features: - Automatic approach determination based on IRB permissions - Diversified portfolio treatment for private equity (190% vs 370%) - Full audit trail generation - Single exposure calculation convenience method</p>"},{"location":"appendix/changelog/#prepost-crm-tracking-for-guarantees","title":"Pre/Post CRM Tracking for Guarantees","text":"<p>Enhanced guarantee processing with full tracking of exposure amounts before and after CRM application: - <code>rwa_pre_crm</code>: RWA calculated on original exposure before guarantee - <code>rwa_post_crm</code>: RWA calculated after guarantee substitution - <code>guarantee_rwa_benefit</code>: Reduction in RWA from guarantee protection - Supports both covered and uncovered portion tracking</p>"},{"location":"appendix/changelog/#changed_3","title":"Changed","text":"<ul> <li>Pipeline now includes equity calculator between CRM and aggregator</li> <li><code>CRMAdjustedBundle</code> extended with <code>equity_exposures</code> field</li> </ul>"},{"location":"appendix/changelog/#0111-2026-01-28","title":"[0.1.11] - 2026-01-28","text":""},{"location":"appendix/changelog/#added_11","title":"Added","text":"<ul> <li>Namespace: add exact fractional years calculation</li> <li>Config: add MCP server configuration</li> </ul>"},{"location":"appendix/changelog/#0110-2026-01-28","title":"[0.1.10] - 2026-01-28","text":""},{"location":"appendix/changelog/#added_12","title":"Added","text":"<ul> <li>CCF: include interest in EAD calculations</li> </ul>"},{"location":"appendix/changelog/#018-2026-01-28","title":"[0.1.8] - 2026-01-28","text":""},{"location":"appendix/changelog/#added_13","title":"Added","text":"<ul> <li>Data: add script to generate sample data in parquet format</li> <li>Correlation: add SME adjustment with EUR/GBP conversion</li> <li>Orgs: make org_mappings optional in data loaders</li> </ul>"},{"location":"appendix/changelog/#fixed_2","title":"Fixed","text":"<ul> <li>Config: update EUR to GBP exchange rate</li> </ul>"},{"location":"appendix/changelog/#017-2026-01-27","title":"[0.1.7] - 2026-01-27","text":""},{"location":"appendix/changelog/#added_14","title":"Added","text":"<ul> <li>Tests: add unit tests for API error handling and validation</li> <li>Protocols: update aggregation method with new bundles</li> <li>Loader: enhance data loading with validation checks</li> <li>BDD: add specifications for CRR provisions, risk weights, and supporting factors</li> </ul>"},{"location":"appendix/changelog/#changed_4","title":"Changed","text":"<ul> <li>Loans: update loan schema and documentation</li> </ul>"},{"location":"appendix/changelog/#016-2026-01-25","title":"[0.1.6] - 2026-01-25","text":""},{"location":"appendix/changelog/#added_15","title":"Added","text":"<ul> <li>Stats: implement backend detection for statistical functions</li> <li>Documentation: add detailed implementation plan and project roadmap</li> </ul>"},{"location":"appendix/changelog/#changed_5","title":"Changed","text":"<ul> <li>Stats: remove dual stats backend implementation</li> <li>Documentation: update optional dependencies and installation instructions</li> </ul>"},{"location":"appendix/changelog/#015-2026-01-25","title":"[0.1.5] - 2026-01-25","text":""},{"location":"appendix/changelog/#added_16","title":"Added","text":"<ul> <li>Counterparties: enhance counterparty schema and classification</li> <li>Documentation: add logo to documentation theme</li> </ul>"},{"location":"appendix/changelog/#changed_6","title":"Changed","text":"<ul> <li>CCF: remove unused CCF module and tests</li> <li>Contingents: remove ccf_category and update risk_type</li> </ul>"},{"location":"appendix/changelog/#performance","title":"Performance","text":"<ul> <li>Benchmark: update results with improved metrics</li> </ul>"},{"location":"appendix/changelog/#014-2026-01-25","title":"[0.1.4] - 2026-01-25","text":""},{"location":"appendix/changelog/#added_17","title":"Added","text":"<ul> <li>Deploy: add automated deployment script</li> </ul>"},{"location":"appendix/changelog/#performance_1","title":"Performance","text":"<ul> <li>Benchmark: transition to pure Polars expressions</li> </ul>"},{"location":"appendix/changelog/#013-2025-01-24","title":"[0.1.3] - 2025-01-24","text":""},{"location":"appendix/changelog/#added_18","title":"Added","text":""},{"location":"appendix/changelog/#documentation-code-linking","title":"Documentation Code Linking","text":"<ul> <li>Updated documentation to link code examples to actual source implementations</li> <li>Added <code>pymdownx.snippets</code> for embedding real code from source files</li> <li>Added <code>mkdocstrings</code> auto-generated API documentation</li> <li>New <code>docs/development/documentation-conventions.md</code> guide for contributors</li> <li>Source code references with GitHub line number links throughout docs</li> </ul>"},{"location":"appendix/changelog/#mandatory-risk_type-column-for-ccf-determination","title":"Mandatory <code>risk_type</code> Column for CCF Determination","text":"<p>The <code>risk_type</code> column is now the authoritative source for CCF (Credit Conversion Factor) determination across all facility inputs:</p> <p>New Columns: - <code>risk_type</code> (mandatory) - Off-balance sheet risk category: FR, MR, MLR, LR - <code>ccf_modelled</code> (optional) - A-IRB modelled CCF estimate (0.0-1.5, Retail IRB can exceed 100%) - <code>is_short_term_trade_lc</code> (optional) - CRR Art. 166(9) exception flag</p> <p>Risk Type Values (CRR Art. 111):</p> Code SA CCF F-IRB CCF Description FR 100% 100% Full risk - guarantees, credit substitutes MR 50% 75% Medium risk - NIFs, RUFs, committed undrawn MLR 20% 75% Medium-low risk - documentary credits, trade LR 0% 0% Low risk - unconditionally cancellable <p>F-IRB Rules: - CRR Art. 166(8): MR and MLR both become 75% CCF under F-IRB - CRR Art. 166(9): Short-term trade LCs for goods movement retain 20% (set <code>is_short_term_trade_lc=True</code>)</p> <p>A-IRB Support: - When <code>ccf_modelled</code> is provided and approach is A-IRB, this value takes precedence</p>"},{"location":"appendix/changelog/#removed","title":"Removed","text":""},{"location":"appendix/changelog/#commitment_type-column-and-legacy-ccf-functions","title":"<code>commitment_type</code> Column and Legacy CCF Functions","text":"<p>The following have been removed as <code>risk_type</code> is now the authoritative CCF source:</p> <p>Removed from schemas: - <code>commitment_type</code> column from FACILITY_SCHEMA and all intermediate schemas</p> <p>Removed from <code>crr_ccf.py</code>: - <code>lookup_ccf()</code> function - <code>lookup_firb_ccf()</code> function - <code>calculate_ead_off_balance_sheet()</code> function - <code>create_ccf_type_mapping_df()</code> function</p> <p>Removed from <code>ccf.py</code>: - <code>calculate_single_ccf()</code> method - <code>CCFResult</code> dataclass</p> <p>Migration: Replace <code>commitment_type</code> with <code>risk_type</code>: - <code>unconditionally_cancellable</code> \u2192 <code>LR</code> (low_risk) - <code>committed_other</code> \u2192 <code>MR</code> (medium_risk) or <code>MLR</code> (medium_low_risk)</p>"},{"location":"appendix/changelog/#fx-conversion-support-14-new-tests","title":"FX Conversion Support (14 new tests)","text":"<p>Multi-currency portfolio support with configurable FX conversion:</p> <p>FXConverter Module (<code>src/rwa_calc/engine/fx_converter.py</code>) - <code>convert_exposures()</code> - Converts drawn, undrawn, and nominal amounts - <code>convert_collateral()</code> - Converts market and nominal values - <code>convert_guarantees()</code> - Converts covered amounts - <code>convert_provisions()</code> - Converts provision amounts - Factory function <code>create_fx_converter()</code></p> <p>Features: - Configurable target currency via <code>CalculationConfig.base_currency</code> - Enable/disable via <code>CalculationConfig.apply_fx_conversion</code> - Full audit trail: <code>original_currency</code>, <code>original_amount</code>, <code>fx_rate_applied</code> - Graceful handling of missing FX rates (values unchanged, rate = null) - Early pipeline integration (HierarchyResolver) for consistent threshold calculations</p> <p>Data Support: - New <code>FX_RATES_SCHEMA</code> in <code>src/rwa_calc/data/schemas.py</code> - <code>fx_rates</code> field added to <code>RawDataBundle</code> - <code>fx_rates_file</code> config in <code>DataSourceConfig</code> - Test fixtures in <code>tests/fixtures/fx_rates/</code></p> <p>Tests: - 14 unit tests covering all conversion scenarios - Tests for exposure, collateral, guarantee, and provision conversion - Multi-currency batch conversion tests - Alternative base currency tests (EUR, USD)</p>"},{"location":"appendix/changelog/#polars-namespace-extensions-8-namespaces-139-new-tests","title":"Polars Namespace Extensions (8 namespaces, 139 new tests)","text":"<p>The calculator now provides comprehensive Polars namespace extensions for fluent, chainable calculations across all approaches:</p> <p>SA Namespace (<code>lf.sa</code>, <code>expr.sa</code>) - <code>SALazyFrame</code> namespace for Standardised Approach calculations - Methods: <code>prepare_columns</code>, <code>apply_risk_weights</code>, <code>apply_residential_mortgage_rw</code>, <code>apply_cqs_based_rw</code>, <code>calculate_rwa</code>, <code>apply_supporting_factors</code>, <code>apply_all</code> - UK deviation handling for institution CQS 2 (30% vs 50%) - 29 unit tests</p> <p>IRB Namespace (<code>lf.irb</code>, <code>expr.irb</code>) - <code>IRBLazyFrame</code> namespace for IRB calculations - Methods: <code>classify_approach</code>, <code>apply_firb_lgd</code>, <code>prepare_columns</code>, <code>apply_pd_floor</code>, <code>apply_lgd_floor</code>, <code>calculate_correlation</code>, <code>calculate_k</code>, <code>calculate_maturity_adjustment</code>, <code>calculate_rwa</code>, <code>calculate_expected_loss</code>, <code>apply_all_formulas</code> - Expression methods: <code>floor_pd</code>, <code>floor_lgd</code>, <code>clip_maturity</code> - 33 unit tests</p> <p>CRM Namespace (<code>lf.crm</code>) - <code>CRMLazyFrame</code> namespace for EAD waterfall processing - Methods: <code>initialize_ead_waterfall</code>, <code>apply_collateral</code>, <code>apply_guarantees</code>, <code>apply_provisions</code>, <code>finalize_ead</code>, <code>apply_all_crm</code> - SA vs IRB treatment differences handled automatically - 20 unit tests</p> <p>Haircuts Namespace (<code>lf.haircuts</code>) - <code>HaircutsLazyFrame</code> namespace for collateral haircut calculations - Methods: <code>classify_maturity_band</code>, <code>apply_collateral_haircuts</code>, <code>apply_fx_haircut</code>, <code>apply_maturity_mismatch</code>, <code>calculate_adjusted_value</code>, <code>apply_all_haircuts</code> - CRR Article 224 supervisory haircuts - 24 unit tests</p> <p>Slotting Namespace (<code>lf.slotting</code>, <code>expr.slotting</code>) - <code>SlottingLazyFrame</code> namespace for specialised lending - Methods: <code>prepare_columns</code>, <code>apply_slotting_weights</code>, <code>calculate_rwa</code>, <code>apply_all</code> - CRR vs Basel 3.1 risk weight differences - HVCRE treatment - 26 unit tests</p> <p>Hierarchy Namespace (<code>lf.hierarchy</code>) - <code>HierarchyLazyFrame</code> namespace for hierarchy resolution - Methods: <code>resolve_ultimate_parent</code>, <code>calculate_hierarchy_depth</code>, <code>inherit_ratings</code>, <code>coalesce_ratings</code>, <code>calculate_lending_group_totals</code>, <code>add_lending_group_reference</code>, <code>add_collateral_ltv</code> - Pure LazyFrame join-based traversal (no Python recursion) - 13 unit tests</p> <p>Aggregator Namespace (<code>lf.aggregator</code>) - <code>AggregatorLazyFrame</code> namespace for result combination - Methods: <code>combine_approach_results</code>, <code>apply_output_floor</code>, <code>calculate_floor_impact</code>, <code>generate_summary_by_class</code>, <code>generate_summary_by_approach</code>, <code>generate_supporting_factor_impact</code> - Basel 3.1 output floor support - 12 unit tests</p> <p>Audit Namespace (<code>lf.audit</code>, <code>expr.audit</code>) - <code>AuditLazyFrame</code> namespace for audit trail generation - Methods: <code>build_sa_calculation</code>, <code>build_irb_calculation</code>, <code>build_slotting_calculation</code>, <code>build_crm_calculation</code>, <code>build_haircut_calculation</code>, <code>build_floor_calculation</code> - <code>AuditExpr</code> namespace for column formatting: <code>format_currency</code>, <code>format_percent</code>, <code>format_ratio</code>, <code>format_bps</code> - 15 unit tests</p>"},{"location":"appendix/changelog/#changed_7","title":"Changed","text":"<ul> <li>All calculators can now use namespace-based fluent APIs</li> <li>Improved code readability with chainable method calls</li> <li>Test count increased from 635 to 826 (139 namespace tests + 14 FX converter tests + 38 other tests)</li> </ul>"},{"location":"appendix/changelog/#planned","title":"Planned","text":"<ul> <li>Basel 3.1 full implementation</li> <li>Differentiated PD floors</li> <li>A-IRB LGD floors</li> <li>Revised SA real estate risk weights</li> </ul>"},{"location":"appendix/changelog/#012-2025-01-24","title":"[0.1.2] - 2025-01-24","text":""},{"location":"appendix/changelog/#added_19","title":"Added","text":""},{"location":"appendix/changelog/#interactive-ui-console-command","title":"Interactive UI Console Command","text":"<ul> <li>New <code>rwa-calc-ui</code> console script for starting the UI server when installed from PyPI</li> <li><code>main()</code> function added to <code>server.py</code> for entry point</li> </ul>"},{"location":"appendix/changelog/#documentation-improvements","title":"Documentation Improvements","text":"<ul> <li>New <code>docs/user-guide/interactive-ui.md</code> - comprehensive UI guide with prerequisites, all three apps, troubleshooting</li> <li>Updated quickstart with \"Choose Your Approach\" section (UI vs Python API)</li> <li>Added Interactive UI to user guide navigation and recommendations</li> <li>Updated all server startup commands to show both PyPI and source installation methods</li> </ul>"},{"location":"appendix/changelog/#changed_8","title":"Changed","text":"<ul> <li>Installation instructions clarified for PyPI vs source installations</li> <li>UI documentation moved from Development section to User Guide for better discoverability</li> </ul>"},{"location":"appendix/changelog/#011-2025-01-22","title":"[0.1.1] - 2025-01-22","text":""},{"location":"appendix/changelog/#added_20","title":"Added","text":"<ul> <li>FX conversion support for multi-currency portfolios</li> <li>Polars namespace extensions (8 namespaces)</li> <li>Retail classification flag (<code>cp_is_managed_as_retail</code>)</li> </ul>"},{"location":"appendix/changelog/#010-2025-01-18","title":"[0.1.0] - 2025-01-18","text":""},{"location":"appendix/changelog/#added_21","title":"Added","text":""},{"location":"appendix/changelog/#core-framework","title":"Core Framework","text":"<ul> <li>Dual-framework support (CRR and Basel 3.1 configuration)</li> <li>Pipeline architecture with discrete processing stages</li> <li>Protocol-based component interfaces</li> <li>Immutable data contracts (bundles)</li> </ul>"},{"location":"appendix/changelog/#data-loading","title":"Data Loading","text":"<ul> <li>Parquet file loader</li> <li>Schema validation</li> <li>Optional file handling</li> <li>Metadata tracking</li> </ul>"},{"location":"appendix/changelog/#hierarchy-resolution","title":"Hierarchy Resolution","text":"<ul> <li>Counterparty hierarchy resolution (up to 10 levels)</li> <li>Rating inheritance from parent</li> <li>Lending group aggregation</li> <li>LazyFrame-based join optimization</li> </ul>"},{"location":"appendix/changelog/#classification","title":"Classification","text":"<ul> <li>All exposure classes supported</li> <li>Approach determination (SA/F-IRB/A-IRB/Slotting)</li> <li>SME identification</li> <li>Retail eligibility checking</li> <li>EAD calculation with CCFs</li> </ul>"},{"location":"appendix/changelog/#standardised-approach","title":"Standardised Approach","text":"<ul> <li>Complete risk weight tables</li> <li>Sovereign, Institution, Corporate, Retail classes</li> <li>Real estate treatments</li> <li>Defaulted exposure handling</li> </ul>"},{"location":"appendix/changelog/#irb-approach","title":"IRB Approach","text":"<ul> <li>K formula implementation</li> <li>Asset correlation with SME adjustment</li> <li>Maturity adjustment</li> <li>PD and LGD floors</li> <li>Expected loss calculation</li> <li>1.06 scaling factor (CRR)</li> </ul>"},{"location":"appendix/changelog/#slotting-approach","title":"Slotting Approach","text":"<ul> <li>All specialised lending types</li> <li>Category-based risk weights</li> <li>HVCRE treatment</li> <li>Pre-operational project finance</li> </ul>"},{"location":"appendix/changelog/#credit-risk-mitigation","title":"Credit Risk Mitigation","text":"<ul> <li>Financial collateral (comprehensive method)</li> <li>Supervisory haircuts</li> <li>Currency mismatch handling</li> <li>Guarantees (substitution approach)</li> <li>Maturity mismatch adjustment</li> <li>Provision allocation</li> </ul>"},{"location":"appendix/changelog/#supporting-factors-crr","title":"Supporting Factors (CRR)","text":"<ul> <li>SME supporting factor (tiered calculation)</li> <li>Infrastructure factor</li> </ul>"},{"location":"appendix/changelog/#output","title":"Output","text":"<ul> <li>Aggregated results</li> <li>Breakdown by approach/class/counterparty</li> <li>Export to Parquet/CSV/JSON</li> <li>Error accumulation and reporting</li> </ul>"},{"location":"appendix/changelog/#configuration","title":"Configuration","text":"<ul> <li>Factory methods (crr/basel_3_1)</li> <li>EUR/GBP rate configuration</li> <li>Configurable supporting factors</li> <li>PD floor configuration</li> </ul>"},{"location":"appendix/changelog/#testing","title":"Testing","text":"<ul> <li>468+ test cases</li> <li>Unit tests for all components</li> <li>Contract tests for interfaces</li> <li>Acceptance test framework</li> <li>Test fixtures generation</li> </ul>"},{"location":"appendix/changelog/#documentation","title":"Documentation","text":"<ul> <li>MkDocs with Material theme</li> <li>User guide for all audiences</li> <li>API reference</li> <li>Architecture documentation</li> <li>Development guide</li> </ul>"},{"location":"appendix/changelog/#technical","title":"Technical","text":"<ul> <li>Python 3.13+ support</li> <li>Polars LazyFrame optimization</li> <li>Pydantic validation</li> <li>Type hints throughout</li> <li>Ruff formatting/linting</li> </ul>"},{"location":"appendix/changelog/#version-history","title":"Version History","text":"Version Date Status 0.1.21 2026-02-16 Current 0.1.20 2026-02-14 Previous 0.1.19 2026-02-11 - 0.1.18 2026-02-10 - 0.1.17 2026-02-10 - 0.1.16 2026-02-09 - 0.1.15 2026-02-08 - 0.1.14 2026-02-07 - 0.1.13 2026-02-07 - 0.1.12 2026-02-02 - 0.1.11 2026-01-28 - 0.1.10 2026-01-28 - 0.1.8 2026-01-28 - 0.1.7 2026-01-27 - 0.1.6 2026-01-25 - 0.1.5 2026-01-25 - 0.1.4 2026-01-25 - 0.1.3 2025-01-24 - 0.1.2 2025-01-24 - 0.1.1 2025-01-22 - 0.1.0 2025-01-18 Initial"},{"location":"appendix/changelog/#migration-notes","title":"Migration Notes","text":""},{"location":"appendix/changelog/#from-previous-versions","title":"From Previous Versions","text":"<p>This is the initial release. No migration required.</p>"},{"location":"appendix/changelog/#crr-to-basel-31","title":"CRR to Basel 3.1","text":"<p>When transitioning calculations from CRR to Basel 3.1:</p> <ol> <li> <p>Update configuration: <pre><code># Before (CRR)\nconfig = CalculationConfig.crr(date(2026, 12, 31))\n\n# After (Basel 3.1)\nconfig = CalculationConfig.basel_3_1(date(2027, 1, 1))\n</code></pre></p> </li> <li> <p>Review impacted exposures:</p> </li> <li>SME exposures (factor removal)</li> <li>Infrastructure exposures (factor removal)</li> <li> <p>Low-risk IRB portfolios (output floor)</p> </li> <li> <p>Update data requirements:</p> </li> <li>LTV data for Basel 3.1 real estate weights</li> <li>Transactor/revolver flags for QRRE</li> </ol>"},{"location":"appendix/changelog/#deprecation-notices","title":"Deprecation Notices","text":""},{"location":"appendix/changelog/#crr-specific-features-end-of-2026","title":"CRR-Specific Features (End of 2026)","text":"<p>The following CRR-specific features will be removed from active use after December 2026:</p> <ul> <li>SME supporting factor</li> <li>Infrastructure supporting factor</li> <li>1.06 scaling factor</li> </ul> <p>These will remain available for historical calculations and comparison.</p>"},{"location":"appendix/changelog/#contributing","title":"Contributing","text":"<p>See Development Guide for contribution guidelines.</p>"},{"location":"appendix/changelog/#support","title":"Support","text":"<p>For issues and feature requests, please use the project's issue tracker.</p>"},{"location":"appendix/glossary/","title":"Glossary","text":"<p>This glossary provides definitions for key terms used throughout the documentation.</p>"},{"location":"appendix/glossary/#a","title":"A","text":""},{"location":"appendix/glossary/#a-irb-advanced-internal-ratings-based","title":"A-IRB (Advanced Internal Ratings-Based)","text":"<p>An IRB approach where the bank estimates PD, LGD, and EAD using internal models, subject to regulatory floors and approval.</p>"},{"location":"appendix/glossary/#asset-correlation","title":"Asset Correlation","text":"<p>A measure of how closely the value of an asset moves with systematic risk factors. Higher correlation means more sensitivity to economic conditions.</p>"},{"location":"appendix/glossary/#b","title":"B","text":""},{"location":"appendix/glossary/#basel-30","title":"Basel 3.0","text":"<p>The international regulatory framework for banks implemented through CRR in the UK. Effective until December 2026.</p>"},{"location":"appendix/glossary/#basel-31","title":"Basel 3.1","text":"<p>The revised Basel framework implemented through PRA PS9/24, effective from January 2027. Introduces output floors, removes supporting factors.</p>"},{"location":"appendix/glossary/#bcbs","title":"BCBS","text":"<p>Basel Committee on Banking Supervision. The international body that develops banking standards.</p>"},{"location":"appendix/glossary/#c","title":"C","text":""},{"location":"appendix/glossary/#capital-requirement","title":"Capital Requirement","text":"<p>The minimum amount of capital a bank must hold against its risk exposures. Calculated as RWA \u00d7 Capital Ratio.</p>"},{"location":"appendix/glossary/#ccf-credit-conversion-factor","title":"CCF (Credit Conversion Factor)","text":"<p>A percentage applied to off-balance sheet exposures to convert them to on-balance sheet equivalents for capital calculation.</p>"},{"location":"appendix/glossary/#cqs-credit-quality-step","title":"CQS (Credit Quality Step)","text":"<p>A standardized credit quality scale (1-6) used to map external credit ratings to risk weights.</p>"},{"location":"appendix/glossary/#cre-credit-risk-real-estate","title":"CRE (Credit Risk - Real Estate)","text":"<p>Basel Committee standards for credit risk treatment of real estate exposures.</p>"},{"location":"appendix/glossary/#crm-credit-risk-mitigation","title":"CRM (Credit Risk Mitigation)","text":"<p>Techniques used to reduce credit risk exposure, including collateral, guarantees, and provisions.</p>"},{"location":"appendix/glossary/#crr-capital-requirements-regulation","title":"CRR (Capital Requirements Regulation)","text":"<p>EU regulation 575/2013 as onshored into UK law. The primary regulatory framework for credit risk capital.</p>"},{"location":"appendix/glossary/#d","title":"D","text":""},{"location":"appendix/glossary/#default","title":"Default","text":"<p>An event where a counterparty fails to meet its credit obligations. Defined as 90+ days past due or unlikely to pay.</p>"},{"location":"appendix/glossary/#dpd-days-past-due","title":"DPD (Days Past Due)","text":"<p>The number of days a payment is overdue.</p>"},{"location":"appendix/glossary/#e","title":"E","text":""},{"location":"appendix/glossary/#ead-exposure-at-default","title":"EAD (Exposure at Default)","text":"<p>The expected exposure amount at the time of default. For on-balance sheet items, typically the gross carrying amount. For off-balance sheet: <code>EAD = Drawn + (Undrawn x CCF)</code>.</p>"},{"location":"appendix/glossary/#equity-exposure","title":"Equity Exposure","text":"<p>Holdings of equity instruments (shares, funds) receiving dedicated risk weight treatment under CRR Art. 133 (SA) or Art. 155 (IRB Simple).</p>"},{"location":"appendix/glossary/#ecra-external-credit-risk-assessment-approach","title":"ECRA (External Credit Risk Assessment Approach)","text":"<p>Basel 3.1 approach for institutions using external ratings.</p>"},{"location":"appendix/glossary/#el-expected-loss","title":"EL (Expected Loss)","text":"<p>The anticipated loss on a portfolio. Calculated as PD \u00d7 LGD \u00d7 EAD.</p>"},{"location":"appendix/glossary/#exposure-class","title":"Exposure Class","text":"<p>A regulatory classification of exposures (Central Govt / Central Bank, Institution, Corporate, Retail, etc.) that determines applicable risk weights.</p>"},{"location":"appendix/glossary/#f","title":"F","text":""},{"location":"appendix/glossary/#f-irb-foundation-internal-ratings-based","title":"F-IRB (Foundation Internal Ratings-Based)","text":"<p>An IRB approach where the bank estimates PD but uses supervisory values for LGD and CCF.</p>"},{"location":"appendix/glossary/#fi-scalar","title":"FI Scalar","text":"<p>A 1.25x multiplier applied to the IRB capital requirement for large or unregulated financial sector entities (CRR Art. 153(2)).</p>"},{"location":"appendix/glossary/#financial-collateral","title":"Financial Collateral","text":"<p>Liquid assets (cash, bonds, equity) used as security for credit exposures.</p>"},{"location":"appendix/glossary/#fx-mismatch-haircut","title":"FX Mismatch Haircut","text":"<p>An 8% additional haircut applied when collateral currency differs from exposure currency (CRR Art. 233).</p>"},{"location":"appendix/glossary/#g","title":"G","text":""},{"location":"appendix/glossary/#gcra-general-credit-risk-adjustment","title":"GCRA (General Credit Risk Adjustment)","text":"<p>General provisions not allocated to specific exposures. May be included in Tier 2 capital.</p>"},{"location":"appendix/glossary/#guarantee","title":"Guarantee","text":"<p>Credit protection provided by a third party. Allows substitution of the guarantor's risk weight.</p>"},{"location":"appendix/glossary/#h","title":"H","text":""},{"location":"appendix/glossary/#haircut","title":"Haircut","text":"<p>A percentage reduction applied to collateral value to account for potential price volatility and liquidation costs.</p>"},{"location":"appendix/glossary/#hvcre-high-volatility-commercial-real-estate","title":"HVCRE (High Volatility Commercial Real Estate)","text":"<p>Speculative commercial real estate development with higher risk weights.</p>"},{"location":"appendix/glossary/#i","title":"I","text":""},{"location":"appendix/glossary/#ifrs-9","title":"IFRS 9","text":"<p>International accounting standard for financial instruments, including impairment (ECL) requirements.</p>"},{"location":"appendix/glossary/#infrastructure-factor","title":"Infrastructure Factor","text":"<p>CRR capital relief factor (0.75) for qualifying infrastructure project finance. Removed under Basel 3.1.</p>"},{"location":"appendix/glossary/#ipre-income-producing-real-estate","title":"IPRE (Income-Producing Real Estate)","text":"<p>Real estate generating rental or sale income. Receives specialised treatment under slotting approach.</p>"},{"location":"appendix/glossary/#irb-internal-ratings-based","title":"IRB (Internal Ratings-Based)","text":"<p>Approaches allowing banks to use internal risk estimates for capital calculation, subject to regulatory approval.</p>"},{"location":"appendix/glossary/#k","title":"K","text":""},{"location":"appendix/glossary/#k-capital-requirement","title":"K (Capital Requirement)","text":"<p>The IRB formula output representing the capital requirement as a percentage of EAD.</p>"},{"location":"appendix/glossary/#l","title":"L","text":""},{"location":"appendix/glossary/#lazyframe","title":"LazyFrame","text":"<p>A Polars data structure representing deferred (lazy) computations on data, enabling query optimization.</p>"},{"location":"appendix/glossary/#lgd-loss-given-default","title":"LGD (Loss Given Default)","text":"<p>The percentage of exposure lost if default occurs, after accounting for recoveries.</p>"},{"location":"appendix/glossary/#ltv-loan-to-value","title":"LTV (Loan-to-Value)","text":"<p>The ratio of a loan amount to the value of the underlying collateral (typically property).</p>"},{"location":"appendix/glossary/#m","title":"M","text":""},{"location":"appendix/glossary/#ma-maturity-adjustment","title":"MA (Maturity Adjustment)","text":"<p>An adjustment factor in the IRB formula accounting for increased risk of longer-dated exposures.</p>"},{"location":"appendix/glossary/#mdb-multilateral-development-bank","title":"MDB (Multilateral Development Bank)","text":"<p>International financial institutions (World Bank, EIB, etc.) that may receive preferential risk weights.</p>"},{"location":"appendix/glossary/#o","title":"O","text":""},{"location":"appendix/glossary/#overcollateralisation","title":"Overcollateralisation","text":"<p>The requirement that non-financial collateral must exceed the exposure value by a regulatory ratio to receive full CRM benefit. Ratios: financial 1.0x, receivables 1.25x, real estate/other physical 1.4x (CRR Art. 230).</p>"},{"location":"appendix/glossary/#output-floor","title":"Output Floor","text":"<p>Basel 3.1 requirement that IRB RWA cannot fall below 72.5% of the equivalent SA RWA.</p>"},{"location":"appendix/glossary/#p","title":"P","text":""},{"location":"appendix/glossary/#pd-probability-of-default","title":"PD (Probability of Default)","text":"<p>The likelihood that a counterparty will default within one year. Range: 0% to 100%.</p>"},{"location":"appendix/glossary/#pra-prudential-regulation-authority","title":"PRA (Prudential Regulation Authority)","text":"<p>The UK banking regulator responsible for implementing Basel standards.</p>"},{"location":"appendix/glossary/#pse-public-sector-entity","title":"PSE (Public Sector Entity)","text":"<p>Non-commercial government bodies that may receive preferential treatment.</p>"},{"location":"appendix/glossary/#q","title":"Q","text":""},{"location":"appendix/glossary/#qrre-qualifying-revolving-retail-exposures","title":"QRRE (Qualifying Revolving Retail Exposures)","text":"<p>Unsecured revolving credit to individuals (credit cards, overdrafts) meeting specific criteria.</p>"},{"location":"appendix/glossary/#r","title":"R","text":""},{"location":"appendix/glossary/#rgla-regional-government-and-local-authority","title":"RGLA (Regional Government and Local Authority)","text":"<p>Sub-national government entities with varying risk treatments.</p>"},{"location":"appendix/glossary/#risk-type","title":"Risk Type","text":"<p>A classification for off-balance sheet exposures that determines the applicable CCF. Valid values: FR (full_risk, 100%), MR (medium_risk, 50%/75%), MLR (medium_low_risk, 20%/75%), LR (low_risk, 0%). See CRR Art. 111.</p>"},{"location":"appendix/glossary/#risk-weight","title":"Risk Weight","text":"<p>A percentage applied to EAD to calculate RWA. Higher risk weights indicate higher risk.</p>"},{"location":"appendix/glossary/#rwa-risk-weighted-assets","title":"RWA (Risk-Weighted Assets)","text":"<p>Assets adjusted for risk, used to calculate capital requirements. RWA = EAD \u00d7 Risk Weight.</p>"},{"location":"appendix/glossary/#s","title":"S","text":""},{"location":"appendix/glossary/#sa-standardised-approach","title":"SA (Standardised Approach)","text":"<p>A capital calculation approach using regulatory-prescribed risk weights based on external ratings.</p>"},{"location":"appendix/glossary/#scaling-factor","title":"Scaling Factor","text":"<p>CRR 1.06 multiplier applied to all IRB RWA. Removed under Basel 3.1.</p>"},{"location":"appendix/glossary/#scra-specific-credit-risk-adjustment","title":"SCRA (Specific Credit Risk Adjustment)","text":"<p>Provisions allocated to specific exposures. Reduces EAD for SA, compares to EL for IRB.</p>"},{"location":"appendix/glossary/#scra-standardised-credit-risk-assessment-approach","title":"SCRA (Standardised Credit Risk Assessment Approach)","text":"<p>Basel 3.1 approach for unrated institutions based on capital adequacy ratios.</p>"},{"location":"appendix/glossary/#slotting-approach","title":"Slotting Approach","text":"<p>A capital calculation method for specialised lending using supervisory categories (Strong/Good/Satisfactory/Weak).</p>"},{"location":"appendix/glossary/#sme-small-and-medium-enterprise","title":"SME (Small and Medium Enterprise)","text":"<p>Companies with turnover \u2264 EUR 50m qualifying for preferential treatment.</p>"},{"location":"appendix/glossary/#sme-supporting-factor","title":"SME Supporting Factor","text":"<p>CRR capital relief factor (0.7619/0.85) for SME exposures. Removed under Basel 3.1.</p>"},{"location":"appendix/glossary/#central-govt-central-bank-sovereign","title":"Central Govt / Central Bank (Sovereign)","text":"<p>Exposure to a government or central bank. The exposure class formerly known as \"Sovereign\".</p>"},{"location":"appendix/glossary/#specialised-lending","title":"Specialised Lending","text":"<p>Project finance, object finance, commodities finance, and real estate exposures with specific treatments.</p>"},{"location":"appendix/glossary/#t","title":"T","text":""},{"location":"appendix/glossary/#tier-1-capital","title":"Tier 1 Capital","text":"<p>High-quality capital including common equity (CET1) and additional Tier 1 instruments.</p>"},{"location":"appendix/glossary/#tier-2-capital","title":"Tier 2 Capital","text":"<p>Supplementary capital including subordinated debt and general provisions.</p>"},{"location":"appendix/glossary/#u","title":"U","text":""},{"location":"appendix/glossary/#unexpected-loss-ul","title":"Unexpected Loss (UL)","text":"<p>Losses above expected levels, covered by regulatory capital. UL = RWA \u00d7 8%.</p>"},{"location":"appendix/glossary/#key-formulas-reference","title":"Key Formulas Reference","text":"Formula Expression Reference SA RWA <code>EAD x RW x SF</code> CRR Art. 113 IRB RWA <code>K x 12.5 x EAD x MA x [1.06]</code> CRR Art. 153 IRB K <code>LGD x N[(1-R)^(-0.5) x G(PD) + (R/(1-R))^(0.5) x G(0.999)] - PD x LGD</code> CRR Art. 153 Corporate Correlation <code>0.12 x f(PD) + 0.24 x (1 - f(PD))</code> where <code>f(PD) = (1-e^(-50xPD))/(1-e^(-50))</code> CRR Art. 153 SME Adjustment <code>0.04 x (1 - (max(5,min(S,50)) - 5) / 45)</code> CRR Art. 153 Maturity Adjustment <code>(1 + (M-2.5) x b) / (1 - 1.5 x b)</code> where <code>b = (0.11852 - 0.05478 x ln(PD))^2</code> CRR Art. 153 Expected Loss <code>PD x LGD x EAD</code> CRR Art. 158 EAD (off-BS) <code>Drawn + Undrawn x CCF</code> CRR Art. 111, 166 Effectively Secured <code>Adjusted Collateral Value / Overcollateralisation Ratio</code> CRR Art. 230 Maturity Mismatch <code>(t - 0.25) / (T - 0.25)</code> CRR Art. 238 Output Floor <code>max(RWA_IRB, floor% x RWA_SA)</code> PRA PS9/24 SME SF (Blended) <code>[min(E,T) x 0.7619 + max(E-T,0) x 0.85] / E</code> CRR Art. 501"},{"location":"appendix/regulatory-references/","title":"Regulatory References","text":"<p>This page provides links to key regulatory documents and resources.</p>"},{"location":"appendix/regulatory-references/#uk-regulations","title":"UK Regulations","text":""},{"location":"appendix/regulatory-references/#pra-rulebook","title":"PRA Rulebook","text":"Document Description Link CRR Firms PRA rules for CRR-regulated firms prarulebook.co.uk"},{"location":"appendix/regulatory-references/#uk-crr","title":"UK CRR","text":"Document Description Link EU 575/2013 (Onshored) Capital Requirements Regulation legislation.gov.uk"},{"location":"appendix/regulatory-references/#basel-31-implementation","title":"Basel 3.1 Implementation","text":"Document Description Link PRA PS9/24 Basel 3.1 Near-Final Rules (Part 2) bankofengland.co.uk PRA CP16/22 Basel 3.1 Consultation Paper bankofengland.co.uk"},{"location":"appendix/regulatory-references/#basel-committee-standards","title":"Basel Committee Standards","text":""},{"location":"appendix/regulatory-references/#basel-framework","title":"Basel Framework","text":"Standard Description Link CRE Credit Risk Standards bis.org/CRE CRE20 Standardised Approach bis.org/CRE20 CRE21 Standardised - Risk Weights bis.org/CRE21 CRE22 Credit Risk Mitigation bis.org/CRE22 CRE30 IRB Overview bis.org/CRE30 CRE31 IRB Risk Weights bis.org/CRE31 CRE32 IRB Risk Components bis.org/CRE32 CRE33 Specialised Lending bis.org/CRE33 CRE99 Output Floor bis.org/CRE99"},{"location":"appendix/regulatory-references/#key-crr-articles","title":"Key CRR Articles","text":""},{"location":"appendix/regulatory-references/#exposure-classes","title":"Exposure Classes","text":"Article Topic Art. 112 Exposure class definitions Art. 114 Sovereign exposures Art. 115 Regional governments Art. 117 MDB exposures Art. 119-121 Institution exposures Art. 122 Corporate exposures Art. 123 Retail exposures Art. 124-125 Real estate exposures Art. 127 Defaulted exposures Art. 128 High risk items Art. 129 Covered bonds Art. 133 Equity exposures"},{"location":"appendix/regulatory-references/#risk-weights-and-ccf","title":"Risk Weights and CCF","text":"Article Topic Art. 111 Credit conversion factors Art. 113-134 Risk weight assignment"},{"location":"appendix/regulatory-references/#irb-approach","title":"IRB Approach","text":"Article Topic Art. 142-150 IRB overview Art. 153 K formula and risk weights Art. 154 Retail IRB Art. 161 Supervisory LGD Art. 162 Maturity Art. 178-180 PD estimation Art. 181 LGD estimation"},{"location":"appendix/regulatory-references/#credit-risk-mitigation","title":"Credit Risk Mitigation","text":"Article Topic Art. 192-194 CRM overview Art. 197-200 Financial collateral Art. 213-216 Guarantees Art. 224-227 Haircuts Art. 238-239 Maturity mismatch"},{"location":"appendix/regulatory-references/#supporting-factors","title":"Supporting Factors","text":"Article Topic Art. 501 SME supporting factor Art. 501a Infrastructure factor"},{"location":"appendix/regulatory-references/#reference-documents-project","title":"Reference Documents (Project)","text":"<p>The <code>ref_docs/</code> directory contains PDF copies of key regulatory documents:</p> File Document <code>pra_ps9_24.pdf</code> PRA PS9/24 <code>pra_cp16_22.pdf</code> PRA CP16/22 <code>bcbs_cre.pdf</code> BCBS CRE Standards <code>uk_crr.pdf</code> UK CRR Extract"},{"location":"appendix/regulatory-references/#rating-agency-mappings","title":"Rating Agency Mappings","text":""},{"location":"appendix/regulatory-references/#cqs-to-external-ratings","title":"CQS to External Ratings","text":"CQS S&amp;P Moody's Fitch 1 AAA to AA- Aaa to Aa3 AAA to AA- 2 A+ to A- A1 to A3 A+ to A- 3 BBB+ to BBB- Baa1 to Baa3 BBB+ to BBB- 4 BB+ to BB- Ba1 to Ba3 BB+ to BB- 5 B+ to B- B1 to B3 B+ to B- 6 CCC+ and below Caa1 and below CCC+ and below"},{"location":"appendix/regulatory-references/#additional-resources","title":"Additional Resources","text":""},{"location":"appendix/regulatory-references/#industry-guidance","title":"Industry Guidance","text":"Source Description UK Finance Industry body guidance ISDA Derivatives documentation LMA Loan market standards"},{"location":"appendix/regulatory-references/#academic-references","title":"Academic References","text":"Topic Key Papers IRB Formula Vasicek (1987), Gordy (2003) Correlation Lopez (2004) LGD Estimation Schuermann (2004)"},{"location":"appendix/regulatory-references/#useful-links","title":"Useful Links","text":"<ul> <li>PRA Publications</li> <li>Basel Committee</li> <li>UK Legislation</li> <li>EBA Publications</li> </ul>"},{"location":"architecture/","title":"Architecture Overview","text":"<p>This section provides detailed documentation of the RWA calculator's architecture for engineers and technical users.</p>"},{"location":"architecture/#design-philosophy","title":"Design Philosophy","text":"<p>The calculator is built on several key principles:</p>"},{"location":"architecture/#1-dual-framework-support","title":"1. Dual-Framework Support","text":"<p>A single codebase supports both CRR and Basel 3.1:</p> <pre><code>graph TD\n    A[Configuration] --&gt; B{Framework}\n    B --&gt;|CRR| C[CRR Parameters]\n    B --&gt;|Basel 3.1| D[Basel 3.1 Parameters]\n    C --&gt; E[Calculation Engine]\n    D --&gt; E\n    E --&gt; F[Results]</code></pre> <p>Framework differences are isolated to: - Configuration factories - Parameter lookups - Supporting factor application - Output floor calculation</p>"},{"location":"architecture/#2-pipeline-architecture","title":"2. Pipeline Architecture","text":"<p>Calculations flow through a well-defined pipeline:</p> <pre><code>flowchart LR\n    subgraph Input\n        A[Raw Data]\n    end\n\n    subgraph Processing\n        B[Loader]\n        C[Hierarchy]\n        D[Classifier]\n        E[CRM]\n    end\n\n    subgraph Calculation\n        F[SA]\n        G[IRB]\n        H[Slotting]\n    end\n\n    subgraph Output\n        I[Aggregator]\n        J[Results]\n    end\n\n    A --&gt; B --&gt; C --&gt; D --&gt; E\n    E --&gt; F &amp; G &amp; H\n    F &amp; G &amp; H --&gt; I --&gt; J</code></pre>"},{"location":"architecture/#3-protocol-based-interfaces","title":"3. Protocol-Based Interfaces","text":"<p>All components implement protocols for dependency injection:</p> <pre><code>from typing import Protocol\n\nclass CalculatorProtocol(Protocol):\n    def calculate(\n        self,\n        exposures: ClassifiedExposuresBundle,\n        config: CalculationConfig\n    ) -&gt; ResultBundle:\n        ...\n</code></pre>"},{"location":"architecture/#4-immutable-data-contracts","title":"4. Immutable Data Contracts","text":"<p>Data flows through immutable bundles:</p> <pre><code>@dataclass(frozen=True)\nclass RawDataBundle:\n    counterparties: pl.LazyFrame\n    facilities: pl.LazyFrame\n    loans: pl.LazyFrame\n    # ... immutable after creation\n</code></pre>"},{"location":"architecture/#5-lazyframe-optimization","title":"5. LazyFrame Optimization","text":"<p>All processing uses Polars LazyFrames for performance:</p> <pre><code># Deferred execution\nresult = (\n    df\n    .filter(pl.col(\"exposure_class\") == \"CORPORATE\")\n    .with_columns(rwa=pl.col(\"ead\") * pl.col(\"risk_weight\"))\n    .group_by(\"counterparty_id\")\n    .agg(pl.col(\"rwa\").sum())\n)  # Not executed yet\n\n# Execute when needed\nmaterialized = result.collect()\n</code></pre>"},{"location":"architecture/#architecture-sections","title":"Architecture Sections","text":"<ul> <li>Design Principles - Core architectural decisions</li> <li>Pipeline Architecture - Detailed pipeline documentation</li> <li>Data Flow - How data moves through the system</li> <li>Component Overview - Individual component documentation</li> </ul>"},{"location":"architecture/#high-level-structure","title":"High-Level Structure","text":"<pre><code>src/rwa_calc/\n\u251c\u2500\u2500 api/                    # API layer\n\u2502   \u251c\u2500\u2500 models.py          # API request/response models\n\u2502   \u251c\u2500\u2500 service.py         # Service layer\n\u2502   \u251c\u2500\u2500 validation.py      # API validation\n\u2502   \u2514\u2500\u2500 formatters.py      # Output formatting\n\u251c\u2500\u2500 config/                 # Configuration\n\u2502   \u251c\u2500\u2500 fx_rates.py        # FX rate configuration\n\u2502   \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 contracts/              # Interfaces and data contracts\n\u2502   \u251c\u2500\u2500 bundles.py         # Data transfer objects\n\u2502   \u251c\u2500\u2500 config.py          # Configuration classes\n\u2502   \u251c\u2500\u2500 errors.py          # Error handling\n\u2502   \u251c\u2500\u2500 protocols.py       # Component interfaces\n\u2502   \u2514\u2500\u2500 validation.py      # Schema validation\n\u251c\u2500\u2500 data/                   # Schemas and regulatory tables\n\u2502   \u251c\u2500\u2500 schemas.py         # Polars schemas\n\u2502   \u2514\u2500\u2500 tables/            # Lookup tables (risk weights, CCFs, haircuts)\n\u251c\u2500\u2500 domain/                 # Core domain\n\u2502   \u2514\u2500\u2500 enums.py           # Enumerations\n\u251c\u2500\u2500 ui/                     # User interface\n\u2502   \u2514\u2500\u2500 marimo/            # Marimo web applications\n\u2514\u2500\u2500 engine/                 # Calculation engine\n    \u251c\u2500\u2500 pipeline.py        # Pipeline orchestration\n    \u251c\u2500\u2500 loader.py          # Data loading\n    \u251c\u2500\u2500 hierarchy.py       # Hierarchy resolution\n    \u251c\u2500\u2500 classifier.py      # Exposure classification\n    \u251c\u2500\u2500 ccf.py             # Credit conversion factors\n    \u251c\u2500\u2500 aggregator.py      # Result aggregation\n    \u251c\u2500\u2500 fx_converter.py    # FX conversion\n    \u251c\u2500\u2500 crm/               # Credit risk mitigation\n    \u251c\u2500\u2500 sa/                # Standardised approach\n    \u251c\u2500\u2500 irb/               # IRB approach\n    \u251c\u2500\u2500 slotting/          # Slotting approach\n    \u2514\u2500\u2500 equity/            # Equity approach\n</code></pre>"},{"location":"architecture/#key-patterns","title":"Key Patterns","text":""},{"location":"architecture/#factory-method","title":"Factory Method","text":"<p>Configuration uses factory methods for clarity:</p> <pre><code># Clear framework intent\nconfig = CalculationConfig.crr(date(2026, 12, 31))\nconfig = CalculationConfig.basel_3_1(date(2027, 1, 1))\n</code></pre>"},{"location":"architecture/#strategy-pattern","title":"Strategy Pattern","text":"<p>Different approaches implement a common interface:</p> <pre><code># All calculators implement CalculatorProtocol\nsa_calculator = SACalculator()\nirb_calculator = IRBCalculator()\nslotting_calculator = SlottingCalculator()\n\n# Used interchangeably\nfor calculator in [sa_calculator, irb_calculator, slotting_calculator]:\n    result = calculator.calculate(exposures, config)\n</code></pre>"},{"location":"architecture/#builder-pattern","title":"Builder Pattern","text":"<p>Complex objects built incrementally:</p> <pre><code>result = (\n    ResultBuilder()\n    .add_sa_results(sa_results)\n    .add_irb_results(irb_results)\n    .add_slotting_results(slotting_results)\n    .with_config(config)\n    .build()\n)\n</code></pre>"},{"location":"architecture/#error-accumulation","title":"Error Accumulation","text":"<p>Errors collected without exceptions:</p> <pre><code># Errors accumulated, not thrown\nresult = LazyFrameResult(\n    data=processed_df,\n    errors=[\n        CalculationError(exposure_id=\"E001\", message=\"Missing PD\"),\n        CalculationError(exposure_id=\"E002\", message=\"Invalid LGD\"),\n    ]\n)\n\n# All exposures processed, errors reported at end\n</code></pre>"},{"location":"architecture/#performance-characteristics","title":"Performance Characteristics","text":""},{"location":"architecture/#lazyframe-benefits","title":"LazyFrame Benefits","text":"Operation DataFrame LazyFrame Memory Eager allocation On-demand Execution Immediate Deferred Optimization Manual Automatic Parallelism Limited Full"},{"location":"architecture/#benchmark-results","title":"Benchmark Results","text":"<p>For typical portfolio sizes (full RWA pipeline with pure Polars IRB):</p> Exposures LazyFrame DataFrame Speedup 10,000 0.05s 0.5s 10x 100,000 0.15s 5.2s 35x 1,000,000 0.5s 45s 90x <p>IRB formula calculation alone achieves 3.4M rows/second throughput using <code>polars-normal-stats</code>.</p>"},{"location":"architecture/#technology-stack","title":"Technology Stack","text":"Component Technology Purpose Data Processing Polars High-performance DataFrames Validation Pydantic Type-safe data validation Numerics polars-normal-stats IRB formulas (pure Polars) Testing Pytest Comprehensive testing Documentation MkDocs This documentation"},{"location":"architecture/#next-steps","title":"Next Steps","text":"<ul> <li>Design Principles - Understand architectural decisions</li> <li>Pipeline Architecture - Detailed pipeline documentation</li> <li>API Reference - Component API documentation</li> </ul>"},{"location":"architecture/components/","title":"Component Overview","text":"<p>This document provides detailed documentation of each component in the RWA calculator.</p>"},{"location":"architecture/components/#component-summary","title":"Component Summary","text":"Component Module Purpose Loader <code>engine/loader.py</code> Load data from files Hierarchy Resolver <code>engine/hierarchy.py</code> Resolve hierarchies Classifier <code>engine/classifier.py</code> Classify exposures CRM Processor <code>engine/crm/processor.py</code> Apply CRM SA Calculator <code>engine/sa/calculator.py</code> Standardised RWA IRB Calculator <code>engine/irb/calculator.py</code> IRB RWA Slotting Calculator <code>engine/slotting/calculator.py</code> Slotting RWA Equity Calculator <code>engine/equity/calculator.py</code> Equity RWA Aggregator <code>engine/aggregator.py</code> Combine results"},{"location":"architecture/components/#polars-namespace-extensions","title":"Polars Namespace Extensions","text":"<p>The calculator uses Polars namespace extensions to provide fluent, chainable APIs for calculations. Each namespace is registered when its module is imported.</p> Namespace Module Description <code>lf.sa</code> <code>engine/sa/namespace.py</code> SA risk weights, RWA, supporting factors <code>lf.irb</code> <code>engine/irb/namespace.py</code> IRB formulas, K calculation, floors <code>lf.crm</code> <code>engine/crm/namespace.py</code> EAD waterfall, collateral, guarantees <code>lf.haircuts</code> <code>engine/crm/haircuts_namespace.py</code> Supervisory haircuts, FX/maturity mismatch <code>lf.slotting</code> <code>engine/slotting/namespace.py</code> Slotting risk weights <code>lf.hierarchy</code> <code>engine/hierarchy_namespace.py</code> Parent resolution, rating inheritance <code>lf.aggregator</code> <code>engine/aggregator_namespace.py</code> Result combination, output floor <code>lf.audit</code> <code>engine/audit_namespace.py</code> Audit trail formatting <code>expr.audit</code> <code>engine/audit_namespace.py</code> Column formatting (currency, %, bps) <p>All namespaces are automatically registered when importing from <code>rwa_calc.engine</code>:</p> <pre><code>from rwa_calc.engine import (\n    SALazyFrame, IRBLazyFrame, CRMLazyFrame,\n    HaircutsLazyFrame, SlottingLazyFrame,\n    HierarchyLazyFrame, AggregatorLazyFrame,\n    AuditLazyFrame, AuditExpr,\n)\n</code></pre>"},{"location":"architecture/components/#loader","title":"Loader","text":""},{"location":"architecture/components/#purpose","title":"Purpose","text":"<p>Load raw data from Parquet or CSV files into LazyFrames.</p>"},{"location":"architecture/components/#interface","title":"Interface","text":"<pre><code>class LoaderProtocol(Protocol):\n    def load(self, path: Path) -&gt; RawDataBundle:\n        \"\"\"Load raw data from the specified path.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#implementation","title":"Implementation","text":"<pre><code>class ParquetLoader:\n    \"\"\"Load data from Parquet files.\"\"\"\n\n    def load(self, path: Path) -&gt; RawDataBundle:\n        return RawDataBundle(\n            counterparties=pl.scan_parquet(path / \"counterparties.parquet\"),\n            facilities=pl.scan_parquet(path / \"facilities.parquet\"),\n            loans=pl.scan_parquet(path / \"loans.parquet\"),\n            contingents=self._load_optional(path / \"contingents.parquet\"),\n            collateral=self._load_optional(path / \"collateral.parquet\"),\n            guarantees=self._load_optional(path / \"guarantees.parquet\"),\n            provisions=self._load_optional(path / \"provisions.parquet\"),\n            ratings=self._load_optional(path / \"ratings.parquet\"),\n            org_mapping=self._load_optional(path / \"org_mapping.parquet\"),\n            lending_mapping=self._load_optional(path / \"lending_mapping.parquet\"),\n        )\n\n    def _load_optional(self, path: Path) -&gt; pl.LazyFrame | None:\n        return pl.scan_parquet(path) if path.exists() else None\n</code></pre>"},{"location":"architecture/components/#key-features","title":"Key Features","text":"<ul> <li>Lazy loading for performance</li> <li>Optional file handling</li> <li>Schema validation</li> <li>Error accumulation</li> </ul>"},{"location":"architecture/components/#hierarchy-resolver","title":"Hierarchy Resolver","text":""},{"location":"architecture/components/#purpose_1","title":"Purpose","text":"<p>Resolve counterparty and facility hierarchies, inherit ratings, unify exposures, and calculate facility undrawn amounts.</p>"},{"location":"architecture/components/#interface_1","title":"Interface","text":"<pre><code>class HierarchyResolverProtocol(Protocol):\n    def resolve(\n        self,\n        raw_data: RawDataBundle,\n        config: CalculationConfig\n    ) -&gt; ResolvedHierarchyBundle:\n        \"\"\"Resolve hierarchies and inherit attributes.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#implementation_1","title":"Implementation","text":"<p>The <code>resolve()</code> method orchestrates the full hierarchy resolution:</p> <pre><code>class HierarchyResolver:\n    \"\"\"Resolve counterparty, facility, and lending group hierarchies.\"\"\"\n\n    def resolve(self, data: RawDataBundle, config: CalculationConfig) -&gt; ResolvedHierarchyBundle:\n        # Step 1: Build counterparty hierarchy lookup\n        #   \u2192 _build_ultimate_parent_lazy() - traverse org_mappings (up to 10 levels)\n        #   \u2192 _build_rating_inheritance_lazy() - inherit ratings from parent if missing\n        #   \u2192 Returns CounterpartyLookup (counterparties, parent_mappings,\n        #                                  ultimate_parent_mappings, rating_inheritance)\n\n        # Step 2: Unify exposures (loans + contingents + facility undrawn)\n        #   \u2192 _build_facility_root_lookup() - traverse facility hierarchies\n        #   \u2192 _calculate_facility_undrawn() - limit minus aggregated drawn amounts\n        #   \u2192 Combines all exposure types into single LazyFrame\n\n        # Step 2a: Apply FX conversion (exposures + CRM data)\n\n        # Step 2b: Add collateral LTV to exposures\n\n        # Step 3: Calculate residential property coverage\n\n        # Step 4: Calculate lending group totals (retail threshold)\n\n        # Step 5: Add lending group totals to exposures\n\n        return ResolvedHierarchyBundle(...)\n</code></pre>"},{"location":"architecture/components/#key-internal-methods","title":"Key Internal Methods","text":"Method Purpose <code>_build_counterparty_lookup()</code> Build complete counterparty hierarchy with ratings <code>_build_ultimate_parent_lazy()</code> Traverse org_mappings to find ultimate parent (up to 10 levels) <code>_build_rating_inheritance_lazy()</code> Inherit ratings: own \u2192 parent \u2192 unrated <code>_build_facility_root_lookup()</code> Traverse facility-to-facility hierarchies to find root facility <code>_calculate_facility_undrawn()</code> Calculate undrawn = limit - sum(descendant drawn), excluding sub-facilities <code>_unify_exposures()</code> Combine loan, contingent, and facility_undrawn into single LazyFrame <code>_calculate_lending_group_totals()</code> Aggregate exposure by lending group for retail threshold <code>_add_collateral_ltv()</code> Add LTV from collateral (direct \u2192 facility \u2192 counterparty priority) <code>_calculate_residential_property_coverage()</code> Separate residential vs all-property collateral coverage <code>_add_lending_group_totals_to_exposures()</code> Join lending group totals to each exposure"},{"location":"architecture/components/#key-features_1","title":"Key Features","text":"<ul> <li>Iterative join-based hierarchy resolution (counterparty and facility)</li> <li>Support for deep hierarchies (up to 10 levels)</li> <li>Multi-level facility hierarchy: drawn amounts aggregated to root facility</li> <li>Sub-facility exclusion from undrawn exposure output (avoids double-counting)</li> <li>Rating inheritance from parent (own \u2192 parent \u2192 unrated)</li> <li>Lending group aggregation with residential property exclusion (CRR Art. 123(c))</li> <li>Multi-level collateral linking (direct, facility, counterparty) with pro-rata allocation</li> <li>FX conversion of exposures and CRM data</li> <li>Flexible type column detection (<code>child_type</code> / <code>node_type</code> / neither)</li> <li>Non-blocking error accumulation</li> </ul>"},{"location":"architecture/components/#classifier","title":"Classifier","text":""},{"location":"architecture/components/#purpose_2","title":"Purpose","text":"<p>Assign regulatory exposure classes and calculation approaches based on counterparty entity type.</p>"},{"location":"architecture/components/#interface_2","title":"Interface","text":"<pre><code>class ClassifierProtocol(Protocol):\n    def classify(\n        self,\n        resolved: ResolvedHierarchyBundle,\n        config: CalculationConfig\n    ) -&gt; ClassifiedExposuresBundle:\n        \"\"\"Classify exposures into regulatory classes.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#entity-type-mappings","title":"Entity Type Mappings","text":"<p>The classifier uses <code>entity_type</code> as the single source of truth for exposure class determination. Two separate mappings exist for SA and IRB approaches:</p> <p>ENTITY_TYPE_TO_SA_CLASS - Maps to SA exposure class for risk weight lookup:</p> Entity Type SA Class <code>sovereign</code>, <code>central_bank</code> CENTRAL_GOVT_CENTRAL_BANK <code>rgla_sovereign</code>, <code>rgla_institution</code> RGLA <code>pse_sovereign</code>, <code>pse_institution</code> PSE <code>mdb</code>, <code>international_org</code> MDB <code>institution</code>, <code>bank</code>, <code>ccp</code>, <code>financial_institution</code> INSTITUTION <code>corporate</code>, <code>company</code> CORPORATE <code>individual</code>, <code>retail</code> RETAIL_OTHER <code>specialised_lending</code> SPECIALISED_LENDING <p>ENTITY_TYPE_TO_IRB_CLASS - Maps to IRB exposure class for formula selection:</p> Entity Type IRB Class Notes <code>sovereign</code>, <code>central_bank</code> CENTRAL_GOVT_CENTRAL_BANK <code>rgla_sovereign</code>, <code>pse_sovereign</code> CENTRAL_GOVT_CENTRAL_BANK Govt-backed = central govt IRB treatment <code>rgla_institution</code>, <code>pse_institution</code> INSTITUTION Commercial = institution IRB treatment <code>mdb</code>, <code>international_org</code> CENTRAL_GOVT_CENTRAL_BANK CRR Art. 147(3) <code>institution</code>, <code>bank</code>, <code>ccp</code>, <code>financial_institution</code> INSTITUTION <code>corporate</code>, <code>company</code> CORPORATE <code>individual</code>, <code>retail</code> RETAIL_OTHER <code>specialised_lending</code> SPECIALISED_LENDING"},{"location":"architecture/components/#classification-pipeline","title":"Classification Pipeline","text":"<p>The <code>classify()</code> method executes these steps in sequence:</p> <pre><code>Step 1: _add_counterparty_attributes()\n        Join exposures with counterparty data (entity_type, revenue, assets, etc.)\n\nStep 2: _classify_exposure_class()\n        Map entity_type to exposure_class_sa and exposure_class_irb\n\nStep 3: _apply_sme_classification()\n        Check annual_revenue &lt; EUR 50m for CORPORATE -&gt; CORPORATE_SME\n\nStep 4: _apply_retail_classification()\n        Aggregate by lending group, check EUR 1m threshold\n        Apply mortgage classification for RETAIL_MORTGAGE\n\nStep 5: _identify_defaults()\n        Check default_status, set exposure_class_for_sa = DEFAULTED\n\nStep 5a: _apply_infrastructure_classification()\n        Check product_type for infrastructure lending\n\nStep 5b: _apply_fi_scalar_classification()\n        Determine if FI scalar (1.25x correlation) applies:\n        - Large FSE: total_assets &gt;= EUR 70bn\n        - Unregulated FSE: is_regulated = False\n\nStep 6: _determine_approach()\n        Assign SA/FIRB/AIRB/SLOTTING based on IRB permissions\n\nStep 7: _add_classification_audit()\n        Build audit trail string for traceability\n\nStep 7a: _enrich_slotting_exposures()\n        Add slotting_category, sl_type, is_hvcre for specialised lending\n\nStep 8: Split by approach\n        Filter into sa_exposures, irb_exposures, slotting_exposures\n</code></pre>"},{"location":"architecture/components/#financial-sector-entity-fse-classification","title":"Financial Sector Entity (FSE) Classification","text":"<p>The classifier identifies Financial Sector Entities for the FI scalar (CRR Art. 153(2)):</p> <pre><code>FINANCIAL_SECTOR_ENTITY_TYPES = {\n    \"institution\",\n    \"bank\",\n    \"ccp\",\n    \"financial_institution\",\n    \"pse_institution\",   # PSE treated as institution\n    \"rgla_institution\",  # RGLA treated as institution\n}\n</code></pre> <p>FI Scalar triggers 1.25x correlation multiplier when: - <code>is_large_financial_sector_entity</code>: total_assets &gt;= EUR 70bn, OR - <code>is_financial_sector_entity</code> AND <code>is_regulated = False</code></p>"},{"location":"architecture/components/#key-features_2","title":"Key Features","text":"<ul> <li>Dual exposure class mapping: SA and IRB classes tracked separately</li> <li>Entity type as single source: No conflicting boolean flags</li> <li>SME identification: Corporate exposures with revenue &lt; EUR 50m</li> <li>Retail threshold checking: Lending group aggregation against EUR 1m</li> <li>Mortgage detection: Product type pattern matching</li> <li>FI scalar determination: Large or unregulated FSE identification</li> <li>Infrastructure classification: For supporting factor eligibility</li> <li>Slotting enrichment: Category, type, HVCRE flags from patterns</li> <li>Full audit trail: Classification reasoning captured per exposure</li> </ul>"},{"location":"architecture/components/#output-columns","title":"Output Columns","text":"<p>The classifier adds these columns to exposures:</p> Column Description <code>exposure_class</code> SA exposure class (backwards compatible) <code>exposure_class_sa</code> SA exposure class (explicit) <code>exposure_class_irb</code> IRB exposure class <code>is_sme</code> SME classification flag <code>is_mortgage</code> Mortgage product flag <code>is_defaulted</code> Default status flag <code>is_infrastructure</code> Infrastructure lending flag <code>is_financial_sector_entity</code> FSE flag <code>is_large_financial_sector_entity</code> Large FSE flag (&gt;= EUR 70bn) <code>requires_fi_scalar</code> FI scalar required (1.25x correlation) <code>qualifies_as_retail</code> Meets retail threshold <code>approach</code> Assigned calculation approach (SA/FIRB/AIRB/SLOTTING) <code>classification_reason</code> Audit trail string <p>See Classification for detailed documentation of the classification algorithm.</p>"},{"location":"architecture/components/#crm-processor","title":"CRM Processor","text":""},{"location":"architecture/components/#purpose_3","title":"Purpose","text":"<p>Apply credit risk mitigation (collateral, guarantees, provisions).</p>"},{"location":"architecture/components/#interface_3","title":"Interface","text":"<pre><code>class CRMProcessorProtocol(Protocol):\n    def process(\n        self,\n        classified: ClassifiedExposuresBundle,\n        config: CalculationConfig\n    ) -&gt; CRMAdjustedBundle:\n        \"\"\"Apply credit risk mitigation.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#implementation_2","title":"Implementation","text":"<pre><code>class CRMProcessor:\n    \"\"\"Process credit risk mitigation.\"\"\"\n\n    def process(\n        self,\n        classified: ClassifiedExposuresBundle,\n        config: CalculationConfig\n    ) -&gt; CRMAdjustedBundle:\n        # Process in order: provisions \u2192 collateral \u2192 guarantees\n\n        # Step 1: Apply provisions\n        after_provisions = self._apply_provisions(\n            classified.all_exposures,\n            classified.provisions\n        )\n\n        # Step 2: Apply collateral\n        after_collateral = self._apply_collateral(\n            after_provisions,\n            classified.collateral,\n            config\n        )\n\n        # Step 3: Apply guarantees\n        after_guarantees = self._apply_guarantees(\n            after_collateral,\n            classified.guarantees,\n            config\n        )\n\n        return CRMAdjustedBundle(\n            sa_exposures=self._filter_sa(after_guarantees),\n            irb_exposures=self._filter_irb(after_guarantees),\n            slotting_exposures=self._filter_slotting(after_guarantees),\n        )\n</code></pre>"},{"location":"architecture/components/#key-features_3","title":"Key Features","text":"<ul> <li>Supervisory haircut application</li> <li>Currency mismatch handling</li> <li>Maturity mismatch adjustment</li> <li>Guarantee substitution</li> <li>Provision allocation</li> </ul>"},{"location":"architecture/components/#sa-calculator","title":"SA Calculator","text":""},{"location":"architecture/components/#purpose_4","title":"Purpose","text":"<p>Calculate RWA using the Standardised Approach.</p>"},{"location":"architecture/components/#interface_4","title":"Interface","text":"<pre><code>class SACalculatorProtocol(Protocol):\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig\n    ) -&gt; SAResultBundle:\n        \"\"\"Calculate SA RWA.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#implementation_3","title":"Implementation","text":"<pre><code>class SACalculator:\n    \"\"\"Calculate Standardised Approach RWA.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig\n    ) -&gt; SAResultBundle:\n        result = (\n            exposures\n            # Look up risk weight\n            .with_columns(\n                risk_weight=self._get_risk_weight(\n                    pl.col(\"exposure_class\"),\n                    pl.col(\"cqs\"),\n                    config\n                )\n            )\n            # Calculate base RWA\n            .with_columns(\n                rwa_base=pl.col(\"ead\") * pl.col(\"risk_weight\")\n            )\n        )\n\n        # Apply supporting factors (CRR only)\n        if config.apply_sme_supporting_factor:\n            result = self._apply_sme_factor(result, config)\n\n        if config.apply_infrastructure_factor:\n            result = self._apply_infrastructure_factor(result, config)\n\n        return SAResultBundle(data=result)\n</code></pre>"},{"location":"architecture/components/#key-features_4","title":"Key Features","text":"<ul> <li>Risk weight lookup by class and CQS</li> <li>LTV-based real estate weights (Basel 3.1)</li> <li>SME supporting factor application</li> <li>Infrastructure factor application</li> </ul>"},{"location":"architecture/components/#irb-calculator","title":"IRB Calculator","text":""},{"location":"architecture/components/#purpose_5","title":"Purpose","text":"<p>Calculate RWA using IRB approaches (F-IRB and A-IRB).</p>"},{"location":"architecture/components/#interface_5","title":"Interface","text":"<pre><code>class IRBCalculatorProtocol(Protocol):\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig\n    ) -&gt; IRBResultBundle:\n        \"\"\"Calculate IRB RWA.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#implementation_4","title":"Implementation","text":"<p>The IRB Calculator uses a Polars namespace extension (<code>IRBLazyFrame</code>) for fluent, chainable calculations:</p> <pre><code>class IRBCalculator:\n    \"\"\"Calculate IRB RWA using K formula.\"\"\"\n\n    def get_irb_result_bundle(\n        self,\n        data: CRMAdjustedBundle,\n        config: CalculationConfig\n    ) -&gt; IRBResultBundle:\n        # Apply IRB calculations using namespace for fluent pipeline\n        exposures = (data.irb_exposures\n            .irb.classify_approach(config)   # Determine F-IRB vs A-IRB\n            .irb.apply_firb_lgd(config)      # Apply supervisory LGD for F-IRB\n            .irb.prepare_columns(config)     # Ensure required columns exist\n            .irb.apply_all_formulas(config)  # Run full IRB calculation\n        )\n\n        # Apply supporting factors (CRR only - Art. 501)\n        exposures = self._apply_supporting_factors(exposures, config)\n\n        return IRBResultBundle(\n            results=exposures,\n            expected_loss=exposures.irb.select_expected_loss(),\n            calculation_audit=exposures.irb.build_audit(),\n            errors=[],\n        )\n</code></pre>"},{"location":"architecture/components/#irb-namespace","title":"IRB Namespace","text":"<p>The <code>.irb</code> namespace provides chainable methods for each calculation step:</p> Method Description <code>classify_approach(config)</code> Classify as F-IRB or A-IRB <code>apply_firb_lgd(config)</code> Apply supervisory LGD for F-IRB <code>prepare_columns(config)</code> Ensure required columns exist <code>apply_pd_floor(config)</code> Apply PD floor (0.03% CRR, 0.05% Basel 3.1) <code>apply_lgd_floor(config)</code> Apply LGD floor (Basel 3.1 A-IRB only) <code>calculate_correlation(config)</code> Calculate asset correlation with SME adjustment <code>calculate_k(config)</code> Calculate capital requirement K <code>calculate_maturity_adjustment(config)</code> Calculate maturity adjustment <code>calculate_rwa(config)</code> Calculate RWA <code>calculate_expected_loss(config)</code> Calculate expected loss <code>apply_all_formulas(config)</code> Run complete calculation pipeline"},{"location":"architecture/components/#key-features_5","title":"Key Features","text":"<ul> <li>Fluent API: Namespace enables readable, chainable method calls</li> <li>Pure Polars expressions: Full lazy evaluation with <code>polars-normal-stats</code> for statistical functions</li> <li>Streaming-capable: No data materialization required, enabling large dataset processing</li> <li>PD and LGD floor application</li> <li>Correlation calculation with SME adjustment</li> <li>K formula implementation using <code>normal_cdf</code> and <code>normal_ppf</code></li> <li>Maturity adjustment</li> <li>Expected loss calculation</li> <li>CRR 1.06 scaling factor</li> </ul>"},{"location":"architecture/components/#slotting-calculator","title":"Slotting Calculator","text":""},{"location":"architecture/components/#purpose_6","title":"Purpose","text":"<p>Calculate RWA using the slotting approach for specialised lending.</p>"},{"location":"architecture/components/#interface_6","title":"Interface","text":"<pre><code>class SlottingCalculatorProtocol(Protocol):\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig\n    ) -&gt; SlottingResultBundle:\n        \"\"\"Calculate Slotting RWA.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#implementation_5","title":"Implementation","text":"<pre><code>class SlottingCalculator:\n    \"\"\"Calculate Slotting RWA for specialised lending.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig\n    ) -&gt; SlottingResultBundle:\n        result = (\n            exposures\n            # Look up slotting risk weight\n            .with_columns(\n                risk_weight=self._get_slotting_weight(\n                    pl.col(\"lending_type\"),\n                    pl.col(\"slotting_category\"),\n                    pl.col(\"is_pre_operational\"),  # For project finance\n                    config\n                )\n            )\n            # Calculate RWA\n            .with_columns(\n                rwa=pl.col(\"ead\") * pl.col(\"risk_weight\")\n            )\n        )\n\n        # Apply infrastructure factor (CRR only)\n        if config.apply_infrastructure_factor:\n            result = self._apply_infrastructure_factor(result, config)\n\n        return SlottingResultBundle(data=result)\n</code></pre>"},{"location":"architecture/components/#key-features_6","title":"Key Features","text":"<ul> <li>Slotting category to risk weight mapping</li> <li>Pre-operational project finance handling</li> <li>HVCRE treatment</li> <li>Infrastructure factor application</li> </ul>"},{"location":"architecture/components/#equity-calculator","title":"Equity Calculator","text":""},{"location":"architecture/components/#purpose_7","title":"Purpose","text":"<p>Calculate RWA for equity exposures using SA (Article 133) or IRB Simple (Article 155) risk weights.</p>"},{"location":"architecture/components/#interface_7","title":"Interface","text":"<pre><code>class EquityCalculatorProtocol(Protocol):\n    def calculate(\n        self,\n        data: CRMAdjustedBundle,\n        config: CalculationConfig,\n    ) -&gt; LazyFrameResult:\n        \"\"\"Calculate RWA for equity exposures.\"\"\"\n        ...\n\n    def get_equity_result_bundle(\n        self,\n        data: CRMAdjustedBundle,\n        config: CalculationConfig,\n    ) -&gt; EquityResultBundle:\n        \"\"\"Calculate equity RWA and return as bundle.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#implementation_6","title":"Implementation","text":"<p>The approach is determined by the firm's IRB permissions:</p> <ul> <li>SA (Article 133): Default approach. Risk weights based on equity type (central bank 0%, listed 100%, unlisted 250%, speculative 400%).</li> <li>IRB Simple (Article 155): When IRB is permitted. Risk weights differ (private equity diversified 190%, exchange-traded 290%, other 370%).</li> </ul> <pre><code>class EquityCalculator:\n    \"\"\"Calculate equity exposure RWA.\"\"\"\n\n    def get_equity_result_bundle(\n        self,\n        data: CRMAdjustedBundle,\n        config: CalculationConfig\n    ) -&gt; EquityResultBundle:\n        approach = self._determine_approach(config)\n        exposures = self._prepare_columns(data.equity_exposures, config)\n\n        if approach == \"sa\":\n            exposures = self._apply_equity_weights_sa(exposures, config)\n        else:\n            exposures = self._apply_equity_weights_irb_simple(exposures, config)\n\n        exposures = self._calculate_rwa(exposures)\n        audit = self._build_audit(exposures, approach)\n\n        return EquityResultBundle(\n            results=exposures,\n            calculation_audit=audit,\n            approach=approach,\n            errors=[],\n        )\n</code></pre>"},{"location":"architecture/components/#key-features_7","title":"Key Features","text":"<ul> <li>Approach determination from IRB permissions</li> <li>SA Article 133 risk weight assignment</li> <li>IRB Simple Article 155 risk weight assignment</li> <li>Diversified portfolio treatment for private equity</li> <li>Equity exposures bypass CRM (no collateral applied)</li> <li>Full audit trail</li> </ul>"},{"location":"architecture/components/#aggregator","title":"Aggregator","text":""},{"location":"architecture/components/#purpose_8","title":"Purpose","text":"<p>Combine results from all calculators, apply output floor.</p>"},{"location":"architecture/components/#interface_8","title":"Interface","text":"<pre><code>class OutputAggregatorProtocol(Protocol):\n    def aggregate(\n        self,\n        sa_result: SAResultBundle,\n        irb_result: IRBResultBundle,\n        slotting_result: SlottingResultBundle,\n        equity_result: EquityResultBundle,\n        config: CalculationConfig\n    ) -&gt; AggregatedResultBundle:\n        \"\"\"Aggregate results and apply final adjustments.\"\"\"\n        ...\n</code></pre>"},{"location":"architecture/components/#implementation_7","title":"Implementation","text":"<pre><code>class OutputAggregator:\n    \"\"\"Aggregate calculation results.\"\"\"\n\n    def aggregate(\n        self,\n        sa_result: SAResultBundle,\n        irb_result: IRBResultBundle,\n        slotting_result: SlottingResultBundle,\n        equity_result: EquityResultBundle,\n        config: CalculationConfig\n    ) -&gt; AggregatedResultBundle:\n        # Combine all results\n        combined = pl.concat([\n            sa_result.data.with_columns(approach=pl.lit(\"SA\")),\n            irb_result.data.with_columns(approach=pl.lit(\"IRB\")),\n            slotting_result.data.with_columns(approach=pl.lit(\"SLOTTING\")),\n            equity_result.results.with_columns(approach=pl.lit(\"EQUITY\")),\n        ])\n\n        # Apply output floor (Basel 3.1)\n        if config.framework == RegulatoryFramework.BASEL_3_1:\n            combined = self._apply_output_floor(\n                combined,\n                config.output_floor_config\n            )\n\n        # Calculate totals\n        totals = self._calculate_totals(combined)\n\n        return AggregatedResultBundle(\n            data=combined,\n            total_rwa=totals.rwa,\n            sa_rwa=totals.sa_rwa,\n            irb_rwa=totals.irb_rwa,\n            slotting_rwa=totals.slotting_rwa,\n            total_expected_loss=totals.expected_loss,\n        )\n</code></pre>"},{"location":"architecture/components/#key-features_8","title":"Key Features","text":"<ul> <li>Result combination</li> <li>Output floor application</li> <li>Floor impact calculation</li> <li>Total aggregation</li> <li>Breakdown by approach/class</li> </ul>"},{"location":"architecture/components/#next-steps","title":"Next Steps","text":"<ul> <li>API Reference - Complete API documentation</li> <li>Data Model - Schema definitions</li> <li>Development Guide - Extending the calculator</li> </ul>"},{"location":"architecture/data-flow/","title":"Data Flow","text":"<p>This document describes how data flows through the RWA calculator, including schemas, transformations, and validation points.</p>"},{"location":"architecture/data-flow/#data-flow-overview","title":"Data Flow Overview","text":"<pre><code>flowchart TD\n    subgraph External\n        A[Parquet Files]\n        B[CSV Files]\n    end\n\n    subgraph Loading\n        C[Schema Validation]\n        D[RawDataBundle]\n    end\n\n    subgraph Processing\n        E[Hierarchy Resolution]\n        F[Classification]\n        G[CRM Application]\n    end\n\n    subgraph Calculation\n        H[SA/IRB/Slotting/Equity]\n    end\n\n    subgraph Output\n        I[Aggregation]\n        J[Results]\n    end\n\n    A &amp; B --&gt; C --&gt; D\n    D --&gt; E --&gt; F --&gt; G --&gt; H --&gt; I --&gt; J</code></pre>"},{"location":"architecture/data-flow/#input-data","title":"Input Data","text":""},{"location":"architecture/data-flow/#required-files","title":"Required Files","text":"File Description Required <code>counterparties.parquet</code> Counterparty master data Yes <code>facilities.parquet</code> Credit facilities Yes <code>loans.parquet</code> Individual loans/draws Yes"},{"location":"architecture/data-flow/#optional-files","title":"Optional Files","text":"File Description <code>contingents.parquet</code> Off-balance sheet items <code>collateral.parquet</code> Collateral details <code>guarantees.parquet</code> Guarantee information <code>provisions.parquet</code> Provision allocations <code>ratings.parquet</code> Credit ratings <code>org_mapping.parquet</code> Organization hierarchy <code>lending_mapping.parquet</code> Retail lending groups"},{"location":"architecture/data-flow/#schema-definitions","title":"Schema Definitions","text":"<p>Schemas are defined in <code>data/schemas.py</code>. The key column names use <code>_reference</code> suffixes (e.g., <code>counterparty_reference</code>, <code>facility_reference</code>) rather than <code>_id</code>.</p>"},{"location":"architecture/data-flow/#counterparty-schema","title":"Counterparty Schema","text":"<pre><code>COUNTERPARTY_SCHEMA = {\n    \"counterparty_reference\": pl.String,  # Unique identifier\n    \"counterparty_name\": pl.String,       # Legal name\n    \"entity_type\": pl.String,             # Single source of truth: sovereign, institution, corporate, etc.\n    \"country_code\": pl.String,            # ISO country code\n    \"annual_revenue\": pl.Float64,         # For SME classification (EUR 50m threshold)\n    \"total_assets\": pl.Float64,           # For large FSE threshold (EUR 70bn)\n    \"default_status\": pl.Boolean,         # Default indicator\n    \"sector_code\": pl.String,             # Based on SIC\n    \"is_regulated\": pl.Boolean,           # For FI scalar: unregulated FSE gets 1.25x correlation\n    \"is_managed_as_retail\": pl.Boolean,   # SME managed on pooled retail basis - 75% RW\n}\n</code></pre>"},{"location":"architecture/data-flow/#facility-schema","title":"Facility Schema","text":"<pre><code>FACILITY_SCHEMA = {\n    \"facility_reference\": pl.String,      # Unique identifier\n    \"product_type\": pl.String,            # Product classification\n    \"book_code\": pl.String,               # Book identifier\n    \"counterparty_reference\": pl.String,  # Link to counterparty\n    \"value_date\": pl.Date,                # Facility start\n    \"maturity_date\": pl.Date,             # Final maturity\n    \"currency\": pl.String,                # ISO currency code\n    \"limit\": pl.Float64,                  # Total commitment\n    \"committed\": pl.Boolean,              # Committed flag\n    \"lgd\": pl.Float64,                    # A-IRB modelled LGD\n    \"beel\": pl.Float64,                   # Best estimate expected loss\n    \"is_revolving\": pl.Boolean,           # Revolving facility flag\n    \"seniority\": pl.String,              # senior/subordinated - affects F-IRB LGD\n    \"risk_type\": pl.String,              # FR/MR/MLR/LR - determines CCF\n    \"ccf_modelled\": pl.Float64,          # A-IRB modelled CCF (0.0-1.5)\n    \"is_short_term_trade_lc\": pl.Boolean, # 20% CCF under F-IRB (Art. 166(9))\n    \"is_buy_to_let\": pl.Boolean,         # BTL - excluded from SME supporting factor\n}\n</code></pre>"},{"location":"architecture/data-flow/#loan-schema","title":"Loan Schema","text":"<pre><code>LOAN_SCHEMA = {\n    \"loan_reference\": pl.String,          # Unique identifier\n    \"product_type\": pl.String,            # Product classification\n    \"book_code\": pl.String,               # Book identifier\n    \"counterparty_reference\": pl.String,  # Link to counterparty\n    \"value_date\": pl.Date,                # Loan start\n    \"maturity_date\": pl.Date,             # Final maturity\n    \"currency\": pl.String,                # ISO currency code\n    \"drawn_amount\": pl.Float64,           # Outstanding principal\n    \"interest\": pl.Float64,              # Accrued interest (adds to EAD)\n    \"lgd\": pl.Float64,                   # A-IRB modelled LGD\n    \"beel\": pl.Float64,                  # Best estimate expected loss\n    \"seniority\": pl.String,             # senior/subordinated\n    \"is_buy_to_let\": pl.Boolean,        # BTL property lending\n}\n</code></pre>"},{"location":"architecture/data-flow/#rating-schema","title":"Rating Schema","text":"<pre><code>RATINGS_SCHEMA = {\n    \"rating_reference\": pl.String,        # Unique identifier\n    \"counterparty_reference\": pl.String,  # Link to counterparty\n    \"rating_type\": pl.String,             # internal/external\n    \"rating_agency\": pl.String,           # internal, S&amp;P, Moodys, Fitch, DBRS, etc.\n    \"rating_value\": pl.String,            # AAA, AA+, Aa1, etc.\n    \"cqs\": pl.Int8,                       # Credit Quality Step 1-6\n    \"pd\": pl.Float64,                     # Probability of Default (for internal ratings)\n}\n</code></pre>"},{"location":"architecture/data-flow/#collateral-schema","title":"Collateral Schema","text":"<pre><code>COLLATERAL_SCHEMA = {\n    \"collateral_reference\": pl.String,    # Unique identifier\n    \"collateral_type\": pl.String,         # cash, gold, equity, bond, real_estate, etc.\n    \"currency\": pl.String,                # ISO currency code\n    \"maturity_date\": pl.Date,             # Collateral maturity\n    \"market_value\": pl.Float64,           # Current market value\n    \"nominal_value\": pl.Float64,          # Nominal value\n    \"pledge_percentage\": pl.Float64,      # Fraction of beneficiary EAD (0.5 = 50%)\n    \"beneficiary_type\": pl.String,        # counterparty/loan/facility/contingent\n    \"beneficiary_reference\": pl.String,   # Reference to linked entity\n    \"issuer_cqs\": pl.Int8,               # CQS of issuer (1-6) for haircut lookup\n    \"issuer_type\": pl.String,            # sovereign/pse/corporate/securitisation\n    \"residual_maturity_years\": pl.Float64, # For haircut bands\n    \"property_type\": pl.String,          # residential/commercial (RE collateral)\n    \"property_ltv\": pl.Float64,          # Loan-to-value ratio\n    \"is_income_producing\": pl.Boolean,   # Material income dependence\n    \"is_adc\": pl.Boolean,               # Acquisition/Development/Construction\n}\n</code></pre>"},{"location":"architecture/data-flow/#data-transformations","title":"Data Transformations","text":""},{"location":"architecture/data-flow/#stage-1-loading","title":"Stage 1: Loading","text":"<p>Input: Raw files Output: <code>RawDataBundle</code></p> <p>Transformations: - Load files as LazyFrames - Validate against schemas - Convert data types - Add metadata columns</p> <pre><code># Example transformation\ncounterparties = (\n    pl.scan_parquet(path / \"counterparties.parquet\")\n    .with_columns(\n        _load_timestamp=pl.lit(datetime.now()),\n        _source_file=pl.lit(\"counterparties.parquet\")\n    )\n)\n</code></pre>"},{"location":"architecture/data-flow/#stage-2-hierarchy-resolution","title":"Stage 2: Hierarchy Resolution","text":"<p>Input: <code>RawDataBundle</code> Output: <code>ResolvedHierarchyBundle</code></p> <p>See <code>hierarchy.py</code> for implementation.</p> <p>Transformations: - Resolve parent-child relationships - Calculate aggregate exposures - Inherit ratings - Resolve lending groups</p> <pre><code># Hierarchy resolution adds columns\nresolved = (\n    exposures\n    .with_columns(\n        ultimate_parent_id=...,\n        group_total_exposure=...,\n        inherited_rating=...,\n        inherited_cqs=...,\n    )\n)\n</code></pre> Hierarchy Resolution (hierarchy.py) <pre><code>        Build counterparty hierarchy lookup using pure LazyFrame operations.\n\n        Returns:\n            Tuple of (CounterpartyLookup, list of errors)\n        \"\"\"\n        errors: list[HierarchyError] = []\n\n        # If org_mappings is None, create empty LazyFrame with expected schema\n        if org_mappings is None:\n            org_mappings = pl.LazyFrame(schema={\n                \"parent_counterparty_reference\": pl.String,\n                \"child_counterparty_reference\": pl.String,\n            })\n\n        # Build ultimate parent mapping (LazyFrame)\n        ultimate_parents = self._build_ultimate_parent_lazy(org_mappings)\n\n        # If ratings is None, create empty LazyFrame with expected schema\n        if ratings is None:\n            ratings = pl.LazyFrame(schema={\n                \"counterparty_reference\": pl.String,\n                \"rating_reference\": pl.String,\n                \"rating_type\": pl.String,\n                \"rating_agency\": pl.String,\n                \"rating_value\": pl.String,\n                \"cqs\": pl.Int8,\n                \"pd\": pl.Float64,\n                \"rating_date\": pl.Date,\n            })\n\n        # Build rating inheritance (LazyFrame)\n        rating_info = self._build_rating_inheritance_lazy(\n            counterparties, ratings, ultimate_parents\n        )\n\n        # Enrich counterparties with hierarchy info\n        enriched_counterparties = self._enrich_counterparties_with_hierarchy(\n            counterparties,\n            org_mappings,\n            ratings,\n            ultimate_parents,\n            rating_info,\n        )\n\n        return CounterpartyLookup(\n            counterparties=enriched_counterparties,\n            parent_mappings=org_mappings.select([\n                \"child_counterparty_reference\",\n                \"parent_counterparty_reference\",\n            ]),\n            ultimate_parent_mappings=ultimate_parents,\n            rating_inheritance=rating_info,\n        ), errors\n\n    def _build_ultimate_parent_lazy(\n        self,\n        org_mappings: pl.LazyFrame,\n        max_depth: int = 10,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build ultimate parent mapping using iterative joins.\n\n        Returns LazyFrame with columns:\n        - counterparty_reference: The entity\n        - ultimate_parent_reference: Its ultimate parent\n        - hierarchy_depth: Number of levels traversed\n        \"\"\"\n        # Get unique child references\n        entities = org_mappings.select(\n            pl.col(\"child_counterparty_reference\").alias(\"counterparty_reference\")\n</code></pre>"},{"location":"architecture/data-flow/#stage-3-classification","title":"Stage 3: Classification","text":"<p>Input: <code>ResolvedHierarchyBundle</code> Output: <code>ClassifiedExposuresBundle</code></p> <p>See <code>classifier.py</code> for implementation.</p> <p>Transformations: - Assign exposure class - Determine calculation approach - Calculate CCFs - Calculate EAD</p> <pre><code># Classification adds columns\nclassified = (\n    resolved\n    .with_columns(\n        exposure_class=...,\n        approach_type=...,\n        ccf=...,\n        ead=pl.col(\"drawn_amount\") + pl.col(\"undrawn_amount\") * pl.col(\"ccf\"),\n    )\n)\n</code></pre> Classification Logic (classifier.py) <pre><code>        )\n\n        # Step 6a: Clear internal LGD for FIRB exposures\n        # FIRB uses supervisory LGD values, not internal models\n        classified = self._clear_lgd_for_firb(classified)\n\n        # Step 7: Add classification audit trail\n        classified = self._add_classification_audit(classified)\n\n        # Step 7a: Enrich slotting exposures with slotting metadata\n        # This must happen before splitting so metadata flows through CRM processor\n        classified = self._enrich_slotting_exposures(classified)\n\n        # Strategic collect to materialize all classification processing\n        # This breaks up the complex query plan for better downstream performance\n        classified = classified.collect().lazy()\n\n        # Step 8: Split by approach\n        sa_exposures = self._filter_by_approach(classified, ApproachType.SA)\n        irb_exposures = self._filter_irb_exposures(classified)\n        slotting_exposures = self._filter_by_approach(classified, ApproachType.SLOTTING)\n\n        # Build classification audit\n        classification_audit = self._build_audit_trail(classified)\n\n        return ClassifiedExposuresBundle(\n            all_exposures=classified,\n            sa_exposures=sa_exposures,\n            irb_exposures=irb_exposures,\n            slotting_exposures=slotting_exposures,\n            equity_exposures=data.equity_exposures,\n            collateral=data.collateral,\n            guarantees=data.guarantees,\n            provisions=data.provisions,\n            counterparty_lookup=data.counterparty_lookup,\n            classification_audit=classification_audit,\n            classification_errors=errors,\n        )\n\n    def _add_counterparty_attributes(\n        self,\n        exposures: pl.LazyFrame,\n        counterparties: pl.LazyFrame,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Add counterparty attributes needed for classification.\n\n        Joins exposures with counterparty data to get:\n        - entity_type (single source of truth for exposure class)\n        - annual_revenue (for SME check)\n</code></pre>"},{"location":"architecture/data-flow/#stage-4-crm-processing","title":"Stage 4: CRM Processing","text":"<p>Input: <code>ClassifiedExposuresBundle</code> Output: <code>CRMAdjustedBundle</code></p> <p>See <code>crm/processor.py</code> for implementation.</p> <p>Transformations: - Apply provision deductions - Calculate collateral haircuts - Apply guarantee substitution - Calculate net exposure</p> <pre><code># CRM processing adds columns\ncrm_adjusted = (\n    classified\n    .with_columns(\n        provision_amount=...,\n        collateral_value=...,\n        collateral_haircut=...,\n        guaranteed_amount=...,\n        guarantor_rw=...,\n        net_ead=...,\n    )\n)\n</code></pre> CRM Processing (processor.py) <pre><code>        \"\"\"\n        Check if optional CRM data is valid for processing.\n\n        This provides defense-in-depth validation to ensure data has:\n        - At least one row\n        - All required columns for the CRM operation\n\n        Args:\n            data: Optional LazyFrame to validate\n            required_columns: Set of column names that must be present\n\n        Returns:\n            True if data is valid for processing, False otherwise\n        \"\"\"\n        if data is None:\n            return False\n\n        try:\n            # Check schema has required columns\n            schema = data.collect_schema()\n            if not required_columns.issubset(set(schema.names())):\n                return False\n\n            # Check if there's at least one row\n            return data.head(1).collect().height &gt; 0\n        except Exception:\n            return False\n\n    def apply_crm(\n        self,\n        data: ClassifiedExposuresBundle,\n        config: CalculationConfig,\n    ) -&gt; LazyFrameResult:\n        \"\"\"\n        Apply credit risk mitigation to exposures.\n\n        Args:\n            data: Classified exposures from classifier\n            config: Calculation configuration\n\n        Returns:\n            LazyFrameResult with CRM-adjusted exposures and any errors\n        \"\"\"\n        bundle = self.get_crm_adjusted_bundle(data, config)\n\n        # Convert to LazyFrameResult format\n        return LazyFrameResult(\n            frame=bundle.exposures,\n            errors=[],  # CRMError objects would need conversion to CalculationError\n        )\n\n    def get_crm_adjusted_bundle(\n        self,\n        data: ClassifiedExposuresBundle,\n        config: CalculationConfig,\n    ) -&gt; CRMAdjustedBundle:\n        \"\"\"\n        Apply CRM and return as a bundle.\n\n        Args:\n            data: Classified exposures from classifier\n            config: Calculation configuration\n\n        Returns:\n            CRMAdjustedBundle with adjusted exposures\n        \"\"\"\n        errors: list[CRMError] = []\n\n        # Start with all exposures\n        exposures = data.all_exposures\n\n        # Step 1: Apply CCF to calculate EAD for contingents\n        exposures = self._apply_ccf(exposures, config)\n</code></pre>"},{"location":"architecture/data-flow/#stage-5-rwa-calculation","title":"Stage 5: RWA Calculation","text":"<p>Input: <code>CRMAdjustedBundle</code> Output: Result bundles</p> <p>See <code>sa/calculator.py</code> and <code>irb/formulas.py</code> for implementations.</p> <p>Transformations: - Look up risk weights (SA) - Calculate K formula (IRB) - Apply maturity adjustment - Calculate RWA</p> <pre><code># SA calculation\nsa_result = (\n    sa_exposures\n    .with_columns(\n        risk_weight=...,\n        supporting_factor=...,\n        rwa=pl.col(\"ead\") * pl.col(\"risk_weight\") * pl.col(\"supporting_factor\"),\n    )\n)\n\n# IRB calculation\nirb_result = (\n    irb_exposures\n    .with_columns(\n        pd_floored=...,\n        lgd_floored=...,\n        correlation=...,\n        k=...,\n        maturity_adjustment=...,\n        rwa=pl.col(\"k\") * 12.5 * pl.col(\"ead\") * pl.col(\"ma\") * scaling,\n        expected_loss=pl.col(\"pd\") * pl.col(\"lgd\") * pl.col(\"ead\"),\n    )\n)\n</code></pre> IRB Formula Application (formulas.py) <pre><code>    apply_scaling = config.is_crr\n    scaling_factor = 1.06 if apply_scaling else 1.0\n\n    # Ensure required columns exist\n    schema = exposures.collect_schema()\n    if \"maturity\" not in schema.names():\n        exposures = exposures.with_columns(pl.lit(2.5).alias(\"maturity\"))\n    if \"turnover_m\" not in schema.names():\n        exposures = exposures.with_columns(pl.lit(None).cast(pl.Float64).alias(\"turnover_m\"))\n    # Ensure requires_fi_scalar column exists (for FI scalar in correlation)\n    # This is normally set by the classifier, default to False if not present\n    schema = exposures.collect_schema()\n    if \"requires_fi_scalar\" not in schema.names():\n        exposures = exposures.with_columns(pl.lit(False).alias(\"requires_fi_scalar\"))\n\n    # Step 1: Apply PD floor (pure Polars)\n    exposures = exposures.with_columns(\n        pl.col(\"pd\").clip(lower_bound=pd_floor).alias(\"pd_floored\")\n    )\n\n    # Step 2: Apply LGD floor (Basel 3.1 A-IRB only)\n    if config.is_basel_3_1:\n        lgd_floor = float(config.lgd_floors.unsecured)\n        exposures = exposures.with_columns(\n            pl.col(\"lgd\").clip(lower_bound=lgd_floor).alias(\"lgd_floored\")\n        )\n    else:\n        exposures = exposures.with_columns(\n            pl.col(\"lgd\").alias(\"lgd_floored\")\n        )\n\n    # Step 3: Calculate correlation using pure Polars expressions\n    # Pass EUR/GBP rate from config to convert GBP turnover to EUR for SME adjustment\n    eur_gbp_rate = float(config.eur_gbp_rate)\n    exposures = exposures.with_columns(\n        _polars_correlation_expr(eur_gbp_rate=eur_gbp_rate).alias(\"correlation\")\n    )\n\n    # Step 4: Calculate K using pure Polars with polars-normal-stats\n    exposures = exposures.with_columns(\n        _polars_capital_k_expr().alias(\"k\")\n    )\n\n    # Step 5: Calculate maturity adjustment (only for non-retail)\n    is_retail = (\n        pl.col(\"exposure_class\")\n        .cast(pl.String)\n        .fill_null(\"CORPORATE\")\n        .str.to_uppercase()\n        .str.contains(\"RETAIL\")\n    )\n\n    exposures = exposures.with_columns(\n        pl.when(is_retail)\n        .then(pl.lit(1.0))\n        .otherwise(_polars_maturity_adjustment_expr())\n        .alias(\"maturity_adjustment\")\n    )\n\n    # Step 6-9: Final calculations (pure Polars expressions)\n    exposures = exposures.with_columns([\n        pl.lit(scaling_factor).alias(\"scaling_factor\"),\n        (pl.col(\"k\") * 12.5 * scaling_factor * pl.col(\"ead_final\") * pl.col(\"maturity_adjustment\")).alias(\"rwa\"),\n        (pl.col(\"k\") * 12.5 * scaling_factor * pl.col(\"maturity_adjustment\")).alias(\"risk_weight\"),\n        (pl.col(\"pd_floored\") * pl.col(\"lgd_floored\") * pl.col(\"ead_final\")).alias(\"expected_loss\"),\n    ])\n\n    return exposures\n\n\n# Backward compatibility alias\napply_irb_formulas_numpy = apply_irb_formulas\n\n\n# =============================================================================\n# PURE POLARS EXPRESSION FUNCTIONS\n# =============================================================================\n\n\ndef _polars_correlation_expr(\n    sme_threshold: float = 50.0,\n    eur_gbp_rate: float = 0.8732,\n) -&gt; pl.Expr:\n    \"\"\"\n    Pure Polars expression for correlation calculation.\n\n    Supports all exposure classes with proper correlation formulas:\n    - Corporate/Institution/Sovereign: PD-dependent (decay=50)\n    - Retail mortgage: Fixed 0.15\n    - QRRE: Fixed 0.04\n    - Other retail: PD-dependent (decay=35)\n\n    Includes:\n    - SME firm size adjustment for corporates (turnover converted from GBP to EUR)\n    - FI scalar (1.25x) for large/unregulated financial sector entities (CRR Art. 153(2))\n\n    Args:\n        sme_threshold: SME threshold in EUR millions (default 50.0)\n        eur_gbp_rate: EUR/GBP exchange rate for converting GBP turnover to EUR (default 0.8732)\n    \"\"\"\n    pd = pl.col(\"pd_floored\")\n    exp_class = pl.col(\"exposure_class\").cast(pl.String).fill_null(\"CORPORATE\").str.to_uppercase()\n    turnover = pl.col(\"turnover_m\")\n\n    # Pre-calculate decay denominators (constants)\n</code></pre>"},{"location":"architecture/data-flow/#stage-6-aggregation","title":"Stage 6: Aggregation","text":"<p>Input: Result bundles Output: <code>AggregatedResultBundle</code></p> <p>See <code>aggregator.py</code> for implementation.</p> <p>Transformations: - Combine results from all approaches - Apply output floor (Basel 3.1) - Calculate totals and breakdowns</p> <pre><code># Aggregation\naggregated = (\n    pl.concat([sa_result, irb_result, slotting_result])\n    .with_columns(\n        # Basel 3.1 output floor\n        rwa_floored=pl.when(framework == \"BASEL_3_1\")\n            .then(pl.max_horizontal(\"rwa\", \"sa_equivalent_rwa\" * floor))\n            .otherwise(pl.col(\"rwa\"))\n    )\n)\n</code></pre> Aggregation (aggregator.py) <pre><code>\"\"\"\nOutput Aggregator for RWA Calculations.\n\nCombines SA, IRB, and Slotting results with:\n- Output floor application (Basel 3.1 only)\n- Supporting factor tracking (CRR only)\n- Summary generation by exposure class and approach\n\nPipeline position:\n    SACalculator/IRBCalculator/SlottingCalculator -&gt; OutputAggregator -&gt; Pipeline output\n\nKey responsibilities:\n- Combine SA and IRB results into unified output\n- Apply output floor (Basel 3.1: max(IRB RWA, 72.5% \u00d7 SA RWA))\n- Track supporting factor impact (CRR only)\n- Generate summary statistics by class and approach\n\nReferences:\n- CRE99.1-8: Output floor (Basel 3.1)\n- PS9/24 Ch.12: PRA output floor implementation\n- CRR Art. 501: SME supporting factor\n- CRR Art. 501a: Infrastructure supporting factor\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass, field\nfrom datetime import date\nfrom decimal import Decimal\nfrom typing import TYPE_CHECKING\n\nimport polars as pl\n\nfrom rwa_calc.contracts.bundles import (\n    AggregatedResultBundle,\n    SAResultBundle,\n    IRBResultBundle,\n    SlottingResultBundle,\n    EquityResultBundle,\n)\nfrom rwa_calc.contracts.errors import (\n    CalculationError,\n    ErrorCategory,\n    ErrorSeverity,\n)\n\nif TYPE_CHECKING:\n    from rwa_calc.contracts.config import CalculationConfig\n\n\n# =============================================================================\n# Error Types\n# =============================================================================\n\n\n@dataclass\nclass AggregationError:\n    \"\"\"Error during result aggregation.\"\"\"\n\n    error_type: str\n    message: str\n    exposure_reference: str | None = None\n\n\n# =============================================================================\n# Output Aggregator Implementation\n# =============================================================================\n\n\nclass OutputAggregator:\n    \"\"\"\n    Aggregate final RWA results from all calculators.\n\n    Implements OutputAggregatorProtocol for:\n    - Combining SA, IRB, and Slotting results\n    - Applying output floor (Basel 3.1)\n    - Tracking supporting factor impact (CRR)\n    - Generating summaries by exposure class and approach\n\n    Usage:\n</code></pre>"},{"location":"architecture/data-flow/#data-validation","title":"Data Validation","text":""},{"location":"architecture/data-flow/#schema-validation","title":"Schema Validation","text":"<pre><code>def validate_schema(\n    df: pl.LazyFrame,\n    expected_schema: dict[str, pl.DataType]\n) -&gt; list[ValidationError]:\n    \"\"\"Validate DataFrame against expected schema.\"\"\"\n    errors = []\n\n    for column, expected_type in expected_schema.items():\n        if column not in df.columns:\n            errors.append(ValidationError(\n                field=column,\n                message=f\"Missing required column: {column}\"\n            ))\n        elif df.schema[column] != expected_type:\n            errors.append(ValidationError(\n                field=column,\n                message=f\"Type mismatch: expected {expected_type}, got {df.schema[column]}\"\n            ))\n\n    return errors\n</code></pre>"},{"location":"architecture/data-flow/#business-rule-validation","title":"Business Rule Validation","text":"<pre><code>def validate_exposure(exposure: dict) -&gt; list[ValidationError]:\n    \"\"\"Validate exposure against business rules.\"\"\"\n    errors = []\n\n    # EAD must be positive\n    if exposure[\"ead\"] &lt;= 0:\n        errors.append(ValidationError(\n            field=\"ead\",\n            message=\"EAD must be positive\"\n        ))\n\n    # PD must be in valid range\n    if not (0 &lt;= exposure[\"pd\"] &lt;= 1):\n        errors.append(ValidationError(\n            field=\"pd\",\n            message=\"PD must be between 0 and 1\"\n        ))\n\n    return errors\n</code></pre>"},{"location":"architecture/data-flow/#output-data","title":"Output Data","text":""},{"location":"architecture/data-flow/#result-schema","title":"Result Schema","text":"<pre><code>RESULT_SCHEMA = {\n    \"exposure_id\": pl.Utf8,\n    \"counterparty_id\": pl.Utf8,\n    \"facility_id\": pl.Utf8,\n    \"exposure_class\": pl.Utf8,\n    \"approach_type\": pl.Utf8,\n    \"ead\": pl.Float64,\n    \"risk_weight\": pl.Float64,\n    \"rwa\": pl.Float64,\n    \"expected_loss\": pl.Float64,  # IRB only\n    \"rwa_before_floor\": pl.Float64,  # Basel 3.1\n    \"floor_impact\": pl.Float64,  # Basel 3.1\n}\n</code></pre>"},{"location":"architecture/data-flow/#export-formats","title":"Export Formats","text":"<pre><code># Export to various formats\nresult.to_parquet(\"results.parquet\")\nresult.to_csv(\"results.csv\")\nresult.to_json(\"results.json\")\n\n# Get as DataFrame\ndf = result.to_dataframe()\n</code></pre>"},{"location":"architecture/data-flow/#data-lineage","title":"Data Lineage","text":"<p>Each calculator produces an audit trail LazyFrame alongside results. The audit trail captures the full calculation reasoning per exposure, including classification decisions, CRM adjustments, and formula parameters. Access audit data via the result bundles:</p> <pre><code># Access audit trails from result bundles\nresult = pipeline.run_with_data(raw_data, config)\n\n# SA audit\nsa_audit = result.sa_result.calculation_audit\n\n# IRB audit\nirb_audit = result.irb_result.calculation_audit\n\n# Materialize results with full detail\ndf = result.to_dataframe()\n</code></pre>"},{"location":"architecture/data-flow/#next-steps","title":"Next Steps","text":"<ul> <li>Component Overview - Individual components</li> <li>API Reference - API documentation</li> <li>Data Model - Complete schema reference</li> </ul>"},{"location":"architecture/design-principles/","title":"Design Principles","text":"<p>This document explains the key architectural decisions and design principles underlying the RWA calculator.</p>"},{"location":"architecture/design-principles/#core-principles","title":"Core Principles","text":""},{"location":"architecture/design-principles/#1-single-codebase-dual-framework","title":"1. Single Codebase, Dual Framework","text":"<p>Decision: Support both CRR and Basel 3.1 in a single codebase.</p> <p>Rationale: - Avoids code duplication - Enables easy comparison between frameworks - Simplifies maintenance - Supports transition planning</p> <p>Implementation: <pre><code># Framework-specific behavior controlled by configuration\nif config.framework == RegulatoryFramework.CRR:\n    rwa = rwa * config.scaling_factor  # 1.06\nelse:\n    rwa = apply_output_floor(rwa, sa_rwa, config.output_floor)\n</code></pre></p>"},{"location":"architecture/design-principles/#2-pure-lazyframe-operations","title":"2. Pure LazyFrame Operations","text":"<p>Decision: Use Polars LazyFrames exclusively for all data operations.</p> <p>Rationale: - Enables query optimization by Polars - Reduces memory usage through lazy evaluation - Allows automatic parallelization - Avoids row-by-row iteration (major performance gain)</p> <p>Anti-pattern (Avoided): <pre><code># BAD: Row-by-row processing\nfor row in dataframe.iter_rows():\n    result = calculate_rwa(row)\n    results.append(result)\n</code></pre></p> <p>Pattern (Used): <pre><code># GOOD: Vectorized operation\nresult = df.with_columns(\n    rwa=pl.col(\"ead\") * pl.col(\"risk_weight\") * pl.col(\"factor\")\n)\n</code></pre></p>"},{"location":"architecture/design-principles/#3-protocol-based-interfaces","title":"3. Protocol-Based Interfaces","text":"<p>Decision: Define component interfaces using Python Protocols.</p> <p>Rationale: - Enables dependency injection - Supports testing with mocks - Allows multiple implementations - Documents expected behavior</p> <p>Implementation: <pre><code>from typing import Protocol\n\nclass LoaderProtocol(Protocol):\n    def load(self, path: Path) -&gt; RawDataBundle:\n        \"\"\"Load raw data from source.\"\"\"\n        ...\n\n# Any class with matching signature satisfies protocol\nclass ParquetLoader:\n    def load(self, path: Path) -&gt; RawDataBundle:\n        # Implementation\n        ...\n\nclass MockLoader:\n    def load(self, path: Path) -&gt; RawDataBundle:\n        # Test implementation\n        ...\n</code></pre></p>"},{"location":"architecture/design-principles/#4-immutable-data-contracts","title":"4. Immutable Data Contracts","text":"<p>Decision: All data transfer objects (bundles) are frozen dataclasses.</p> <p>Rationale: - Prevents accidental mutation - Ensures thread safety - Supports lazy evaluation - Makes data flow predictable</p> <p>Implementation: <pre><code>from dataclasses import dataclass\nimport polars as pl\n\n@dataclass(frozen=True)\nclass RawDataBundle:\n    counterparties: pl.LazyFrame\n    facilities: pl.LazyFrame\n    loans: pl.LazyFrame\n    collateral: pl.LazyFrame | None = None\n    guarantees: pl.LazyFrame | None = None\n</code></pre></p>"},{"location":"architecture/design-principles/#5-error-accumulation","title":"5. Error Accumulation","text":"<p>Decision: Accumulate errors rather than fail fast.</p> <p>Rationale: - Reports all validation issues at once - Supports audit requirements - Allows partial results - Better user experience</p> <p>Implementation: <pre><code>@dataclass\nclass LazyFrameResult:\n    data: pl.LazyFrame\n    errors: list[CalculationError]\n    warnings: list[CalculationWarning]\n\n    @property\n    def has_errors(self) -&gt; bool:\n        return len(self.errors) &gt; 0\n\n# Usage\nresult = processor.process(exposures, config)\nif result.has_errors:\n    for error in result.errors:\n        logger.error(f\"{error.exposure_id}: {error.message}\")\n</code></pre></p>"},{"location":"architecture/design-principles/#6-factory-methods-for-configuration","title":"6. Factory Methods for Configuration","text":"<p>Decision: Use factory methods rather than direct construction.</p> <p>Rationale: - Self-documenting code - Encapsulates complex initialization - Ensures valid combinations - Easier to use correctly</p> <p>Implementation: <pre><code>class CalculationConfig:\n    @classmethod\n    def crr(cls, reporting_date: date, **kwargs) -&gt; \"CalculationConfig\":\n        \"\"\"Create CRR configuration with appropriate defaults.\"\"\"\n        return cls(\n            framework=RegulatoryFramework.CRR,\n            reporting_date=reporting_date,\n            scaling_factor=Decimal(\"1.06\"),\n            pd_floors=PDFloors.crr(),\n            # ... other CRR defaults\n            **kwargs\n        )\n\n    @classmethod\n    def basel_3_1(cls, reporting_date: date, **kwargs) -&gt; \"CalculationConfig\":\n        \"\"\"Create Basel 3.1 configuration with appropriate defaults.\"\"\"\n        return cls(\n            framework=RegulatoryFramework.BASEL_3_1,\n            reporting_date=reporting_date,\n            scaling_factor=Decimal(\"1.0\"),\n            pd_floors=PDFloors.basel_3_1(),\n            # ... other Basel 3.1 defaults\n            **kwargs\n        )\n</code></pre></p>"},{"location":"architecture/design-principles/#7-hierarchical-join-pattern","title":"7. Hierarchical Join Pattern","text":"<p>Decision: Use iterative joins for hierarchy resolution instead of Python dictionaries.</p> <p>Rationale: - 50-100x performance improvement - Stays within Polars optimization - Handles deep hierarchies efficiently - Avoids Python GIL limitations</p> <p>Anti-pattern (Avoided): <pre><code># BAD: Python dictionary lookup\nparent_dict = {row['id']: row['parent'] for row in df}\nresults = [parent_dict.get(x) for x in ids]\n</code></pre></p> <p>Pattern (Used): <pre><code># GOOD: Polars join\nresult = (\n    df\n    .join(parent_df, left_on=\"parent_id\", right_on=\"id\")\n    .select([\"id\", \"resolved_parent\"])\n)\n</code></pre></p>"},{"location":"architecture/design-principles/#module-organization","title":"Module Organization","text":""},{"location":"architecture/design-principles/#main-entry-point-first","title":"Main Entry Point First","text":"<p>Decision: Place main entry points at the top of modules.</p> <p>Rationale: - Reads like a book - Easy to find key functionality - Follows \"newspaper\" style - Better developer experience</p> <p>Implementation: <pre><code># module.py\n\n# Main entry point at top\ndef calculate_rwa(exposures: Bundle, config: Config) -&gt; Result:\n    \"\"\"Calculate RWA for all exposures.\"\"\"\n    validated = _validate_exposures(exposures)\n    enriched = _apply_crm(validated, config)\n    return _compute_rwa(enriched, config)\n\n\n# Supporting functions below\ndef _validate_exposures(exposures: Bundle) -&gt; Bundle:\n    ...\n\ndef _apply_crm(exposures: Bundle, config: Config) -&gt; Bundle:\n    ...\n\ndef _compute_rwa(exposures: Bundle, config: Config) -&gt; Result:\n    ...\n</code></pre></p>"},{"location":"architecture/design-principles/#clean-imports","title":"Clean Imports","text":"<p>Decision: Organize imports clearly with separation.</p> <pre><code># Standard library\nfrom dataclasses import dataclass\nfrom datetime import date\nfrom decimal import Decimal\n\n# Third-party\nimport polars as pl\nfrom polars_normal_stats import normal_cdf, normal_ppf\n\n# Local - contracts first\nfrom rwa_calc.contracts.bundles import ResultBundle\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# Local - engine components\nfrom rwa_calc.engine.irb.formulas import calculate_k\n</code></pre>"},{"location":"architecture/design-principles/#error-handling-strategy","title":"Error Handling Strategy","text":""},{"location":"architecture/design-principles/#validation-errors","title":"Validation Errors","text":"<p>Collected and reported: <pre><code>errors = []\nif pd &lt; config.pd_floors.minimum:\n    errors.append(ValidationError(\n        field=\"pd\",\n        message=f\"PD {pd} below floor {config.pd_floors.minimum}\"\n    ))\n</code></pre></p>"},{"location":"architecture/design-principles/#calculation-errors","title":"Calculation Errors","text":"<p>Logged with context: <pre><code>try:\n    k = calculate_k(pd, lgd, correlation)\nexcept ValueError as e:\n    errors.append(CalculationError(\n        exposure_id=exposure.id,\n        stage=\"IRB\",\n        message=str(e)\n    ))\n</code></pre></p>"},{"location":"architecture/design-principles/#system-errors","title":"System Errors","text":"<p>Raised immediately: <pre><code>if config is None:\n    raise RuntimeError(\"Configuration must be provided\")\n</code></pre></p>"},{"location":"architecture/design-principles/#testing-philosophy","title":"Testing Philosophy","text":""},{"location":"architecture/design-principles/#test-driven-development","title":"Test-Driven Development","text":"<ol> <li>Write acceptance test (what should happen)</li> <li>Write unit tests (how it should work)</li> <li>Implement to pass tests</li> <li>Refactor with confidence</li> </ol>"},{"location":"architecture/design-principles/#test-organization","title":"Test Organization","text":"<pre><code>tests/\n\u251c\u2500\u2500 acceptance/           # End-to-end scenarios\n\u2502   \u251c\u2500\u2500 crr/             # CRR scenarios\n\u2502   \u2514\u2500\u2500 basel31/         # Basel 3.1 scenarios\n\u251c\u2500\u2500 contracts/           # Interface compliance\n\u251c\u2500\u2500 unit/                # Component tests\n\u2502   \u251c\u2500\u2500 test_loader.py\n\u2502   \u251c\u2500\u2500 test_hierarchy.py\n\u2502   \u2514\u2500\u2500 crr/             # Framework-specific\n\u2514\u2500\u2500 fixtures/            # Test data generation\n</code></pre>"},{"location":"architecture/design-principles/#test-naming","title":"Test Naming","text":"<pre><code>def test_sa_corporate_rated_cqs2_returns_50_percent_risk_weight():\n    \"\"\"Clear description of what is being tested.\"\"\"\n    ...\n\ndef test_sme_factor_tiered_calculation_above_threshold():\n    \"\"\"Documents the specific scenario.\"\"\"\n    ...\n</code></pre>"},{"location":"architecture/design-principles/#documentation-philosophy","title":"Documentation Philosophy","text":""},{"location":"architecture/design-principles/#code-as-documentation","title":"Code as Documentation","text":"<p>Self-documenting names and types: <pre><code>def calculate_maturity_adjustment(\n    pd: float,\n    effective_maturity_years: float\n) -&gt; float:\n    \"\"\"Calculate maturity adjustment factor for IRB.\"\"\"\n    ...\n</code></pre></p>"},{"location":"architecture/design-principles/#regulatory-references","title":"Regulatory References","text":"<p>Link to articles: <pre><code>def calculate_sme_supporting_factor(\n    total_exposure: Decimal,\n    threshold: Decimal = EUR_2_5M\n) -&gt; Decimal:\n    \"\"\"\n    Calculate SME supporting factor per CRR Article 501.\n\n    The factor provides capital relief for SME exposures using\n    a tiered approach based on total exposure amount.\n    \"\"\"\n    ...\n</code></pre></p>"},{"location":"architecture/design-principles/#next-steps","title":"Next Steps","text":"<ul> <li>Pipeline Architecture - Detailed pipeline documentation</li> <li>Data Flow - How data moves through the system</li> <li>Component Overview - Individual components</li> </ul>"},{"location":"architecture/pipeline/","title":"Pipeline Architecture","text":"<p>The RWA calculator processes exposures through a well-defined pipeline with discrete stages. This document details each stage and how they interact.</p>"},{"location":"architecture/pipeline/#pipeline-overview","title":"Pipeline Overview","text":"<pre><code>flowchart TD\n    subgraph Input\n        A[Raw Data Files]\n    end\n\n    subgraph Stage1[Stage 1: Data Loading]\n        B[Loader]\n        B1[RawDataBundle]\n    end\n\n    subgraph Stage2[Stage 2: Hierarchy Resolution]\n        C[Hierarchy Resolver]\n        C1[ResolvedHierarchyBundle]\n    end\n\n    subgraph Stage3[Stage 3: Classification]\n        D[Classifier]\n        D1[ClassifiedExposuresBundle]\n    end\n\n    subgraph Stage4[Stage 4: CRM Processing]\n        E[CRM Processor]\n        E1[CRMAdjustedBundle]\n    end\n\n    subgraph Stage5[Stage 5: RWA Calculation]\n        F[SA Calculator]\n        G[IRB Calculator]\n        H[Slotting Calculator]\n        L[Equity Calculator]\n        F1[SAResultBundle]\n        G1[IRBResultBundle]\n        H1[SlottingResultBundle]\n        L1[EquityResultBundle]\n    end\n\n    subgraph Stage6[Stage 6: Aggregation]\n        I[Aggregator]\n        I1[AggregatedResultBundle]\n    end\n\n    A --&gt; B --&gt; B1\n    B1 --&gt; C --&gt; C1\n    C1 --&gt; D --&gt; D1\n    D1 --&gt; E --&gt; E1\n    E1 --&gt; F --&gt; F1\n    E1 --&gt; G --&gt; G1\n    E1 --&gt; H --&gt; H1\n    E1 --&gt; L --&gt; L1\n    F1 &amp; G1 &amp; H1 &amp; L1 --&gt; I --&gt; I1</code></pre>"},{"location":"architecture/pipeline/#pipeline-orchestration","title":"Pipeline Orchestration","text":"<p>The pipeline is orchestrated by <code>PipelineOrchestrator</code> (see <code>pipeline.py:80-594</code>):</p> <pre><code>from rwa_calc.engine.pipeline import create_pipeline\n\n# Create pipeline with default components\npipeline = create_pipeline()\n\n# Run with configuration\nresult = pipeline.run(config)\n\n# Or with pre-loaded data\nresult = pipeline.run_with_data(raw_data, config)\n</code></pre>"},{"location":"architecture/pipeline/#pipeline-implementation","title":"Pipeline Implementation","text":"<p>For full API documentation, see Pipeline API Reference.</p> Full Implementation (pipeline.py) <pre><code>class PipelineOrchestrator:\n    \"\"\"\n    Orchestrate the complete RWA calculation pipeline.\n\n    Implements PipelineProtocol for:\n    - Full pipeline execution from data loading to final aggregation\n    - Pre-loaded data execution (bypassing loader)\n    - Component dependency management\n    - Error accumulation across stages\n\n    Pipeline stages:\n    1. Loader: Load raw data from files/databases\n    2. HierarchyResolver: Resolve counterparty and facility hierarchies\n    3. Classifier: Classify exposures and assign approaches\n    4. CRMProcessor: Apply credit risk mitigation\n    5. SACalculator: Calculate SA RWA\n    6. IRBCalculator: Calculate IRB RWA\n    7. SlottingCalculator: Calculate Slotting RWA\n    8. OutputAggregator: Combine results, apply floor, generate summaries\n\n    Usage:\n        orchestrator = PipelineOrchestrator(\n            loader=ParquetLoader(base_path),\n            hierarchy_resolver=HierarchyResolver(),\n            classifier=ExposureClassifier(),\n            crm_processor=CRMProcessor(),\n            sa_calculator=SACalculator(),\n            irb_calculator=IRBCalculator(),\n            slotting_calculator=SlottingCalculator(),\n            aggregator=OutputAggregator(),\n        )\n        result = orchestrator.run(config)\n    \"\"\"\n\n    def __init__(\n        self,\n        loader: LoaderProtocol | None = None,\n        hierarchy_resolver: HierarchyResolverProtocol | None = None,\n        classifier: ClassifierProtocol | None = None,\n        crm_processor: CRMProcessorProtocol | None = None,\n        sa_calculator: SACalculatorProtocol | None = None,\n        irb_calculator: IRBCalculatorProtocol | None = None,\n        slotting_calculator: SlottingCalculatorProtocol | None = None,\n        equity_calculator: EquityCalculatorProtocol | None = None,\n        aggregator: OutputAggregatorProtocol | None = None,\n    ) -&gt; None:\n        \"\"\"\n        Initialize pipeline with components.\n\n        Components can be injected for testing or customization.\n        If not provided, defaults will be created on first use.\n\n        Args:\n            loader: Data loader (optional - required for run())\n            hierarchy_resolver: Hierarchy resolver\n            classifier: Exposure classifier\n            crm_processor: CRM processor\n            sa_calculator: SA calculator\n            irb_calculator: IRB calculator\n            slotting_calculator: Slotting calculator\n            equity_calculator: Equity calculator\n            aggregator: Output aggregator\n        \"\"\"\n        self._loader = loader\n        self._hierarchy_resolver = hierarchy_resolver\n        self._classifier = classifier\n        self._crm_processor = crm_processor\n        self._sa_calculator = sa_calculator\n        self._irb_calculator = irb_calculator\n        self._slotting_calculator = slotting_calculator\n        self._equity_calculator = equity_calculator\n        self._aggregator = aggregator\n        self._errors: list[PipelineError] = []\n\n    # =========================================================================\n    # Public API\n    # =========================================================================\n\n    def run(self, config: CalculationConfig) -&gt; AggregatedResultBundle:\n        \"\"\"\n        Execute the complete RWA calculation pipeline.\n\n        Requires a loader to be configured.\n\n        Args:\n            config: Calculation configuration\n\n        Returns:\n            AggregatedResultBundle with all results and audit trail\n\n        Raises:\n            ValueError: If no loader is configured\n        \"\"\"\n        if self._loader is None:\n            raise ValueError(\n                \"No loader configured. Use run_with_data() or provide a loader.\"\n            )\n\n        # Reset errors for new run\n        self._errors = []\n\n        # Stage 1: Load data\n        try:\n            raw_data = self._loader.load()\n        except Exception as e:\n            self._errors.append(PipelineError(\n                stage=\"loader\",\n                error_type=\"load_error\",\n                message=str(e),\n            ))\n            return self._create_error_result()\n\n        return self.run_with_data(raw_data, config)\n\n    def run_with_data(\n        self,\n        data: RawDataBundle,\n        config: CalculationConfig,\n    ) -&gt; AggregatedResultBundle:\n        \"\"\"\n        Execute pipeline with pre-loaded data.\n\n        Bypasses the loader stage, useful for testing or\n        when data is already available.\n\n        Args:\n            data: Pre-loaded raw data bundle\n            config: Calculation configuration\n\n        Returns:\n            AggregatedResultBundle with all results and audit trail\n        \"\"\"\n        # Reset errors for new run\n        self._errors = []\n\n        # Ensure components are initialized\n        self._ensure_components_initialized()\n\n        # Validate input data values\n        self._validate_input_data(data)\n\n        # Stage 2: Resolve hierarchies\n        resolved = self._run_hierarchy_resolver(data, config)\n        if resolved is None:\n            return self._create_error_result()\n\n        # Stage 3: Classify exposures\n        classified = self._run_classifier(resolved, config)\n        if classified is None:\n            return self._create_error_result()\n\n        # Stage 4: Apply CRM\n        crm_adjusted = self._run_crm_processor(classified, config)\n        if crm_adjusted is None:\n            return self._create_error_result()\n\n        # Stage 5-8: Run calculators in parallel (conceptually)\n        sa_bundle = self._run_sa_calculator(crm_adjusted, config)\n        irb_bundle = self._run_irb_calculator(crm_adjusted, config)\n        slotting_bundle = self._run_slotting_calculator(crm_adjusted, config)\n        equity_bundle = self._run_equity_calculator(crm_adjusted, config)\n\n        # Stage 9: Aggregate results\n        result = self._run_aggregator(\n            sa_bundle,\n            irb_bundle,\n            slotting_bundle,\n            equity_bundle,\n            config,\n        )\n\n        # Add pipeline errors to result\n        if self._errors:\n            all_errors = list(result.errors) + [\n                self._convert_pipeline_error(e) for e in self._errors\n            ]\n            result = AggregatedResultBundle(\n                results=result.results,\n                sa_results=result.sa_results,\n                irb_results=result.irb_results,\n</code></pre>"},{"location":"architecture/pipeline/#stage-1-data-loading","title":"Stage 1: Data Loading","text":""},{"location":"architecture/pipeline/#purpose","title":"Purpose","text":"<p>Load raw data from Parquet/CSV files into LazyFrames.</p>"},{"location":"architecture/pipeline/#input","title":"Input","text":"<p>File paths to data files.</p>"},{"location":"architecture/pipeline/#output","title":"Output","text":"<p><code>RawDataBundle</code> containing: - <code>counterparties</code>: Counterparty master data - <code>facilities</code>: Credit facility data - <code>loans</code>: Individual loan/draw data - <code>contingents</code>: Off-balance sheet items - <code>collateral</code>: Collateral information - <code>guarantees</code>: Guarantee data - <code>provisions</code>: Provision allocations - <code>ratings</code>: External and internal ratings - <code>org_mapping</code>: Organization hierarchy - <code>lending_mapping</code>: Retail lending groups</p>"},{"location":"architecture/pipeline/#implementation","title":"Implementation","text":"<pre><code>class ParquetLoader:\n    def load(self, path: Path) -&gt; RawDataBundle:\n        return RawDataBundle(\n            counterparties=pl.scan_parquet(path / \"counterparties.parquet\"),\n            facilities=pl.scan_parquet(path / \"facilities.parquet\"),\n            loans=pl.scan_parquet(path / \"loans.parquet\"),\n            # ... other data sources\n        )\n</code></pre>"},{"location":"architecture/pipeline/#validation","title":"Validation","text":"<ul> <li>Schema validation against defined schemas</li> <li>Required field checks</li> <li>Data type validation</li> </ul>"},{"location":"architecture/pipeline/#stage-2-hierarchy-resolution","title":"Stage 2: Hierarchy Resolution","text":""},{"location":"architecture/pipeline/#purpose_1","title":"Purpose","text":"<p>Resolve counterparty and facility hierarchies, inherit ratings, unify exposures, and prepare enriched data for classification.</p>"},{"location":"architecture/pipeline/#input_1","title":"Input","text":"<p><code>RawDataBundle</code></p>"},{"location":"architecture/pipeline/#output_1","title":"Output","text":"<p><code>ResolvedHierarchyBundle</code> with: - <code>exposures</code>: Unified LazyFrame (loans + contingents + facility undrawn) - <code>counterparty_lookup</code>: Enriched counterparties with hierarchy metadata and inherited ratings - <code>collateral</code>, <code>guarantees</code>, <code>provisions</code>: FX-converted CRM data - <code>lending_group_totals</code>: Aggregated group exposure for retail threshold testing - <code>hierarchy_errors</code>: Accumulated non-blocking errors</p>"},{"location":"architecture/pipeline/#processing-steps","title":"Processing Steps","text":"<pre><code>Step 1: Build counterparty hierarchy lookup\n  \u251c\u2500\u2500 _build_ultimate_parent_lazy()      \u2192 traverse org_mappings (up to 10 levels)\n  \u251c\u2500\u2500 _build_rating_inheritance_lazy()   \u2192 inherit ratings (own \u2192 parent \u2192 unrated)\n  \u2514\u2500\u2500 _enrich_counterparties_with_hierarchy() \u2192 add hierarchy metadata\n\nStep 2: Unify exposures\n  \u251c\u2500\u2500 Standardise loans         \u2192 exposure_type = \"loan\"\n  \u251c\u2500\u2500 Standardise contingents   \u2192 exposure_type = \"contingent\"\n  \u251c\u2500\u2500 _build_facility_root_lookup()       \u2192 traverse facility-to-facility hierarchies\n  \u251c\u2500\u2500 _calculate_facility_undrawn()       \u2192 limit - sum(descendant drawn amounts)\n  \u2514\u2500\u2500 pl.concat(all exposure types)       \u2192 single unified LazyFrame\n\nStep 2a: FX conversion          \u2192 convert all monetary values to base currency\nStep 2b: Add collateral LTV     \u2192 direct \u2192 facility \u2192 counterparty priority\n\nStep 3: Residential property coverage\n  \u2514\u2500\u2500 Separate residential vs all-property collateral for threshold exclusion\n\nStep 4: Lending group totals\n  \u2514\u2500\u2500 Aggregate by group, exclude residential from retail threshold (CRR Art. 123(c))\n\nStep 5: Add lending group totals to exposures\n</code></pre>"},{"location":"architecture/pipeline/#counterparty-hierarchy","title":"Counterparty Hierarchy","text":"<p>The hierarchy resolution uses iterative Polars LazyFrame joins for performance. See <code>hierarchy.py:258-327</code> for the full implementation.</p> <p>Build ultimate parent mapping using iterative joins.</p> <p>Returns LazyFrame with columns: - counterparty_reference: The entity - ultimate_parent_reference: Its ultimate parent - hierarchy_depth: Number of levels traversed</p> Actual Implementation (hierarchy.py) <pre><code>            ultimate_parent_mappings=ultimate_parents,\n            rating_inheritance=rating_info,\n        ), errors\n\n    def _build_ultimate_parent_lazy(\n        self,\n        org_mappings: pl.LazyFrame,\n        max_depth: int = 10,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build ultimate parent mapping using iterative joins.\n\n        Returns LazyFrame with columns:\n        - counterparty_reference: The entity\n        - ultimate_parent_reference: Its ultimate parent\n        - hierarchy_depth: Number of levels traversed\n        \"\"\"\n        # Get unique child references\n        entities = org_mappings.select(\n            pl.col(\"child_counterparty_reference\").alias(\"counterparty_reference\")\n        ).unique()\n\n        # Parent lookup for joins (alias child column to avoid name collision)\n        parent_map = org_mappings.select([\n            pl.col(\"child_counterparty_reference\").alias(\"_lookup_child\"),\n            pl.col(\"parent_counterparty_reference\").alias(\"_lookup_parent\"),\n        ])\n\n        # Initialize: each entity's current parent is its direct parent (or self)\n        # Depth starts at 1 for entities with a parent, 0 for root entities\n        result = entities.join(\n            parent_map,\n            left_on=\"counterparty_reference\",\n            right_on=\"_lookup_child\",\n            how=\"left\",\n        ).with_columns([\n            pl.coalesce(\n                pl.col(\"_lookup_parent\"),\n                pl.col(\"counterparty_reference\")\n            ).alias(\"current_parent\"),\n            pl.when(pl.col(\"_lookup_parent\").is_not_null())\n            .then(pl.lit(1).cast(pl.Int32))\n            .otherwise(pl.lit(0).cast(pl.Int32))\n            .alias(\"depth\"),\n        ]).select([\n            pl.col(\"counterparty_reference\"),\n            pl.col(\"current_parent\"),\n            pl.col(\"depth\"),\n        ])\n\n        # Iteratively traverse upward - each iteration adds one level of depth\n        for _ in range(max_depth):\n            result = result.join(\n                parent_map,\n                left_on=\"current_parent\",\n                right_on=\"_lookup_child\",\n                how=\"left\",\n            ).with_columns([\n                pl.coalesce(pl.col(\"_lookup_parent\"), pl.col(\"current_parent\")).alias(\"current_parent\"),\n                pl.when(pl.col(\"_lookup_parent\").is_not_null())\n                .then(pl.col(\"depth\") + 1)\n                .otherwise(pl.col(\"depth\"))\n                .alias(\"depth\"),\n            ]).select([\n                pl.col(\"counterparty_reference\"),\n                pl.col(\"current_parent\"),\n                pl.col(\"depth\"),\n            ])\n\n        return result.select([\n</code></pre>"},{"location":"architecture/pipeline/#rating-inheritance","title":"Rating Inheritance","text":"<p>Ratings are inherited from parent entities when not directly available. See <code>hierarchy.py:329-431</code>.</p> <p>The inheritance priority is: 1. Entity's own rating 2. Ultimate parent's rating 3. Mark as unrated</p> Actual Implementation (hierarchy.py) <pre><code>            pl.col(\"current_parent\").alias(\"ultimate_parent_reference\"),\n            pl.col(\"depth\").alias(\"hierarchy_depth\"),\n        ])\n\n    def _build_rating_inheritance_lazy(\n        self,\n        counterparties: pl.LazyFrame,\n        ratings: pl.LazyFrame,\n        ultimate_parents: pl.LazyFrame,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build rating lookup with inheritance via LazyFrame joins.\n\n        Returns LazyFrame with columns:\n        - counterparty_reference: The entity\n        - cqs, pd, rating_value, rating_agency, rating_type, rating_date: Rating info\n        - inherited: Whether the rating was inherited\n        - source_counterparty: Where the rating came from\n        - inheritance_reason: own_rating, parent_rating, or unrated\n        \"\"\"\n        # Get most recent rating per counterparty (sort by date then reference for consistency)\n        first_ratings = (\n            ratings\n            .sort([\"rating_date\", \"rating_reference\"], descending=[True, True])\n            .group_by(\"counterparty_reference\")\n            .first()\n            .select([\n                pl.col(\"counterparty_reference\").alias(\"rated_cp\"),\n                pl.col(\"rating_type\"),\n                pl.col(\"rating_agency\"),\n                pl.col(\"rating_value\"),\n                pl.col(\"cqs\"),\n                pl.col(\"pd\"),\n                pl.col(\"rating_date\"),\n            ])\n        )\n\n        # Start with all counterparties\n        result = counterparties.select(\"counterparty_reference\")\n\n        # Join with own ratings\n        result = result.join(\n            first_ratings,\n            left_on=\"counterparty_reference\",\n            right_on=\"rated_cp\",\n            how=\"left\",\n        )\n\n        # Join with ultimate parents\n        result = result.join(\n            ultimate_parents.select([\n                pl.col(\"counterparty_reference\").alias(\"_cp\"),\n                pl.col(\"ultimate_parent_reference\"),\n            ]),\n            left_on=\"counterparty_reference\",\n            right_on=\"_cp\",\n            how=\"left\",\n        )\n\n        # Join to get parent's ratings\n        parent_ratings = first_ratings.select([\n            pl.col(\"rated_cp\").alias(\"parent_cp\"),\n            pl.col(\"cqs\").alias(\"parent_cqs\"),\n            pl.col(\"pd\").alias(\"parent_pd\"),\n            pl.col(\"rating_value\").alias(\"parent_rating_value\"),\n            pl.col(\"rating_agency\").alias(\"parent_rating_agency\"),\n            pl.col(\"rating_type\").alias(\"parent_rating_type\"),\n            pl.col(\"rating_date\").alias(\"parent_rating_date\"),\n        ])\n\n        result = result.join(\n            parent_ratings,\n            left_on=\"ultimate_parent_reference\",\n            right_on=\"parent_cp\",\n            how=\"left\",\n        )\n\n        # Resolve inheritance with coalesce\n        has_own_rating = pl.col(\"cqs\").is_not_null() | pl.col(\"rating_value\").is_not_null()\n        has_parent_rating = pl.col(\"parent_cqs\").is_not_null() | pl.col(\"parent_rating_value\").is_not_null()\n\n        result = result.with_columns([\n            pl.coalesce(pl.col(\"cqs\"), pl.col(\"parent_cqs\")).alias(\"cqs\"),\n            pl.coalesce(pl.col(\"pd\"), pl.col(\"parent_pd\")).alias(\"pd\"),\n            pl.coalesce(pl.col(\"rating_value\"), pl.col(\"parent_rating_value\")).alias(\"rating_value\"),\n            pl.coalesce(pl.col(\"rating_agency\"), pl.col(\"parent_rating_agency\")).alias(\"rating_agency\"),\n            pl.coalesce(pl.col(\"rating_type\"), pl.col(\"parent_rating_type\")).alias(\"rating_type\"),\n            pl.coalesce(pl.col(\"rating_date\"), pl.col(\"parent_rating_date\")).alias(\"rating_date\"),\n\n            pl.when(has_own_rating).then(pl.lit(False))\n            .when(has_parent_rating).then(pl.lit(True))\n            .otherwise(pl.lit(False)).alias(\"inherited\"),\n\n            pl.when(has_own_rating).then(pl.col(\"counterparty_reference\"))\n            .when(has_parent_rating).then(pl.col(\"ultimate_parent_reference\"))\n            .otherwise(pl.lit(None).cast(pl.String)).alias(\"source_counterparty\"),\n\n            pl.when(has_own_rating).then(pl.lit(\"own_rating\"))\n            .when(has_parent_rating).then(pl.lit(\"parent_rating\"))\n            .otherwise(pl.lit(\"unrated\")).alias(\"inheritance_reason\"),\n        ])\n\n        # Drop intermediate columns\n</code></pre>"},{"location":"architecture/pipeline/#facility-hierarchy","title":"Facility Hierarchy","text":"<p>Facilities can form multi-level hierarchies (e.g., master facility \u2192 sub-facilities). The resolver traverses these using the same iterative join pattern as counterparty hierarchies. See <code>hierarchy.py:433-537</code>.</p> <p>Key behaviour: - Facility-to-facility edges identified from <code>facility_mappings</code> where <code>child_type = \"facility\"</code> - Traverses up to 10 levels to find the root facility for each sub-facility - Drawn amounts from all descendant loans are aggregated to the root facility - Sub-facilities are excluded from producing their own undrawn exposure records - Only root/standalone facilities with <code>undrawn_amount &gt; 0</code> generate <code>facility_undrawn</code> exposures</p> Actual Implementation (hierarchy.py) <pre><code>            \"counterparty_reference\", \"cqs\", \"pd\", \"rating_value\", \"rating_agency\",\n            \"rating_type\", \"rating_date\", \"inherited\", \"source_counterparty\", \"inheritance_reason\",\n        ])\n\n    def _build_facility_root_lookup(\n        self,\n        facility_mappings: pl.LazyFrame,\n        max_depth: int = 10,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Build root facility lookup for multi-level facility hierarchies.\n\n        Mirrors _build_ultimate_parent_lazy but for facility-to-facility relationships.\n        Iteratively traverses upward through facility hierarchy to find the root facility.\n\n        Args:\n            facility_mappings: Facility mappings with parent_facility_reference,\n                             child_reference, and child_type/node_type columns\n            max_depth: Maximum hierarchy depth to traverse\n\n        Returns:\n            LazyFrame with columns:\n            - child_facility_reference: The sub-facility\n            - root_facility_reference: Its ultimate root facility\n            - facility_hierarchy_depth: Number of levels traversed\n        \"\"\"\n        empty_result = pl.LazyFrame(schema={\n            \"child_facility_reference\": pl.String,\n            \"root_facility_reference\": pl.String,\n            \"facility_hierarchy_depth\": pl.Int32,\n        })\n\n        # Detect type column (child_type / node_type / neither)\n        mapping_schema = facility_mappings.collect_schema()\n        mapping_cols = set(mapping_schema.names())\n\n        if \"child_type\" in mapping_cols:\n            type_col = \"child_type\"\n        elif \"node_type\" in mapping_cols:\n            type_col = \"node_type\"\n        else:\n            return empty_result\n\n        # Filter to facility\u2192facility relationships only\n        facility_edges = facility_mappings.filter(\n            pl.col(type_col).fill_null(\"\").str.to_lowercase() == \"facility\"\n        ).select([\n            pl.col(\"child_reference\").alias(\"child_facility_reference\"),\n            pl.col(\"parent_facility_reference\"),\n        ]).unique()\n\n        # Check if there are any facility edges\n        if facility_edges.head(1).collect().height == 0:\n            return empty_result\n\n        # Parent lookup for iterative joins\n        parent_map = facility_edges.select([\n            pl.col(\"child_facility_reference\").alias(\"_lookup_child\"),\n            pl.col(\"parent_facility_reference\").alias(\"_lookup_parent\"),\n        ])\n\n        # Initialize: each sub-facility's current parent is its direct parent\n        result = facility_edges.join(\n            parent_map,\n            left_on=\"parent_facility_reference\",\n            right_on=\"_lookup_child\",\n            how=\"left\",\n        ).with_columns([\n            pl.coalesce(\n                pl.col(\"_lookup_parent\"),\n                pl.col(\"parent_facility_reference\"),\n            ).alias(\"current_root\"),\n            pl.when(pl.col(\"_lookup_parent\").is_not_null())\n            .then(pl.lit(2).cast(pl.Int32))\n            .otherwise(pl.lit(1).cast(pl.Int32))\n            .alias(\"depth\"),\n        ]).select([\n            pl.col(\"child_facility_reference\"),\n            pl.col(\"current_root\"),\n            pl.col(\"depth\"),\n        ])\n\n        # Iteratively traverse upward\n        for _ in range(max_depth - 1):\n            result = result.join(\n                parent_map,\n                left_on=\"current_root\",\n                right_on=\"_lookup_child\",\n                how=\"left\",\n            ).with_columns([\n                pl.coalesce(\n                    pl.col(\"_lookup_parent\"),\n                    pl.col(\"current_root\"),\n                ).alias(\"current_root\"),\n                pl.when(pl.col(\"_lookup_parent\").is_not_null())\n                .then(pl.col(\"depth\") + 1)\n                .otherwise(pl.col(\"depth\"))\n                .alias(\"depth\"),\n            ]).select([\n                pl.col(\"child_facility_reference\"),\n                pl.col(\"current_root\"),\n                pl.col(\"depth\"),\n            ])\n\n        return result.select([\n</code></pre>"},{"location":"architecture/pipeline/#stage-3-classification","title":"Stage 3: Classification","text":""},{"location":"architecture/pipeline/#purpose_2","title":"Purpose","text":"<p>Assign exposure classes and determine calculation approach.</p>"},{"location":"architecture/pipeline/#input_2","title":"Input","text":"<p><code>ResolvedHierarchyBundle</code></p>"},{"location":"architecture/pipeline/#output_2","title":"Output","text":"<p><code>ClassifiedExposuresBundle</code> with: - <code>exposure_class</code>: Regulatory exposure class - <code>approach</code>: SA, F-IRB, A-IRB, or Slotting - Grouped exposures by approach</p>"},{"location":"architecture/pipeline/#classification-logic","title":"Classification Logic","text":"<p>The classifier assigns exposure classes and calculation approaches. See <code>classifier.py:195-244</code> for the core classification logic.</p> <p>Classification Priority Order</p> <ol> <li>Central Govt / Central Bank: Government entities, central banks</li> <li>RGLA: Regional governments and local authorities</li> <li>PSE: Public sector entities</li> <li>MDB: Multilateral development banks</li> <li>Institution: Banks, regulated financial institutions, CCPs</li> <li>Retail: Individuals, small businesses meeting retail criteria</li> <li>Corporate: Non-financial corporates</li> <li>Specialised Lending: Project finance, object finance, etc.</li> </ol> Actual Implementation (classifier.py) <pre><code>        )\n\n        # Step 6a: Clear internal LGD for FIRB exposures\n        # FIRB uses supervisory LGD values, not internal models\n        classified = self._clear_lgd_for_firb(classified)\n\n        # Step 7: Add classification audit trail\n        classified = self._add_classification_audit(classified)\n\n        # Step 7a: Enrich slotting exposures with slotting metadata\n        # This must happen before splitting so metadata flows through CRM processor\n        classified = self._enrich_slotting_exposures(classified)\n\n        # Strategic collect to materialize all classification processing\n        # This breaks up the complex query plan for better downstream performance\n        classified = classified.collect().lazy()\n\n        # Step 8: Split by approach\n        sa_exposures = self._filter_by_approach(classified, ApproachType.SA)\n        irb_exposures = self._filter_irb_exposures(classified)\n        slotting_exposures = self._filter_by_approach(classified, ApproachType.SLOTTING)\n\n        # Build classification audit\n        classification_audit = self._build_audit_trail(classified)\n\n        return ClassifiedExposuresBundle(\n            all_exposures=classified,\n            sa_exposures=sa_exposures,\n            irb_exposures=irb_exposures,\n            slotting_exposures=slotting_exposures,\n            equity_exposures=data.equity_exposures,\n            collateral=data.collateral,\n            guarantees=data.guarantees,\n            provisions=data.provisions,\n            counterparty_lookup=data.counterparty_lookup,\n            classification_audit=classification_audit,\n            classification_errors=errors,\n        )\n\n    def _add_counterparty_attributes(\n        self,\n        exposures: pl.LazyFrame,\n        counterparties: pl.LazyFrame,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Add counterparty attributes needed for classification.\n\n        Joins exposures with counterparty data to get:\n        - entity_type (single source of truth for exposure class)\n        - annual_revenue (for SME check)\n</code></pre>"},{"location":"architecture/pipeline/#rwa_calc.engine.classifier.ExposureClassifier","title":"<code>rwa_calc.engine.classifier.ExposureClassifier</code>","text":"<p>Classify exposures by exposure class and approach.</p> <p>Implements ClassifierProtocol for: - Mapping counterparty types to exposure classes - Checking SME criteria (turnover thresholds) - Checking retail criteria (aggregate exposure thresholds) - Determining IRB eligibility based on permissions - Identifying specialised lending for slotting - Splitting exposures by calculation approach</p> <p>All operations use Polars LazyFrames for deferred execution.</p>"},{"location":"architecture/pipeline/#rwa_calc.engine.classifier.ExposureClassifier.classify","title":"<code>classify(data, config)</code>","text":"<p>Classify exposures and split by approach.</p> <p>Parameters:</p> Name Type Description Default <code>data</code> <code>ResolvedHierarchyBundle</code> <p>Hierarchy-resolved data from HierarchyResolver</p> required <code>config</code> <code>CalculationConfig</code> <p>Calculation configuration</p> required <p>Returns:</p> Type Description <code>ClassifiedExposuresBundle</code> <p>ClassifiedExposuresBundle with exposures split by approach</p>"},{"location":"architecture/pipeline/#stage-4-crm-processing","title":"Stage 4: CRM Processing","text":""},{"location":"architecture/pipeline/#purpose_3","title":"Purpose","text":"<p>Apply credit risk mitigation: collateral, guarantees, provisions.</p>"},{"location":"architecture/pipeline/#input_3","title":"Input","text":"<p><code>ClassifiedExposuresBundle</code> plus CRM data</p>"},{"location":"architecture/pipeline/#output_3","title":"Output","text":"<p><code>CRMAdjustedBundle</code> with: - Adjusted EAD values - Applied haircuts - Substituted risk weights (guarantees) - Provision adjustments</p>"},{"location":"architecture/pipeline/#processing-order","title":"Processing Order","text":"<ol> <li>Apply specific provisions (reduce EAD)</li> <li>Apply collateral with haircuts</li> <li>Apply guarantees (substitution approach)</li> </ol> <pre><code>def process_crm(\n    exposures: pl.LazyFrame,\n    collateral: pl.LazyFrame,\n    guarantees: pl.LazyFrame,\n    provisions: pl.LazyFrame,\n    config: CalculationConfig\n) -&gt; pl.LazyFrame:\n    \"\"\"Apply CRM in correct order.\"\"\"\n\n    # Step 1: Provisions\n    after_provisions = apply_provisions(exposures, provisions)\n\n    # Step 2: Collateral\n    after_collateral = apply_collateral_haircuts(\n        after_provisions, collateral, config\n    )\n\n    # Step 3: Guarantees\n    after_guarantees = apply_guarantee_substitution(\n        after_collateral, guarantees, config\n    )\n\n    return after_guarantees\n</code></pre>"},{"location":"architecture/pipeline/#stage-5-rwa-calculation","title":"Stage 5: RWA Calculation","text":""},{"location":"architecture/pipeline/#purpose_4","title":"Purpose","text":"<p>Calculate RWA using appropriate approach for each exposure.</p>"},{"location":"architecture/pipeline/#sa-calculator","title":"SA Calculator","text":"<pre><code>class SACalculator:\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig\n    ) -&gt; SAResultBundle:\n        \"\"\"Calculate SA RWA.\"\"\"\n        result = (\n            exposures\n            .with_columns(\n                risk_weight=self._lookup_risk_weight(\n                    pl.col(\"exposure_class\"),\n                    pl.col(\"cqs\")\n                )\n            )\n            .with_columns(\n                rwa=pl.col(\"ead\") * pl.col(\"risk_weight\")\n            )\n        )\n\n        # Apply supporting factors (CRR only)\n        if config.framework == RegulatoryFramework.CRR:\n            result = self._apply_supporting_factors(result, config)\n\n        return SAResultBundle(data=result)\n</code></pre>"},{"location":"architecture/pipeline/#irb-calculator","title":"IRB Calculator","text":"<pre><code>class IRBCalculator:\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig\n    ) -&gt; IRBResultBundle:\n        \"\"\"Calculate IRB RWA.\"\"\"\n        result = (\n            exposures\n            .with_columns(\n                # Apply PD floor\n                pd_floored=pl.max_horizontal(\n                    pl.col(\"pd\"),\n                    pl.lit(config.pd_floors.get_floor(pl.col(\"exposure_class\")))\n                )\n            )\n            .with_columns(\n                # Calculate correlation\n                correlation=self._calculate_correlation(\n                    pl.col(\"exposure_class\"),\n                    pl.col(\"pd_floored\"),\n                    pl.col(\"turnover\")\n                ),\n                # Calculate maturity adjustment\n                ma=self._calculate_maturity_adjustment(\n                    pl.col(\"pd_floored\"),\n                    pl.col(\"effective_maturity\")\n                )\n            )\n            .with_columns(\n                # Calculate K\n                k=self._calculate_k(\n                    pl.col(\"pd_floored\"),\n                    pl.col(\"lgd\"),\n                    pl.col(\"correlation\")\n                )\n            )\n            .with_columns(\n                # Calculate RWA\n                rwa=pl.col(\"k\") * 12.5 * pl.col(\"ead\") * pl.col(\"ma\") *\n                    config.scaling_factor\n            )\n        )\n\n        return IRBResultBundle(data=result)\n</code></pre>"},{"location":"architecture/pipeline/#slotting-calculator","title":"Slotting Calculator","text":"<pre><code>class SlottingCalculator:\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig\n    ) -&gt; SlottingResultBundle:\n        \"\"\"Calculate Slotting RWA.\"\"\"\n        result = (\n            exposures\n            .with_columns(\n                risk_weight=self._lookup_slotting_weight(\n                    pl.col(\"lending_type\"),\n                    pl.col(\"slotting_category\"),\n                    config.framework\n                )\n            )\n            .with_columns(\n                rwa=pl.col(\"ead\") * pl.col(\"risk_weight\")\n            )\n        )\n\n        return SlottingResultBundle(data=result)\n</code></pre>"},{"location":"architecture/pipeline/#stage-6-aggregation","title":"Stage 6: Aggregation","text":""},{"location":"architecture/pipeline/#purpose_5","title":"Purpose","text":"<p>Combine results, apply output floor, produce final output.</p>"},{"location":"architecture/pipeline/#input_4","title":"Input","text":"<p>Result bundles from all calculators</p>"},{"location":"architecture/pipeline/#output_4","title":"Output","text":"<p><code>AggregatedResultBundle</code> with: - Total RWA - RWA by approach - RWA by exposure class - Floor impact (Basel 3.1) - Detailed breakdown</p>"},{"location":"architecture/pipeline/#output-floor-basel-31","title":"Output Floor (Basel 3.1)","text":"<pre><code>def apply_output_floor(\n    irb_rwa: pl.LazyFrame,\n    sa_rwa: pl.LazyFrame,\n    floor_percentage: float\n) -&gt; pl.LazyFrame:\n    \"\"\"Apply output floor to IRB results.\"\"\"\n    return (\n        irb_rwa\n        .join(sa_rwa, on=\"exposure_id\", suffix=\"_sa\")\n        .with_columns(\n            floor=pl.col(\"rwa_sa\") * floor_percentage,\n            rwa_floored=pl.max_horizontal(\n                pl.col(\"rwa\"),\n                pl.col(\"rwa_sa\") * floor_percentage\n            )\n        )\n    )\n</code></pre>"},{"location":"architecture/pipeline/#error-handling","title":"Error Handling","text":"<p>Each stage accumulates errors:</p> <pre><code>@dataclass\nclass StageResult:\n    data: pl.LazyFrame\n    errors: list[CalculationError]\n    warnings: list[CalculationWarning]\n\n# Pipeline accumulates across stages\nall_errors = []\nall_errors.extend(loader_result.errors)\nall_errors.extend(hierarchy_result.errors)\n# ... etc.\n</code></pre>"},{"location":"architecture/pipeline/#next-steps","title":"Next Steps","text":"<ul> <li>Data Flow - Detailed data flow documentation</li> <li>Component Overview - Individual component details</li> <li>API Reference - Pipeline API documentation</li> </ul>"},{"location":"data-model/","title":"Data Model","text":"<p>This section documents the data schemas used throughout the RWA calculator, including input requirements, intermediate structures, and output formats.</p>"},{"location":"data-model/#overview","title":"Overview","text":"<p>The calculator uses Polars schemas to define and validate data at each stage:</p> <pre><code>flowchart LR\n    A[Input Schemas] --&gt; B[Intermediate Schemas] --&gt; C[Output Schemas]</code></pre>"},{"location":"data-model/#schema-categories","title":"Schema Categories","text":""},{"location":"data-model/#input-schemas","title":"Input Schemas","text":"<p>Define the structure of data loaded from external sources:</p> <ul> <li>Input Schemas</li> <li>Counterparty Schema</li> <li>Facility Schema</li> <li>Loan Schema</li> <li>Contingent Schema</li> <li>Collateral Schema</li> <li>Guarantee Schema</li> <li>Provision Schema</li> <li>Rating Schema</li> <li>FX Rates Schema</li> <li>Specialised Lending Schema</li> <li>Equity Exposure Schema</li> <li>Mapping Schemas (Facility, Org, Lending)</li> </ul>"},{"location":"data-model/#data-validation","title":"Data Validation","text":"<p>Validation rules and troubleshooting:</p> <ul> <li>Data Validation Guide</li> <li>Schema Validation Functions</li> <li>Business Rule Validators</li> <li>Common Errors and Fixes</li> <li>Debugging Tips</li> </ul>"},{"location":"data-model/#intermediate-schemas","title":"Intermediate Schemas","text":"<p>Define internal data structures used during processing:</p> <ul> <li>Intermediate Schemas</li> <li>Resolved Hierarchy Schema</li> <li>Classified Exposure Schema</li> <li>CRM Adjusted Schema</li> </ul>"},{"location":"data-model/#output-schemas","title":"Output Schemas","text":"<p>Define the structure of calculation results:</p> <ul> <li>Output Schemas</li> <li>SA Result Schema</li> <li>IRB Result Schema</li> <li>Slotting Result Schema</li> <li>Aggregated Result Schema</li> </ul>"},{"location":"data-model/#regulatory-tables","title":"Regulatory Tables","text":"<p>Lookup tables for risk weights and parameters:</p> <ul> <li>Regulatory Tables</li> <li>Risk Weight Tables</li> <li>CCF Tables</li> <li>Haircut Tables</li> <li>Slotting Tables</li> <li>F-IRB LGD Tables</li> </ul>"},{"location":"data-model/#schema-usage","title":"Schema Usage","text":""},{"location":"data-model/#validation","title":"Validation","text":"<pre><code>from rwa_calc.data.schemas import COUNTERPARTY_SCHEMA\nfrom rwa_calc.contracts.validation import validate_schema\n\n# Validate data against schema\nerrors = validate_schema(counterparty_df, COUNTERPARTY_SCHEMA)\n\nif errors:\n    for error in errors:\n        print(f\"Validation error: {error}\")\n</code></pre>"},{"location":"data-model/#type-checking","title":"Type Checking","text":"<pre><code>import polars as pl\nfrom rwa_calc.data.schemas import FACILITY_SCHEMA\n\n# Create DataFrame with explicit schema\nfacilities = pl.DataFrame({\n    \"facility_id\": [\"F001\", \"F002\"],\n    \"counterparty_id\": [\"C001\", \"C001\"],\n    \"committed_amount\": [1_000_000.0, 500_000.0],\n}).cast(FACILITY_SCHEMA)\n</code></pre>"},{"location":"data-model/#data-types","title":"Data Types","text":"Polars Type Python Type Usage <code>pl.Utf8</code> <code>str</code> IDs, names, codes <code>pl.Float64</code> <code>float</code> Amounts, rates, weights <code>pl.Int32</code> <code>int</code> Counts, CQS values <code>pl.Boolean</code> <code>bool</code> Flags, indicators <code>pl.Date</code> <code>date</code> Dates <code>pl.Datetime</code> <code>datetime</code> Timestamps"},{"location":"data-model/#nullable-fields","title":"Nullable Fields","text":"<p>Optional fields are marked with <code>| None</code> in schemas:</p> <pre><code>COUNTERPARTY_SCHEMA = {\n    \"counterparty_id\": pl.Utf8,          # Required\n    \"annual_turnover\": pl.Float64,        # Optional (can be null)\n    \"parent_id\": pl.Utf8,                 # Optional\n}\n</code></pre>"},{"location":"data-model/#next-steps","title":"Next Steps","text":"<ul> <li>Input Schemas - Required input data formats</li> <li>Data Validation Guide - Validation and troubleshooting</li> <li>Output Schemas - Result data formats</li> <li>Regulatory Tables - Lookup table reference</li> </ul>"},{"location":"data-model/data-validation/","title":"Data Validation Guide","text":"<p>This guide explains how data validation works in the RWA calculator, common validation errors, and how to troubleshoot data issues.</p>"},{"location":"data-model/data-validation/#overview","title":"Overview","text":"<p>The RWA calculator validates input data at multiple stages:</p> <ol> <li>Load-time validation - Schema checks when data is loaded</li> <li>Pipeline boundary validation - Checks at each processing stage</li> <li>Business rule validation - Domain-specific constraints (PD/LGD ranges, etc.)</li> </ol> <p>Validation is performed without materialising data where possible, using Polars LazyFrame schema inspection for efficiency.</p>"},{"location":"data-model/data-validation/#validation-functions","title":"Validation Functions","text":"<p>The validation utilities are in <code>src/rwa_calc/contracts/validation.py</code>.</p>"},{"location":"data-model/data-validation/#schema-validation","title":"Schema Validation","text":"<p>Validates that a LazyFrame has the expected columns and types:</p> <pre><code>from rwa_calc.contracts.validation import validate_schema\nfrom rwa_calc.data.schemas import FACILITY_SCHEMA\nimport polars as pl\n\n# Load your data\nfacilities = pl.scan_parquet(\"data/exposures/facilities.parquet\")\n\n# Validate against expected schema\nerrors = validate_schema(\n    lf=facilities,\n    expected_schema=FACILITY_SCHEMA,\n    context=\"facilities\",\n    strict=False  # Set True to flag unexpected columns\n)\n\nif errors:\n    print(\"Validation errors found:\")\n    for error in errors:\n        print(f\"  - {error}\")\nelse:\n    print(\"Schema validation passed\")\n</code></pre>"},{"location":"data-model/data-validation/#required-columns-check","title":"Required Columns Check","text":"<p>Validates that specific columns are present (without type checking):</p> <pre><code>from rwa_calc.contracts.validation import validate_required_columns\n\nrequired = [\"counterparty_reference\", \"entity_type\", \"country_code\"]\nmissing = validate_required_columns(\n    lf=counterparties,\n    required_columns=required,\n    context=\"counterparties\"\n)\n\nif missing:\n    print(\"Missing columns:\", missing)\n</code></pre>"},{"location":"data-model/data-validation/#structured-error-objects","title":"Structured Error Objects","text":"<p>For integration with the pipeline, use error objects:</p> <pre><code>from rwa_calc.contracts.validation import validate_schema_to_errors\nfrom rwa_calc.data.schemas import LOAN_SCHEMA\n\nerrors = validate_schema_to_errors(\n    lf=loans,\n    expected_schema=LOAN_SCHEMA,\n    context=\"loans\"\n)\n\nfor error in errors:\n    print(f\"Code: {error.code}\")\n    print(f\"Message: {error.message}\")\n    print(f\"Field: {error.field_name}\")\n    print(f\"Expected: {error.expected_value}\")\n    print(f\"Actual: {error.actual_value}\")\n</code></pre>"},{"location":"data-model/data-validation/#error-types","title":"Error Types","text":""},{"location":"data-model/data-validation/#schema-errors","title":"Schema Errors","text":"Error Code Description Example <code>MISSING_FIELD</code> Required column not present <code>Missing column 'counterparty_reference'</code> <code>TYPE_MISMATCH</code> Column has wrong data type <code>Type mismatch for 'limit': expected Float64, got String</code>"},{"location":"data-model/data-validation/#business-rule-errors","title":"Business Rule Errors","text":"Error Code Description Example <code>INVALID_VALUE</code> Value outside valid range <code>PD value 1.5 exceeds maximum 1.0</code> <code>INVALID_REFERENCE</code> Foreign key not found <code>counterparty_reference 'CORP_999' not found</code> <code>DUPLICATE_KEY</code> Duplicate primary key <code>Duplicate facility_reference: 'FAC_001'</code>"},{"location":"data-model/data-validation/#common-validation-issues","title":"Common Validation Issues","text":""},{"location":"data-model/data-validation/#1-missing-column","title":"1. Missing Column","text":"<p>Error: <pre><code>[facilities] Missing column: 'risk_type' (expected type: String)\n</code></pre></p> <p>Cause: The input file is missing a required column.</p> <p>Fix: Add the missing column to your data:</p> <pre><code>import polars as pl\n\n# Add missing column with default value\nfacilities = facilities.with_columns(\n    pl.lit(\"MR\").alias(\"risk_type\")  # MR = medium risk (50% SA, 75% F-IRB)\n)\n</code></pre>"},{"location":"data-model/data-validation/#2-type-mismatch","title":"2. Type Mismatch","text":"<p>Error: <pre><code>[loans] Type mismatch for 'drawn_amount': expected Float64, got String\n</code></pre></p> <p>Cause: The column contains string values instead of numbers (common with CSV imports).</p> <p>Fix: Cast the column to the correct type:</p> <pre><code>import polars as pl\n\nloans = loans.with_columns(\n    pl.col(\"drawn_amount\").cast(pl.Float64)\n)\n</code></pre>"},{"location":"data-model/data-validation/#3-column-name-case-mismatch","title":"3. Column Name Case Mismatch","text":"<p>Error: <pre><code>[counterparties] Missing column: 'counterparty_reference' (expected type: String)\n</code></pre></p> <p>Cause: Column names are case-sensitive. <code>Counterparty_Reference</code> is not the same as <code>counterparty_reference</code>.</p> <p>Fix: Rename columns to match expected names:</p> <pre><code>import polars as pl\n\ncounterparties = counterparties.rename({\n    \"Counterparty_Reference\": \"counterparty_reference\",\n    \"Country_Code\": \"country_code\",\n})\n</code></pre>"},{"location":"data-model/data-validation/#4-date-format-issues","title":"4. Date Format Issues","text":"<p>Error: <pre><code>[facilities] Type mismatch for 'maturity_date': expected Date, got String\n</code></pre></p> <p>Cause: Dates are stored as strings instead of proper date types.</p> <p>Fix: Parse dates from strings:</p> <pre><code>import polars as pl\n\nfacilities = facilities.with_columns(\n    pl.col(\"maturity_date\").str.strptime(pl.Date, \"%Y-%m-%d\")\n)\n\n# For different formats:\n# \"%d/%m/%Y\" for 31/12/2024\n# \"%m/%d/%Y\" for 12/31/2024\n</code></pre>"},{"location":"data-model/data-validation/#5-invalid-pdlgd-values","title":"5. Invalid PD/LGD Values","text":"<p>Error: <pre><code>PD value -0.01 is below minimum 0.0\nLGD value 1.5 exceeds maximum 1.25\n</code></pre></p> <p>Cause: Risk parameters are outside valid ranges.</p> <p>Fix: Clip or filter invalid values:</p> <pre><code>import polars as pl\n\n# Clip PD to valid range [0, 1]\ndata = data.with_columns(\n    pl.col(\"pd\").clip(0.0, 1.0)\n)\n\n# Or filter out invalid rows\nvalid_data = data.filter(\n    (pl.col(\"pd\") &gt;= 0.0) &amp; (pl.col(\"pd\") &lt;= 1.0)\n)\n</code></pre>"},{"location":"data-model/data-validation/#6-missing-reference-foreign-key","title":"6. Missing Reference (Foreign Key)","text":"<p>Error: <pre><code>counterparty_reference 'CORP_999' in loans not found in counterparties\n</code></pre></p> <p>Cause: A loan references a counterparty that doesn't exist.</p> <p>Fix: Either add the missing counterparty or filter orphan records:</p> <pre><code>import polars as pl\n\n# Get valid counterparty references\nvalid_refs = counterparties.select(\"counterparty_reference\").collect()\n\n# Filter loans to only valid references\nloans = loans.filter(\n    pl.col(\"counterparty_reference\").is_in(valid_refs[\"counterparty_reference\"])\n)\n</code></pre>"},{"location":"data-model/data-validation/#7-negative-amounts","title":"7. Negative Amounts","text":"<p>Error: <pre><code>Invalid value: drawn_amount cannot be negative\n</code></pre></p> <p>Cause: Amount columns contain negative values.</p> <p>Fix: Take absolute value or filter:</p> <pre><code>import polars as pl\n\n# Take absolute value\nloans = loans.with_columns(\n    pl.col(\"drawn_amount\").abs()\n)\n\n# Or filter\nloans = loans.filter(pl.col(\"drawn_amount\") &gt;= 0)\n</code></pre>"},{"location":"data-model/data-validation/#business-rule-validators","title":"Business Rule Validators","text":"<p>The calculator includes validators for domain-specific rules:</p>"},{"location":"data-model/data-validation/#non-negative-amounts","title":"Non-Negative Amounts","text":"<pre><code>from rwa_calc.contracts.validation import validate_non_negative_amounts\n\n# Returns LazyFrame with validation flag columns\nvalidated = validate_non_negative_amounts(\n    lf=loans,\n    amount_columns=[\"drawn_amount\", \"limit\"],\n    context=\"loans\"\n)\n\n# Check validation results\nresult = validated.select([\n    \"_valid_drawn_amount\",\n    \"_valid_limit\"\n]).collect()\n</code></pre>"},{"location":"data-model/data-validation/#pd-range-validation","title":"PD Range Validation","text":"<pre><code>from rwa_calc.contracts.validation import validate_pd_range\n\nvalidated = validate_pd_range(\n    lf=ratings,\n    pd_column=\"pd\",\n    min_pd=0.0,\n    max_pd=1.0\n)\n\n# Filter to only valid PDs\nvalid_ratings = validated.filter(pl.col(\"_valid_pd\"))\n</code></pre>"},{"location":"data-model/data-validation/#lgd-range-validation","title":"LGD Range Validation","text":"<pre><code>from rwa_calc.contracts.validation import validate_lgd_range\n\nvalidated = validate_lgd_range(\n    lf=exposures,\n    lgd_column=\"lgd\",\n    min_lgd=0.0,\n    max_lgd=1.25  # Can exceed 1.0 in some cases\n)\n</code></pre>"},{"location":"data-model/data-validation/#pre-flight-validation","title":"Pre-Flight Validation","text":"<p>Before running the full pipeline, validate your entire data bundle:</p> <pre><code>from rwa_calc.contracts.validation import validate_raw_data_bundle\nfrom rwa_calc.data.schemas import (\n    FACILITY_SCHEMA,\n    LOAN_SCHEMA,\n    COUNTERPARTY_SCHEMA,\n    COLLATERAL_SCHEMA,\n)\n\n# Define schemas to validate\nschemas = {\n    \"facilities\": FACILITY_SCHEMA,\n    \"loans\": LOAN_SCHEMA,\n    \"counterparties\": COUNTERPARTY_SCHEMA,\n    \"collateral\": COLLATERAL_SCHEMA,\n}\n\n# Validate entire bundle\nerrors = validate_raw_data_bundle(bundle, schemas)\n\nif errors:\n    print(f\"Found {len(errors)} validation errors:\")\n    for error in errors:\n        print(f\"  [{error.category}] {error.message}\")\nelse:\n    print(\"All data validated successfully\")\n</code></pre>"},{"location":"data-model/data-validation/#type-compatibility","title":"Type Compatibility","text":"<p>The validator allows some type flexibility:</p> Expected Type Allowed Actual Types <code>Int64</code> <code>Int8</code>, <code>Int16</code>, <code>Int32</code>, <code>Int64</code> <code>Float64</code> <code>Float32</code>, <code>Float64</code> <code>String</code> <code>Utf8</code>, <code>String</code> <p>This means if your file has <code>Int32</code> but the schema expects <code>Int64</code>, validation will pass.</p>"},{"location":"data-model/data-validation/#validation-in-the-pipeline","title":"Validation in the Pipeline","text":"<p>The pipeline validates data at stage boundaries:</p> <pre><code>Load \u2192 [Validate Raw] \u2192 Hierarchy \u2192 [Validate Resolved] \u2192 Classify \u2192 ...\n</code></pre> <p>If validation fails, the pipeline:</p> <ol> <li>Accumulates errors - Does not fail immediately</li> <li>Continues where possible - Processes valid records</li> <li>Reports all issues - Returns complete error list</li> </ol> <p>Access validation results:</p> <pre><code>result = pipeline.run(config)\n\nif result.has_errors:\n    for error in result.errors:\n        if error.category == \"SCHEMA_VALIDATION\":\n            print(f\"Schema error: {error.message}\")\n        elif error.category == \"BUSINESS_RULE\":\n            print(f\"Business rule violation: {error.message}\")\n</code></pre>"},{"location":"data-model/data-validation/#debugging-tips","title":"Debugging Tips","text":""},{"location":"data-model/data-validation/#1-inspect-schema-before-validation","title":"1. Inspect Schema Before Validation","text":"<pre><code>import polars as pl\n\nlf = pl.scan_parquet(\"data/facilities.parquet\")\n\n# View actual schema\nprint(\"Actual schema:\")\nfor name, dtype in lf.collect_schema().items():\n    print(f\"  {name}: {dtype}\")\n</code></pre>"},{"location":"data-model/data-validation/#2-compare-expected-vs-actual","title":"2. Compare Expected vs Actual","text":"<pre><code>from rwa_calc.data.schemas import FACILITY_SCHEMA\n\nprint(\"\\nExpected schema:\")\nfor name, dtype in FACILITY_SCHEMA.items():\n    print(f\"  {name}: {dtype}\")\n\nprint(\"\\nActual schema:\")\nfor name, dtype in lf.collect_schema().items():\n    print(f\"  {name}: {dtype}\")\n\n# Find differences\nexpected_cols = set(FACILITY_SCHEMA.keys())\nactual_cols = set(lf.collect_schema().names())\n\nprint(f\"\\nMissing columns: {expected_cols - actual_cols}\")\nprint(f\"Extra columns: {actual_cols - expected_cols}\")\n</code></pre>"},{"location":"data-model/data-validation/#3-sample-invalid-rows","title":"3. Sample Invalid Rows","text":"<pre><code>import polars as pl\n\n# Find rows with negative amounts\ninvalid = loans.filter(pl.col(\"drawn_amount\") &lt; 0).collect()\nprint(f\"Found {len(invalid)} rows with negative drawn_amount\")\nprint(invalid.head())\n\n# Find rows with null required fields\nnull_refs = loans.filter(pl.col(\"counterparty_reference\").is_null()).collect()\nprint(f\"Found {len(null_refs)} rows with null counterparty_reference\")\n</code></pre>"},{"location":"data-model/data-validation/#4-check-value-distributions","title":"4. Check Value Distributions","text":"<pre><code>import polars as pl\n\n# Check PD distribution\npd_stats = ratings.select([\n    pl.col(\"pd\").min().alias(\"min_pd\"),\n    pl.col(\"pd\").max().alias(\"max_pd\"),\n    pl.col(\"pd\").mean().alias(\"mean_pd\"),\n    pl.col(\"pd\").null_count().alias(\"null_count\"),\n]).collect()\n\nprint(pd_stats)\n</code></pre>"},{"location":"data-model/data-validation/#strict-mode","title":"Strict Mode","text":"<p>For production use, enable strict validation to catch unexpected columns:</p> <pre><code>errors = validate_schema(\n    lf=facilities,\n    expected_schema=FACILITY_SCHEMA,\n    context=\"facilities\",\n    strict=True  # Flag unexpected columns\n)\n</code></pre> <p>Unexpected columns might indicate: - Data from a different version - Leftover columns from transformations - Incorrectly named columns</p>"},{"location":"data-model/data-validation/#next-steps","title":"Next Steps","text":"<ul> <li>Input Schemas - Complete schema definitions</li> <li>Data Flow - How data moves through pipeline</li> <li>Error Handling - Error types and handling</li> </ul>"},{"location":"data-model/input-schemas/","title":"Input Data Schemas","text":"<p>This page documents the authoritative schemas for all input data files required by the RWA calculator. These schemas are defined in <code>src/rwa_calc/data/schemas.py</code> and represent the single source of truth.</p>"},{"location":"data-model/input-schemas/#quick-reference","title":"Quick Reference","text":"Data Category File(s) Required Purpose Counterparty <code>counterparty/*.parquet</code> Yes Borrower/obligor information Facility <code>exposures/facilities.parquet</code> Yes Committed credit limits Loan <code>exposures/loans.parquet</code> Yes Drawn exposures Contingent <code>exposures/contingents.parquet</code> No Off-balance sheet items Collateral <code>collateral/collateral.parquet</code> No Security/collateral Guarantee <code>guarantee/guarantee.parquet</code> No Credit protection Provision <code>provision/provision.parquet</code> No IFRS 9 provisions Rating <code>ratings/ratings.parquet</code> No Credit ratings FX Rates <code>fx_rates/fx_rates.parquet</code> No Currency conversion rates Specialised Lending N/A No Slotting approach data Equity Exposure N/A No Equity holdings <p>Mapping Files:</p> Mapping File Purpose Facility Mapping <code>exposures/facility_mapping.parquet</code> Facility-to-loan hierarchy Org Mapping <code>mapping/org_mapping.parquet</code> Organisation hierarchy (rating inheritance) Lending Mapping <code>mapping/lending_mapping.parquet</code> Lending groups (retail threshold aggregation)"},{"location":"data-model/input-schemas/#counterparty-schema","title":"Counterparty Schema","text":"<p>Purpose: Defines borrower/obligor information used for exposure classification, risk weight determination, and hierarchy resolution.</p> <p>File: <code>counterparty/{entity_type}.parquet</code> (e.g., <code>counterparty/corporate.parquet</code>)</p> Column Type Required Description <code>counterparty_reference</code> <code>String</code> Yes Unique identifier for the counterparty <code>counterparty_name</code> <code>String</code> Yes Legal name of the counterparty <code>entity_type</code> <code>String</code> Yes Single source of truth for exposure class (see valid values below) <code>country_code</code> <code>String</code> Yes ISO 3166-1 alpha-2 country code <code>annual_revenue</code> <code>Float64</code> No Annual revenue in GBP (for SME classification - EUR 50m threshold) <code>total_assets</code> <code>Float64</code> No Total assets in GBP (for large FSE threshold - EUR 70bn per CRR Art. 4(1)(146)) <code>default_status</code> <code>Boolean</code> No Whether counterparty is in default <code>sector_code</code> <code>String</code> No Industry sector code (SIC-based) <code>is_regulated</code> <code>Boolean</code> No Prudentially regulated (affects FI scalar - CRR Art. 153(2)) <code>is_managed_as_retail</code> <code>Boolean</code> No SME managed on pooled retail basis (75% RW per CRR Art. 123)"},{"location":"data-model/input-schemas/#entity-type-the-single-source-of-truth","title":"Entity Type: The Single Source of Truth","text":"<p>The <code>entity_type</code> field is the authoritative source for determining both SA and IRB exposure classes. Each entity type maps to specific exposure classes for each approach. This design ensures consistent classification across the calculation pipeline.</p> <p>Valid <code>entity_type</code> values:</p> Entity Type SA Exposure Class IRB Exposure Class Regulatory Reference Sovereign Class <code>sovereign</code> CENTRAL_GOVT_CENTRAL_BANK CENTRAL_GOVT_CENTRAL_BANK CRR Art. 112(a) <code>central_bank</code> CENTRAL_GOVT_CENTRAL_BANK CENTRAL_GOVT_CENTRAL_BANK CRR Art. 112(a) RGLA Class (Regional Governments/Local Authorities) <code>rgla_sovereign</code> RGLA CENTRAL_GOVT_CENTRAL_BANK CRR Art. 115 - has taxing powers/govt guarantee <code>rgla_institution</code> RGLA INSTITUTION CRR Art. 115 - no sovereign equivalence PSE Class (Public Sector Entities) <code>pse_sovereign</code> PSE CENTRAL_GOVT_CENTRAL_BANK CRR Art. 116 - govt guaranteed <code>pse_institution</code> PSE INSTITUTION CRR Art. 116 - commercial PSE MDB/International Org Class <code>mdb</code> MDB CENTRAL_GOVT_CENTRAL_BANK CRR Art. 117 - 0% RW if on eligible list <code>international_org</code> MDB CENTRAL_GOVT_CENTRAL_BANK CRR Art. 118 Institution Class <code>institution</code> INSTITUTION INSTITUTION CRR Art. 112(d) <code>bank</code> INSTITUTION INSTITUTION CRR Art. 112(d) <code>ccp</code> INSTITUTION INSTITUTION CRR Art. 300-311 (CCP treatment) <code>financial_institution</code> INSTITUTION INSTITUTION CRR Art. 112(d) Corporate Class <code>corporate</code> CORPORATE CORPORATE CRR Art. 112(g) <code>company</code> CORPORATE CORPORATE CRR Art. 112(g) Retail Class <code>individual</code> RETAIL_OTHER RETAIL_OTHER CRR Art. 112(h) <code>retail</code> RETAIL_OTHER RETAIL_OTHER CRR Art. 112(h) Specialised Lending Class <code>specialised_lending</code> SPECIALISED_LENDING SPECIALISED_LENDING CRR Art. 147(8)"},{"location":"data-model/input-schemas/#why-sa-and-irb-classes-can-differ","title":"Why SA and IRB Classes Can Differ","text":"<p>For certain entity types, the regulatory treatment differs between SA and IRB approaches:</p> <ul> <li>RGLA/PSE with sovereign treatment: Under SA, these use dedicated RGLA/PSE risk weight tables. Under IRB, those with government guarantees or taxing powers use the central govt/central bank IRB formula.</li> <li>RGLA/PSE with institution treatment: Under SA, these use RGLA/PSE tables. Under IRB, commercial PSEs without sovereign backing use the institution IRB formula.</li> <li>MDB/International Orgs: Under SA, these typically receive 0% RW from the MDB table. Under IRB, they use the central govt/central bank formula.</li> </ul>"},{"location":"data-model/input-schemas/#additional-classification-flags","title":"Additional Classification Flags","text":"Column Purpose When Used <code>is_regulated</code> Determines if FI scalar (1.25x correlation) applies Unregulated financial sector entities get FI scalar under IRB (CRR Art. 153(2)) <code>is_managed_as_retail</code> SME managed on pooled retail basis Can use 75% RW under SA (CRR Art. 123)"},{"location":"data-model/input-schemas/#financial-sector-entity-fse-determination","title":"Financial Sector Entity (FSE) Determination","text":"<p>The following entity types are classified as Financial Sector Entities for FI scalar purposes:</p> <ul> <li><code>institution</code></li> <li><code>bank</code></li> <li><code>ccp</code></li> <li><code>financial_institution</code></li> <li><code>pse_institution</code> (PSE treated as institution)</li> <li><code>rgla_institution</code> (RGLA treated as institution)</li> </ul> <p>FI Scalar applies when (CRR Art. 153(2)): 1. Large FSE: <code>total_assets &gt;= EUR 70bn</code>, OR 2. Unregulated FSE: <code>is_regulated = False</code></p> <p>Example:</p> <pre><code>import polars as pl\n\ncounterparties = pl.DataFrame({\n    \"counterparty_reference\": [\"CORP_001\", \"CORP_002\", \"SOV_001\", \"BANK_001\", \"PSE_001\"],\n    \"counterparty_name\": [\"Acme Corp Ltd\", \"Beta Industries PLC\", \"UK Treasury\", \"Major Bank PLC\", \"Local Council\"],\n    \"entity_type\": [\"corporate\", \"corporate\", \"sovereign\", \"bank\", \"pse_sovereign\"],\n    \"country_code\": [\"GB\", \"GB\", \"GB\", \"GB\", \"GB\"],\n    \"annual_revenue\": [25_000_000.0, 500_000_000.0, None, None, None],\n    \"total_assets\": [30_000_000.0, 600_000_000.0, None, 80_000_000_000.0, 500_000_000.0],\n    \"default_status\": [False, False, False, False, False],\n    \"sector_code\": [\"62.01\", \"28.11\", None, \"64.19\", None],\n    \"is_regulated\": [False, False, True, True, True],\n    \"is_managed_as_retail\": [False, False, False, False, False],\n})\n</code></pre>"},{"location":"data-model/input-schemas/#classification-algorithm-summary","title":"Classification Algorithm Summary","text":"<p>The classifier (<code>engine/classifier.py</code>) processes counterparties through these steps:</p> <ol> <li>Entity Type Mapping: Maps <code>entity_type</code> to both SA and IRB exposure classes</li> <li>SME Classification: Checks if <code>annual_revenue &lt; EUR 50m</code> for corporates</li> <li>Retail Threshold: Aggregates exposures by lending group against EUR 1m threshold</li> <li>Default Identification: Checks <code>default_status</code> for defaulted treatment</li> <li>FI Scalar Determination: Identifies large/unregulated FSEs for 1.25x correlation</li> <li>Approach Assignment: Assigns SA/F-IRB/A-IRB/Slotting based on IRB permissions</li> </ol> <p>See Classification for the complete classification algorithm.</p>"},{"location":"data-model/input-schemas/#facility-schema","title":"Facility Schema","text":"<p>Purpose: Defines committed credit facilities (parent nodes in exposure hierarchy). Facilities represent credit limits; actual drawings are captured in the Loan schema.</p> <p>File: <code>exposures/facilities.parquet</code></p> Column Type Required Description <code>facility_reference</code> <code>String</code> Yes Unique identifier for the facility <code>product_type</code> <code>String</code> Yes Product classification <code>book_code</code> <code>String</code> Yes Portfolio/book classification <code>counterparty_reference</code> <code>String</code> Yes Link to counterparty <code>value_date</code> <code>Date</code> Yes Facility start date <code>maturity_date</code> <code>Date</code> Yes Final maturity date <code>currency</code> <code>String</code> Yes ISO 4217 currency code <code>limit</code> <code>Float64</code> Yes Committed facility limit <code>committed</code> <code>Boolean</code> Yes Whether facility is committed <code>lgd</code> <code>Float64</code> No Internal LGD estimate (A-IRB) <code>beel</code> <code>Float64</code> No Best estimate expected loss <code>is_revolving</code> <code>Boolean</code> Yes Revolving vs term facility <code>seniority</code> <code>String</code> Yes <code>senior</code> or <code>subordinated</code> (affects F-IRB LGD) <code>risk_type</code> <code>String</code> Yes Off-balance sheet risk category (see below) <code>ccf_modelled</code> <code>Float64</code> No A-IRB modelled CCF (0.0-1.5) <code>is_short_term_trade_lc</code> <code>Boolean</code> No Short-term trade LC for goods movement (Art. 166(9)) <code>is_buy_to_let</code> <code>Boolean</code> No Buy-to-let property lending \u2014 excluded from SME supporting factor (CRR Art. 501) <p>Valid <code>product_type</code> values:</p> Value Description <code>rcf</code> Revolving credit facility <code>term_loan</code> Term loan facility <code>mortgage</code> Mortgage facility <code>overdraft</code> Overdraft facility <code>credit_card</code> Credit card facility <code>trade_finance</code> Trade finance facility <code>guarantee</code> Guarantee facility <code>project_finance</code> Project finance <p>Valid <code>seniority</code> values:</p> Value F-IRB LGD Description <code>senior</code> 45% Senior unsecured claims <code>subordinated</code> 75% Subordinated claims <p>Valid <code>risk_type</code> values (CRR Art. 111 CCF Categories):</p> Code Full Value SA CCF F-IRB CCF Description <code>FR</code> <code>full_risk</code> 100% 100% Direct credit substitutes, guarantees, acceptances <code>MR</code> <code>medium_risk</code> 50% 75% NIFs, RUFs, standby LCs, committed undrawn <code>MLR</code> <code>medium_low_risk</code> 20% 75% Documentary credits, trade finance <code>LR</code> <code>low_risk</code> 0% 0% Unconditionally cancellable commitments <p>Note: Under F-IRB (CRR Art. 166(8)), MR and MLR both become 75% CCF.</p> <p>F-IRB Exception (Art. 166(9)): Short-term letters of credit arising from the movement of goods retain 20% CCF under F-IRB. To flag these exposures, set <code>is_short_term_trade_lc = True</code> for MLR risk type items.</p> Column Type Required Description <code>is_short_term_trade_lc</code> <code>Boolean</code> No True for short-term trade LCs for goods movement (Art. 166(9) - retains 20% CCF under F-IRB) <p>A-IRB Modelled CCF: For A-IRB exposures, provide the bank's own modelled CCF estimate (0.0 to 1.5) in <code>ccf_modelled</code>. Retail IRB CCFs can exceed 100% due to additional drawdown behaviour. When populated and approach is A-IRB, this value takes precedence over the risk_type lookup.</p> <p>Example:</p> <pre><code>from datetime import date\nimport polars as pl\n\nfacilities = pl.DataFrame({\n    \"facility_reference\": [\"FAC_001\", \"FAC_002\"],\n    \"product_type\": [\"rcf\", \"term_loan\"],\n    \"book_code\": [\"CORP_LENDING\", \"CORP_LENDING\"],\n    \"counterparty_reference\": [\"CORP_001\", \"CORP_002\"],\n    \"value_date\": [date(2024, 1, 15), date(2023, 6, 1)],\n    \"maturity_date\": [date(2029, 1, 15), date(2028, 6, 1)],\n    \"currency\": [\"GBP\", \"GBP\"],\n    \"limit\": [10_000_000.0, 5_000_000.0],\n    \"committed\": [True, True],\n    \"lgd\": [None, None],  # Supervisory LGD used for F-IRB\n    \"beel\": [None, None],\n    \"is_revolving\": [True, False],\n    \"seniority\": [\"senior\", \"senior\"],\n    \"risk_type\": [\"MR\", \"MR\"],  # Medium risk - committed undrawn\n    \"ccf_modelled\": [None, None],  # No modelled CCF (use regulatory)\n})\n</code></pre>"},{"location":"data-model/input-schemas/#loan-schema","title":"Loan Schema","text":"<p>Purpose: Defines drawn loan exposures (leaf nodes in exposure hierarchy). Loans represent actual credit usage under facilities.</p> <p>File: <code>exposures/loans.parquet</code></p> Column Type Required Description <code>loan_reference</code> <code>String</code> Yes Unique identifier for the loan <code>product_type</code> <code>String</code> Yes Product classification <code>book_code</code> <code>String</code> Yes Portfolio/book classification <code>counterparty_reference</code> <code>String</code> Yes Link to counterparty <code>value_date</code> <code>Date</code> Yes Loan origination date <code>maturity_date</code> <code>Date</code> Yes Loan maturity date <code>currency</code> <code>String</code> Yes ISO 4217 currency code <code>drawn_amount</code> <code>Float64</code> Yes Outstanding principal balance <code>interest</code> <code>Float64</code> No Accrued interest (adds to on-balance-sheet EAD) <code>lgd</code> <code>Float64</code> No Internal LGD estimate (A-IRB) <code>beel</code> <code>Float64</code> No Best estimate expected loss <code>seniority</code> <code>String</code> Yes <code>senior</code> or <code>subordinated</code> (affects F-IRB LGD) <code>is_buy_to_let</code> <code>Boolean</code> No Buy-to-let property lending \u2014 excluded from SME supporting factor (CRR Art. 501) <p>Note: Loans do not have CCF fields (<code>risk_type</code>, <code>ccf_modelled</code>, <code>is_short_term_trade_lc</code>) because CCF only applies to off-balance sheet items. For drawn loans, EAD = <code>drawn_amount</code> + <code>interest</code> directly.</p> <p>Example:</p> <pre><code>from datetime import date\nimport polars as pl\n\nloans = pl.DataFrame({\n    \"loan_reference\": [\"LOAN_001\", \"LOAN_002\", \"LOAN_003\"],\n    \"product_type\": [\"rcf_drawing\", \"term_loan\", \"term_loan\"],\n    \"book_code\": [\"CORP_LENDING\", \"CORP_LENDING\", \"CORP_LENDING\"],\n    \"counterparty_reference\": [\"CORP_001\", \"CORP_001\", \"CORP_002\"],\n    \"value_date\": [date(2024, 3, 1), date(2024, 4, 15), date(2023, 6, 1)],\n    \"maturity_date\": [date(2029, 1, 15), date(2029, 1, 15), date(2028, 6, 1)],\n    \"currency\": [\"GBP\", \"GBP\", \"GBP\"],\n    \"drawn_amount\": [2_000_000.0, 1_500_000.0, 5_000_000.0],\n    \"lgd\": [None, None, None],\n    \"beel\": [None, None, None],\n    \"seniority\": [\"senior\", \"senior\", \"senior\"],\n    \"risk_type\": [\"FR\", \"FR\", \"FR\"],  # Full risk for drawn loans\n    \"ccf_modelled\": [None, None, None],  # N/A for drawn amounts\n})\n</code></pre>"},{"location":"data-model/input-schemas/#contingent-schema","title":"Contingent Schema","text":"<p>Purpose: Defines off-balance sheet commitments that require Credit Conversion Factor (CCF) application.</p> <p>File: <code>exposures/contingents.parquet</code></p> Column Type Required Description <code>contingent_reference</code> <code>String</code> Yes Unique identifier <code>contract_type</code> <code>String</code> Yes Type of contingent contract <code>product_type</code> <code>String</code> Yes Product classification <code>book_code</code> <code>String</code> Yes Portfolio/book classification <code>counterparty_reference</code> <code>String</code> Yes Link to counterparty <code>value_date</code> <code>Date</code> Yes Contract start date <code>maturity_date</code> <code>Date</code> Yes Contract expiry date <code>currency</code> <code>String</code> Yes ISO 4217 currency code <code>nominal_amount</code> <code>Float64</code> Yes Notional/nominal amount <code>lgd</code> <code>Float64</code> No Internal LGD estimate (A-IRB) <code>beel</code> <code>Float64</code> No Best estimate expected loss <code>ccf_category</code> <code>String</code> Yes Category for CCF lookup (legacy, see <code>risk_type</code>) <code>seniority</code> <code>String</code> Yes <code>senior</code> or <code>subordinated</code> <code>risk_type</code> <code>String</code> Yes Off-balance sheet risk category (see Facility schema) <code>ccf_modelled</code> <code>Float64</code> No A-IRB modelled CCF (0.0-1.5) <code>is_short_term_trade_lc</code> <code>Boolean</code> No Short-term trade LC for goods movement (Art. 166(9)) <p>Valid <code>ccf_category</code> values (legacy):</p> Category SA CCF Description <code>full_risk</code> 100% Direct credit substitutes <code>medium_risk</code> 50% Transaction-related contingencies <code>medium_low_risk</code> 20% Short-term self-liquidating trade <code>low_risk</code> 0%/10% Unconditionally cancellable <p>Note: The <code>risk_type</code> column is the primary source for CCF determination. The <code>ccf_category</code> column is retained for backwards compatibility but <code>risk_type</code> takes precedence when both are present.</p> <p>Example:</p> <pre><code>from datetime import date\nimport polars as pl\n\ncontingents = pl.DataFrame({\n    \"contingent_reference\": [\"CONT_001\", \"CONT_002\", \"CONT_003\"],\n    \"contract_type\": [\"standby_lc\", \"performance_guarantee\", \"documentary_lc\"],\n    \"product_type\": [\"trade_finance\", \"guarantee\", \"import_lc\"],\n    \"book_code\": [\"TRADE\", \"GUARANTEE\", \"TRADE\"],\n    \"counterparty_reference\": [\"CORP_001\", \"CORP_002\", \"CORP_003\"],\n    \"value_date\": [date(2024, 1, 1), date(2024, 2, 1), date(2024, 3, 1)],\n    \"maturity_date\": [date(2025, 1, 1), date(2025, 2, 1), date(2024, 6, 1)],\n    \"currency\": [\"GBP\", \"GBP\", \"GBP\"],\n    \"nominal_amount\": [500_000.0, 1_000_000.0, 250_000.0],\n    \"lgd\": [None, None, None],\n    \"beel\": [None, None, None],\n    \"ccf_category\": [\"full_risk\", \"medium_risk\", \"medium_low_risk\"],\n    \"seniority\": [\"senior\", \"senior\", \"senior\"],\n    \"risk_type\": [\"FR\", \"MR\", \"MLR\"],  # FR=100%, MR=50%/75%, MLR=20%/75%\n    \"ccf_modelled\": [None, None, None],  # No modelled CCF\n    \"is_short_term_trade_lc\": [False, False, True],  # Third is Art. 166(9) exception\n})\n</code></pre>"},{"location":"data-model/input-schemas/#collateral-schema","title":"Collateral Schema","text":"<p>Purpose: Defines collateral/security items used for Credit Risk Mitigation (CRM). Collateral can be linked at counterparty, facility, or loan level.</p> <p>File: <code>collateral/collateral.parquet</code></p> Column Type Required Description <code>collateral_reference</code> <code>String</code> Yes Unique identifier <code>collateral_type</code> <code>String</code> Yes Type of collateral (see valid values) <code>currency</code> <code>String</code> Yes ISO 4217 currency code <code>maturity_date</code> <code>Date</code> No Collateral maturity (if applicable) <code>market_value</code> <code>Float64</code> Conditional Current market value (required unless <code>pledge_percentage</code> provided) <code>nominal_value</code> <code>Float64</code> No Nominal/face value <code>pledge_percentage</code> <code>Float64</code> Conditional Fraction of beneficiary EAD (0.5 = 50%). Used when <code>market_value</code> not provided. Resolved to absolute <code>market_value</code> before haircuts. <code>beneficiary_type</code> <code>String</code> Yes Level of allocation <code>beneficiary_reference</code> <code>String</code> Yes Reference to counterparty/facility/loan <code>issuer_cqs</code> <code>Int8</code> No CQS of issuer (for securities) <code>issuer_type</code> <code>String</code> No Issuer type (for haircut lookup) <code>residual_maturity_years</code> <code>Float64</code> No Residual maturity in years <code>is_eligible_financial_collateral</code> <code>Boolean</code> No Meets SA eligibility (CRR Art 197) <code>is_eligible_irb_collateral</code> <code>Boolean</code> No Meets IRB eligibility (CRR Art 199) <code>valuation_date</code> <code>Date</code> No Date of last valuation <code>valuation_type</code> <code>String</code> No <code>market</code>, <code>indexed</code>, <code>independent</code> <code>property_type</code> <code>String</code> No <code>residential</code> or <code>commercial</code> (RE only) <code>property_ltv</code> <code>Float64</code> No Loan-to-value ratio (RE only) <code>is_income_producing</code> <code>Boolean</code> No Material income dependence (CRE) <code>is_adc</code> <code>Boolean</code> No Acquisition/Development/Construction <code>is_presold</code> <code>Boolean</code> No ADC pre-sold to qualifying buyer <p>Valid <code>collateral_type</code> values:</p> Value Description <code>cash</code> Cash collateral (0% haircut) <code>gold</code> Gold collateral (15% haircut) <code>bond</code> Bond securities \u2014 haircut depends on <code>issuer_type</code>, <code>issuer_cqs</code>, and <code>residual_maturity_years</code> <code>equity</code> Equity securities <code>real_estate</code> Real estate \u2014 use <code>property_type</code> for residential/commercial classification <code>receivables</code> Trade receivables <code>other_physical</code> Other physical collateral <p>Valid <code>beneficiary_type</code> values:</p> Value Description <code>counterparty</code> Allocated at counterparty level (expands to all exposures) <code>facility</code> Allocated at facility level (expands to facility + child loans) <code>loan</code> Allocated directly to specific loan <code>contingent</code> Allocated directly to contingent <p>Example:</p> <pre><code>from datetime import date\nimport polars as pl\n\ncollateral = pl.DataFrame({\n    \"collateral_reference\": [\"COLL_001\", \"COLL_002\"],\n    \"collateral_type\": [\"cash\", \"real_estate\"],\n    \"currency\": [\"GBP\", \"GBP\"],\n    \"maturity_date\": [None, None],\n    \"market_value\": [1_000_000.0, 500_000.0],\n    \"nominal_value\": [1_000_000.0, None],\n    \"beneficiary_type\": [\"counterparty\", \"loan\"],\n    \"beneficiary_reference\": [\"CORP_001\", \"LOAN_003\"],\n    \"issuer_cqs\": [None, None],\n    \"issuer_type\": [None, None],\n    \"residual_maturity_years\": [None, None],\n    \"is_eligible_financial_collateral\": [True, False],\n    \"is_eligible_irb_collateral\": [True, True],\n    \"valuation_date\": [date(2024, 12, 31), date(2024, 11, 15)],\n    \"valuation_type\": [\"market\", \"independent\"],\n    \"property_type\": [None, \"residential\"],\n    \"property_ltv\": [None, 0.65],\n    \"is_income_producing\": [None, False],\n    \"is_adc\": [None, False],\n    \"is_presold\": [None, None],\n})\n</code></pre>"},{"location":"data-model/input-schemas/#guarantee-schema","title":"Guarantee Schema","text":"<p>Purpose: Defines guarantee protection for Credit Risk Mitigation using the substitution approach.</p> <p>File: <code>guarantee/guarantee.parquet</code></p> Column Type Required Description <code>guarantee_reference</code> <code>String</code> Yes Unique identifier <code>guarantee_type</code> <code>String</code> Yes Type of guarantee <code>guarantor</code> <code>String</code> Yes Guarantor counterparty reference <code>currency</code> <code>String</code> Yes ISO 4217 currency code <code>maturity_date</code> <code>Date</code> No Guarantee expiry date <code>amount_covered</code> <code>Float64</code> Yes Amount covered by guarantee <code>percentage_covered</code> <code>Float64</code> No Percentage of exposure covered <code>beneficiary_type</code> <code>String</code> Yes Level of allocation <code>beneficiary_reference</code> <code>String</code> Yes Reference to counterparty/facility/loan <p>Valid <code>guarantee_type</code> values:</p> Value Description <code>guarantee</code> Standard guarantee <code>credit_derivative</code> Credit derivative protection <code>counter_guarantee</code> Counter-guarantee <p>Example:</p> <pre><code>from datetime import date\nimport polars as pl\n\nguarantees = pl.DataFrame({\n    \"guarantee_reference\": [\"GUAR_001\"],\n    \"guarantee_type\": [\"guarantee\"],\n    \"guarantor\": [\"SOV_001\"],  # UK Treasury guaranteeing\n    \"currency\": [\"GBP\"],\n    \"maturity_date\": [date(2030, 12, 31)],\n    \"amount_covered\": [2_000_000.0],\n    \"percentage_covered\": [1.0],\n    \"beneficiary_type\": [\"counterparty\"],\n    \"beneficiary_reference\": [\"CORP_001\"],\n})\n</code></pre>"},{"location":"data-model/input-schemas/#provision-schema","title":"Provision Schema","text":"<p>Purpose: Defines IFRS 9 provisions/impairments for EAD reduction and IRB expected loss comparison.</p> <p>File: <code>provision/provision.parquet</code></p> Column Type Required Description <code>provision_reference</code> <code>String</code> Yes Unique identifier <code>provision_type</code> <code>String</code> Yes <code>SCRA</code> (specific) or <code>GCRA</code> (general) <code>ifrs9_stage</code> <code>Int8</code> No IFRS 9 stage (1, 2, or 3) <code>currency</code> <code>String</code> Yes ISO 4217 currency code <code>amount</code> <code>Float64</code> Yes Provision amount <code>as_of_date</code> <code>Date</code> Yes Provision as-of date <code>beneficiary_type</code> <code>String</code> Yes Level of allocation <code>beneficiary_reference</code> <code>String</code> Yes Reference to counterparty/facility/loan <p>Valid <code>provision_type</code> values:</p> Value Description Usage <code>SCRA</code> Specific Credit Risk Adjustment Reduces exposure value; affects defaulted RW <code>GCRA</code> General Credit Risk Adjustment Reduces exposure value <p>Valid <code>ifrs9_stage</code> values:</p> Stage Description ECL Type <code>1</code> Performing 12-month ECL <code>2</code> Performing, significant increase in credit risk Lifetime ECL <code>3</code> Non-performing/credit-impaired Lifetime ECL <p>Example:</p> <pre><code>from datetime import date\nimport polars as pl\n\nprovisions = pl.DataFrame({\n    \"provision_reference\": [\"PROV_001\", \"PROV_002\"],\n    \"provision_type\": [\"SCRA\", \"GCRA\"],\n    \"ifrs9_stage\": [1, 2],\n    \"currency\": [\"GBP\", \"GBP\"],\n    \"amount\": [50_000.0, 100_000.0],\n    \"as_of_date\": [date(2024, 12, 31), date(2024, 12, 31)],\n    \"beneficiary_type\": [\"loan\", \"counterparty\"],\n    \"beneficiary_reference\": [\"LOAN_001\", \"CORP_002\"],\n})\n</code></pre>"},{"location":"data-model/input-schemas/#rating-schema","title":"Rating Schema","text":"<p>Purpose: Defines internal and external credit ratings for risk weight determination.</p> <p>File: <code>ratings/ratings.parquet</code></p> Column Type Required Description <code>rating_reference</code> <code>String</code> Yes Unique identifier <code>counterparty_reference</code> <code>String</code> Yes Link to counterparty <code>rating_type</code> <code>String</code> Yes <code>internal</code> or <code>external</code> <code>rating_agency</code> <code>String</code> Yes Rating source <code>rating_value</code> <code>String</code> Yes Rating value (e.g., <code>AAA</code>, <code>Aa1</code>) <code>cqs</code> <code>Int8</code> Yes Credit Quality Step (1-6) <code>pd</code> <code>Float64</code> No Probability of Default (internal ratings) <code>rating_date</code> <code>Date</code> Yes Rating as-of date <code>is_solicited</code> <code>Boolean</code> No Whether rating was solicited <p>Valid <code>rating_agency</code> values:</p> Value Description <code>internal</code> Internal rating system <code>SP</code> Standard &amp; Poor's <code>MOODYS</code> Moody's <code>FITCH</code> Fitch Ratings <code>DBRS</code> DBRS Morningstar <p>CQS Mapping:</p> CQS S&amp;P/Fitch Moody's Sovereign RW Institution RW Corporate RW 1 AAA to AA- Aaa to Aa3 0% 20% 20% 2 A+ to A- A1 to A3 20% 30%* 50% 3 BBB+ to BBB- Baa1 to Baa3 50% 50% 100% 4 BB+ to BB- Ba1 to Ba3 100% 100% 100% 5 B+ to B- B1 to B3 100% 100% 150% 6 CCC+ and below Caa1 and below 150% 150% 150% <p>*UK deviation: CQS 2 institutions get 30% RW (not 50%)</p> <p>Example:</p> <pre><code>from datetime import date\nimport polars as pl\n\nratings = pl.DataFrame({\n    \"rating_reference\": [\"RAT_001\", \"RAT_002\"],\n    \"counterparty_reference\": [\"CORP_001\", \"SOV_001\"],\n    \"rating_type\": [\"external\", \"external\"],\n    \"rating_agency\": [\"SP\", \"SP\"],\n    \"rating_value\": [\"BBB+\", \"AA\"],\n    \"cqs\": [3, 1],\n    \"pd\": [None, None],\n    \"rating_date\": [date(2024, 6, 15), date(2024, 1, 1)],\n    \"is_solicited\": [True, True],\n})\n</code></pre>"},{"location":"data-model/input-schemas/#fx-rates-schema","title":"FX Rates Schema","text":"<p>Purpose: Defines FX (foreign exchange) rates for converting exposure amounts from their original currencies to a reporting currency. This enables consistent RWA calculations across multi-currency portfolios.</p> <p>File: <code>fx_rates/fx_rates.parquet</code></p> Column Type Required Description <code>currency_from</code> <code>String</code> Yes Source currency code (ISO 4217) <code>currency_to</code> <code>String</code> Yes Target currency code (ISO 4217) <code>rate</code> <code>Float64</code> Yes Conversion multiplier: <code>target_amount = source_amount * rate</code> <p>Usage: - Rates should be provided for all currency pairs needed (source \u2192 target) - Include identity rates (e.g., GBP\u2192GBP = 1.0) for the target currency - The target currency should match <code>CalculationConfig.base_currency</code></p> <p>Converted Fields: - Exposures: <code>drawn_amount</code>, <code>undrawn_amount</code>, <code>nominal_amount</code> - Collateral: <code>market_value</code>, <code>nominal_value</code> - Guarantees: <code>amount_covered</code> - Provisions: <code>amount</code></p> <p>Audit Trail: After conversion, the following columns are added: - <code>original_currency</code> - Currency before conversion - <code>original_amount</code> - Amount before conversion (drawn + nominal) - <code>fx_rate_applied</code> - Rate used (null if no conversion needed)</p> <p>Example:</p> <pre><code>from datetime import date\nimport polars as pl\n\nfx_rates = pl.DataFrame({\n    \"currency_from\": [\"GBP\", \"USD\", \"EUR\", \"JPY\", \"CHF\"],\n    \"currency_to\": [\"GBP\", \"GBP\", \"GBP\", \"GBP\", \"GBP\"],\n    \"rate\": [1.0, 0.79, 0.88, 0.0053, 0.89],\n})\n</code></pre> <p>Behaviour: - Missing rates: Exposures in currencies without rates retain original values; <code>fx_rate_applied</code> is null - FX disabled: Set <code>apply_fx_conversion=False</code> in <code>CalculationConfig</code> to skip conversion - No FX file: If <code>fx_rates.parquet</code> is not provided, no conversion occurs</p>"},{"location":"data-model/input-schemas/#specialised-lending-schema","title":"Specialised Lending Schema","text":"<p>Purpose: Defines specialised lending exposures for slotting approach treatment (CRE33).</p> Column Type Required Description <code>exposure_reference</code> <code>String</code> Yes Links to facility/loan reference <code>sl_type</code> <code>String</code> Yes Type of specialised lending <code>slotting_category</code> <code>String</code> Yes Slotting category <code>remaining_maturity_years</code> <code>Float64</code> Yes Remaining maturity in years <code>is_hvcre</code> <code>Boolean</code> No High-volatility commercial real estate <p>Valid <code>sl_type</code> values:</p> Value Description <code>project_finance</code> Project finance (PF) <code>object_finance</code> Object finance (OF) <code>commodities_finance</code> Commodities finance (CF) <code>ipre</code> Income-producing real estate <p>Valid <code>slotting_category</code> values:</p> Category CRR RW Description <code>strong</code> 70% Excellent risk profile <code>good</code> 70% Good risk profile (same as Strong under CRR) <code>satisfactory</code> 115% Acceptable risk profile <code>weak</code> 250% Higher risk profile <code>default</code> 0% In default (provisions apply)"},{"location":"data-model/input-schemas/#equity-exposure-schema","title":"Equity Exposure Schema","text":"<p>Purpose: Defines equity holdings (SA only under Basel 3.1, IRB approaches withdrawn).</p> Column Type Required Description <code>exposure_reference</code> <code>String</code> Yes Unique identifier <code>counterparty_reference</code> <code>String</code> Yes Link to counterparty <code>equity_type</code> <code>String</code> Yes Type of equity exposure <code>currency</code> <code>String</code> Yes ISO 4217 currency code <code>carrying_value</code> <code>Float64</code> Yes Balance sheet value <code>fair_value</code> <code>Float64</code> No Mark-to-market value <code>is_speculative</code> <code>Boolean</code> No Speculative unlisted equity <code>is_exchange_traded</code> <code>Boolean</code> No Listed on recognised exchange <code>is_government_supported</code> <code>Boolean</code> No Government-supported programme <code>is_significant_investment</code> <code>Boolean</code> No &gt;10% of CET1 <p>Valid <code>equity_type</code> values:</p> Value Risk Weight Description <code>listed</code> 100% Exchange-traded equities <code>unlisted</code> 250% Unlisted equities <code>private_equity</code> 250% Private equity investments <code>speculative</code> 400% Speculative unlisted <code>ciu</code> Look-through Collective investment undertakings"},{"location":"data-model/input-schemas/#facility-mapping-schema","title":"Facility Mapping Schema","text":"<p>Purpose: Defines parent-child relationships between facilities, loans, and contingents.</p> <p>File: <code>exposures/facility_mapping.parquet</code></p> Column Type Required Description <code>parent_facility_reference</code> <code>String</code> Yes Parent facility reference <code>child_reference</code> <code>String</code> Yes Child facility/loan/contingent reference <code>child_type</code> <code>String</code> Yes <code>facility</code>, <code>loan</code>, or <code>contingent</code> <p>Example:</p> <pre><code>import polars as pl\n\nfacility_mapping = pl.DataFrame({\n    \"parent_facility_reference\": [\"FAC_001\", \"FAC_001\", \"FAC_001\"],\n    \"child_reference\": [\"LOAN_001\", \"LOAN_002\", \"FAC_001A\"],\n    \"child_type\": [\"loan\", \"loan\", \"facility\"],\n})\n</code></pre>"},{"location":"data-model/input-schemas/#org-mapping-schema","title":"Org Mapping Schema","text":"<p>Purpose: Defines organisation hierarchy for rating and turnover inheritance.</p> <p>File: <code>mapping/org_mapping.parquet</code></p> Column Type Required Description <code>parent_counterparty_reference</code> <code>String</code> Yes Parent counterparty reference <code>child_counterparty_reference</code> <code>String</code> Yes Child counterparty reference <p>Example:</p> <pre><code>import polars as pl\n\norg_mapping = pl.DataFrame({\n    \"parent_counterparty_reference\": [\"CORP_PARENT\", \"CORP_PARENT\"],\n    \"child_counterparty_reference\": [\"CORP_001\", \"CORP_002\"],\n})\n</code></pre>"},{"location":"data-model/input-schemas/#lending-mapping-schema","title":"Lending Mapping Schema","text":"<p>Purpose: Defines lending groups for retail threshold aggregation.</p> <p>File: <code>mapping/lending_mapping.parquet</code></p> Column Type Required Description <code>parent_counterparty_reference</code> <code>String</code> Yes Lending group lead reference <code>child_counterparty_reference</code> <code>String</code> Yes Member counterparty reference <p>Exposures are aggregated to the group level for retail eligibility (threshold: EUR 1m / GBP 880k).</p>"},{"location":"data-model/input-schemas/#data-preparation-checklist","title":"Data Preparation Checklist","text":"<p>Before running the calculator, verify your data meets these requirements:</p> <ul> <li>[ ] All required files present in expected locations</li> <li>[ ] Column names match schema exactly (case-sensitive)</li> <li>[ ] Data types match expected types</li> <li>[ ] All required columns have non-null values</li> <li>[ ] Reference columns have valid foreign key relationships</li> <li>[ ] Dates are in <code>YYYY-MM-DD</code> format</li> <li>[ ] Currency codes are valid ISO 4217</li> <li>[ ] Country codes are valid ISO 3166-1 alpha-2</li> <li>[ ] Numeric amounts are non-negative where expected</li> <li>[ ] PD values are in range [0, 1]</li> <li>[ ] LGD values are in range [0, 1.25]</li> </ul> <p>See Data Validation Guide for validation functions and troubleshooting.</p>"},{"location":"data-model/input-schemas/#next-steps","title":"Next Steps","text":"<ul> <li>Data Validation Guide - Validation rules and error handling</li> <li>Intermediate Schemas - Pipeline intermediate data</li> <li>Output Schemas - Calculation results</li> </ul>"},{"location":"data-model/intermediate-schemas/","title":"Intermediate Schemas","text":"<p>This page documents the schemas for intermediate data structures used during calculation.</p>"},{"location":"data-model/intermediate-schemas/#resolved-hierarchy-schema","title":"Resolved Hierarchy Schema","text":"<p>After hierarchy resolution, exposures include resolved parent information.</p> Column Type Description <code>counterparty_id</code> <code>Utf8</code> Counterparty identifier <code>ultimate_parent_id</code> <code>Utf8</code> Ultimate parent in hierarchy <code>parent_chain</code> <code>List[Utf8]</code> List of parent IDs <code>hierarchy_level</code> <code>Int32</code> Depth in hierarchy <code>inherited_rating</code> <code>Utf8</code> Rating (own or inherited) <code>inherited_cqs</code> <code>Int32</code> CQS (own or inherited) <code>inherited_pd</code> <code>Float64</code> PD (own or inherited) <code>group_total_exposure</code> <code>Float64</code> Total exposure to group <code>lending_group_id</code> <code>Utf8</code> Retail lending group <code>lending_group_exposure</code> <code>Float64</code> Lending group total"},{"location":"data-model/intermediate-schemas/#classified-exposure-schema","title":"Classified Exposure Schema","text":"<p>After classification, each exposure has regulatory attributes.</p> Column Type Description <code>exposure_id</code> <code>Utf8</code> Unique exposure identifier <code>counterparty_id</code> <code>Utf8</code> Counterparty identifier <code>facility_id</code> <code>Utf8</code> Facility identifier <code>loan_id</code> <code>Utf8</code> Loan identifier (if applicable) <code>exposure_class</code> <code>Utf8</code> Regulatory exposure class <code>approach_type</code> <code>Utf8</code> SA/FIRB/AIRB/SLOTTING <code>is_defaulted</code> <code>Boolean</code> Default indicator <code>gross_exposure</code> <code>Float64</code> Gross carrying amount <code>undrawn_amount</code> <code>Float64</code> Undrawn commitment <code>ccf</code> <code>Float64</code> Credit conversion factor <code>ead</code> <code>Float64</code> Exposure at default <code>cqs</code> <code>Int32</code> Credit quality step <code>pd</code> <code>Float64</code> Probability of default <code>lgd</code> <code>Float64</code> Loss given default <code>effective_maturity</code> <code>Float64</code> Effective maturity (years) <code>turnover</code> <code>Float64</code> Counterparty turnover <code>is_sme</code> <code>Boolean</code> SME indicator <code>is_infrastructure</code> <code>Boolean</code> Infrastructure indicator <p>Valid <code>exposure_class</code> values: - <code>CENTRAL_GOVT_CENTRAL_BANK</code> - <code>INSTITUTION</code> - <code>CORPORATE</code> - <code>CORPORATE_SME</code> - <code>RETAIL_MORTGAGE</code> - <code>RETAIL_QRRE</code> - <code>RETAIL_OTHER</code> - <code>SPECIALISED_LENDING</code> - <code>EQUITY</code> - <code>DEFAULTED</code> - <code>PSE</code> - <code>MDB</code> - <code>RGLA</code> - <code>OTHER</code></p> <p>Valid <code>approach_type</code> values: - <code>SA</code> - Standardised Approach - <code>FIRB</code> - Foundation IRB - <code>AIRB</code> - Advanced IRB - <code>SLOTTING</code> - Slotting Approach</p>"},{"location":"data-model/intermediate-schemas/#crm-adjusted-schema","title":"CRM Adjusted Schema","text":"<p>After CRM processing, exposures include mitigation adjustments.</p> Column Type Description <code>exposure_id</code> <code>Utf8</code> Exposure identifier ... ... (all classified exposure columns) <code>provision_amount</code> <code>Float64</code> Applied provision <code>provision_type</code> <code>Utf8</code> SCRA or GCRA <code>collateral_value</code> <code>Float64</code> Total collateral value <code>collateral_type</code> <code>Utf8</code> Primary collateral type <code>collateral_haircut</code> <code>Float64</code> Applied haircut <code>currency_mismatch_haircut</code> <code>Float64</code> FX mismatch haircut <code>net_collateral_value</code> <code>Float64</code> Collateral after haircuts <code>guaranteed_amount</code> <code>Float64</code> Guaranteed portion <code>guarantor_id</code> <code>Utf8</code> Guarantor identifier <code>guarantor_type</code> <code>Utf8</code> Guarantor type <code>guarantor_cqs</code> <code>Int32</code> Guarantor CQS <code>guarantor_rw</code> <code>Float64</code> Guarantor risk weight <code>maturity_mismatch_factor</code> <code>Float64</code> Maturity mismatch adj <code>net_ead</code> <code>Float64</code> EAD after CRM <code>net_ead_unsecured</code> <code>Float64</code> Unsecured portion <code>net_ead_guaranteed</code> <code>Float64</code> Guaranteed portion"},{"location":"data-model/intermediate-schemas/#specialised-lending-schema","title":"Specialised Lending Schema","text":"<p>For slotting approach exposures.</p> Column Type Description <code>exposure_id</code> <code>Utf8</code> Exposure identifier ... ... (all CRM adjusted columns) <code>lending_type</code> <code>Utf8</code> Type of specialised lending <code>slotting_category</code> <code>Utf8</code> Strong/Good/Satisfactory/Weak <code>is_pre_operational</code> <code>Boolean</code> Pre-operational phase <code>is_hvcre</code> <code>Boolean</code> High volatility CRE <p>Valid <code>lending_type</code> values: - <code>PROJECT_FINANCE</code> - <code>OBJECT_FINANCE</code> - <code>COMMODITIES_FINANCE</code> - <code>IPRE</code> - Income-producing real estate - <code>HVCRE</code> - High volatility CRE</p> <p>Valid <code>slotting_category</code> values: - <code>STRONG</code> - <code>GOOD</code> - <code>SATISFACTORY</code> - <code>WEAK</code> - <code>DEFAULT</code></p>"},{"location":"data-model/intermediate-schemas/#transformation-examples","title":"Transformation Examples","text":""},{"location":"data-model/intermediate-schemas/#hierarchy-resolution","title":"Hierarchy Resolution","text":"<pre><code># Input\ncounterparties = pl.DataFrame({\n    \"counterparty_id\": [\"C001\", \"C002\"],\n    \"parent_counterparty_id\": [None, \"C001\"],\n    \"rating\": [None, \"A\"],\n})\n\n# After resolution\nresolved = pl.DataFrame({\n    \"counterparty_id\": [\"C001\", \"C002\"],\n    \"ultimate_parent_id\": [\"C001\", \"C001\"],\n    \"hierarchy_level\": [0, 1],\n    \"inherited_rating\": [\"A\", \"A\"],  # C001 inherits from C002\n})\n</code></pre>"},{"location":"data-model/intermediate-schemas/#classification","title":"Classification","text":"<pre><code># Input\nexposure = {\n    \"counterparty_type\": \"CORPORATE\",\n    \"turnover\": 30_000_000,  # EUR\n    \"total_exposure\": 5_000_000,\n}\n\n# After classification\nclassified = {\n    \"exposure_class\": \"CORPORATE_SME\",  # turnover &lt; EUR 50m\n    \"approach_type\": \"SA\",\n    \"is_sme\": True,\n}\n</code></pre>"},{"location":"data-model/intermediate-schemas/#crm-application","title":"CRM Application","text":"<pre><code># Input\nexposure = {\"ead\": 10_000_000}\ncollateral = {\"value\": 8_000_000, \"type\": \"GOVERNMENT_BOND\", \"maturity\": 3}\n\n# After CRM\ncrm_adjusted = {\n    \"collateral_value\": 8_000_000,\n    \"collateral_haircut\": 0.02,  # 2% for 1-5yr govt bond\n    \"net_collateral_value\": 7_840_000,\n    \"net_ead\": 2_160_000,  # 10m - 7.84m\n}\n</code></pre>"},{"location":"data-model/intermediate-schemas/#next-steps","title":"Next Steps","text":"<ul> <li>Output Schemas</li> <li>Regulatory Tables</li> <li>Pipeline Architecture</li> </ul>"},{"location":"data-model/output-schemas/","title":"Output Schemas","text":"<p>This page documents the schemas for calculation results and output data.</p>"},{"location":"data-model/output-schemas/#sa-result-schema","title":"SA Result Schema","text":"<p>Results from Standardised Approach calculation.</p> Column Type Description <code>exposure_id</code> <code>Utf8</code> Exposure identifier <code>counterparty_id</code> <code>Utf8</code> Counterparty identifier <code>facility_id</code> <code>Utf8</code> Facility identifier <code>exposure_class</code> <code>Utf8</code> Regulatory exposure class <code>ead</code> <code>Float64</code> Exposure at default <code>cqs</code> <code>Int32</code> Credit quality step <code>risk_weight</code> <code>Float64</code> Applied risk weight <code>rwa_base</code> <code>Float64</code> RWA before factors <code>sme_factor</code> <code>Float64</code> SME supporting factor <code>infrastructure_factor</code> <code>Float64</code> Infrastructure factor <code>rwa</code> <code>Float64</code> Final RWA"},{"location":"data-model/output-schemas/#irb-result-schema","title":"IRB Result Schema","text":"<p>Results from IRB approach calculation.</p> Column Type Description <code>exposure_id</code> <code>Utf8</code> Exposure identifier <code>counterparty_id</code> <code>Utf8</code> Counterparty identifier <code>facility_id</code> <code>Utf8</code> Facility identifier <code>exposure_class</code> <code>Utf8</code> Regulatory exposure class <code>approach_type</code> <code>Utf8</code> FIRB or AIRB <code>ead</code> <code>Float64</code> Exposure at default <code>pd_input</code> <code>Float64</code> Input PD <code>pd_floored</code> <code>Float64</code> PD after floor <code>lgd_input</code> <code>Float64</code> Input LGD <code>lgd_floored</code> <code>Float64</code> LGD after floor <code>correlation</code> <code>Float64</code> Asset correlation <code>k</code> <code>Float64</code> Capital requirement <code>effective_maturity</code> <code>Float64</code> Effective maturity <code>maturity_adjustment</code> <code>Float64</code> Maturity adjustment <code>scaling_factor</code> <code>Float64</code> CRR scaling (1.06 or 1.0) <code>rwa</code> <code>Float64</code> Risk-weighted assets <code>expected_loss</code> <code>Float64</code> PD \u00d7 LGD \u00d7 EAD"},{"location":"data-model/output-schemas/#slotting-result-schema","title":"Slotting Result Schema","text":"<p>Results from slotting approach calculation.</p> Column Type Description <code>exposure_id</code> <code>Utf8</code> Exposure identifier <code>counterparty_id</code> <code>Utf8</code> Counterparty identifier <code>facility_id</code> <code>Utf8</code> Facility identifier <code>lending_type</code> <code>Utf8</code> Specialised lending type <code>slotting_category</code> <code>Utf8</code> Strong/Good/Satisfactory/Weak <code>ead</code> <code>Float64</code> Exposure at default <code>risk_weight</code> <code>Float64</code> Slotting risk weight <code>infrastructure_factor</code> <code>Float64</code> Infrastructure factor <code>rwa</code> <code>Float64</code> Risk-weighted assets"},{"location":"data-model/output-schemas/#aggregated-result-schema","title":"Aggregated Result Schema","text":"<p>Combined results with totals and floor adjustments.</p> Column Type Description <code>exposure_id</code> <code>Utf8</code> Exposure identifier <code>counterparty_id</code> <code>Utf8</code> Counterparty identifier <code>facility_id</code> <code>Utf8</code> Facility identifier <code>exposure_class</code> <code>Utf8</code> Regulatory exposure class <code>approach</code> <code>Utf8</code> SA/IRB/SLOTTING <code>ead</code> <code>Float64</code> Exposure at default <code>rwa_pre_floor</code> <code>Float64</code> RWA before output floor <code>sa_equivalent_rwa</code> <code>Float64</code> SA equivalent (for IRB) <code>output_floor</code> <code>Float64</code> Output floor amount <code>floor_impact</code> <code>Float64</code> Floor add-on <code>rwa</code> <code>Float64</code> Final RWA <code>expected_loss</code> <code>Float64</code> Expected loss (IRB)"},{"location":"data-model/output-schemas/#summary-result-schema","title":"Summary Result Schema","text":"<p>High-level summary statistics.</p> Column Type Description <code>metric</code> <code>Utf8</code> Metric name <code>value</code> <code>Float64</code> Metric value <p>Standard metrics: - <code>total_ead</code> - <code>total_rwa</code> - <code>sa_rwa</code> - <code>irb_rwa</code> - <code>slotting_rwa</code> - <code>total_expected_loss</code> - <code>floor_impact_total</code> - <code>average_risk_weight</code></p>"},{"location":"data-model/output-schemas/#breakdown-schemas","title":"Breakdown Schemas","text":""},{"location":"data-model/output-schemas/#by-exposure-class","title":"By Exposure Class","text":"Column Type Description <code>exposure_class</code> <code>Utf8</code> Exposure class <code>count</code> <code>Int64</code> Number of exposures <code>ead</code> <code>Float64</code> Total EAD <code>rwa</code> <code>Float64</code> Total RWA <code>average_rw</code> <code>Float64</code> Average risk weight"},{"location":"data-model/output-schemas/#by-approach","title":"By Approach","text":"Column Type Description <code>approach</code> <code>Utf8</code> Calculation approach <code>count</code> <code>Int64</code> Number of exposures <code>ead</code> <code>Float64</code> Total EAD <code>rwa</code> <code>Float64</code> Total RWA"},{"location":"data-model/output-schemas/#by-counterparty","title":"By Counterparty","text":"Column Type Description <code>counterparty_id</code> <code>Utf8</code> Counterparty <code>counterparty_name</code> <code>Utf8</code> Name <code>ead</code> <code>Float64</code> Total EAD <code>rwa</code> <code>Float64</code> Total RWA <code>average_rw</code> <code>Float64</code> Average risk weight"},{"location":"data-model/output-schemas/#result-bundle","title":"Result Bundle","text":"<p>The final result is wrapped in a bundle object:</p> <pre><code>@dataclass(frozen=True)\nclass AggregatedResultBundle:\n    \"\"\"Final calculation results.\"\"\"\n\n    data: pl.LazyFrame           # Detailed exposure-level results\n    errors: list[CalculationError]  # Any calculation errors\n    warnings: list[CalculationWarning]  # Any warnings\n\n    @property\n    def total_rwa(self) -&gt; float:\n        \"\"\"Total risk-weighted assets.\"\"\"\n        return self.data.select(pl.col(\"rwa\").sum()).collect().item()\n\n    @property\n    def total_ead(self) -&gt; float:\n        \"\"\"Total exposure at default.\"\"\"\n        return self.data.select(pl.col(\"ead\").sum()).collect().item()\n\n    def to_dataframe(self) -&gt; pl.DataFrame:\n        \"\"\"Materialize results as DataFrame.\"\"\"\n        return self.data.collect()\n\n    def to_parquet(self, path: str) -&gt; None:\n        \"\"\"Export results to Parquet.\"\"\"\n        self.data.collect().write_parquet(path)\n\n    def to_csv(self, path: str) -&gt; None:\n        \"\"\"Export results to CSV.\"\"\"\n        self.data.collect().write_csv(path)\n\n    def by_exposure_class(self) -&gt; pl.DataFrame:\n        \"\"\"Get breakdown by exposure class.\"\"\"\n        return (\n            self.data\n            .group_by(\"exposure_class\")\n            .agg(\n                pl.count().alias(\"count\"),\n                pl.col(\"ead\").sum(),\n                pl.col(\"rwa\").sum(),\n            )\n            .collect()\n        )\n</code></pre>"},{"location":"data-model/output-schemas/#export-formats","title":"Export Formats","text":""},{"location":"data-model/output-schemas/#parquet","title":"Parquet","text":"<pre><code>result.to_parquet(\"rwa_results.parquet\")\n</code></pre> <p>Includes: - Full precision numeric values - Efficient compression - Schema preservation</p>"},{"location":"data-model/output-schemas/#csv","title":"CSV","text":"<pre><code>result.to_csv(\"rwa_results.csv\")\n</code></pre> <p>Includes: - Human-readable format - Excel-compatible - Standard delimiters</p>"},{"location":"data-model/output-schemas/#json","title":"JSON","text":"<pre><code>result.to_json(\"rwa_results.json\")\n</code></pre> <p>Includes: - Nested structure support - Metadata - Summary statistics</p>"},{"location":"data-model/output-schemas/#example-output","title":"Example Output","text":""},{"location":"data-model/output-schemas/#detailed-results","title":"Detailed Results","text":"<pre><code>result.to_dataframe().head()\n</code></pre> exposure_id exposure_class approach ead rwa E001 CORPORATE SA 1,000,000 500,000 E002 CORPORATE_SME SA 500,000 207,975 E003 RETAIL_MORTGAGE SA 250,000 87,500 E004 INSTITUTION FIRB 5,000,000 1,250,000"},{"location":"data-model/output-schemas/#summary","title":"Summary","text":"<pre><code>print(f\"Total EAD: {result.total_ead:,.0f}\")\nprint(f\"Total RWA: {result.total_rwa:,.0f}\")\nprint(f\"Average RW: {result.total_rwa / result.total_ead:.1%}\")\n</code></pre> <pre><code>Total EAD: 6,750,000\nTotal RWA: 2,045,475\nAverage RW: 30.3%\n</code></pre>"},{"location":"data-model/output-schemas/#next-steps","title":"Next Steps","text":"<ul> <li>Regulatory Tables</li> <li>API Reference</li> <li>Configuration Guide</li> </ul>"},{"location":"data-model/regulatory-tables/","title":"Regulatory Tables","text":"<p>This page documents the lookup tables used for regulatory parameters.</p>"},{"location":"data-model/regulatory-tables/#risk-weight-tables","title":"Risk Weight Tables","text":""},{"location":"data-model/regulatory-tables/#sovereign-risk-weights","title":"Sovereign Risk Weights","text":"CQS CRR Risk Weight Basel 3.1 Risk Weight 1 0% 0% 2 20% 20% 3 50% 50% 4 100% 100% 5 100% 100% 6 150% 150% Unrated 100% 100%"},{"location":"data-model/regulatory-tables/#institution-risk-weights","title":"Institution Risk Weights","text":"CQS CRR Risk Weight Basel 3.1 (ECRA) 1 20% 20% 2 30%* 30% 3 50% 50% 4 100% 100% 5 100% 100% 6 150% 150% <p>*UK deviation from standard 50%</p>"},{"location":"data-model/regulatory-tables/#corporate-risk-weights","title":"Corporate Risk Weights","text":"CQS CRR Risk Weight Basel 3.1 Risk Weight 1 20% 20% 2 50% 50% 3 75% 75% 4 100% 100% 5 150% 100% 6 150% 150% Unrated 100% 100%"},{"location":"data-model/regulatory-tables/#retail-risk-weights","title":"Retail Risk Weights","text":"Exposure Type CRR Basel 3.1 Retail Mortgage (LTV \u226480%) 35% LTV-based Retail QRRE 75% 45-75% Retail Other 75% 75%"},{"location":"data-model/regulatory-tables/#basel-31-residential-real-estate","title":"Basel 3.1 Residential Real Estate","text":"LTV Whole Loan Income-Producing \u226450% 20% 30% 50-60% 25% 35% 60-70% 30% 45% 70-80% 40% 60% 80-90% 50% 75% 90-100% 70% 105% &gt;100% Counterparty RW Counterparty RW"},{"location":"data-model/regulatory-tables/#credit-conversion-factors","title":"Credit Conversion Factors","text":""},{"location":"data-model/regulatory-tables/#risk-type-categories-crr-art-111","title":"Risk Type Categories (CRR Art. 111)","text":"<p>The <code>risk_type</code> column determines CCF for all off-balance sheet exposures:</p> Code Full Value SA CCF F-IRB CCF Description <code>FR</code> <code>full_risk</code> 100% 100% Direct credit substitutes, guarantees, acceptances <code>MR</code> <code>medium_risk</code> 50% 75% NIFs, RUFs, standby LCs, committed undrawn <code>MLR</code> <code>medium_low_risk</code> 20% 75% Documentary credits, trade finance <code>LR</code> <code>low_risk</code> 0% 0% Unconditionally cancellable commitments <p>F-IRB 75% Rule (CRR Art. 166(8)): Under F-IRB, both MR and MLR categories use 75% CCF instead of SA values.</p> <p>F-IRB Exception (CRR Art. 166(9)): Short-term letters of credit arising from the movement of goods retain 20% CCF under F-IRB. Flag these with <code>is_short_term_trade_lc = True</code>.</p>"},{"location":"data-model/regulatory-tables/#legacy-ccf-categories","title":"Legacy CCF Categories","text":"Item Type CRR CCF Basel 3.1 CCF Unconditionally cancellable 0% 10% Short-term trade finance 20% 20% Undrawn commitments &lt;1yr 20% 40% Undrawn commitments \u22651yr 50% 40% NIFs/RUFs 50% 50% Direct credit substitutes 100% 100%"},{"location":"data-model/regulatory-tables/#supervisory-haircuts","title":"Supervisory Haircuts","text":""},{"location":"data-model/regulatory-tables/#financial-collateral","title":"Financial Collateral","text":"Collateral Type \u22641yr 1-5yr &gt;5yr Cash 0% 0% 0% Government CQS1 0.5% 2% 4% Government CQS2-3 1% 3% 6% Corporate CQS1-2 1% 4% 8% Corporate CQS3 2% 6% 12% Main index equity 15% 15% 15% Other equity 25% 25% 25% Gold 15% 15% 15%"},{"location":"data-model/regulatory-tables/#additional-haircuts","title":"Additional Haircuts","text":"Condition Haircut Currency mismatch +8% Daily revaluation absence +\u221a10 scaling"},{"location":"data-model/regulatory-tables/#slotting-risk-weights","title":"Slotting Risk Weights","text":""},{"location":"data-model/regulatory-tables/#standard-specialised-lending","title":"Standard Specialised Lending","text":"Category CRR Basel 3.1 Strong 70% 70% Good 70% 70% Satisfactory 115% 115% Weak 250% 250% <p>Note: Under CRR, Strong and Good both receive 70% RW.</p>"},{"location":"data-model/regulatory-tables/#project-finance-pre-operational-basel-31","title":"Project Finance Pre-Operational (Basel 3.1)","text":"Category Basel 3.1 Strong 80% Good 100% Satisfactory 120% Weak 350%"},{"location":"data-model/regulatory-tables/#hvcre","title":"HVCRE","text":"Category CRR Basel 3.1 Strong 70% 95% Good 70% 120% Satisfactory 115% 140% Weak 250% 250% <p>Note: Under CRR, HVCRE uses the same weights as standard specialised lending. Basel 3.1 introduces elevated weights for HVCRE.</p>"},{"location":"data-model/regulatory-tables/#f-irb-supervisory-lgd","title":"F-IRB Supervisory LGD","text":"Exposure Type LGD Senior unsecured 45% Subordinated 75% Secured - Financial collateral 0% Secured - Receivables 35% Secured - CRE/RRE 35% Secured - Other physical 40%"},{"location":"data-model/regulatory-tables/#a-irb-lgd-floors-basel-31","title":"A-IRB LGD Floors (Basel 3.1)","text":"Collateral Type LGD Floor Unsecured senior 25% Unsecured subordinated 50% Financial collateral 0% Receivables 10% Commercial real estate 10% Residential real estate 5% Other physical 15%"},{"location":"data-model/regulatory-tables/#pd-floors","title":"PD Floors","text":"Exposure Class CRR Basel 3.1 Corporate 0.03% 0.05% Institution 0.03% 0.05% Retail Mortgage 0.03% 0.05% Retail QRRE (transactor) 0.03% 0.03% Retail QRRE (revolver) 0.03% 0.10% Retail Other 0.03% 0.05%"},{"location":"data-model/regulatory-tables/#implementation","title":"Implementation","text":""},{"location":"data-model/regulatory-tables/#risk-weight-lookup","title":"Risk Weight Lookup","text":"<pre><code>from rwa_calc.data.tables.crr_risk_weights import get_risk_weight\n\nrw = get_risk_weight(\n    exposure_class=ExposureClass.CORPORATE,\n    cqs=CQS.CQS_2,\n    framework=RegulatoryFramework.CRR\n)\n# Returns: 0.50 (50%)\n</code></pre>"},{"location":"data-model/regulatory-tables/#ccf-lookup","title":"CCF Lookup","text":"<pre><code>from rwa_calc.data.tables.crr_ccf import get_ccf\n\nccf = get_ccf(\n    item_type=\"UNDRAWN_COMMITMENT\",\n    original_maturity_years=2,\n    framework=RegulatoryFramework.CRR\n)\n# Returns: 0.50 (50%)\n</code></pre>"},{"location":"data-model/regulatory-tables/#haircut-lookup","title":"Haircut Lookup","text":"<pre><code>from rwa_calc.data.tables.crr_haircuts import get_haircut\n\nhaircut = get_haircut(\n    collateral_type=CollateralType.GOVERNMENT_BOND,\n    cqs=CQS.CQS_1,\n    residual_maturity_years=3\n)\n# Returns: 0.02 (2%)\n</code></pre>"},{"location":"data-model/regulatory-tables/#slotting-lookup","title":"Slotting Lookup","text":"<pre><code>from rwa_calc.data.tables.crr_slotting import get_slotting_weight\n\nrw = get_slotting_weight(\n    lending_type=SpecialisedLendingType.PROJECT_FINANCE,\n    category=SlottingCategory.GOOD,\n    framework=RegulatoryFramework.CRR\n)\n# Returns: 0.90 (90%)\n</code></pre>"},{"location":"data-model/regulatory-tables/#next-steps","title":"Next Steps","text":"<ul> <li>API Reference</li> <li>Standardised Approach</li> <li>IRB Approach</li> </ul>"},{"location":"development/","title":"Development Guide","text":"<p>This section provides guidance for developers working on the RWA calculator.</p>"},{"location":"development/#overview","title":"Overview","text":"<p>The development guide covers:</p> <ul> <li>Testing Guide - Running tests, writing tests, test fixtures</li> <li>Workbooks &amp; UI - Marimo workbooks and interactive UI applications</li> <li>Benchmark Tests - Performance and scale testing (10K-10M)</li> <li>Adding Features - Extending the calculator</li> <li>Code Style - Coding standards and conventions</li> </ul>"},{"location":"development/#development-setup","title":"Development Setup","text":""},{"location":"development/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.13+</li> <li>uv package manager (recommended)</li> <li>Git</li> </ul>"},{"location":"development/#setup-steps","title":"Setup Steps","text":"<pre><code># Clone the repository\ngit clone https://github.com/OpenAfterHours/rwa_calculator.git\ncd rwa_calculator\n\n# Install with development dependencies\nuv sync --all-extras\n\n# Verify installation\nuv run pytest\n</code></pre>"},{"location":"development/#ide-configuration","title":"IDE Configuration","text":"<p>VS Code: <pre><code>{\n  \"python.defaultInterpreterPath\": \".venv/bin/python\",\n  \"python.formatting.provider\": \"none\",\n  \"[python]\": {\n    \"editor.defaultFormatter\": \"charliermarsh.ruff\",\n    \"editor.formatOnSave\": true\n  }\n}\n</code></pre></p> <p>PyCharm: 1. Open project directory 2. Configure interpreter to use <code>.venv</code> 3. Mark <code>src</code> as Sources Root 4. Enable Ruff integration</p>"},{"location":"development/#development-workflow","title":"Development Workflow","text":""},{"location":"development/#tdd-approach","title":"TDD Approach","text":"<p>The project follows Test-Driven Development:</p> <ol> <li>Write acceptance test - Define expected behavior</li> <li>Write unit tests - Test component behavior</li> <li>Implement - Write code to pass tests</li> <li>Refactor - Improve code while tests pass</li> </ol>"},{"location":"development/#branch-strategy","title":"Branch Strategy","text":"<pre><code>master\n  \u2514\u2500\u2500 feature/feature-name\n  \u2514\u2500\u2500 fix/bug-description\n  \u2514\u2500\u2500 tests/test-description\n</code></pre>"},{"location":"development/#commit-convention","title":"Commit Convention","text":"<pre><code>type: short description\n\n- Detail 1\n- Detail 2\n\nCo-Authored-By: Name &lt;email&gt;\n</code></pre> <p>Types: <code>feat</code>, <code>fix</code>, <code>docs</code>, <code>test</code>, <code>refactor</code>, <code>chore</code></p>"},{"location":"development/#project-structure","title":"Project Structure","text":"<pre><code>src/rwa_calc/\n\u251c\u2500\u2500 config/           # Configuration (FX rates)\n\u251c\u2500\u2500 contracts/        # Interfaces and data contracts\n\u2502   \u251c\u2500\u2500 bundles.py   # Data transfer objects\n\u2502   \u251c\u2500\u2500 config.py    # Configuration classes\n\u2502   \u251c\u2500\u2500 errors.py    # Error types\n\u2502   \u251c\u2500\u2500 protocols.py # Component interfaces\n\u2502   \u2514\u2500\u2500 validation.py\n\u251c\u2500\u2500 data/            # Schemas and lookup tables\n\u2502   \u251c\u2500\u2500 schemas.py   # Polars schemas\n\u2502   \u2514\u2500\u2500 tables/      # Regulatory tables\n\u251c\u2500\u2500 domain/          # Core domain\n\u2502   \u2514\u2500\u2500 enums.py     # Enumerations\n\u2514\u2500\u2500 engine/          # Calculation engine\n    \u251c\u2500\u2500 pipeline.py  # Orchestration\n    \u251c\u2500\u2500 loader.py    # Data loading\n    \u251c\u2500\u2500 hierarchy.py # Hierarchy resolution\n    \u251c\u2500\u2500 classifier.py # Classification\n    \u251c\u2500\u2500 ccf.py       # Credit conversion factors\n    \u251c\u2500\u2500 aggregator.py # Aggregation\n    \u251c\u2500\u2500 crm/         # Credit risk mitigation\n    \u251c\u2500\u2500 sa/          # Standardised approach\n    \u251c\u2500\u2500 irb/         # IRB approach\n    \u2514\u2500\u2500 slotting/    # Slotting approach\n</code></pre>"},{"location":"development/#key-development-principles","title":"Key Development Principles","text":""},{"location":"development/#1-lazyframe-operations","title":"1. LazyFrame Operations","text":"<p>Always use Polars LazyFrames:</p> <pre><code># Good\nresult = df.with_columns(\n    rwa=pl.col(\"ead\") * pl.col(\"risk_weight\")\n)\n\n# Bad - row iteration\nfor row in df.iter_rows():\n    rwa = row[\"ead\"] * row[\"risk_weight\"]\n</code></pre>"},{"location":"development/#2-protocol-based-design","title":"2. Protocol-Based Design","text":"<p>Implement protocols for new components:</p> <pre><code>from rwa_calc.contracts.protocols import CalculatorProtocol\n\nclass MyCalculator:\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; ResultBundle:\n        # Implementation\n        ...\n</code></pre>"},{"location":"development/#3-immutable-data","title":"3. Immutable Data","text":"<p>Use frozen dataclasses for data contracts:</p> <pre><code>from dataclasses import dataclass\n\n@dataclass(frozen=True)\nclass MyBundle:\n    data: pl.LazyFrame\n    metadata: dict\n</code></pre>"},{"location":"development/#4-error-accumulation","title":"4. Error Accumulation","text":"<p>Collect errors instead of raising:</p> <pre><code>errors = []\nfor exposure in exposures:\n    if not valid(exposure):\n        errors.append(CalculationError(\n            exposure_id=exposure.id,\n            message=\"Invalid exposure\"\n        ))\n\nreturn Result(data=data, errors=errors)\n</code></pre>"},{"location":"development/#running-tasks","title":"Running Tasks","text":""},{"location":"development/#tests","title":"Tests","text":"<pre><code># Run all tests\nuv run pytest\n\n# Run with coverage\nuv run pytest --cov=src/rwa_calc\n\n# Run specific test file\nuv run pytest tests/unit/test_pipeline.py\n\n# Run specific test\nuv run pytest tests/unit/test_pipeline.py::test_crr_calculation\n</code></pre>"},{"location":"development/#linting","title":"Linting","text":"<pre><code># Check code style\nuv run ruff check src tests\n\n# Fix automatically\nuv run ruff check --fix src tests\n\n# Format code\nuv run ruff format src tests\n</code></pre>"},{"location":"development/#type-checking","title":"Type Checking","text":"<pre><code># Run mypy\nuv run mypy src\n</code></pre>"},{"location":"development/#documentation","title":"Documentation","text":"<pre><code># Serve documentation locally\nuv run mkdocs serve\n\n# Build documentation\nuv run mkdocs build\n</code></pre>"},{"location":"development/#next-steps","title":"Next Steps","text":"<ul> <li>Testing Guide - Comprehensive testing documentation</li> <li>Adding Features - How to extend the calculator</li> <li>Code Style - Coding conventions</li> </ul>"},{"location":"development/benchmarks/","title":"Benchmark Tests","text":"<p>This guide covers the performance and scale testing infrastructure for validating calculator performance from 10K to 10M counterparties.</p>"},{"location":"development/benchmarks/#overview","title":"Overview","text":"<p>Benchmark tests validate that the RWA calculator meets performance requirements at various scales. The tests cover:</p> <ul> <li>Hierarchy Resolution - Building counterparty and facility hierarchies</li> <li>Pipeline Execution - End-to-end RWA calculation</li> <li>Memory Usage - Peak memory consumption at scale</li> <li>Component Performance - Individual calculator components</li> </ul>"},{"location":"development/benchmarks/#test-structure","title":"Test Structure","text":"<pre><code>tests/benchmarks/\n\u251c\u2500\u2500 test_hierarchy_benchmark.py   # HierarchyResolver performance\n\u2514\u2500\u2500 test_pipeline_benchmark.py    # End-to-end pipeline performance\n</code></pre>"},{"location":"development/benchmarks/#running-benchmarks","title":"Running Benchmarks","text":""},{"location":"development/benchmarks/#all-benchmarks","title":"All Benchmarks","text":"<pre><code># Run all benchmark tests\nuv run pytest tests/benchmarks/ -v\n\n# With detailed timing\nuv run pytest tests/benchmarks/ -v --tb=short\n</code></pre>"},{"location":"development/benchmarks/#by-scale","title":"By Scale","text":"<pre><code># Quick tests (10K counterparties)\nuv run pytest tests/benchmarks/ -m scale_10k -v\n\n# Standard benchmarks (100K counterparties)\nuv run pytest tests/benchmarks/ -m scale_100k -v\n\n# Large scale (1M counterparties) - slower\nuv run pytest tests/benchmarks/ -m scale_1m -v\n\n# Enterprise scale (10M counterparties) - very slow\nuv run pytest tests/benchmarks/ -m scale_10m -v\n</code></pre>"},{"location":"development/benchmarks/#skip-slow-tests","title":"Skip Slow Tests","text":"<pre><code># Skip 1M+ scale tests\nuv run pytest tests/benchmarks/ -m \"not slow\" -v\n\n# Only memory benchmarks\nuv run pytest tests/benchmarks/ -m benchmark -v\n</code></pre>"},{"location":"development/benchmarks/#test-markers","title":"Test Markers","text":"Marker Description Typical Duration <code>@pytest.mark.scale_10k</code> 10K counterparty tests &lt; 5 seconds <code>@pytest.mark.scale_100k</code> 100K counterparty tests &lt; 30 seconds <code>@pytest.mark.scale_1m</code> 1M counterparty tests &lt; 5 minutes <code>@pytest.mark.scale_10m</code> 10M counterparty tests &lt; 30 minutes <code>@pytest.mark.slow</code> Long-running tests (1M+) Minutes <code>@pytest.mark.benchmark</code> Memory/performance benchmarks Varies"},{"location":"development/benchmarks/#hierarchy-benchmarks","title":"Hierarchy Benchmarks","text":"<p>Tests for <code>HierarchyResolver</code> performance at scale.</p>"},{"location":"development/benchmarks/#test-classes","title":"Test Classes","text":""},{"location":"development/benchmarks/#testhierarchybenchmark10k","title":"<code>TestHierarchyBenchmark10K</code>","text":"<p>Quick validation tests at 10K scale:</p> Test Target Description <code>test_full_resolve_10k</code> &lt; 1 sec Full hierarchy resolution <code>test_counterparty_lookup_10k</code> - Counterparty lookup building <code>test_exposure_unification_10k</code> - Exposure unification"},{"location":"development/benchmarks/#testhierarchybenchmark100k","title":"<code>TestHierarchyBenchmark100K</code>","text":"<p>Standard benchmark at 100K scale:</p> Test Target Description <code>test_full_resolve_100k</code> &lt; 5 sec Full hierarchy resolution <code>test_counterparty_lookup_100k</code> &lt; 2 sec Counterparty lookup building <code>test_org_hierarchy_depth_100k</code> - Verify hierarchy depth &gt;= 2 <code>test_facility_hierarchy_depth_100k</code> - Verify facility depth &gt;= 2"},{"location":"development/benchmarks/#testhierarchybenchmark1m","title":"<code>TestHierarchyBenchmark1M</code>","text":"<p>Large scale tests (marked <code>@pytest.mark.slow</code>):</p> Test Target Description <code>test_full_resolve_1m</code> &lt; 60 sec Full hierarchy resolution"},{"location":"development/benchmarks/#testhierarchybenchmark10m","title":"<code>TestHierarchyBenchmark10M</code>","text":"<p>Enterprise scale tests (marked <code>@pytest.mark.slow</code>):</p> Test Target Description <code>test_full_resolve_10m</code> &lt; 10 min Full hierarchy resolution"},{"location":"development/benchmarks/#testhierarchymemorybenchmark","title":"<code>TestHierarchyMemoryBenchmark</code>","text":"<p>Memory consumption tests:</p> Test Target Description <code>test_memory_usage_10k</code> &lt; 100 MB Peak memory at 10K <code>test_memory_usage_100k</code> &lt; 500 MB Peak memory at 100K"},{"location":"development/benchmarks/#pipeline-benchmarks","title":"Pipeline Benchmarks","text":"<p>End-to-end RWA calculation pipeline performance.</p>"},{"location":"development/benchmarks/#test-classes_1","title":"Test Classes","text":""},{"location":"development/benchmarks/#testpipelinebenchmark10k","title":"<code>TestPipelineBenchmark10K</code>","text":"<p>Quick pipeline validation:</p> Test Target Description <code>test_full_pipeline_sa_10k</code> &lt; 2 sec SA-only calculation <code>test_full_pipeline_crr_10k</code> &lt; 3 sec SA + IRB calculation"},{"location":"development/benchmarks/#testpipelinebenchmark100k","title":"<code>TestPipelineBenchmark100K</code>","text":"<p>Standard pipeline benchmarks:</p> Test Target Description <code>test_full_pipeline_sa_100k</code> &lt; 10 sec SA-only calculation <code>test_full_pipeline_crr_100k</code> &lt; 15 sec SA + IRB calculation <code>test_pipeline_throughput_100k</code> - Measures exposures/second"},{"location":"development/benchmarks/#testpipelinebenchmark1m","title":"<code>TestPipelineBenchmark1M</code>","text":"<p>Large scale pipeline tests:</p> Test Target Description <code>test_full_pipeline_sa_1m</code> &lt; 120 sec SA-only at 1M scale"},{"location":"development/benchmarks/#testpipelinebenchmark10m","title":"<code>TestPipelineBenchmark10M</code>","text":"<p>Enterprise scale pipeline tests:</p> Test Target Description <code>test_full_pipeline_sa_10m</code> &lt; 20 min SA-only at 10M scale"},{"location":"development/benchmarks/#approach-specific-benchmarks","title":"Approach-Specific Benchmarks","text":"<p>Tests at 100K scale for different calculation approaches:</p>"},{"location":"development/benchmarks/#testapproachbenchmarks100k","title":"<code>TestApproachBenchmarks100K</code>","text":"Test Description <code>test_sa_only_100k</code> All exposures use SA (no IRB) <code>test_full_irb_100k</code> All eligible exposures use IRB <code>test_irb_with_slotting_100k</code> IRB + Slotting approach <code>test_partial_irb_corporate_only_100k</code> Corporate-only IRB <code>test_basel_3_1_with_output_floor_100k</code> Basel 3.1 with output floor"},{"location":"development/benchmarks/#testapproachbenchmarks1m","title":"<code>TestApproachBenchmarks1M</code>","text":"Test Description <code>test_sa_only_1m</code> SA-only at 1M scale <code>test_full_irb_1m</code> Full IRB at 1M scale <code>test_irb_with_slotting_1m</code> IRB + Slotting at 1M scale"},{"location":"development/benchmarks/#component-benchmarks","title":"Component Benchmarks","text":"<p>Individual component performance at 100K scale:</p>"},{"location":"development/benchmarks/#testcomponentbenchmarks100k","title":"<code>TestComponentBenchmarks100K</code>","text":"Test Description <code>test_classifier_100k</code> Exposure classifier performance <code>test_sa_calculator_100k</code> SA calculator performance"},{"location":"development/benchmarks/#irb-formula-benchmarks","title":"IRB Formula Benchmarks","text":"<p>The IRB formula implementation uses pure Polars expressions with <code>polars-normal-stats</code> for statistical functions, enabling full lazy evaluation and streaming.</p>"},{"location":"development/benchmarks/#performance-results","title":"Performance Results","text":"Scale Mean Time Throughput 10,000 7.2 ms 1.4M rows/s 100,000 32.3 ms 3.1M rows/s 1,000,000 298 ms 3.4M rows/s <p>Key benefits of the pure Polars implementation:</p> <ul> <li>Full lazy evaluation: Query optimization preserved throughout</li> <li>Streaming-capable: Datasets larger than memory can be processed</li> <li>No data conversion: No NumPy/SciPy overhead</li> <li>Sub-second for 1M rows: 1 million IRB exposures processed in ~300ms</li> </ul> <p>Run the IRB formula benchmark:</p> <pre><code>uv run python tests/benchmarks/benchmark_irb_formulas.py\n</code></pre>"},{"location":"development/benchmarks/#memory-benchmarks","title":"Memory Benchmarks","text":""},{"location":"development/benchmarks/#testpipelinememorybenchmark","title":"<code>TestPipelineMemoryBenchmark</code>","text":"Test Target Description <code>test_pipeline_memory_100k</code> &lt; 2 GB Peak memory during pipeline"},{"location":"development/benchmarks/#performance-targets-summary","title":"Performance Targets Summary","text":""},{"location":"development/benchmarks/#hierarchy-resolution","title":"Hierarchy Resolution","text":"Scale Target Time Memory 10K &lt; 1 sec &lt; 100 MB 100K &lt; 5 sec &lt; 500 MB 1M &lt; 60 sec - 10M &lt; 10 min -"},{"location":"development/benchmarks/#pipeline-execution","title":"Pipeline Execution","text":"Scale SA Only SA + IRB 10K &lt; 2 sec &lt; 3 sec 100K &lt; 10 sec &lt; 15 sec 1M &lt; 120 sec - 10M &lt; 20 min -"},{"location":"development/benchmarks/#writing-benchmark-tests","title":"Writing Benchmark Tests","text":""},{"location":"development/benchmarks/#basic-structure","title":"Basic Structure","text":"<pre><code>import pytest\nimport time\n\nclass TestMyBenchmark:\n    \"\"\"Benchmark tests for MyComponent.\"\"\"\n\n    @pytest.mark.scale_100k\n    def test_my_component_100k(self, dataset_100k):\n        \"\"\"Test MyComponent at 100K scale.\"\"\"\n        start = time.perf_counter()\n\n        # Run the operation\n        result = my_component.process(dataset_100k)\n\n        duration = time.perf_counter() - start\n\n        # Assert performance target\n        assert duration &lt; 10.0, f\"Expected &lt; 10s, got {duration:.2f}s\"\n\n        # Assert correctness\n        assert result.is_valid\n</code></pre>"},{"location":"development/benchmarks/#using-dataset-generators","title":"Using Dataset Generators","text":"<p>The benchmark tests use dataset generators that create realistic data distributions:</p> <pre><code>@pytest.fixture\ndef dataset_100k():\n    \"\"\"Generate 100K counterparty dataset.\"\"\"\n    return generate_dataset(\n        num_counterparties=100_000,\n        facilities_per_counterparty=3,\n        loans_per_facility=2,\n    )\n</code></pre>"},{"location":"development/benchmarks/#memory-testing","title":"Memory Testing","text":"<pre><code>import tracemalloc\n\n@pytest.mark.benchmark\ndef test_memory_usage(self, dataset):\n    \"\"\"Test memory consumption.\"\"\"\n    tracemalloc.start()\n\n    # Run operation\n    result = component.process(dataset)\n\n    current, peak = tracemalloc.get_traced_memory()\n    tracemalloc.stop()\n\n    peak_mb = peak / 1024 / 1024\n    assert peak_mb &lt; 500, f\"Expected &lt; 500 MB, got {peak_mb:.1f} MB\"\n</code></pre>"},{"location":"development/benchmarks/#cicd-integration","title":"CI/CD Integration","text":""},{"location":"development/benchmarks/#recommended-ci-configuration","title":"Recommended CI Configuration","text":"<pre><code># Run quick benchmarks on every PR\nbenchmark-quick:\n  script:\n    - uv run pytest tests/benchmarks/ -m \"scale_10k or scale_100k\" -v\n\n# Run full benchmarks nightly\nbenchmark-full:\n  schedule: \"0 2 * * *\"  # 2 AM daily\n  script:\n    - uv run pytest tests/benchmarks/ -v --tb=short\n</code></pre>"},{"location":"development/benchmarks/#performance-regression-detection","title":"Performance Regression Detection","text":"<p>Monitor benchmark results over time to detect regressions:</p> <pre><code># Generate benchmark report\nuv run pytest tests/benchmarks/ -v --benchmark-json=benchmark.json\n\n# Compare with baseline\nuv run pytest-benchmark compare benchmark.json baseline.json\n</code></pre>"},{"location":"development/benchmarks/#next-steps","title":"Next Steps","text":"<ul> <li>Testing Guide - General testing documentation</li> <li>Workbooks - Interactive UI and workbooks</li> <li>Architecture - Pipeline architecture details</li> </ul>"},{"location":"development/code-style/","title":"Code Style","text":"<p>This guide documents the coding conventions and style guidelines for the RWA calculator.</p>"},{"location":"development/code-style/#general-principles","title":"General Principles","text":"<ol> <li>Clarity over cleverness - Write readable code</li> <li>Consistency - Follow established patterns</li> <li>Simplicity - Avoid over-engineering</li> <li>Type safety - Use type hints everywhere</li> </ol>"},{"location":"development/code-style/#code-formatting","title":"Code Formatting","text":""},{"location":"development/code-style/#ruff-configuration","title":"Ruff Configuration","text":"<p>The project uses Ruff for linting and formatting:</p> <pre><code># pyproject.toml\n[tool.ruff]\ntarget-version = \"py313\"\nline-length = 100\nsrc = [\"src\", \"tests\"]\n\n[tool.ruff.lint]\nselect = [\n    \"E\",      # pycodestyle errors\n    \"W\",      # pycodestyle warnings\n    \"F\",      # Pyflakes\n    \"I\",      # isort\n    \"B\",      # flake8-bugbear\n    \"C4\",     # flake8-comprehensions\n    \"UP\",     # pyupgrade\n    \"SIM\",    # flake8-simplify\n]\n</code></pre>"},{"location":"development/code-style/#running-formatters","title":"Running Formatters","text":"<pre><code># Check style\nuv run ruff check src tests\n\n# Fix issues\nuv run ruff check --fix src tests\n\n# Format code\nuv run ruff format src tests\n</code></pre>"},{"location":"development/code-style/#naming-conventions","title":"Naming Conventions","text":""},{"location":"development/code-style/#variables-and-functions","title":"Variables and Functions","text":"<pre><code># snake_case for variables and functions\ntotal_rwa = calculate_total_rwa(exposures)\n\ndef calculate_risk_weight(exposure_class: ExposureClass) -&gt; Decimal:\n    ...\n</code></pre>"},{"location":"development/code-style/#classes","title":"Classes","text":"<pre><code># PascalCase for classes\nclass SACalculator:\n    ...\n\nclass RawDataBundle:\n    ...\n</code></pre>"},{"location":"development/code-style/#constants","title":"Constants","text":"<pre><code># UPPER_SNAKE_CASE for constants\nEUR_GBP_RATE = Decimal(\"0.88\")\nMAX_HIERARCHY_DEPTH = 10\nDEFAULT_PD_FLOOR = Decimal(\"0.0003\")\n</code></pre>"},{"location":"development/code-style/#private-members","title":"Private Members","text":"<pre><code># Single underscore for internal use\ndef _validate_exposure(exposure: dict) -&gt; list[Error]:\n    ...\n\n# Double underscore for name mangling (rarely used)\nclass Calculator:\n    def __init__(self):\n        self.__internal_state = {}\n</code></pre>"},{"location":"development/code-style/#type-hints","title":"Type Hints","text":""},{"location":"development/code-style/#function-signatures","title":"Function Signatures","text":"<pre><code>from decimal import Decimal\nimport polars as pl\n\ndef calculate_rwa(\n    exposures: pl.LazyFrame,\n    config: CalculationConfig,\n) -&gt; ResultBundle:\n    \"\"\"Calculate RWA for all exposures.\"\"\"\n    ...\n</code></pre>"},{"location":"development/code-style/#optional-types","title":"Optional Types","text":"<pre><code>from typing import Optional\n\n# Use | None (Python 3.10+)\ndef get_rating(counterparty_id: str) -&gt; str | None:\n    ...\n\n# For collections\ndef process_exposures(\n    exposures: list[Exposure],\n    filters: dict[str, str] | None = None,\n) -&gt; list[Result]:\n    ...\n</code></pre>"},{"location":"development/code-style/#generic-types","title":"Generic Types","text":"<pre><code>from typing import TypeVar, Generic\n\nT = TypeVar(\"T\")\n\nclass Result(Generic[T]):\n    def __init__(self, data: T, errors: list[Error]):\n        self.data = data\n        self.errors = errors\n</code></pre>"},{"location":"development/code-style/#docstrings","title":"Docstrings","text":""},{"location":"development/code-style/#google-style","title":"Google Style","text":"<pre><code>def calculate_maturity_adjustment(\n    pd: float,\n    effective_maturity: float,\n) -&gt; float:\n    \"\"\"\n    Calculate maturity adjustment factor for IRB.\n\n    The maturity adjustment accounts for the increased risk\n    of longer-dated exposures.\n\n    Args:\n        pd: Probability of default (0.0 to 1.0).\n        effective_maturity: Effective maturity in years (1-5).\n\n    Returns:\n        Maturity adjustment factor.\n\n    Raises:\n        ValueError: If PD is not in valid range.\n\n    Example:\n        &gt;&gt;&gt; ma = calculate_maturity_adjustment(0.01, 3.0)\n        &gt;&gt;&gt; print(f\"MA: {ma:.4f}\")\n        MA: 1.2345\n    \"\"\"\n</code></pre>"},{"location":"development/code-style/#class-docstrings","title":"Class Docstrings","text":"<pre><code>class SACalculator:\n    \"\"\"\n    Calculate RWA using the Standardised Approach.\n\n    The SA calculator applies regulatory risk weights to exposures\n    based on their credit quality and exposure class.\n\n    Attributes:\n        config: Calculation configuration.\n\n    Example:\n        &gt;&gt;&gt; calculator = SACalculator()\n        &gt;&gt;&gt; result = calculator.calculate(exposures, config)\n    \"\"\"\n</code></pre>"},{"location":"development/code-style/#module-organization","title":"Module Organization","text":""},{"location":"development/code-style/#import-order","title":"Import Order","text":"<pre><code># 1. Standard library\nfrom dataclasses import dataclass\nfrom datetime import date\nfrom decimal import Decimal\nfrom pathlib import Path\n\n# 2. Third-party\nimport polars as pl\nfrom polars_normal_stats import normal_cdf, normal_ppf\n\n# 3. Local - contracts first\nfrom rwa_calc.contracts.bundles import ResultBundle\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# 4. Local - other modules\nfrom rwa_calc.engine.irb.formulas import calculate_k\n</code></pre>"},{"location":"development/code-style/#module-structure","title":"Module Structure","text":"<pre><code>\"\"\"\nModule docstring explaining purpose.\n\nThis module provides...\n\"\"\"\n\n# Imports (as above)\n\n# Constants\nDEFAULT_VALUE = Decimal(\"0.45\")\n\n# Main entry point (top of module)\ndef main_function():\n    \"\"\"Main entry point - at top for visibility.\"\"\"\n    ...\n\n# Supporting functions\ndef _helper_function():\n    \"\"\"Internal helper.\"\"\"\n    ...\n\n# Classes\nclass MainClass:\n    \"\"\"Primary class.\"\"\"\n    ...\n\nclass _HelperClass:\n    \"\"\"Internal helper class.\"\"\"\n    ...\n</code></pre>"},{"location":"development/code-style/#data-classes","title":"Data Classes","text":""},{"location":"development/code-style/#frozen-data-classes","title":"Frozen Data Classes","text":"<pre><code>from dataclasses import dataclass, field\n\n@dataclass(frozen=True)\nclass ResultBundle:\n    \"\"\"Immutable result container.\"\"\"\n\n    data: pl.LazyFrame\n    errors: list[CalculationError] = field(default_factory=list)\n\n    @property\n    def has_errors(self) -&gt; bool:\n        \"\"\"Whether any errors occurred.\"\"\"\n        return len(self.errors) &gt; 0\n</code></pre>"},{"location":"development/code-style/#with-validation","title":"With Validation","text":"<pre><code>@dataclass(frozen=True)\nclass PDFloor:\n    \"\"\"PD floor with validation.\"\"\"\n\n    value: Decimal\n\n    def __post_init__(self):\n        if self.value &lt; 0 or self.value &gt; 1:\n            raise ValueError(f\"PD floor must be between 0 and 1, got {self.value}\")\n</code></pre>"},{"location":"development/code-style/#error-handling","title":"Error Handling","text":""},{"location":"development/code-style/#custom-exceptions","title":"Custom Exceptions","text":"<pre><code>class CalculationError(Exception):\n    \"\"\"Base exception for calculation errors.\"\"\"\n\n    def __init__(\n        self,\n        message: str,\n        exposure_id: str | None = None,\n        stage: str | None = None,\n    ):\n        super().__init__(message)\n        self.exposure_id = exposure_id\n        self.stage = stage\n</code></pre>"},{"location":"development/code-style/#error-accumulation","title":"Error Accumulation","text":"<pre><code>def process_exposures(exposures: list[dict]) -&gt; Result:\n    \"\"\"Process exposures, accumulating errors.\"\"\"\n    results = []\n    errors = []\n\n    for exposure in exposures:\n        try:\n            result = calculate_single(exposure)\n            results.append(result)\n        except ValidationError as e:\n            errors.append(CalculationError(\n                message=str(e),\n                exposure_id=exposure.get(\"id\"),\n            ))\n\n    return Result(data=results, errors=errors)\n</code></pre>"},{"location":"development/code-style/#polars-best-practices","title":"Polars Best Practices","text":""},{"location":"development/code-style/#use-lazyframes","title":"Use LazyFrames","text":"<pre><code># Good - lazy evaluation\nresult = (\n    df\n    .filter(pl.col(\"exposure_class\") == \"CORPORATE\")\n    .with_columns(rwa=pl.col(\"ead\") * pl.col(\"risk_weight\"))\n    .group_by(\"counterparty_id\")\n    .agg(pl.col(\"rwa\").sum())\n)\n\n# Bad - eager evaluation\ndf_filtered = df.filter(pl.col(\"exposure_class\") == \"CORPORATE\").collect()\ndf_with_rwa = df_filtered.with_columns(...)  # Loses optimization\n</code></pre>"},{"location":"development/code-style/#chain-operations","title":"Chain Operations","text":"<pre><code># Good - single chain\nresult = (\n    df\n    .filter(condition)\n    .with_columns(new_col)\n    .group_by(group_col)\n    .agg(aggregations)\n)\n\n# Bad - multiple assignments\ndf1 = df.filter(condition)\ndf2 = df1.with_columns(new_col)\ndf3 = df2.group_by(group_col)\nresult = df3.agg(aggregations)\n</code></pre>"},{"location":"development/code-style/#use-expressions","title":"Use Expressions","text":"<pre><code># Good - vectorized\ndf.with_columns(\n    rwa=pl.col(\"ead\") * pl.col(\"risk_weight\")\n)\n\n# Bad - row iteration\nfor row in df.iter_rows():\n    rwa = row[\"ead\"] * row[\"risk_weight\"]\n</code></pre>"},{"location":"development/code-style/#testing-style","title":"Testing Style","text":""},{"location":"development/code-style/#test-naming","title":"Test Naming","text":"<pre><code># Descriptive names\ndef test_sme_factor_returns_0_7619_for_exposure_below_threshold():\n    ...\n\ndef test_irb_calculator_raises_error_for_negative_pd():\n    ...\n\n# Not\ndef test_sme():\n    ...\n</code></pre>"},{"location":"development/code-style/#arrange-act-assert","title":"Arrange-Act-Assert","text":"<pre><code>def test_calculate_k():\n    \"\"\"Test IRB K formula calculation.\"\"\"\n    # Arrange\n    pd = 0.01\n    lgd = 0.45\n    correlation = 0.20\n\n    # Act\n    result = calculate_k(pd, lgd, correlation)\n\n    # Assert\n    assert result == pytest.approx(0.0445, rel=0.01)\n</code></pre>"},{"location":"development/code-style/#comments","title":"Comments","text":""},{"location":"development/code-style/#when-to-comment","title":"When to Comment","text":"<pre><code># Good - explain why, not what\n# CRR Article 153 requires 1.06 scaling for all IRB exposures\nrwa = k * 12.5 * ead * ma * 1.06\n\n# Bad - obvious comment\n# Calculate RWA\nrwa = k * 12.5 * ead * ma * 1.06\n</code></pre>"},{"location":"development/code-style/#todo-comments","title":"TODO Comments","text":"<pre><code># TODO: Implement Basel 3.1 output floor calculation\n# Reference: CRE99\n\n# FIXME: Handle edge case where maturity &lt; 1 year\n</code></pre>"},{"location":"development/code-style/#next-steps","title":"Next Steps","text":"<ul> <li>Testing Guide - Writing tests</li> <li>Adding Features - Extending the calculator</li> <li>Architecture - System design</li> </ul>"},{"location":"development/documentation-conventions/","title":"Documentation Conventions","text":"<p>This guide explains how to keep documentation synchronized with the codebase and avoid disconnected code examples.</p>"},{"location":"development/documentation-conventions/#problem-disconnected-documentation","title":"Problem: Disconnected Documentation","text":"<p>Documentation that contains pseudo-code or example snippets that don't match the actual implementation creates several problems:</p> <ol> <li>Misleading users who try to use the examples</li> <li>Maintenance burden when code changes but docs don't</li> <li>Loss of trust in documentation accuracy</li> </ol>"},{"location":"development/documentation-conventions/#solution-linked-documentation","title":"Solution: Linked Documentation","text":"<p>We use several techniques to keep documentation synchronized with code.</p>"},{"location":"development/documentation-conventions/#1-source-code-references","title":"1. Source Code References","text":"<p>Always include links to actual implementation when showing conceptual code:</p> <pre><code>!!! info \"Conceptual Logic\"\n    The following illustrates the logic. For the actual implementation,\n    see [`classifier.py:285-392`](https://github.com/OpenAfterHours/rwa_calculator/blob/master/src/rwa_calc/engine/classifier.py#L285-L392).\n</code></pre> <p>Format for GitHub links: <pre><code>https://github.com/OpenAfterHours/rwa_calculator/blob/master/src/rwa_calc/engine/classifier.py#L285-L392\n</code></pre></p>"},{"location":"development/documentation-conventions/#2-embedded-code-snippets","title":"2. Embedded Code Snippets","text":"<p>Use <code>pymdownx.snippets</code> to embed actual code from source files.</p> <p>Syntax:</p> <p>The snippet marker looks like scissors: two dashes, the digit 8, a less-than sign, and two more dashes (<code>-</code> <code>-</code> <code>8</code> <code>&lt;</code> <code>-</code> <code>-</code>), followed by a quoted file path.</p> Pattern Description Marker + <code>\"path/to/file.py\"</code> Include entire file Marker + <code>\"path/to/file.py:10:50\"</code> Include lines 10-50 <p>Path is relative to repository root. See pymdownx.snippets docs for full syntax.</p> <p>Example - the actual snippets in retail.md look like:</p> See retail.md for working example <pre><code>        \"\"\"\n        return exposures.with_columns([\n            # SA exposure class (used for SA risk weight lookup)\n            pl.col(\"cp_entity_type\")\n            .replace_strict(ENTITY_TYPE_TO_SA_CLASS, default=ExposureClass.OTHER.value)\n            .alias(\"exposure_class_sa\"),\n\n            # IRB exposure class (used for IRB formula selection)\n            # Note: PSE/RGLA map to sovereign or institution based on entity_type suffix\n            # MDB/international_org map to sovereign for IRB\n            pl.col(\"cp_entity_type\")\n            .replace_strict(ENTITY_TYPE_TO_IRB_CLASS, default=ExposureClass.OTHER.value)\n            .alias(\"exposure_class_irb\"),\n\n            # Unified exposure_class (SA class for backwards compatibility)\n            pl.col(\"cp_entity_type\")\n            .replace_strict(ENTITY_TYPE_TO_SA_CLASS, default=ExposureClass.OTHER.value)\n            .alias(\"exposure_class\"),\n        ])\n\n    def _apply_sme_classification(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n</code></pre>"},{"location":"development/documentation-conventions/#3-auto-generated-api-documentation","title":"3. Auto-generated API Documentation","text":"<p>Use <code>mkdocstrings</code> to generate documentation from docstrings:</p> <pre><code>::: rwa_calc.engine.classifier.ExposureClassifier\n    options:\n      show_root_heading: true\n      members:\n        - classify\n      show_source: false\n</code></pre> <p>This automatically pulls docstrings and keeps them in sync with code.</p>"},{"location":"development/documentation-conventions/#4-admonitions-for-pseudo-code","title":"4. Admonitions for Pseudo-code","text":"<p>When pseudo-code is necessary for conceptual explanation, mark it clearly:</p> <p><pre><code>!!! info \"Conceptual Logic\"\n    The following is simplified pseudo-code to illustrate the concept.\n\n```python\n# This is conceptual - see actual implementation below\ndef simplified_example():\n    pass\n</code></pre> <pre><code>### 5. Collapsible Actual Code\n\nUse collapsible sections to show lengthy actual code without cluttering the page:\n\n??? example \"See this working example from hierarchy.py\"\n    ```python\n        - Resolving facility-to-exposure mappings\n        - Aggregating lending group exposures for retail threshold\n\n        All operations use Polars LazyFrames for deferred execution.\n        \"\"\"\n\n        def _is_valid_optional_data(\n            self,\n            data: pl.LazyFrame | None,\n            required_columns: set[str] | None = None,\n        ) -&gt; bool:\n            \"\"\"\n            Check if optional data is valid for processing.\n\n            This provides defense-in-depth validation to ensure data:\n            - Is not None\n            - Has at least one row\n            - Has all required columns (if specified)\n\n            Args:\n                data: Optional LazyFrame to validate\n                required_columns: Set of column names that must be present (optional)\n\n            Returns:\n                True if data is valid for processing, False otherwise\n            \"\"\"\n            if data is None:\n                return False\n\n            try:\n                schema = data.collect_schema()\n\n                # Check required columns if specified\n                if required_columns is not None:\n                    if not required_columns.issubset(set(schema.names())):\n                        return False\n\n                # Check if there's at least one row\n                return data.head(1).collect().height &gt; 0\n            except Exception:\n                return False\n    ```\n\n## Best Practices\n\n### When Writing New Documentation\n\n1. **Start with the actual code** - Read the implementation first\n2. **Use mkdocstrings for API docs** - Let docstrings be the source of truth\n3. **Link, don't copy** - Use snippets rather than copying code\n4. **Mark pseudo-code clearly** - Use admonitions to indicate conceptual code\n\n### When Updating Code\n\n1. **Check for documentation** - Search for references to your function/class\n2. **Update line numbers** - Snippet references may need adjustment\n3. **Update docstrings** - mkdocstrings will pull these automatically\n4. **Run docs locally** - `mkdocs serve` to verify everything renders\n\n### Documentation Structure\n\n| Documentation Type | Approach |\n|-------------------|----------|\n| API Reference | Use `::: module.Class` for auto-generation |\n| Conceptual Guides | Pseudo-code with source links |\n| Tutorials | Embedded snippets from actual code |\n| Examples | Working code from test files |\n\n## Available Tools\n\n### pymdownx.snippets\n\nConfiguration in `mkdocs.yml`:\n```yaml\n- pymdownx.snippets:\n    base_path: ['.']\n    check_paths: false\n</code></pre></p>"},{"location":"development/documentation-conventions/#mkdocstrings","title":"mkdocstrings","text":"<p>Configuration in <code>mkdocs.yml</code>: <pre><code>- mkdocstrings:\n    handlers:\n      python:\n        options:\n          docstring_style: google\n          show_source: true\n          show_root_heading: true\n          members_order: source\n</code></pre></p>"},{"location":"development/documentation-conventions/#admonitions","title":"Admonitions","text":"<p>Available types: <code>note</code>, <code>info</code>, <code>tip</code>, <code>warning</code>, <code>danger</code>, <code>example</code></p>"},{"location":"development/documentation-conventions/#checking-documentation","title":"Checking Documentation","text":"<p>Before submitting changes:</p> <ol> <li>Run <code>mkdocs serve</code> locally</li> <li>Check that snippets render correctly</li> <li>Verify GitHub links point to correct lines</li> <li>Ensure mkdocstrings generates expected output</li> </ol>"},{"location":"development/documentation-conventions/#migration-checklist","title":"Migration Checklist","text":"<p>When finding disconnected code in documentation:</p> <ul> <li>[ ] Identify the actual implementation</li> <li>[ ] Add source code reference link</li> <li>[ ] Convert to embedded snippet if appropriate</li> <li>[ ] Add admonition if keeping conceptual code</li> <li>[ ] Update line references after code changes</li> </ul>"},{"location":"development/extending/","title":"Adding Features","text":"<p>This guide explains how to extend the RWA calculator with new functionality.</p>"},{"location":"development/extending/#extension-points","title":"Extension Points","text":"<p>The calculator is designed for extensibility at several points:</p> <ol> <li>New exposure classes</li> <li>New calculation approaches</li> <li>New CRM types</li> <li>Custom data loaders</li> <li>New regulatory tables</li> </ol>"},{"location":"development/extending/#adding-a-new-exposure-class","title":"Adding a New Exposure Class","text":""},{"location":"development/extending/#step-1-add-enum-value","title":"Step 1: Add Enum Value","text":"<pre><code># src/rwa_calc/domain/enums.py\n\nclass ExposureClass(str, Enum):\n    # ... existing classes ...\n    NEW_CLASS = \"NEW_CLASS\"  # Add new class\n</code></pre>"},{"location":"development/extending/#step-2-add-classification-logic","title":"Step 2: Add Classification Logic","text":"<pre><code># src/rwa_calc/engine/classifier.py\n\ndef _determine_exposure_class(\n    counterparty_type: str,\n    # ... other params ...\n) -&gt; ExposureClass:\n    # Add classification rule\n    if counterparty_type == \"NEW_TYPE\":\n        return ExposureClass.NEW_CLASS\n\n    # ... existing logic ...\n</code></pre>"},{"location":"development/extending/#step-3-add-risk-weight-table","title":"Step 3: Add Risk Weight Table","text":"<pre><code># src/rwa_calc/data/tables/crr_risk_weights.py\n\nNEW_CLASS_RISK_WEIGHTS = {\n    CQS.CQS_1: Decimal(\"0.20\"),\n    CQS.CQS_2: Decimal(\"0.50\"),\n    # ... etc ...\n}\n\ndef get_risk_weight(\n    exposure_class: ExposureClass,\n    cqs: CQS,\n    framework: RegulatoryFramework,\n) -&gt; Decimal:\n    if exposure_class == ExposureClass.NEW_CLASS:\n        return NEW_CLASS_RISK_WEIGHTS.get(cqs, Decimal(\"1.00\"))\n    # ... existing logic ...\n</code></pre>"},{"location":"development/extending/#step-4-add-tests","title":"Step 4: Add Tests","text":"<pre><code># tests/unit/test_new_class.py\n\nclass TestNewExposureClass:\n    def test_classification(self):\n        \"\"\"NEW_TYPE counterparty classified as NEW_CLASS.\"\"\"\n        # ...\n\n    def test_risk_weights(self):\n        \"\"\"NEW_CLASS risk weights are correct.\"\"\"\n        # ...\n</code></pre>"},{"location":"development/extending/#adding-a-custom-calculator","title":"Adding a Custom Calculator","text":""},{"location":"development/extending/#step-1-implement-protocol","title":"Step 1: Implement Protocol","text":"<pre><code># src/rwa_calc/engine/custom/calculator.py\n\nfrom rwa_calc.contracts.protocols import CalculatorProtocol\nfrom rwa_calc.contracts.bundles import ResultBundle\n\nclass CustomCalculator:\n    \"\"\"Custom calculator for specialized exposures.\"\"\"\n\n    def calculate(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; ResultBundle:\n        \"\"\"Calculate RWA using custom methodology.\"\"\"\n        result = (\n            exposures\n            .with_columns(\n                # Custom calculation logic\n                rwa=self._calculate_custom_rwa(\n                    pl.col(\"ead\"),\n                    pl.col(\"custom_param\"),\n                )\n            )\n        )\n\n        return ResultBundle(data=result)\n\n    def _calculate_custom_rwa(\n        self,\n        ead: pl.Expr,\n        custom_param: pl.Expr,\n    ) -&gt; pl.Expr:\n        \"\"\"Custom RWA calculation.\"\"\"\n        return ead * custom_param * 0.08  # Example\n</code></pre>"},{"location":"development/extending/#step-2-register-in-pipeline","title":"Step 2: Register in Pipeline","text":"<pre><code># src/rwa_calc/engine/pipeline.py\n\ndef create_pipeline(\n    custom_calculator: CustomCalculator | None = None,\n) -&gt; RWAPipeline:\n    \"\"\"Create pipeline with optional custom calculator.\"\"\"\n    return RWAPipeline(\n        # ... existing components ...\n        custom_calculator=custom_calculator or CustomCalculator(),\n    )\n</code></pre>"},{"location":"development/extending/#step-3-add-tests","title":"Step 3: Add Tests","text":"<pre><code># tests/unit/test_custom_calculator.py\n\nclass TestCustomCalculator:\n    def test_implements_protocol(self):\n        calculator = CustomCalculator()\n        # Verify protocol compliance\n\n    def test_calculation_logic(self, sample_exposures, config):\n        calculator = CustomCalculator()\n        result = calculator.calculate(sample_exposures, config)\n        # Verify results\n</code></pre>"},{"location":"development/extending/#adding-a-new-data-loader","title":"Adding a New Data Loader","text":""},{"location":"development/extending/#step-1-implement-protocol_1","title":"Step 1: Implement Protocol","text":"<pre><code># src/rwa_calc/engine/loaders/csv_loader.py\n\nfrom rwa_calc.contracts.protocols import LoaderProtocol\nfrom rwa_calc.contracts.bundles import RawDataBundle\n\nclass CSVLoader:\n    \"\"\"Load data from CSV files.\"\"\"\n\n    def load(self, path: Path) -&gt; RawDataBundle:\n        \"\"\"Load all data files from directory.\"\"\"\n        return RawDataBundle(\n            counterparties=pl.scan_csv(path / \"counterparties.csv\"),\n            facilities=pl.scan_csv(path / \"facilities.csv\"),\n            loans=pl.scan_csv(path / \"loans.csv\"),\n            # ... other files ...\n        )\n</code></pre>"},{"location":"development/extending/#step-2-use-in-pipeline","title":"Step 2: Use in Pipeline","text":"<pre><code>from rwa_calc.engine.loaders.csv_loader import CSVLoader\nfrom rwa_calc.engine.pipeline import RWAPipeline\n\n# Create pipeline with CSV loader\ncsv_loader = CSVLoader()\npipeline = RWAPipeline(\n    loader=csv_loader,\n    # ... other components ...\n)\n</code></pre>"},{"location":"development/extending/#adding-new-crm-type","title":"Adding New CRM Type","text":""},{"location":"development/extending/#step-1-add-collateral-type","title":"Step 1: Add Collateral Type","text":"<pre><code># src/rwa_calc/domain/enums.py\n\nclass CollateralType(str, Enum):\n    # ... existing types ...\n    NEW_COLLATERAL = \"NEW_COLLATERAL\"\n</code></pre>"},{"location":"development/extending/#step-2-add-haircut-table","title":"Step 2: Add Haircut Table","text":"<pre><code># src/rwa_calc/data/tables/crr_haircuts.py\n\nNEW_COLLATERAL_HAIRCUTS = {\n    \"&lt;=1yr\": Decimal(\"0.05\"),\n    \"1-5yr\": Decimal(\"0.10\"),\n    \"&gt;5yr\": Decimal(\"0.15\"),\n}\n</code></pre>"},{"location":"development/extending/#step-3-update-crm-processor","title":"Step 3: Update CRM Processor","text":"<pre><code># src/rwa_calc/engine/crm/processor.py\n\ndef _get_haircut(\n    collateral_type: CollateralType,\n    residual_maturity: float,\n) -&gt; Decimal:\n    if collateral_type == CollateralType.NEW_COLLATERAL:\n        if residual_maturity &lt;= 1:\n            return NEW_COLLATERAL_HAIRCUTS[\"&lt;=1yr\"]\n        # ... etc ...\n</code></pre>"},{"location":"development/extending/#adding-basel-31-features","title":"Adding Basel 3.1 Features","text":""},{"location":"development/extending/#step-1-add-configuration","title":"Step 1: Add Configuration","text":"<pre><code># src/rwa_calc/contracts/config.py\n\n@dataclass(frozen=True)\nclass Basel31SpecificConfig:\n    \"\"\"Basel 3.1 specific configuration.\"\"\"\n    new_feature_enabled: bool = True\n    new_feature_threshold: Decimal = Decimal(\"0.05\")\n</code></pre>"},{"location":"development/extending/#step-2-conditional-logic","title":"Step 2: Conditional Logic","text":"<pre><code># In calculator\ndef calculate(self, exposures: pl.LazyFrame, config: CalculationConfig):\n    result = exposures\n\n    if config.framework == RegulatoryFramework.BASEL_3_1:\n        result = self._apply_basel31_treatment(result, config)\n\n    return result\n\ndef _apply_basel31_treatment(\n    self,\n    exposures: pl.LazyFrame,\n    config: CalculationConfig,\n) -&gt; pl.LazyFrame:\n    \"\"\"Apply Basel 3.1 specific treatment.\"\"\"\n    return exposures.with_columns(\n        # Basel 3.1 specific logic\n    )\n</code></pre>"},{"location":"development/extending/#adding-new-regulatory-table","title":"Adding New Regulatory Table","text":""},{"location":"development/extending/#step-1-create-table-module","title":"Step 1: Create Table Module","text":"<pre><code># src/rwa_calc/data/tables/new_table.py\n\nimport polars as pl\nfrom decimal import Decimal\n\nNEW_TABLE = pl.DataFrame({\n    \"category\": [\"A\", \"B\", \"C\"],\n    \"weight\": [0.10, 0.20, 0.30],\n})\n\ndef lookup_new_table(category: str) -&gt; Decimal:\n    \"\"\"Look up value from new table.\"\"\"\n    result = NEW_TABLE.filter(pl.col(\"category\") == category)\n    if len(result) == 0:\n        raise ValueError(f\"Unknown category: {category}\")\n    return Decimal(str(result[\"weight\"][0]))\n</code></pre>"},{"location":"development/extending/#step-2-add-tests","title":"Step 2: Add Tests","text":"<pre><code># tests/unit/test_new_table.py\n\nclass TestNewTable:\n    @pytest.mark.parametrize(\"category,expected\", [\n        (\"A\", Decimal(\"0.10\")),\n        (\"B\", Decimal(\"0.20\")),\n        (\"C\", Decimal(\"0.30\")),\n    ])\n    def test_lookup_returns_correct_value(self, category, expected):\n        result = lookup_new_table(category)\n        assert result == expected\n\n    def test_unknown_category_raises(self):\n        with pytest.raises(ValueError):\n            lookup_new_table(\"UNKNOWN\")\n</code></pre>"},{"location":"development/extending/#using-polars-namespaces","title":"Using Polars Namespaces","text":"<p>The calculator uses Polars namespace extensions to provide fluent, chainable APIs for complex calculations. There are 8 namespaces available:</p> Namespace Purpose Key Methods <code>lf.sa</code> SA calculations <code>apply_risk_weights</code>, <code>calculate_rwa</code>, <code>apply_supporting_factors</code> <code>lf.irb</code> IRB calculations <code>apply_all_formulas</code>, <code>calculate_k</code>, <code>calculate_correlation</code> <code>lf.crm</code> CRM/EAD waterfall <code>initialize_ead_waterfall</code>, <code>apply_collateral</code>, <code>apply_guarantees</code> <code>lf.haircuts</code> Collateral haircuts <code>apply_collateral_haircuts</code>, <code>apply_fx_haircut</code>, <code>calculate_adjusted_value</code> <code>lf.slotting</code> Slotting calculations <code>apply_slotting_weights</code>, <code>calculate_rwa</code> <code>lf.hierarchy</code> Hierarchy resolution <code>resolve_ultimate_parent</code>, <code>inherit_ratings</code>, <code>calculate_lending_group_totals</code> <code>lf.aggregator</code> Result aggregation <code>combine_approach_results</code>, <code>apply_output_floor</code>, <code>generate_summary_by_class</code> <code>lf.audit</code> / <code>expr.audit</code> Audit formatting <code>build_sa_calculation</code>, <code>format_currency</code>, <code>format_percent</code>"},{"location":"development/extending/#using-existing-namespaces","title":"Using Existing Namespaces","text":"<p>All namespaces are registered when importing from <code>rwa_calc.engine</code>:</p> <pre><code>import polars as pl\nfrom datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\nfrom rwa_calc.engine import (\n    SALazyFrame, IRBLazyFrame, CRMLazyFrame,\n    HaircutsLazyFrame, SlottingLazyFrame,\n    HierarchyLazyFrame, AggregatorLazyFrame,\n    AuditLazyFrame, AuditExpr,\n)\n\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# SA calculation pipeline\nsa_result = (\n    exposures\n    .sa.prepare_columns(config)\n    .sa.apply_risk_weights(config)\n    .sa.calculate_rwa()\n    .sa.apply_supporting_factors(config)\n)\n\n# IRB calculation pipeline\nirb_result = (\n    exposures\n    .irb.classify_approach(config)\n    .irb.apply_firb_lgd(config)\n    .irb.prepare_columns(config)\n    .irb.apply_all_formulas(config)\n)\n\n# CRM/EAD waterfall\ncrm_result = (\n    exposures\n    .crm.initialize_ead_waterfall()\n    .crm.apply_collateral(collateral, config)\n    .crm.apply_guarantees(guarantees, counterparty_lookup, config)\n    .crm.finalize_ead()\n)\n\n# Hierarchy resolution\nhierarchy_result = (\n    counterparties\n    .hierarchy.resolve_ultimate_parent(org_mappings)\n    .hierarchy.inherit_ratings(ratings)\n)\n\n# Aggregation with output floor (Basel 3.1)\naggregated = (\n    results\n    .aggregator.combine_approach_results(sa=sa_results, irb=irb_results)\n    .aggregator.apply_output_floor(sa_for_floor, config)\n)\n\n# Audit trail formatting\naudited = exposures.audit.build_sa_calculation()\n</code></pre>"},{"location":"development/extending/#creating-a-new-namespace","title":"Creating a New Namespace","text":"<p>To add a new calculation namespace (e.g., for a custom approach):</p>"},{"location":"development/extending/#step-1-create-namespace-module","title":"Step 1: Create Namespace Module","text":"<pre><code># src/rwa_calc/engine/custom/namespace.py\n\nfrom __future__ import annotations\nfrom typing import TYPE_CHECKING\nimport polars as pl\n\nif TYPE_CHECKING:\n    from rwa_calc.contracts.config import CalculationConfig\n\n\n@pl.api.register_lazyframe_namespace(\"custom\")\nclass CustomLazyFrame:\n    \"\"\"LazyFrame namespace for custom calculations.\"\"\"\n\n    def __init__(self, lf: pl.LazyFrame) -&gt; None:\n        self._lf = lf\n\n    def apply_custom_formula(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Apply custom calculation formula.\"\"\"\n        return self._lf.with_columns(\n            (pl.col(\"ead\") * pl.col(\"risk_weight\")).alias(\"rwa\")\n        )\n\n    def validate_inputs(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n        \"\"\"Validate required columns exist.\"\"\"\n        schema = self._lf.collect_schema()\n        required = [\"ead\", \"risk_weight\"]\n        missing = [col for col in required if col not in schema.names()]\n        if missing:\n            raise ValueError(f\"Missing columns: {missing}\")\n        return self._lf\n\n\n@pl.api.register_expr_namespace(\"custom\")\nclass CustomExpr:\n    \"\"\"Expression namespace for column-level custom operations.\"\"\"\n\n    def __init__(self, expr: pl.Expr) -&gt; None:\n        self._expr = expr\n\n    def apply_factor(self, factor: float) -&gt; pl.Expr:\n        \"\"\"Apply a multiplication factor.\"\"\"\n        return self._expr * factor\n</code></pre>"},{"location":"development/extending/#step-2-register-in-__init__py","title":"Step 2: Register in <code>__init__.py</code>","text":"<pre><code># src/rwa_calc/engine/custom/__init__.py\n\n# Import to register namespace on module load\nimport rwa_calc.engine.custom.namespace  # noqa: F401\n\nfrom rwa_calc.engine.custom.namespace import CustomLazyFrame, CustomExpr\n\n__all__ = [\"CustomLazyFrame\", \"CustomExpr\"]\n</code></pre>"},{"location":"development/extending/#step-3-use-pure-polars-expressions-for-performance","title":"Step 3: Use Pure Polars Expressions for Performance","text":"<p>For computationally intensive formulas, use pure Polars expressions with <code>polars-normal-stats</code>:</p> <pre><code>from polars_normal_stats import normal_cdf, normal_ppf\n\ndef _custom_formula_expr() -&gt; pl.Expr:\n    \"\"\"Pure Polars expression for custom calculation.\"\"\"\n    # Example: normal CDF of input values\n    return normal_cdf(pl.col(\"input_value\"))\n\ndef apply_custom_formula(self, config: CalculationConfig) -&gt; pl.LazyFrame:\n    \"\"\"Apply custom calculation using pure Polars expressions.\"\"\"\n    return self._lf.with_columns(\n        _custom_formula_expr().alias(\"output_value\")\n    )\n</code></pre> <p>This approach: - Preserves full lazy evaluation (query optimization, streaming) - Enables processing of datasets larger than memory - Achieves 3M+ rows/second throughput</p>"},{"location":"development/extending/#step-4-add-tests_1","title":"Step 4: Add Tests","text":"<pre><code># tests/unit/test_custom_namespace.py\n\nimport polars as pl\nimport pytest\nfrom datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.custom.namespace  # Register namespace\n\n\nclass TestCustomNamespace:\n    @pytest.fixture\n    def config(self):\n        return CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n    def test_namespace_registered(self):\n        \"\"\"Custom namespace is available on LazyFrame.\"\"\"\n        lf = pl.LazyFrame({\"a\": [1]})\n        assert hasattr(lf, \"custom\")\n\n    def test_apply_custom_formula(self, config):\n        \"\"\"Custom formula produces expected results.\"\"\"\n        lf = pl.LazyFrame({\"ead\": [1000.0], \"risk_weight\": [0.5]})\n        result = lf.custom.apply_custom_formula(config).collect()\n        assert result[\"rwa\"][0] == 500.0\n\n    def test_method_chaining(self, config):\n        \"\"\"Methods can be chained fluently.\"\"\"\n        lf = pl.LazyFrame({\"ead\": [1000.0], \"risk_weight\": [0.5]})\n        result = (\n            lf\n            .custom.validate_inputs(config)\n            .custom.apply_custom_formula(config)\n            .collect()\n        )\n        assert \"rwa\" in result.columns\n</code></pre>"},{"location":"development/extending/#namespace-design-guidelines","title":"Namespace Design Guidelines","text":"<ol> <li>Return <code>pl.LazyFrame</code> from all LazyFrame namespace methods for chaining</li> <li>Accept <code>CalculationConfig</code> to handle framework-specific logic</li> <li>Use pure Polars expressions with <code>polars-normal-stats</code> for statistical functions</li> <li>Preserve lazy evaluation - avoid <code>.collect()</code> or <code>.to_numpy()</code> in formulas</li> <li>Check column existence before operations using <code>collect_schema()</code></li> <li>Provide sensible defaults for optional columns</li> <li>Document added columns in method docstrings</li> </ol>"},{"location":"development/extending/#best-practices","title":"Best Practices","text":""},{"location":"development/extending/#1-follow-existing-patterns","title":"1. Follow Existing Patterns","text":"<p>Look at existing implementations for guidance: - <code>sa/calculator.py</code> for calculator patterns - <code>data/tables/*.py</code> for lookup tables - <code>contracts/bundles.py</code> for data contracts</p>"},{"location":"development/extending/#2-write-tests-first","title":"2. Write Tests First","text":"<p>Follow TDD: 1. Write failing acceptance test 2. Write failing unit tests 3. Implement to pass tests 4. Refactor</p>"},{"location":"development/extending/#3-use-type-hints","title":"3. Use Type Hints","text":"<pre><code>def calculate_rwa(\n    ead: float,\n    risk_weight: Decimal,\n    factor: Decimal | None = None,\n) -&gt; Decimal:\n    \"\"\"Calculate RWA with optional factor.\"\"\"\n    base_rwa = Decimal(str(ead)) * risk_weight\n    if factor is not None:\n        return base_rwa * factor\n    return base_rwa\n</code></pre>"},{"location":"development/extending/#4-document-regulatory-references","title":"4. Document Regulatory References","text":"<pre><code>def calculate_sme_factor(total_exposure: Decimal) -&gt; Decimal:\n    \"\"\"\n    Calculate SME supporting factor per CRR Article 501.\n\n    The factor provides capital relief using a tiered approach:\n    - Exposure &lt;= EUR 2.5m: 0.7619 factor\n    - Exposure &gt; EUR 2.5m: Blended factor\n\n    Args:\n        total_exposure: Total exposure to SME counterparty.\n\n    Returns:\n        SME supporting factor (0.7619 to 0.85).\n    \"\"\"\n</code></pre>"},{"location":"development/extending/#5-update-documentation","title":"5. Update Documentation","text":"<p>After adding features, update: - API documentation - User guide (if user-facing) - Changelog</p>"},{"location":"development/extending/#next-steps","title":"Next Steps","text":"<ul> <li>Code Style - Coding conventions</li> <li>Testing Guide - Writing tests</li> <li>Architecture - System design</li> </ul>"},{"location":"development/testing/","title":"Testing Guide","text":"<p>This guide covers the testing approach, test organization, and how to write effective tests. The test suite currently contains 1,188+ tests across unit, acceptance, and benchmark categories.</p>"},{"location":"development/testing/#test-organization","title":"Test Organization","text":"<pre><code>tests/\n\u251c\u2500\u2500 acceptance/           # End-to-end scenario tests\n\u2502   \u251c\u2500\u2500 crr/             # CRR framework scenarios\n\u2502   \u2514\u2500\u2500 basel31/         # Basel 3.1 scenarios\n\u251c\u2500\u2500 benchmarks/          # Performance and scale tests\n\u251c\u2500\u2500 contracts/           # Interface compliance tests\n\u251c\u2500\u2500 unit/                # Component unit tests\n\u2502   \u251c\u2500\u2500 crr/             # CRR-specific tests\n\u2502   \u251c\u2500\u2500 basel31/         # Basel 3.1-specific tests\n\u2502   \u2514\u2500\u2500 test_fx_converter.py  # FX conversion tests\n\u2514\u2500\u2500 fixtures/            # Test data generators\n    \u251c\u2500\u2500 counterparty/    # Counterparty fixtures\n    \u251c\u2500\u2500 exposures/       # Facility, loan, contingent fixtures\n    \u251c\u2500\u2500 collateral/      # Collateral fixtures\n    \u251c\u2500\u2500 guarantee/       # Guarantee fixtures\n    \u251c\u2500\u2500 provision/       # Provision fixtures\n    \u251c\u2500\u2500 ratings/         # Rating fixtures\n    \u251c\u2500\u2500 mapping/         # Hierarchy mapping fixtures\n    \u2514\u2500\u2500 fx_rates/        # FX rates fixtures\n\ndocs/specifications/      # Regulatory specifications (plain markdown)\n\u251c\u2500\u2500 crr/                 # CRR framework specifications\n\u251c\u2500\u2500 basel31/             # Basel 3.1 specifications\n\u2514\u2500\u2500 common/              # Framework-agnostic specifications\n</code></pre>"},{"location":"development/testing/#running-tests","title":"Running Tests","text":""},{"location":"development/testing/#all-tests","title":"All Tests","text":"<pre><code># Run entire test suite\nuv run pytest\n\n# With verbose output\nuv run pytest -v\n\n# With coverage\nuv run pytest --cov=src/rwa_calc --cov-report=html\n</code></pre>"},{"location":"development/testing/#specific-tests","title":"Specific Tests","text":"<pre><code># Run specific file\nuv run pytest tests/unit/test_pipeline.py\n\n# Run specific test\nuv run pytest tests/unit/test_pipeline.py::test_crr_basic_calculation\n\n# Run by marker\nuv run pytest -m \"crr\"\nuv run pytest -m \"not slow\"\n\n# Run by pattern\nuv run pytest -k \"test_sa_\"\n</code></pre>"},{"location":"development/testing/#test-options","title":"Test Options","text":"<pre><code># Stop on first failure\nuv run pytest -x\n\n# Show local variables in tracebacks\nuv run pytest -l\n\n# Run last failed tests\nuv run pytest --lf\n\n# Parallel execution\nuv run pytest -n auto\n</code></pre>"},{"location":"development/testing/#test-categories","title":"Test Categories","text":""},{"location":"development/testing/#unit-tests","title":"Unit Tests","text":"<p>Test individual components in isolation:</p> <pre><code># tests/unit/test_ccf.py\n\nimport pytest\nfrom rwa_calc.engine.ccf import get_ccf\nfrom rwa_calc.domain.enums import RegulatoryFramework\n\nclass TestCCF:\n    \"\"\"Tests for credit conversion factor calculation.\"\"\"\n\n    def test_unconditionally_cancellable_crr_returns_zero(self):\n        \"\"\"Unconditionally cancellable commitments have 0% CCF under CRR.\"\"\"\n        ccf = get_ccf(\n            item_type=\"UNDRAWN_COMMITMENT\",\n            is_unconditionally_cancellable=True,\n            original_maturity_years=5,\n            framework=RegulatoryFramework.CRR,\n        )\n        assert ccf == 0.0\n\n    def test_unconditionally_cancellable_basel31_returns_ten_percent(self):\n        \"\"\"Unconditionally cancellable has 10% CCF under Basel 3.1.\"\"\"\n        ccf = get_ccf(\n            item_type=\"UNDRAWN_COMMITMENT\",\n            is_unconditionally_cancellable=True,\n            original_maturity_years=5,\n            framework=RegulatoryFramework.BASEL_3_1,\n        )\n        assert ccf == 0.10\n</code></pre>"},{"location":"development/testing/#contract-tests","title":"Contract Tests","text":"<p>Test interface compliance:</p> <pre><code># tests/contracts/test_calculator_protocol.py\n\nimport pytest\nfrom rwa_calc.contracts.protocols import SACalculatorProtocol\nfrom rwa_calc.engine.sa.calculator import SACalculator\n\nclass TestSACalculatorProtocol:\n    \"\"\"Verify SACalculator implements protocol correctly.\"\"\"\n\n    def test_implements_protocol(self):\n        \"\"\"SACalculator should implement SACalculatorProtocol.\"\"\"\n        calculator = SACalculator()\n        assert isinstance(calculator, SACalculatorProtocol)\n\n    def test_calculate_returns_result_bundle(self, sample_exposures, config):\n        \"\"\"Calculate should return SAResultBundle.\"\"\"\n        calculator = SACalculator()\n        result = calculator.calculate(sample_exposures, config)\n        assert hasattr(result, \"data\")\n        assert hasattr(result, \"errors\")\n</code></pre>"},{"location":"development/testing/#acceptance-tests","title":"Acceptance Tests","text":"<p>Test complete scenarios:</p> <pre><code># tests/acceptance/crr/test_scenario_crr_a_sa.py\n\nimport pytest\nfrom datetime import date\nfrom rwa_calc.engine.pipeline import create_pipeline\nfrom rwa_calc.contracts.config import CalculationConfig\n\nclass TestCRRStandardisedApproach:\n    \"\"\"CRR Standardised Approach acceptance tests.\"\"\"\n\n    @pytest.fixture\n    def pipeline(self):\n        return create_pipeline()\n\n    @pytest.fixture\n    def crr_config(self):\n        return CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n    def test_crr_a01_sovereign_cqs1_zero_risk_weight(\n        self, pipeline, crr_config, sovereign_cqs1_exposure\n    ):\n        \"\"\"\n        CRR-A01: Sovereign CQS1 exposure receives 0% risk weight.\n\n        Given: Exposure to UK Government (CQS1)\n        When: Calculating RWA under CRR SA\n        Then: Risk weight is 0%, RWA is 0\n        \"\"\"\n        result = pipeline.run_with_data(sovereign_cqs1_exposure, crr_config)\n\n        assert result.total_rwa == 0\n        df = result.to_dataframe()\n        assert df.filter(pl.col(\"exposure_class\") == \"CENTRAL_GOVT_CENTRAL_BANK\")[\"risk_weight\"][0] == 0.0\n\n    def test_crr_a02_corporate_unrated_100_percent(\n        self, pipeline, crr_config, corporate_unrated_exposure\n    ):\n        \"\"\"\n        CRR-A02: Unrated corporate receives 100% risk weight.\n\n        Given: Unrated corporate exposure of GBP 1m\n        When: Calculating RWA under CRR SA\n        Then: RWA is GBP 1m (100% risk weight)\n        \"\"\"\n        result = pipeline.run_with_data(corporate_unrated_exposure, crr_config)\n\n        assert result.total_rwa == pytest.approx(1_000_000, rel=0.01)\n</code></pre>"},{"location":"development/testing/#test-fixtures","title":"Test Fixtures","text":""},{"location":"development/testing/#creating-fixtures","title":"Creating Fixtures","text":"<pre><code># tests/fixtures/exposures.py\n\nimport pytest\nimport polars as pl\nfrom datetime import date\n\n@pytest.fixture\ndef sample_counterparty():\n    \"\"\"Single corporate counterparty.\"\"\"\n    return pl.DataFrame({\n        \"counterparty_id\": [\"C001\"],\n        \"counterparty_name\": [\"Acme Corp\"],\n        \"counterparty_type\": [\"CORPORATE\"],\n        \"country_code\": [\"GB\"],\n        \"annual_turnover\": [30_000_000.0],\n    }).lazy()\n\n@pytest.fixture\ndef sample_facility(sample_counterparty):\n    \"\"\"Single term loan facility.\"\"\"\n    return pl.DataFrame({\n        \"facility_id\": [\"F001\"],\n        \"counterparty_id\": [\"C001\"],\n        \"facility_type\": [\"TERM\"],\n        \"committed_amount\": [1_000_000.0],\n        \"drawn_amount\": [1_000_000.0],\n        \"currency\": [\"GBP\"],\n        \"start_date\": [date(2024, 1, 1)],\n        \"maturity_date\": [date(2029, 1, 1)],\n        \"is_unconditionally_cancellable\": [False],\n        \"is_committed\": [True],\n    }).lazy()\n\n@pytest.fixture\ndef sample_raw_data(sample_counterparty, sample_facility):\n    \"\"\"Complete raw data bundle.\"\"\"\n    from rwa_calc.contracts.bundles import RawDataBundle\n\n    return RawDataBundle(\n        counterparties=sample_counterparty,\n        facilities=sample_facility,\n        loans=pl.DataFrame().lazy(),\n    )\n</code></pre>"},{"location":"development/testing/#parametrized-fixtures","title":"Parametrized Fixtures","text":"<pre><code>@pytest.fixture(params=[\n    (\"CQS_1\", 0.20),\n    (\"CQS_2\", 0.50),\n    (\"CQS_3\", 0.75),\n    (\"CQS_4\", 1.00),\n    (\"UNRATED\", 1.00),\n])\ndef corporate_risk_weight_case(request):\n    \"\"\"Parametrized corporate risk weight test cases.\"\"\"\n    cqs, expected_rw = request.param\n    return {\"cqs\": cqs, \"expected_risk_weight\": expected_rw}\n</code></pre>"},{"location":"development/testing/#configuration-fixtures","title":"Configuration Fixtures","text":"<pre><code># tests/conftest.py\n\nimport pytest\nfrom datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\n\n@pytest.fixture\ndef crr_config():\n    \"\"\"Standard CRR configuration.\"\"\"\n    return CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n@pytest.fixture\ndef basel31_config():\n    \"\"\"Standard Basel 3.1 configuration.\"\"\"\n    return CalculationConfig.basel_3_1(reporting_date=date(2027, 1, 1))\n\n@pytest.fixture(params=[\"crr\", \"basel31\"])\ndef both_frameworks(request, crr_config, basel31_config):\n    \"\"\"Run test under both frameworks.\"\"\"\n    if request.param == \"crr\":\n        return crr_config\n    return basel31_config\n</code></pre>"},{"location":"development/testing/#writing-effective-tests","title":"Writing Effective Tests","text":""},{"location":"development/testing/#test-naming","title":"Test Naming","text":"<p>Use descriptive names that explain: - What is being tested - Under what conditions - Expected outcome</p> <pre><code># Good\ndef test_sme_factor_tiered_calculation_exposure_above_threshold_returns_blended_factor():\n    ...\n\n# Bad\ndef test_sme():\n    ...\n</code></pre>"},{"location":"development/testing/#test-structure-aaa-pattern","title":"Test Structure (AAA Pattern)","text":"<pre><code>def test_irb_capital_requirement_calculation():\n    \"\"\"Test IRB K formula calculation.\"\"\"\n    # Arrange\n    pd = 0.01\n    lgd = 0.45\n    correlation = 0.20\n\n    # Act\n    k = calculate_k(pd, lgd, correlation)\n\n    # Assert\n    assert k == pytest.approx(0.0445, rel=0.01)\n</code></pre>"},{"location":"development/testing/#assertions","title":"Assertions","text":"<pre><code># Exact equality\nassert result == expected\n\n# Approximate equality\nassert result == pytest.approx(expected, rel=0.01)  # 1% tolerance\nassert result == pytest.approx(expected, abs=0.001)  # Absolute tolerance\n\n# Collections\nassert set(result) == set(expected)\nassert result in expected_values\n\n# DataFrame assertions\nassert len(df) == expected_count\nassert df[\"column\"].sum() == expected_sum\n</code></pre>"},{"location":"development/testing/#testing-errors","title":"Testing Errors","text":"<pre><code>def test_invalid_pd_raises_error():\n    \"\"\"Negative PD should raise ValueError.\"\"\"\n    with pytest.raises(ValueError, match=\"PD must be positive\"):\n        calculate_k(pd=-0.01, lgd=0.45, correlation=0.20)\n\ndef test_calculation_accumulates_errors():\n    \"\"\"Invalid exposures should accumulate errors.\"\"\"\n    result = pipeline.run_with_data(invalid_data, config)\n    assert result.has_errors\n    assert any(\"Invalid PD\" in e.message for e in result.errors)\n</code></pre>"},{"location":"development/testing/#test-markers","title":"Test Markers","text":"<pre><code># tests/conftest.py\n\ndef pytest_configure(config):\n    config.addinivalue_line(\"markers\", \"crr: CRR framework tests\")\n    config.addinivalue_line(\"markers\", \"basel31: Basel 3.1 framework tests\")\n    config.addinivalue_line(\"markers\", \"slow: slow-running tests\")\n    config.addinivalue_line(\"markers\", \"integration: integration tests\")\n</code></pre> <p>Usage: <pre><code>@pytest.mark.crr\ndef test_crr_specific_feature():\n    ...\n\n@pytest.mark.slow\ndef test_large_portfolio_calculation():\n    ...\n</code></pre></p> <p>Run by marker: <pre><code>uv run pytest -m crr\nuv run pytest -m \"not slow\"\n</code></pre></p>"},{"location":"development/testing/#coverage","title":"Coverage","text":""},{"location":"development/testing/#generate-coverage-report","title":"Generate Coverage Report","text":"<pre><code># Terminal report\nuv run pytest --cov=src/rwa_calc\n\n# HTML report\nuv run pytest --cov=src/rwa_calc --cov-report=html\nopen htmlcov/index.html\n</code></pre>"},{"location":"development/testing/#coverage-configuration","title":"Coverage Configuration","text":"<pre><code># pyproject.toml\n[tool.coverage.run]\nsource = [\"src/rwa_calc\"]\nbranch = true\n\n[tool.coverage.report]\nexclude_lines = [\n    \"pragma: no cover\",\n    \"if TYPE_CHECKING:\",\n    \"raise NotImplementedError\",\n]\n</code></pre>"},{"location":"development/testing/#next-steps","title":"Next Steps","text":"<ul> <li>Specifications - Regulatory specifications and scenarios</li> <li>Adding Features - Extending the calculator</li> <li>Code Style - Coding conventions</li> <li>Architecture - System design</li> </ul>"},{"location":"development/workbooks/","title":"Workbooks &amp; Interactive UI","text":"<p>This guide covers the Marimo workbooks used for expected output generation and the interactive UI applications.</p>"},{"location":"development/workbooks/#overview","title":"Overview","text":"<p>The project includes two types of Marimo-based components:</p> <ol> <li>Expected Output Workbooks - Reference implementations for generating test expected outputs</li> <li>Interactive UI Applications - Web-based tools for running calculations and exploring results</li> </ol>"},{"location":"development/workbooks/#interactive-ui","title":"Interactive UI","text":"<p>The calculator includes a multi-app web server providing three interactive applications.</p>"},{"location":"development/workbooks/#starting-the-server","title":"Starting the Server","text":"<pre><code># If installed from PyPI\nrwa-calc-ui\n\n# From source with uv\nuv run python src/rwa_calc/ui/marimo/server.py\n\n# Or using uvicorn directly\nuvicorn rwa_calc.ui.marimo.server:app --host 0.0.0.0 --port 8000\n</code></pre>"},{"location":"development/workbooks/#available-applications","title":"Available Applications","text":"Application URL Description RWA Calculator <code>http://localhost:8000/</code> or <code>/calculator</code> Run RWA calculations Results Explorer <code>http://localhost:8000/results</code> Analyze calculation results Framework Reference <code>http://localhost:8000/reference</code> Regulatory documentation"},{"location":"development/workbooks/#rwa-calculator-rwa_apppy","title":"RWA Calculator (<code>rwa_app.py</code>)","text":"<p>The main calculator application provides:</p> <ul> <li> <p>Data Input</p> <ul> <li>Data path selection with validation</li> <li>Format selection (Parquet / CSV)</li> <li>Reporting date picker</li> </ul> </li> <li> <p>Configuration</p> <ul> <li>Framework selection (CRR / Basel 3.1)</li> <li>IRB approach toggle</li> </ul> </li> <li> <p>Results</p> <ul> <li>Summary statistics (total EAD, total RWA, average risk weight)</li> <li>Breakdown by calculation approach</li> <li>Performance metrics (duration, throughput)</li> <li>Results preview (first 100 rows)</li> <li>CSV export</li> </ul> </li> </ul>"},{"location":"development/workbooks/#results-explorer-results_explorerpy","title":"Results Explorer (<code>results_explorer.py</code>)","text":"<p>Analyze and filter calculation results:</p> <ul> <li> <p>Filters</p> <ul> <li>By exposure class (dropdown)</li> <li>By approach (dropdown)</li> <li>By risk weight range (min/max)</li> </ul> </li> <li> <p>Aggregation Options</p> <ul> <li>By Exposure Class</li> <li>By Approach</li> <li>By Risk Weight Band</li> </ul> </li> <li> <p>Features</p> <ul> <li>Column selector for detailed view</li> <li>Export filtered results (CSV + Parquet)</li> <li>Summary statistics</li> </ul> </li> </ul>"},{"location":"development/workbooks/#framework-reference-framework_referencepy","title":"Framework Reference (<code>framework_reference.py</code>)","text":"<p>Interactive regulatory reference with tabbed navigation:</p> <ul> <li>Overview of CRR vs Basel 3.1</li> <li>CRR (Basel 3.0) parameters</li> <li>Basel 3.1 parameters</li> <li>Risk weight tables</li> <li>IRB parameters</li> </ul>"},{"location":"development/workbooks/#server-architecture","title":"Server Architecture","text":"<p>The multi-app server uses Marimo's ASGI integration:</p> <pre><code>from marimo import create_asgi_app\n\napp = (\n    create_asgi_app()\n    .with_app(path=\"\", root=str(apps_dir / \"rwa_app.py\"))\n    .with_app(path=\"/calculator\", root=str(apps_dir / \"rwa_app.py\"))\n    .with_app(path=\"/results\", root=str(apps_dir / \"results_explorer.py\"))\n    .with_app(path=\"/reference\", root=str(apps_dir / \"framework_reference.py\"))\n    .build()\n)\n</code></pre>"},{"location":"development/workbooks/#expected-output-workbooks","title":"Expected Output Workbooks","text":"<p>The workbooks in <code>workbooks/</code> provide reference implementations for generating expected test outputs, ensuring calculator accuracy.</p>"},{"location":"development/workbooks/#structure","title":"Structure","text":"<pre><code>workbooks/\n\u251c\u2500\u2500 shared/                         # Common utilities\n\u2502   \u251c\u2500\u2500 fixture_loader.py           # Test data loading\n\u2502   \u251c\u2500\u2500 irb_formulas.py             # IRB K calculation\n\u2502   \u2514\u2500\u2500 correlation.py              # Asset correlation\n\u251c\u2500\u2500 crr_expected_outputs/           # CRR (Basel 3.0)\n\u2502   \u251c\u2500\u2500 data/\n\u2502   \u2502   \u2514\u2500\u2500 crr_params.py           # Regulatory parameters\n\u2502   \u251c\u2500\u2500 calculations/               # Calculation modules\n\u2502   \u2502   \u251c\u2500\u2500 crr_risk_weights.py     # SA risk weights\n\u2502   \u2502   \u251c\u2500\u2500 crr_ccf.py              # Credit conversion factors\n\u2502   \u2502   \u251c\u2500\u2500 crr_haircuts.py         # CRM haircuts\n\u2502   \u2502   \u251c\u2500\u2500 crr_supporting_factors.py\n\u2502   \u2502   \u2514\u2500\u2500 crr_irb.py              # CRR IRB (with 1.06 factor)\n\u2502   \u251c\u2500\u2500 scenarios/                  # Expected output scenarios\n\u2502   \u2502   \u251c\u2500\u2500 group_crr_a_sa.py       # SA scenarios (12)\n\u2502   \u2502   \u251c\u2500\u2500 group_crr_b_firb.py     # F-IRB scenarios (6)\n\u2502   \u2502   \u251c\u2500\u2500 group_crr_c_airb.py     # A-IRB scenarios (3)\n\u2502   \u2502   \u251c\u2500\u2500 group_crr_d_crm.py      # CRM scenarios (6)\n\u2502   \u2502   \u251c\u2500\u2500 group_crr_e_slotting.py # Slotting scenarios (4)\n\u2502   \u2502   \u251c\u2500\u2500 group_crr_f_supporting_factors.py (7)\n\u2502   \u2502   \u251c\u2500\u2500 group_crr_g_provisions.py (3)\n\u2502   \u2502   \u2514\u2500\u2500 group_crr_h_complex.py  # Complex scenarios (4)\n\u2502   \u251c\u2500\u2500 main.py                     # Main orchestration workbook\n\u2502   \u2514\u2500\u2500 generate_outputs.py         # Output generation\n\u2514\u2500\u2500 basel31_expected_outputs/       # Basel 3.1 (mirrors CRR structure)\n    \u251c\u2500\u2500 data/\n    \u2502   \u2514\u2500\u2500 regulatory_params.py    # Basel 3.1 parameters\n    \u251c\u2500\u2500 calculations/\n    \u2502   \u251c\u2500\u2500 sa_risk_weights.py      # Basel 3.1 SA (LTV-based)\n    \u2502   \u251c\u2500\u2500 ccf.py\n    \u2502   \u251c\u2500\u2500 crm_haircuts.py\n    \u2502   \u251c\u2500\u2500 irb_formulas.py         # IRB with floors\n    \u2502   \u2514\u2500\u2500 correlation.py\n    \u251c\u2500\u2500 scenarios/                  # 8 groups including output floor\n    \u2502   \u251c\u2500\u2500 group_a_sa.py\n    \u2502   \u251c\u2500\u2500 group_b_firb.py\n    \u2502   \u251c\u2500\u2500 group_c_airb.py\n    \u2502   \u251c\u2500\u2500 group_d_crm.py\n    \u2502   \u251c\u2500\u2500 group_e_slotting.py\n    \u2502   \u251c\u2500\u2500 group_f_output_floor.py # Output floor mechanics\n    \u2502   \u251c\u2500\u2500 group_g_provisions.py\n    \u2502   \u2514\u2500\u2500 group_h_complex.py\n    \u2514\u2500\u2500 main.py\n</code></pre>"},{"location":"development/workbooks/#running-workbooks","title":"Running Workbooks","text":"<pre><code># Run CRR workbook interactively\nuv run marimo edit workbooks/crr_expected_outputs/main.py\n\n# Run Basel 3.1 workbook\nuv run marimo edit workbooks/basel31_expected_outputs/main.py\n\n# Generate expected outputs (non-interactive)\nuv run python workbooks/crr_expected_outputs/generate_outputs.py\n</code></pre>"},{"location":"development/workbooks/#scenario-groups","title":"Scenario Groups","text":""},{"location":"development/workbooks/#crr-scenarios-45-total","title":"CRR Scenarios (45 total)","text":"Group Description Scenarios CRR-A Standardised Approach 12 CRR-B Foundation IRB 6 CRR-C Advanced IRB 3 CRR-D Credit Risk Mitigation 6 CRR-E Specialised Lending (Slotting) 4 CRR-F Supporting Factors 7 CRR-G Provisions &amp; Impairments 3 CRR-H Complex/Combined 4"},{"location":"development/workbooks/#basel-31-scenarios","title":"Basel 3.1 Scenarios","text":"<p>Similar structure to CRR with additional:</p> <ul> <li>Group F: Output Floor - Testing the 72.5% floor mechanics and transitional schedule</li> </ul>"},{"location":"development/workbooks/#shared-utilities","title":"Shared Utilities","text":""},{"location":"development/workbooks/#irb-formulas-sharedirb_formulaspy","title":"IRB Formulas (<code>shared/irb_formulas.py</code>)","text":"<p>Common IRB calculations used by both frameworks:</p> <pre><code>from workbooks.shared.irb_formulas import calculate_k, maturity_adjustment\n\n# Calculate capital requirement (K)\nk = calculate_k(pd=0.01, lgd=0.45, correlation=0.20)\n\n# Calculate maturity adjustment\nma = maturity_adjustment(pd=0.01, maturity=2.5)\n</code></pre>"},{"location":"development/workbooks/#asset-correlation-sharedcorrelationpy","title":"Asset Correlation (<code>shared/correlation.py</code>)","text":"<p>Correlation parameters by exposure class:</p> <pre><code>from workbooks.shared.correlation import get_correlation\n\n# Corporate correlation (PD-dependent)\nr = get_correlation(\"CORPORATE\", pd=0.01)\n\n# Retail mortgage (fixed 15%)\nr = get_correlation(\"RETAIL_MORTGAGE\", pd=0.01)\n</code></pre>"},{"location":"development/workbooks/#adding-new-scenarios","title":"Adding New Scenarios","text":"<ol> <li>Create scenario file in the appropriate <code>scenarios/</code> directory</li> <li>Define expected outputs with all required fields</li> <li>Add to main.py orchestration</li> <li>Generate outputs using the generation script</li> <li>Create acceptance test in <code>tests/acceptance/</code></li> </ol> <p>Example scenario definition:</p> <pre><code># workbooks/crr_expected_outputs/scenarios/group_crr_a_sa.py\n\ndef get_scenarios():\n    return [\n        {\n            \"scenario_id\": \"CRR-A01\",\n            \"description\": \"Sovereign CQS1 - 0% RW\",\n            \"exposure_ref\": \"EXP_SOV_CQS1\",\n            \"expected\": {\n                \"exposure_class\": \"CENTRAL_GOVT_CENTRAL_BANK\",\n                \"approach\": \"SA\",\n                \"risk_weight\": 0.0,\n                \"ead\": 1_000_000,\n                \"rwa\": 0,\n            }\n        },\n        # ... more scenarios\n    ]\n</code></pre>"},{"location":"development/workbooks/#development-workflow","title":"Development Workflow","text":""},{"location":"development/workbooks/#workbook-development","title":"Workbook Development","text":"<ol> <li>Edit interactively using <code>marimo edit</code></li> <li>Test calculations against regulatory documentation</li> <li>Generate outputs to CSV/JSON/Parquet</li> <li>Validate with acceptance tests</li> </ol>"},{"location":"development/workbooks/#ui-development","title":"UI Development","text":"<ol> <li>Run server in development mode</li> <li>Edit app files - Marimo hot-reloads changes</li> <li>Test all applications through the browser</li> <li>Validate with API and integration tests</li> </ol>"},{"location":"development/workbooks/#next-steps","title":"Next Steps","text":"<ul> <li>Testing Guide - Testing approach and examples</li> <li>Benchmark Tests - Performance testing</li> <li>Adding Features - Extending the calculator</li> </ul>"},{"location":"features/","title":"Features","text":"<p>This section provides an overview of all implemented features in the RWA calculator with links to detailed documentation.</p>"},{"location":"features/#core-calculation-features","title":"Core Calculation Features","text":"Feature Description Documentation Standardised Approach (SA) CQS-based risk weights for all exposure classes, including UK CRR deviations Methodology, Specification Foundation IRB (F-IRB) Supervisory LGD, PD floors, correlation formulas, maturity adjustment Methodology, Specification Advanced IRB (A-IRB) Internal LGD/CCF estimates with Basel 3.1 LGD floors Methodology, Specification Slotting Approach Category-based risk weights for specialised lending (PF, OF, CF, IPRE, HVCRE) Methodology, Specification Equity Calculator Article 133 (SA) and Article 155 (IRB Simple) equity risk weights Methodology, API"},{"location":"features/#credit-risk-mitigation-features","title":"Credit Risk Mitigation Features","text":"Feature Description Documentation Collateral Haircuts CRR Art. 224 supervisory haircuts for financial and physical collateral Methodology, Specification Overcollateralisation CRR Art. 230 overcollateralisation ratios and minimum thresholds Methodology, Specification Guarantee Substitution Risk weight substitution for beneficial guarantees with pre/post CRM tracking Methodology, Specification Provisions SA provision deduction and IRB expected loss comparison Methodology, Specification Maturity Mismatch CRR Art. 238 adjustment for collateral/guarantee maturity shorter than exposure Methodology, Specification"},{"location":"features/#pipeline-infrastructure-features","title":"Pipeline &amp; Infrastructure Features","text":"Feature Description Documentation Classification Entity type mapping, SME/retail detection, approach assignment Detail, Specification Hierarchy Resolution Parent-child traversal, rating inheritance, lending group aggregation Architecture, Specification FX Conversion Multi-currency support with configurable base currency and audit trail Methodology, API Credit Conversion Factors SA and F-IRB CCFs for off-balance sheet exposures Specification, API Supporting Factors CRR SME tiered factor (0.7619/0.85) and infrastructure factor (0.75) Methodology, Specification Output Floor Basel 3.1 output floor (72.5% of SA) with transitional schedule Specification, API Input Validation Categorical value validation with DQ006 error codes Data Model Audit Trail Full calculation transparency with formatted audit strings for every approach API"},{"location":"features/#dual-framework-support","title":"Dual-Framework Support","text":"<p>The calculator supports both CRR and Basel 3.1 via a single configuration toggle:</p> <pre><code>config = CalculationConfig.crr(reporting_date=date(2026, 12, 31))     # CRR\nconfig = CalculationConfig.basel_3_1(reporting_date=date(2027, 1, 1))  # Basel 3.1\n</code></pre> <p>Key differences are documented in the Framework Differences specification.</p>"},{"location":"features/#performance","title":"Performance","text":"<p>All calculations use Polars LazyFrames for vectorized performance (50-100x improvement over row-by-row iteration). Eight custom Polars namespace extensions provide fluent, chainable APIs. See Design Principles for details.</p>"},{"location":"features/classification/","title":"Exposure Classification","text":"<p>This document provides comprehensive documentation of the exposure classification system used to determine regulatory exposure classes and calculation approaches.</p>"},{"location":"features/classification/#overview","title":"Overview","text":"<p>The classifier (<code>src/rwa_calc/engine/classifier.py</code>) is responsible for:</p> <ol> <li>Mapping counterparty entity types to regulatory exposure classes</li> <li>Determining the calculation approach (SA, F-IRB, A-IRB, Slotting)</li> <li>Applying SME and retail classification rules</li> <li>Identifying defaulted exposures</li> <li>Determining FI scalar eligibility for IRB correlation adjustment</li> </ol>"},{"location":"features/classification/#entity-type-the-single-source-of-truth","title":"Entity Type: The Single Source of Truth","text":"<p>The <code>entity_type</code> field on counterparties is the authoritative source for exposure class determination. This design eliminates ambiguity from overlapping boolean flags and ensures consistent classification.</p>"},{"location":"features/classification/#valid-entity-types","title":"Valid Entity Types","text":"<p>The system supports 17 entity types organised into logical groups:</p> <pre><code>VALID_ENTITY_TYPES = {\n    # Sovereign class\n    \"sovereign\",\n    \"central_bank\",\n\n    # RGLA class (Regional Governments/Local Authorities)\n    \"rgla_sovereign\",      # Has taxing powers or government guarantee\n    \"rgla_institution\",    # No sovereign equivalence\n\n    # PSE class (Public Sector Entities)\n    \"pse_sovereign\",       # Government guaranteed\n    \"pse_institution\",     # Commercial PSE\n\n    # MDB/International org class\n    \"mdb\",\n    \"international_org\",\n\n    # Institution class\n    \"institution\",\n    \"bank\",\n    \"ccp\",\n    \"financial_institution\",\n\n    # Corporate class\n    \"corporate\",\n    \"company\",\n\n    # Retail class\n    \"individual\",\n    \"retail\",\n\n    # Specialised lending\n    \"specialised_lending\",\n}\n</code></pre>"},{"location":"features/classification/#dual-exposure-class-mapping","title":"Dual Exposure Class Mapping","text":"<p>Each entity type maps to both an SA exposure class and an IRB exposure class. These can differ for certain entity types based on regulatory requirements.</p>"},{"location":"features/classification/#sa-exposure-class-mapping","title":"SA Exposure Class Mapping","text":"<p>Used for SA risk weight table lookups:</p> Entity Type SA Exposure Class Regulatory Reference <code>sovereign</code> CENTRAL_GOVT_CENTRAL_BANK CRR Art. 112(a) <code>central_bank</code> CENTRAL_GOVT_CENTRAL_BANK CRR Art. 112(a) <code>rgla_sovereign</code> RGLA CRR Art. 115 <code>rgla_institution</code> RGLA CRR Art. 115 <code>pse_sovereign</code> PSE CRR Art. 116 <code>pse_institution</code> PSE CRR Art. 116 <code>mdb</code> MDB CRR Art. 117 <code>international_org</code> MDB CRR Art. 118 <code>institution</code> INSTITUTION CRR Art. 112(d) <code>bank</code> INSTITUTION CRR Art. 112(d) <code>ccp</code> INSTITUTION CRR Art. 300-311 <code>financial_institution</code> INSTITUTION CRR Art. 112(d) <code>corporate</code> CORPORATE CRR Art. 112(g) <code>company</code> CORPORATE CRR Art. 112(g) <code>individual</code> RETAIL_OTHER CRR Art. 112(h) <code>retail</code> RETAIL_OTHER CRR Art. 112(h) <code>specialised_lending</code> SPECIALISED_LENDING CRR Art. 147(8)"},{"location":"features/classification/#irb-exposure-class-mapping","title":"IRB Exposure Class Mapping","text":"<p>Used for IRB formula selection:</p> Entity Type IRB Exposure Class Notes <code>sovereign</code> CENTRAL_GOVT_CENTRAL_BANK Standard central govt/central bank treatment <code>central_bank</code> CENTRAL_GOVT_CENTRAL_BANK Standard central govt/central bank treatment <code>rgla_sovereign</code> CENTRAL_GOVT_CENTRAL_BANK Central govt/central bank IRB formula <code>rgla_institution</code> INSTITUTION Institution IRB formula <code>pse_sovereign</code> CENTRAL_GOVT_CENTRAL_BANK Central govt/central bank IRB formula <code>pse_institution</code> INSTITUTION Institution IRB formula <code>mdb</code> CENTRAL_GOVT_CENTRAL_BANK CRR Art. 147(3) <code>international_org</code> CENTRAL_GOVT_CENTRAL_BANK CRR Art. 147(3) <code>institution</code> INSTITUTION Standard institution treatment <code>bank</code> INSTITUTION Standard institution treatment <code>ccp</code> INSTITUTION Standard institution treatment <code>financial_institution</code> INSTITUTION Standard institution treatment <code>corporate</code> CORPORATE Standard corporate treatment <code>company</code> CORPORATE Standard corporate treatment <code>individual</code> RETAIL_OTHER Standard retail treatment <code>retail</code> RETAIL_OTHER Standard retail treatment <code>specialised_lending</code> SPECIALISED_LENDING Slotting or IRB"},{"location":"features/classification/#why-classes-can-differ","title":"Why Classes Can Differ","text":"<p>The SA and IRB exposure classes differ for RGLA, PSE, and MDB entity types because:</p> <ul> <li>SA treatment: Uses specific risk weight tables for RGLA, PSE, and MDB</li> <li>IRB treatment: Uses the underlying IRB formula (central govt/central bank or institution) based on the nature of the entity's credit support</li> </ul> <p>For example, a government-guaranteed PSE (<code>pse_sovereign</code>) uses the PSE risk weight table under SA but the central govt/central bank IRB formula because its credit risk is backed by the government.</p>"},{"location":"features/classification/#classification-pipeline","title":"Classification Pipeline","text":"<p>The <code>ExposureClassifier.classify()</code> method processes exposures through a defined sequence of steps:</p>"},{"location":"features/classification/#step-1-add-counterparty-attributes","title":"Step 1: Add Counterparty Attributes","text":"<pre><code>_add_counterparty_attributes(exposures, counterparties)\n</code></pre> <p>Joins exposure data with counterparty attributes needed for classification: - <code>entity_type</code> - Single source of truth - <code>annual_revenue</code> - For SME check - <code>total_assets</code> - For large FSE threshold - <code>default_status</code> - For default identification - <code>is_regulated</code> - For FI scalar determination - <code>is_managed_as_retail</code> - For SME retail treatment</p>"},{"location":"features/classification/#step-2-classify-exposure-class","title":"Step 2: Classify Exposure Class","text":"<pre><code>_classify_exposure_class(exposures, config)\n</code></pre> <p>Maps <code>entity_type</code> to exposure classes using the constant mappings:</p> <pre><code># Result columns:\nexposure_class_sa   # SA class for risk weight lookup\nexposure_class_irb  # IRB class for formula selection\nexposure_class      # Unified class (SA class for backwards compatibility)\n</code></pre>"},{"location":"features/classification/#step-3-apply-sme-classification","title":"Step 3: Apply SME Classification","text":"<pre><code>_apply_sme_classification(exposures, config)\n</code></pre> <p>Checks SME criteria per CRR Art. 501: - Entity must be classified as CORPORATE - <code>annual_revenue &lt; EUR 50m</code> (converted to GBP using config FX rate) - Revenue must be &gt; 0 (excludes missing data)</p> <p>If criteria met: - Sets <code>is_sme = True</code> - Updates <code>exposure_class</code> to <code>CORPORATE_SME</code></p>"},{"location":"features/classification/#step-4-apply-retail-classification","title":"Step 4: Apply Retail Classification","text":"<pre><code>_apply_retail_classification(exposures, lending_group_totals, config)\n</code></pre> <p>Checks retail eligibility per CRR Art. 123:</p> <ol> <li>Mortgage detection: Identifies mortgages via product_type pattern matching</li> <li>Threshold check: Aggregated exposure to lending group &lt; EUR 1m</li> <li>Residential exclusion: Residential property collateral excluded from threshold (CRR Art. 123(c))</li> </ol> <p>Classification outcomes: - Mortgages to individuals \u2192 <code>RETAIL_MORTGAGE</code> - Retail exceeding threshold + SME revenue \u2192 <code>CORPORATE_SME</code> - Retail exceeding threshold + no SME criteria \u2192 <code>CORPORATE</code> - Retail within threshold \u2192 remains <code>RETAIL_OTHER</code></p>"},{"location":"features/classification/#step-5-identify-defaults","title":"Step 5: Identify Defaults","text":"<pre><code>_identify_defaults(exposures)\n</code></pre> <p>Checks <code>default_status</code> flag: - Sets <code>is_defaulted = True</code> - Sets <code>exposure_class_for_sa = DEFAULTED</code> (SA treatment) - IRB exposures keep their class but use default LGD</p>"},{"location":"features/classification/#step-5a-infrastructure-classification","title":"Step 5a: Infrastructure Classification","text":"<pre><code>_apply_infrastructure_classification(exposures)\n</code></pre> <p>Identifies infrastructure exposures per CRR Art. 501a: - Checks product_type for \"INFRASTRUCTURE\" pattern - Sets <code>is_infrastructure = True</code> - Eligible for 0.75 supporting factor under CRR (not Basel 3.1)</p>"},{"location":"features/classification/#step-5b-fi-scalar-classification","title":"Step 5b: FI Scalar Classification","text":"<pre><code>_apply_fi_scalar_classification(exposures, config)\n</code></pre> <p>Determines Financial Sector Entity (FSE) status and FI scalar eligibility per CRR Art. 153(2):</p> <p>Financial Sector Entity Types: <pre><code>FINANCIAL_SECTOR_ENTITY_TYPES = {\n    \"institution\",\n    \"bank\",\n    \"ccp\",\n    \"financial_institution\",\n    \"pse_institution\",\n    \"rgla_institution\",\n}\n</code></pre></p> <p>Output columns: - <code>is_financial_sector_entity</code> - True if entity_type in FSE set - <code>is_large_financial_sector_entity</code> - FSE with total_assets &gt;= EUR 70bn - <code>requires_fi_scalar</code> - True if large FSE OR unregulated FSE</p> <p>FI Scalar effect: 1.25x multiplier on IRB correlation</p>"},{"location":"features/classification/#step-6-determine-approach","title":"Step 6: Determine Approach","text":"<pre><code>_determine_approach(exposures, config)\n</code></pre> <p>Assigns calculation approach based on IRB permissions:</p> Condition Approach Specialised lending + A-IRB permission for SL AIRB Specialised lending + Slotting permission SLOTTING Retail classes + A-IRB permission AIRB Corporate classes + A-IRB permission AIRB Corporate/Institution/Central Govt/Central Bank + F-IRB (no A-IRB) FIRB Default / No IRB permission SA"},{"location":"features/classification/#step-7-add-classification-audit","title":"Step 7: Add Classification Audit","text":"<pre><code>_add_classification_audit(exposures)\n</code></pre> <p>Builds audit trail string for each exposure: <pre><code>entity_type=corporate; exp_class_sa=CORPORATE; exp_class_irb=CORPORATE;\nis_sme=true; is_mortgage=false; is_defaulted=false; is_infrastructure=false;\nrequires_fi_scalar=false; qualifies_as_retail=true\n</code></pre></p>"},{"location":"features/classification/#step-7a-enrich-slotting-exposures","title":"Step 7a: Enrich Slotting Exposures","text":"<pre><code>_enrich_slotting_exposures(exposures)\n</code></pre> <p>Derives slotting metadata from patterns in reference fields:</p> <p>Slotting Category (from counterparty_reference): - <code>*_STRONG*</code> \u2192 strong - <code>*_GOOD*</code> \u2192 good - <code>*_SATISFACTORY*</code> \u2192 satisfactory - <code>*_WEAK*</code> \u2192 weak - <code>*_DEFAULT*</code> \u2192 default</p> <p>Specialised Lending Type (from product_type): - <code>*PROJECT*</code> \u2192 project_finance - <code>*OBJECT*</code> \u2192 object_finance - <code>*COMMOD*</code> \u2192 commodities_finance - <code>IPRE</code> \u2192 ipre - <code>HVCRE</code> \u2192 hvcre</p> <p>HVCRE Flag: - <code>is_hvcre = True</code> if sl_type == \"hvcre\"</p>"},{"location":"features/classification/#step-8-split-by-approach","title":"Step 8: Split by Approach","text":"<p>Filters exposures into separate LazyFrames: - <code>sa_exposures</code> - Approach = SA - <code>irb_exposures</code> - Approach = FIRB or AIRB - <code>slotting_exposures</code> - Approach = SLOTTING</p>"},{"location":"features/classification/#output-schema","title":"Output Schema","text":"<p>The classifier adds these columns to the exposure data:</p> Column Type Description <code>exposure_class</code> String SA exposure class (backwards compatible) <code>exposure_class_sa</code> String SA exposure class (explicit) <code>exposure_class_irb</code> String IRB exposure class <code>is_sme</code> Boolean SME classification (revenue &lt; EUR 50m) <code>is_mortgage</code> Boolean Mortgage product flag <code>qualifies_as_retail</code> Boolean Meets retail threshold <code>retail_threshold_exclusion_applied</code> Boolean Residential RE excluded from threshold <code>is_defaulted</code> Boolean Default status <code>exposure_class_for_sa</code> String SA class (DEFAULTED if in default) <code>is_infrastructure</code> Boolean Infrastructure lending flag <code>is_financial_sector_entity</code> Boolean FSE flag <code>is_large_financial_sector_entity</code> Boolean Large FSE (&gt;= EUR 70bn assets) <code>requires_fi_scalar</code> Boolean Requires 1.25x correlation <code>approach</code> String Calculation approach (SA/FIRB/AIRB/SLOTTING) <code>firb_permitted</code> Boolean F-IRB permitted by config <code>airb_permitted</code> Boolean A-IRB permitted by config <code>slotting_category</code> String Slotting category (for SL) <code>sl_type</code> String Specialised lending type <code>is_hvcre</code> Boolean High-volatility CRE flag <code>classification_reason</code> String Full audit trail"},{"location":"features/classification/#exposure-classes","title":"Exposure Classes","text":"<p>The system supports these exposure classes (defined in <code>domain/enums.py</code>):</p> Class Description SA Treatment IRB Treatment <code>CENTRAL_GOVT_CENTRAL_BANK</code> Central governments, central banks CQS-based (0%-150%) Central govt/central bank formula <code>RGLA</code> Regional govts, local authorities CQS-based Central govt/central bank or Institution <code>PSE</code> Public sector entities CQS-based Central govt/central bank or Institution <code>MDB</code> Multilateral development banks 0% (eligible) or CQS Central govt/central bank formula <code>INSTITUTION</code> Banks, investment firms CQS-based (20%-150%) Institution formula <code>CORPORATE</code> Non-financial corporates CQS-based or 100% Corporate formula <code>CORPORATE_SME</code> SME corporates (&lt;EUR 50m) As corporate SME adjustment <code>RETAIL_MORTGAGE</code> Residential mortgages LTV-based (20%-70%) Retail formula <code>RETAIL_QRRE</code> Qualifying revolving retail 75% QRRE formula <code>RETAIL_OTHER</code> Other retail 75% Retail formula <code>SPECIALISED_LENDING</code> PF, OF, CF, IPRE Per slotting Slotting/IRB <code>EQUITY</code> Equity exposures 100%-400% SA only (Basel 3.1) <code>DEFAULTED</code> Defaulted exposures 100%-150% Default LGD <code>OTHER</code> Unmapped/other 100% N/A"},{"location":"features/classification/#regulatory-references","title":"Regulatory References","text":"<ul> <li>CRR Art. 112: SA exposure class definitions</li> <li>CRR Art. 115: RGLA treatment</li> <li>CRR Art. 116: PSE treatment</li> <li>CRR Art. 117-118: MDB and international organisation treatment</li> <li>CRR Art. 123: Retail exposure criteria</li> <li>CRR Art. 147: IRB exposure class definitions</li> <li>CRR Art. 153(2): FI scalar (1.25x correlation)</li> <li>CRR Art. 501: SME supporting factor</li> <li>CRR Art. 501a: Infrastructure supporting factor</li> <li>CRE30.6: SME classification (Basel Framework)</li> <li>CRE20.65-70: Retail exposure criteria (Basel Framework)</li> </ul>"},{"location":"getting-started/","title":"Getting Started","text":"<p>This section will help you get up and running with the UK Credit Risk RWA Calculator quickly.</p>"},{"location":"getting-started/#prerequisites","title":"Prerequisites","text":"<p>Before you begin, ensure you have:</p> <ul> <li>Python 3.13+ installed</li> <li>uv package manager (recommended) or pip</li> <li>Access to your exposure data in Parquet or CSV format</li> </ul>"},{"location":"getting-started/#what-youll-learn","title":"What You'll Learn","text":"<ol> <li>Installation - How to install the calculator and its dependencies</li> <li>Quick Start - Run your first RWA calculation in minutes</li> <li>Concepts - Understand the key concepts and terminology</li> </ol>"},{"location":"getting-started/#overview","title":"Overview","text":"<p>The RWA calculator processes your credit exposure data through a pipeline that:</p> <ol> <li>Loads raw data from Parquet/CSV files</li> <li>Resolves counterparty and facility hierarchies</li> <li>Classifies exposures into regulatory exposure classes</li> <li>Applies credit risk mitigation (CRM)</li> <li>Calculates RWA using SA, IRB, or Slotting approaches</li> <li>Aggregates results with supporting factors and output floors</li> </ol> <pre><code>graph TD\n    A[Your Data] --&gt; B[RWA Calculator]\n    B --&gt; C[RWA Results]\n\n    subgraph Configuration\n        D[CRR Config]\n        E[Basel 3.1 Config]\n    end\n\n    D --&gt; B\n    E --&gt; B</code></pre>"},{"location":"getting-started/#quick-example","title":"Quick Example","text":"<pre><code>from datetime import date\nfrom rwa_calc.engine.pipeline import create_pipeline\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# Create configuration for CRR framework\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Create and run the pipeline\npipeline = create_pipeline()\nresult = pipeline.run(config)\n\n# Access results\nprint(f\"Total RWA: {result.total_rwa:,.2f}\")\nprint(f\"By approach: {result.by_approach}\")\n</code></pre>"},{"location":"getting-started/#next-steps","title":"Next Steps","text":"<ul> <li>New to RWA calculations? Start with Concepts</li> <li>Ready to install? Go to Installation</li> <li>Want to jump right in? Try the Quick Start</li> </ul>"},{"location":"getting-started/concepts/","title":"Key Concepts","text":"<p>This page introduces the fundamental concepts used throughout the RWA calculator. Understanding these terms is essential for working with the system effectively.</p>"},{"location":"getting-started/concepts/#risk-weighted-assets-rwa","title":"Risk-Weighted Assets (RWA)","text":"<p>Risk-Weighted Assets (RWA) are a measure of a bank's assets, adjusted for risk. They are used to determine the minimum capital a bank must hold to remain solvent.</p> <pre><code>Capital Ratio = Regulatory Capital / RWA\n</code></pre> <p>The higher the risk of an asset, the higher its risk weight, and the more capital required.</p>"},{"location":"getting-started/concepts/#example","title":"Example","text":"Asset Value Risk Weight RWA UK Government Bond \u00a3100m 0% \u00a30m Corporate Loan (AAA) \u00a3100m 20% \u00a320m Corporate Loan (Unrated) \u00a3100m 100% \u00a3100m"},{"location":"getting-started/concepts/#regulatory-frameworks","title":"Regulatory Frameworks","text":""},{"location":"getting-started/concepts/#crr-capital-requirements-regulation","title":"CRR (Capital Requirements Regulation)","text":"<p>The CRR implements Basel 3.0 standards in the UK. It is the current regulatory framework, effective until 31 December 2026.</p> <p>Key features: - 1.06 scaling factor for IRB approaches - SME Supporting Factor (Article 501) - Infrastructure Supporting Factor - No output floor</p>"},{"location":"getting-started/concepts/#basel-31","title":"Basel 3.1","text":"<p>Basel 3.1 (implemented via PRA PS9/24) introduces enhanced risk sensitivity and removes certain capital relief mechanisms. Effective from 1 January 2027.</p> <p>Key features: - Removal of 1.06 scaling factor - Removal of supporting factors - Introduction of 72.5% output floor - Differentiated PD floors - A-IRB LGD floors</p>"},{"location":"getting-started/concepts/#calculation-approaches","title":"Calculation Approaches","text":""},{"location":"getting-started/concepts/#standardised-approach-sa","title":"Standardised Approach (SA)","text":"<p>The Standardised Approach uses regulatory-prescribed risk weights based on: - External credit ratings (where available) - Exposure class characteristics - Collateral type</p> <pre><code>RWA = EAD \u00d7 Risk Weight\n</code></pre> <p>Advantages: Simple, transparent, consistent across institutions Disadvantages: Less risk-sensitive than IRB approaches</p>"},{"location":"getting-started/concepts/#foundation-irb-f-irb","title":"Foundation IRB (F-IRB)","text":"<p>The Foundation Internal Ratings-Based approach allows banks to estimate: - PD (Probability of Default) - Bank's own estimate - LGD (Loss Given Default) - Supervisory values - EAD (Exposure at Default) - Supervisory rules</p> <pre><code>RWA = K \u00d7 12.5 \u00d7 EAD \u00d7 Maturity Adjustment \u00d7 [1.06 if CRR]\n</code></pre> <p>Where K is calculated using the IRB formula.</p>"},{"location":"getting-started/concepts/#advanced-irb-a-irb","title":"Advanced IRB (A-IRB)","text":"<p>The Advanced Internal Ratings-Based approach allows banks to estimate: - PD - Bank's own estimate - LGD - Bank's own estimate - EAD - Bank's own estimate</p> <p>This provides the most risk-sensitive calculation but requires regulatory approval.</p>"},{"location":"getting-started/concepts/#slotting-approach","title":"Slotting Approach","text":"<p>The Slotting Approach applies to Specialised Lending exposures where the bank cannot estimate PD: - Project Finance - Object Finance - Commodities Finance - Income-Producing Real Estate (IPRE) - High Volatility Commercial Real Estate (HVCRE)</p> <p>Exposures are mapped to categories (Strong, Good, Satisfactory, Weak, Default) with prescribed risk weights.</p>"},{"location":"getting-started/concepts/#exposure-classes","title":"Exposure Classes","text":"<p>Exposures are classified into regulatory categories based on the counterparty's entity type:</p> Class Description Typical Risk Central Govt / Central Bank Governments and central banks Low-High RGLA Regional governments, local authorities Low-Medium PSE Public sector entities Low-Medium MDB Multilateral development banks Low Institution Banks, CCPs, financial institutions Medium Corporate Non-retail companies Medium-High Corporate SME Small/medium enterprises (&lt;EUR 50m revenue) Medium Retail Mortgage Residential mortgages Low-Medium Retail QRRE Qualifying revolving retail Medium Retail Other Other retail exposures Medium-High Specialised Lending Project finance, object finance, IPRE Variable Equity Equity holdings High Defaulted Non-performing exposures Very High"},{"location":"getting-started/concepts/#entity-type-classification","title":"Entity Type Classification","text":"<p>The counterparty's <code>entity_type</code> field is the single source of truth for exposure class determination. The calculator supports 17 entity types that map to both SA and IRB exposure classes.</p> <p>For example: - <code>pse_sovereign</code> maps to PSE for SA (uses PSE risk weight table) but CENTRAL_GOVT_CENTRAL_BANK for IRB (uses central govt/central bank formula) - <code>mdb</code> maps to MDB for SA (typically 0% RW) but CENTRAL_GOVT_CENTRAL_BANK for IRB</p> <p>See Classification for the complete entity type mapping and classification algorithm.</p>"},{"location":"getting-started/concepts/#key-metrics","title":"Key Metrics","text":""},{"location":"getting-started/concepts/#ead-exposure-at-default","title":"EAD (Exposure at Default)","text":"<p>The Exposure at Default is the expected exposure amount if the counterparty defaults.</p> <p>For on-balance sheet items: <pre><code>EAD = Drawn Amount\n</code></pre></p> <p>For off-balance sheet items: <pre><code>EAD = Committed Amount \u00d7 CCF\n</code></pre></p> <p>Where CCF (Credit Conversion Factor) converts undrawn commitments to on-balance sheet equivalents.</p>"},{"location":"getting-started/concepts/#pd-probability-of-default","title":"PD (Probability of Default)","text":"<p>The Probability of Default is the likelihood that a counterparty will default within one year. Used in IRB approaches.</p> <ul> <li>Range: 0.03% to 100%</li> <li>Floor depends on framework and exposure class</li> </ul>"},{"location":"getting-started/concepts/#lgd-loss-given-default","title":"LGD (Loss Given Default)","text":"<p>The Loss Given Default is the percentage of exposure lost if default occurs, after recoveries.</p> Approach LGD Source SA Not used (embedded in risk weight) F-IRB Supervisory values (0%, 35%, 45%, 75%) A-IRB Bank estimates (subject to floors)"},{"location":"getting-started/concepts/#ccf-credit-conversion-factor","title":"CCF (Credit Conversion Factor)","text":"<p>The Credit Conversion Factor converts off-balance sheet exposures to on-balance sheet equivalents.</p> Item Type CCF Unconditionally cancellable 0% Trade finance 20% Note issuance facilities 50% Direct credit substitutes 100%"},{"location":"getting-started/concepts/#credit-risk-mitigation-crm","title":"Credit Risk Mitigation (CRM)","text":"<p>CRM techniques reduce the capital required for an exposure:</p>"},{"location":"getting-started/concepts/#collateral","title":"Collateral","text":"<p>Physical or financial assets securing an exposure. Subject to haircuts:</p> Collateral Type Haircut Cash (same currency) 0% Government bonds 0-4% Corporate bonds 1-15% Equity 15-25% <p>Plus 8% currency mismatch haircut if applicable.</p>"},{"location":"getting-started/concepts/#guarantees","title":"Guarantees","text":"<p>Credit protection provided by a third party. The exposure can be treated as if it were to the guarantor (substitution approach).</p>"},{"location":"getting-started/concepts/#provisions","title":"Provisions","text":"<p>Specific provisions reduce EAD for SA exposures or expected loss for IRB exposures.</p>"},{"location":"getting-started/concepts/#data-hierarchy","title":"Data Hierarchy","text":"<p>Exposures follow a hierarchical structure:</p> <pre><code>graph TD\n    A[Counterparty] --&gt; B[Facility]\n    B --&gt; C[Loan/Draw]\n    A --&gt; D[Collateral]\n    A --&gt; E[Guarantee]\n    A --&gt; F[Rating]\n    B --&gt; G[Collateral]\n    C --&gt; H[Collateral]</code></pre> <ul> <li>Counterparty: The obligor (borrower)</li> <li>Facility: A credit arrangement (e.g., credit line)</li> <li>Loan: Individual draws or tranches</li> </ul> <p>Ratings and collateral can be assigned at any level and inherit down the hierarchy.</p>"},{"location":"getting-started/concepts/#pipeline-stages","title":"Pipeline Stages","text":"<p>The calculation flows through distinct stages:</p> <ol> <li>Loader: Reads raw data from files</li> <li>Hierarchy Resolver: Resolves parent-child relationships and inherits attributes</li> <li>Classifier: Assigns exposure classes and calculation approaches</li> <li>CRM Processor: Applies collateral, guarantees, and provisions</li> <li>Calculators: Compute RWA using SA, IRB, Slotting, or Equity</li> <li>Aggregator: Combines results and applies floors/factors</li> </ol>"},{"location":"getting-started/concepts/#next-steps","title":"Next Steps","text":"<ul> <li>Regulatory Frameworks - Deep dive into CRR and Basel 3.1</li> <li>Calculation Methodology - Detailed calculation explanations</li> <li>Data Model - Input and output data structures</li> </ul>"},{"location":"getting-started/installation/","title":"Installation","text":"<p>This guide covers how to install the UK Credit Risk RWA Calculator and its dependencies.</p>"},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"<ul> <li>Python: 3.13 or higher</li> <li>Operating System: Windows, macOS, or Linux</li> <li>Package Manager: uv (recommended) or pip</li> </ul>"},{"location":"getting-started/installation/#install-from-pypi-recommended","title":"Install from PyPI (Recommended)","text":"<p>The simplest way to install the calculator:</p> pipuv <pre><code>pip install rwa-calc\n</code></pre> <pre><code>uv add rwa-calc\n</code></pre>"},{"location":"getting-started/installation/#optional-dependencies","title":"Optional Dependencies","text":"<p>The calculator provides several optional dependency groups:</p> pipuv <pre><code># UI support (Marimo web interface)\npip install rwa-calc[ui]\n\n# Everything (ui and dev dependencies)\npip install rwa-calc[all]\n</code></pre> <pre><code># UI support (Marimo web interface)\nuv add rwa-calc[ui]\n\n# Everything (ui and dev dependencies)\nuv add rwa-calc[all]\n</code></pre> Extra Description <code>ui</code> Interactive web UI via Marimo for exploration and testing <code>dev</code> Development tools (pytest, mypy, mkdocs, etc.) <code>all</code> All optional dependencies combined <p>Recommended Installation</p> <p>For most users, we recommend installing with <code>ui</code> for the interactive web interface: <pre><code>pip install rwa-calc[ui]\n</code></pre></p>"},{"location":"getting-started/installation/#install-from-source","title":"Install from Source","text":"<p>For development or to get the latest unreleased changes, install from the GitHub repository.</p>"},{"location":"getting-started/installation/#installation-with-uv-recommended","title":"Installation with uv (Recommended)","text":"<p>uv is the recommended package manager for this project due to its speed and reliability.</p>"},{"location":"getting-started/installation/#install-uv","title":"Install uv","text":"Windows (PowerShell)macOS/Linux <pre><code>powershell -ExecutionPolicy ByPass -c \"irm https://astral.sh/uv/install.ps1 | iex\"\n</code></pre> <pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh\n</code></pre>"},{"location":"getting-started/installation/#install-the-calculator","title":"Install the Calculator","text":"<pre><code># Clone the repository\ngit clone https://github.com/OpenAfterHours/rwa_calculator.git\ncd rwa_calculator\n\n# Install dependencies with uv\nuv sync\n\n# Install with development dependencies\nuv sync --all-extras\n</code></pre>"},{"location":"getting-started/installation/#installation-with-pip","title":"Installation with pip","text":"<p>If you prefer pip, you can install using:</p> <pre><code># Clone the repository\ngit clone https://github.com/OpenAfterHours/rwa_calculator.git\ncd rwa_calculator\n\n# Create a virtual environment\npython -m venv .venv\n\n# Activate the virtual environment\n# Windows:\n.venv\\Scripts\\activate\n# macOS/Linux:\nsource .venv/bin/activate\n\n# Install in editable mode\npip install -e .\n\n# Install with development dependencies\npip install -e \".[dev]\"\n</code></pre>"},{"location":"getting-started/installation/#dependencies","title":"Dependencies","text":""},{"location":"getting-started/installation/#core-dependencies","title":"Core Dependencies","text":"Package Purpose <code>polars</code> High-performance DataFrame operations <code>pydantic</code> Data validation and settings management <code>polars-normal-stats</code> Statistical functions for IRB calculations (normal CDF/PPF) <code>pyarrow</code> Parquet file support <code>pyyaml</code> Configuration file parsing <code>duckdb</code> SQL analytics engine"},{"location":"getting-started/installation/#optional-dependencies_1","title":"Optional Dependencies","text":"Package Extra Purpose <code>marimo</code> <code>ui</code> Interactive notebook UI <code>uvicorn</code> <code>ui</code> ASGI server for UI"},{"location":"getting-started/installation/#development-dependencies","title":"Development Dependencies","text":"Package Purpose <code>pytest</code> Testing framework <code>pytest-cov</code> Test coverage reporting <code>ruff</code> Linting and formatting <code>mypy</code> Static type checking <code>mkdocs</code> Documentation generation <code>mkdocs-material</code> Documentation theme <code>mkdocstrings[python]</code> API documentation <code>marimo</code> Interactive notebooks"},{"location":"getting-started/installation/#verifying-installation","title":"Verifying Installation","text":"<p>After installation, verify everything is working:</p> <pre><code># Run the test suite\nuv run pytest\n\n# Or with pip\npytest\n</code></pre> <p>You should see output similar to:</p> <pre><code>========================= test session starts ==========================\ncollected 468 items\n\ntests/contracts/test_bundles.py::TestRawDataBundle ...\n...\n========================= 448 passed, 20 skipped =======================\n</code></pre>"},{"location":"getting-started/installation/#project-structure","title":"Project Structure","text":"<p>After installation, your project structure should look like:</p> <pre><code>rwa_calculator/\n\u251c\u2500\u2500 src/\n\u2502   \u2514\u2500\u2500 rwa_calc/           # Main source code\n\u2502       \u251c\u2500\u2500 config/         # Configuration (FX rates)\n\u2502       \u251c\u2500\u2500 contracts/      # Interfaces and data contracts\n\u2502       \u251c\u2500\u2500 data/           # Schemas and regulatory tables\n\u2502       \u251c\u2500\u2500 domain/         # Core domain enums\n\u2502       \u2514\u2500\u2500 engine/         # Calculation engines\n\u251c\u2500\u2500 tests/                  # Test suite\n\u251c\u2500\u2500 workbooks/              # Reference implementations\n\u251c\u2500\u2500 ref_docs/               # Regulatory documents\n\u251c\u2500\u2500 docs/                   # This documentation\n\u251c\u2500\u2500 pyproject.toml          # Project configuration\n\u2514\u2500\u2500 mkdocs.yml              # Documentation configuration\n</code></pre>"},{"location":"getting-started/installation/#environment-variables","title":"Environment Variables","text":"<p>The calculator uses sensible defaults, but you can configure:</p> Variable Description Default <code>RWA_DATA_PATH</code> Default path for input data <code>./data</code> <code>RWA_OUTPUT_PATH</code> Default path for output files <code>./output</code>"},{"location":"getting-started/installation/#ide-setup","title":"IDE Setup","text":""},{"location":"getting-started/installation/#vs-code","title":"VS Code","text":"<p>Install recommended extensions:</p> <pre><code>{\n  \"recommendations\": [\n    \"ms-python.python\",\n    \"ms-python.vscode-pylance\",\n    \"charliermarsh.ruff\"\n  ]\n}\n</code></pre>"},{"location":"getting-started/installation/#pycharm","title":"PyCharm","text":"<ol> <li>Open the project directory</li> <li>Configure the Python interpreter to use the virtual environment</li> <li>Mark <code>src</code> as a Sources Root</li> </ol>"},{"location":"getting-started/installation/#troubleshooting","title":"Troubleshooting","text":""},{"location":"getting-started/installation/#common-issues","title":"Common Issues","text":"<p>Python version mismatch</p> <pre><code># Check your Python version\npython --version\n\n# Ensure it's 3.13 or higher\n# If not, install Python 3.13+ from python.org\n</code></pre> <p>Import errors</p> <pre><code># Ensure the package is installed in editable mode\nuv pip install -e .\n\n# Or verify PYTHONPATH includes src/\nexport PYTHONPATH=\"${PYTHONPATH}:./src\"\n</code></pre> <p>Polars installation issues</p> <pre><code># Polars requires a compatible CPU architecture\n# For older CPUs, try:\npip install polars-lts-cpu\n</code></pre>"},{"location":"getting-started/installation/#next-steps","title":"Next Steps","text":"<ul> <li>Quick Start Guide - Run your first calculation</li> <li>Concepts - Understand the key terminology</li> </ul>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":"<p>This guide will help you run your first RWA calculation in just a few minutes.</p>"},{"location":"getting-started/quickstart/#choose-your-approach","title":"Choose Your Approach","text":"<p>There are two ways to run RWA calculations:</p> Approach Best For Guide Interactive UI Quick analysis, exploring results, non-developers See below Python API Automation, integration, custom workflows See below"},{"location":"getting-started/quickstart/#using-the-interactive-ui","title":"Using the Interactive UI","text":"<p>The fastest way to get started is the web-based interface.</p>"},{"location":"getting-started/quickstart/#step-1-install-with-ui-support","title":"Step 1: Install with UI Support","text":"<pre><code>pip install rwa-calc[ui]\n# Or with uv\nuv add rwa-calc --extra ui\n</code></pre>"},{"location":"getting-started/quickstart/#step-2-start-the-server","title":"Step 2: Start the Server","text":"<pre><code># If installed from PyPI\nrwa-calc-ui\n\n# Or from source\nuv run python src/rwa_calc/ui/marimo/server.py\n</code></pre>"},{"location":"getting-started/quickstart/#step-3-open-your-browser","title":"Step 3: Open Your Browser","text":"<p>Navigate to http://localhost:8000 to access:</p> <ul> <li>RWA Calculator (<code>/</code>) - Run calculations on your data</li> <li>Results Explorer (<code>/results</code>) - Filter and analyze results</li> <li>Framework Reference (<code>/reference</code>) - View regulatory parameters</li> </ul> <p>For detailed UI documentation, see the Interactive UI Guide.</p>"},{"location":"getting-started/quickstart/#using-the-python-api","title":"Using the Python API","text":""},{"location":"getting-started/quickstart/#step-1-import-the-required-modules","title":"Step 1: Import the Required Modules","text":"<pre><code>from datetime import date\nfrom rwa_calc.engine.pipeline import create_pipeline\nfrom rwa_calc.contracts.config import CalculationConfig\n</code></pre>"},{"location":"getting-started/quickstart/#step-2-create-a-configuration","title":"Step 2: Create a Configuration","text":"<p>Choose the regulatory framework for your calculation:</p> CRR (Current)Basel 3.1 (Future) <pre><code># For calculations under current CRR rules (until Dec 2026)\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31)\n)\n</code></pre> <pre><code># For calculations under Basel 3.1 (from Jan 2027)\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2027, 1, 1)\n)\n</code></pre>"},{"location":"getting-started/quickstart/#step-3-create-and-run-the-pipeline","title":"Step 3: Create and Run the Pipeline","text":"<pre><code># Create the pipeline\npipeline = create_pipeline()\n\n# Run the calculation\nresult = pipeline.run(config)\n</code></pre>"},{"location":"getting-started/quickstart/#step-4-access-results","title":"Step 4: Access Results","text":"<pre><code># Total RWA\nprint(f\"Total RWA: {result.total_rwa:,.2f}\")\n\n# RWA by approach\nprint(f\"SA RWA: {result.sa_rwa:,.2f}\")\nprint(f\"IRB RWA: {result.irb_rwa:,.2f}\")\nprint(f\"Slotting RWA: {result.slotting_rwa:,.2f}\")\n\n# Get detailed breakdown\ndf = result.to_dataframe()\nprint(df.head())\n</code></pre>"},{"location":"getting-started/quickstart/#complete-example","title":"Complete Example","text":"<p>Here's a complete working example:</p> <pre><code>from datetime import date\nfrom pathlib import Path\n\nfrom rwa_calc.engine.pipeline import create_pipeline\nfrom rwa_calc.contracts.config import CalculationConfig\n\ndef calculate_rwa():\n    \"\"\"Calculate RWA for credit exposures.\"\"\"\n\n    # Configure for CRR framework\n    config = CalculationConfig.crr(\n        reporting_date=date(2026, 12, 31),\n        apply_sme_supporting_factor=True,\n        apply_infrastructure_factor=True\n    )\n\n    # Create the pipeline\n    pipeline = create_pipeline()\n\n    # Run the calculation\n    result = pipeline.run(config)\n\n    # Print summary\n    print(\"=\" * 50)\n    print(\"RWA Calculation Results\")\n    print(\"=\" * 50)\n    print(f\"Reporting Date: {config.reporting_date}\")\n    print(f\"Framework: {config.framework.value}\")\n    print(\"-\" * 50)\n    print(f\"Total RWA: GBP {result.total_rwa:,.2f}\")\n    print(f\"  - SA RWA: GBP {result.sa_rwa:,.2f}\")\n    print(f\"  - IRB RWA: GBP {result.irb_rwa:,.2f}\")\n    print(f\"  - Slotting RWA: GBP {result.slotting_rwa:,.2f}\")\n    print(\"=\" * 50)\n\n    return result\n\nif __name__ == \"__main__\":\n    calculate_rwa()\n</code></pre>"},{"location":"getting-started/quickstart/#working-with-custom-data","title":"Working with Custom Data","text":""},{"location":"getting-started/quickstart/#loading-from-parquet-files","title":"Loading from Parquet Files","text":"<pre><code>from pathlib import Path\nfrom rwa_calc.engine.loader import ParquetLoader\n\n# Specify your data directory\ndata_path = Path(\"./your_data\")\n\n# Create a loader\nloader = ParquetLoader(data_path)\n\n# Load data\nraw_data = loader.load()\n\n# Run pipeline with your data\nresult = pipeline.run_with_data(raw_data, config)\n</code></pre>"},{"location":"getting-started/quickstart/#required-data-files","title":"Required Data Files","text":"<p>The calculator expects the following Parquet files:</p> File Description Required <code>counterparties.parquet</code> Counterparty information Yes <code>facilities.parquet</code> Credit facilities Yes <code>loans.parquet</code> Individual loans/draws Yes <code>contingents.parquet</code> Off-balance sheet items No <code>collateral.parquet</code> Collateral holdings No <code>guarantees.parquet</code> Guarantee information No <code>provisions.parquet</code> Provision allocations No <code>ratings.parquet</code> Credit ratings No <code>org_mapping.parquet</code> Organization hierarchy No <code>lending_mapping.parquet</code> Retail lending groups No"},{"location":"getting-started/quickstart/#configuration-options","title":"Configuration Options","text":""},{"location":"getting-started/quickstart/#crr-configuration","title":"CRR Configuration","text":"<pre><code>config = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n\n    # Supporting factors (CRR-specific)\n    apply_sme_supporting_factor=True,    # Article 501 SME factor\n    apply_infrastructure_factor=True,     # Infrastructure factor\n\n    # FX conversion\n    eur_gbp_rate=Decimal(\"0.88\"),         # EUR to GBP rate\n)\n</code></pre>"},{"location":"getting-started/quickstart/#basel-31-configuration","title":"Basel 3.1 Configuration","text":"<pre><code>config = CalculationConfig.basel_3_1(\n    reporting_date=date(2027, 1, 1),\n\n    # Output floor (Basel 3.1-specific)\n    output_floor_percentage=0.725,        # 72.5% floor\n    transitional_floor_year=2027,         # Phase-in year\n)\n</code></pre>"},{"location":"getting-started/quickstart/#understanding-results","title":"Understanding Results","text":"<p>The result object provides several views of the calculated RWA:</p>"},{"location":"getting-started/quickstart/#summary-statistics","title":"Summary Statistics","text":"<pre><code># Total figures\nresult.total_rwa          # Total risk-weighted assets\nresult.total_ead          # Total exposure at default\nresult.total_expected_loss # Total expected loss (IRB only)\n\n# By approach\nresult.sa_rwa             # Standardised Approach RWA\nresult.irb_rwa            # IRB RWA (before scaling/floor)\nresult.slotting_rwa       # Slotting RWA\n</code></pre>"},{"location":"getting-started/quickstart/#detailed-breakdown","title":"Detailed Breakdown","text":"<pre><code># Get as Polars DataFrame\ndf = result.to_dataframe()\n\n# Filter by exposure class\ncorporate = df.filter(pl.col(\"exposure_class\") == \"CORPORATE\")\n\n# Aggregate by any dimension\nby_approach = df.group_by(\"approach\").agg(\n    pl.col(\"rwa\").sum().alias(\"total_rwa\"),\n    pl.col(\"ead\").sum().alias(\"total_ead\")\n)\n</code></pre>"},{"location":"getting-started/quickstart/#export-results","title":"Export Results","text":"<pre><code># To Parquet\nresult.to_parquet(\"results.parquet\")\n\n# To CSV\nresult.to_csv(\"results.csv\")\n\n# To JSON\nresult.to_json(\"results.json\")\n</code></pre>"},{"location":"getting-started/quickstart/#error-handling","title":"Error Handling","text":"<p>The calculator accumulates errors rather than failing fast:</p> <pre><code>result = pipeline.run(config)\n\n# Check for errors\nif result.has_errors:\n    for error in result.errors:\n        print(f\"Error: {error.message}\")\n        print(f\"  Exposure: {error.exposure_id}\")\n        print(f\"  Stage: {error.stage}\")\n\n# Check for warnings\nif result.has_warnings:\n    for warning in result.warnings:\n        print(f\"Warning: {warning.message}\")\n</code></pre>"},{"location":"getting-started/quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Concepts - Understand key terminology</li> <li>Configuration Guide - Advanced configuration options</li> <li>Calculation Methodology - How calculations work</li> </ul>"},{"location":"plans/","title":"Project Plans","text":"<p>This section contains project planning documents, development roadmaps, and phase tracking for the RWA Calculator.</p>"},{"location":"plans/#overview","title":"Overview","text":"<p>The project follows a phased, test-first approach prioritising CRR (Basel 3.0) implementation before extending to Basel 3.1.</p>"},{"location":"plans/#documents","title":"Documents","text":"<ul> <li>Development Roadmap - Current development status, phase tracking, and implementation progress</li> <li>Implementation Plan - Detailed acceptance test scenarios, contract definitions, and regulatory parameters</li> </ul>"},{"location":"plans/#development-philosophy","title":"Development Philosophy","text":"<p>The project adheres to these core principles:</p> <ol> <li>Test-Driven Development (TDD) - Tests are written before implementation</li> <li>Phased Delivery - Features are delivered incrementally with clear milestones</li> <li>Regulatory Accuracy - All calculations are validated against regulatory specifications</li> <li>Performance First - LazyFrame operations and vectorized calculations throughout</li> </ol>"},{"location":"plans/#current-focus","title":"Current Focus","text":"<p>The calculator is currently in active development with CRR (Basel 3.0) implementation complete and Basel 3.1 implementation planned.</p> <p>See the Development Roadmap for detailed status and progress tracking.</p>"},{"location":"plans/implementation-plan/","title":"Implementation Plan","text":"<p>This document provides the detailed implementation plan including acceptance test scenarios, contract definitions, and implementation order.</p>"},{"location":"plans/implementation-plan/#overview","title":"Overview","text":"<p>The implementation follows a test-first approach with phases:</p> <ol> <li>Phase 1: User Acceptance Tests - Define expected inputs and outputs</li> <li>Phase 2: Process Contracts - Establish interfaces between components</li> <li>Phase 3: Implementation - Build components in dependency order</li> <li>Phase 4: Acceptance Testing - Validate against expected outputs</li> </ol> <p>Regulatory Framework Prioritisation: 1. Phase A: CRR (Basel 3.0) - Current UK implementation (effective until 31 Dec 2026) 2. Phase B: Basel 3.1 - Future UK implementation (effective from 1 Jan 2027 per PRA PS9/24)</p>"},{"location":"plans/implementation-plan/#crr-acceptance-test-scenarios","title":"CRR Acceptance Test Scenarios","text":"<p>Each scenario defines specific inputs and expected outputs with hand-calculated values based on current CRR rules (EU 575/2013 as onshored into UK law).</p>"},{"location":"plans/implementation-plan/#scenario-group-crr-a-standardised-approach-sa","title":"Scenario Group CRR-A: Standardised Approach (SA)","text":"ID Description Key Inputs Expected RWA Regulatory Basis CRR-A1 UK Sovereign exposure \u00a31m loan to UK Govt, CQS1 \u00a30 (0% RW) CRR Art. 114 CRR-A2 Unrated corporate \u00a31m loan, no rating, no SME \u00a31m (100% RW) CRR Art. 122 CRR-A3 Rated corporate CQS2 \u00a31m loan, A-rated \u00a3500k (50% RW) CRR Art. 122 CRR-A4 Institution ECRA CQS2 \u00a31m loan to UK bank, A-rated \u00a3300k (30% RW) CRR Art. 120 + UK deviation CRR-A5 Residential mortgage \u226480% LTV \u00a3500k loan, 75% LTV \u00a3175k (35% RW) CRR Art. 125 CRR-A6 Residential mortgage &gt;80% LTV \u00a3850k loan, 85% LTV \u00a3425k (50% avg RW) CRR Art. 125 CRR-A7 Commercial real estate \u226450% LTV \u00a3600k loan, 50% LTV \u00a3300k (50% RW) CRR Art. 126 CRR-A8 Off-balance sheet commitment \u00a31m undrawn (&gt;1yr), 50% CCF \u00a3500k EAD CRR Art. 111 CRR-A9 Retail exposure \u00a350k loan to individual \u00a337.5k (75% RW) CRR Art. 123 CRR-A10 SME with supporting factor \u00a31m loan, SME &lt;\u20ac50m turnover \u00a3761.9k (100% \u00d7 0.7619) CRR Art. 501 CRR-A11 SME Retail with supporting factor SME retail exposure Retail RW \u00d7 0.7619 CRR Art. 501 CRR-A12 Large Corporate (no supporting factor) Turnover &gt; \u20ac50m 100% RW, no factor CRR Art. 122"},{"location":"plans/implementation-plan/#scenario-group-crr-b-foundation-irb-f-irb","title":"Scenario Group CRR-B: Foundation IRB (F-IRB)","text":"<p>Note: F-IRB only applies to wholesale exposures (corporate, institution, sovereign). Retail exposures must use A-IRB or Standardised Approach.</p> ID Description Key Inputs Expected RWA Notes CRR-B1 Corporate unsecured - low PD PD=0.10%, LGD=45%, M=2.5y, EAD=\u00a325m \u00a37.86m CRR Art. 153, 161-163 CRR-B2 Corporate unsecured - high PD PD=5.00%, LGD=45%, M=3.0y, EAD=\u00a35m \u00a38.26m CRR Art. 153, 161-162 CRR-B3 Subordinated exposure PD=1.00%, LGD=75%, M=4.0y, EAD=\u00a32m \u00a33.93m CRR Art. 153, 161 CRR-B4 SME Corporate - firm size adj PD=1.50%, LGD=45%, M=2.5y, T=\u20ac25m Reduced R CRR Art. 153(4), 161 CRR-B5 SME Corporate - both adjustments PD=2.00%, LGD=45%, M=3.0y, T=\u20ac15m R adj + SF 0.7619 CRR Art. 153(4), 501 CRR-B6 Corporate at SME threshold PD=1.00%, LGD=45%, M=2.5y, T=\u20ac50m No firm size adj CRR Art. 153, 161 CRR-B7 Long maturity exposure PD=0.80%, LGD=45%, M=7y (capped 5y) Maturity capped CRR Art. 153, 162"},{"location":"plans/implementation-plan/#scenario-group-crr-c-advanced-irb-a-irb","title":"Scenario Group CRR-C: Advanced IRB (A-IRB)","text":"ID Description Key Inputs Expected RWA Notes CRR-C1 Corporate own estimates PD=1%, LGD=35%, M=2.5y Bank-estimated CRR Art. 143 CRR-C2 Retail own estimates PD=0.3%, LGD=15%, EAD=\u00a3100k Retail formula CRR Art. 154 CRR-C3 Specialised lending A-IRB PD=1.5%, LGD=25% Project finance CRR Art. 153 <p>Note: CRR A-IRB has NO LGD floors (unlike Basel 3.1 which has 25% unsecured floor).</p>"},{"location":"plans/implementation-plan/#scenario-group-crr-d-credit-risk-mitigation-crm","title":"Scenario Group CRR-D: Credit Risk Mitigation (CRM)","text":"ID Description Key Inputs Expected RWA Notes CRR-D1 Cash collateral (SA) \u00a31m exposure, \u00a3500k cash \u00a3500k EAD CRR Art. 207 CRR-D2 Govt bond collateral \u00a31m exp, \u00a3600k gilts (5y) Haircut applied CRR Art. 224 CRR-D3 Equity collateral (main index) \u00a31m exp, \u00a3400k listed equity 15% haircut CRR Art. 224 CRR-D4 Guarantee substitution \u00a31m corp, \u00a3600k bank guarantee Split RW CRR Art. 213 CRR-D5 Maturity mismatch \u00a31m exp 5y, \u00a3500k collateral 2y Adjusted value CRR Art. 238 CRR-D6 Currency mismatch \u00a31m GBP exp, \u20ac500k collateral 8% FX haircut CRR Art. 224"},{"location":"plans/implementation-plan/#scenario-group-crr-e-specialised-lending-slotting","title":"Scenario Group CRR-E: Specialised Lending (Slotting)","text":"ID Description Key Inputs Expected RWA Notes CRR-E1 Project finance - Strong \u00a310m, Strong category \u00a37m (70% RW) CRR Art. 153(5) CRR-E2 Project finance - Good \u00a310m, Good category \u00a37m (70% RW) Same as Strong CRR-E3 IPRE - Weak \u00a35m, Weak category \u00a35.75m (115% RW) CRR Art. 153(5) CRR-E4 HVCRE - Strong \u00a35m, High volatility CRE \u00a33.5m (70% RW) CRR Art. 153(5) <p>CRR Slotting Risk Weights:</p> Category Non-HVCRE HVCRE Strong 70% 70% Good 70% 70% Satisfactory 115% 115% Weak 250% 250% Default 0% (EL) 0% (EL)"},{"location":"plans/implementation-plan/#scenario-group-crr-f-supporting-factors","title":"Scenario Group CRR-F: Supporting Factors","text":"ID Description Key Inputs Expected RWA Notes CRR-F1 SME Tier 1 only Small exposure (\u00a32m \u2264 \u00a32.2m) 0.7619 factor CRR Art. 501 CRR-F2 SME blended tiers Medium exposure (\u00a34m) Blended factor CRR Art. 501 CRR-F3 SME Tier 2 dominant Large exposure (\u00a310m) ~0.85 factor CRR Art. 501 CRR-F4 SME retail with Tier 1 \u00a3500k retail 0.7619 factor CRR Art. 501 CRR-F5 Infrastructure supporting factor Qualifying infrastructure 0.75 factor CRR Art. 501a CRR-F6 Large corporate - no factor Turnover &gt; \u00a344m No factor CRR Art. 501 CRR-F7 At exposure threshold \u00a32.2m exactly 0.7619 factor CRR Art. 501 <p>CRR SME Supporting Factor - Tiered Approach (CRR2 Art. 501): - Tier 1: Exposures up to \u20ac2.5m (\u00a32.2m): factor of 0.7619 (23.81% RWA reduction) - Tier 2: Exposures above \u20ac2.5m (\u00a32.2m): factor of 0.85 (15% RWA reduction) - Formula: <code>factor = [min(E, threshold) \u00d7 0.7619 + max(E - threshold, 0) \u00d7 0.85] / E</code></p>"},{"location":"plans/implementation-plan/#scenario-group-crr-g-provisions-impairments","title":"Scenario Group CRR-G: Provisions &amp; Impairments","text":"ID Description Key Inputs Expected RWA Notes CRR-G1 SA with specific provision \u00a31m exposure, \u00a350k provision \u00a3950k net CRR Art. 110 CRR-G2 IRB EL shortfall EL &gt; provisions T2 deduction CRR Art. 159 CRR-G3 IRB EL excess Provisions &gt; EL T2 credit (capped) CRR Art. 62(d)"},{"location":"plans/implementation-plan/#scenario-group-crr-h-complexcombined","title":"Scenario Group CRR-H: Complex/Combined","text":"ID Description Key Inputs Expected RWA Notes CRR-H1 Facility with multiple loans \u00a35m facility, 3 loans Aggregate Hierarchy test CRR-H2 Counterparty group Parent + 2 subs Rating inheritance Org hierarchy CRR-H3 SME chain with factor SME corp + supporting factor 0.7619 applied CRR Art. 501 CRR-H4 Full CRM chain Exp + coll + guar + prov All CRM steps Integration"},{"location":"plans/implementation-plan/#basel-31-acceptance-test-scenarios","title":"Basel 3.1 Acceptance Test Scenarios","text":"<p>These scenarios test the Basel 3.1 implementation per PRA PS9/24, effective 1 Jan 2027.</p>"},{"location":"plans/implementation-plan/#scenario-group-b31-a-standardised-approach-sa","title":"Scenario Group B31-A: Standardised Approach (SA)","text":"ID Description Key Inputs Expected RWA Regulatory Basis B31-A1 UK Sovereign exposure \u00a31m loan to UK Govt, CQS1 \u00a30 (0% RW) CRE20.7 B31-A2 Unrated corporate \u00a31m loan, no rating \u00a31m (100% RW) CRE20.26 B31-A3 Rated corporate CQS2 \u00a31m loan, A-rated \u00a3500k (50% RW) CRE20.25 B31-A4 Institution ECRA CQS2 \u00a31m loan to UK bank \u00a3300k (30% RW) UK deviation B31-A5 Residential mortgage 60% LTV \u00a3500k loan \u00a3100k (20% RW) CRE20.71 B31-A6 Residential mortgage 85% LTV \u00a3850k loan \u00a3297.5k (35% RW) CRE20.71 B31-A10 SME (no supporting factor) \u00a31m loan, SME \u00a31m (100% RW) No factor in B3.1"},{"location":"plans/implementation-plan/#scenario-group-b31-f-output-floor","title":"Scenario Group B31-F: Output Floor","text":"ID Description Key Inputs Expected RWA Notes B31-F1 Floor binding IRB=\u00a350m, SA=\u00a3100m \u00a372.5m 72.5% floor B31-F2 Floor not binding IRB=\u00a380m, SA=\u00a3100m \u00a380m IRB &gt; floor B31-F3 Transitional 2027 Year 2027, 50% floor Phased floor PRA PS9/24 <p>Output Floor Phase-In:</p> Year Floor % 2027 50% 2028 55% 2029 60% 2030 65% 2031 70% 2032+ 72.5%"},{"location":"plans/implementation-plan/#key-crr-implementation-details","title":"Key CRR Implementation Details","text":"<ol> <li> <p>1.06 Scaling Factor: Applies to ALL IRB RWA under CRR (removed in Basel 3.1)    <pre><code>CRR:      RWA = K \u00d7 12.5 \u00d7 1.06 \u00d7 EAD \u00d7 MA\nBasel 3.1: RWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA\n</code></pre></p> </li> <li> <p>SME Firm Size Adjustment: <code>R_adjusted = R - 0.04 \u00d7 (1 - (max(S, 5) - 5) / 45)</code> for turnover &lt; EUR 50m</p> </li> <li> <p>PD Floor: Single 0.03% floor for all exposure classes (Basel 3.1 has differentiated floors)</p> </li> <li> <p>F-IRB LGDs: 45% unsecured senior, 75% subordinated</p> </li> <li> <p>Maturity: Floor 1 year, Cap 5 years</p> </li> </ol>"},{"location":"plans/implementation-plan/#test-data-fixtures","title":"Test Data Fixtures","text":"<p>Test datasets cover all key regulatory scenarios:</p> <pre><code>tests/fixtures/\n\u251c\u2500\u2500 counterparty/\n\u2502   \u251c\u2500\u2500 sovereign.py              # UK Govt, US Govt, Brazil, Argentina, etc.\n\u2502   \u251c\u2500\u2500 institution.py            # Banks (Barclays, HSBC, JPMorgan), CCPs\n\u2502   \u251c\u2500\u2500 corporate.py              # Large corp, SME, unrated, org hierarchy groups\n\u2502   \u251c\u2500\u2500 retail.py                 # Individuals, mortgages, SME retail, lending groups\n\u2502   \u2514\u2500\u2500 specialised_lending.py    # Project finance, IPRE, HVCRE, object finance\n\u251c\u2500\u2500 exposures/\n\u2502   \u251c\u2500\u2500 facilities.py             # RCFs, term facilities, mortgages, hierarchy test\n\u2502   \u251c\u2500\u2500 loans.py                  # Drawn exposures for all acceptance scenarios\n\u2502   \u251c\u2500\u2500 contingents.py            # Off-balance sheet (LCs, guarantees, commitments)\n\u2502   \u2514\u2500\u2500 facility_mapping.py       # Facility-to-loan/contingent relationships\n\u251c\u2500\u2500 collateral/\n\u2502   \u2514\u2500\u2500 collateral.py             # Cash, bonds, equity, real estate, receivables\n\u251c\u2500\u2500 guarantee/\n\u2502   \u2514\u2500\u2500 guarantee.py              # Sovereign, bank, corporate guarantees\n\u251c\u2500\u2500 provision/\n\u2502   \u2514\u2500\u2500 provision.py              # SCRA/GCRA, IFRS9 stages 1-3\n\u251c\u2500\u2500 ratings/\n\u2502   \u2514\u2500\u2500 ratings.py                # External (S&amp;P/Moody's) and internal ratings\n\u2514\u2500\u2500 mapping/\n    \u251c\u2500\u2500 org_mapping.py            # Parent-subsidiary relationships\n    \u2514\u2500\u2500 lending_mapping.py        # Retail lending group connections\n</code></pre>"},{"location":"plans/implementation-plan/#crr-regulatory-parameters","title":"CRR Regulatory Parameters","text":""},{"location":"plans/implementation-plan/#sa-risk-weights","title":"SA Risk Weights","text":""},{"location":"plans/implementation-plan/#sovereigns-art-114","title":"Sovereigns (Art. 114)","text":"CQS Risk Weight 1 0% 2 20% 3 50% 4-5 100% 6 150% Unrated 100%"},{"location":"plans/implementation-plan/#institutions-art-120-121-ecra","title":"Institutions (Art. 120-121) - ECRA","text":"CQS Risk Weight UK Deviation 1 20% 20% 2 50% 30% 3 50% 50% 4-5 100% 100% 6 150% 150% Unrated 40% 40%"},{"location":"plans/implementation-plan/#corporates-art-122","title":"Corporates (Art. 122)","text":"CQS Risk Weight 1 20% 2 50% 3-4 100% 5-6 150% Unrated 100%"},{"location":"plans/implementation-plan/#real-estate-art-125-126","title":"Real Estate (Art. 125-126)","text":"<p>Residential (Art. 125): - LTV \u226480%: 35% - LTV &gt;80%: Split treatment (35% on 80%, 75% on excess)</p> <p>Commercial (Art. 126): - LTV \u226450%: 50% (where rental income &gt;1.5x interest) - Otherwise: 100%</p>"},{"location":"plans/implementation-plan/#ccfs-art-111","title":"CCFs (Art. 111)","text":"Category CCF Full risk 100% Medium risk 50% Medium-low risk 20% Low risk 0%"},{"location":"plans/implementation-plan/#supervisory-haircuts-art-224","title":"Supervisory Haircuts (Art. 224)","text":"Collateral Type Haircut Cash 0% CQS 1 govt bonds \u22641y 0.5% CQS 1 govt bonds 1-5y 2% CQS 1 govt bonds &gt;5y 4% Main index equity 15% Other equity 25% Currency mismatch +8%"},{"location":"plans/implementation-plan/#f-irb-lgds","title":"F-IRB LGDs","text":"Collateral Type LGD Unsecured senior 45% Subordinated 75% Financial collateral 0% Receivables 35% Commercial/residential RE 35%"},{"location":"plans/implementation-plan/#next-steps","title":"Next Steps","text":""},{"location":"plans/implementation-plan/#completed-fixture-work","title":"Completed Fixture Work","text":"<p>The majority of fixture data has been completed, enabling 62 of 65 acceptance tests to pass:</p> <ul> <li>[x] IRB exposures with PD values (CRR-B: 7/7 pass)</li> <li>[x] CRM scenario exposures with collateral/guarantees (CRR-D: 6/6 pass)</li> <li>[x] Specialised lending exposures with slotting categories (CRR-E: 4/4 pass)</li> <li>[x] Supporting factor scenario exposures (CRR-F: 7/7 pass)</li> <li>[x] Provision scenario exposures with EL data (CRR-G: 3/3 pass)</li> <li>[x] Complex/combined scenario exposures (CRR-H: 4/4 pass)</li> </ul>"},{"location":"plans/implementation-plan/#remaining-fixture-work","title":"Remaining Fixture Work","text":"<ul> <li>[ ] Commercial RE low LTV fixture data (CRR-A7)</li> <li>[ ] Off-balance sheet commitment CCF fixture data (CRR-A8)</li> <li>[ ] Specialised lending A-IRB fixture data (CRR-C3)</li> </ul>"},{"location":"plans/implementation-plan/#basel-31-extension","title":"Basel 3.1 Extension","text":"<ul> <li>[ ] Basel 3.1 expected outputs</li> <li>[ ] Basel 3.1 acceptance tests</li> <li>[ ] Updated risk weight tables (LTV-based real estate)</li> <li>[ ] Differentiated PD floors</li> <li>[ ] A-IRB LGD floors</li> <li>[ ] Output floor phase-in validation</li> </ul>"},{"location":"plans/implementation-plan/#related-documentation","title":"Related Documentation","text":"<ul> <li>Development Roadmap - Current status and phase tracking</li> <li>Testing Guide - How to run tests</li> <li>Framework Comparison - CRR vs Basel 3.1 differences</li> </ul>"},{"location":"plans/retail_airb_corporate_firb_plan/","title":"Plan: Corporate-to-Retail Reclassification with Hybrid IRB Permissions","text":"<p>Status: Implemented (v0.1.11) \u2014 All components below have been built and are wired end-to-end: enum (<code>IRBApproachOption.RETAIL_AIRB_CORPORATE_FIRB</code>), config factory (<code>IRBPermissions.retail_airb_corporate_firb()</code>), classifier reclassification logic, API model, service layer, and Marimo UI dropdown. See <code>tests/unit/test_corporate_to_retail_reclassification.py</code> and <code>tests/unit/test_irb_permissions.py</code> for test coverage.</p>"},{"location":"plans/retail_airb_corporate_firb_plan/#problem-statement","title":"Problem Statement","text":"<p>A firm has the following IRB approvals: - AIRB for retail exposures (including corporates that qualify as \"regulatory retail\") - FIRB for corporate exposures</p> <p>Under CRR Art. 147(5) / Basel CRE30.16-17, corporate exposures CAN be treated as retail (\"regulatory retail\" or \"SME retail\") if: 1. Aggregated exposure to the obligor/group &lt; EUR 1m 2. The exposure is managed as part of a retail portfolio (similar risk characteristics) 3. The firm has internal LGD estimates (required for AIRB)</p>"},{"location":"plans/retail_airb_corporate_firb_plan/#current-gaps","title":"Current Gaps","text":"<ol> <li> <p><code>is_managed_as_retail</code> flag exists but is unused: The counterparty schema has this flag, and it's joined to exposures (<code>cp_is_managed_as_retail</code>), but it's never used in classification logic.</p> </li> <li> <p>No downward reclassification: The classifier only reclassifies retail exposures UP to corporate when they exceed the EUR 1m threshold. It does NOT reclassify corporates DOWN to retail.</p> </li> <li> <p>No hybrid IRB permission: There's no <code>IRBPermissions</code> configuration that grants AIRB for retail and FIRB for corporate simultaneously.</p> </li> <li> <p>LGD availability check missing: AIRB requires modelled LGD. If no internal LGD estimate exists, the exposure must use FIRB (supervisory LGD).</p> </li> </ol>"},{"location":"plans/retail_airb_corporate_firb_plan/#solution-overview","title":"Solution Overview","text":""},{"location":"plans/retail_airb_corporate_firb_plan/#reclassification-logic","title":"Reclassification Logic","text":"<p>For a corporate exposure to be reclassified to retail (and receive AIRB treatment):</p> Condition Field Check Managed as retail <code>cp_is_managed_as_retail</code> <code>= True</code> Below threshold <code>qualifies_as_retail</code> <code>= True</code> (aggregated &lt; EUR 1m) Has modelled LGD <code>lgd</code> <code>IS NOT NULL</code> <p>If ALL conditions are met \u2192 Reclassify to <code>RETAIL_OTHER</code> \u2192 AIRB treatment</p> <p>If ANY condition fails \u2192 Stays as <code>CORPORATE</code> / <code>CORPORATE_SME</code> \u2192 FIRB treatment</p>"},{"location":"plans/retail_airb_corporate_firb_plan/#expected-outcomes","title":"Expected Outcomes","text":"Scenario Exposure Class Approach LGD Source Corporate, managed as retail, &lt; EUR 1m, has LGD, with property collateral <code>RETAIL_MORTGAGE</code> AIRB Modelled Corporate, managed as retail, &lt; EUR 1m, has LGD, no property collateral <code>RETAIL_OTHER</code> AIRB Modelled Corporate, managed as retail, &lt; EUR 1m, NO LGD <code>CORPORATE</code> FIRB Supervisory Corporate, managed as retail, &gt;= EUR 1m <code>CORPORATE</code> FIRB Supervisory Corporate, NOT managed as retail <code>CORPORATE</code> FIRB Supervisory Retail (individual), &lt; EUR 1m <code>RETAIL_OTHER</code> AIRB Modelled Retail (individual), &gt;= EUR 1m <code>CORPORATE</code> FIRB Supervisory <p>Note: Reclassified corporates are NOT eligible for QRRE, even if the facility is revolving.</p>"},{"location":"plans/retail_airb_corporate_firb_plan/#files-to-modify","title":"Files to Modify","text":"File Changes <code>src/rwa_calc/domain/enums.py</code> Add <code>RETAIL_AIRB_CORPORATE_FIRB</code> to <code>IRBApproachOption</code> <code>src/rwa_calc/contracts/config.py</code> Add <code>IRBPermissions.retail_airb_corporate_firb()</code> factory method <code>src/rwa_calc/engine/classifier.py</code> Add downward reclassification logic in <code>_apply_retail_classification()</code> <code>src/rwa_calc/api/models.py</code> Add <code>\"retail_airb_corporate_firb\"</code> to <code>irb_approach</code> Literal type <code>src/rwa_calc/api/service.py</code> Handle new approach option in <code>_create_config()</code> <code>src/rwa_calc/ui/marimo/rwa_app.py</code> Add new option to IRB approach dropdown <code>tests/unit/test_irb_permissions.py</code> Add tests for new factory method <code>tests/unit/test_classifier.py</code> Add tests for downward reclassification"},{"location":"plans/retail_airb_corporate_firb_plan/#implementation-details","title":"Implementation Details","text":""},{"location":"plans/retail_airb_corporate_firb_plan/#1-add-enum-value-domainenumspy","title":"1. Add Enum Value (<code>domain/enums.py</code>)","text":"<pre><code>class IRBApproachOption(Enum):\n    # ... existing values ...\n    RETAIL_AIRB_CORPORATE_FIRB = \"retail_airb_corporate_firb\"\n</code></pre> <p>Update docstring to document the new option.</p>"},{"location":"plans/retail_airb_corporate_firb_plan/#2-add-factory-method-contractsconfigpy","title":"2. Add Factory Method (<code>contracts/config.py</code>)","text":"<pre><code>@classmethod\ndef retail_airb_corporate_firb(cls) -&gt; IRBPermissions:\n    \"\"\"\n    AIRB for retail, FIRB for corporate.\n\n    Use when firm has:\n    - AIRB approval for retail exposures\n    - FIRB approval for corporate exposures\n    - Ability to reclassify qualifying corporates as regulatory retail\n\n    Corporates can be treated as retail if:\n    - Managed as part of retail pool (is_managed_as_retail=True)\n    - Aggregated exposure &lt; EUR 1m\n    - Has internally modelled LGD\n    \"\"\"\n    return cls(\n        permissions={\n            ExposureClass.CENTRAL_GOVT_CENTRAL_BANK: {ApproachType.SA, ApproachType.FIRB},\n            ExposureClass.INSTITUTION: {ApproachType.SA, ApproachType.FIRB},\n            ExposureClass.CORPORATE: {ApproachType.SA, ApproachType.FIRB},\n            ExposureClass.CORPORATE_SME: {ApproachType.SA, ApproachType.FIRB},\n            ExposureClass.RETAIL_MORTGAGE: {ApproachType.SA, ApproachType.AIRB},\n            ExposureClass.RETAIL_QRRE: {ApproachType.SA, ApproachType.AIRB},\n            ExposureClass.RETAIL_OTHER: {ApproachType.SA, ApproachType.AIRB},\n            ExposureClass.SPECIALISED_LENDING: {ApproachType.SA, ApproachType.SLOTTING, ApproachType.FIRB},\n            ExposureClass.EQUITY: {ApproachType.SA},\n        }\n    )\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#3-add-classifier-logic-engineclassifierpy","title":"3. Add Classifier Logic (<code>engine/classifier.py</code>)","text":""},{"location":"plans/retail_airb_corporate_firb_plan/#3a-add-new-method-_apply_corporate_to_retail_reclassification","title":"3a. Add new method <code>_apply_corporate_to_retail_reclassification()</code>","text":"<p>Insert after <code>_apply_retail_classification()</code> in the pipeline (Step 4a):</p> <pre><code>def _apply_corporate_to_retail_reclassification(\n    self,\n    exposures: pl.LazyFrame,\n    config: CalculationConfig,\n) -&gt; pl.LazyFrame:\n    \"\"\"\n    Reclassify qualifying corporates to retail for AIRB treatment.\n\n    Per CRR Art. 147(5) / Basel CRE30.16-17, corporate exposures can be\n    treated as retail (\"regulatory retail\") if:\n    1. Managed as part of a retail pool (is_managed_as_retail=True)\n    2. Aggregated exposure &lt; EUR 1m (qualifies_as_retail=True)\n    3. Has internally modelled LGD (lgd IS NOT NULL)\n\n    Reclassification target:\n    - With property collateral \u2192 RETAIL_MORTGAGE\n    - Without property collateral \u2192 RETAIL_OTHER\n    - NOT eligible for QRRE (even if revolving facility)\n\n    This enables AIRB treatment for small corporates when the firm has\n    AIRB approval for retail but only FIRB approval for corporates.\n    \"\"\"\n    # Check if this reclassification is relevant\n    # Only applies when AIRB is permitted for retail but not for corporate\n    airb_for_retail = config.irb_permissions.is_permitted(\n        ExposureClass.RETAIL_OTHER, ApproachType.AIRB\n    )\n    airb_for_corporate = config.irb_permissions.is_permitted(\n        ExposureClass.CORPORATE, ApproachType.AIRB\n    )\n\n    # If AIRB is permitted for corporate, no need to reclassify\n    # If AIRB is not permitted for retail, can't reclassify to get AIRB\n    if airb_for_corporate or not airb_for_retail:\n        return exposures\n\n    # Add flag for reclassification eligibility\n    exposures = exposures.with_columns([\n        # Eligible for retail reclassification if ALL conditions met\n        pl.when(\n            (pl.col(\"exposure_class\").is_in([\n                ExposureClass.CORPORATE.value,\n                ExposureClass.CORPORATE_SME.value,\n            ])) &amp;\n            (pl.col(\"cp_is_managed_as_retail\") == True) &amp;\n            (pl.col(\"qualifies_as_retail\") == True) &amp;\n            (pl.col(\"lgd\").is_not_null())\n        ).then(pl.lit(True))\n        .otherwise(pl.lit(False))\n        .alias(\"reclassified_to_retail\"),\n    ])\n\n    # Determine if exposure has property collateral\n    # Check residential_collateral_value (from hierarchy) or collateral_type\n    exposures = exposures.with_columns([\n        pl.when(\n            (pl.col(\"residential_collateral_value\") &gt; 0) |\n            (pl.col(\"collateral_type\").is_in([\"immovable\", \"residential\", \"commercial\"]))\n        ).then(pl.lit(True))\n        .otherwise(pl.lit(False))\n        .alias(\"has_property_collateral\"),\n    ])\n\n    # Reclassify eligible corporates\n    # - With property collateral \u2192 RETAIL_MORTGAGE\n    # - Without property collateral \u2192 RETAIL_OTHER\n    exposures = exposures.with_columns([\n        pl.when(\n            (pl.col(\"reclassified_to_retail\") == True) &amp;\n            (pl.col(\"has_property_collateral\") == True)\n        ).then(pl.lit(ExposureClass.RETAIL_MORTGAGE.value))\n        .when(pl.col(\"reclassified_to_retail\") == True)\n        .then(pl.lit(ExposureClass.RETAIL_OTHER.value))\n        .otherwise(pl.col(\"exposure_class\"))\n        .alias(\"exposure_class\"),\n    ])\n\n    return exposures\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#3b-update-classify-method","title":"3b. Update <code>classify()</code> method","text":"<p>Add Step 4a after Step 4:</p> <pre><code># Step 4: Check and apply retail classification (retail \u2192 corporate if &gt; threshold)\nclassified = self._apply_retail_classification(\n    classified,\n    data.lending_group_totals,\n    config,\n)\n\n# Step 4a: Check and apply corporate \u2192 retail reclassification\n# (for qualifying SME corporates with modelled LGD)\nclassified = self._apply_corporate_to_retail_reclassification(\n    classified,\n    config,\n)\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#3c-update-_add_classification_audit","title":"3c. Update <code>_add_classification_audit()</code>","text":"<p>Add <code>reclassified_to_retail</code> to the audit trail:</p> <pre><code>pl.lit(\"; reclassified_to_retail=\"),\npl.col(\"reclassified_to_retail\").cast(pl.String),\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#3d-update-_build_audit_trail","title":"3d. Update <code>_build_audit_trail()</code>","text":"<p>Add column to audit output:</p> <pre><code>pl.col(\"reclassified_to_retail\"),\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#4-update-api-models-apimodelspy","title":"4. Update API Models (<code>api/models.py</code>)","text":"<p>Update the <code>irb_approach</code> field type:</p> <pre><code>irb_approach: Literal[\n    \"sa_only\", \"firb\", \"airb\", \"full_irb\", \"retail_airb_corporate_firb\"\n] | None = None\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#5-update-service-apiservicepy","title":"5. Update Service (<code>api/service.py</code>)","text":"<p>Add handling in <code>_create_config()</code>:</p> <pre><code>elif request.irb_approach == \"retail_airb_corporate_firb\":\n    irb_permissions = IRBPermissions.retail_airb_corporate_firb()\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#6-update-marimo-ui-uimarimorwa_apppy","title":"6. Update Marimo UI (<code>ui/marimo/rwa_app.py</code>)","text":"<p>Add new option to dropdown:</p> <pre><code>irb_approach_dropdown = mo.ui.dropdown(\n    options={\n        \"SA Only (No IRB)\": \"sa_only\",\n        \"Foundation IRB (F-IRB)\": \"firb\",\n        \"Advanced IRB (A-IRB)\": \"airb\",\n        \"Full IRB (A-IRB preferred)\": \"full_irb\",\n        \"Retail A-IRB / Corporate F-IRB\": \"retail_airb_corporate_firb\",\n    },\n    value=\"SA Only (No IRB)\",\n    label=\"IRB Approach\",\n)\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#test-cases","title":"Test Cases","text":""},{"location":"plans/retail_airb_corporate_firb_plan/#unit-tests-for-irbpermissions","title":"Unit Tests for IRBPermissions","text":"<pre><code>class TestRetailAIRBCorporateFIRBPermissions:\n    \"\"\"Tests for IRBPermissions.retail_airb_corporate_firb().\"\"\"\n\n    def test_airb_permitted_for_retail(self):\n        perms = IRBPermissions.retail_airb_corporate_firb()\n        assert perms.is_permitted(ExposureClass.RETAIL_OTHER, ApproachType.AIRB)\n        assert perms.is_permitted(ExposureClass.RETAIL_MORTGAGE, ApproachType.AIRB)\n        assert perms.is_permitted(ExposureClass.RETAIL_QRRE, ApproachType.AIRB)\n\n    def test_firb_permitted_for_corporate(self):\n        perms = IRBPermissions.retail_airb_corporate_firb()\n        assert perms.is_permitted(ExposureClass.CORPORATE, ApproachType.FIRB)\n        assert perms.is_permitted(ExposureClass.CORPORATE_SME, ApproachType.FIRB)\n\n    def test_airb_not_permitted_for_corporate(self):\n        perms = IRBPermissions.retail_airb_corporate_firb()\n        assert not perms.is_permitted(ExposureClass.CORPORATE, ApproachType.AIRB)\n        assert not perms.is_permitted(ExposureClass.CORPORATE_SME, ApproachType.AIRB)\n\n    def test_firb_not_permitted_for_retail(self):\n        perms = IRBPermissions.retail_airb_corporate_firb()\n        assert not perms.is_permitted(ExposureClass.RETAIL_OTHER, ApproachType.FIRB)\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#unit-tests-for-classifier-reclassification","title":"Unit Tests for Classifier Reclassification","text":"<pre><code>class TestCorporateToRetailReclassification:\n    \"\"\"Tests for corporate \u2192 retail reclassification.\"\"\"\n\n    def test_corporate_with_property_collateral_becomes_retail_mortgage(self):\n        \"\"\"Corporate with property collateral \u2192 RETAIL_MORTGAGE.\"\"\"\n        # Setup: Corporate with managed_as_retail, &lt; EUR 1m, LGD, property collateral\n        # Assert: exposure_class = RETAIL_MORTGAGE\n        # Assert: reclassified_to_retail = True\n        # Assert: approach = AIRB\n\n    def test_corporate_without_property_collateral_becomes_retail_other(self):\n        \"\"\"Corporate without property collateral \u2192 RETAIL_OTHER.\"\"\"\n        # Setup: Corporate with managed_as_retail, &lt; EUR 1m, LGD, no property collateral\n        # Assert: exposure_class = RETAIL_OTHER\n        # Assert: reclassified_to_retail = True\n        # Assert: approach = AIRB\n\n    def test_corporate_not_reclassified_when_not_managed_as_retail(self):\n        \"\"\"Corporate without managed_as_retail flag stays as CORPORATE.\"\"\"\n        # Assert: exposure_class remains CORPORATE\n        # Assert: reclassified_to_retail = False\n        # Assert: approach = FIRB\n\n    def test_corporate_not_reclassified_when_exceeds_threshold(self):\n        \"\"\"Corporate &gt; EUR 1m stays as CORPORATE even if managed as retail.\"\"\"\n        # Assert: exposure_class remains CORPORATE\n        # Assert: approach = FIRB\n\n    def test_corporate_not_reclassified_when_no_lgd(self):\n        \"\"\"Corporate without modelled LGD stays as CORPORATE.\"\"\"\n        # Assert: exposure_class remains CORPORATE\n        # Assert: approach = FIRB (uses supervisory LGD)\n\n    def test_corporate_sme_with_property_becomes_retail_mortgage(self):\n        \"\"\"CORPORATE_SME with property collateral \u2192 RETAIL_MORTGAGE.\"\"\"\n        # Assert: exposure_class = RETAIL_MORTGAGE\n\n    def test_reclassified_corporate_not_eligible_for_qrre(self):\n        \"\"\"Reclassified corporate never becomes QRRE even if revolving.\"\"\"\n        # Setup: Corporate with revolving facility, meeting all reclassification criteria\n        # Assert: exposure_class = RETAIL_OTHER (not QRRE)\n\n    def test_reclassification_only_when_airb_retail_firb_corporate(self):\n        \"\"\"Reclassification only applies with hybrid permissions.\"\"\"\n        # With full_irb: No reclassification needed (AIRB available for corporate)\n        # With firb_only: No reclassification (AIRB not available for retail)\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#integration-test","title":"Integration Test","text":"<pre><code>class TestHybridIRBApproachIntegration:\n    \"\"\"Integration tests for retail AIRB / corporate FIRB scenario.\"\"\"\n\n    def test_mixed_portfolio_correct_approach_assignment(self):\n        \"\"\"\n        Portfolio with:\n        - Corporate &lt; EUR 1m, managed as retail, has LGD, property collateral \u2192 RETAIL_MORTGAGE, AIRB\n        - Corporate &lt; EUR 1m, managed as retail, has LGD, no property collateral \u2192 RETAIL_OTHER, AIRB\n        - Corporate &lt; EUR 1m, managed as retail, NO LGD \u2192 CORPORATE, FIRB\n        - Corporate &gt;= EUR 1m, managed as retail \u2192 CORPORATE, FIRB\n        - Corporate, NOT managed as retail \u2192 CORPORATE, FIRB\n        - Retail individual &lt; EUR 1m \u2192 RETAIL_OTHER, AIRB\n        \"\"\"\n        pass\n</code></pre>"},{"location":"plans/retail_airb_corporate_firb_plan/#implementation-sequence","title":"Implementation Sequence","text":"<ol> <li>Add <code>RETAIL_AIRB_CORPORATE_FIRB</code> to <code>IRBApproachOption</code> enum</li> <li>Add <code>retail_airb_corporate_firb()</code> factory method to <code>IRBPermissions</code></li> <li>Update <code>contracts/__init__.py</code> exports (if needed)</li> <li>Add <code>_apply_corporate_to_retail_reclassification()</code> method to classifier</li> <li>Update <code>classify()</code> to call new method</li> <li>Update classification audit trail</li> <li>Update <code>irb_approach</code> Literal type in <code>api/models.py</code></li> <li>Update <code>_create_config()</code> in <code>api/service.py</code></li> <li>Update Marimo UI dropdown</li> <li>Add unit tests for permissions</li> <li>Add unit tests for classifier reclassification</li> <li>Run full test suite to verify no regressions</li> </ol>"},{"location":"plans/retail_airb_corporate_firb_plan/#verification","title":"Verification","text":""},{"location":"plans/retail_airb_corporate_firb_plan/#manual-testing","title":"Manual Testing","text":"<ol> <li>Run Marimo app: <code>uv run marimo run src/rwa_calc/ui/marimo/rwa_app.py</code></li> <li>Select \"Retail A-IRB / Corporate F-IRB\" from dropdown</li> <li>Run calculation on test data with:</li> <li>Corporate exposures with <code>is_managed_as_retail=True</code>, &lt; EUR 1m, with LGD</li> <li>Corporate exposures with <code>is_managed_as_retail=True</code>, &lt; EUR 1m, without LGD</li> <li>Verify:</li> <li>First group: <code>exposure_class=retail_other</code>, <code>approach=advanced_irb</code></li> <li>Second group: <code>exposure_class=corporate</code>, <code>approach=foundation_irb</code></li> </ol>"},{"location":"plans/retail_airb_corporate_firb_plan/#columns-to-check-in-results","title":"Columns to Check in Results","text":"Column Reclassified (with property) Reclassified (no property) Not reclassified <code>exposure_class</code> <code>retail_mortgage</code> <code>retail_other</code> <code>corporate</code> / <code>corporate_sme</code> <code>approach</code> <code>advanced_irb</code> <code>advanced_irb</code> <code>foundation_irb</code> <code>reclassified_to_retail</code> <code>True</code> <code>True</code> <code>False</code> <code>has_property_collateral</code> <code>True</code> <code>False</code> N/A <code>lgd_type</code> <code>modelled</code> <code>modelled</code> <code>supervisory</code>"},{"location":"plans/retail_airb_corporate_firb_plan/#regulatory-references","title":"Regulatory References","text":"<ul> <li>CRR Art. 147(5): Exposures to small businesses may be treated as retail if aggregated exposure &lt; EUR 1m</li> <li>CRR Art. 123: Retail exposure criteria including EUR 1m threshold</li> <li>Basel CRE30.16-17: Retail exposure definition and eligibility criteria</li> <li>CRR Art. 163: A-IRB requires internal LGD estimates</li> <li>CRR Art. 161: F-IRB uses supervisory LGD values</li> </ul>"},{"location":"plans/retail_airb_corporate_firb_plan/#design-decisions-confirmed","title":"Design Decisions (Confirmed)","text":"<ol> <li> <p>QRRE eligibility: Reclassified corporates are NOT eligible for QRRE classification, even if the facility is revolving.</p> </li> <li> <p>Property collateral treatment: If the reclassified corporate exposure is secured by property collateral, classify as <code>RETAIL_MORTGAGE</code> (not <code>RETAIL_OTHER</code>).</p> </li> <li> <p>Audit trail: No need to track original exposure class. The <code>reclassified_to_retail</code> flag is sufficient.</p> </li> </ol>"},{"location":"plans/roadmap/","title":"Development Roadmap","text":"<p>This page tracks the development status and progress of the RWA Calculator across all implementation phases.</p>"},{"location":"plans/roadmap/#phase-overview","title":"Phase Overview","text":"Phase Description Status Phase 1 Test Infrastructure Complete Phase 2 Process Contracts Complete Phase 3 Implementation Complete Phase 4 Acceptance Testing Complete"},{"location":"plans/roadmap/#phase-1-test-infrastructure","title":"Phase 1: Test Infrastructure","text":"Component Status Details Test Data Fixtures Complete 15 fixture types covering all counterparty, exposure, CRM, and mapping scenarios CRR Expected Outputs Complete 45 scenarios across 8 groups (SA, F-IRB, A-IRB, CRM, Slotting, Supporting Factors, Provisions, Complex) CRR Acceptance Tests Complete 65 tests (62 pass, 3 skip) Basel 3.1 Expected Outputs Not Started Planned for Phase 1.2B"},{"location":"plans/roadmap/#phase-2-process-contracts","title":"Phase 2: Process Contracts","text":"<p>Interfaces and contracts between RWA calculator components have been implemented:</p> Component Location Tests Domain Enums <code>src/rwa_calc/domain/enums.py</code> - Error Contracts <code>src/rwa_calc/contracts/errors.py</code> 20 Configuration <code>src/rwa_calc/contracts/config.py</code> 20 Data Bundles <code>src/rwa_calc/contracts/bundles.py</code> 24 Protocols <code>src/rwa_calc/contracts/protocols.py</code> 14 Validation <code>src/rwa_calc/contracts/validation.py</code> 19 Total 6 modules 97 tests"},{"location":"plans/roadmap/#key-features","title":"Key Features","text":"<ul> <li><code>CalculationConfig.crr()</code> and <code>.basel_3_1()</code> factory methods for framework-specific configuration</li> <li>Protocol-based interfaces (<code>LoaderProtocol</code>, <code>ClassifierProtocol</code>, etc.) for dependency injection</li> <li><code>LazyFrameResult</code> for error accumulation without exceptions</li> <li>Intermediate pipeline schemas for data validation at component boundaries</li> </ul>"},{"location":"plans/roadmap/#phase-3-implementation","title":"Phase 3: Implementation","text":"Component Location CRR Status Basel 3.1 Status Tests Domain enums <code>domain/enums.py</code> Complete Complete - Risk weight tables <code>data/tables/crr_risk_weights.py</code> Complete Planned - CCF tables <code>engine/ccf.py</code> Complete Complete 47 Data Loader <code>engine/loader.py</code> Complete Complete 31 Hierarchy Resolver <code>engine/hierarchy.py</code> Complete Complete 66 Exposure Classifier <code>engine/classifier.py</code> Complete Complete 24 CRM Processor <code>engine/crm/processor.py</code> Complete Complete - Haircut Calculator <code>engine/crm/haircuts.py</code> Complete Complete - SA Calculator <code>engine/sa/calculator.py</code> Complete Complete - IRB Calculator <code>engine/irb/calculator.py</code> Complete Complete - Slotting Calculator <code>engine/slotting/calculator.py</code> Complete Complete - Equity Calculator <code>engine/equity/calculator.py</code> Complete N/A - Supporting Factors <code>engine/sa/supporting_factors.py</code> Complete N/A - FX Converter <code>engine/fx_converter.py</code> Complete Complete 14 Input Validation <code>contracts/validation.py</code> Complete Complete - Output Aggregator <code>engine/aggregator.py</code> Complete Complete 21 Output floor <code>engine/aggregator.py</code> N/A Complete - Pipeline Orchestrator <code>engine/pipeline.py</code> Complete Complete 30"},{"location":"plans/roadmap/#key-implementation-features","title":"Key Implementation Features","text":"<ul> <li>Pure LazyFrame Operations: Hierarchy resolution uses iterative Polars joins instead of Python dicts for 50-100x performance improvement</li> <li>Multi-Level Facility Hierarchy: Facility root lookup traverses facility-to-facility hierarchies (up to 10 levels), aggregates drawn amounts to root, and excludes sub-facilities from undrawn output</li> <li>Cross-Approach CCF Substitution: When an IRB exposure is guaranteed by an SA counterparty, the guaranteed portion uses SA CCFs (CRR Art. 166/194)</li> <li>Overcollateralisation: CRR Art. 230 / CRE32.9-12 ratios (1.0x financial, 1.25x receivables, 1.4x RE/physical) with minimum thresholds</li> <li>Equity Calculator: Article 133 (SA) and Article 155 (IRB Simple) risk weight methods with diversified portfolio treatment</li> <li>Pre/Post CRM Tracking: Full tracking of guarantee impact on RWA with covered/uncovered portions</li> <li>Output Floor: Full Basel 3.1 output floor with transitional schedule support (50% to 72.5%, 2027-2032)</li> <li>Supporting Factors: CRR SME tiered factor (0.7619/0.85) and infrastructure factor (0.75)</li> <li>Input Value Validation: <code>validate_bundle_values()</code> with <code>DQ006</code> error code for invalid categorical values</li> <li>Retail A-IRB / Corporate F-IRB: Hybrid IRB permissions with corporate-to-retail reclassification for qualifying exposures</li> <li>FX Conversion: Multi-currency portfolio support with configurable target currency and full audit trail</li> <li>Pipeline Orchestrator: Complete pipeline wiring with error accumulation and audit trail</li> <li>8 Polars Namespace Extensions: Fluent, chainable APIs for SA, IRB, CRM, Haircuts, Slotting, Hierarchy, Aggregator, and Audit</li> </ul>"},{"location":"plans/roadmap/#phase-4-acceptance-testing","title":"Phase 4: Acceptance Testing","text":"<p>CRR acceptance tests validate production pipeline outputs against expected values:</p> Group Description Scenarios Status CRR-A Standardised Approach 12 10 PASS, 2 SKIP CRR-B Foundation IRB 7 7 PASS CRR-C Advanced IRB 3 2 PASS, 1 SKIP CRR-D Credit Risk Mitigation 6 6 PASS CRR-E Specialised Lending (Slotting) 4 4 PASS CRR-F Supporting Factors 7 7 PASS CRR-G Provisions &amp; Impairments 3 3 PASS CRR-H Complex/Combined 4 4 PASS Total 65 62 PASS, 3 SKIP"},{"location":"plans/roadmap/#remaining-skipped-tests","title":"Remaining Skipped Tests","text":"Test Reason CRR-A7 Commercial RE low LTV \u2014 fixture data needed CRR-A8 Off-balance sheet commitment CCF \u2014 fixture data needed CRR-C3 Specialised lending A-IRB \u2014 fixture data needed"},{"location":"plans/roadmap/#key-achievements","title":"Key Achievements","text":"<ul> <li>Pipeline-based testing using session-scoped fixtures</li> <li>Scenario-to-exposure reference mapping for all scenarios</li> <li>95% acceptance test pass rate (62/65)</li> <li>All major calculation approaches validated end-to-end (SA, F-IRB, A-IRB, CRM, Slotting, Supporting Factors, Provisions)</li> </ul>"},{"location":"plans/roadmap/#crr-workbook-components","title":"CRR Workbook Components","text":"<p>Reference implementations for expected output generation:</p> Component Location Status CRR Parameters <code>workbooks/crr_expected_outputs/data/crr_params.py</code> Complete SA Risk Weights <code>workbooks/crr_expected_outputs/calculations/crr_risk_weights.py</code> Complete CCF Tables <code>workbooks/crr_expected_outputs/calculations/crr_ccf.py</code> Complete Supporting Factors <code>workbooks/crr_expected_outputs/calculations/crr_supporting_factors.py</code> Complete CRM Haircuts <code>workbooks/crr_expected_outputs/calculations/crr_haircuts.py</code> Complete IRB Formulas <code>workbooks/shared/irb_formulas.py</code> Complete Correlation <code>workbooks/shared/correlation.py</code> Complete All Scenario Groups <code>workbooks/crr_expected_outputs/scenarios/</code> Complete"},{"location":"plans/roadmap/#test-results-summary","title":"Test Results Summary","text":"<p>Total: 1,152 tests (925 unit + 65 acceptance + benchmark)</p> Category Tests Status Unit tests 925 All passing Acceptance tests 65 62 pass, 3 skip Benchmark tests ~162 Import fix needed <p>Run all tests: <pre><code>uv run pytest -v\n</code></pre></p>"},{"location":"plans/roadmap/#recent-completions","title":"Recent Completions","text":""},{"location":"plans/roadmap/#v0118","title":"v0.1.18","text":"<ul> <li>[x] Facility Root Lookup: Multi-level facility hierarchy traversal (up to 10 levels)</li> <li>[x] Undrawn Aggregation: Drawn amounts from sub-facility loans aggregated to root facility</li> <li>[x] Sub-Facility Exclusion: Only root/standalone facilities produce undrawn exposure records</li> <li>[x] Contingent Liabilities: Included in facility undrawn calculations</li> </ul>"},{"location":"plans/roadmap/#v0117","title":"v0.1.17","text":"<ul> <li>[x] Negative Drawn Amounts: Clamped to zero in EAD calculations (negative balances don't increase headroom)</li> <li>[x] Duplicate Mapping Fix: Resolved duplicate mapping issues in facility calculations</li> </ul>"},{"location":"plans/roadmap/#v0116","title":"v0.1.16","text":"<ul> <li>[x] Cross-Approach CCF Substitution: SA CCFs applied to guaranteed portion of IRB exposures</li> <li>[x] Guarantor Approach Detection: Based on IRB permissions, exposure class, and rating type</li> <li>[x] Aggregator Enhancements: Updated summaries for post-CRM reporting</li> </ul>"},{"location":"plans/roadmap/#v0115","title":"v0.1.15","text":"<ul> <li>[x] Exposure Class Rename: Sovereign \u2192 Central Govt / Central Bank for regulatory accuracy</li> <li>[x] CI/CD: GitHub Actions workflow for documentation deployment</li> </ul>"},{"location":"plans/roadmap/#v0114","title":"v0.1.14","text":"<ul> <li>[x] Overcollateralisation: CRR Art. 230 / CRE32.9-12 overcollateralisation ratios and minimum thresholds</li> <li>[x] Collateral standardization: Consistent <code>collateral_type</code> casing and descriptions</li> </ul>"},{"location":"plans/roadmap/#v0113","title":"v0.1.13","text":"<ul> <li>[x] Input Value Validation: <code>validate_bundle_values()</code> with error code DQ006</li> <li>[x] Row Duplication Fix: Prevented duplicate exposures when <code>facility_reference = loan_reference</code> (#71)</li> </ul>"},{"location":"plans/roadmap/#v0112","title":"v0.1.12","text":"<ul> <li>[x] Equity Calculator: Article 133 (SA) and Article 155 (IRB Simple) risk weight methods</li> <li>[x] Equity Namespace: Polars LazyFrame namespace (<code>lf.equity</code>) for fluent calculations</li> <li>[x] Pre/Post CRM Tracking: Guarantee impact tracking with <code>rwa_pre_crm</code>, <code>rwa_post_crm</code>, <code>guarantee_rwa_benefit</code></li> <li>[x] Equity Risk Weight Tables: <code>crr_equity_rw.py</code> with SA and IRB Simple lookups</li> </ul>"},{"location":"plans/roadmap/#upcoming-work","title":"Upcoming Work","text":""},{"location":"plans/roadmap/#basel-31-implementation","title":"Basel 3.1 Implementation","text":"<ul> <li>[ ] Basel 3.1 expected outputs</li> <li>[ ] Basel 3.1 acceptance tests</li> <li>[ ] Updated risk weight tables (LTV-based real estate)</li> <li>[ ] Differentiated PD floors</li> <li>[ ] A-IRB LGD floors</li> <li>[ ] Output floor phase-in validation</li> </ul>"},{"location":"plans/roadmap/#remaining-fixture-completion","title":"Remaining Fixture Completion","text":"<ul> <li>[ ] Commercial RE low LTV fixture data (CRR-A7)</li> <li>[ ] Off-balance sheet commitment CCF fixture data (CRR-A8)</li> <li>[ ] Specialised lending A-IRB fixture data (CRR-C3)</li> </ul>"},{"location":"plans/roadmap/#next-steps","title":"Next Steps","text":"<ul> <li>Testing Guide - How to run tests</li> <li>Benchmark Tests - Performance testing</li> <li>Architecture - System design</li> </ul>"},{"location":"specifications/","title":"RWA Calculator Specifications","text":"<p>This section contains the formal specifications for the RWA Calculator. These specifications serve as:</p> <ol> <li>Living documentation - Human-readable descriptions of business rules and regulatory treatments</li> <li>Acceptance criteria - Clear definition of expected behaviour for each scenario</li> <li>Traceability - Each scenario maps to acceptance tests via scenario IDs</li> </ol>"},{"location":"specifications/#specification-index","title":"Specification Index","text":""},{"location":"specifications/#crr-framework-current-until-december-2026","title":"CRR Framework (Current - Until December 2026)","text":"Specification Description Regulatory Reference SA Risk Weights Standardised Approach risk weights by exposure class and CQS CRR Art. 112-134 Supporting Factors SME (0.7619) and infrastructure (0.75) factors CRR Art. 501, 501a F-IRB Calculation Foundation IRB with supervisory LGD CRR Art. 153-154, 161-163 A-IRB Calculation Advanced IRB with internal estimates CRR Art. 153-154 Credit Conversion Factors CCF for off-balance sheet items CRR Art. 111, 166 Credit Risk Mitigation Collateral haircuts, guarantees, and overcollateralisation CRR Art. 192-241 Slotting Approach Specialised lending categories CRR Art. 147(8), 153(5) Provisions Provision treatment and EL comparison CRR Art. 158-159"},{"location":"specifications/#basel-31-framework-from-january-2027","title":"Basel 3.1 Framework (From January 2027)","text":"Specification Description Regulatory Reference Framework Differences Key changes from CRR including output floor, PD/LGD floors PRA PS9/24"},{"location":"specifications/#common-framework-agnostic","title":"Common (Framework-Agnostic)","text":"Specification Description Hierarchy &amp; Classification Counterparty hierarchy resolution and exposure classification"},{"location":"specifications/#scenario-coverage-by-test-group","title":"Scenario Coverage by Test Group","text":""},{"location":"specifications/#group-a-standardised-approach","title":"Group A: Standardised Approach","text":"<p>Covers risk weight determination for all SA exposure classes:</p> <ul> <li>Sovereigns (CQS 1-6 and unrated)</li> <li>Institutions (including UK 30% CQS 2 deviation)</li> <li>Corporates (rated and unrated)</li> <li>Retail (fixed 75%)</li> <li>Residential mortgages (LTV-based split at 80%)</li> <li>Commercial real estate (LTV-based with income cover test)</li> </ul>"},{"location":"specifications/#group-b-foundation-irb","title":"Group B: Foundation IRB","text":"<p>Covers F-IRB calculation components:</p> <ul> <li>PD floor (0.03%)</li> <li>Supervisory LGD (45% senior, 75% subordinated)</li> <li>Corporate correlation formula with PD-dependent decay</li> <li>SME firm-size correlation adjustment</li> <li>Maturity adjustment</li> <li>Expected loss calculation</li> <li>1.06 scaling factor</li> </ul>"},{"location":"specifications/#group-c-advanced-irb","title":"Group C: Advanced IRB","text":"<p>Covers A-IRB with internal estimates:</p> <ul> <li>Internal LGD application</li> <li>Internal CCF application</li> <li>FI scalar (1.25x) for large financial institutions</li> </ul>"},{"location":"specifications/#group-d-credit-risk-mitigation","title":"Group D: Credit Risk Mitigation","text":"<p>Covers CRM techniques:</p> <ul> <li>Financial collateral haircuts (CRR Art. 224)</li> <li>FX mismatch haircut (8%)</li> <li>Overcollateralisation requirements (CRR Art. 230)</li> <li>Guarantee substitution (CRR Art. 213-217)</li> <li>Multi-level collateral allocation (exposure, facility, counterparty)</li> <li>Maturity mismatch adjustment (CRR Art. 238)</li> </ul>"},{"location":"specifications/#group-e-slotting","title":"Group E: Slotting","text":"<p>Covers specialised lending:</p> <ul> <li>Slotting categories (Strong to Default)</li> <li>HVCRE elevated risk weights</li> <li>Project/Object/Commodities/IPRE finance types</li> </ul>"},{"location":"specifications/#group-f-supporting-factors","title":"Group F: Supporting Factors","text":"<p>Covers CRR-specific factors:</p> <ul> <li>SME supporting factor (tiered: 0.7619 / 0.85)</li> <li>Infrastructure supporting factor (0.75)</li> </ul>"},{"location":"specifications/#group-g-provisions","title":"Group G: Provisions","text":"<p>Covers provision treatment:</p> <ul> <li>SA provision deduction from exposure</li> <li>IRB expected loss comparison</li> </ul>"},{"location":"specifications/#group-h-basel-31-differences","title":"Group H: Basel 3.1 Differences","text":"<p>Covers framework changes:</p> <ul> <li>Removal of supporting factors</li> <li>Removal of 1.06 scaling factor</li> <li>Output floor (72.5% of SA)</li> <li>Differentiated PD floors</li> <li>LGD floors for A-IRB</li> <li>Revised slotting risk weights</li> </ul>"},{"location":"specifications/#scenario-id-convention","title":"Scenario ID Convention","text":"<p>Each scenario is tagged with an identifier for traceability:</p> Prefix Description <code>CRR-A</code> CRR Standardised Approach <code>CRR-B</code> CRR Foundation IRB <code>CRR-C</code> CRR Advanced IRB <code>CRR-D</code> CRR Credit Risk Mitigation <code>CRR-E</code> CRR Slotting Approach <code>CRR-F</code> CRR Supporting Factors <code>CRR-G</code> CRR Provisions <code>BASEL31-F</code> Basel 3.1 Framework Differences <code>HIER-</code> Hierarchy scenarios <code>CLASS-</code> Classification scenarios"},{"location":"specifications/#for-developers","title":"For Developers","text":"<p>These specifications are verified through acceptance tests in <code>tests/acceptance/</code>. See the Testing Guide for details on running tests.</p>"},{"location":"specifications/basel31/framework-differences/","title":"Basel 3.1 Framework Differences","text":"<p>Key differences from CRR including output floor, PD/LGD floors, and removal of supporting factors.</p> <p>Regulatory Reference: PRA PS9/24</p>"},{"location":"specifications/basel31/framework-differences/#overview","title":"Overview","text":"<p>Basel 3.1 (effective 1 January 2027 in the UK) introduces significant changes to the credit risk framework. The calculator supports both regimes via a configuration toggle.</p>"},{"location":"specifications/basel31/framework-differences/#key-differences","title":"Key Differences","text":"Parameter CRR (Current) Basel 3.1 Reference RWA Scaling Factor 1.06 Removed \u2014 SME Supporting Factor 0.7619 / 0.85 Removed CRR Art. 501 Infrastructure Factor 0.75 Removed CRR Art. 501a Output Floor None 72.5% of SA PRA PS9/24 PD Floor 0.03% (all classes) Differentiated CRE30.55 A-IRB LGD Floors None Yes (by collateral type) CRE30.41 Slotting Risk Weights Non-differentiated HVCRE differentiated PRA PS9/24"},{"location":"specifications/basel31/framework-differences/#differentiated-pd-floors-basel-31","title":"Differentiated PD Floors (Basel 3.1)","text":"Exposure Class PD Floor Corporate 0.05% Corporate SME 0.05% Retail Mortgage 0.05% Retail Other 0.05% QRRE (Transactors) 0.03% QRRE (Revolvers) 0.10%"},{"location":"specifications/basel31/framework-differences/#a-irb-lgd-floors-basel-31","title":"A-IRB LGD Floors (Basel 3.1)","text":"Collateral Type LGD Floor Unsecured 25% Financial collateral 0% Receivables 10% Commercial real estate 10% Residential real estate 5% Other physical 15%"},{"location":"specifications/basel31/framework-differences/#output-floor","title":"Output Floor","text":"<p>The output floor ensures IRB RWA cannot fall below a percentage of what the SA would produce:</p> <pre><code>RWA_final = max(RWA_IRB, floor_percentage x RWA_SA)\n</code></pre>"},{"location":"specifications/basel31/framework-differences/#transitional-schedule","title":"Transitional Schedule","text":"Year Floor Percentage 2027 50.0% 2028 55.0% 2029 60.0% 2030 65.0% 2031 70.0% 2032+ 72.5%"},{"location":"specifications/basel31/framework-differences/#slotting-risk-weights-basel-31","title":"Slotting Risk Weights (Basel 3.1)","text":"<p>HVCRE exposures receive elevated risk weights under Basel 3.1:</p> Category Non-HVCRE HVCRE Strong 50% 100% Good 70% 70% Satisfactory 100% 150% Weak 150% 150% Default 350% 350% <p>Compare with CRR slotting weights in the Slotting Approach specification.</p>"},{"location":"specifications/basel31/framework-differences/#configuration","title":"Configuration","text":"<p>Switch between frameworks using the configuration factory:</p> <pre><code>from rwa_calc.contracts.config import CalculationConfig\n\n# CRR (current)\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Basel 3.1\nconfig = CalculationConfig.basel_3_1(reporting_date=date(2027, 1, 1))\n</code></pre>"},{"location":"specifications/common/hierarchy-classification/","title":"Hierarchy &amp; Classification Specification","text":"<p>Counterparty hierarchy resolution, rating inheritance, and exposure class determination.</p>"},{"location":"specifications/common/hierarchy-classification/#counterparty-hierarchy","title":"Counterparty Hierarchy","text":""},{"location":"specifications/common/hierarchy-classification/#organisation-mappings","title":"Organisation Mappings","text":"<p>The calculator resolves parent-child relationships between counterparties using <code>org_mappings</code>:</p> <ul> <li>Child counterparties inherit ratings from their parent when they lack their own</li> <li>The hierarchy is traversed upward until a rated entity is found</li> </ul>"},{"location":"specifications/common/hierarchy-classification/#lending-group-aggregation","title":"Lending Group Aggregation","text":"<p>Lending groups aggregate exposure across related counterparties for threshold calculations (e.g., SME turnover, retail exposure limits).</p> <ul> <li>Members are defined via <code>lending_mappings</code></li> <li>The parent counterparty is automatically included as a member</li> <li>Duplicate membership is resolved (a counterparty appearing in multiple groups keeps only the first assignment)</li> <li>Residential property exposures are excluded from retail aggregation per CRR Art. 123(c)</li> </ul>"},{"location":"specifications/common/hierarchy-classification/#facility-to-exposure-mapping","title":"Facility-to-Exposure Mapping","text":"<p>The <code>facility_mappings</code> table links facilities to their underlying exposures (loans and contingents):</p> <ul> <li>Facility undrawn amount = <code>max(facility_limit - sum(drawn_amounts), 0)</code></li> <li>Supports multiple exposure types under a single facility</li> <li>Pro-rata allocation of facility-level attributes</li> </ul>"},{"location":"specifications/common/hierarchy-classification/#multi-level-facility-hierarchies","title":"Multi-Level Facility Hierarchies","text":"<p>Facilities can form their own hierarchies (e.g., a master facility with sub-facilities beneath it). The resolver handles this via facility root lookup \u2014 an iterative traversal that mirrors the counterparty hierarchy pattern:</p> <ul> <li>Facility-to-facility edges are identified from <code>facility_mappings</code> where <code>child_type = \"facility\"</code></li> <li>The hierarchy is traversed upward (up to 10 levels) to find the root facility for each sub-facility</li> <li>Output columns: <code>child_facility_reference</code>, <code>root_facility_reference</code>, <code>facility_hierarchy_depth</code></li> </ul>"},{"location":"specifications/common/hierarchy-classification/#undrawn-amount-aggregation","title":"Undrawn Amount Aggregation","text":"<p>For multi-level facility hierarchies, drawn amounts from loans under sub-facilities are aggregated up to the root facility:</p> <pre><code>Root Facility (limit = 1,000,000)\n\u251c\u2500\u2500 Sub-Facility A\n\u2502   \u251c\u2500\u2500 Loan 1 (drawn = 200,000)\n\u2502   \u2514\u2500\u2500 Loan 2 (drawn = 100,000)\n\u2514\u2500\u2500 Sub-Facility B\n    \u2514\u2500\u2500 Loan 3 (drawn = 150,000)\n\nRoot undrawn = 1,000,000 - (200,000 + 100,000 + 150,000) = 550,000\n</code></pre> <p>Key rules:</p> <ul> <li>Root/standalone facilities produce undrawn exposure records</li> <li>Sub-facilities are excluded from producing their own undrawn records (avoids double-counting)</li> <li>Negative drawn amounts are clamped to zero before aggregation (negative balances do not increase headroom)</li> <li>Only facilities with <code>undrawn_amount &gt; 0</code> generate exposure records</li> </ul>"},{"location":"specifications/common/hierarchy-classification/#type-column-handling","title":"Type Column Handling","text":"<p>The <code>facility_mappings</code> table may use different column names for the child type discriminator:</p> Column Present Behaviour <code>child_type</code> Used to filter loan vs facility children (preferred) <code>node_type</code> Fallback \u2014 same filtering logic Neither No facility hierarchy traversal; all mappings treated as loan mappings"},{"location":"specifications/common/hierarchy-classification/#exposure-classification","title":"Exposure Classification","text":""},{"location":"specifications/common/hierarchy-classification/#entity-type-to-exposure-class","title":"Entity Type to Exposure Class","text":"<p>Counterparty entity type determines the base SA exposure class:</p> Entity Type Exposure Class CENTRAL_GOVERNMENT CENTRAL_GOVT_CENTRAL_BANK REGIONAL_GOVERNMENT CENTRAL_GOVT_CENTRAL_BANK PUBLIC_SECTOR_ENTITY CENTRAL_GOVT_CENTRAL_BANK MULTILATERAL_DEVELOPMENT_BANK CENTRAL_GOVT_CENTRAL_BANK INTERNATIONAL_ORGANISATION CENTRAL_GOVT_CENTRAL_BANK CREDIT_INSTITUTION INSTITUTION INVESTMENT_FIRM INSTITUTION CORPORATE CORPORATE INDIVIDUAL Retail (if qualifying)"},{"location":"specifications/common/hierarchy-classification/#sme-detection","title":"SME Detection","text":"<p>Corporate counterparties are reclassified as CORPORATE_SME when:</p> <ul> <li>Group turnover &lt; EUR 50m (GBP converted to EUR at configured rate)</li> </ul>"},{"location":"specifications/common/hierarchy-classification/#retail-qualification","title":"Retail Qualification","text":"<p>Individual counterparties qualify for retail treatment when:</p> <ul> <li>CRR: Aggregate exposure &lt; EUR 1m (approx. GBP 880k at default rate)</li> <li>Basel 3.1: Aggregate exposure &lt; GBP 880k</li> <li>QRRE limit: Individual exposure \u2264 EUR 100k / GBP 100k</li> </ul> <p>If retail thresholds are breached, the exposure is reclassified as CORPORATE.</p>"},{"location":"specifications/common/hierarchy-classification/#defaulted-exposures","title":"Defaulted Exposures","text":"<p>Exposures flagged with a default status are identified and tracked throughout the calculation. Defaulted status affects risk weighting (e.g., 150% SA risk weight for defaulted unsecured).</p>"},{"location":"specifications/common/hierarchy-classification/#approach-assignment","title":"Approach Assignment","text":""},{"location":"specifications/common/hierarchy-classification/#dual-approach-split","title":"Dual-Approach Split","text":"<p>Based on IRB permissions in the configuration, exposures are routed to:</p> <ol> <li>SA - Standardised Approach</li> <li>IRB - Foundation IRB or Advanced IRB</li> <li>Slotting - Specialised lending categories</li> <li>Equity - Equity exposures (pass-through, no CRM applied)</li> </ol>"},{"location":"specifications/common/hierarchy-classification/#fx-conversion","title":"FX Conversion","text":"<p>All monetary values are converted to the base currency (GBP) using provided FX rates before calculation.</p>"},{"location":"specifications/crr/airb-calculation/","title":"Advanced IRB Specification","text":"<p>Advanced IRB calculation with internal LGD and CCF estimates.</p> <p>Regulatory Reference: CRR Articles 153-154</p> <p>Test Group: CRR-C</p>"},{"location":"specifications/crr/airb-calculation/#overview","title":"Overview","text":"<p>A-IRB uses the same capital requirement formula and correlation functions as F-IRB, but the bank provides its own estimates for LGD and (optionally) maturity and CCF, rather than using supervisory values.</p>"},{"location":"specifications/crr/airb-calculation/#key-differences-from-f-irb","title":"Key Differences from F-IRB","text":"Parameter F-IRB A-IRB (CRR) A-IRB (Basel 3.1) PD Bank estimate (floored) Bank estimate (floored) Bank estimate (floored) LGD Supervisory Bank estimate, no floor Bank estimate, with floors CCF Supervisory Bank estimate Bank estimate Maturity Supervisory (2.5y default) Bank estimate (clamped 1-5y) Bank estimate (clamped 1-5y)"},{"location":"specifications/crr/airb-calculation/#lgd-floors-basel-31-only","title":"LGD Floors (Basel 3.1 Only)","text":"<p>Under CRR, A-IRB has no LGD floors. Under Basel 3.1, the following floors apply:</p> Collateral Type LGD Floor Unsecured 25% Financial collateral 0% Receivables 10% Commercial real estate 10% Residential real estate 5% Other physical 15%"},{"location":"specifications/crr/airb-calculation/#fi-scalar","title":"FI Scalar","text":"<p>The 1.25x capital multiplier for large/unregulated financial sector entities applies equally to A-IRB and F-IRB (Art. 153(2)).</p>"},{"location":"specifications/crr/airb-calculation/#calculation","title":"Calculation","text":"<p>The capital requirement formula, correlation functions, maturity adjustment, and RWA computation are identical to F-IRB. See F-IRB Specification for full details.</p>"},{"location":"specifications/crr/airb-calculation/#key-scenarios","title":"Key Scenarios","text":"Scenario ID Description CRR-C A-IRB with internal LGD CRR-C A-IRB with internal CCF CRR-C FI scalar (1.25x) for large financial institution CRR-C A-IRB vs F-IRB comparison (same exposure, different LGD)"},{"location":"specifications/crr/credit-conversion-factors/","title":"Credit Conversion Factors Specification","text":"<p>CCF application for off-balance sheet exposures under SA and F-IRB.</p> <p>Regulatory Reference: CRR Articles 111, 166</p> <p>Test Group: CRR-D (partial)</p>"},{"location":"specifications/crr/credit-conversion-factors/#sa-approach-crr-art-111","title":"SA Approach (CRR Art. 111)","text":"CCF Category CCF Description Full Risk (FR) 100% Direct credit substitutes, guarantees Medium Risk (MR) 50% Undrawn commitments &gt; 1 year Medium-Low Risk (MLR) 20% Undrawn commitments \u2264 1 year, trade-related LCs Low Risk (LR) 0% Unconditionally cancellable commitments"},{"location":"specifications/crr/credit-conversion-factors/#f-irb-approach-crr-art-1668-9","title":"F-IRB Approach (CRR Art. 166(8)-(9))","text":"CCF Category CCF Notes Full Risk (FR) 100% Same as SA Medium Risk (MR) 75% Higher than SA 50% Medium-Low Risk (MLR) 75% Higher than SA 20% (general case) MLR (trade LCs) 20% Short-term trade LCs for goods movement (Art. 166(9) exception) Low Risk (LR) 0% Same as SA"},{"location":"specifications/crr/credit-conversion-factors/#a-irb-approach","title":"A-IRB Approach","text":"<ul> <li>Uses modelled CCF if provided by the bank</li> <li>Falls back to SA CCFs if not available</li> </ul>"},{"location":"specifications/crr/credit-conversion-factors/#ead-calculation","title":"EAD Calculation","text":"<pre><code>EAD = Drawn Amount + Accrued Interest + (Undrawn Amount x CCF)\n</code></pre> <p>Where:</p> <ul> <li>Drawn Amount: Current outstanding balance</li> <li>Accrued Interest: Interest due but not yet paid</li> <li>Undrawn Amount: Committed but undrawn facility limit minus drawn amount</li> </ul>"},{"location":"specifications/crr/credit-conversion-factors/#key-scenarios","title":"Key Scenarios","text":"Scenario ID Description CRR-D Full risk CCF (100%) on guarantee CRR-D Medium risk undrawn commitment (50% SA, 75% F-IRB) CRR-D Trade LC at 20% under F-IRB exception CRR-D Unconditionally cancellable (0%)"},{"location":"specifications/crr/credit-risk-mitigation/","title":"Credit Risk Mitigation Specification","text":"<p>Collateral haircuts, overcollateralisation, FX mismatch, maturity mismatch, and guarantee substitution.</p> <p>Regulatory Reference: CRR Articles 192-241</p> <p>Test Group: CRR-D</p>"},{"location":"specifications/crr/credit-risk-mitigation/#collateral-haircuts-crr-art-224","title":"Collateral Haircuts (CRR Art. 224)","text":""},{"location":"specifications/crr/credit-risk-mitigation/#financial-collateral","title":"Financial Collateral","text":"Collateral Type Haircut Cash / Deposit 0% Gold 15%"},{"location":"specifications/crr/credit-risk-mitigation/#government-bonds-by-cqs-and-residual-maturity","title":"Government Bonds (by CQS and Residual Maturity)","text":"CQS 0-1 year 1-5 years 5+ years 1 0.5% 2% 4% 2-3 1% 3% 6%"},{"location":"specifications/crr/credit-risk-mitigation/#corporate-bonds-by-cqs-and-residual-maturity","title":"Corporate Bonds (by CQS and Residual Maturity)","text":"CQS 0-1 year 1-5 years 5+ years 1-2 1% 4% 6% 3 2% 6% 8%"},{"location":"specifications/crr/credit-risk-mitigation/#equity","title":"Equity","text":"Type Haircut Main index 15% Other listed 25%"},{"location":"specifications/crr/credit-risk-mitigation/#non-financial-collateral","title":"Non-Financial Collateral","text":"Type Haircut Receivables 20% Real estate 0% (handled via LTV, not haircut) Other physical 40%"},{"location":"specifications/crr/credit-risk-mitigation/#fx-mismatch-haircut-crr-art-233","title":"FX Mismatch Haircut (CRR Art. 233)","text":"<p>When collateral currency differs from exposure currency: 8% additional haircut.</p>"},{"location":"specifications/crr/credit-risk-mitigation/#overcollateralisation-crr-art-230","title":"Overcollateralisation (CRR Art. 230)","text":"<p>Non-financial collateral requires overcollateralisation to receive credit risk mitigation benefit.</p>"},{"location":"specifications/crr/credit-risk-mitigation/#overcollateralisation-ratios","title":"Overcollateralisation Ratios","text":"Collateral Type Required Ratio Financial 1.0x (no overcollateralisation required) Receivables 1.25x Real estate 1.4x Other physical 1.4x <p>The effectively secured amount is:</p> <pre><code>effectively_secured = adjusted_collateral_value / overcollateralisation_ratio\n</code></pre>"},{"location":"specifications/crr/credit-risk-mitigation/#minimum-coverage-thresholds","title":"Minimum Coverage Thresholds","text":"Collateral Type Minimum Coverage Financial No minimum Receivables No minimum Real estate 30% of EAD Other physical 30% of EAD <p>If the minimum threshold is not met, the non-financial collateral value is set to zero (no CRM benefit).</p>"},{"location":"specifications/crr/credit-risk-mitigation/#maturity-mismatch-adjustment-crr-art-238","title":"Maturity Mismatch Adjustment (CRR Art. 238)","text":"<p>When collateral maturity is shorter than exposure maturity:</p> <pre><code>adjustment_factor = (t - 0.25) / (T - 0.25)\n</code></pre> <p>Where <code>t</code> = residual collateral maturity, <code>T</code> = 5 years.</p> <p>No adjustment when:</p> <ul> <li>Collateral residual maturity \u2265 5 years, or</li> <li>Exposure residual maturity \u2264 3 months</li> </ul>"},{"location":"specifications/crr/credit-risk-mitigation/#multi-level-collateral-allocation","title":"Multi-Level Collateral Allocation","text":"<p>Collateral is allocated at three levels, distributed pro-rata:</p> <ol> <li>Exposure level - Collateral pledged directly against an exposure</li> <li>Facility level - Collateral pledged against a facility, shared across its exposures</li> <li>Counterparty level - Collateral pledged against a counterparty, shared across all exposures</li> </ol> <p>Financial and non-financial collateral are tracked separately to apply the correct overcollateralisation ratios and minimum thresholds.</p>"},{"location":"specifications/crr/credit-risk-mitigation/#guarantee-substitution-crr-art-213-217","title":"Guarantee Substitution (CRR Art. 213-217)","text":""},{"location":"specifications/crr/credit-risk-mitigation/#approach","title":"Approach","text":"<p>The guarantor's risk weight replaces the borrower's risk weight for the guaranteed portion of the exposure, but only when this is beneficial.</p>"},{"location":"specifications/crr/credit-risk-mitigation/#application-logic","title":"Application Logic","text":"<ol> <li>Look up the guarantor's risk weight based on entity type and CQS</li> <li>Compare to the borrower's risk weight</li> <li>If guarantor RW &lt; borrower RW, apply substitution on the guaranteed portion</li> <li>If guarantor RW \u2265 borrower RW, no substitution (guarantee is non-beneficial)</li> </ol>"},{"location":"specifications/crr/credit-risk-mitigation/#blended-risk-weight","title":"Blended Risk Weight","text":"<p>For partially guaranteed exposures:</p> <pre><code>RW_blended = (unguaranteed_portion x borrower_RW + guaranteed_portion x guarantor_RW) / EAD\n</code></pre>"},{"location":"specifications/crr/credit-risk-mitigation/#tracking-fields","title":"Tracking Fields","text":"<p>The calculator tracks pre- and post-CRM values for audit:</p> <ul> <li><code>pre_crm_counterparty_reference</code> / <code>post_crm_counterparty_guaranteed</code></li> <li><code>pre_crm_exposure_class</code> / <code>post_crm_exposure_class_guaranteed</code></li> <li><code>guaranteed_portion</code> / <code>unguaranteed_portion</code></li> <li><code>is_guarantee_beneficial</code></li> </ul>"},{"location":"specifications/crr/credit-risk-mitigation/#cross-approach-ccf-substitution-crr-art-1533","title":"Cross-Approach CCF Substitution (CRR Art. 153(3))","text":"<p>When an IRB exposure is guaranteed by a counterparty under the Standardised Approach, the guaranteed portion uses SA CCFs instead of IRB supervisory CCFs.</p>"},{"location":"specifications/crr/credit-risk-mitigation/#guarantor-approach-determination","title":"Guarantor Approach Determination","text":"<p>The guarantor's approach is \"sa\" when: - The firm lacks IRB permission for the guarantor's exposure class, OR - The guarantor has only an external rating (no internal PD)</p> <p>The guarantor's approach is \"irb\" only when both conditions are met: - The firm has IRB permission for the guarantor's exposure class, AND - The guarantor has an internal rating with PD</p>"},{"location":"specifications/crr/credit-risk-mitigation/#ead-split","title":"EAD Split","text":"<pre><code>ead_guaranteed = guarantee_ratio \u00d7 (drawn + undrawn \u00d7 ccf_sa)\nead_unguaranteed = (1 - guarantee_ratio) \u00d7 (drawn + undrawn \u00d7 ccf_irb)\n</code></pre>"},{"location":"specifications/crr/credit-risk-mitigation/#output-fields","title":"Output Fields","text":"<ul> <li><code>ccf_original</code>, <code>ccf_guaranteed</code>, <code>ccf_unguaranteed</code></li> <li><code>guarantee_ratio</code>, <code>guarantor_approach</code>, <code>guarantor_rating_type</code></li> </ul>"},{"location":"specifications/crr/credit-risk-mitigation/#key-scenarios","title":"Key Scenarios","text":"Scenario ID Description CRR-D Financial collateral with cash (0% haircut) CRR-D Government bond collateral with maturity bands CRR-D FX mismatch haircut (8%) CRR-D Overcollateralisation: RE at 1.4x ratio CRR-D Minimum threshold: RE below 30% of EAD (zeroed) CRR-D Maturity mismatch adjustment CRR-D Beneficial guarantee substitution CRR-D Non-beneficial guarantee (guarantor RW \u2265 borrower RW) CRR-D Multi-level collateral allocation"},{"location":"specifications/crr/firb-calculation/","title":"Foundation IRB Specification","text":"<p>Foundation IRB calculation with supervisory LGD, PD floors, and correlation formulas.</p> <p>Regulatory Reference: CRR Articles 153-154, 161-163</p> <p>Test Group: CRR-B</p>"},{"location":"specifications/crr/firb-calculation/#supervisory-lgd-values-crr-art-161","title":"Supervisory LGD Values (CRR Art. 161)","text":"<p>Under F-IRB, LGD is prescribed by the regulator based on collateral type:</p> Collateral Type Supervisory LGD Unsecured (senior) 45% Subordinated 75% Financial collateral 0% Receivables 35% Residential real estate 35% Commercial real estate 35% Other physical 40%"},{"location":"specifications/crr/firb-calculation/#pd-floor","title":"PD Floor","text":"<p>CRR: Single floor of 0.03% for all exposure classes (Art. 163).</p> <p>See Framework Differences for Basel 3.1 differentiated PD floors.</p>"},{"location":"specifications/crr/firb-calculation/#asset-correlation-formula-crr-art-153","title":"Asset Correlation Formula (CRR Art. 153)","text":""},{"location":"specifications/crr/firb-calculation/#corporate-institution-sovereign","title":"Corporate, Institution, Sovereign","text":"<p>PD-dependent correlation with exponential decay factor of 50:</p> <pre><code>f(PD) = (1 - exp(-50 x PD)) / (1 - exp(-50))\nR = 0.12 x f(PD) + 0.24 x (1 - f(PD))\n</code></pre>"},{"location":"specifications/crr/firb-calculation/#sme-firm-size-adjustment","title":"SME Firm-Size Adjustment","text":"<p>For corporates with turnover &lt; EUR 50m, correlation is reduced:</p> <pre><code>s = max(5, min(turnover_EUR, 50))\nadjustment = 0.04 x (1 - (s - 5) / 45)\nR_adjusted = R - adjustment\n</code></pre> <p>Turnover is stored in GBP and converted to EUR via the configured FX rate.</p>"},{"location":"specifications/crr/firb-calculation/#retail-mortgage","title":"Retail Mortgage","text":"<p>Fixed correlation: R = 0.15</p>"},{"location":"specifications/crr/firb-calculation/#qualifying-revolving-retail-qrre","title":"Qualifying Revolving Retail (QRRE)","text":"<p>Fixed correlation: R = 0.04</p>"},{"location":"specifications/crr/firb-calculation/#other-retail","title":"Other Retail","text":"<p>PD-dependent correlation with exponential decay factor of 35:</p> <pre><code>f(PD) = (1 - exp(-35 x PD)) / (1 - exp(-35))\nR = 0.03 x f(PD) + 0.16 x (1 - f(PD))\n</code></pre>"},{"location":"specifications/crr/firb-calculation/#fi-scalar-crr-art-1532","title":"FI Scalar (CRR Art. 153(2))","text":"<p>A 1.25x multiplier applied to the capital requirement for large or unregulated financial sector entities.</p>"},{"location":"specifications/crr/firb-calculation/#capital-requirement-formula","title":"Capital Requirement Formula","text":"<pre><code>K = LGD x N[(1-R)^(-0.5) x G(PD) + (R/(1-R))^(0.5) x G(0.999)] - PD x LGD\n</code></pre> <p>Where:</p> <ul> <li><code>N(x)</code> = cumulative normal distribution function</li> <li><code>G(x)</code> = inverse normal CDF</li> <li><code>G(0.999)</code> = 3.0902323061678132</li> <li><code>K</code> is floored at 0</li> </ul>"},{"location":"specifications/crr/firb-calculation/#maturity-adjustment-crr-art-162","title":"Maturity Adjustment (CRR Art. 162)","text":"<p>Applied to non-retail exposures only (retail exposures use MA = 1.0):</p> <pre><code>b = (0.11852 - 0.05478 x ln(PD))^2\nMA = (1 + (M - 2.5) x b) / (1 - 1.5 x b)\n</code></pre> <p>Maturity <code>M</code> is clamped to the range [1.0, 5.0] years.</p>"},{"location":"specifications/crr/firb-calculation/#rwa-calculation","title":"RWA Calculation","text":"<p>CRR: <code>RWA = K x 12.5 x 1.06 x EAD x MA</code></p> <p>The 1.06 is the CRR scaling factor (not present in Basel 3.1).</p>"},{"location":"specifications/crr/firb-calculation/#expected-loss","title":"Expected Loss","text":"<pre><code>EL = PD x LGD x EAD\n</code></pre> <p>Used for comparison against provisions (see Provisions).</p>"},{"location":"specifications/crr/firb-calculation/#key-scenarios","title":"Key Scenarios","text":"Scenario ID Description CRR-B Corporate F-IRB with senior unsecured (LGD 45%) CRR-B Corporate F-IRB with financial collateral (LGD 0%) CRR-B SME with firm-size adjustment CRR-B PD floor enforcement (PD &lt; 0.03%) CRR-B FI scalar application (1.25x) CRR-B Maturity adjustment at boundaries (M=1, M=5)"},{"location":"specifications/crr/provisions/","title":"Provisions Specification","text":"<p>Provision treatment, expected loss calculation, and EL vs provisions comparison.</p> <p>Regulatory Reference: CRR Articles 110, 158-159</p> <p>Test Group: CRR-G</p>"},{"location":"specifications/crr/provisions/#sa-approach-crr-art-110","title":"SA Approach (CRR Art. 110)","text":"<p>Under the Standardised Approach, specific provisions are deducted from the exposure value before risk weighting:</p> <pre><code>EAD_net = EAD_gross - specific_provisions\n</code></pre> <p>This reduces the base on which risk weights are applied.</p>"},{"location":"specifications/crr/provisions/#irb-approach-crr-art-158-159","title":"IRB Approach (CRR Art. 158-159)","text":"<p>Under IRB, provisions are not deducted from EAD. Instead, the calculator computes Expected Loss for comparison:</p> <pre><code>EL = PD x LGD x EAD\n</code></pre>"},{"location":"specifications/crr/provisions/#el-vs-provisions-comparison","title":"EL vs Provisions Comparison","text":"<ul> <li>EL &gt; Provisions (shortfall): The difference reduces CET1 capital</li> <li>EL &lt; Provisions (excess): The surplus may be added to Tier 2 capital (subject to caps)</li> </ul> <p>The calculator tracks both values to support this regulatory comparison.</p>"},{"location":"specifications/crr/provisions/#key-scenarios","title":"Key Scenarios","text":"Scenario ID Description CRR-G SA exposure with specific provision deducted from EAD CRR-G IRB expected loss calculation CRR-G EL vs provisions: shortfall case CRR-G EL vs provisions: excess case"},{"location":"specifications/crr/sa-risk-weights/","title":"SA Risk Weights Specification","text":"<p>Standardised Approach risk weights by exposure class and credit quality step.</p> <p>Regulatory Reference: CRR Articles 112-134</p> <p>Test Group: CRR-A</p>"},{"location":"specifications/crr/sa-risk-weights/#sovereign-exposures-crr-art-114","title":"Sovereign Exposures (CRR Art. 114)","text":"CQS Rating Equivalent Risk Weight 1 AAA to AA- 0% 2 A+ to A- 20% 3 BBB+ to BBB- 50% 4 BB+ to BB- 100% 5 B+ to B- 100% 6 CCC+ and below 150% Unrated \u2014 100%"},{"location":"specifications/crr/sa-risk-weights/#institution-exposures-crr-art-120-121","title":"Institution Exposures (CRR Art. 120-121)","text":"<p>UK Deviation</p> <p>CQS 2 institutions receive a 30% risk weight under the UK CRR, rather than the standard 50% under EU CRR.</p> CQS Risk Weight (UK) Risk Weight (EU Standard) 1 20% 20% 2 30% 50% 3 50% 50% 4 100% 100% 5 100% 100% 6 150% 150% Unrated 40% 100% <p>UK unrated institutions default to 40% (derived from sovereign CQS 2).</p>"},{"location":"specifications/crr/sa-risk-weights/#corporate-exposures-crr-art-122","title":"Corporate Exposures (CRR Art. 122)","text":"CQS Risk Weight 1 20% 2 50% 3 100% 4 100% 5 150% 6 150% Unrated 100%"},{"location":"specifications/crr/sa-risk-weights/#retail-exposures-crr-art-123","title":"Retail Exposures (CRR Art. 123)","text":"<p>All qualifying retail exposures receive a flat 75% risk weight.</p>"},{"location":"specifications/crr/sa-risk-weights/#residential-mortgage-exposures-crr-art-125","title":"Residential Mortgage Exposures (CRR Art. 125)","text":"<p>Risk weight depends on LTV ratio with a split at 80%:</p> LTV Treatment LTV \u2264 80% 35% on whole exposure LTV &gt; 80% Split: 35% on portion up to 80% LTV, 75% on excess <p>Blended formula for LTV &gt; 80%:</p> <pre><code>avg_RW = 0.35 x (0.80 / LTV) + 0.75 x ((LTV - 0.80) / LTV)\n</code></pre>"},{"location":"specifications/crr/sa-risk-weights/#commercial-real-estate-crr-art-126","title":"Commercial Real Estate (CRR Art. 126)","text":"Condition Risk Weight LTV \u2264 50% and rental income \u2265 1.5x interest costs 50% All other CRE 100%"},{"location":"specifications/crr/sa-risk-weights/#key-scenarios","title":"Key Scenarios","text":"Scenario ID Description Expected RW CRR-A1 UK Sovereign CQS 1 0% CRR-A4 UK Institution CQS 2 (UK deviation) 30% CRR-A Corporate unrated 100% CRR-A Retail exposure 75% CRR-A Residential mortgage LTV 60% 35% CRR-A CRE with income cover, LTV 45% 50%"},{"location":"specifications/crr/slotting-approach/","title":"Slotting Approach Specification","text":"<p>Specialised lending slotting categories for project finance, object finance, commodities finance, and IPRE.</p> <p>Regulatory Reference: CRR Articles 147(8), 153(5)</p> <p>Test Group: CRR-E</p>"},{"location":"specifications/crr/slotting-approach/#overview","title":"Overview","text":"<p>The slotting approach assigns risk weights based on qualitative category assessment rather than PD/LGD modelling. It applies to specialised lending exposures where banks cannot estimate PD using standard IRB models.</p>"},{"location":"specifications/crr/slotting-approach/#specialised-lending-types","title":"Specialised Lending Types","text":"Type Abbreviation Description Project Finance PF Long-term financing of infrastructure/industrial projects Object Finance OF Financing of physical assets (ships, aircraft, etc.) Commodities Finance CF Structured financing of commodity inventories Income-Producing RE IPRE Commercial real estate where repayment depends on rental income High Volatility CRE HVCRE CRE with higher risk characteristics"},{"location":"specifications/crr/slotting-approach/#crr-slotting-risk-weights","title":"CRR Slotting Risk Weights","text":"<p>Under CRR, the same risk weights apply regardless of HVCRE status:</p> Category Risk Weight Description Strong 70% Highly favourable financial and risk characteristics Good 70% Favourable characteristics Satisfactory 115% Acceptable characteristics Weak 250% Weakened characteristics Default 0% Fully provisioned"},{"location":"specifications/crr/slotting-approach/#basel-31-slotting-risk-weights","title":"Basel 3.1 Slotting Risk Weights","text":"<p>Under Basel 3.1, HVCRE receives elevated risk weights:</p> Category Non-HVCRE HVCRE Strong 50% 100% Good 70% 70% Satisfactory 100% 150% Weak 150% 150% Default 350% 350%"},{"location":"specifications/crr/slotting-approach/#key-scenarios","title":"Key Scenarios","text":"Scenario ID Description CRR-E Project finance, Strong category (70%) CRR-E Object finance, Satisfactory category (115%) CRR-E HVCRE exposure, Weak category (250%) CRR-E Defaulted specialised lending (0%, fully provisioned)"},{"location":"specifications/crr/supporting-factors/","title":"Supporting Factors Specification","text":"<p>SME supporting factor and infrastructure supporting factor under CRR.</p> <p>Regulatory Reference: CRR Articles 501, 501a</p> <p>Test Group: CRR-F</p> <p>CRR Only</p> <p>Supporting factors are not available under Basel 3.1. They are disabled automatically when using the Basel 3.1 configuration.</p>"},{"location":"specifications/crr/supporting-factors/#sme-supporting-factor-crr-art-501","title":"SME Supporting Factor (CRR Art. 501)","text":"<p>A tiered discount applied to RWA for qualifying SME exposures.</p>"},{"location":"specifications/crr/supporting-factors/#eligibility","title":"Eligibility","text":"<ul> <li>Counterparty must be classified as Corporate SME</li> <li>Turnover &lt; EUR 50m (converted from GBP at the configured FX rate)</li> <li>Aggregated at counterparty level, not per-exposure</li> </ul>"},{"location":"specifications/crr/supporting-factors/#tiered-application","title":"Tiered Application","text":"Tier Exposure Threshold Factor Tier 1 Up to EUR 2.5m (GBP ~2.2m) 0.7619 Tier 2 Above EUR 2.5m 0.85"},{"location":"specifications/crr/supporting-factors/#blended-formula","title":"Blended Formula","text":"<p>For exposures that span both tiers:</p> <pre><code>SF = [min(E, threshold) x 0.7619 + max(E - threshold, 0) x 0.85] / E\n</code></pre> <p>Where <code>E</code> is the total aggregated exposure and <code>threshold</code> is EUR 2.5m (or GBP equivalent).</p>"},{"location":"specifications/crr/supporting-factors/#infrastructure-supporting-factor-crr-art-501a","title":"Infrastructure Supporting Factor (CRR Art. 501a)","text":"<p>A flat 0.75 factor applied to qualifying infrastructure lending exposures.</p>"},{"location":"specifications/crr/supporting-factors/#eligibility_1","title":"Eligibility","text":"<ul> <li>Exposure must be flagged as <code>is_infrastructure = true</code></li> <li>Applied regardless of exposure size</li> </ul>"},{"location":"specifications/crr/supporting-factors/#combined-application","title":"Combined Application","text":"<p>When both factors apply to an exposure, the calculator uses the minimum (most beneficial) factor.</p>"},{"location":"specifications/crr/supporting-factors/#key-scenarios","title":"Key Scenarios","text":"Scenario ID Description Expected Factor CRR-F SME below EUR 2.5m threshold 0.7619 CRR-F SME above EUR 2.5m threshold 0.85 CRR-F SME spanning both tiers Blended CRR-F Infrastructure exposure 0.75 CRR-F Combined SME + infrastructure min(SME, 0.75)"},{"location":"user-guide/","title":"User Guide","text":"<p>Welcome to the comprehensive user guide for the UK Credit Risk RWA Calculator. This guide provides detailed information on regulatory frameworks, calculation methodologies, and exposure class treatments.</p>"},{"location":"user-guide/#guide-structure","title":"Guide Structure","text":"<p>This guide is organized into the following sections:</p>"},{"location":"user-guide/#interactive-ui","title":"Interactive UI","text":"<p>Run calculations without writing code using the web-based interface:</p> <ul> <li>Interactive UI - Web-based calculator, results explorer, and regulatory reference</li> </ul>"},{"location":"user-guide/#regulatory-frameworks","title":"Regulatory Frameworks","text":"<p>Understand the regulatory requirements that govern RWA calculations:</p> <ul> <li>Overview - Introduction to UK credit risk regulations</li> <li>CRR (Basel 3.0) - Current framework until December 2026</li> <li>Basel 3.1 - New framework from January 2027</li> <li>Framework Comparison - Key differences between frameworks</li> </ul>"},{"location":"user-guide/#calculation-methodology","title":"Calculation Methodology","text":"<p>Learn how RWA is calculated under different approaches:</p> <ul> <li>Overview - Introduction to RWA calculation</li> <li>Standardised Approach - SA calculation methodology</li> <li>IRB Approach - F-IRB and A-IRB methodologies</li> <li>Specialised Lending - Slotting approach</li> <li>Credit Risk Mitigation - CRM techniques and application</li> <li>Supporting Factors - SME and infrastructure factors</li> </ul>"},{"location":"user-guide/#exposure-classes","title":"Exposure Classes","text":"<p>Understand how different exposures are classified and treated:</p> <ul> <li>Overview - Exposure classification</li> <li>Central Govt / Central Bank - Government and central bank exposures</li> <li>Institution - Bank and investment firm exposures</li> <li>Corporate - Corporate and SME exposures</li> <li>Retail - Retail mortgage, QRRE, and other retail</li> <li>Other Classes - Equity, defaulted, and specialised lending</li> </ul>"},{"location":"user-guide/#configuration","title":"Configuration","text":"<ul> <li>Configuration Guide - How to configure the calculator</li> </ul>"},{"location":"user-guide/#quick-reference","title":"Quick Reference","text":""},{"location":"user-guide/#key-formulas","title":"Key Formulas","text":"Standardised ApproachIRB ApproachSlotting <pre><code>RWA = EAD \u00d7 Risk Weight\n</code></pre> <pre><code>RWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA \u00d7 [1.06 if CRR]\n</code></pre> <p>Where K is the capital requirement from the IRB formula.</p> <pre><code>RWA = EAD \u00d7 Slotting Risk Weight\n</code></pre>"},{"location":"user-guide/#approach-availability-by-exposure-class","title":"Approach Availability by Exposure Class","text":"Exposure Class SA F-IRB A-IRB Slotting Central Govt / Central Bank Institution Corporate Corporate SME Retail Specialised Lending Equity Defaulted"},{"location":"user-guide/#for-different-users","title":"For Different Users","text":""},{"location":"user-guide/#risk-audit-teams","title":"Risk &amp; Audit Teams","text":"<p>Start with: 1. Interactive UI - Run calculations without code 2. Regulatory Frameworks - Understand the rules 3. Calculation Methodology - How calculations work 4. Framework Comparison - CRR vs Basel 3.1 differences</p>"},{"location":"user-guide/#business-users","title":"Business Users","text":"<p>Start with: 1. Interactive UI - Run calculations through the web interface 2. Key Concepts - Terminology 3. Exposure Classes - How exposures are classified 4. Configuration Guide - Setting up calculations</p>"},{"location":"user-guide/#technical-users","title":"Technical Users","text":"<p>See also: - Architecture Guide - API Reference - Data Model</p>"},{"location":"user-guide/configuration/","title":"Configuration Guide","text":"<p>This guide explains how to configure the RWA calculator for different scenarios, regulatory frameworks, and calculation options.</p>"},{"location":"user-guide/configuration/#configuration-overview","title":"Configuration Overview","text":"<p>The calculator uses a <code>CalculationConfig</code> object to control all aspects of the calculation:</p> <pre><code>from rwa_calc.contracts.config import CalculationConfig\n\n# Create configuration\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31)\n)\n</code></pre>"},{"location":"user-guide/configuration/#framework-selection","title":"Framework Selection","text":""},{"location":"user-guide/configuration/#crr-configuration","title":"CRR Configuration","text":"<p>For calculations under current CRR rules:</p> <pre><code>from datetime import date\nfrom decimal import Decimal\nfrom rwa_calc.contracts.config import CalculationConfig\n\nconfig = CalculationConfig.crr(\n    # Required\n    reporting_date=date(2026, 12, 31),\n\n    # Optional - CRR-specific\n    apply_sme_supporting_factor=True,      # Default: True\n    apply_infrastructure_factor=True,       # Default: True\n\n    # Optional - General\n    eur_gbp_rate=Decimal(\"0.88\"),          # Default: 0.88\n)\n</code></pre>"},{"location":"user-guide/configuration/#basel-31-configuration","title":"Basel 3.1 Configuration","text":"<p>For calculations under Basel 3.1 rules:</p> <pre><code>config = CalculationConfig.basel_3_1(\n    # Required\n    reporting_date=date(2027, 1, 1),\n\n    # Optional - Basel 3.1-specific\n    output_floor_percentage=0.725,          # Default: 0.725 (72.5%)\n    transitional_floor_year=2027,           # For phase-in calculation\n\n    # Optional - General\n    eur_gbp_rate=Decimal(\"0.88\"),\n)\n</code></pre>"},{"location":"user-guide/configuration/#configuration-parameters","title":"Configuration Parameters","text":""},{"location":"user-guide/configuration/#common-parameters","title":"Common Parameters","text":"Parameter Type Default Description <code>reporting_date</code> <code>date</code> Required Calculation reference date <code>eur_gbp_rate</code> <code>Decimal</code> 0.88 EUR to GBP conversion rate"},{"location":"user-guide/configuration/#crr-specific-parameters","title":"CRR-Specific Parameters","text":"Parameter Type Default Description <code>apply_sme_supporting_factor</code> <code>bool</code> True Apply SME factor (Art. 501) <code>apply_infrastructure_factor</code> <code>bool</code> True Apply infrastructure factor"},{"location":"user-guide/configuration/#basel-31-specific-parameters","title":"Basel 3.1-Specific Parameters","text":"Parameter Type Default Description <code>output_floor_percentage</code> <code>float</code> 0.725 Output floor percentage <code>transitional_floor_year</code> <code>int</code> None Year for transitional floor"},{"location":"user-guide/configuration/#framework-differences","title":"Framework Differences","text":"<p>The configuration factories automatically set framework-specific values:</p>"},{"location":"user-guide/configuration/#automatic-settings","title":"Automatic Settings","text":"Setting CRR Basel 3.1 <code>framework</code> <code>RegulatoryFramework.CRR</code> <code>RegulatoryFramework.BASEL_3_1</code> <code>scaling_factor</code> 1.06 1.00 <code>pd_floors</code> Uniform 0.03% Differentiated <code>lgd_floors</code> None By collateral type <code>output_floor</code> None 72.5% (or transitional) <code>supporting_factors</code> Available Not available"},{"location":"user-guide/configuration/#pd-floors","title":"PD Floors","text":"<pre><code># CRR - All exposures\npd_floor = 0.0003  # 0.03%\n\n# Basel 3.1 - Differentiated\npd_floors = {\n    \"CORPORATE\": 0.0005,           # 0.05%\n    \"INSTITUTION\": 0.0005,         # 0.05%\n    \"RETAIL_MORTGAGE\": 0.0005,     # 0.05%\n    \"RETAIL_QRRE_TRANSACTOR\": 0.0003,  # 0.03%\n    \"RETAIL_QRRE_REVOLVER\": 0.0010,    # 0.10%\n    \"RETAIL_OTHER\": 0.0005,        # 0.05%\n}\n</code></pre>"},{"location":"user-guide/configuration/#lgd-floors-basel-31-a-irb","title":"LGD Floors (Basel 3.1 A-IRB)","text":"<pre><code>lgd_floors = {\n    \"UNSECURED_SENIOR\": 0.25,      # 25%\n    \"UNSECURED_SUBORDINATED\": 0.50, # 50%\n    \"FINANCIAL_COLLATERAL\": 0.00,  # 0%\n    \"RECEIVABLES\": 0.15,           # 15%\n    \"CRE\": 0.15,                   # 15%\n    \"RRE\": 0.10,                   # 10%\n    \"OTHER_PHYSICAL\": 0.20,        # 20%\n}\n</code></pre>"},{"location":"user-guide/configuration/#output-floor-configuration","title":"Output Floor Configuration","text":""},{"location":"user-guide/configuration/#phase-in-schedule","title":"Phase-In Schedule","text":"Year Floor Percentage 2027 50.0% 2028 55.0% 2029 60.0% 2030 65.0% 2031 70.0% 2032+ 72.5%"},{"location":"user-guide/configuration/#transitional-configuration","title":"Transitional Configuration","text":"<pre><code># Automatically calculate transitional floor\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2028, 6, 30),\n    transitional_floor_year=2028  # Uses 55% floor\n)\n\n# Or specify exact percentage\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2028, 6, 30),\n    output_floor_percentage=0.55  # Explicit 55%\n)\n</code></pre>"},{"location":"user-guide/configuration/#fx-rate-configuration","title":"FX Rate Configuration","text":""},{"location":"user-guide/configuration/#eurgbp-conversion","title":"EUR/GBP Conversion","text":"<p>Many regulatory thresholds are defined in EUR. The calculator converts these to GBP:</p> <pre><code># Default rate\neur_gbp_rate = Decimal(\"0.88\")\n\n# Converted thresholds\nSME_TURNOVER = EUR 50m \u00d7 0.88 = GBP 44m\nSME_EXPOSURE = EUR 2.5m \u00d7 0.88 = GBP 2.2m\nRETAIL_THRESHOLD = EUR 1m \u00d7 0.88 = GBP 880k\n</code></pre>"},{"location":"user-guide/configuration/#custom-fx-rate","title":"Custom FX Rate","text":"<pre><code>from decimal import Decimal\n\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    eur_gbp_rate=Decimal(\"0.85\")  # Custom rate\n)\n</code></pre>"},{"location":"user-guide/configuration/#supporting-factors-configuration","title":"Supporting Factors Configuration","text":""},{"location":"user-guide/configuration/#sme-supporting-factor","title":"SME Supporting Factor","text":"<pre><code># Enable (default)\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=True\n)\n\n# Disable for comparison\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=False\n)\n</code></pre>"},{"location":"user-guide/configuration/#infrastructure-factor","title":"Infrastructure Factor","text":"<pre><code># Enable (default)\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_infrastructure_factor=True\n)\n\n# Disable\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_infrastructure_factor=False\n)\n</code></pre>"},{"location":"user-guide/configuration/#advanced-configuration","title":"Advanced Configuration","text":""},{"location":"user-guide/configuration/#accessing-configuration-components","title":"Accessing Configuration Components","text":"<pre><code>from rwa_calc.contracts.config import CalculationConfig\n\nconfig = CalculationConfig.crr(date(2026, 12, 31))\n\n# Access sub-components\nprint(config.framework)              # RegulatoryFramework.CRR\nprint(config.pd_floors)              # PDFloors object\nprint(config.lgd_floors)             # LGDFloors object (None for CRR)\nprint(config.supporting_factors)     # SupportingFactors object\nprint(config.output_floor_config)    # OutputFloorConfig object (None for CRR)\n</code></pre>"},{"location":"user-guide/configuration/#custom-pd-floors","title":"Custom PD Floors","text":"<pre><code>from rwa_calc.contracts.config import PDFloors\n\n# Custom floors\ncustom_pd_floors = PDFloors(\n    corporate=0.0006,        # 0.06%\n    institution=0.0005,      # 0.05%\n    retail_mortgage=0.0005,  # 0.05%\n    retail_qrre=0.0003,      # 0.03%\n    retail_other=0.0005      # 0.05%\n)\n</code></pre>"},{"location":"user-guide/configuration/#configuration-validation","title":"Configuration Validation","text":"<p>The calculator validates configuration:</p> <pre><code># Invalid date\ntry:\n    config = CalculationConfig.crr(\n        reporting_date=date(2020, 1, 1)  # Historic date\n    )\nexcept ValueError as e:\n    print(f\"Invalid config: {e}\")\n\n# Framework mismatch\ntry:\n    config = CalculationConfig.basel_3_1(\n        reporting_date=date(2025, 1, 1)  # Before Basel 3.1 effective\n    )\n    # Warning issued but allowed for testing\nexcept ValueError:\n    pass\n</code></pre>"},{"location":"user-guide/configuration/#comparison-runs","title":"Comparison Runs","text":""},{"location":"user-guide/configuration/#framework-comparison","title":"Framework Comparison","text":"<p>Run under both frameworks for impact analysis:</p> <pre><code>from datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\nfrom rwa_calc.engine.pipeline import create_pipeline\n\npipeline = create_pipeline()\n\n# CRR calculation\nconfig_crr = CalculationConfig.crr(date(2026, 12, 31))\nresult_crr = pipeline.run(config_crr)\n\n# Basel 3.1 calculation\nconfig_b31 = CalculationConfig.basel_3_1(date(2027, 1, 1))\nresult_b31 = pipeline.run(config_b31)\n\n# Compare\nprint(f\"CRR RWA: {result_crr.total_rwa:,.0f}\")\nprint(f\"Basel 3.1 RWA: {result_b31.total_rwa:,.0f}\")\nprint(f\"Impact: {(result_b31.total_rwa / result_crr.total_rwa - 1) * 100:.1f}%\")\n</code></pre>"},{"location":"user-guide/configuration/#withwithout-supporting-factors","title":"With/Without Supporting Factors","text":"<pre><code># With factors\nconfig_with = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=True\n)\n\n# Without factors\nconfig_without = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=False\n)\n\nresult_with = pipeline.run(config_with)\nresult_without = pipeline.run(config_without)\n\nprint(f\"With SME factor: {result_with.total_rwa:,.0f}\")\nprint(f\"Without: {result_without.total_rwa:,.0f}\")\nprint(f\"SME benefit: {result_without.total_rwa - result_with.total_rwa:,.0f}\")\n</code></pre>"},{"location":"user-guide/configuration/#environment-variables","title":"Environment Variables","text":"<p>The calculator can read certain settings from environment variables:</p> Variable Description Default <code>RWA_EUR_GBP_RATE</code> Default EUR/GBP rate 0.88 <code>RWA_DATA_PATH</code> Default data directory ./data <code>RWA_OUTPUT_PATH</code> Default output directory ./output <pre><code>import os\n\nos.environ[\"RWA_EUR_GBP_RATE\"] = \"0.85\"\nos.environ[\"RWA_DATA_PATH\"] = \"/path/to/data\"\n</code></pre>"},{"location":"user-guide/configuration/#configuration-best-practices","title":"Configuration Best Practices","text":""},{"location":"user-guide/configuration/#1-use-factory-methods","title":"1. Use Factory Methods","text":"<pre><code># Good - clear intent\nconfig = CalculationConfig.crr(date(2026, 12, 31))\n\n# Avoid - manual construction\nconfig = CalculationConfig(\n    framework=RegulatoryFramework.CRR,\n    reporting_date=date(2026, 12, 31),\n    # ... many more parameters\n)\n</code></pre>"},{"location":"user-guide/configuration/#2-document-configuration","title":"2. Document Configuration","text":"<pre><code># Document your configuration choices\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    # Using Q4 2026 rate per Treasury guidance\n    eur_gbp_rate=Decimal(\"0.88\"),\n    # SME factor enabled per policy\n    apply_sme_supporting_factor=True,\n)\n</code></pre>"},{"location":"user-guide/configuration/#3-version-control-configuration","title":"3. Version Control Configuration","text":"<pre><code># Store configuration in version control\nCONFIG_Q4_2026 = {\n    \"reporting_date\": \"2026-12-31\",\n    \"framework\": \"CRR\",\n    \"eur_gbp_rate\": \"0.88\",\n    \"apply_sme_supporting_factor\": True,\n}\n</code></pre>"},{"location":"user-guide/configuration/#next-steps","title":"Next Steps","text":"<ul> <li>Quick Start Guide</li> <li>API Reference - Configuration</li> <li>Framework Comparison</li> </ul>"},{"location":"user-guide/interactive-ui/","title":"Interactive UI","text":"<p>The RWA Calculator includes a web-based interactive interface for running calculations, exploring results, and referencing regulatory parameters\u2014all without writing code.</p>"},{"location":"user-guide/interactive-ui/#prerequisites","title":"Prerequisites","text":"<p>Before using the UI, ensure you have installed the calculator with UI dependencies:</p> <pre><code># Install with UI support\npip install rwa-calc[ui]\n\n# Or with uv\nuv add rwa-calc --extra ui\n</code></pre> <p>This installs Marimo and Uvicorn, which power the web interface.</p>"},{"location":"user-guide/interactive-ui/#starting-the-ui-server","title":"Starting the UI Server","text":"<p>Launch the multi-application server:</p> Installed from PyPIFrom Source <pre><code># Using the console command (recommended)\nrwa-calc-ui\n\n# Or using the module directly\npython -m rwa_calc.ui.marimo.server\n\n# Or using uvicorn\nuvicorn rwa_calc.ui.marimo.server:app --host 0.0.0.0 --port 8000\n</code></pre> <pre><code># Using uv\nuv run python src/rwa_calc/ui/marimo/server.py\n\n# Or using uvicorn\nuv run uvicorn rwa_calc.ui.marimo.server:app --host 0.0.0.0 --port 8000\n</code></pre> <p>Once started, open your browser to http://localhost:8000.</p>"},{"location":"user-guide/interactive-ui/#available-applications","title":"Available Applications","text":"<p>The UI provides three integrated applications:</p> Application URL Purpose RWA Calculator <code>/</code> or <code>/calculator</code> Run RWA calculations on your data Results Explorer <code>/results</code> Filter, aggregate, and export results Framework Reference <code>/reference</code> View regulatory parameters and risk weights"},{"location":"user-guide/interactive-ui/#rwa-calculator","title":"RWA Calculator","text":"<p>The main calculator application at http://localhost:8000/ allows you to run RWA calculations through a visual interface.</p>"},{"location":"user-guide/interactive-ui/#configuration-options","title":"Configuration Options","text":"Option Description Data Path Path to your data directory containing Parquet or CSV files Data Format Select Parquet (recommended) or CSV Reporting Date The calculation reference date Framework Choose between CRR (Basel 3.0) or Basel 3.1 Enable IRB Toggle IRB calculations on/off"},{"location":"user-guide/interactive-ui/#running-a-calculation","title":"Running a Calculation","text":"<ol> <li>Set your data path - Enter the path to your data directory</li> <li>Select format - Choose Parquet or CSV</li> <li>Choose framework - CRR for current rules, Basel 3.1 for future rules</li> <li>Configure options - Set reporting date and IRB toggle</li> <li>Run calculation - Click the calculate button</li> </ol>"},{"location":"user-guide/interactive-ui/#understanding-results","title":"Understanding Results","text":"<p>The calculator displays:</p> <ul> <li> <p>Summary Statistics</p> <ul> <li>Total EAD (Exposure at Default)</li> <li>Total RWA (Risk-Weighted Assets)</li> <li>Average Risk Weight (RWA / EAD)</li> </ul> </li> <li> <p>Breakdown by Approach</p> <ul> <li>Standardised Approach RWA</li> <li>IRB RWA (if enabled)</li> <li>Slotting RWA (for specialised lending)</li> </ul> </li> <li> <p>Performance Metrics</p> <ul> <li>Calculation duration</li> <li>Throughput (exposures per second)</li> </ul> </li> <li> <p>Results Preview</p> <ul> <li>First 100 rows of detailed results</li> <li>Export to CSV option</li> </ul> </li> </ul>"},{"location":"user-guide/interactive-ui/#results-explorer","title":"Results Explorer","text":"<p>The Results Explorer at http://localhost:8000/results provides interactive analysis of calculation outputs.</p>"},{"location":"user-guide/interactive-ui/#filtering-options","title":"Filtering Options","text":"Filter Description Exposure Class Filter by class (Corporate, Retail, Central Govt / Central Bank, etc.) Approach Filter by calculation approach (SA, F-IRB, A-IRB, Slotting) Risk Weight Range Set minimum and maximum risk weight bounds"},{"location":"user-guide/interactive-ui/#aggregation-views","title":"Aggregation Views","text":"<p>Aggregate results by different dimensions:</p> <ul> <li>By Exposure Class - See totals for each exposure category</li> <li>By Approach - Compare SA vs IRB vs Slotting</li> <li>By Risk Weight Band - Distribution across risk weight ranges</li> </ul>"},{"location":"user-guide/interactive-ui/#exporting-data","title":"Exporting Data","text":"<p>Export your filtered and aggregated results:</p> <ul> <li>CSV - For spreadsheet analysis</li> <li>Parquet - For further processing with Polars/Pandas</li> </ul>"},{"location":"user-guide/interactive-ui/#framework-reference","title":"Framework Reference","text":"<p>The Framework Reference at http://localhost:8000/reference provides an interactive regulatory reference.</p>"},{"location":"user-guide/interactive-ui/#available-sections","title":"Available Sections","text":"Tab Content Overview Summary of CRR vs Basel 3.1 differences CRR Parameters Current framework regulatory values Basel 3.1 Parameters Future framework regulatory values Risk Weight Tables SA risk weights by exposure class and rating IRB Parameters PD floors, LGD values, correlation factors <p>This reference is useful for:</p> <ul> <li>Validating calculation inputs</li> <li>Understanding regulatory differences</li> <li>Quick lookup of risk weights and parameters</li> </ul>"},{"location":"user-guide/interactive-ui/#data-requirements","title":"Data Requirements","text":"<p>The UI expects data in the same format as the Python API. Place your files in a directory structure:</p> <pre><code>your_data_directory/\n\u251c\u2500\u2500 counterparty/\n\u2502   \u2514\u2500\u2500 counterparties.parquet\n\u251c\u2500\u2500 exposures/\n\u2502   \u251c\u2500\u2500 facilities.parquet\n\u2502   \u2514\u2500\u2500 loans.parquet\n\u251c\u2500\u2500 collateral/           # Optional\n\u2502   \u2514\u2500\u2500 collateral.parquet\n\u251c\u2500\u2500 guarantee/            # Optional\n\u2502   \u2514\u2500\u2500 guarantee.parquet\n\u2514\u2500\u2500 ratings/              # Optional\n    \u2514\u2500\u2500 ratings.parquet\n</code></pre> <p>See Input Schemas for detailed field requirements.</p>"},{"location":"user-guide/interactive-ui/#troubleshooting","title":"Troubleshooting","text":""},{"location":"user-guide/interactive-ui/#server-wont-start","title":"Server won't start","text":"<p>Error: <code>ModuleNotFoundError: No module named 'marimo'</code></p> <p>Install with UI dependencies: <pre><code>pip install rwa-calc[ui]\n</code></pre></p> <p>Error: Port 8000 already in use</p> <p>Use a different port: <pre><code>uv run uvicorn rwa_calc.ui.marimo.server:app --port 8080\n</code></pre></p>"},{"location":"user-guide/interactive-ui/#data-path-not-found","title":"Data path not found","text":"<ul> <li>Ensure the path is absolute or relative to your current working directory</li> <li>Check that the required files (counterparties, facilities, loans) exist</li> <li>Verify file format matches your selection (Parquet vs CSV)</li> </ul>"},{"location":"user-guide/interactive-ui/#calculation-errors","title":"Calculation errors","text":"<ul> <li>Check the error panel for specific validation failures</li> <li>Ensure required fields are present in your data</li> <li>See Data Validation for field requirements</li> </ul>"},{"location":"user-guide/interactive-ui/#next-steps","title":"Next Steps","text":"<ul> <li>Configuration Guide - Advanced configuration options</li> <li>Calculation Methodology - Understanding how RWA is calculated</li> <li>Data Model - Detailed schema documentation</li> </ul>"},{"location":"user-guide/exposure-classes/","title":"Exposure Classes","text":"<p>Exposures are classified into regulatory categories that determine their treatment under the Standardised Approach (SA) and eligibility for Internal Ratings-Based (IRB) approaches.</p>"},{"location":"user-guide/exposure-classes/#overview","title":"Overview","text":"<pre><code>flowchart TD\n    A[Exposure] --&gt; B{Classification}\n    B --&gt; C[Central Govt / Central Bank]\n    B --&gt; D[Institution]\n    B --&gt; E[Corporate]\n    B --&gt; F[Retail]\n    B --&gt; G[Specialised Lending]\n    B --&gt; H[Equity]\n    B --&gt; I[Defaulted]\n    B --&gt; J[Other]</code></pre>"},{"location":"user-guide/exposure-classes/#exposure-class-summary","title":"Exposure Class Summary","text":"Class Description SA F-IRB A-IRB Slotting Central Govt / Central Bank Governments and central banks Institution Banks and investment firms * Corporate Non-financial companies * Corporate SME Small/medium enterprises Retail Individuals and small businesses Retail Mortgage Residential mortgages Retail QRRE Qualifying revolving exposures Retail Other Other retail exposures Specialised Lending Project/object/commodity finance Equity Equity holdings Defaulted Non-performing exposures Other PSE, MDB, RGLA, etc. Varies Varies <p>*Basel 3.1 restricts A-IRB for large corporates and institutions</p>"},{"location":"user-guide/exposure-classes/#classification-process","title":"Classification Process","text":"<p>The classifier assigns exposure classes based on:</p> <ol> <li>Counterparty type - Legal entity classification</li> <li>Product type - Facility/loan characteristics</li> <li>Size - Turnover, exposure amounts</li> <li>Performance status - Default indicators</li> </ol> <pre><code>from rwa_calc.engine.classifier import ExposureClassifier\n\nclassifier = ExposureClassifier()\n\n# Classify exposures\nresult = classifier.classify(\n    exposures=resolved_exposures,\n    config=CalculationConfig.crr(date(2026, 12, 31))\n)\n\n# Each exposure now has exposure_class assigned\n</code></pre>"},{"location":"user-guide/exposure-classes/#classification-hierarchy","title":"Classification Hierarchy","text":"<pre><code>flowchart TD\n    A[Counterparty] --&gt; B{Is Defaulted?}\n    B --&gt;|Yes| C[DEFAULTED]\n    B --&gt;|No| D{Counterparty Type}\n    D --&gt;|Government| E[CENTRAL_GOVT_CENTRAL_BANK]\n    D --&gt;|Central Bank| E\n    D --&gt;|Bank| F[INSTITUTION]\n    D --&gt;|Investment Firm| F\n    D --&gt;|Corporate| G{SME?}\n    G --&gt;|Yes| H[CORPORATE_SME]\n    G --&gt;|No| I{Large?}\n    I --&gt;|Yes| J[CORPORATE]\n    I --&gt;|No| J\n    D --&gt;|Individual| K{Exposure Type}\n    K --&gt;|Mortgage| L[RETAIL_MORTGAGE]\n    K --&gt;|Revolving| M[RETAIL_QRRE]\n    K --&gt;|Other| N[RETAIL_OTHER]\n    D --&gt;|Project Entity| O[SPECIALISED_LENDING]</code></pre>"},{"location":"user-guide/exposure-classes/#key-classification-criteria","title":"Key Classification Criteria","text":""},{"location":"user-guide/exposure-classes/#sme-definition","title":"SME Definition","text":"<p>An entity is classified as SME if: - Annual turnover \u2264 EUR 50m (GBP 44m), AND - Total assets \u2264 EUR 43m (GBP 37.84m)</p>"},{"location":"user-guide/exposure-classes/#retail-criteria","title":"Retail Criteria","text":"<p>An exposure qualifies as retail if: - To an individual or small business - Part of a pool of similar exposures - Total exposure to borrower \u2264 EUR 1m (GBP 880k)</p>"},{"location":"user-guide/exposure-classes/#qrre-criteria","title":"QRRE Criteria","text":"<p>Qualifying Revolving Retail Exposures: - Revolving, unsecured - To individuals - Maximum line \u2264 EUR 100k - Unconditionally cancellable</p>"},{"location":"user-guide/exposure-classes/#specialised-lending","title":"Specialised Lending","text":"<p>Project/object/commodity finance where: - Repayment from asset cash flows - Lender has substantial control - Primary security is the financed asset</p>"},{"location":"user-guide/exposure-classes/#default-indicators","title":"Default Indicators","text":"<p>An exposure is classified as defaulted if: - Past due &gt; 90 days on material amount - Unlikely to pay in full - Subject to distressed restructuring - Bankruptcy/insolvency proceedings - Non-accrual status</p> <pre><code># Default check\nif (days_past_due &gt; 90 and past_due_amount &gt; materiality_threshold) or\n   unlikely_to_pay or\n   distressed_restructuring:\n    exposure_class = ExposureClass.DEFAULTED\n</code></pre>"},{"location":"user-guide/exposure-classes/#treatment-by-class","title":"Treatment by Class","text":""},{"location":"user-guide/exposure-classes/#capital-calculation","title":"Capital Calculation","text":"Class SA Risk Weight Range IRB Availability Central Govt / Central Bank 0% - 150% F-IRB, A-IRB Institution 20% - 150% F-IRB, A-IRB* Corporate 20% - 150% F-IRB, A-IRB* Corporate SME 20% - 150% (+ factor) F-IRB, A-IRB Retail 35% - 75% A-IRB only Specialised Lending 70% - 250% Slotting Equity 100% - 400% Simple/PD/LGD Defaulted 100% - 150% IRB (100% PD)"},{"location":"user-guide/exposure-classes/#crm-eligibility","title":"CRM Eligibility","text":"Class Financial Collateral Physical Collateral Guarantees Central Govt / Central Bank Institution Corporate Retail Limited Specialised Lending"},{"location":"user-guide/exposure-classes/#supporting-factor-eligibility","title":"Supporting Factor Eligibility","text":"Class SME Factor (CRR) Infrastructure Factor (CRR) Corporate SME Retail (SME) Specialised Lending (Infra) Other"},{"location":"user-guide/exposure-classes/#implementation","title":"Implementation","text":""},{"location":"user-guide/exposure-classes/#exposure-class-enum","title":"Exposure Class Enum","text":"<pre><code>from rwa_calc.domain.enums import ExposureClass\n\n# Available classes\nExposureClass.CENTRAL_GOVT_CENTRAL_BANK\nExposureClass.INSTITUTION\nExposureClass.CORPORATE\nExposureClass.CORPORATE_SME\nExposureClass.RETAIL_MORTGAGE\nExposureClass.RETAIL_QRRE\nExposureClass.RETAIL_OTHER\nExposureClass.SPECIALISED_LENDING\nExposureClass.EQUITY\nExposureClass.DEFAULTED\nExposureClass.PSE\nExposureClass.MDB\nExposureClass.RGLA\nExposureClass.OTHER\n</code></pre>"},{"location":"user-guide/exposure-classes/#classification-configuration","title":"Classification Configuration","text":"<pre><code>from rwa_calc.contracts.config import CalculationConfig\n\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    # Thresholds converted from EUR\n    eur_gbp_rate=Decimal(\"0.88\")\n)\n\n# SME threshold: EUR 50m \u2192 GBP 44m\n# Retail threshold: EUR 1m \u2192 GBP 880k\n</code></pre>"},{"location":"user-guide/exposure-classes/#detailed-documentation","title":"Detailed Documentation","text":"<ul> <li>Central Govt / Central Bank - Government and central bank exposures</li> <li>Institution - Bank and investment firm exposures</li> <li>Corporate - Corporate and SME exposures</li> <li>Retail - Retail mortgage, QRRE, and other retail</li> <li>Other Classes - Equity, PSE, MDB, and defaulted exposures</li> </ul>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/","title":"Central Government and Central Bank Exposures","text":"<p>Central government and central bank exposures are claims on governments, central banks, and certain public sector entities treated as sovereigns.</p>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#definition","title":"Definition","text":"<p>Sovereign exposures include:</p> Entity Type Examples Central governments UK HM Treasury, US Treasury Central banks Bank of England, ECB Multilateral development banks (eligible) IMF, World Bank, EIB International organisations BIS, EU institutions Regional governments (treated as sovereign) Devolved UK administrations"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#risk-weights-sa","title":"Risk Weights (SA)","text":""},{"location":"user-guide/exposure-classes/central-govt-central-bank/#external-rating-approach","title":"External Rating Approach","text":"CQS S&amp;P/Fitch Moody's Risk Weight CQS 1 AAA to AA- Aaa to Aa3 0% CQS 2 A+ to A- A1 to A3 20% CQS 3 BBB+ to BBB- Baa1 to Baa3 50% CQS 4 BB+ to BB- Ba1 to Ba3 100% CQS 5 B+ to B- B1 to B3 100% CQS 6 CCC+ and below Caa1 and below 150% Unrated - - 100%"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#preferential-treatment","title":"Preferential Treatment","text":"<p>Certain sovereigns receive preferential risk weights:</p> Sovereign Treatment Risk Weight UK Government Domestic sovereign 0% Other G10 Reciprocal treatment Per rating Non-OECD Unrated Default weight 100%"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#irb-treatment","title":"IRB Treatment","text":""},{"location":"user-guide/exposure-classes/central-govt-central-bank/#f-irb-parameters","title":"F-IRB Parameters","text":"Parameter Value PD Bank estimate (floor 0.03%) LGD Supervisory 45% M Effective maturity"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#a-irb-parameters","title":"A-IRB Parameters","text":"Parameter Value PD Bank estimate (floor 0.03% CRR / 0.05% Basel 3.1) LGD Bank estimate EAD Bank estimate"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#correlation","title":"Correlation","text":"<p>Sovereign correlation uses the corporate formula: <pre><code>R = 0.12 \u00d7 (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50)) +\n    0.24 \u00d7 [1 - (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50))]\n</code></pre></p>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#domestic-sovereign","title":"Domestic Sovereign","text":""},{"location":"user-guide/exposure-classes/central-govt-central-bank/#uk-government-exposures","title":"UK Government Exposures","text":"<p>The UK Government receives 0% risk weight for: - Treasury bonds (Gilts) - National Savings products - Loans to HM Treasury - Exposures guaranteed by UK Government</p>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#treatment","title":"Treatment","text":"<pre><code>if counterparty.country == \"UK\" and counterparty.type == \"SOVEREIGN\":\n    risk_weight = 0.00  # 0% RW\n</code></pre>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#foreign-sovereigns","title":"Foreign Sovereigns","text":""},{"location":"user-guide/exposure-classes/central-govt-central-bank/#g10-sovereigns","title":"G10 Sovereigns","text":"Country Typical Rating Typical RW United States AA+ 0-20% Germany AAA 0% France AA 0-20% Japan A+ 20%"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#emerging-market-sovereigns","title":"Emerging Market Sovereigns","text":"Rating Category Examples Typical RW Investment Grade China, India 20-100% Non-Investment Grade Various 100-150% High Risk Distressed 150%"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#central-bank-exposures","title":"Central Bank Exposures","text":""},{"location":"user-guide/exposure-classes/central-govt-central-bank/#treatment_1","title":"Treatment","text":"<p>Central bank exposures receive the same treatment as their sovereign:</p> Central Bank Sovereign Link Risk Weight Bank of England UK Government 0% European Central Bank Per member state or EU 0% Federal Reserve US Government 0-20%"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#reserves-held","title":"Reserves Held","text":"<p>Reserves held with central banks: <pre><code>if exposure.type == \"CENTRAL_BANK_RESERVE\":\n    risk_weight = sovereign_risk_weight  # Same as sovereign\n</code></pre></p>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#multilateral-development-banks","title":"Multilateral Development Banks","text":""},{"location":"user-guide/exposure-classes/central-govt-central-bank/#eligible-mdbs-0-rw","title":"Eligible MDBs (0% RW)","text":"Institution Abbreviation International Bank for Reconstruction and Development IBRD International Finance Corporation IFC Inter-American Development Bank IADB Asian Development Bank ADB African Development Bank AfDB European Bank for Reconstruction and Development EBRD European Investment Bank EIB European Investment Fund EIF Nordic Investment Bank NIB Council of Europe Development Bank CEB Islamic Development Bank IsDB Asian Infrastructure Investment Bank AIIB"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#other-mdbs","title":"Other MDBs","text":"<p>Non-eligible MDBs treated as institutions: <pre><code>if mdb in ELIGIBLE_MDB_LIST:\n    risk_weight = 0.00\nelse:\n    # Treat as institution\n    risk_weight = institution_risk_weight(cqs)\n</code></pre></p>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#crm-for-sovereign-exposures","title":"CRM for Sovereign Exposures","text":""},{"location":"user-guide/exposure-classes/central-govt-central-bank/#sovereign-guarantees","title":"Sovereign Guarantees","text":"<p>Exposures guaranteed by eligible sovereigns use substitution:</p> <pre><code># Guaranteed portion at guarantor sovereign RW\nif guarantee.type == \"SOVEREIGN\" and guarantee.cqs &lt;= 3:\n    guaranteed_rw = sovereign_risk_weight(guarantee.cqs)\n</code></pre>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#sovereign-collateral","title":"Sovereign Collateral","text":"<p>Government bonds as collateral receive low haircuts:</p> Collateral (CQS 1 Sovereign) Maturity Haircut Government bonds \u22641 year 0.5% Government bonds 1-5 years 2% Government bonds &gt;5 years 4%"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#calculation-example","title":"Calculation Example","text":"<p>Exposure: - \u00a3100m UK Gilt holding - UK Government (CQS 1)</p> <p>SA Calculation: <pre><code># Sovereign CQS 1 = 0% RW\nRisk_Weight = 0%\nEAD = \u00a3100,000,000\nRWA = \u00a3100,000,000 \u00d7 0% = \u00a30\n</code></pre></p> <p>Foreign Sovereign Example: - \u00a350m German Bund - Germany (AAA, CQS 1)</p> <pre><code>Risk_Weight = 0%\nRWA = \u00a350,000,000 \u00d7 0% = \u00a30\n</code></pre> <p>Lower-rated Sovereign: - \u00a320m Brazil bonds - Brazil (BB-, CQS 4)</p> <pre><code>Risk_Weight = 100%\nRWA = \u00a320,000,000 \u00d7 100% = \u00a320,000,000\n</code></pre>"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE Sovereign definition Art. 114 CRE20.7-10 Risk weights Art. 114 CRE20.11 MDB treatment Art. 117 CRE20.12-14 Central bank treatment Art. 114(4) CRE20.8"},{"location":"user-guide/exposure-classes/central-govt-central-bank/#next-steps","title":"Next Steps","text":"<ul> <li>Institution Exposures</li> <li>Standardised Approach</li> <li>IRB Approach</li> </ul>"},{"location":"user-guide/exposure-classes/corporate/","title":"Corporate Exposures","text":"<p>Corporate exposures are claims on companies that do not qualify as sovereigns, institutions, or retail. This includes large corporates, SMEs, and specialised lending.</p>"},{"location":"user-guide/exposure-classes/corporate/#definition","title":"Definition","text":"<p>Corporate exposures include:</p> Entity Type Description Large corporates Companies with turnover &gt; EUR 50m Corporate SMEs Companies with turnover \u2264 EUR 50m Unincorporated businesses Partnerships, sole traders (non-retail) Non-profit organisations Charities, associations Special purpose vehicles SPVs not qualifying as specialised lending"},{"location":"user-guide/exposure-classes/corporate/#sme-definition","title":"SME Definition","text":"<p>An entity qualifies as an SME if:</p> Criterion Threshold (EUR) Threshold (GBP @ 0.88) Annual turnover \u2264 EUR 50m \u2264 GBP 44m OR Total assets \u2264 EUR 43m \u2264 GBP 37.84m <pre><code>def is_sme(counterparty):\n    return (\n        counterparty.annual_turnover &lt;= 50_000_000 or  # EUR\n        counterparty.total_assets &lt;= 43_000_000         # EUR\n    )\n</code></pre>"},{"location":"user-guide/exposure-classes/corporate/#risk-weights-sa","title":"Risk Weights (SA)","text":""},{"location":"user-guide/exposure-classes/corporate/#rated-corporates","title":"Rated Corporates","text":"CQS S&amp;P/Fitch Moody's CRR Basel 3.1 CQS 1 AAA to AA- Aaa to Aa3 20% 20% CQS 2 A+ to A- A1 to A3 50% 50% CQS 3 BBB+ to BBB- Baa1 to Baa3 75% 75% CQS 4 BB+ to BB- Ba1 to Ba3 100% 100% CQS 5 B+ to B- B1 to B3 150% 100% CQS 6 CCC+ and below Caa1 and below 150% 150%"},{"location":"user-guide/exposure-classes/corporate/#unrated-corporates","title":"Unrated Corporates","text":"Framework Risk Weight CRR 100% Basel 3.1 100% <p>Investment Grade</p> <p>Basel 3.1 introduces an \"investment grade\" corporate category with potentially lower risk weights for qualifying unrated corporates meeting specific criteria.</p>"},{"location":"user-guide/exposure-classes/corporate/#irb-treatment","title":"IRB Treatment","text":""},{"location":"user-guide/exposure-classes/corporate/#f-irb-parameters","title":"F-IRB Parameters","text":"Parameter Source Value PD Bank estimate Floor 0.03% (CRR) / 0.05% (Basel 3.1) LGD Supervisory 45% (senior), 75% (subordinated) M Effective maturity 1-5 years"},{"location":"user-guide/exposure-classes/corporate/#a-irb-parameters","title":"A-IRB Parameters","text":"Parameter Source Basel 3.1 Restrictions PD Bank estimate Floor 0.05% LGD Bank estimate Floor 25% (unsecured) EAD Bank estimate CCF floors apply <p>Large Corporate Restriction</p> <p>Under Basel 3.1, corporates with consolidated revenues &gt; EUR 500m (GBP 440m) are restricted to F-IRB only. A-IRB is no longer permitted for these exposures.</p>"},{"location":"user-guide/exposure-classes/corporate/#correlation","title":"Correlation","text":"<p>Standard Corporate: <pre><code>R = 0.12 \u00d7 (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50)) +\n    0.24 \u00d7 [1 - (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50))]\n</code></pre></p> <p>SME Correlation Adjustment: <pre><code># Size adjustment for corporates with turnover \u00a35m-\u00a350m\nS = min(50, max(5, turnover_millions))\nadjustment = 0.04 \u00d7 (1 - (S - 5) / 45)\nR_sme = R - adjustment\n</code></pre></p> Turnover (\u00a3m) Correlation Reduction 5 4.0 pp 15 3.1 pp 25 2.2 pp 35 1.3 pp 45 0.4 pp \u226550 0.0 pp"},{"location":"user-guide/exposure-classes/corporate/#sme-supporting-factor-crr-only","title":"SME Supporting Factor (CRR Only)","text":""},{"location":"user-guide/exposure-classes/corporate/#eligibility","title":"Eligibility","text":"<ul> <li>Counterparty is SME (turnover \u2264 EUR 50m)</li> <li>Exposure class: Corporate, Corporate SME, or secured by RE</li> <li>Not in default</li> </ul>"},{"location":"user-guide/exposure-classes/corporate/#tiered-calculation","title":"Tiered Calculation","text":"<pre><code>threshold = EUR_2_500_000  # GBP 2,200,000\n\nif total_exposure &lt;= threshold:\n    factor = 0.7619  # 23.81% reduction\nelse:\n    factor = (threshold \u00d7 0.7619 + (total_exposure - threshold) \u00d7 0.85) / total_exposure\n</code></pre>"},{"location":"user-guide/exposure-classes/corporate/#factor-examples","title":"Factor Examples","text":"Total Exposure Factor RWA Reduction GBP 1m 0.7619 23.81% GBP 2.2m 0.7619 23.81% GBP 5m 0.811 18.9% GBP 10m 0.831 16.9% GBP 50m 0.843 15.7%"},{"location":"user-guide/exposure-classes/corporate/#calculation-examples","title":"Calculation Examples","text":""},{"location":"user-guide/exposure-classes/corporate/#example-1-rated-large-corporate-sa","title":"Example 1: Rated Large Corporate (SA)","text":"<p>Exposure: - \u00a375m term loan to Tesco PLC - Rating: BBB (CQS 3) - Undrawn commitment: \u00a325m</p> <p>Calculation: <pre><code># Drawn portion\nEAD_drawn = \u00a375,000,000\n\n# Undrawn (50% CCF for committed facilities)\nEAD_undrawn = \u00a325,000,000 \u00d7 50% = \u00a312,500,000\n\n# Total EAD\nEAD = \u00a387,500,000\n\n# Risk weight (CQS 3)\nRisk_Weight = 75%\n\n# RWA\nRWA = \u00a387,500,000 \u00d7 75% = \u00a365,625,000\n</code></pre></p>"},{"location":"user-guide/exposure-classes/corporate/#example-2-sme-with-supporting-factor-sa","title":"Example 2: SME with Supporting Factor (SA)","text":"<p>Exposure: - \u00a38m loan to regional SME - Turnover: \u00a330m (qualifies as SME) - Unrated (100% RW)</p> <p>Calculation: <pre><code># Base RWA\nEAD = \u00a38,000,000\nBase_RWA = \u00a38,000,000 \u00d7 100% = \u00a38,000,000\n\n# SME factor (tiered)\nthreshold = \u00a32,200,000\nfactor = (2,200,000 \u00d7 0.7619 + 5,800,000 \u00d7 0.85) / 8,000,000\nfactor = (1,676,180 + 4,930,000) / 8,000,000 = 0.826\n\n# Adjusted RWA (CRR)\nAdjusted_RWA = \u00a38,000,000 \u00d7 0.826 = \u00a36,606,400\n\n# Basel 3.1 (no factor)\nB31_RWA = \u00a38,000,000\n</code></pre></p>"},{"location":"user-guide/exposure-classes/corporate/#example-3-corporate-irb","title":"Example 3: Corporate IRB","text":"<p>Exposure: - \u00a350m corporate loan - Bank PD estimate: 0.75% - F-IRB (LGD = 45%) - Maturity: 4 years - Turnover: \u00a3100m (no SME adjustment)</p> <p>Calculation: <pre><code># Step 1: PD (above floor)\nPD = 0.0075\n\n# Step 2: Correlation\nR = 0.12 \u00d7 (1 - exp(-50 \u00d7 0.0075)) / (1 - exp(-50)) +\n    0.24 \u00d7 (1 - (1 - exp(-50 \u00d7 0.0075)) / (1 - exp(-50)))\nR = 0.12 \u00d7 0.313 + 0.24 \u00d7 0.687 = 0.202\n\n# Step 3: K calculation\nK \u2248 0.0445  # From IRB formula\n\n# Step 4: Maturity adjustment\nb = (0.11852 - 0.05478 \u00d7 ln(0.0075))^2 = 0.149\nMA = (1 + (4 - 2.5) \u00d7 0.149) / (1 - 1.5 \u00d7 0.149) = 1.29\n\n# Step 5: RWA (CRR)\nRWA_CRR = 0.0445 \u00d7 12.5 \u00d7 \u00a350,000,000 \u00d7 1.29 \u00d7 1.06\nRWA_CRR = \u00a338,107,313\n\n# Basel 3.1 (no scaling)\nRWA_B31 = \u00a335,950,295\n</code></pre></p>"},{"location":"user-guide/exposure-classes/corporate/#example-4-sme-corporate-irb","title":"Example 4: SME Corporate IRB","text":"<p>Exposure: - \u00a315m loan - PD: 1.5% - F-IRB (LGD = 45%) - Maturity: 3 years - Turnover: \u00a320m (SME)</p> <p>Calculation: <pre><code># SME correlation adjustment\nS = 20\nR_base = 0.179\nadjustment = 0.04 \u00d7 (1 - (20 - 5) / 45) = 0.027\nR_sme = 0.179 - 0.027 = 0.152\n\n# Results in lower K, lower RWA\n# Plus SME Supporting Factor on final RWA (CRR)\n</code></pre></p>"},{"location":"user-guide/exposure-classes/corporate/#subordinated-debt","title":"Subordinated Debt","text":"Instrument Type CRR Treatment Basel 3.1 Senior unsecured Standard corporate RW Standard Subordinated debt Corporate RW + premium 150% Mezzanine Corporate RW + premium 150% Equity-like 150% 250%"},{"location":"user-guide/exposure-classes/corporate/#crm-for-corporates","title":"CRM for Corporates","text":""},{"location":"user-guide/exposure-classes/corporate/#eligible-collateral","title":"Eligible Collateral","text":"Collateral Type SA F-IRB LGD Cash 0% Government bonds 0% Corporate bonds Varies Listed equity Varies Real estate 35% Receivables 35% Other physical Limited 40%"},{"location":"user-guide/exposure-classes/corporate/#guarantees","title":"Guarantees","text":"<p>Corporate exposures can benefit from guarantees by: - Sovereigns (0% if CQS 1) - Institutions (if better rated) - Parent companies (under conditions)</p>"},{"location":"user-guide/exposure-classes/corporate/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE Corporate definition Art. 122 CRE20.35-40 Risk weights Art. 122 CRE20.41-45 SME definition Art. 501(2) N/A SME factor Art. 501 N/A IRB corporate Art. 153 CRE31 Correlation Art. 153(3) CRE31.5"},{"location":"user-guide/exposure-classes/corporate/#next-steps","title":"Next Steps","text":"<ul> <li>Retail Exposures</li> <li>Supporting Factors</li> <li>IRB Approach</li> </ul>"},{"location":"user-guide/exposure-classes/institution/","title":"Institution Exposures","text":"<p>Institution exposures are claims on banks, investment firms, and other regulated financial institutions.</p>"},{"location":"user-guide/exposure-classes/institution/#definition","title":"Definition","text":"<p>Institution exposures include:</p> Entity Type Description Credit institutions Banks, building societies Investment firms Broker-dealers, asset managers Central counterparties (CCPs) Clearing houses Financial holding companies Bank holding companies Insurance companies Subject to certain conditions"},{"location":"user-guide/exposure-classes/institution/#risk-weights-sa","title":"Risk Weights (SA)","text":""},{"location":"user-guide/exposure-classes/institution/#external-credit-risk-assessment-approach-ecra","title":"External Credit Risk Assessment Approach (ECRA)","text":"CQS S&amp;P/Fitch Moody's CRR Risk Weight Basel 3.1 CQS 1 AAA to AA- Aaa to Aa3 20% 20% CQS 2 A+ to A- A1 to A3 30%* 30% CQS 3 BBB+ to BBB- Baa1 to Baa3 50% 50% CQS 4 BB+ to BB- Ba1 to Ba3 100% 100% CQS 5 B+ to B- B1 to B3 100% 100% CQS 6 CCC+ and below Caa1 and below 150% 150% <p>*UK deviation: CQS 2 receives 30% RW instead of standard Basel 50%</p>"},{"location":"user-guide/exposure-classes/institution/#unrated-institutions","title":"Unrated Institutions","text":"<p>CRR: Apply due diligence assessment Basel 3.1: Use Standardised Credit Risk Assessment Approach (SCRA)</p>"},{"location":"user-guide/exposure-classes/institution/#scra-basel-31","title":"SCRA (Basel 3.1)","text":"Grade Criteria Risk Weight A CET1 &gt; 14%, Leverage &gt; 5%, meets requirements 40% B CET1 &gt; 5.5%, Leverage &gt; 3%, meets minimums 75% C Below minimum requirements 150% <pre><code># SCRA classification\nif cet1_ratio &gt; 0.14 and leverage_ratio &gt; 0.05:\n    scra_grade = \"A\"\n    risk_weight = 0.40\nelif cet1_ratio &gt; 0.055 and leverage_ratio &gt; 0.03:\n    scra_grade = \"B\"\n    risk_weight = 0.75\nelse:\n    scra_grade = \"C\"\n    risk_weight = 1.50\n</code></pre>"},{"location":"user-guide/exposure-classes/institution/#irb-treatment","title":"IRB Treatment","text":""},{"location":"user-guide/exposure-classes/institution/#f-irb-parameters","title":"F-IRB Parameters","text":"Parameter Source Value PD Bank estimate Floor 0.03% (CRR) / 0.05% (Basel 3.1) LGD Supervisory 45% (senior), 75% (subordinated) M Effective maturity 1-5 years"},{"location":"user-guide/exposure-classes/institution/#a-irb-restrictions","title":"A-IRB Restrictions","text":"<p>Basel 3.1</p> <p>A-IRB is no longer permitted for institution exposures under Basel 3.1. Only SA or F-IRB may be used.</p>"},{"location":"user-guide/exposure-classes/institution/#correlation","title":"Correlation","text":"<pre><code># Institution correlation (same as corporate)\nR = 0.12 \u00d7 (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50)) +\n    0.24 \u00d7 [1 - (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50))]\n</code></pre>"},{"location":"user-guide/exposure-classes/institution/#short-term-exposures","title":"Short-Term Exposures","text":"<p>Exposures with original maturity \u2264 3 months may receive preferential treatment:</p> CQS Standard RW Short-Term RW CQS 1 20% 20% CQS 2 30% 20% CQS 3 50% 20% CQS 4-6 100-150% 50% <p>Eligibility: - Original maturity \u2264 3 months - Funded in domestic currency - Cleared through domestic payments system</p>"},{"location":"user-guide/exposure-classes/institution/#interbank-exposures","title":"Interbank Exposures","text":""},{"location":"user-guide/exposure-classes/institution/#due-from-banks","title":"Due From Banks","text":"Exposure Type Treatment Nostro balances Standard institution RW Interbank loans Standard institution RW Money market placements May qualify for short-term Repo/reverse repo CRM treatment may apply"},{"location":"user-guide/exposure-classes/institution/#trade-finance","title":"Trade Finance","text":"Item CCF Risk Weight Documentary credits 20% Institution RW Standby LCs 50-100% Institution RW Guarantees 100% Institution RW"},{"location":"user-guide/exposure-classes/institution/#covered-bonds","title":"Covered Bonds","text":"<p>Covered bonds issued by institutions receive preferential treatment:</p> CQS of Covered Bond Risk Weight CQS 1 10% CQS 2 20% CQS 3 20% CQS 4-6 50% Unrated 50% <p>Eligibility criteria: - Issued by eligible credit institution - Subject to special public supervision - Backed by qualifying assets (mortgages, PSE exposures) - Overcollateralization requirements met</p>"},{"location":"user-guide/exposure-classes/institution/#central-counterparties-ccps","title":"Central Counterparties (CCPs)","text":""},{"location":"user-guide/exposure-classes/institution/#qualifying-ccps-qccps","title":"Qualifying CCPs (QCCPs)","text":"Exposure Type Risk Weight Trade exposures 2% Default fund contributions Risk-sensitive calculation"},{"location":"user-guide/exposure-classes/institution/#non-qccps","title":"Non-QCCPs","text":"Exposure Type Treatment Trade exposures Bilateral institution RW Default fund contributions 1250% (or deduction)"},{"location":"user-guide/exposure-classes/institution/#crm-for-institutions","title":"CRM for Institutions","text":""},{"location":"user-guide/exposure-classes/institution/#bank-guarantees","title":"Bank Guarantees","text":"<p>Exposures guaranteed by better-rated institutions:</p> <pre><code>if guarantee.type == \"INSTITUTION\" and guarantee.cqs &lt; counterparty.cqs:\n    # Substitution approach\n    guaranteed_rw = institution_risk_weight(guarantee.cqs)\n</code></pre>"},{"location":"user-guide/exposure-classes/institution/#bank-collateral","title":"Bank Collateral","text":"<p>Bonds issued by institutions as collateral:</p> Collateral Rating Haircut (1-5yr) CQS 1-2 4% CQS 3 6% CQS 4+ Not eligible"},{"location":"user-guide/exposure-classes/institution/#calculation-examples","title":"Calculation Examples","text":"<p>Example 1: Rated Bank - \u00a325m placement with Deutsche Bank - Rating: A+ (CQS 2) - Maturity: 6 months</p> <pre><code># CQS 2 institution under CRR\nRisk_Weight = 30%  # UK deviation\nEAD = \u00a325,000,000\nRWA = \u00a325,000,000 \u00d7 30% = \u00a37,500,000\n</code></pre> <p>Example 2: Unrated Bank (Basel 3.1) - \u00a310m loan to regional bank - No external rating - SCRA assessment: CET1 = 16%, Leverage = 6%</p> <pre><code># SCRA Grade A\nRisk_Weight = 40%\nRWA = \u00a310,000,000 \u00d7 40% = \u00a34,000,000\n</code></pre> <p>Example 3: Short-Term - \u00a350m overnight placement - Counterparty: CQS 3 bank - Original maturity: 1 day</p> <pre><code># Short-term preferential treatment\nRisk_Weight = 20%  # vs. standard 50%\nRWA = \u00a350,000,000 \u00d7 20% = \u00a310,000,000\n</code></pre>"},{"location":"user-guide/exposure-classes/institution/#subordinated-debt","title":"Subordinated Debt","text":"<p>Exposures to subordinated debt of institutions:</p> Instrument Type CRR Basel 3.1 Tier 2 instruments Institution RW + premium 150% AT1 instruments Institution RW + premium 150% Equity-like 150% 250%"},{"location":"user-guide/exposure-classes/institution/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE Institution definition Art. 119 CRE20.15-20 Risk weights Art. 119-121 CRE20.21-25 Short-term treatment Art. 119(2) CRE20.26 Covered bonds Art. 129 CRE20.27-30 CCPs Art. 300-311 CRE54"},{"location":"user-guide/exposure-classes/institution/#next-steps","title":"Next Steps","text":"<ul> <li>Corporate Exposures</li> <li>Standardised Approach</li> <li>Credit Risk Mitigation</li> </ul>"},{"location":"user-guide/exposure-classes/other/","title":"Other Exposure Classes","text":"<p>This page covers exposure classes not detailed in previous sections: Equity, Defaulted, PSE, MDB, RGLA, and other specialized categories.</p>"},{"location":"user-guide/exposure-classes/other/#equity-exposures","title":"Equity Exposures","text":""},{"location":"user-guide/exposure-classes/other/#definition","title":"Definition","text":"<p>Equity exposures include: - Direct equity holdings - Investments in funds - Private equity - Venture capital investments - Subordinated debt with equity characteristics</p>"},{"location":"user-guide/exposure-classes/other/#sa-risk-weights","title":"SA Risk Weights","text":"Type CRR Basel 3.1 Exchange-traded equities 100% 100% Other listed equities 100% 100% Private equity / Venture capital 150% 400% Speculative investments 150% 400%"},{"location":"user-guide/exposure-classes/other/#irb-treatment","title":"IRB Treatment","text":"<p>Basel 3.1</p> <p>IRB approaches for equity are removed under Basel 3.1. Only SA is permitted.</p> <p>CRR IRB Options:</p> Approach Description Minimum RW Simple Fixed risk weights 190-370% PD/LGD Use corporate formula 200% Internal models VaR-based 200% <p>Simple Risk Weight Approach:</p> Equity Type Risk Weight Exchange-traded 190% Other 290% Private equity 370%"},{"location":"user-guide/exposure-classes/other/#calculation-example","title":"Calculation Example","text":"<p>Exposure: - \u00a310m listed equity portfolio - Mix of exchange-traded and private equity</p> <p>CRR (Simple Approach): <pre><code># Exchange-traded: \u00a37m\nRWA_exchange = \u00a37,000,000 \u00d7 190% = \u00a313,300,000\n\n# Private equity: \u00a33m\nRWA_private = \u00a33,000,000 \u00d7 370% = \u00a311,100,000\n\n# Total\nTotal_RWA = \u00a324,400,000\n</code></pre></p> <p>Basel 3.1: <pre><code># Exchange-traded: \u00a37m\nRWA_exchange = \u00a37,000,000 \u00d7 100% = \u00a37,000,000\n\n# Private equity: \u00a33m\nRWA_private = \u00a33,000,000 \u00d7 400% = \u00a312,000,000\n\n# Total\nTotal_RWA = \u00a319,000,000\n</code></pre></p>"},{"location":"user-guide/exposure-classes/other/#defaulted-exposures","title":"Defaulted Exposures","text":""},{"location":"user-guide/exposure-classes/other/#definition_1","title":"Definition","text":"<p>An exposure is classified as defaulted when: - Past due &gt; 90 days on a material amount - Unlikely to pay in full without recourse to collateral - Subject to distressed restructuring - Bankruptcy or insolvency proceedings initiated - Similar credit quality deterioration</p>"},{"location":"user-guide/exposure-classes/other/#sa-risk-weights_1","title":"SA Risk Weights","text":"Provision Coverage CRR Basel 3.1 &lt; 20% 150% 150% 20% - 50% 100% 100% \u2265 50% 100% 50-100% <p>Basel 3.1 High Coverage: - \u226550% specific provisions: 50% RW for secured portion - Unsecured portion: 100% RW</p>"},{"location":"user-guide/exposure-classes/other/#irb-treatment_1","title":"IRB Treatment","text":"<p>For defaulted exposures under IRB: - PD = 100% - LGD = \"best estimate LGD\" (ELGD) - Expected Loss = LGD \u00d7 EAD</p> <pre><code># Defaulted exposure IRB\nPD = 1.00  # 100%\nLGD = best_estimate_lgd  # Bank's expectation of loss\nEL = LGD \u00d7 EAD\n\n# K formula still applies but with PD = 100%\n# Results in RWA reflecting unexpected loss only\n</code></pre>"},{"location":"user-guide/exposure-classes/other/#calculation-example_1","title":"Calculation Example","text":"<p>Exposure: - \u00a35m defaulted corporate loan - Specific provision: \u00a31.5m (30% coverage) - Collateral value: \u00a32m</p> <p>SA Calculation: <pre><code># Net exposure\nNet_EAD = \u00a35,000,000 - \u00a31,500,000 = \u00a33,500,000\n\n# Provision coverage 30% \u2192 100% RW\nRisk_Weight = 100%\n\nRWA = \u00a33,500,000 \u00d7 100% = \u00a33,500,000\n</code></pre></p>"},{"location":"user-guide/exposure-classes/other/#public-sector-entities-pse","title":"Public Sector Entities (PSE)","text":""},{"location":"user-guide/exposure-classes/other/#definition_2","title":"Definition","text":"<p>PSEs are non-commercial administrative bodies: - Regional governments - Local authorities - Administrative bodies - Enterprises owned by governments</p>"},{"location":"user-guide/exposure-classes/other/#treatment-options","title":"Treatment Options","text":"PSE Type Treatment Central government-like Sovereign treatment Regional/Local government Institution or sovereign treatment Other PSE Institution treatment"},{"location":"user-guide/exposure-classes/other/#risk-weights","title":"Risk Weights","text":"<p>Depends on treatment option elected:</p> Option Basis Risk Weights Sovereign Parent sovereign rating 0-150% Institution PSE's own rating 20-150% <p>UK Regional Governments: - Scottish Government - Welsh Government - Northern Ireland Executive - Typically treated as sovereign (0% RW)</p>"},{"location":"user-guide/exposure-classes/other/#calculation-example_2","title":"Calculation Example","text":"<p>Exposure: - \u00a350m loan to Transport for London - Treated as PSE with institution option - Rating: AA (CQS 1)</p> <pre><code># Institution treatment, CQS 1\nRisk_Weight = 20%\nRWA = \u00a350,000,000 \u00d7 20% = \u00a310,000,000\n</code></pre>"},{"location":"user-guide/exposure-classes/other/#multilateral-development-banks-mdb","title":"Multilateral Development Banks (MDB)","text":""},{"location":"user-guide/exposure-classes/other/#eligible-mdbs-0-rw","title":"Eligible MDBs (0% RW)","text":"Institution Countries/Region World Bank (IBRD, IDA) Global European Investment Bank (EIB) EU Asian Development Bank (ADB) Asia-Pacific African Development Bank (AfDB) Africa Inter-American Development Bank (IADB) Americas European Bank for Reconstruction (EBRD) Europe/Asia Asian Infrastructure Investment Bank (AIIB) Asia Islamic Development Bank (IsDB) Islamic countries Nordic Investment Bank (NIB) Nordic region Council of Europe Development Bank (CEB) Europe"},{"location":"user-guide/exposure-classes/other/#non-eligible-mdbs","title":"Non-Eligible MDBs","text":"<p>Treated as institutions with applicable risk weight.</p>"},{"location":"user-guide/exposure-classes/other/#calculation-example_3","title":"Calculation Example","text":"<p>Exposure: - \u00a325m bond issued by World Bank</p> <pre><code># Eligible MDB = 0% RW\nRisk_Weight = 0%\nRWA = \u00a325,000,000 \u00d7 0% = \u00a30\n</code></pre>"},{"location":"user-guide/exposure-classes/other/#regional-governments-and-local-authorities-rgla","title":"Regional Governments and Local Authorities (RGLA)","text":""},{"location":"user-guide/exposure-classes/other/#treatment","title":"Treatment","text":"<p>RGLAs can receive: - Sovereign treatment (if explicitly guaranteed) - PSE treatment (based on characteristics) - Institution treatment (default)</p>"},{"location":"user-guide/exposure-classes/other/#uk-rglas","title":"UK RGLAs","text":"Entity Typical Treatment Scottish Government Sovereign-like Welsh Government Sovereign-like English local authorities PSE/Institution Housing associations Corporate/PSE"},{"location":"user-guide/exposure-classes/other/#international-organisations","title":"International Organisations","text":""},{"location":"user-guide/exposure-classes/other/#0-risk-weight","title":"0% Risk Weight","text":"Organisation European Union International Monetary Fund (IMF) Bank for International Settlements (BIS) European Stability Mechanism (ESM)"},{"location":"user-guide/exposure-classes/other/#calculation-example_4","title":"Calculation Example","text":"<p>Exposure: - \u00a3100m deposit with BIS</p> <pre><code># International organisation = 0% RW\nRisk_Weight = 0%\nRWA = \u00a3100,000,000 \u00d7 0% = \u00a30\n</code></pre>"},{"location":"user-guide/exposure-classes/other/#covered-bonds","title":"Covered Bonds","text":""},{"location":"user-guide/exposure-classes/other/#definition_3","title":"Definition","text":"<p>Debt securities secured by a dedicated pool of assets (cover pool): - Residential mortgages - Public sector exposures - Ship mortgages</p>"},{"location":"user-guide/exposure-classes/other/#risk-weights_1","title":"Risk Weights","text":"CQS of Covered Bond Risk Weight CQS 1 10% CQS 2 20% CQS 3 20% CQS 4-6 50% Unrated 50%"},{"location":"user-guide/exposure-classes/other/#eligibility-requirements","title":"Eligibility Requirements","text":"<ul> <li>Issued by credit institution in EEA/equivalent</li> <li>Subject to special public supervision</li> <li>Cover pool meets quality requirements</li> <li>Overcollateralization of at least 5%</li> </ul>"},{"location":"user-guide/exposure-classes/other/#securitisation-positions","title":"Securitisation Positions","text":""},{"location":"user-guide/exposure-classes/other/#definition_4","title":"Definition","text":"<p>Exposures to tranched credit risk: - Asset-backed securities - Mortgage-backed securities - Collateralized loan obligations</p>"},{"location":"user-guide/exposure-classes/other/#treatment_1","title":"Treatment","text":"<p>Securitisation has dedicated rules (outside scope of this calculator): - SEC-IRBA (IRB approach) - SEC-SA (Standardised approach) - SEC-ERBA (External ratings-based)</p>"},{"location":"user-guide/exposure-classes/other/#items-associated-with-high-risk","title":"Items Associated with High Risk","text":""},{"location":"user-guide/exposure-classes/other/#categories","title":"Categories","text":"Type Risk Weight Private equity (Basel 3.1) 400% Speculative RE financing 150% Venture capital investments 400% Speculative unlisted equity 400%"},{"location":"user-guide/exposure-classes/other/#other-items","title":"Other Items","text":""},{"location":"user-guide/exposure-classes/other/#tangible-assets","title":"Tangible Assets","text":"Item Risk Weight Property, plant &amp; equipment 100% Other tangible assets 100%"},{"location":"user-guide/exposure-classes/other/#deferred-tax-assets","title":"Deferred Tax Assets","text":"Type Treatment DTAs from temporary differences 250% RW or deduction DTAs from tax loss carry-forward Deduction"},{"location":"user-guide/exposure-classes/other/#cash-items-in-collection","title":"Cash Items in Collection","text":"Item Risk Weight Cash in collection 20% Items in process 100%"},{"location":"user-guide/exposure-classes/other/#summary-table","title":"Summary Table","text":"Exposure Class SA RW Range IRB Available Equity (exchange) 100% No (Basel 3.1) Equity (private) 150-400% No (Basel 3.1) Defaulted 50-150% Yes PSE 0-150% Yes MDB (eligible) 0% N/A RGLA 0-150% Yes International Org 0% N/A Covered Bonds 10-50% Varies High Risk Items 150-400% Varies"},{"location":"user-guide/exposure-classes/other/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE Equity Art. 133 CRE20.60-65 Defaulted Art. 127 CRE20.80-85 PSE Art. 115-116 CRE20.15-20 MDB Art. 117 CRE20.12-14 RGLA Art. 115 CRE20.8-10 Covered bonds Art. 129 CRE20.27-30 High risk Art. 128 CRE20.90"},{"location":"user-guide/exposure-classes/other/#next-steps","title":"Next Steps","text":"<ul> <li>Exposure Classes Overview</li> <li>Standardised Approach</li> <li>Configuration Guide</li> </ul>"},{"location":"user-guide/exposure-classes/retail/","title":"Retail Exposures","text":"<p>Retail exposures are claims on individuals or small businesses that meet specific criteria for size, product type, and portfolio management.</p>"},{"location":"user-guide/exposure-classes/retail/#definition","title":"Definition","text":"<p>Retail exposures must meet ALL of the following criteria:</p> Criterion Requirement Counterparty Individual or small business Product Revolving credit, personal loans, mortgages, or small business facilities Size Total exposure \u2264 EUR 1m (GBP 880k) Management Managed as part of a portfolio with similar characteristics <p>Conceptual Logic</p> <p>The following illustrates the retail classification decision logic. For the actual implementation, see <code>classifier.py:285-392</code>.</p> <pre><code># Conceptual overview - actual implementation in ExposureClassifier._apply_retail_classification\ndef is_retail(exposure, counterparty, lending_group_adjusted_exposure):\n    return (\n        counterparty.type in [\"individual\", \"retail\", \"small_business\"] and\n        lending_group_adjusted_exposure &lt;= 1_000_000 and  # EUR threshold\n        is_managed_as_retail_pool(exposure)  # cp_is_managed_as_retail flag\n    )\n</code></pre> Actual Implementation (classifier.py) <pre><code>        \"\"\"\n        return exposures.with_columns([\n            # SA exposure class (used for SA risk weight lookup)\n            pl.col(\"cp_entity_type\")\n            .replace_strict(ENTITY_TYPE_TO_SA_CLASS, default=ExposureClass.OTHER.value)\n            .alias(\"exposure_class_sa\"),\n\n            # IRB exposure class (used for IRB formula selection)\n            # Note: PSE/RGLA map to sovereign or institution based on entity_type suffix\n            # MDB/international_org map to sovereign for IRB\n            pl.col(\"cp_entity_type\")\n            .replace_strict(ENTITY_TYPE_TO_IRB_CLASS, default=ExposureClass.OTHER.value)\n            .alias(\"exposure_class_irb\"),\n\n            # Unified exposure_class (SA class for backwards compatibility)\n            pl.col(\"cp_entity_type\")\n            .replace_strict(ENTITY_TYPE_TO_SA_CLASS, default=ExposureClass.OTHER.value)\n            .alias(\"exposure_class\"),\n        ])\n\n    def _apply_sme_classification(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply SME classification for corporate exposures.\n\n        SME criteria (CRR Art. 501):\n        - Annual revenue &lt; EUR 50m (GBP 44m at 0.88 FX rate)\n        - Only applies to corporates\n\n        CRR uses EUR thresholds, Basel 3.1 uses GBP.\n        \"\"\"\n        # Convert EUR threshold to GBP\n        sme_threshold_gbp = float(\n            config.supporting_factors.sme_turnover_threshold_eur * config.eur_gbp_rate\n        )\n\n        return exposures.with_columns([\n            # SME flag\n            pl.when(\n                (pl.col(\"exposure_class\") == ExposureClass.CORPORATE.value) &amp;\n                (pl.col(\"cp_annual_revenue\") &lt; sme_threshold_gbp) &amp;\n                (pl.col(\"cp_annual_revenue\") &gt; 0)  # Exclude missing/zero revenue\n            ).then(pl.lit(True))\n            .otherwise(pl.lit(False))\n            .alias(\"is_sme\"),\n\n            # Update exposure class for SME corporates\n            pl.when(\n                (pl.col(\"exposure_class\") == ExposureClass.CORPORATE.value) &amp;\n                (pl.col(\"cp_annual_revenue\") &lt; sme_threshold_gbp) &amp;\n                (pl.col(\"cp_annual_revenue\") &gt; 0)\n            ).then(pl.lit(ExposureClass.CORPORATE_SME.value))\n            .otherwise(pl.col(\"exposure_class\"))\n            .alias(\"exposure_class\"),\n        ])\n</code></pre>"},{"location":"user-guide/exposure-classes/retail/#retail-sub-classes","title":"Retail Sub-Classes","text":"Sub-Class Description IRB Correlation Retail Mortgage Residential mortgages 15% Retail QRRE Qualifying revolving retail 4% Retail Other All other retail 3-16%"},{"location":"user-guide/exposure-classes/retail/#retail-mortgage","title":"Retail Mortgage","text":""},{"location":"user-guide/exposure-classes/retail/#definition_1","title":"Definition","text":"<p>Exposures secured by residential property that is or will be: - Occupied by the borrower, OR - Rented out</p>"},{"location":"user-guide/exposure-classes/retail/#sa-risk-weights-crr","title":"SA Risk Weights (CRR)","text":"Criterion Risk Weight LTV \u2264 80%, performing 35% LTV &gt; 80% 75% Non-performing 100%"},{"location":"user-guide/exposure-classes/retail/#sa-risk-weights-basel-31","title":"SA Risk Weights (Basel 3.1)","text":"<p>Whole Loan Approach:</p> LTV Risk Weight \u2264 50% 20% 50-60% 25% 60-70% 30% 70-80% 40% 80-90% 50% 90-100% 70% &gt; 100% Counterparty RW <p>Income-Producing (Buy-to-Let):</p> LTV Risk Weight \u2264 50% 30% 50-60% 35% 60-70% 45% 70-80% 60% 80-90% 75% 90-100% 105% &gt; 100% Counterparty RW"},{"location":"user-guide/exposure-classes/retail/#irb-treatment","title":"IRB Treatment","text":"<p>Parameters: - PD: Bank estimate (floor 0.03% CRR / 0.05% Basel 3.1) - LGD: Bank estimate (floor 10% Basel 3.1) - Correlation: 15% (fixed)</p> <pre><code># Retail mortgage correlation (fixed)\nR = 0.15\n</code></pre> <p>No maturity adjustment for retail exposures.</p>"},{"location":"user-guide/exposure-classes/retail/#qrre-qualifying-revolving-retail-exposures","title":"QRRE (Qualifying Revolving Retail Exposures)","text":""},{"location":"user-guide/exposure-classes/retail/#definition_2","title":"Definition","text":"<p>To qualify as QRRE, ALL criteria must be met:</p> Criterion Requirement Counterparty Individual (not corporate) Product Revolving credit line Maximum limit \u2264 EUR 100,000 Security Unsecured Cancellability Unconditionally cancellable <p>Examples: - Credit cards - Personal overdrafts - Revolving personal lines</p>"},{"location":"user-guide/exposure-classes/retail/#sa-risk-weight","title":"SA Risk Weight","text":"Framework Risk Weight CRR 75% Basel 3.1 45-75% (depends on transactor/revolver status) <p>Basel 3.1 Transactor/Revolver:</p> Type Definition Risk Weight Transactor Pays full balance monthly 45% Revolver Carries balance 75%"},{"location":"user-guide/exposure-classes/retail/#irb-treatment_1","title":"IRB Treatment","text":"<p>Parameters: - PD: Bank estimate   - Floor: 0.03% (CRR/Basel 3.1 transactor)   - Floor: 0.10% (Basel 3.1 revolver) - LGD: Bank estimate - Correlation: 4% (fixed)</p> <pre><code># QRRE correlation (fixed, low due to diversification)\nR = 0.04\n</code></pre>"},{"location":"user-guide/exposure-classes/retail/#retail-other","title":"Retail Other","text":""},{"location":"user-guide/exposure-classes/retail/#definition_3","title":"Definition","text":"<p>All retail exposures not qualifying as mortgage or QRRE: - Personal loans - Auto finance - Consumer durable financing - Small business facilities (&lt; EUR 1m total exposure)</p>"},{"location":"user-guide/exposure-classes/retail/#sa-risk-weight_1","title":"SA Risk Weight","text":"Framework Risk Weight CRR 75% Basel 3.1 75%"},{"location":"user-guide/exposure-classes/retail/#irb-treatment_2","title":"IRB Treatment","text":"<p>Parameters: - PD: Bank estimate (floor 0.03% CRR / 0.05% Basel 3.1) - LGD: Bank estimate (floor varies by collateral) - Correlation: PD-dependent (3% to 16%)</p> <pre><code># Other retail correlation formula\nR = 0.03 \u00d7 (1 - exp(-35 \u00d7 PD)) / (1 - exp(-35)) +\n    0.16 \u00d7 [1 - (1 - exp(-35 \u00d7 PD)) / (1 - exp(-35))]\n</code></pre> PD Correlation 0.03% 16% 0.5% 12.4% 2% 7.2% 10% 3.6% 20%+ 3%"},{"location":"user-guide/exposure-classes/retail/#calculation-examples","title":"Calculation Examples","text":""},{"location":"user-guide/exposure-classes/retail/#example-1-residential-mortgage-sa","title":"Example 1: Residential Mortgage (SA)","text":"<p>Exposure: - \u00a3250,000 mortgage - Property value: \u00a3350,000 - LTV: 71.4% - Owner-occupied</p> <p>CRR Calculation: <pre><code># LTV \u2264 80%, so 35% RW\nRisk_Weight = 35%\nEAD = \u00a3250,000\nRWA = \u00a3250,000 \u00d7 35% = \u00a387,500\n</code></pre></p> <p>Basel 3.1 Calculation: <pre><code># LTV 70-80% band\nRisk_Weight = 40%\nRWA = \u00a3250,000 \u00d7 40% = \u00a3100,000\n</code></pre></p>"},{"location":"user-guide/exposure-classes/retail/#example-2-credit-card-qrre","title":"Example 2: Credit Card (QRRE)","text":"<p>Exposure: - \u00a315,000 credit limit - \u00a38,000 current balance - Unconditionally cancellable - Revolver (carries balance)</p> <p>CRR Calculation: <pre><code># QRRE 75% RW\n# CCF = 0% for unconditionally cancellable (CRR)\nEAD = \u00a38,000  # Current balance only\nRisk_Weight = 75%\nRWA = \u00a38,000 \u00d7 75% = \u00a36,000\n</code></pre></p> <p>Basel 3.1 Calculation: <pre><code># CCF = 10% for unconditionally cancellable\nUndrawn = \u00a315,000 - \u00a38,000 = \u00a37,000\nEAD = \u00a38,000 + (\u00a37,000 \u00d7 10%) = \u00a38,700\n\n# Revolver = 75% RW\nRisk_Weight = 75%\nRWA = \u00a38,700 \u00d7 75% = \u00a36,525\n</code></pre></p>"},{"location":"user-guide/exposure-classes/retail/#example-3-retail-irb","title":"Example 3: Retail IRB","text":"<p>Exposure: - \u00a350,000 personal loan - Bank PD: 2% - Bank LGD: 40% - \"Other retail\" category</p> <p>Calculation: <pre><code># Correlation (PD = 2%)\nR = 0.03 \u00d7 (1 - exp(-35 \u00d7 0.02)) / (1 - exp(-35)) +\n    0.16 \u00d7 (1 - (1 - exp(-35 \u00d7 0.02)) / (1 - exp(-35)))\nR = 0.072  # 7.2%\n\n# K calculation (no maturity adjustment for retail)\nK \u2248 0.0285\n\n# RWA\nRWA = K \u00d7 12.5 \u00d7 EAD\nRWA = 0.0285 \u00d7 12.5 \u00d7 \u00a350,000\nRWA = \u00a317,813\n\n# Risk Weight equivalent\nRW = 35.6%\n</code></pre></p>"},{"location":"user-guide/exposure-classes/retail/#lending-groups-and-eur-1m-threshold","title":"Lending Groups and EUR 1m Threshold","text":""},{"location":"user-guide/exposure-classes/retail/#retail-lending-groups","title":"Retail Lending Groups","text":"<p>For retail SME exposures, total exposure is calculated across the lending group: - Connected individuals/entities - Common ownership or control - Aggregated for threshold purposes</p>"},{"location":"user-guide/exposure-classes/retail/#residential-property-exclusion-crr-art-123c","title":"Residential Property Exclusion (CRR Art. 123(c))","text":"<p>Important: Exposures secured by residential property are excluded from the EUR 1m threshold calculation when they are assigned to the residential property exposure class under the Standardised Approach.</p> <p>This exclusion applies because: - Per CRR Art. 123(c), exposures \"fully and completely secured on residential property collateral that have been assigned to the exposure class laid down in point (i) of Article 112\" are excluded from the aggregation - This means the collateral value (capped at the exposure amount) is deducted from the total amount owed</p> <p>Key Rules:</p> Approach Residential Property Treatment SA Excluded from EUR 1m threshold; stays as residential mortgage IRB NOT excluded from EUR 1m threshold (per EBA Q&amp;A 2018_4012) <p>Conceptual Logic</p> <p>The following illustrates the residential property exclusion logic. For the actual implementation, see <code>hierarchy.py:692-789</code>.</p> <pre><code># Conceptual overview - actual implementation in HierarchyResolver._calculate_residential_property_coverage\ndef calculate_adjusted_exposure(exposures, residential_collateral):\n    \"\"\"\n    Per CRR Art. 123(c), residential property secured exposures (SA)\n    are excluded from the EUR 1m retail threshold calculation.\n    \"\"\"\n    for exposure in exposures:\n        # Get residential collateral securing this exposure\n        res_collateral_value = residential_collateral.get(exposure.id, 0)\n\n        # Cap at exposure amount (can't exclude more than exposure)\n        exclusion = min(res_collateral_value, exposure.amount)\n\n        # Adjusted exposure for threshold\n        exposure.for_retail_threshold = exposure.amount - exclusion\n\n    return exposures\n</code></pre> Actual Implementation (hierarchy.py) <p>The real implementation uses Polars LazyFrames for efficient processing:</p> <pre><code>        if loan_ref_col is None:\n            # No valid loans, all facilities are 100% undrawn\n            loan_drawn_totals = pl.LazyFrame(schema={\n                \"aggregation_facility\": pl.String,\n                \"total_drawn\": pl.Float64,\n            })\n        else:\n            if type_col is not None:\n                loan_mappings = facility_mappings.filter(\n                    pl.col(type_col).fill_null(\"\").str.to_lowercase() == \"loan\"\n                ).unique(subset=[\"child_reference\", \"parent_facility_reference\"])\n            else:\n                loan_mappings = facility_mappings.unique(\n                    subset=[\"child_reference\", \"parent_facility_reference\"]\n                )\n\n            # Sum drawn amounts by parent facility\n            # Clamp negative drawn amounts to 0 before summing - negative balances\n            # should not increase available undrawn headroom\n            loan_with_parent = loans.join(\n                loan_mappings,\n                left_on=\"loan_reference\",\n                right_on=\"child_reference\",\n                how=\"inner\",\n            )\n\n            # For multi-level hierarchies, map each loan's drawn amount to the ROOT facility\n            if facility_root_lookup is not None and facility_root_lookup.head(1).collect().height &gt; 0:\n                loan_with_parent = loan_with_parent.join(\n                    facility_root_lookup.select([\n                        pl.col(\"child_facility_reference\"),\n                        pl.col(\"root_facility_reference\").alias(\"_root_fac\"),\n                    ]),\n                    left_on=\"parent_facility_reference\",\n                    right_on=\"child_facility_reference\",\n                    how=\"left\",\n                ).with_columns([\n                    pl.coalesce(\n                        pl.col(\"_root_fac\"),\n                        pl.col(\"parent_facility_reference\"),\n                    ).alias(\"aggregation_facility\"),\n                ]).drop(\"_root_fac\")\n            else:\n                loan_with_parent = loan_with_parent.with_columns([\n                    pl.col(\"parent_facility_reference\").alias(\"aggregation_facility\"),\n                ])\n\n            loan_drawn_totals = loan_with_parent.group_by(\"aggregation_facility\").agg([\n                pl.col(\"drawn_amount\").clip(lower_bound=0.0).sum().alias(\"total_drawn\"),\n            ])\n\n        # Calculate contingent utilisation (parallel to loan drawn totals)\n        contingent_ref_col = None\n        if contingents is not None:\n            cont_schema = contingents.collect_schema()\n            if \"contingent_reference\" in cont_schema.names():\n                contingent_ref_col = \"contingent_reference\"\n\n        if contingent_ref_col is None:\n            contingent_totals = pl.LazyFrame(schema={\n                \"aggregation_facility\": pl.String,\n                \"total_contingent\": pl.Float64,\n            })\n        else:\n            # Filter mappings to only contingent children\n            if type_col is not None:\n                contingent_mappings = facility_mappings.filter(\n                    pl.col(type_col).fill_null(\"\").str.to_lowercase() == \"contingent\"\n                ).unique(subset=[\"child_reference\", \"parent_facility_reference\"])\n            else:\n                contingent_mappings = facility_mappings.unique(\n                    subset=[\"child_reference\", \"parent_facility_reference\"]\n                )\n\n            # Join contingents with their parent facility\n            contingent_with_parent = contingents.join(\n                contingent_mappings,\n                left_on=\"contingent_reference\",\n                right_on=\"child_reference\",\n                how=\"inner\",\n            )\n\n            # For multi-level hierarchies, map to root facility\n            if facility_root_lookup is not None and facility_root_lookup.head(1).collect().height &gt; 0:\n                contingent_with_parent = contingent_with_parent.join(\n                    facility_root_lookup.select([\n                        pl.col(\"child_facility_reference\"),\n                        pl.col(\"root_facility_reference\").alias(\"_root_fac\"),\n                    ]),\n                    left_on=\"parent_facility_reference\",\n                    right_on=\"child_facility_reference\",\n                    how=\"left\",\n                ).with_columns([\n                    pl.coalesce(\n                        pl.col(\"_root_fac\"),\n                        pl.col(\"parent_facility_reference\"),\n                    ).alias(\"aggregation_facility\"),\n                ]).drop(\"_root_fac\")\n</code></pre> <p>Lending Group Threshold Check:</p> <pre><code># Total adjusted exposure to lending group (from hierarchy resolver)\nadjusted_group_exposure = sum(\n    exp.exposure_for_retail_threshold for entity in lending_group\n    for exp in entity.exposures\n)\n\n# Must be \u2264 EUR 1m for retail treatment\nif adjusted_group_exposure &lt;= 1_000_000:\n    treatment = \"RETAIL\"\nelse:\n    treatment = \"CORPORATE_SME\"  # SMEs retain firm-size adjustment\n</code></pre>"},{"location":"user-guide/exposure-classes/retail/#treatment-when-threshold-exceeded","title":"Treatment When Threshold Exceeded","text":"Counterparty Type Exceeds Threshold Treatment Individual (mortgage) Yes Stays as RETAIL_MORTGAGE (SA Art. 112(i)) Individual (other) Yes Reclassified to CORPORATE SME (any product) Yes Reclassified to CORPORATE_SME <p>Regulatory References: - CRR Art. 123(c) - Retail exclusion for residential property - EBA Q&amp;A 2013_72 - SA residential property exclusion clarification - EBA Q&amp;A 2018_4012 - IRB residential property NOT excluded</p>"},{"location":"user-guide/exposure-classes/retail/#example-threshold-calculation-with-exclusion","title":"Example: Threshold Calculation with Exclusion","text":"<p>Scenario: Lending group with EUR 2m total exposure</p> Exposure Amount Residential Collateral For Threshold Term loan EUR 1m EUR 0 EUR 1m Mortgage EUR 1m EUR 1m EUR 0 Total EUR 2m EUR 1m <p>Result: Adjusted exposure = EUR 1m (at threshold) - qualifies as retail</p>"},{"location":"user-guide/exposure-classes/retail/#crm-for-retail","title":"CRM for Retail","text":""},{"location":"user-guide/exposure-classes/retail/#eligible-collateral","title":"Eligible Collateral","text":"Collateral Type Treatment Residential property Mortgage RW Financial collateral Haircut method Physical collateral LGD reduction (IRB)"},{"location":"user-guide/exposure-classes/retail/#guarantees","title":"Guarantees","text":"<p>Limited guarantee recognition for retail: - Government guarantees accepted - Institution guarantees under conditions - Individual guarantees generally not recognized</p>"},{"location":"user-guide/exposure-classes/retail/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE EBA Q&amp;A Retail definition Art. 123 CRE20.50-60 - EUR 1m threshold Art. 123(c) CRE20.65 2016_2626 Residential property exclusion Art. 123(c), Art. 112(i) - 2013_72, 2018_4012 Retail mortgage Art. 125 CRE20.70-75 - QRRE Art. 154 CRE31.10-12 - Retail IRB Art. 154 CRE31 - Correlation Art. 154 CRE31.13-15 -"},{"location":"user-guide/exposure-classes/retail/#next-steps","title":"Next Steps","text":"<ul> <li>Other Exposure Classes</li> <li>IRB Approach</li> <li>Credit Risk Mitigation</li> </ul>"},{"location":"user-guide/methodology/","title":"Calculation Methodology","text":"<p>This section explains how Risk-Weighted Assets (RWA) are calculated for credit risk exposures. Understanding these methodologies is essential for auditing results and validating regulatory compliance.</p>"},{"location":"user-guide/methodology/#rwa-calculation-overview","title":"RWA Calculation Overview","text":"<p>Risk-Weighted Assets represent the risk-adjusted value of exposures, used to determine capital requirements:</p> <pre><code>Capital Requirement = RWA \u00d7 Capital Ratio (typically 8%)\n</code></pre> <p>The calculator supports four main approaches:</p> Approach Description Applicable To Standardised (SA) Regulatory risk weights All exposure classes IRB Internal ratings-based Approved portfolios Slotting Category-based weights Specialised lending Equity Dedicated equity treatment Equity holdings"},{"location":"user-guide/methodology/#calculation-pipeline","title":"Calculation Pipeline","text":"<pre><code>flowchart TD\n    subgraph Input\n        A[Raw Data]\n    end\n\n    subgraph Processing\n        B[Hierarchy Resolution]\n        C[Classification]\n        D[CRM Application]\n    end\n\n    subgraph Calculation\n        E{Approach}\n        F[SA Calculator]\n        G[IRB Calculator]\n        H[Slotting Calculator]\n    end\n\n    subgraph Output\n        I[Aggregation]\n        J[Final RWA]\n    end\n\n    A --&gt; B\n    B --&gt; C\n    C --&gt; D\n    D --&gt; E\n    E --&gt;|SA| F\n    E --&gt;|IRB| G\n    E --&gt;|Slotting| H\n    F --&gt; I\n    G --&gt; I\n    H --&gt; I\n    I --&gt; J</code></pre>"},{"location":"user-guide/methodology/#key-formulas","title":"Key Formulas","text":""},{"location":"user-guide/methodology/#standardised-approach","title":"Standardised Approach","text":"<pre><code>RWA = EAD \u00d7 Risk Weight \u00d7 Supporting Factors\n</code></pre> <p>Where: - EAD = Exposure at Default (drawn + CCF \u00d7 undrawn) - Risk Weight = Regulatory-prescribed weight based on rating/class - Supporting Factors = SME/infrastructure factors (CRR only)</p>"},{"location":"user-guide/methodology/#irb-approach","title":"IRB Approach","text":"<pre><code>RWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA \u00d7 Scaling Factor\n</code></pre> <p>Where: - K = Capital requirement from IRB formula - 12.5 = Reciprocal of 8% minimum capital ratio - EAD = Exposure at Default - MA = Maturity Adjustment - Scaling Factor = 1.06 (CRR) or 1.0 (Basel 3.1)</p>"},{"location":"user-guide/methodology/#slotting-approach","title":"Slotting Approach","text":"<pre><code>RWA = EAD \u00d7 Slotting Risk Weight\n</code></pre> <p>Where: - Slotting Risk Weight = Based on category (Strong/Good/Satisfactory/Weak)</p>"},{"location":"user-guide/methodology/#calculation-components","title":"Calculation Components","text":""},{"location":"user-guide/methodology/#exposure-at-default-ead","title":"Exposure at Default (EAD)","text":"<p>EAD is the expected exposure amount at the time of default:</p> Exposure Type EAD Calculation On-Balance Sheet Gross carrying amount Off-Balance Sheet Committed \u00d7 CCF Derivatives Mark-to-market + Add-on"},{"location":"user-guide/methodology/#credit-conversion-factors-ccf","title":"Credit Conversion Factors (CCF)","text":"<p>CCFs convert off-balance sheet exposures to EAD:</p> Item Type CCF Unconditionally Cancellable 0% (CRR) / 10% (Basel 3.1) Short-term Trade Finance 20% Undrawn Commitments 20-50% Direct Credit Substitutes 100%"},{"location":"user-guide/methodology/#risk-weights","title":"Risk Weights","text":"<p>Risk weights depend on: 1. Exposure class (Central Govt / Central Bank, Institution, Corporate, Retail, etc.) 2. Credit quality (CQS 1-6 or internal rating) 3. Collateral (secured vs unsecured) 4. Maturity (for certain exposures)</p>"},{"location":"user-guide/methodology/#credit-risk-mitigation-crm","title":"Credit Risk Mitigation (CRM)","text":"<p>CRM reduces exposure or substitutes risk weight:</p> <pre><code>flowchart LR\n    A[Gross Exposure] --&gt; B{CRM Type}\n    B --&gt;|Collateral| C[Apply Haircuts]\n    B --&gt;|Guarantee| D[Substitution]\n    B --&gt;|Provision| E[Reduce EAD/EL]\n    C --&gt; F[Net Exposure]\n    D --&gt; F\n    E --&gt; F\n    F --&gt; G[Calculate RWA]</code></pre> <p>See Credit Risk Mitigation for details.</p>"},{"location":"user-guide/methodology/#approach-selection","title":"Approach Selection","text":"<p>The calculation approach is determined by:</p> <ol> <li>Regulatory approval - IRB requires PRA approval</li> <li>Exposure class - Some classes have restricted approaches</li> <li>Data availability - IRB requires PD estimates</li> </ol> Exposure Class SA F-IRB A-IRB Slotting Central Govt / Central Bank Institution * Corporate * Retail Specialised Lending Equity <p>*Basel 3.1 restricts A-IRB for banks and large corporates</p>"},{"location":"user-guide/methodology/#framework-adjustments","title":"Framework Adjustments","text":""},{"location":"user-guide/methodology/#crr-adjustments","title":"CRR Adjustments","text":"<ol> <li>1.06 Scaling Factor: Applied to all IRB RWA</li> <li>SME Supporting Factor: 0.7619/0.85 tiered reduction</li> <li>Infrastructure Factor: 0.75 flat reduction</li> </ol>"},{"location":"user-guide/methodology/#basel-31-adjustments","title":"Basel 3.1 Adjustments","text":"<ol> <li>Output Floor: max(IRB RWA, 72.5% \u00d7 SA RWA)</li> <li>PD Floors: Differentiated by exposure class</li> <li>LGD Floors: For A-IRB by collateral type</li> </ol>"},{"location":"user-guide/methodology/#validation-and-audit","title":"Validation and Audit","text":""},{"location":"user-guide/methodology/#traceability","title":"Traceability","text":"<p>Every calculation can be traced: - Input values for each exposure - Intermediate calculations - Applied adjustments - Final RWA</p>"},{"location":"user-guide/methodology/#error-accumulation","title":"Error Accumulation","text":"<p>The calculator accumulates errors without failing: <pre><code>result = pipeline.run(config)\n\nfor error in result.errors:\n    print(f\"{error.exposure_id}: {error.message}\")\n</code></pre></p>"},{"location":"user-guide/methodology/#reconciliation-points","title":"Reconciliation Points","text":"<p>Key reconciliation points: 1. EAD Total - Sum of all exposures at default 2. RWA by Approach - SA + IRB + Slotting 3. RWA by Exposure Class - Sum by classification 4. Floor Impact - IRB before and after floor (Basel 3.1)</p>"},{"location":"user-guide/methodology/#detailed-methodology","title":"Detailed Methodology","text":"<p>Explore each calculation approach in detail:</p> <ul> <li>Standardised Approach - SA methodology and risk weights</li> <li>IRB Approach - F-IRB and A-IRB formulas</li> <li>Specialised Lending - Slotting approach</li> <li>Equity - Equity exposure treatment</li> <li>Credit Risk Mitigation - CRM techniques</li> <li>Supporting Factors - SME and infrastructure factors</li> <li>FX Conversion - Multi-currency portfolio support</li> </ul>"},{"location":"user-guide/methodology/crm/","title":"Credit Risk Mitigation","text":"<p>Credit Risk Mitigation (CRM) techniques reduce the capital requirement for exposures by providing protection against default losses. The calculator supports collateral, guarantees, and provisions.</p>"},{"location":"user-guide/methodology/crm/#overview","title":"Overview","text":"<pre><code>flowchart TD\n    A[Gross Exposure] --&gt; B{CRM Available?}\n    B --&gt;|Yes| C{CRM Type}\n    B --&gt;|No| D[Calculate RWA on Gross]\n    C --&gt;|Collateral| E[Apply Haircuts]\n    C --&gt;|Guarantee| F[Substitution Approach]\n    C --&gt;|Provision| G[Reduce EAD/EL]\n    E --&gt; H[Net Exposure]\n    F --&gt; I[Split Exposure]\n    G --&gt; J[Adjusted Exposure]\n    H --&gt; K[Calculate RWA]\n    I --&gt; K\n    J --&gt; K\n    D --&gt; K</code></pre>"},{"location":"user-guide/methodology/crm/#collateral","title":"Collateral","text":""},{"location":"user-guide/methodology/crm/#pledge-percentage","title":"Pledge Percentage","text":"<p>Collateral can be specified as a percentage of the beneficiary's EAD instead of an absolute <code>market_value</code>. Set <code>pledge_percentage</code> (decimal fraction, e.g. 0.5 = 50%) and leave <code>market_value</code> null or zero. The system resolves it to an absolute value before haircuts:</p> <ul> <li>Direct (loan/contingent): <code>market_value = pledge_percentage \u00d7 exposure ead_gross</code></li> <li>Facility: <code>market_value = pledge_percentage \u00d7 sum(ead_gross)</code> across all facility exposures</li> <li>Counterparty: <code>market_value = pledge_percentage \u00d7 sum(ead_gross)</code> across all counterparty exposures</li> </ul> <p>When <code>market_value</code> is provided (non-null, non-zero), it takes priority and <code>pledge_percentage</code> is ignored.</p>"},{"location":"user-guide/methodology/crm/#financial-collateral","title":"Financial Collateral","text":"<p>Financial collateral (cash, bonds, equity) directly reduces exposure.</p>"},{"location":"user-guide/methodology/crm/#simple-method-sa-only","title":"Simple Method (SA Only)","text":"<p>The collateral's risk weight substitutes for the exposure's risk weight:</p> <pre><code># Protected portion uses collateral issuer's RW\nRWA_protected = Protected_Amount \u00d7 Collateral_RW\n\n# Unprotected portion uses counterparty RW\nRWA_unprotected = Unprotected_Amount \u00d7 Counterparty_RW\n\n# Total\nRWA = RWA_protected + RWA_unprotected\n</code></pre>"},{"location":"user-guide/methodology/crm/#comprehensive-method","title":"Comprehensive Method","text":"<p>Applies haircuts to both exposure and collateral. See <code>crm/haircuts.py:69-143</code> for the implementation.</p> <p>Conceptual Formula</p> <pre><code># Exposure with volatility adjustment\nE_adjusted = E \u00d7 (1 + H_e)\n\n# Collateral with haircuts\nC_adjusted = C \u00d7 (1 - H_c - H_fx)\n\n# Net exposure\nE_star = max(0, E_adjusted - C_adjusted)\n\n# RWA on net exposure\nRWA = E_star \u00d7 Risk_Weight\n</code></pre>"},{"location":"user-guide/methodology/crm/#supervisory-haircuts","title":"Supervisory Haircuts","text":"Collateral Type Residual Maturity Haircut (H_c) Cash Any 0% Government/PSE CQS1 \u22641 year 0.5% 1-5 years 2% &gt;5 years 4% Government/PSE CQS2-3 \u22641 year 1% 1-5 years 3% &gt;5 years 6% Corporate CQS1-2 \u22641 year 1% 1-5 years 4% &gt;5 years 8% Corporate CQS3 \u22641 year 2% 1-5 years 6% &gt;5 years 12% Main Index Equity Any 15% Other Listed Equity Any 25% Gold Any 15% <p>Currency Mismatch (H_fx): <pre><code># Add 8% if collateral currency \u2260 exposure currency\nif collateral_currency != exposure_currency:\n    H_fx = 0.08\nelse:\n    H_fx = 0.00\n</code></pre></p>"},{"location":"user-guide/methodology/crm/#exposure-haircut-h_e","title":"Exposure Haircut (H_e)","text":"<p>For repos and similar transactions:</p> Exposure Type Haircut (H_e) Government bonds CQS1 Same as H_c table Corporate bonds Same as H_c table Equity 0% (exposure side)"},{"location":"user-guide/methodology/crm/#collateral-calculation-example","title":"Collateral Calculation Example","text":"<p>Exposure: - Corporate loan, \u00a310m - Counterparty RW: 100%</p> <p>Collateral: - Government bonds (CQS1), \u00a38m - Residual maturity: 3 years - Same currency</p> <p>Calculation (Comprehensive Method): <pre><code># Haircuts\nH_e = 0%  # Loan exposure\nH_c = 2%  # Govt bond 1-5yr\nH_fx = 0%  # Same currency\n\n# Adjusted values\nE_adjusted = 10,000,000 \u00d7 (1 + 0.00) = 10,000,000\nC_adjusted = 8,000,000 \u00d7 (1 - 0.02 - 0.00) = 7,840,000\n\n# Net exposure\nE_star = max(0, 10,000,000 - 7,840,000) = 2,160,000\n\n# RWA\nRWA = 2,160,000 \u00d7 100% = \u00a32,160,000\n\n# vs. Gross RWA\nGross_RWA = 10,000,000 \u00d7 100% = \u00a310,000,000\n\n# Benefit: 78.4% reduction\n</code></pre></p>"},{"location":"user-guide/methodology/crm/#physical-collateral","title":"Physical Collateral","text":"<p>Physical collateral (real estate, equipment) provides CRM for IRB:</p> Collateral Type F-IRB LGD Residential Real Estate 35% Commercial Real Estate 35% Receivables 35% Other Physical 40% Unsecured 45% <p>Eligibility Requirements: - Legal certainty of enforcement - Regular revaluation - Proper documentation - Insurance where appropriate</p>"},{"location":"user-guide/methodology/crm/#overcollateralisation-crr-art-230","title":"Overcollateralisation (CRR Art. 230)","text":"<p>Non-financial collateral must meet overcollateralisation requirements before it can provide CRM benefit. This ensures sufficient excess coverage to absorb valuation uncertainty.</p>"},{"location":"user-guide/methodology/crm/#overcollateralisation-ratios","title":"Overcollateralisation Ratios","text":"Collateral Type Required Ratio Effectively Secured Financial 1.0x Full adjusted value Receivables 1.25x Adjusted value / 1.25 Real estate 1.4x Adjusted value / 1.4 Other physical 1.4x Adjusted value / 1.4 <pre><code># Example: \u00a31.4m of real estate collateral (after haircuts)\novercoll_ratio = 1.4\neffectively_secured = 1_400_000 / 1.4  # = \u00a31,000,000 of CRM benefit\n</code></pre>"},{"location":"user-guide/methodology/crm/#minimum-coverage-thresholds","title":"Minimum Coverage Thresholds","text":"<p>Physical collateral must cover a minimum portion of EAD to provide any benefit:</p> Collateral Type Minimum Coverage Financial No minimum Receivables No minimum Real estate 30% of EAD Other physical 30% of EAD <p>If the minimum threshold is not met, the non-financial collateral value is zeroed (no CRM benefit at all).</p> <pre><code># Example: EAD = \u00a31,000,000, RE collateral adjusted value = \u00a3200,000\n# Coverage = 200,000 / 1,000,000 = 20% &lt; 30% threshold\n# Result: collateral value set to \u00a30 (threshold not met)\n</code></pre>"},{"location":"user-guide/methodology/crm/#multi-level-treatment","title":"Multi-Level Treatment","text":"<p>Financial and non-financial collateral are tracked separately through the multi-level allocation process (exposure, facility, counterparty levels). This ensures:</p> <ul> <li>Overcollateralisation ratios are applied per collateral type</li> <li>Minimum thresholds are checked against the total non-financial coverage</li> <li>Financial collateral is unaffected by the overcollateralisation requirements</li> </ul>"},{"location":"user-guide/methodology/crm/#guarantees","title":"Guarantees","text":""},{"location":"user-guide/methodology/crm/#substitution-approach","title":"Substitution Approach","text":"<p>The guaranteed portion is treated as an exposure to the guarantor:</p> <pre><code>flowchart LR\n    A[\u00a310m Exposure] --&gt; B{Guaranteed?}\n    B --&gt;|\u00a36m| C[Guarantor RW]\n    B --&gt;|\u00a34m| D[Counterparty RW]\n    C --&gt; E[\u00a36m \u00d7 20%]\n    D --&gt; F[\u00a34m \u00d7 100%]\n    E --&gt; G[Total RWA = \u00a35.2m]\n    F --&gt; G</code></pre>"},{"location":"user-guide/methodology/crm/#eligible-guarantors","title":"Eligible Guarantors","text":"Guarantor Type Eligibility Sovereigns CQS1-3 Institutions CQS1-3 Corporates Rated corporates with lower RW Parent Companies Under certain conditions"},{"location":"user-guide/methodology/crm/#guarantee-requirements","title":"Guarantee Requirements","text":"<ol> <li>Direct claim on guarantor</li> <li>Unconditional - no conditions to payment</li> <li>Irrevocable - cannot be cancelled</li> <li>Legally enforceable in relevant jurisdictions</li> </ol>"},{"location":"user-guide/methodology/crm/#double-default-crr","title":"Double Default (CRR)","text":"<p>For qualifying guarantees, the double default treatment may apply:</p> <pre><code># Probability both obligor AND guarantor default\nPD_joint = PD_obligor \u00d7 PD_guarantor \u00d7 (1 + correlation)\n\n# Typically results in lower RWA\n</code></pre>"},{"location":"user-guide/methodology/crm/#guarantee-example","title":"Guarantee Example","text":"<p>Exposure: - SME loan, \u00a35m - Counterparty RW: 100%</p> <p>Guarantee: - UK Government (0% RW) - Guaranteed amount: \u00a34m</p> <p>Calculation: <pre><code># Guaranteed portion (G10 sovereign)\nRWA_guaranteed = 4,000,000 \u00d7 0% = \u00a30\n\n# Unguaranteed portion\nRWA_unguaranteed = 1,000,000 \u00d7 100% = \u00a31,000,000\n\n# Total RWA\nRWA = \u00a30 + \u00a31,000,000 = \u00a31,000,000\n\n# vs. Gross RWA\nGross_RWA = \u00a35,000,000\n\n# Benefit: 80% reduction\n</code></pre></p>"},{"location":"user-guide/methodology/crm/#maturity-mismatch","title":"Maturity Mismatch","text":"<p>When protection maturity &lt; exposure maturity:</p> <pre><code># Minimum protection maturity: 1 year\nt = max(0.25, protection_residual_maturity)\nT = max(0.25, exposure_residual_maturity)\n\n# Adjustment factor\nif t &gt;= T:\n    adjustment = 1.0\nelse:\n    adjustment = (t - 0.25) / (T - 0.25)\n\n# Adjusted protection\nAdjusted_Protection = Protection \u00d7 adjustment\n</code></pre> <p>Example: - Exposure maturity: 5 years - Guarantee maturity: 3 years</p> <pre><code>adjustment = (3 - 0.25) / (5 - 0.25) = 2.75 / 4.75 = 0.579\n\n# \u00a34m guarantee provides \u00a32.32m effective protection\n</code></pre>"},{"location":"user-guide/methodology/crm/#cross-approach-ccf-substitution","title":"Cross-Approach CCF Substitution","text":"<p>When an IRB exposure is guaranteed by a counterparty that falls under the Standardised Approach, the guaranteed portion uses SA CCFs instead of the IRB supervisory CCFs. This reflects the principle that the risk of the guaranteed portion should be treated consistently with the guarantor's approach.</p>"},{"location":"user-guide/methodology/crm/#when-it-applies","title":"When It Applies","text":"<p>Cross-approach CCF substitution triggers when:</p> <ol> <li>The exposure is under F-IRB or A-IRB</li> <li>The guarantor's approach is determined to be SA \u2014 either because:</li> <li>The firm does not have IRB permission for the guarantor's exposure class, OR</li> <li>The guarantor only has an external rating (no internal PD estimate)</li> </ol>"},{"location":"user-guide/methodology/crm/#guarantor-approach-determination","title":"Guarantor Approach Determination","text":"<p>The guarantor's approach depends on three factors:</p> Condition Guarantor Approach Firm has IRB permission for guarantor's class AND guarantor has internal rating (PD) IRB Firm lacks IRB permission for guarantor's class SA Guarantor has external rating only (no PD) SA <p>For example, a sovereign guarantor rated CQS 1 with no internal PD will always be treated as SA, even if the firm has F-IRB permission for sovereign exposures.</p>"},{"location":"user-guide/methodology/crm/#ead-recalculation","title":"EAD Recalculation","text":"<p>When the guarantor approach is SA, the exposure's EAD is recalculated with a split:</p> <pre><code># Original EAD uses IRB CCF\nead_original = drawn + undrawn \u00d7 ccf_irb\n\n# Guaranteed portion recalculated with SA CCF\nead_guaranteed = guarantee_ratio \u00d7 (drawn + undrawn \u00d7 ccf_sa)\n\n# Unguaranteed portion retains IRB CCF\nead_unguaranteed = (1 - guarantee_ratio) \u00d7 (drawn + undrawn \u00d7 ccf_irb)\n</code></pre>"},{"location":"user-guide/methodology/crm/#output-columns","title":"Output Columns","text":"<p>The cross-approach CCF process adds these columns:</p> Column Description <code>ccf_original</code> Original IRB CCF <code>ccf_guaranteed</code> CCF for guaranteed portion (SA if cross-approach) <code>ccf_unguaranteed</code> CCF for unguaranteed portion (IRB) <code>guarantee_ratio</code> Proportion guaranteed <code>guarantor_approach</code> \"sa\" or \"irb\" <code>guarantor_rating_type</code> \"internal\" or \"external\""},{"location":"user-guide/methodology/crm/#regulatory-reference","title":"Regulatory Reference","text":"<p>CRR Article 153(3) and CRE31.4 \u2014 when a guarantee provides credit protection, the CCF applicable to the protected portion should be consistent with the guarantor's treatment.</p>"},{"location":"user-guide/methodology/crm/#provisions","title":"Provisions","text":""},{"location":"user-guide/methodology/crm/#sa-treatment","title":"SA Treatment","text":"<p>Specific provisions reduce EAD:</p> <pre><code>EAD = Gross_Exposure - Specific_Provision\nRWA = EAD \u00d7 Risk_Weight\n</code></pre>"},{"location":"user-guide/methodology/crm/#irb-treatment","title":"IRB Treatment","text":"<p>Provisions compare to Expected Loss:</p> <pre><code>EL = PD \u00d7 LGD \u00d7 EAD\n\nif Provisions &gt;= EL:\n    # Excess provisions can be added to Tier 2 (limited)\n    Excess = Provisions - EL\nelse:\n    # Shortfall deducted from CET1\n    Shortfall = EL - Provisions\n</code></pre>"},{"location":"user-guide/methodology/crm/#scra-and-gcra-provisions","title":"SCRA and GCRA Provisions","text":"Type Description Treatment SCRA Specific Credit Risk Adjustments Reduce EAD directly GCRA General Credit Risk Adjustments May be included in Tier 2"},{"location":"user-guide/methodology/crm/#provision-allocation","title":"Provision Allocation","text":"<p>Provisions can be allocated at different levels:</p> Level Application Counterparty Applies to all exposures Facility Applies to facility and sub-loans Loan Applies to specific loan"},{"location":"user-guide/methodology/crm/#crm-hierarchy","title":"CRM Hierarchy","text":"<p>When multiple CRM types are available:</p> <pre><code># Order of application\n1. Apply specific provisions (reduce EAD)\n2. Apply collateral (reduce net exposure)\n3. Apply guarantees (substitution on remainder)\n</code></pre>"},{"location":"user-guide/methodology/crm/#example-with-multiple-crm","title":"Example with Multiple CRM","text":"<p>Exposure: - Corporate loan, \u00a310m - Counterparty RW: 100%</p> <p>CRM: - Specific provision: \u00a31m - Cash collateral: \u00a33m - Bank guarantee (20% RW): \u00a34m</p> <p>Calculation: <pre><code># Step 1: Apply provision\nNet_1 = 10,000,000 - 1,000,000 = 9,000,000\n\n# Step 2: Apply collateral (no haircut for cash)\nNet_2 = 9,000,000 - 3,000,000 = 6,000,000\n\n# Step 3: Apply guarantee (substitution)\nGuaranteed = min(4,000,000, 6,000,000) = 4,000,000\nUnguaranteed = 6,000,000 - 4,000,000 = 2,000,000\n\n# Calculate RWA\nRWA_guaranteed = 4,000,000 \u00d7 20% = 800,000\nRWA_unguaranteed = 2,000,000 \u00d7 100% = 2,000,000\n\nTotal_RWA = \u00a32,800,000\n\n# vs. Gross RWA = \u00a310,000,000\n# Benefit: 72% reduction\n</code></pre></p>"},{"location":"user-guide/methodology/crm/#implementation","title":"Implementation","text":"<p>The CRM processing is implemented in <code>crm/processor.py</code> and <code>crm/haircuts.py</code>.</p>"},{"location":"user-guide/methodology/crm/#crm-processor","title":"CRM Processor","text":"<pre><code>from rwa_calc.engine.crm.processor import CRMProcessor\nfrom rwa_calc.contracts.config import CalculationConfig\nfrom datetime import date\n\n# Create processor\nprocessor = CRMProcessor()\n\n# Process exposures through CRM pipeline\nresult = processor.get_crm_adjusted_bundle(\n    data=classified_exposures_bundle,\n    config=CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n)\n\n# Access adjusted exposures\nadjusted = result.exposures\nsa_adjusted = result.sa_exposures\nirb_adjusted = result.irb_exposures\n</code></pre> CRM Processor Implementation (processor.py) <pre><code>    from rwa_calc.contracts.config import CalculationConfig\n\n\n@dataclass\nclass CRMError:\n    \"\"\"Error encountered during CRM processing.\"\"\"\n\n    error_type: str\n    message: str\n    exposure_reference: str | None = None\n    context: dict = field(default_factory=dict)\n\n\nclass CRMProcessor:\n    \"\"\"\n    Apply credit risk mitigation to exposures.\n\n    Implements CRMProcessorProtocol for:\n    - CCF application for off-balance sheet items (CRR Art. 111)\n    - Collateral haircuts and allocation (CRR Art. 223-224)\n    - Guarantee substitution (CRR Art. 213-215)\n    - Provision deduction (CRR Art. 110)\n\n    The CRM process follows this order:\n    1. Apply CCF to calculate base EAD for contingents\n    2. Apply collateral (reduce EAD for SA, reduce LGD for IRB)\n    3. Apply guarantees (substitution approach)\n    4. Deduct provisions from EAD\n    \"\"\"\n\n    # Required columns for each CRM data type\n    COLLATERAL_REQUIRED_COLUMNS = {\"beneficiary_reference\", \"market_value\"}\n    GUARANTEE_REQUIRED_COLUMNS = {\"beneficiary_reference\", \"amount_covered\", \"guarantor\"}\n    PROVISION_REQUIRED_COLUMNS = {\"beneficiary_reference\", \"amount\"}\n\n    def __init__(self) -&gt; None:\n        \"\"\"Initialize CRM processor with sub-calculators.\"\"\"\n        self._ccf_calculator = CCFCalculator()\n        self._haircut_calculator = HaircutCalculator()\n\n    def _is_valid_for_processing(\n        self,\n        data: pl.LazyFrame | None,\n        required_columns: set[str],\n    ) -&gt; bool:\n        \"\"\"\n        Check if optional CRM data is valid for processing.\n\n        This provides defense-in-depth validation to ensure data has:\n        - At least one row\n        - All required columns for the CRM operation\n\n        Args:\n            data: Optional LazyFrame to validate\n            required_columns: Set of column names that must be present\n\n        Returns:\n            True if data is valid for processing, False otherwise\n        \"\"\"\n        if data is None:\n            return False\n\n        try:\n            # Check schema has required columns\n            schema = data.collect_schema()\n            if not required_columns.issubset(set(schema.names())):\n                return False\n\n            # Check if there's at least one row\n            return data.head(1).collect().height &gt; 0\n        except Exception:\n            return False\n\n    def apply_crm(\n        self,\n        data: ClassifiedExposuresBundle,\n        config: CalculationConfig,\n    ) -&gt; LazyFrameResult:\n        \"\"\"\n        Apply credit risk mitigation to exposures.\n\n        Args:\n            data: Classified exposures from classifier\n            config: Calculation configuration\n\n        Returns:\n            LazyFrameResult with CRM-adjusted exposures and any errors\n        \"\"\"\n        bundle = self.get_crm_adjusted_bundle(data, config)\n\n        # Convert to LazyFrameResult format\n        return LazyFrameResult(\n            frame=bundle.exposures,\n            errors=[],  # CRMError objects would need conversion to CalculationError\n        )\n\n    def get_crm_adjusted_bundle(\n        self,\n        data: ClassifiedExposuresBundle,\n        config: CalculationConfig,\n    ) -&gt; CRMAdjustedBundle:\n        \"\"\"\n        Apply CRM and return as a bundle.\n\n        Args:\n            data: Classified exposures from classifier\n            config: Calculation configuration\n\n        Returns:\n            CRMAdjustedBundle with adjusted exposures\n        \"\"\"\n        errors: list[CRMError] = []\n\n        # Start with all exposures\n        exposures = data.all_exposures\n\n        # Step 1: Apply CCF to calculate EAD for contingents\n        exposures = self._apply_ccf(exposures, config)\n</code></pre>"},{"location":"user-guide/methodology/crm/#rwa_calc.engine.crm.processor.CRMProcessor","title":"<code>rwa_calc.engine.crm.processor.CRMProcessor</code>","text":"<p>Apply credit risk mitigation to exposures.</p> <p>Implements CRMProcessorProtocol for: - CCF application for off-balance sheet items (CRR Art. 111) - Collateral haircuts and allocation (CRR Art. 223-224) - Guarantee substitution (CRR Art. 213-215) - Provision deduction (CRR Art. 110)</p> <p>The CRM process follows this order: 1. Apply CCF to calculate base EAD for contingents 2. Apply collateral (reduce EAD for SA, reduce LGD for IRB) 3. Apply guarantees (substitution approach) 4. Deduct provisions from EAD</p>"},{"location":"user-guide/methodology/crm/#rwa_calc.engine.crm.processor.CRMProcessor.apply_crm","title":"<code>apply_crm(data, config)</code>","text":"<p>Apply credit risk mitigation to exposures.</p> <p>Parameters:</p> Name Type Description Default <code>data</code> <code>ClassifiedExposuresBundle</code> <p>Classified exposures from classifier</p> required <code>config</code> <code>CalculationConfig</code> <p>Calculation configuration</p> required <p>Returns:</p> Type Description <code>LazyFrameResult</code> <p>LazyFrameResult with CRM-adjusted exposures and any errors</p>"},{"location":"user-guide/methodology/crm/#rwa_calc.engine.crm.processor.CRMProcessor.apply_collateral","title":"<code>apply_collateral(exposures, collateral, config)</code>","text":"<p>Apply collateral to reduce EAD (SA) or LGD (IRB).</p> <p>Parameters:</p> Name Type Description Default <code>exposures</code> <code>LazyFrame</code> <p>Exposures with ead_gross</p> required <code>collateral</code> <code>LazyFrame</code> <p>Collateral data</p> required <code>config</code> <code>CalculationConfig</code> <p>Calculation configuration</p> required <p>Returns:</p> Type Description <code>LazyFrame</code> <p>Exposures with collateral effects applied</p>"},{"location":"user-guide/methodology/crm/#rwa_calc.engine.crm.processor.CRMProcessor.apply_guarantees","title":"<code>apply_guarantees(exposures, guarantees, counterparty_lookup, config, rating_inheritance=None)</code>","text":"<p>Apply guarantee substitution.</p> <p>For guaranteed portion, substitute borrower RW with guarantor RW.</p> <p>Parameters:</p> Name Type Description Default <code>exposures</code> <code>LazyFrame</code> <p>Exposures with EAD</p> required <code>guarantees</code> <code>LazyFrame</code> <p>Guarantee data</p> required <code>counterparty_lookup</code> <code>LazyFrame</code> <p>For guarantor risk weights</p> required <code>config</code> <code>CalculationConfig</code> <p>Calculation configuration</p> required <code>rating_inheritance</code> <code>LazyFrame | None</code> <p>For guarantor CQS lookup</p> <code>None</code> <p>Returns:</p> Type Description <code>LazyFrame</code> <p>Exposures with guarantee effects applied</p>"},{"location":"user-guide/methodology/crm/#rwa_calc.engine.crm.processor.CRMProcessor.apply_provisions","title":"<code>apply_provisions(exposures, provisions, config)</code>","text":"<p>Apply provision deduction from EAD.</p> <p>For SA, specific provisions are deducted from EAD. For IRB, provisions are compared to EL for shortfall/excess.</p> <p>Parameters:</p> Name Type Description Default <code>exposures</code> <code>LazyFrame</code> <p>Exposures with EAD</p> required <code>provisions</code> <code>LazyFrame</code> <p>Provision data</p> required <code>config</code> <code>CalculationConfig</code> <p>Calculation configuration</p> required <p>Returns:</p> Type Description <code>LazyFrame</code> <p>Exposures with provision effects applied</p>"},{"location":"user-guide/methodology/crm/#haircut-calculator","title":"Haircut Calculator","text":"<pre><code>from rwa_calc.engine.crm.haircuts import HaircutCalculator\nfrom decimal import Decimal\n\ncalculator = HaircutCalculator()\n\n# Calculate haircut for a single collateral item\nresult = calculator.calculate_single_haircut(\n    collateral_type=\"govt_bond\",\n    market_value=Decimal(\"8000000\"),\n    collateral_currency=\"GBP\",\n    exposure_currency=\"GBP\",\n    cqs=1,\n    residual_maturity_years=3.0,\n)\n\nprint(f\"Collateral haircut: {result.collateral_haircut:.1%}\")\nprint(f\"Adjusted value: {result.adjusted_value:,.0f}\")\n</code></pre> Haircut Application (haircuts.py) <pre><code>    def _apply_collateral_haircuts(\n        self,\n        collateral: pl.LazyFrame,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply collateral-type-specific haircuts.\n\n        Args:\n            collateral: Collateral with collateral_type column\n\n        Returns:\n            LazyFrame with collateral_haircut column added\n        \"\"\"\n        return collateral.with_columns([\n            # Cash - 0%\n            pl.when(pl.col(\"collateral_type\").str.to_lowercase().is_in([\"cash\", \"deposit\"]))\n            .then(pl.lit(0.00))\n            # Gold - 15%\n            .when(pl.col(\"collateral_type\").str.to_lowercase() == \"gold\")\n            .then(pl.lit(0.15))\n            # Government bonds - by CQS and maturity\n            # Match explicit govt bond types or generic \"bond\" with sovereign issuer\n            .when(\n                (\n                    pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                        \"govt_bond\", \"sovereign_bond\", \"government_bond\", \"gilt\"\n                    ]) |\n                    ((pl.col(\"collateral_type\").str.to_lowercase() == \"bond\") &amp;\n                     (pl.col(\"issuer_type\").str.to_lowercase() == \"sovereign\"))\n                ) &amp;\n                (pl.col(\"issuer_cqs\") == 1) &amp;\n                (pl.col(\"maturity_band\") == \"0_1y\")\n            ).then(pl.lit(0.005))\n            .when(\n                (\n                    pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                        \"govt_bond\", \"sovereign_bond\", \"government_bond\", \"gilt\"\n                    ]) |\n                    ((pl.col(\"collateral_type\").str.to_lowercase() == \"bond\") &amp;\n                     (pl.col(\"issuer_type\").str.to_lowercase() == \"sovereign\"))\n                ) &amp;\n                (pl.col(\"issuer_cqs\") == 1) &amp;\n                (pl.col(\"maturity_band\") == \"1_5y\")\n            ).then(pl.lit(0.02))\n            .when(\n                (\n                    pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                        \"govt_bond\", \"sovereign_bond\", \"government_bond\", \"gilt\"\n                    ]) |\n                    ((pl.col(\"collateral_type\").str.to_lowercase() == \"bond\") &amp;\n                     (pl.col(\"issuer_type\").str.to_lowercase() == \"sovereign\"))\n                ) &amp;\n                (pl.col(\"issuer_cqs\") == 1)\n            ).then(pl.lit(0.04))\n            .when(\n                (\n                    pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                        \"govt_bond\", \"sovereign_bond\", \"government_bond\", \"gilt\"\n                    ]) |\n                    ((pl.col(\"collateral_type\").str.to_lowercase() == \"bond\") &amp;\n                     (pl.col(\"issuer_type\").str.to_lowercase() == \"sovereign\"))\n                ) &amp;\n                (pl.col(\"issuer_cqs\").is_in([2, 3])) &amp;\n                (pl.col(\"maturity_band\") == \"0_1y\")\n            ).then(pl.lit(0.01))\n            .when(\n                (\n                    pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                        \"govt_bond\", \"sovereign_bond\", \"government_bond\", \"gilt\"\n                    ]) |\n                    ((pl.col(\"collateral_type\").str.to_lowercase() == \"bond\") &amp;\n                     (pl.col(\"issuer_type\").str.to_lowercase() == \"sovereign\"))\n                ) &amp;\n                (pl.col(\"issuer_cqs\").is_in([2, 3])) &amp;\n                (pl.col(\"maturity_band\") == \"1_5y\")\n            ).then(pl.lit(0.03))\n            .when(\n                (\n                    pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                        \"govt_bond\", \"sovereign_bond\", \"government_bond\", \"gilt\"\n                    ]) |\n                    ((pl.col(\"collateral_type\").str.to_lowercase() == \"bond\") &amp;\n                     (pl.col(\"issuer_type\").str.to_lowercase() == \"sovereign\"))\n                ) &amp;\n                (pl.col(\"issuer_cqs\").is_in([2, 3]))\n            ).then(pl.lit(0.06))\n            # Corporate bonds CQS 1-2\n            .when(\n                (pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"corp_bond\", \"corporate_bond\"\n                ])) &amp;\n                (pl.col(\"issuer_cqs\").is_in([1, 2])) &amp;\n                (pl.col(\"maturity_band\") == \"0_1y\")\n            ).then(pl.lit(0.01))\n            .when(\n                (pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"corp_bond\", \"corporate_bond\"\n                ])) &amp;\n                (pl.col(\"issuer_cqs\").is_in([1, 2])) &amp;\n                (pl.col(\"maturity_band\") == \"1_5y\")\n            ).then(pl.lit(0.04))\n            .when(\n                (pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"corp_bond\", \"corporate_bond\"\n                ])) &amp;\n                (pl.col(\"issuer_cqs\").is_in([1, 2]))\n            ).then(pl.lit(0.06))\n            # Corporate bonds CQS 3\n            .when(\n                (pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"corp_bond\", \"corporate_bond\"\n                ])) &amp;\n                (pl.col(\"issuer_cqs\") == 3) &amp;\n                (pl.col(\"maturity_band\") == \"0_1y\")\n            ).then(pl.lit(0.02))\n            .when(\n                (pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"corp_bond\", \"corporate_bond\"\n                ])) &amp;\n                (pl.col(\"issuer_cqs\") == 3) &amp;\n                (pl.col(\"maturity_band\") == \"1_5y\")\n            ).then(pl.lit(0.06))\n            .when(\n                (pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"corp_bond\", \"corporate_bond\"\n                ])) &amp;\n                (pl.col(\"issuer_cqs\") == 3)\n            ).then(pl.lit(0.08))\n            # Equity - main index 15%, other 25%\n            .when(\n                (pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"equity\", \"shares\", \"stock\"\n                ])) &amp;\n                (pl.col(\"is_eligible_financial_collateral\") == True)  # noqa: E712\n            ).then(pl.lit(0.15))  # Main index\n            .when(\n                pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"equity\", \"shares\", \"stock\"\n                ])\n            ).then(pl.lit(0.25))  # Other equity\n            # Receivables - 20%\n            .when(\n                pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"receivables\", \"trade_receivables\"\n                ])\n            ).then(pl.lit(0.20))\n            # Real estate - no haircut (LTV-based treatment)\n            .when(\n                pl.col(\"collateral_type\").str.to_lowercase().is_in([\n                    \"real_estate\", \"property\", \"rre\", \"cre\",\n                    \"residential_property\", \"commercial_property\"\n                ])\n            ).then(pl.lit(0.00))\n            # Other physical - 40%\n            .otherwise(pl.lit(0.40))\n            .alias(\"collateral_haircut\"),\n        ])\n</code></pre>"},{"location":"user-guide/methodology/crm/#crm-data-structure","title":"CRM Data Structure","text":"<p>The calculator accepts CRM data at multiple levels:</p> <pre><code># Collateral data\ncollateral = {\n    \"collateral_id\": \"COL001\",\n    \"counterparty_id\": \"CP001\",  # Or facility_id, loan_id\n    \"collateral_type\": \"cash\",\n    \"value\": 1_000_000,\n    \"currency\": \"GBP\",\n    \"issuer_cqs\": None,  # For bonds\n    \"residual_maturity\": None  # For bonds\n}\n\n# Guarantee data\nguarantee = {\n    \"guarantee_id\": \"GAR001\",\n    \"counterparty_id\": \"CP001\",  # Protected party\n    \"guarantor_id\": \"GP001\",\n    \"amount\": 5_000_000,\n    \"guarantor_type\": \"SOVEREIGN\",\n    \"guarantor_cqs\": 1,\n    \"maturity_date\": date(2028, 12, 31)\n}\n\n# Provision data\nprovision = {\n    \"provision_id\": \"PRV001\",\n    \"counterparty_id\": \"CP001\",  # Or facility_id, loan_id\n    \"provision_type\": \"SCRA\",\n    \"amount\": 500_000,\n    \"ifrs_stage\": \"STAGE_3\"\n}\n</code></pre>"},{"location":"user-guide/methodology/crm/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE CRM overview Art. 192-194 CRE22.1-10 Financial collateral Art. 197-200 CRE22.35-70 Haircuts Art. 224-227 CRE22.50-55 Guarantees Art. 213-216 CRE22.71-85 Maturity mismatch Art. 238-239 CRE22.90-95 Physical collateral Art. 199 CRE22.100-120 Overcollateralisation Art. 230 CRE32.9-12"},{"location":"user-guide/methodology/crm/#next-steps","title":"Next Steps","text":"<ul> <li>Supporting Factors - SME and infrastructure factors</li> <li>Standardised Approach - SA with CRM</li> <li>IRB Approach - IRB with CRM</li> </ul>"},{"location":"user-guide/methodology/equity/","title":"Equity Exposures","text":"<p>Equity exposures receive dedicated risk weight treatment separate from credit risk. The calculator supports two approaches under CRR.</p>"},{"location":"user-guide/methodology/equity/#overview","title":"Overview","text":"<p>Equity exposures are routed directly from classification to the equity calculator, bypassing CRM processing (collateral is not applied to equity holdings).</p> <pre><code>flowchart LR\n    A[Classified Exposures] --&gt; B{Exposure Class}\n    B --&gt;|Equity| C[Equity Calculator]\n    B --&gt;|Other| D[CRM Processor]\n    C --&gt; E[Aggregator]\n    D --&gt; E</code></pre>"},{"location":"user-guide/methodology/equity/#article-133-standardised-approach-sa","title":"Article 133 - Standardised Approach (SA)","text":"<p>The default approach for firms without IRB approval. Risk weights are based on equity type:</p> Equity Type Risk Weight Description Central bank 0% Central bank equity holdings Listed / Exchange-traded 100% Publicly traded on recognised exchanges Government-supported 100% Government-backed equity investments Unlisted / Private equity 250% Non-publicly traded equities Speculative 400% Venture capital, high-risk investments <p>Calculation: <pre><code>RWA = EAD x Risk Weight\n</code></pre></p>"},{"location":"user-guide/methodology/equity/#article-155-irb-simple-risk-weight-method","title":"Article 155 - IRB Simple Risk Weight Method","text":"<p>For firms with IRB permission, a different risk weight schedule applies:</p> Equity Type Risk Weight Description Central bank 0% Central bank equity holdings Private equity (diversified) 190% Diversified portfolio treatment Government-supported 190% Government-backed equity investments Exchange-traded / Listed 290% Publicly traded equities Other equity 370% All other equity holdings"},{"location":"user-guide/methodology/equity/#diversified-portfolio-treatment","title":"Diversified Portfolio Treatment","text":"<p>Private equity holdings in a diversified portfolio receive a reduced risk weight of 190% (vs 370% for non-diversified). This is flagged via the <code>is_diversified_portfolio</code> attribute.</p>"},{"location":"user-guide/methodology/equity/#approach-determination","title":"Approach Determination","text":"<p>The equity approach is determined by the IRB permissions in the configuration:</p> IRB Permission Equity Approach SA only Article 133 (SA) IRB permitted for equity Article 155 (IRB Simple)"},{"location":"user-guide/methodology/equity/#example","title":"Example","text":"<p>Equity holding: Listed shares, \u00a32m</p> <p>SA Treatment (Article 133): <pre><code>RWA = \u00a32,000,000 x 100% = \u00a32,000,000\n</code></pre></p> <p>IRB Simple Treatment (Article 155): <pre><code>RWA = \u00a32,000,000 x 290% = \u00a35,800,000\n</code></pre></p>"},{"location":"user-guide/methodology/equity/#regulatory-references","title":"Regulatory References","text":"Topic Reference SA equity treatment CRR Art. 133 IRB simple risk weight CRR Art. 155 Strategic equity treatment EBA Q&amp;A 2023_6716"},{"location":"user-guide/methodology/fx-conversion/","title":"FX Conversion","text":"<p>The calculator supports multi-currency portfolios by converting all monetary values to a base currency (GBP by default) before performing calculations.</p>"},{"location":"user-guide/methodology/fx-conversion/#why-fx-conversion-matters","title":"Why FX Conversion Matters","text":"<p>Regulatory thresholds (SME turnover, retail exposure limits) are defined in EUR or GBP. Without consistent currency conversion, exposures in foreign currencies would be incorrectly assessed against these thresholds.</p>"},{"location":"user-guide/methodology/fx-conversion/#what-gets-converted","title":"What Gets Converted","text":"Data Type Converted Fields Exposures Drawn amount, undrawn amount, nominal amount Collateral Market value, nominal value Guarantees Covered amount Provisions Provision amount"},{"location":"user-guide/methodology/fx-conversion/#configuration","title":"Configuration","text":"<p>FX conversion is controlled via <code>CalculationConfig</code>:</p> <pre><code>from rwa_calc.contracts.config import CalculationConfig\nfrom datetime import date\n\n# FX conversion enabled by default\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    base_currency=\"GBP\",           # Target currency\n    apply_fx_conversion=True,      # Enable/disable\n)\n</code></pre>"},{"location":"user-guide/methodology/fx-conversion/#input-data","title":"Input Data","text":"<p>FX rates are provided via the <code>fx_rates</code> input table:</p> Column Type Description <code>source_currency</code> String Currency code (e.g., \"USD\", \"EUR\") <code>target_currency</code> String Target currency (must match <code>base_currency</code>) <code>rate</code> Float Exchange rate (source to target)"},{"location":"user-guide/methodology/fx-conversion/#example-fx-rates","title":"Example FX Rates","text":"<pre><code>fx_rates = pl.DataFrame({\n    \"source_currency\": [\"USD\", \"EUR\", \"CHF\"],\n    \"target_currency\": [\"GBP\", \"GBP\", \"GBP\"],\n    \"rate\": [0.79, 0.87, 0.89],\n})\n</code></pre>"},{"location":"user-guide/methodology/fx-conversion/#pipeline-integration","title":"Pipeline Integration","text":"<p>FX conversion occurs early in the pipeline, during hierarchy resolution, so that all downstream calculations (threshold checks, collateral haircuts, RWA) use consistent GBP values.</p> <pre><code>flowchart TD\n    A[Raw Data - Mixed Currencies] --&gt; B[FX Conversion]\n    B --&gt; C[Hierarchy Resolution]\n    C --&gt; D[Classification - GBP thresholds]\n    D --&gt; E[CRM - GBP haircuts]\n    E --&gt; F[Calculators - GBP RWA]</code></pre>"},{"location":"user-guide/methodology/fx-conversion/#audit-trail","title":"Audit Trail","text":"<p>The converter preserves original values for audit:</p> Audit Field Description <code>original_currency</code> Currency before conversion <code>original_amount</code> Amount before conversion <code>fx_rate_applied</code> Rate used for conversion"},{"location":"user-guide/methodology/fx-conversion/#missing-fx-rates","title":"Missing FX Rates","text":"<p>If a currency's FX rate is not provided: - Values are left unchanged (not converted) - <code>fx_rate_applied</code> is set to <code>null</code> - No error is raised (graceful handling)</p>"},{"location":"user-guide/methodology/fx-conversion/#regulatory-thresholds","title":"Regulatory Thresholds","text":"<p>Key thresholds that depend on correct FX conversion:</p> Threshold EUR Value GBP Equivalent SME turnover EUR 50m ~GBP 43.7m SME exposure (SF tier) EUR 2.5m ~GBP 2.2m Retail aggregate EUR 1m ~GBP 880k QRRE individual EUR 100k ~GBP 100k <p>The EUR-to-GBP rate is configurable and defaults to 0.8732.</p>"},{"location":"user-guide/methodology/irb-approach/","title":"IRB Approach","text":"<p>The Internal Ratings-Based (IRB) approach allows banks with regulatory approval to use their own risk estimates for calculating RWA. This provides greater risk sensitivity than the Standardised Approach.</p>"},{"location":"user-guide/methodology/irb-approach/#overview","title":"Overview","text":"<p>Two IRB variants are available:</p> Approach PD LGD EAD CCF Foundation IRB (F-IRB) Bank Supervisory Supervisory Supervisory Advanced IRB (A-IRB) Bank Bank Bank Bank <p>Basel 3.1 Restrictions</p> <p>Under Basel 3.1, A-IRB is no longer permitted for: - Large corporates (revenue &gt; \u00a3500m) - Banks/Financial Institutions - Equity exposures</p>"},{"location":"user-guide/methodology/irb-approach/#irb-formula","title":"IRB Formula","text":"<p>The core IRB formula calculates the capital requirement (K). See <code>irb/formulas.py</code> for the pure Polars implementation.</p> <pre><code>K = [LGD \u00d7 N((1-R)^(-0.5) \u00d7 G(PD) + (R/(1-R))^0.5 \u00d7 G(0.999)) - LGD \u00d7 PD] \u00d7 MA\n</code></pre> <p>Where: - N() = Standard normal cumulative distribution function - G() = Inverse standard normal distribution function - R = Asset correlation - PD = Probability of Default - LGD = Loss Given Default - MA = Maturity Adjustment (for non-retail)</p> <p>Then: <pre><code>RWA = K \u00d7 12.5 \u00d7 EAD \u00d7 Scaling Factor\n</code></pre></p>"},{"location":"user-guide/methodology/irb-approach/#stats-backend","title":"Stats Backend","text":"<p>The IRB formulas require statistical functions (normal CDF and inverse CDF). The calculator uses a backend abstraction that automatically selects the best available implementation:</p> Backend Package Performance Notes polars-normal-stats <code>rwa-calc[fast-stats]</code> Fastest Native Polars, streaming-compatible scipy Core dependency Good Universal fallback via <code>map_batches</code> <p>To check which backend is active:</p> <pre><code>from rwa_calc.engine.irb import get_backend\nprint(f\"Active backend: {get_backend()}\")  # \"polars-normal-stats\" or \"scipy\"\n</code></pre> <p>Performance Recommendation</p> <p>For production environments, install with the <code>fast-stats</code> extra: <pre><code>pip install rwa-calc[fast-stats]\n</code></pre> This enables the native Polars backend which is faster and supports true streaming for large datasets.</p> Capital K Formula Implementation (formulas.py) <pre><code>    # unregulated financial sector entities, the coefficients of correlation are\n    # multiplied by 1.25.\"\n    # Note: The requires_fi_scalar column is set by the classifier\n    fi_scalar = (\n        pl.when(pl.col(\"requires_fi_scalar\").fill_null(False) == True)  # noqa: E712\n        .then(pl.lit(1.25))\n        .otherwise(pl.lit(1.0))\n    )\n\n    return base_correlation * fi_scalar\n\n\ndef _polars_capital_k_expr() -&gt; pl.Expr:\n    \"\"\"\n    Pure Polars expression for capital requirement (K) calculation.\n\n    K = LGD \u00d7 N[(1-R)^(-0.5) \u00d7 G(PD) + (R/(1-R))^(0.5) \u00d7 G(0.999)] - PD \u00d7 LGD\n\n    Uses polars-normal-stats for normal_cdf and normal_ppf functions.\n    \"\"\"\n    # Safe PD to avoid edge cases\n    pd_safe = pl.col(\"pd_floored\").clip(1e-10, 0.9999)\n    lgd = pl.col(\"lgd_floored\")\n    correlation = pl.col(\"correlation\")\n\n    # G(PD) = inverse normal CDF of PD\n    g_pd = normal_ppf(pd_safe)\n\n    # Calculate conditional default probability terms\n    one_minus_r = 1.0 - correlation\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#risk-parameters","title":"Risk Parameters","text":""},{"location":"user-guide/methodology/irb-approach/#probability-of-default-pd","title":"Probability of Default (PD)","text":"<p>PD is the likelihood of default within one year.</p> <p>Floors:</p> Exposure Class CRR Basel 3.1 Corporate 0.03% 0.05% Large Corporate 0.03% 0.05% Bank/Institution 0.03% 0.05% Retail Mortgage 0.03% 0.05% Retail QRRE (Transactor) 0.03% 0.03% Retail QRRE (Revolver) 0.03% 0.10% Retail Other 0.03% 0.05% <pre><code>PD_effective = max(PD_estimated, PD_floor)\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#loss-given-default-lgd","title":"Loss Given Default (LGD)","text":"<p>LGD is the percentage of exposure lost after recoveries.</p> <p>F-IRB Supervisory LGD:</p> Exposure Type LGD Senior Unsecured 45% Subordinated 75% Secured by Financial Collateral 0% Secured by Receivables 35% Secured by CRE/RRE 35% Secured by Other Collateral 40% <p>A-IRB LGD Floors (Basel 3.1 only):</p> Collateral Type LGD Floor Unsecured Senior 25% Unsecured Subordinated 50% Financial Collateral 0% Receivables 15% Commercial Real Estate 15% Residential Real Estate 10% Other Physical 20%"},{"location":"user-guide/methodology/irb-approach/#exposure-at-default-ead","title":"Exposure at Default (EAD)","text":"<p>F-IRB: - On-Balance Sheet: Gross carrying amount - Off-Balance Sheet: Regulatory CCFs apply based on <code>risk_type</code>:</p> Risk Type SA CCF F-IRB CCF Notes FR (full_risk) 100% 100% Guarantees, credit substitutes MR (medium_risk) 50% 75% Committed undrawn, NIFs, RUFs MLR (medium_low_risk) 20% 75% Documentary credits, trade finance LR (low_risk) 0% 0% Unconditionally cancellable <p>CRR Art. 166(8): Under F-IRB, MR and MLR categories both use 75% CCF.</p> <p>CRR Art. 166(9) Exception: Short-term letters of credit arising from the movement of goods retain 20% CCF under F-IRB. Flag these exposures with <code>is_short_term_trade_lc = True</code>.</p> <p>A-IRB: - Bank estimates EAD using internal models - Provide modelled CCF in <code>ccf_modelled</code> column (0.0-1.5, can exceed 100% for Retail IRB) - When <code>ccf_modelled</code> is provided, it takes precedence over risk_type lookup - Subject to CCF floors under Basel 3.1</p>"},{"location":"user-guide/methodology/irb-approach/#maturity-m","title":"Maturity (M)","text":"<p>Effective maturity affects capital through the maturity adjustment.</p> <ul> <li>Range: 1 year (floor) to 5 years (cap)</li> <li>Retail exemption: No maturity adjustment for retail</li> </ul> <pre><code># Effective maturity calculation\nM = max(1, min(5, weighted_average_life))\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#asset-correlation","title":"Asset Correlation","text":"<p>Asset correlation (R) determines how sensitive the exposure is to systematic risk. See <code>_polars_correlation_expr()</code> for the pure Polars implementation.</p>"},{"location":"user-guide/methodology/irb-approach/#corporatebank-correlation","title":"Corporate/Bank Correlation","text":"<pre><code>R = 0.12 \u00d7 (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50)) +\n    0.24 \u00d7 [1 - (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50))]\n</code></pre> <p>This produces: - R = 24% for very low PD - R = 12% for high PD</p>"},{"location":"user-guide/methodology/irb-approach/#sme-size-adjustment","title":"SME Size Adjustment","text":"<p>For SME corporates (turnover \u00a35m-\u00a350m):</p> <pre><code># Size adjustment factor\nS = min(50, max(5, turnover_millions))\n\nR_adjusted = R - 0.04 \u00d7 (1 - (S - 5) / 45)\n</code></pre> <p>This reduces correlation by up to 4 percentage points for smaller firms.</p>"},{"location":"user-guide/methodology/irb-approach/#retail-correlations","title":"Retail Correlations","text":"Retail Type Correlation Residential Mortgage 15% QRRE 4% Other Retail 3-16% (PD-dependent) <p>Other Retail: <pre><code>R = 0.03 \u00d7 (1 - exp(-35 \u00d7 PD)) / (1 - exp(-35)) +\n    0.16 \u00d7 [1 - (1 - exp(-35 \u00d7 PD)) / (1 - exp(-35))]\n</code></pre></p> Actual Correlation Implementation (formulas.py) <pre><code>    eur_gbp_rate: float = 0.8732,\n) -&gt; pl.Expr:\n    \"\"\"\n    Pure Polars expression for correlation calculation.\n\n    Supports all exposure classes with proper correlation formulas:\n    - Corporate/Institution/Sovereign: PD-dependent (decay=50)\n    - Retail mortgage: Fixed 0.15\n    - QRRE: Fixed 0.04\n    - Other retail: PD-dependent (decay=35)\n\n    Includes:\n    - SME firm size adjustment for corporates (turnover converted from GBP to EUR)\n    - FI scalar (1.25x) for large/unregulated financial sector entities (CRR Art. 153(2))\n\n    Args:\n        sme_threshold: SME threshold in EUR millions (default 50.0)\n        eur_gbp_rate: EUR/GBP exchange rate for converting GBP turnover to EUR (default 0.8732)\n    \"\"\"\n    pd = pl.col(\"pd_floored\")\n    exp_class = pl.col(\"exposure_class\").cast(pl.String).fill_null(\"CORPORATE\").str.to_uppercase()\n    turnover = pl.col(\"turnover_m\")\n\n    # Pre-calculate decay denominators (constants)\n    corporate_denom = 1.0 - math.exp(-50.0)\n    retail_denom = 1.0 - math.exp(-35.0)\n\n    # f(PD) for corporate (decay = 50)\n    f_pd_corp = (1.0 - (-50.0 * pd).exp()) / corporate_denom\n\n    # f(PD) for retail (decay = 35)\n    f_pd_retail = (1.0 - (-35.0 * pd).exp()) / retail_denom\n\n    # Corporate correlation: 0.12 \u00d7 f(PD) + 0.24 \u00d7 (1 - f(PD))\n    r_corporate = 0.12 * f_pd_corp + 0.24 * (1.0 - f_pd_corp)\n\n    # Retail other correlation: 0.03 \u00d7 f(PD) + 0.16 \u00d7 (1 - f(PD))\n    r_retail_other = 0.03 * f_pd_retail + 0.16 * (1.0 - f_pd_retail)\n\n    # SME adjustment for corporates: reduce correlation based on turnover\n    # The SME threshold is in EUR, but turnover_m is stored in GBP millions\n    # Convert GBP turnover to EUR: turnover_eur = turnover_gbp / eur_gbp_rate\n    # s_clamped = max(5, min(turnover_eur, 50))\n    # adjustment = 0.04 \u00d7 (1 - (s_clamped - 5) / 45)\n    # Cast to Float64 first to handle null dtype, then convert to EUR and clip\n    turnover_float = turnover.cast(pl.Float64)\n    turnover_eur = turnover_float / eur_gbp_rate\n    s_clamped = turnover_eur.clip(5.0, sme_threshold)\n    sme_adjustment = 0.04 * (1.0 - (s_clamped - 5.0) / 45.0)\n\n    # Corporate with SME adjustment (when turnover_eur &lt; threshold and is corporate)\n    is_corporate = exp_class.str.contains(\"CORPORATE\")\n    # Use is_not_null() and is_finite() to check for valid turnover values\n    # is_finite() returns false for NaN and infinities, handles null dtype gracefully\n    has_valid_turnover = turnover_eur.is_not_null() &amp; turnover_eur.is_finite()\n    is_sme = has_valid_turnover &amp; (turnover_eur &lt; sme_threshold)\n\n    r_corporate_with_sme = (\n        pl.when(is_corporate &amp; is_sme)\n        .then(r_corporate - sme_adjustment)\n        .otherwise(r_corporate)\n    )\n\n    # Build base correlation based on exposure class\n    base_correlation = (\n        pl.when(exp_class.str.contains(\"MORTGAGE\") | exp_class.str.contains(\"RESIDENTIAL\"))\n        .then(pl.lit(0.15))\n        .when(exp_class.str.contains(\"QRRE\"))\n        .then(pl.lit(0.04))\n        .when(exp_class.str.contains(\"RETAIL\"))\n        .then(r_retail_other)\n        .otherwise(r_corporate_with_sme)\n    )\n\n    # Apply FI scalar (1.25x) for large/unregulated financial sector entities\n    # Per CRR Article 153(2): \"For all exposures to large financial sector entities,\n    # the coefficient of correlation is multiplied by 1.25. For all exposures to\n    # unregulated financial sector entities, the coefficients of correlation are\n    # multiplied by 1.25.\"\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#maturity-adjustment","title":"Maturity Adjustment","text":"<p>For non-retail exposures. See <code>_polars_maturity_adjustment_expr()</code> for the pure Polars implementation.</p> <pre><code># Maturity factor b\nb = (0.11852 - 0.05478 \u00d7 ln(PD))^2\n\n# Maturity adjustment\nMA = (1 + (M - 2.5) \u00d7 b) / (1 - 1.5 \u00d7 b)\n</code></pre> <p>Where M is effective maturity in years.</p> Actual Maturity Adjustment (formulas.py) <pre><code>    # K = LGD \u00d7 conditional_pd - PD \u00d7 LGD\n    k = lgd * conditional_pd - pd_safe * lgd\n\n    # Floor at 0\n    return pl.max_horizontal(k, pl.lit(0.0))\n\n\ndef _polars_maturity_adjustment_expr(\n    maturity_floor: float = 1.0,\n    maturity_cap: float = 5.0,\n) -&gt; pl.Expr:\n    \"\"\"\n    Pure Polars expression for maturity adjustment calculation.\n\n    b = (0.11852 - 0.05478 \u00d7 ln(PD))\u00b2\n    MA = (1 + (M - 2.5) \u00d7 b) / (1 - 1.5 \u00d7 b)\n    \"\"\"\n    # Clamp maturity to bounds\n    m = pl.col(\"maturity\").clip(maturity_floor, maturity_cap)\n</code></pre> <p>Example values:</p> PD M=1yr M=2.5yr M=5yr 0.03% 0.853 1.000 1.221 0.10% 0.880 1.000 1.177 1.00% 0.934 1.000 1.099 5.00% 0.966 1.000 1.050"},{"location":"user-guide/methodology/irb-approach/#scaling-factor","title":"Scaling Factor","text":"Framework Scaling Factor CRR 1.06 Basel 3.1 1.00 (none) <pre><code># CRR\nRWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA \u00d7 1.06\n\n# Basel 3.1\nRWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#expected-loss-el","title":"Expected Loss (EL)","text":"<p>IRB requires calculation of Expected Loss:</p> <pre><code>EL = PD \u00d7 LGD \u00d7 EAD\n</code></pre> <p>EL is compared to provisions: - EL &gt; Provisions: Shortfall deducted from capital - EL &lt; Provisions: Excess added to Tier 2 (with limits)</p>"},{"location":"user-guide/methodology/irb-approach/#detailed-calculation-example","title":"Detailed Calculation Example","text":"<p>Exposure: - Corporate loan, \u00a350m - Bank-estimated PD: 0.50% - F-IRB (LGD = 45%) - Maturity: 3 years - Counterparty turnover: \u00a325m (SME)</p> <p>Step 1: Apply PD Floor <pre><code>PD = max(0.0050, 0.0003) = 0.0050  # 0.50%\n</code></pre></p> <p>Step 2: Calculate Asset Correlation <pre><code># Base correlation\nR_base = 0.12 \u00d7 (1 - exp(-50 \u00d7 0.005)) / (1 - exp(-50)) +\n         0.24 \u00d7 (1 - (1 - exp(-50 \u00d7 0.005)) / (1 - exp(-50)))\nR_base = 0.12 \u00d7 0.221 + 0.24 \u00d7 0.779 = 0.214\n\n# SME adjustment (turnover \u00a325m)\nS = 25\nadjustment = 0.04 \u00d7 (1 - (25 - 5) / 45) = 0.04 \u00d7 0.556 = 0.022\nR = 0.214 - 0.022 = 0.192\n</code></pre></p> <p>Step 3: Calculate Capital Requirement (K) <pre><code># Intermediate calculations\nG_PD = norm.ppf(0.005) = -2.576\nG_999 = norm.ppf(0.999) = 3.090\n\nterm1 = (1 - R)^(-0.5) \u00d7 G_PD = 1.113 \u00d7 (-2.576) = -2.867\nterm2 = (R / (1-R))^0.5 \u00d7 G_999 = 0.487 \u00d7 3.090 = 1.505\n\nK_pre = LGD \u00d7 N(term1 + term2) - LGD \u00d7 PD\nK_pre = 0.45 \u00d7 N(-1.362) - 0.45 \u00d7 0.005\nK_pre = 0.45 \u00d7 0.0867 - 0.00225\nK_pre = 0.0390 - 0.00225 = 0.0367\n</code></pre></p> <p>Step 4: Calculate Maturity Adjustment <pre><code>b = (0.11852 - 0.05478 \u00d7 ln(0.005))^2 = (0.11852 + 0.290)^2 = 0.167\nMA = (1 + (3 - 2.5) \u00d7 0.167) / (1 - 1.5 \u00d7 0.167)\nMA = 1.0835 / 0.7495 = 1.446\n</code></pre></p> <p>Step 5: Calculate RWA <pre><code># CRR\nRWA_CRR = K \u00d7 12.5 \u00d7 EAD \u00d7 MA \u00d7 1.06\nRWA_CRR = 0.0367 \u00d7 12.5 \u00d7 50,000,000 \u00d7 1.446 \u00d7 1.06\nRWA_CRR = \u00a335,142,968\n\nRW_CRR = RWA / EAD = 70.3%\n\n# Basel 3.1 (no scaling)\nRWA_B31 = 0.0367 \u00d7 12.5 \u00d7 50,000,000 \u00d7 1.446 \u00d7 1.00\nRWA_B31 = \u00a333,154,688\n\nRW_B31 = 66.3%\n</code></pre></p> <p>Step 6: Check Output Floor (Basel 3.1) <pre><code># SA equivalent RWA (assume 100% RW corporate)\nRWA_SA = 50,000,000 \u00d7 100% = \u00a350,000,000\n\n# Output floor (72.5%)\nFloor = 50,000,000 \u00d7 0.725 = \u00a336,250,000\n\n# Final RWA\nRWA_final = max(33,154,688, 36,250,000) = \u00a336,250,000\n</code></pre></p>"},{"location":"user-guide/methodology/irb-approach/#implementation","title":"Implementation","text":""},{"location":"user-guide/methodology/irb-approach/#using-the-irb-namespace-recommended","title":"Using the IRB Namespace (Recommended)","text":"<p>The IRB module provides a Polars namespace extension for fluent, chainable calculations:</p> <pre><code>import polars as pl\nfrom datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\nimport rwa_calc.engine.irb.namespace  # Registers .irb namespace\n\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# Create sample exposure data\nexposures = pl.LazyFrame({\n    \"exposure_reference\": [\"EXP001\"],\n    \"pd\": [0.005],\n    \"lgd\": [0.45],\n    \"ead_final\": [50_000_000.0],\n    \"maturity\": [3.0],\n    \"exposure_class\": [\"CORPORATE\"],\n    \"turnover_m\": [25.0],  # Annual turnover in millions\n})\n\n# Fluent IRB calculation pipeline\nresult = (\n    exposures\n    .irb.classify_approach(config)   # Determine F-IRB vs A-IRB\n    .irb.apply_firb_lgd(config)      # Apply supervisory LGD for F-IRB\n    .irb.prepare_columns(config)     # Ensure required columns exist\n    .irb.apply_all_formulas(config)  # Run full IRB calculation\n    .collect()\n)\n\n# Access results\nprint(result.select([\n    \"pd_floored\", \"correlation\", \"k\", \"maturity_adjustment\", \"rwa\", \"expected_loss\"\n]))\n</code></pre> <p>Individual formula steps can also be chained:</p> <pre><code>result = (\n    exposures\n    .irb.apply_pd_floor(config)\n    .irb.apply_lgd_floor(config)\n    .irb.calculate_correlation(config)\n    .irb.calculate_k(config)\n    .irb.calculate_maturity_adjustment(config)\n    .irb.calculate_rwa(config)\n    .irb.calculate_expected_loss(config)\n)\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#using-the-irb-calculator","title":"Using the IRB Calculator","text":"<pre><code>from rwa_calc.engine.irb.calculator import IRBCalculator\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# Create calculator\ncalculator = IRBCalculator()\n\n# Calculate\nresult = calculator.calculate(\n    exposures=classified_exposures,\n    config=CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n)\n\n# Results\nprint(f\"IRB RWA: {result.total_rwa:,.2f}\")\nprint(f\"Expected Loss: {result.total_expected_loss:,.2f}\")\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#using-irb-formulas-directly","title":"Using IRB Formulas Directly","text":"<p>The IRB formulas are implemented in <code>irb/formulas.py</code>. Both scalar functions and pure Polars expression functions are available.</p> <p>Implementation Architecture</p> <ul> <li>Vectorized expressions: Pure Polars expressions for bulk processing (used by namespace and calculator)</li> <li>Scalar wrappers: Thin wrappers around vectorized expressions for single-value calculations</li> <li>Stats backend: Auto-detects <code>polars-normal-stats</code> (native) or <code>scipy</code> (fallback)</li> </ul> <pre><code>from rwa_calc.engine.irb.formulas import (\n    calculate_k,\n    calculate_correlation,\n    calculate_maturity_adjustment,\n    calculate_irb_rwa,  # Convenience function for single exposures\n)\n\n# Calculate components\nR = calculate_correlation(\n    pd=0.005,\n    exposure_class=\"CORPORATE\",\n    turnover_m=25.0  # Turnover in millions\n)\n\nMA = calculate_maturity_adjustment(pd=0.005, maturity=3)\n\nK = calculate_k(pd=0.005, lgd=0.45, correlation=R)\n\n# Calculate RWA\nrwa = K * 12.5 * ead * MA * scaling_factor\n\n# Or use the convenience function for complete calculation\nresult = calculate_irb_rwa(\n    ead=50_000_000,\n    pd=0.005,\n    lgd=0.45,\n    correlation=R,\n    maturity=3.0,\n    apply_scaling_factor=True,  # CRR 1.06 factor\n)\nprint(f\"RWA: {result['rwa']:,.0f}\")\n</code></pre> Scalar K Calculation (formulas.py) <pre><code>    return _run_scalar_via_vectorized(\n        {\n            \"pd_floored\": pd,\n            \"exposure_class\": exposure_class,\n            \"turnover_m\": turnover_m,\n            \"requires_fi_scalar\": apply_fi_scalar,\n            \"eur_gbp_rate\": eur_gbp_rate,\n        },\n        \"correlation\",\n    )\n\n\ndef calculate_k(pd: float, lgd: float, correlation: float) -&gt; float:\n    \"\"\"Scalar capital requirement calculation.\n\n    Wrapper around _polars_capital_k_expr() - uses the same implementation\n    as vectorized processing.\n\n    Args:\n        pd: Probability of default (floored)\n        lgd: Loss given default (floored)\n        correlation: Asset correlation\n\n    Returns:\n        Capital requirement K value\n    \"\"\"\n    # Handle edge cases that vectorized expression clips\n    if pd &gt;= 1.0:\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#expected-loss-calculation","title":"Expected Loss Calculation","text":"<pre><code>from rwa_calc.engine.irb.calculator import calculate_expected_loss\n\nel = calculate_expected_loss(\n    pd=0.005,\n    lgd=0.45,\n    ead=50_000_000\n)\n# el = 0.005 \u00d7 0.45 \u00d7 50,000,000 = \u00a3112,500\n</code></pre>"},{"location":"user-guide/methodology/irb-approach/#f-irb-vs-a-irb-comparison","title":"F-IRB vs A-IRB Comparison","text":"Parameter F-IRB A-IRB PD Bank estimate Bank estimate LGD Supervisory (45%/75%) Bank estimate (floored) EAD Regulatory Bank estimate CCF Regulatory Bank estimate Typical RW Higher Lower Complexity Lower Higher Approval Easier Harder"},{"location":"user-guide/methodology/irb-approach/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE IRB approach overview Art. 142-150 CRE30 K formula Art. 153 CRE31 PD estimation Art. 178-180 CRE32 LGD estimation Art. 181 CRE32 Correlation Art. 153 CRE31 Maturity adjustment Art. 162 CRE31 Supervisory LGD Art. 161 CRE32"},{"location":"user-guide/methodology/irb-approach/#next-steps","title":"Next Steps","text":"<ul> <li>Standardised Approach - Compare with SA</li> <li>Credit Risk Mitigation - CRM under IRB</li> <li>Supporting Factors - SME correlation adjustment</li> </ul>"},{"location":"user-guide/methodology/specialised-lending/","title":"Specialised Lending","text":"<p>Specialised Lending exposures are those where repayment depends primarily on the cash flows generated by the financed assets rather than the independent capacity of the borrower. These exposures receive special treatment under both SA and IRB frameworks.</p>"},{"location":"user-guide/methodology/specialised-lending/#overview","title":"Overview","text":"<p>Specialised lending categories:</p> Category Abbreviation Description Project Finance PF Financing of large, complex projects Object Finance OF Financing of physical assets (ships, aircraft) Commodities Finance CF Structured financing of commodities Income-Producing Real Estate IPRE Real estate with rental/sale income High Volatility Commercial Real Estate HVCRE Speculative CRE development"},{"location":"user-guide/methodology/specialised-lending/#slotting-approach","title":"Slotting Approach","text":"<p>The Slotting Approach maps exposures to supervisory categories based on qualitative criteria, rather than estimating PD:</p> <pre><code>flowchart LR\n    A[Exposure] --&gt; B[Assess Criteria]\n    B --&gt; C{Map to Category}\n    C --&gt; D[Strong]\n    C --&gt; E[Good]\n    C --&gt; F[Satisfactory]\n    C --&gt; G[Weak]\n    C --&gt; H[Default]\n    D --&gt; I[Risk Weight]\n    E --&gt; I\n    F --&gt; I\n    G --&gt; I\n    H --&gt; J[Expected Loss]</code></pre>"},{"location":"user-guide/methodology/specialised-lending/#slotting-categories","title":"Slotting Categories","text":""},{"location":"user-guide/methodology/specialised-lending/#assessment-criteria","title":"Assessment Criteria","text":"<p>Each exposure is assessed against supervisory criteria:</p> Factor Strong Good Satisfactory Weak Financial strength Excellent Good Acceptable Deteriorating Political/legal Very low Low Acceptable High Transaction characteristics Very favorable Favorable Acceptable Unfavorable Asset strength Very strong Strong Adequate Weak Sponsor strength Excellent Good Adequate Weak"},{"location":"user-guide/methodology/specialised-lending/#project-finance-criteria","title":"Project Finance Criteria","text":"Factor Strong Good Satisfactory Weak Market conditions Few competing suppliers Few suppliers, demand stable Average Weak or declining Financial ratios Strong coverage Good coverage Adequate Weak Stress resilience Robust Good Limited Poor Contractual arrangements Strong contracts Acceptable Some weaknesses Significant gaps Reserve accounts Comprehensive Adequate Minimum Insufficient"},{"location":"user-guide/methodology/specialised-lending/#ipre-criteria","title":"IPRE Criteria","text":"Factor Strong Good Satisfactory Weak LTV &lt;60% 60-75% 75-85% &gt;85% DSCR &gt;1.35x 1.2-1.35x 1.0-1.2x &lt;1.0x Location Prime Good Acceptable Weak Tenant quality Strong Adequate Variable Poor Lease length Long-term Medium-term Short-term Month-to-month"},{"location":"user-guide/methodology/specialised-lending/#risk-weights","title":"Risk Weights","text":""},{"location":"user-guide/methodology/specialised-lending/#crr-risk-weights","title":"CRR Risk Weights","text":"<p>Under CRR, all specialised lending types (including HVCRE) use the same risk weights, with Strong and Good both at 70%:</p> Category Strong Good Satisfactory Weak Default All types (incl. HVCRE) 70% 70% 115% 250% 0%* <p>*Default exposures: 0% RW with 50% EL deduction</p>"},{"location":"user-guide/methodology/specialised-lending/#basel-31-risk-weights","title":"Basel 3.1 Risk Weights","text":"<p>Basel 3.1 introduces differentiated weights for HVCRE and pre-operational project finance:</p> Category Strong Good Satisfactory Weak Default PF (Pre-Operational) 80% 100% 120% 350% 0%* Standard (PF Operational, OF, CF, IPRE) 70% 70% 115% 250% 0%* HVCRE 95% 120% 140% 250% 0%* <p>Basel 3.1 Project Finance Changes</p> <p>Pre-operational project finance receives higher risk weights under Basel 3.1: - Strong: 70% \u2192 80% - Good: 70% \u2192 100% - Satisfactory: 115% \u2192 120% - Weak: 250% \u2192 350%</p>"},{"location":"user-guide/methodology/specialised-lending/#expected-loss-for-default","title":"Expected Loss for Default","text":"<p>For defaulted exposures (50% EL assumption):</p> <pre><code># Instead of RWA\nEL_deduction = EAD \u00d7 50%\n\n# This is deducted from capital directly\n</code></pre>"},{"location":"user-guide/methodology/specialised-lending/#calculation-example","title":"Calculation Example","text":"<p>Exposure: - IPRE loan, \u00a320m - LTV: 65% - DSCR: 1.25x - Prime location - Strong tenant - Category assessment: Good</p> <p>CRR Calculation: <pre><code># Category: Good\nRisk_Weight = 90%\n\n# RWA\nRWA = EAD \u00d7 Risk_Weight\nRWA = \u00a320,000,000 \u00d7 90%\nRWA = \u00a318,000,000\n</code></pre></p> <p>Basel 3.1 Calculation: <pre><code># Same category and weight\nRWA = \u00a318,000,000\n\n# Check output floor\nSA_equivalent_RW = 70%  # IPRE LTV 60-75%\nSA_RWA = \u00a320,000,000 \u00d7 70% = \u00a314,000,000\nFloor = \u00a314,000,000 \u00d7 72.5% = \u00a310,150,000\n\n# Slotting RWA &gt; Floor, so no adjustment\nFinal_RWA = \u00a318,000,000\n</code></pre></p>"},{"location":"user-guide/methodology/specialised-lending/#sa-alternative","title":"SA Alternative","text":"<p>Specialised lending can also be treated under SA:</p> Type SA Treatment Project Finance Corporate risk weights Object Finance Corporate risk weights Commodities Finance Corporate risk weights IPRE CRE risk weights HVCRE CRE risk weights <p>When to use SA vs Slotting:</p> Use SA when Use Slotting when External rating available No PD estimate available IRB not approved IRB approved for portfolio Lower SA RW expected Specialized assessment needed"},{"location":"user-guide/methodology/specialised-lending/#implementation","title":"Implementation","text":""},{"location":"user-guide/methodology/specialised-lending/#slotting-calculator","title":"Slotting Calculator","text":"<pre><code>from rwa_calc.engine.slotting.calculator import SlottingCalculator\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# Create calculator\ncalculator = SlottingCalculator()\n\n# Calculate\nresult = calculator.calculate(\n    exposures=specialised_lending_exposures,\n    config=CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n)\n\nprint(f\"Slotting RWA: {result.total_rwa:,.2f}\")\n</code></pre>"},{"location":"user-guide/methodology/specialised-lending/#category-mapping","title":"Category Mapping","text":"<pre><code>from rwa_calc.data.tables.crr_slotting import get_slotting_risk_weight\nfrom rwa_calc.domain.enums import SlottingCategory, SpecialisedLendingType\n\n# Lookup risk weight\nrw = get_slotting_risk_weight(\n    lending_type=SpecialisedLendingType.IPRE,\n    category=SlottingCategory.GOOD\n)\n# Returns: 0.90 (90%)\n</code></pre>"},{"location":"user-guide/methodology/specialised-lending/#project-finance-detail","title":"Project Finance Detail","text":""},{"location":"user-guide/methodology/specialised-lending/#pre-operational-phase","title":"Pre-Operational Phase","text":"<p>Project is in construction or commissioning: - Construction risk present - Cash flows not yet established - Higher risk weights under Basel 3.1</p>"},{"location":"user-guide/methodology/specialised-lending/#operational-phase","title":"Operational Phase","text":"<p>Project is generating cash flows: - Construction complete - Revenue stream established - Standard slotting weights apply</p>"},{"location":"user-guide/methodology/specialised-lending/#phase-transition","title":"Phase Transition","text":"<pre><code>if project.construction_complete and project.generating_cashflows:\n    phase = \"operational\"\nelse:\n    phase = \"pre_operational\"\n\n# Basel 3.1 applies different weights\nif framework == \"BASEL_3_1\" and lending_type == \"PROJECT_FINANCE\":\n    if phase == \"pre_operational\":\n        # Use higher pre-op weights\n        weights = {\"strong\": 0.80, \"good\": 1.00, \"satisfactory\": 1.20, \"weak\": 3.50}\n    else:\n        # Use standard weights\n        weights = {\"strong\": 0.70, \"good\": 0.90, \"satisfactory\": 1.15, \"weak\": 2.50}\n</code></pre>"},{"location":"user-guide/methodology/specialised-lending/#hvcre-treatment","title":"HVCRE Treatment","text":"<p>High Volatility Commercial Real Estate receives higher risk weights due to: - Speculative development - No established cash flows - Higher correlation to economic cycles</p> <p>HVCRE Criteria: - CRE development or land acquisition - Repayment from future sale or refinancing - Uncertain outcome</p> <p>Risk Weights:</p> Category CRR (all types) Basel 3.1 HVCRE Strong 70% 95% Good 70% 120% Satisfactory 115% 140% Weak 250% 250%"},{"location":"user-guide/methodology/specialised-lending/#supporting-factors","title":"Supporting Factors","text":""},{"location":"user-guide/methodology/specialised-lending/#infrastructure-factor-crr-only","title":"Infrastructure Factor (CRR Only)","text":"<p>Qualifying infrastructure project finance receives 0.75 factor:</p> <pre><code># Eligibility\nif (lending_type == \"PROJECT_FINANCE\" and\n    is_qualifying_infrastructure and\n    framework == \"CRR\"):\n\n    RWA = RWA \u00d7 0.75\n</code></pre> <p>Qualifying criteria: - Infrastructure project entity - Revenue in EUR/GBP or hedged - Contractual arrangements limit risk - Stable cash flow structure</p> <p>Basel 3.1</p> <p>Infrastructure factor is removed under Basel 3.1.</p>"},{"location":"user-guide/methodology/specialised-lending/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE Specialised lending definition Art. 147(8) CRE33.1 Slotting categories Art. 153(5) CRE33.2 Risk weights Art. 153(5) CRE33.3-4 HVCRE Art. 153(5) CRE33.5 Infrastructure factor Art. 501a N/A"},{"location":"user-guide/methodology/specialised-lending/#next-steps","title":"Next Steps","text":"<ul> <li>Credit Risk Mitigation - CRM for specialised lending</li> <li>Supporting Factors - Infrastructure factor details</li> <li>Configuration - Slotting configuration</li> </ul>"},{"location":"user-guide/methodology/standardised-approach/","title":"Standardised Approach","text":"<p>The Standardised Approach (SA) uses regulatory-prescribed risk weights based on external credit ratings and exposure characteristics. It is the default approach for institutions without IRB approval.</p>"},{"location":"user-guide/methodology/standardised-approach/#overview","title":"Overview","text":"<pre><code>RWA = EAD \u00d7 Risk Weight \u00d7 Supporting Factors\n</code></pre> <p>The SA calculation involves: 1. Determining the Exposure Class 2. Mapping to a Credit Quality Step (CQS) if rated 3. Looking up the Risk Weight 4. Applying Supporting Factors (CRR only)</p>"},{"location":"user-guide/methodology/standardised-approach/#risk-weight-determination","title":"Risk Weight Determination","text":"<pre><code>flowchart TD\n    A[Exposure] --&gt; B{Has External Rating?}\n    B --&gt;|Yes| C[Map to CQS]\n    B --&gt;|No| D[Unrated Treatment]\n    C --&gt; E[Lookup RW by Class + CQS]\n    D --&gt; F[Default RW for Class]\n    E --&gt; G[Apply Supporting Factors]\n    F --&gt; G\n    G --&gt; H[Calculate RWA]</code></pre>"},{"location":"user-guide/methodology/standardised-approach/#credit-quality-steps-cqs","title":"Credit Quality Steps (CQS)","text":"<p>External ratings are mapped to Credit Quality Steps:</p> CQS S&amp;P/Fitch Moody's Description CQS 1 AAA to AA- Aaa to Aa3 Prime/High Grade CQS 2 A+ to A- A1 to A3 Upper Medium Grade CQS 3 BBB+ to BBB- Baa1 to Baa3 Lower Medium Grade CQS 4 BB+ to BB- Ba1 to Ba3 Non-Investment Grade CQS 5 B+ to B- B1 to B3 Highly Speculative CQS 6 CCC+ and below Caa1 and below Substantial Risk"},{"location":"user-guide/methodology/standardised-approach/#risk-weights-by-exposure-class","title":"Risk Weights by Exposure Class","text":""},{"location":"user-guide/methodology/standardised-approach/#sovereign-exposures","title":"Sovereign Exposures","text":"<p>Exposures to governments and central banks:</p> CQS Risk Weight CQS 1 0% CQS 2 20% CQS 3 50% CQS 4 100% CQS 5 100% CQS 6 150% Unrated 100% <p>UK Government</p> <p>UK Government (HM Treasury) exposures receive 0% risk weight as a CQS 1 sovereign.</p>"},{"location":"user-guide/methodology/standardised-approach/#institution-exposures","title":"Institution Exposures","text":"<p>Exposures to banks and investment firms:</p> CQS CRR Risk Weight Basel 3.1 (ECRA) CQS 1 20% 20% CQS 2 30%* 30% CQS 3 50% 50% CQS 4 100% 100% CQS 5 100% 100% CQS 6 150% 150% <p>*UK deviation from standard 50% Basel weight</p> <p>Unrated Institutions: - CRR: Apply due diligence assessment - Basel 3.1: Use Standardised Credit Risk Assessment (SCRA)</p>"},{"location":"user-guide/methodology/standardised-approach/#corporate-exposures","title":"Corporate Exposures","text":"<p>Exposures to non-financial corporates:</p> CQS CRR Basel 3.1 CQS 1 20% 20% CQS 2 50% 50% CQS 3 75% 75% CQS 4 100% 100% CQS 5 150% 100% CQS 6 150% 150% Unrated 100% 100% <p>Corporate SME: - Same risk weights as Corporate - SME Supporting Factor may apply (CRR only)</p>"},{"location":"user-guide/methodology/standardised-approach/#retail-exposures","title":"Retail Exposures","text":"<p>Residential Mortgages (CRR):</p> Criterion Risk Weight LTV \u2264 80%, performing 35% LTV &gt; 80% or other 75% <p>Residential Mortgages (Basel 3.1):</p> LTV Whole Loan Income-Producing \u2264 50% 20% 30% 50-60% 25% 35% 60-70% 30% 45% 70-80% 40% 60% 80-90% 50% 75% 90-100% 70% 105% &gt; 100% Cpty RW Cpty RW <p>QRRE (Qualifying Revolving Retail Exposures):</p> Framework Risk Weight CRR 75% Basel 3.1 45-75% (depends on transactor status) <p>Other Retail:</p> Framework Risk Weight CRR 75% Basel 3.1 75%"},{"location":"user-guide/methodology/standardised-approach/#defaulted-exposures","title":"Defaulted Exposures","text":"<p>Exposures where the counterparty is in default:</p> Provision Coverage CRR Basel 3.1 &lt; 20% 150% 150% 20-50% 100% 100% \u2265 50% 100% 50-100%"},{"location":"user-guide/methodology/standardised-approach/#equity-exposures","title":"Equity Exposures","text":"Type CRR Basel 3.1 Exchange-traded 100% 100% Other equity 150% 250% Private equity 150% 400%"},{"location":"user-guide/methodology/standardised-approach/#commercial-real-estate","title":"Commercial Real Estate","text":"Scenario CRR Basel 3.1 Standard 100% 100% Income-Producing (LTV \u2264 60%) 100% 70% Income-Producing (LTV &gt; 60%) 100% 110%"},{"location":"user-guide/methodology/standardised-approach/#ead-calculation","title":"EAD Calculation","text":""},{"location":"user-guide/methodology/standardised-approach/#on-balance-sheet","title":"On-Balance Sheet","text":"<pre><code>EAD = Gross_Carrying_Amount - Specific_Provisions\n</code></pre>"},{"location":"user-guide/methodology/standardised-approach/#off-balance-sheet","title":"Off-Balance Sheet","text":"<pre><code>EAD = Committed_Amount \u00d7 CCF\n</code></pre> <p>Credit Conversion Factors by Risk Type (CRR Art. 111):</p> <p>The <code>risk_type</code> column determines the CCF for off-balance sheet exposures:</p> Risk Type Code SA CCF Description Full Risk FR 100% Guarantees, acceptances, credit derivatives Medium Risk MR 50% NIFs, RUFs, standby LCs, committed undrawn Medium-Low Risk MLR 20% Documentary credits, short-term trade finance Low Risk LR 0% Unconditionally cancellable commitments <p>Basel 3.1 Changes:</p> Item Type CRR CCF Basel 3.1 CCF Unconditionally Cancellable 0% 10% Trade Finance (ST) 20% 20% Undrawn Commitments (&lt;1yr) 20% 40% Undrawn Commitments (\u22651yr) 50% 40% NIFs/RUFs 50% 50% Direct Credit Substitutes 100% 100%"},{"location":"user-guide/methodology/standardised-approach/#credit-risk-mitigation","title":"Credit Risk Mitigation","text":"<p>SA allows several CRM techniques:</p>"},{"location":"user-guide/methodology/standardised-approach/#financial-collateral-simple-method","title":"Financial Collateral Simple Method","text":"<pre><code># Reduce RW based on collateral\nCollateral_RW = Risk_Weight_of_Collateral_Issuer\n\n# Apply lower of exposure RW or collateral RW\nEffective_RW = min(Exposure_RW, Collateral_RW)\n</code></pre>"},{"location":"user-guide/methodology/standardised-approach/#financial-collateral-comprehensive-method","title":"Financial Collateral Comprehensive Method","text":"<pre><code># Calculate adjusted values\nE_adjusted = Exposure \u00d7 (1 + H_e)  # Exposure haircut\nC_adjusted = Collateral \u00d7 (1 - H_c - H_fx)  # Collateral haircut\n\n# Net exposure\nE_star = max(0, E_adjusted - C_adjusted)\n\n# RWA on net exposure\nRWA = E_star \u00d7 Risk_Weight\n</code></pre> <p>Supervisory Haircuts:</p> Collateral Type Haircut Cash (same currency) 0% Government bonds \u22641yr 0.5% Government bonds 1-5yr 2% Government bonds &gt;5yr 4% Corporate bonds AAA-AA \u22641yr 1% Corporate bonds AAA-AA 1-5yr 4% Corporate bonds AAA-AA &gt;5yr 8% Main index equity 15% Other equity 25% Currency mismatch add-on +8%"},{"location":"user-guide/methodology/standardised-approach/#guarantees-substitution-approach","title":"Guarantees (Substitution Approach)","text":"<pre><code># Guaranteed portion treated as exposure to guarantor\nGuaranteed_RWA = Guaranteed_Amount \u00d7 Guarantor_RW\n\n# Unguaranteed portion at counterparty RW\nUnguaranteed_RWA = (EAD - Guaranteed_Amount) \u00d7 Counterparty_RW\n\n# Total RWA\nRWA = Guaranteed_RWA + Unguaranteed_RWA\n</code></pre>"},{"location":"user-guide/methodology/standardised-approach/#supporting-factors-crr-only","title":"Supporting Factors (CRR Only)","text":"<p>Supporting factors are implemented in <code>sa/supporting_factors.py</code>.</p>"},{"location":"user-guide/methodology/standardised-approach/#sme-supporting-factor","title":"SME Supporting Factor","text":"<p>Reduces RWA for SME exposures (CRR Art. 501):</p> <p>Conceptual Logic</p> <p>The following illustrates the SME factor calculation. See the actual implementation for the full Polars-based processing.</p> <pre><code># Check eligibility\nif turnover &lt;= EUR_50m and is_sme:\n    threshold = EUR_2.5m  # GBP 2.2m\n\n    if exposure &lt;= threshold:\n        factor = 0.7619\n    else:\n        factor = (threshold * 0.7619 + (exposure - threshold) * 0.85) / exposure\n\n    RWA = RWA * factor\n</code></pre> Actual Implementation (supporting_factors.py) <pre><code>\"\"\"\nCRR Supporting Factors for SA calculator (CRR2 Art. 501).\n\nApplies SME and infrastructure supporting factors to RWA calculations.\nThese factors are CRR-specific and NOT available under Basel 3.1.\n\nSME Supporting Factor - Tiered Approach (CRR2 Art. 501):\n- Exposures up to EUR 2.5m (GBP 2.2m): factor of 0.7619\n- Exposures above EUR 2.5m (GBP 2.2m): factor of 0.85\n\nFormula:\n    factor = [min(E, threshold) \u00d7 0.7619 + max(E - threshold, 0) \u00d7 0.85] / E\n\nInfrastructure Supporting Factor (CRR Art. 501a):\n- Qualifying infrastructure: factor of 0.75\n\nReferences:\n- CRR2 Art. 501 (EU 2019/876 amending EU 575/2013)\n- CRR Art. 501a: Infrastructure supporting factor\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass\nfrom decimal import Decimal\nfrom typing import TYPE_CHECKING\n\nimport polars as pl\n\nif TYPE_CHECKING:\n    from rwa_calc.contracts.config import CalculationConfig\n\n\n@dataclass\nclass SupportingFactorResult:\n    \"\"\"Result of supporting factor calculation.\"\"\"\n\n    factor: Decimal\n    was_applied: bool\n    description: str\n\n\nclass SupportingFactorCalculator:\n    \"\"\"\n    Calculate SME and infrastructure supporting factors for CRR.\n\n    The supporting factors reduce RWA for qualifying exposures:\n    - SME: Tiered factor (0.7619 up to threshold, 0.85 above)\n    - Infrastructure: Flat 0.75 factor\n\n    Under Basel 3.1, these factors are not available (returns 1.0).\n    \"\"\"\n\n    def calculate_sme_factor(\n        self,\n        total_exposure: Decimal,\n        config: CalculationConfig,\n    ) -&gt; Decimal:\n        \"\"\"\n        Calculate SME supporting factor based on total exposure.\n\n        Args:\n            total_exposure: Total exposure amount to the SME\n            config: Calculation configuration\n\n        Returns:\n            Effective supporting factor (0.7619 to 0.85)\n        \"\"\"\n        if not config.supporting_factors.enabled:\n            return Decimal(\"1.0\")\n\n        if total_exposure &lt;= 0:\n            return Decimal(\"1.0\")\n\n        # Get thresholds and factors from config\n        threshold_eur = config.supporting_factors.sme_exposure_threshold_eur\n        threshold_gbp = threshold_eur * config.eur_gbp_rate\n\n        factor_tier1 = config.supporting_factors.sme_factor_under_threshold\n        factor_tier2 = config.supporting_factors.sme_factor_above_threshold\n\n        # Use GBP threshold for GBP currency (default)\n        threshold = threshold_gbp\n\n        # Calculate tiered factor\n        tier1_amount = min(total_exposure, threshold)\n        tier2_amount = max(total_exposure - threshold, Decimal(\"0\"))\n\n        weighted_factor = (\n            tier1_amount * factor_tier1 +\n            tier2_amount * factor_tier2\n        )\n\n        return weighted_factor / total_exposure\n\n    def calculate_infrastructure_factor(\n        self,\n        config: CalculationConfig,\n    ) -&gt; Decimal:\n        \"\"\"\n        Get infrastructure supporting factor.\n\n        Args:\n            config: Calculation configuration\n\n        Returns:\n            Infrastructure factor (0.75 for CRR, 1.0 for Basel 3.1)\n        \"\"\"\n        if not config.supporting_factors.enabled:\n            return Decimal(\"1.0\")\n\n        return config.supporting_factors.infrastructure_factor\n\n    def get_effective_factor(\n        self,\n        is_sme: bool,\n        is_infrastructure: bool,\n        total_exposure: Decimal,\n        config: CalculationConfig,\n    ) -&gt; Decimal:\n        \"\"\"\n        Get the most beneficial supporting factor.\n\n        If both SME and infrastructure apply, returns the lower factor\n        (more beneficial to the bank).\n\n        Args:\n            is_sme: Whether exposure qualifies for SME factor\n            is_infrastructure: Whether exposure qualifies for infrastructure\n            total_exposure: Total exposure amount (for SME tier calculation)\n            config: Calculation configuration\n\n        Returns:\n            Most beneficial factor (lowest value)\n        \"\"\"\n        if not config.supporting_factors.enabled:\n            return Decimal(\"1.0\")\n\n        factors = [Decimal(\"1.0\")]\n\n        if is_sme:\n            factors.append(self.calculate_sme_factor(total_exposure, config))\n\n        if is_infrastructure:\n            factors.append(self.calculate_infrastructure_factor(config))\n\n        # Return lowest factor (most beneficial)\n        return min(factors)\n\n    def apply_factors(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Apply supporting factors to exposures LazyFrame.\n\n        The SME supporting factor threshold (EUR 2.5m) is applied at the\n        counterparty level, not per-exposure. This means all exposures to\n        the same counterparty are aggregated before determining the tiered\n        factor, and that blended factor is applied to each exposure.\n\n        Expects columns:\n        - is_sme: bool\n        - is_infrastructure: bool\n        - ead_final: float (exposure amount for tier calculation)\n        - rwa_pre_factor: float (RWA before supporting factor)\n        - counterparty_reference: str (optional, for aggregation)\n\n        Adds columns:\n        - supporting_factor: float\n        - rwa_post_factor: float (RWA after supporting factor)\n        - supporting_factor_applied: bool\n        - total_cp_ead: float (total counterparty EAD, for SME exposures)\n\n        Args:\n            exposures: Exposures with RWA calculated\n            config: Calculation configuration\n\n        Returns:\n            Exposures with supporting factors applied\n        \"\"\"\n        if not config.supporting_factors.enabled:\n            # Basel 3.1: No supporting factors\n            return exposures.with_columns([\n                pl.lit(1.0).alias(\"supporting_factor\"),\n                pl.col(\"rwa_pre_factor\").alias(\"rwa_post_factor\"),\n                pl.lit(False).alias(\"supporting_factor_applied\"),\n            ])\n\n        # Get threshold in GBP\n        threshold_gbp = float(\n            config.supporting_factors.sme_exposure_threshold_eur * config.eur_gbp_rate\n        )\n        factor_tier1 = float(config.supporting_factors.sme_factor_under_threshold)\n        factor_tier2 = float(config.supporting_factors.sme_factor_above_threshold)\n        infra_factor = float(config.supporting_factors.infrastructure_factor)\n\n        # Check for required columns\n        schema = exposures.collect_schema()\n        has_sme = \"is_sme\" in schema.names()\n        has_infra = \"is_infrastructure\" in schema.names()\n        has_counterparty = \"counterparty_reference\" in schema.names()\n        has_btl = \"is_buy_to_let\" in schema.names()\n\n        # Build SME factor expression with counterparty-level aggregation\n        if has_sme:\n            if has_counterparty:\n                # Calculate total EAD at counterparty level using window function\n                # Only aggregate SME exposures with valid counterparty references\n                total_cp_ead_expr = pl.when(\n                    pl.col(\"is_sme\") &amp; pl.col(\"counterparty_reference\").is_not_null()\n                ).then(\n                    pl.col(\"ead_final\").sum().over(\"counterparty_reference\")\n                ).otherwise(\n                    # Fall back to individual EAD if no counterparty ref or not SME\n                    pl.col(\"ead_final\")\n                )\n\n                exposures = exposures.with_columns([\n                    total_cp_ead_expr.alias(\"total_cp_ead\")\n                ])\n\n                # Use counterparty total for tier calculation\n                ead_for_tier = pl.col(\"total_cp_ead\")\n            else:\n                # No counterparty reference column - use individual EAD\n                ead_for_tier = pl.col(\"ead_final\")\n\n            # Calculate tiered factor based on aggregated exposure\n            tier1_expr = pl.when(ead_for_tier &lt;= threshold_gbp).then(\n                ead_for_tier\n            ).otherwise(pl.lit(threshold_gbp))\n\n            tier2_expr = pl.when(ead_for_tier &gt; threshold_gbp).then(\n                ead_for_tier - threshold_gbp\n            ).otherwise(pl.lit(0.0))\n\n            # BTL exposures are excluded from the SME factor but still\n            # contribute to total_cp_ead for tier calculation (CRR Art. 501)\n            is_btl = pl.col(\"is_buy_to_let\") if has_btl else pl.lit(False)\n\n            sme_factor_expr = pl.when(\n                pl.col(\"is_sme\") &amp; (ead_for_tier &gt; 0) &amp; ~is_btl\n            ).then(\n                (tier1_expr * factor_tier1 + tier2_expr * factor_tier2) / ead_for_tier\n            ).otherwise(pl.lit(1.0))\n        else:\n            sme_factor_expr = pl.lit(1.0)\n\n        # Build infrastructure factor expression inline\n        if has_infra:\n            infra_factor_expr = pl.when(pl.col(\"is_infrastructure\")).then(\n                pl.lit(infra_factor)\n            ).otherwise(pl.lit(1.0))\n        else:\n            infra_factor_expr = pl.lit(1.0)\n\n        # Compute minimum (most beneficial) factor\n        min_factor_expr = pl.min_horizontal(sme_factor_expr, infra_factor_expr)\n\n        # Single with_columns call for maximum performance\n        return exposures.with_columns([\n            min_factor_expr.alias(\"supporting_factor\"),\n            (pl.col(\"rwa_pre_factor\") * min_factor_expr).alias(\"rwa_post_factor\"),\n            (min_factor_expr &lt; 1.0).alias(\"supporting_factor_applied\"),\n        ])\n\n\ndef create_supporting_factor_calculator() -&gt; SupportingFactorCalculator:\n    \"\"\"Create a SupportingFactorCalculator instance.\"\"\"\n    return SupportingFactorCalculator()\n</code></pre>"},{"location":"user-guide/methodology/standardised-approach/#infrastructure-factor","title":"Infrastructure Factor","text":"<p>Reduces RWA for qualifying infrastructure (CRR Art. 501a):</p> <pre><code>if is_qualifying_infrastructure:\n    RWA = RWA * 0.75\n</code></pre>"},{"location":"user-guide/methodology/standardised-approach/#calculation-example","title":"Calculation Example","text":"<p>Exposure: - Corporate loan, \u00a310m drawn - Rated A+ (CQS 2) - SME counterparty (turnover \u00a330m) - Unsecured</p> <p>Calculation: <pre><code># Step 1: EAD\nEAD = \u00a310,000,000\n\n# Step 2: Risk Weight (CQS 2 Corporate)\nRW = 50%\n\n# Step 3: Base RWA\nBase_RWA = \u00a310,000,000 \u00d7 50% = \u00a35,000,000\n\n# Step 4: SME Factor (CRR only)\n# Exposure &gt; threshold, so tiered\nthreshold = \u00a32,200,000\nfactor = (2,200,000 \u00d7 0.7619 + 7,800,000 \u00d7 0.85) / 10,000,000\nfactor = (1,676,180 + 6,630,000) / 10,000,000\nfactor = 0.831\n\n# Step 5: Final RWA (CRR)\nFinal_RWA = \u00a35,000,000 \u00d7 0.831 = \u00a34,153,090\n\n# Basel 3.1 (no SME factor)\nFinal_RWA_B31 = \u00a35,000,000\n</code></pre></p>"},{"location":"user-guide/methodology/standardised-approach/#implementation-notes","title":"Implementation Notes","text":""},{"location":"user-guide/methodology/standardised-approach/#calculator-usage","title":"Calculator Usage","text":"<p>The SA calculator is implemented in <code>sa/calculator.py</code>.</p> <pre><code>from rwa_calc.engine.sa.calculator import SACalculator\nfrom rwa_calc.contracts.config import CalculationConfig\nfrom datetime import date\n\n# Create SA calculator\ncalculator = SACalculator()\n\n# Calculate RWA for a single exposure (convenience method)\nresult = calculator.calculate_single_exposure(\n    ead=Decimal(\"10000000\"),\n    exposure_class=\"CORPORATE\",\n    cqs=2,\n    is_sme=True,\n    config=CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n)\n\n# Access results\nprint(f\"Risk Weight: {result['risk_weight']}\")\nprint(f\"RWA: {result['rwa']}\")\nprint(f\"Supporting Factor: {result['supporting_factor_applied']}\")\n</code></pre>"},{"location":"user-guide/methodology/standardised-approach/#rwa_calc.engine.sa.calculator.SACalculator","title":"<code>rwa_calc.engine.sa.calculator.SACalculator</code>","text":"<p>Calculate RWA using Standardised Approach.</p> <p>Implements SACalculatorProtocol for: - CQS-based risk weight lookup (sovereign, institution, corporate) - Fixed retail risk weight (75%) - LTV-based real estate risk weights - Supporting factor application (CRR only)</p> Usage <p>calculator = SACalculator() result = calculator.calculate(crm_bundle, config)</p>"},{"location":"user-guide/methodology/standardised-approach/#rwa_calc.engine.sa.calculator.SACalculator.calculate_single_exposure","title":"<code>calculate_single_exposure(ead, exposure_class, cqs=None, ltv=None, is_sme=False, is_infrastructure=False, is_managed_as_retail=False, config=None)</code>","text":"<p>Calculate RWA for a single exposure (convenience method).</p> <p>Parameters:</p> Name Type Description Default <code>ead</code> <code>Decimal</code> <p>Exposure at default</p> required <code>exposure_class</code> <code>str</code> <p>Exposure class</p> required <code>cqs</code> <code>int | None</code> <p>Credit quality step (1-6 or None for unrated)</p> <code>None</code> <code>ltv</code> <code>Decimal | None</code> <p>Loan-to-value ratio (for real estate)</p> <code>None</code> <code>is_sme</code> <code>bool</code> <p>Whether SME supporting factor applies</p> <code>False</code> <code>is_infrastructure</code> <code>bool</code> <p>Whether infrastructure factor applies</p> <code>False</code> <code>is_managed_as_retail</code> <code>bool</code> <p>Whether SME is managed on pooled retail basis (CRR Art. 123)</p> <code>False</code> <code>config</code> <code>CalculationConfig | None</code> <p>Calculation configuration (defaults to CRR)</p> <code>None</code> <p>Returns:</p> Type Description <code>dict</code> <p>Dictionary with calculation results</p>"},{"location":"user-guide/methodology/standardised-approach/#risk-weight-lookup","title":"Risk Weight Lookup","text":"<p>Risk weights are defined in <code>data/tables/crr_risk_weights.py</code>.</p> <pre><code>from rwa_calc.data.tables.crr_risk_weights import get_combined_cqs_risk_weights\n\n# Get risk weight lookup table\nrw_table = get_combined_cqs_risk_weights(use_uk_deviation=True)\n\n# Table includes: exposure_class, cqs, risk_weight\n# Example: CORPORATE, CQS 2 -&gt; 50%\n</code></pre> Actual Risk Weight Application (calculator.py) <pre><code>    def _apply_risk_weights(\n        self,\n        exposures: pl.LazyFrame,\n        config: CalculationConfig,\n    ) -&gt; pl.LazyFrame:\n        \"\"\"\n        Look up and apply risk weights based on exposure class.\n\n        Handles:\n        - CQS-based lookups (sovereign, institution, corporate)\n        - Fixed retail (75%)\n        - LTV-based real estate (split treatment)\n\n        Args:\n            exposures: SA exposures with classification\n            config: Calculation configuration\n\n        Returns:\n            Exposures with risk_weight column added\n        \"\"\"\n        # Get CQS-based risk weight table (includes UK deviation for institutions)\n        use_uk_deviation = config.base_currency == \"GBP\"\n        rw_table = get_combined_cqs_risk_weights(use_uk_deviation).lazy()\n\n        # Ensure required columns exist\n        schema = exposures.collect_schema()\n        if \"ltv\" not in schema.names():\n            exposures = exposures.with_columns([\n                pl.lit(None).cast(pl.Float64).alias(\"ltv\"),\n            ])\n        if \"has_income_cover\" not in schema.names():\n            exposures = exposures.with_columns([\n                pl.lit(False).alias(\"has_income_cover\"),\n            ])\n        if \"book_code\" not in schema.names():\n            exposures = exposures.with_columns([\n                pl.lit(\"\").alias(\"book_code\"),\n            ])\n        if \"cp_is_managed_as_retail\" not in schema.names():\n            exposures = exposures.with_columns([\n                pl.lit(False).alias(\"cp_is_managed_as_retail\"),\n            ])\n\n        # Prepare exposures for join\n        # Normalize exposure class names for matching\n        # Use sentinel value -1 for null CQS to allow join (null != null in joins)\n        exposures = exposures.with_columns([\n            # Map detailed classes to lookup classes\n            pl.when(pl.col(\"exposure_class\").str.contains(\"(?i)central_govt\"))\n            .then(pl.lit(\"CENTRAL_GOVT_CENTRAL_BANK\"))\n            .when(pl.col(\"exposure_class\").str.contains(\"(?i)institution\"))\n            .then(pl.lit(\"INSTITUTION\"))\n            .when(pl.col(\"exposure_class\").str.contains(\"(?i)corporate\"))\n            .then(pl.lit(\"CORPORATE\"))\n            .otherwise(pl.col(\"exposure_class\").str.to_uppercase())\n            .alias(\"_lookup_class\"),\n\n            # Use -1 as sentinel for null CQS (for join matching)\n            pl.col(\"cqs\").fill_null(-1).cast(pl.Int8).alias(\"_lookup_cqs\"),\n        ])\n\n        # Prepare risk weight table with same sentinel for null CQS\n        rw_table = rw_table.with_columns([\n            pl.col(\"cqs\").fill_null(-1).cast(pl.Int8).alias(\"cqs\"),\n        ])\n\n        # Join risk weight table\n        exposures = exposures.join(\n            rw_table.select([\"exposure_class\", \"cqs\", \"risk_weight\"]),\n            left_on=[\"_lookup_class\", \"_lookup_cqs\"],\n            right_on=[\"exposure_class\", \"cqs\"],\n            how=\"left\",\n            suffix=\"_rw\",\n        )\n\n        # Apply class-specific risk weights\n        retail_rw = float(RETAIL_RISK_WEIGHT)\n        resi_threshold = float(RESIDENTIAL_MORTGAGE_PARAMS[\"ltv_threshold\"])\n        resi_rw_low = float(RESIDENTIAL_MORTGAGE_PARAMS[\"rw_low_ltv\"])\n        resi_rw_high = float(RESIDENTIAL_MORTGAGE_PARAMS[\"rw_high_ltv\"])\n        cre_threshold = float(COMMERCIAL_RE_PARAMS[\"ltv_threshold\"])\n        cre_rw_low = float(COMMERCIAL_RE_PARAMS[\"rw_low_ltv\"])\n        cre_rw_standard = float(COMMERCIAL_RE_PARAMS[\"rw_standard\"])\n\n        exposures = exposures.with_columns([\n            # Order matters: check specific classes before generic ones\n            # 1. Residential mortgage: LTV-based (must come before retail)\n            pl.when(pl.col(\"exposure_class\").str.contains(\"(?i)mortgage|residential\"))\n            .then(\n                pl.when(pl.col(\"ltv\").fill_null(0.0) &lt;= resi_threshold)\n                .then(pl.lit(resi_rw_low))\n                # High LTV: weighted average\n                .otherwise(\n                    # portion_low = threshold / ltv\n                    # portion_high = (ltv - threshold) / ltv\n                    # avg_rw = rw_low * portion_low + rw_high * portion_high\n                    (resi_rw_low * resi_threshold / pl.col(\"ltv\").fill_null(1.0) +\n                     resi_rw_high * (pl.col(\"ltv\").fill_null(1.0) - resi_threshold) /\n                     pl.col(\"ltv\").fill_null(1.0))\n                )\n            )\n\n            # 2. Commercial RE: LTV + income cover based\n            .when(pl.col(\"exposure_class\").str.contains(\"(?i)commercial.*re|cre\"))\n            .then(\n                pl.when(\n                    (pl.col(\"ltv\").fill_null(1.0) &lt;= cre_threshold) &amp;\n                    pl.col(\"has_income_cover\").fill_null(False)\n                )\n                .then(pl.lit(cre_rw_low))\n                .otherwise(pl.lit(cre_rw_standard))\n            )\n\n            # 3. SME managed as retail: 75% RW (CRR Art. 123)\n            .when(\n                (pl.col(\"exposure_class\").str.contains(\"(?i)sme\")) &amp;\n                (pl.col(\"cp_is_managed_as_retail\") == True)  # noqa: E712\n            )\n            .then(pl.lit(retail_rw))\n\n            # 4. Corporate SME: 100% RW (then reduced by SME supporting factor)\n            .when(pl.col(\"exposure_class\").str.contains(\"(?i)corporate.*sme|sme.*corporate\"))\n            .then(pl.lit(1.0))\n\n            # 5. Retail (non-mortgage): 75% flat\n            .when(pl.col(\"exposure_class\").str.contains(\"(?i)retail\"))\n            .then(pl.lit(retail_rw))\n\n            # 5. Default: use joined CQS-based risk weight, or 100%\n            .otherwise(pl.col(\"risk_weight\").fill_null(1.0))\n            .alias(\"risk_weight\"),\n        ])\n\n        # Clean up temporary columns\n        exposures = exposures.drop([\n            col for col in [\"_lookup_class\", \"_lookup_cqs\", \"risk_weight_rw\"]\n            if col in exposures.collect_schema().names()\n        ])\n\n        return exposures\n</code></pre>"},{"location":"user-guide/methodology/standardised-approach/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article BCBS CRE Risk weight assignment Art. 113-134 CRE20-22 CCFs Art. 111 CRE20.10 CRM Art. 192-241 CRE22 SME factor Art. 501 N/A Real estate Art. 124-125 CRE20.70-90"},{"location":"user-guide/methodology/standardised-approach/#next-steps","title":"Next Steps","text":"<ul> <li>IRB Approach - Internal ratings-based methodology</li> <li>Credit Risk Mitigation - CRM techniques in detail</li> <li>Supporting Factors - SME and infrastructure factors</li> </ul>"},{"location":"user-guide/methodology/supporting-factors/","title":"Supporting Factors","text":"<p>Supporting Factors are capital relief mechanisms under CRR that reduce RWA for qualifying exposures. These factors are removed under Basel 3.1.</p> <p>Basel 3.1 Impact</p> <p>Both the SME Supporting Factor and Infrastructure Factor are withdrawn from 1 January 2027 under Basel 3.1 (PRA PS9/24).</p>"},{"location":"user-guide/methodology/supporting-factors/#sme-supporting-factor","title":"SME Supporting Factor","text":"<p>The SME Supporting Factor (Article 501 CRR) provides capital relief for exposures to Small and Medium Enterprises.</p>"},{"location":"user-guide/methodology/supporting-factors/#eligibility-criteria","title":"Eligibility Criteria","text":"Criterion Requirement Counterparty SME (turnover \u2264 EUR 50m / GBP 44m) Exposure class Corporate, Retail, or Secured by Real Estate Approach SA or IRB Exposure type Not in default Not buy-to-let <code>is_buy_to_let = False</code> (BTL exposures excluded per CRR Art. 501)"},{"location":"user-guide/methodology/supporting-factors/#calculation","title":"Calculation","text":"<p>The factor is tiered based on total exposure to the counterparty:</p> <pre><code>threshold = EUR 2,500,000  # GBP 2,200,000\n\nif total_exposure &lt;= threshold:\n    factor = 0.7619  # 23.81% reduction\nelse:\n    factor = (threshold \u00d7 0.7619 + (total_exposure - threshold) \u00d7 0.85) / total_exposure\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#factor-values","title":"Factor Values","text":"Total Exposure Factor RWA Reduction \u2264 GBP 2.2m 0.7619 23.81% GBP 3m 0.789 21.1% GBP 5m 0.811 18.9% GBP 10m 0.831 16.9% GBP 25m 0.840 16.0% GBP 50m 0.843 15.7%"},{"location":"user-guide/methodology/supporting-factors/#graphical-representation","title":"Graphical Representation","text":"<pre><code>Factor\n1.00 |\n     |\n0.90 |\n     |                    ....----------------\n0.85 |                ....\n     |            ....\n0.80 |        ....\n     |    ....\n0.76 |....\n     |___________________________________\n     0      2.2m   5m    10m   25m   50m  Exposure\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#calculation-example","title":"Calculation Example","text":"<p>Exposure: - SME corporate with turnover \u00a330m - Total exposure: \u00a38m - Base RWA: \u00a36.4m (80% average RW)</p> <p>SME Factor Calculation: <pre><code>threshold = 2,200,000\n\n# Tiered calculation\nportion_1 = 2,200,000 \u00d7 0.7619 = 1,676,180\nportion_2 = (8,000,000 - 2,200,000) \u00d7 0.85 = 4,930,000\n\ntotal_weighted = 1,676,180 + 4,930,000 = 6,606,180\nfactor = 6,606,180 / 8,000,000 = 0.826\n\n# Apply to RWA\nAdjusted_RWA = 6,400,000 \u00d7 0.826 = \u00a35,286,400\n\n# Saving: \u00a31,113,600 (17.4%)\n</code></pre></p>"},{"location":"user-guide/methodology/supporting-factors/#sme-definition","title":"SME Definition","text":"<p>An entity qualifies as an SME if: - Annual turnover \u2264 EUR 50m (GBP 44m), OR - Total assets \u2264 EUR 43m (GBP 37.84m)</p> <p>Turnover Source: 1. Audited financial statements (preferred) 2. Management accounts 3. Tax returns 4. Estimated based on relationship data</p>"},{"location":"user-guide/methodology/supporting-factors/#infrastructure-supporting-factor","title":"Infrastructure Supporting Factor","text":"<p>The Infrastructure Supporting Factor (Article 501a CRR) provides capital relief for qualifying infrastructure project finance.</p>"},{"location":"user-guide/methodology/supporting-factors/#eligibility-criteria_1","title":"Eligibility Criteria","text":"Criterion Requirement Exposure type Project finance Entity type Project entity or High Quality Project Entity Revenue Predictable, predominantly EUR/GBP (or hedged) Contracts Robust contractual framework Cash flows Reliable debt service"},{"location":"user-guide/methodology/supporting-factors/#factor-value","title":"Factor Value","text":"<p>A flat 0.75 factor (25% RWA reduction) applies to the entire exposure:</p> <pre><code>if is_qualifying_infrastructure:\n    factor = 0.75\n    Adjusted_RWA = RWA \u00d7 0.75\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#high-quality-project-entity-hqpe","title":"High Quality Project Entity (HQPE)","text":"<p>Additional criteria for maximum benefit:</p> Criterion HQPE Requirement Revenues Highly predictable Contractual framework Comprehensive protection Equity cushion Adequate for risk Operating risk Limited or mitigated Refinancing risk Limited or covered"},{"location":"user-guide/methodology/supporting-factors/#qualifying-infrastructure","title":"Qualifying Infrastructure","text":"Category Examples Transport Roads, railways, ports, airports Energy Power generation, transmission, distribution Water Treatment, distribution, drainage Social Hospitals, schools, housing Communications Telecoms, broadband"},{"location":"user-guide/methodology/supporting-factors/#non-qualifying-examples","title":"Non-Qualifying Examples","text":"Exclusion Reason Speculative development Cash flow uncertainty Mining/extraction Commodity price risk Merchant power Revenue volatility Early-stage tech Unproven technology"},{"location":"user-guide/methodology/supporting-factors/#calculation-example_1","title":"Calculation Example","text":"<p>Exposure: - Infrastructure project finance - Toll road concession - Base RWA: \u00a315m (slotting category \"Satisfactory\", 115% RW) - Qualifies for infrastructure factor</p> <p>Calculation: <pre><code>factor = 0.75\n\nAdjusted_RWA = 15,000,000 \u00d7 0.75 = \u00a311,250,000\n\n# Saving: \u00a33,750,000 (25%)\n</code></pre></p>"},{"location":"user-guide/methodology/supporting-factors/#interaction-of-factors","title":"Interaction of Factors","text":""},{"location":"user-guide/methodology/supporting-factors/#sme-infrastructure","title":"SME + Infrastructure","text":"<p>Both factors can potentially apply:</p> <pre><code># Corporate SME with infrastructure characteristics\nif is_sme and is_qualifying_infrastructure:\n    # Apply SME factor to corporate exposure\n    # Infrastructure factor applies to project finance only\n    # Generally mutually exclusive by exposure type\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#with-crm","title":"With CRM","text":"<p>Supporting factors apply after CRM:</p> <pre><code># Order of operations\n1. Apply CRM (reduce exposure/RW)\n2. Calculate base RWA\n3. Apply supporting factors\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#with-irb","title":"With IRB","text":"<p>Factors apply to IRB RWA before the 1.06 scaling:</p> <pre><code># IRB with SME factor\nRWA_base = K \u00d7 12.5 \u00d7 EAD \u00d7 MA\nRWA_with_sme = RWA_base \u00d7 SME_factor\nRWA_final = RWA_with_sme \u00d7 1.06  # CRR scaling applied last\n</code></pre> <p>IRB SME Adjustment</p> <p>For IRB, the SME size adjustment to correlation is separate from the SME Supporting Factor. Both can apply to the same exposure.</p>"},{"location":"user-guide/methodology/supporting-factors/#implementation","title":"Implementation","text":""},{"location":"user-guide/methodology/supporting-factors/#enabling-supporting-factors","title":"Enabling Supporting Factors","text":"<pre><code>from rwa_calc.contracts.config import CalculationConfig\n\n# Enable both factors (CRR default)\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=True,\n    apply_infrastructure_factor=True\n)\n\n# Disable for comparison\nconfig_no_factors = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=False,\n    apply_infrastructure_factor=False\n)\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#basel-31-configuration","title":"Basel 3.1 Configuration","text":"<pre><code># Basel 3.1 - factors not available\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2027, 1, 1)\n)\n\n# apply_sme_supporting_factor is ignored\n# apply_infrastructure_factor is ignored\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#calculating-factors","title":"Calculating Factors","text":"<pre><code>from rwa_calc.engine.sa.supporting_factors import (\n    calculate_sme_factor,\n    is_qualifying_infrastructure\n)\n\n# SME factor\nsme_factor = calculate_sme_factor(\n    total_exposure=8_000_000,\n    counterparty_turnover=30_000_000,\n    eur_gbp_rate=0.8732\n)\n\n# Infrastructure check\ninfra_eligible = is_qualifying_infrastructure(\n    exposure_type=\"PROJECT_FINANCE\",\n    revenue_stability=\"HIGH\",\n    contractual_framework=\"COMPREHENSIVE\"\n)\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#eurgbp-conversion","title":"EUR/GBP Conversion","text":"<p>Thresholds are defined in EUR and converted to GBP:</p> <pre><code># Default rate (matches CalculationConfig.eur_gbp_rate)\nEUR_GBP_RATE = 0.8732\n\n# Thresholds\nSME_TURNOVER_EUR = 50_000_000\nSME_TURNOVER_GBP = 50_000_000 \u00d7 0.8732 \u2248 43_660_000\n\nSME_EXPOSURE_EUR = 2_500_000\nSME_EXPOSURE_GBP = 2_500_000 \u00d7 0.8732 \u2248 2_183_000\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#configuring-fx-rate","title":"Configuring FX Rate","text":"<pre><code>from decimal import Decimal\nfrom rwa_calc.contracts.config import CalculationConfig\n\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    eur_gbp_rate=Decimal(\"0.85\")  # Custom rate\n)\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#impact-analysis","title":"Impact Analysis","text":""},{"location":"user-guide/methodology/supporting-factors/#portfolio-impact","title":"Portfolio Impact","text":"Portfolio Type SME Factor Impact Infra Factor Impact SME-heavy 15-24% RWA reduction N/A Infrastructure N/A 25% RWA reduction Mixed Weighted average Weighted average"},{"location":"user-guide/methodology/supporting-factors/#basel-31-transition","title":"Basel 3.1 Transition","text":"<p>For portfolios heavily reliant on supporting factors:</p> <pre><code># Estimate impact\nCRR_RWA = base_rwa \u00d7 sme_factor  # e.g., \u00a38m \u00d7 0.83 = \u00a36.64m\nB31_RWA = base_rwa  # \u00a38m (no factor)\n\nImpact = B31_RWA - CRR_RWA  # \u00a31.36m increase (20.5%)\n</code></pre>"},{"location":"user-guide/methodology/supporting-factors/#regulatory-references","title":"Regulatory References","text":"Topic CRR Article SME Supporting Factor Art. 501 (CRR2) SME definition Art. 501(2) Tiered calculation Art. 501(1) Infrastructure Factor Art. 501a HQPE definition Art. 501a(1)"},{"location":"user-guide/methodology/supporting-factors/#next-steps","title":"Next Steps","text":"<ul> <li>Framework Comparison - CRR vs Basel 3.1 impact</li> <li>Configuration Guide - Enabling/disabling factors</li> <li>IRB Approach - SME correlation adjustment</li> </ul>"},{"location":"user-guide/regulatory/","title":"Regulatory Frameworks","text":"<p>This section provides detailed information on the regulatory frameworks supported by the UK Credit Risk RWA Calculator.</p>"},{"location":"user-guide/regulatory/#overview","title":"Overview","text":"<p>UK credit risk capital requirements are based on international Basel standards, as implemented by the Prudential Regulation Authority (PRA). The calculator supports two frameworks:</p> Framework Status Effective Period Primary Regulation CRR (Basel 3.0) Active Until 31 Dec 2026 UK CRR, PRA Rulebook Basel 3.1 Planned From 1 Jan 2027 PRA PS9/24"},{"location":"user-guide/regulatory/#regulatory-hierarchy","title":"Regulatory Hierarchy","text":"<pre><code>graph TD\n    A[Basel Committee] --&gt; B[Basel 3.0 Standards]\n    A --&gt; C[Basel 3.1 Standards]\n    B --&gt; D[EU CRR/CRD IV]\n    C --&gt; E[PRA PS9/24]\n    D --&gt; F[UK CRR Onshored]\n    F --&gt; G[Current UK Rules]\n    E --&gt; H[Future UK Rules]\n\n    style G fill:#90EE90\n    style H fill:#FFE4B5</code></pre>"},{"location":"user-guide/regulatory/#key-regulatory-documents","title":"Key Regulatory Documents","text":""},{"location":"user-guide/regulatory/#current-framework-crr","title":"Current Framework (CRR)","text":"Document Description Link UK CRR EU 575/2013 as onshored legislation.gov.uk PRA Rulebook - CRR Firms PRA rules for CRR firms prarulebook.co.uk"},{"location":"user-guide/regulatory/#future-framework-basel-31","title":"Future Framework (Basel 3.1)","text":"Document Description Link PRA PS9/24 Basel 3.1 implementation near-final rules bankofengland.co.uk PRA CP16/22 Basel 3.1 consultation paper bankofengland.co.uk BCBS CRE Standards Basel Committee credit risk standards bis.org"},{"location":"user-guide/regulatory/#framework-selection","title":"Framework Selection","text":"<p>The calculator automatically applies the correct rules based on your configuration:</p> <pre><code>from datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\n\n# For current CRR rules\nconfig = CalculationConfig.crr(reporting_date=date(2026, 12, 31))\n\n# For Basel 3.1 rules\nconfig = CalculationConfig.basel_3_1(reporting_date=date(2027, 1, 1))\n</code></pre>"},{"location":"user-guide/regulatory/#key-differences-summary","title":"Key Differences Summary","text":"Feature CRR Basel 3.1 1.06 Scaling Factor Applied to all IRB Removed Output Floor None 72.5% of SA equivalent SME Supporting Factor 0.7619/0.85 tiered Removed Infrastructure Factor 0.75 flat Removed PD Floors 0.03% uniform 0.03%-0.10% differentiated A-IRB LGD Floors None 0%-25% by collateral"},{"location":"user-guide/regulatory/#detailed-framework-documentation","title":"Detailed Framework Documentation","text":"<ul> <li>CRR (Basel 3.0) - Complete CRR documentation</li> <li>Basel 3.1 - Complete Basel 3.1 documentation</li> <li>Framework Comparison - Detailed side-by-side comparison</li> </ul>"},{"location":"user-guide/regulatory/#uk-specific-deviations","title":"UK-Specific Deviations","text":"<p>The UK has implemented certain deviations from Basel standards:</p>"},{"location":"user-guide/regulatory/#institution-risk-weights","title":"Institution Risk Weights","text":"<p>Under CRR, UK institutions apply a 30% risk weight for CQS2 institutions (vs. 50% standard Basel):</p> CQS Standard Basel UK CRR CQS1 20% 20% CQS2 50% 30% CQS3 50% 50%"},{"location":"user-guide/regulatory/#threshold-currency-conversion","title":"Threshold Currency Conversion","text":"<p>EUR-denominated thresholds in regulations are converted to GBP:</p> Threshold EUR Amount GBP Amount (@ 0.88) SME turnover EUR 50m GBP 44m SME exposure EUR 2.5m GBP 2.2m Retail threshold EUR 1m GBP 880k <p>The calculator automatically handles these conversions using the configured FX rate.</p>"},{"location":"user-guide/regulatory/#compliance-considerations","title":"Compliance Considerations","text":""},{"location":"user-guide/regulatory/#audit-trail","title":"Audit Trail","text":"<p>The calculator maintains full audit trails for regulatory compliance: - All calculation inputs are logged - Intermediate results are available - Errors and warnings are accumulated (not thrown) - Results can be exported for review</p>"},{"location":"user-guide/regulatory/#validation","title":"Validation","text":"<p>Input data is validated against regulatory schemas: - Exposure class constraints - Rating scale mappings - Threshold compliance - Required field validation</p>"},{"location":"user-guide/regulatory/#documentation","title":"Documentation","text":"<p>All calculations reference specific regulatory articles: - CRR Article numbers for current rules - CRE chapter references for Basel 3.1 - PRA rulebook cross-references</p>"},{"location":"user-guide/regulatory/#next-steps","title":"Next Steps","text":"<ul> <li>CRR Deep Dive - Current framework details</li> <li>Basel 3.1 Deep Dive - Future framework details</li> <li>Comparison - Framework differences</li> </ul>"},{"location":"user-guide/regulatory/basel31/","title":"Basel 3.1","text":"<p>Basel 3.1 represents a significant overhaul of credit risk capital requirements, implemented in the UK through PRA PS9/24. It becomes effective on 1 January 2027.</p>"},{"location":"user-guide/regulatory/basel31/#legal-basis","title":"Legal Basis","text":"Document Reference Primary Policy PRA PS9/24 (Near-Final Rules) Consultation PRA CP16/22 Basel Standards BCBS CRE20-CRE99"},{"location":"user-guide/regulatory/basel31/#key-changes-from-crr","title":"Key Changes from CRR","text":""},{"location":"user-guide/regulatory/basel31/#1-removal-of-106-scaling-factor","title":"1. Removal of 1.06 Scaling Factor","text":"<p>The 1.06 multiplier applied to all IRB RWA is removed:</p> CRRBasel 3.1 <pre><code>RWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA \u00d7 1.06\n</code></pre> <pre><code>RWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA\n</code></pre> <p>Impact</p> <p>This reduces IRB RWA by approximately 5.7% before other Basel 3.1 changes.</p>"},{"location":"user-guide/regulatory/basel31/#2-output-floor","title":"2. Output Floor","text":"<p>An output floor ensures IRB RWA cannot fall below 72.5% of the equivalent SA RWA:</p> <pre><code>RWA_final = max(RWA_IRB, 0.725 \u00d7 RWA_SA_equivalent)\n</code></pre> <p>Transitional Phase-In:</p> Year Floor Percentage 2027 50% 2028 55% 2029 60% 2030 65% 2031 70% 2032+ 72.5% <p>Impact</p> <p>For exposures with significant IRB benefit (RWA_IRB &lt; 72.5% \u00d7 RWA_SA), this floor will increase capital requirements.</p>"},{"location":"user-guide/regulatory/basel31/#3-removal-of-supporting-factors","title":"3. Removal of Supporting Factors","text":"<p>All CRR supporting factors are withdrawn:</p> Factor CRR Basel 3.1 SME Supporting Factor 0.7619/0.85 Removed Infrastructure Factor 0.75 Removed"},{"location":"user-guide/regulatory/basel31/#4-differentiated-pd-floors","title":"4. Differentiated PD Floors","text":"<p>PD floors vary by exposure class instead of a uniform 0.03%:</p> Exposure Class CRR PD Floor Basel 3.1 PD Floor Corporate 0.03% 0.05% Large Corporate 0.03% 0.05% Bank 0.03% 0.05% Retail Mortgage 0.03% 0.05% Retail QRRE (transactor) 0.03% 0.03% Retail QRRE (revolver) 0.03% 0.10% Retail Other 0.03% 0.05%"},{"location":"user-guide/regulatory/basel31/#5-a-irb-lgd-floors","title":"5. A-IRB LGD Floors","text":"<p>New minimum LGD values for Advanced IRB:</p> Collateral Type LGD Floor Unsecured - Senior 25% Unsecured - Subordinated 50% Secured - Financial Collateral 0% Secured - Receivables 15% Secured - Commercial Real Estate 15% Secured - Residential Real Estate 10% Secured - Other Physical 20%"},{"location":"user-guide/regulatory/basel31/#6-revised-sa-risk-weights","title":"6. Revised SA Risk Weights","text":"<p>Standardised Approach risk weights are recalibrated:</p>"},{"location":"user-guide/regulatory/basel31/#corporate-exposures","title":"Corporate Exposures","text":"CQS CRR Basel 3.1 CQS 1 (AAA to AA-) 20% 20% CQS 2 (A+ to A-) 50% 50% CQS 3 (BBB+ to BBB-) 75% 75% CQS 4 (BB+ to BB-) 100% 100% CQS 5 (B+ to B-) 150% 100% CQS 6 (CCC+/Below) 150% 150% Unrated 100% 100%"},{"location":"user-guide/regulatory/basel31/#real-estate-exposures","title":"Real Estate Exposures","text":"<p>New LTV-based risk weights for real estate:</p> <p>Residential Real Estate (Regulatory RRE):</p> LTV Whole Loan RW Income-Producing RW \u2264 50% 20% 30% 50-60% 25% 35% 60-70% 30% 45% 70-80% 40% 60% 80-90% 50% 75% 90-100% 70% 105% &gt; 100% Counterparty RW Counterparty RW <p>Commercial Real Estate:</p> LTV Income-Producing \u2264 60% 70% &gt; 60% 110%"},{"location":"user-guide/regulatory/basel31/#7-input-floors-for-irb","title":"7. Input Floors for IRB","text":"<p>Beyond PD and LGD floors, Basel 3.1 introduces:</p> <p>EAD Floors: - CCF cannot be lower than SA values for comparable exposures - Minimum 10% CCF for unconditionally cancellable facilities (vs 0% CRR)</p> <p>Maturity: - Effective maturity floor: 1 year - Cap remains: 5 years</p>"},{"location":"user-guide/regulatory/basel31/#8-due-diligence-requirements","title":"8. Due Diligence Requirements","text":"<p>Enhanced requirements for unrated exposures: - Institutions must perform internal assessment - Risk weight based on assessment quality - Documentation requirements</p>"},{"location":"user-guide/regulatory/basel31/#risk-weight-tables-basel-31","title":"Risk Weight Tables (Basel 3.1)","text":""},{"location":"user-guide/regulatory/basel31/#sovereign-exposures","title":"Sovereign Exposures","text":"CQS Risk Weight CQS 1 0% CQS 2 20% CQS 3 50% CQS 4 100% CQS 5 100% CQS 6 150% Unrated (OECD) 0% Unrated (non-OECD) 100%"},{"location":"user-guide/regulatory/basel31/#institution-exposures","title":"Institution Exposures","text":"<p>External Credit Risk Assessment Approach (ECRA):</p> CQS Risk Weight CQS 1 20% CQS 2 30% CQS 3 50% CQS 4 100% CQS 5 100% CQS 6 150% <p>Standardised Credit Risk Assessment Approach (SCRA):</p> Grade Risk Weight Criteria A 40% CET1 &gt; 14%, Leverage &gt; 5% B 75% CET1 &gt; 5.5%, Leverage &gt; 3% C 150% Below minimum requirements"},{"location":"user-guide/regulatory/basel31/#subordinated-debt","title":"Subordinated Debt","text":"Instrument Type Risk Weight Subordinated debt instruments 150% Equity-like instruments 250%"},{"location":"user-guide/regulatory/basel31/#irb-restrictions","title":"IRB Restrictions","text":"<p>Basel 3.1 restricts IRB usage for certain exposures:</p> Exposure Type Allowed Approaches Large Corporate (Revenue &gt; \u00a3500m) SA or F-IRB only Bank/Institution SA or F-IRB only Equity SA only Specialised Lending (no PD) SA or Slotting only"},{"location":"user-guide/regulatory/basel31/#crm-changes","title":"CRM Changes","text":""},{"location":"user-guide/regulatory/basel31/#haircuts","title":"Haircuts","text":"<p>Supervisory haircuts are recalibrated:</p> Collateral Type CRR Haircut Basel 3.1 Haircut Main index equities 15% 15% Other listed equities 25% 25% Gold 15% 15% Cash 0% 0%"},{"location":"user-guide/regulatory/basel31/#guarantee-recognition","title":"Guarantee Recognition","text":"<ul> <li>Unfunded credit protection maintained</li> <li>G-10 sovereign guarantees: 0% RW</li> <li>Covered bond issuer guarantees: Enhanced treatment</li> </ul>"},{"location":"user-guide/regulatory/basel31/#specialised-lending","title":"Specialised Lending","text":"<p>Slotting remains available with updated risk weights:</p> Category Strong Good Satisfactory Weak Default Project Finance (Pre-Operational) 80% 100% 120% 350% 0% (EL) Project Finance (Operational) 70% 90% 115% 250% 0% (EL) Object Finance 70% 90% 115% 250% 0% (EL) Commodities Finance 70% 90% 115% 250% 0% (EL) IPRE 70% 90% 115% 250% 0% (EL) HVCRE 95% 120% 140% 250% 0% (EL)"},{"location":"user-guide/regulatory/basel31/#configuration-example","title":"Configuration Example","text":"<pre><code>from datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\n\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2027, 1, 1),\n\n    # Output floor (72.5% fully phased in, or transitional)\n    output_floor_percentage=0.725,\n\n    # Transitional year (for phase-in calculation)\n    transitional_floor_year=2027,  # 50% in 2027\n)\n</code></pre>"},{"location":"user-guide/regulatory/basel31/#implementation-timeline","title":"Implementation Timeline","text":"<pre><code>gantt\n    title Basel 3.1 Implementation Timeline\n    dateFormat  YYYY-MM-DD\n    section Milestones\n    PRA PS9/24 Published     :done,    2024-09-01, 2024-09-30\n    Industry Preparation     :active,  2025-01-01, 2026-12-31\n    Basel 3.1 Go-Live        :         2027-01-01, 2027-01-01\n    section Output Floor\n    50% Floor                :         2027-01-01, 2027-12-31\n    55% Floor                :         2028-01-01, 2028-12-31\n    60% Floor                :         2029-01-01, 2029-12-31\n    65% Floor                :         2030-01-01, 2030-12-31\n    70% Floor                :         2031-01-01, 2031-12-31\n    72.5% Floor (Final)      :         2032-01-01, 2032-12-31</code></pre>"},{"location":"user-guide/regulatory/basel31/#regulatory-references","title":"Regulatory References","text":"Topic Reference Output floor CRE99 SA risk weights CRE20-22 IRB approach CRE30-36 Real estate CRE20.70-90 PD/LGD floors CRE32 Specialised lending CRE33"},{"location":"user-guide/regulatory/basel31/#next-steps","title":"Next Steps","text":"<ul> <li>CRR - Current framework</li> <li>Framework Comparison - Side-by-side comparison</li> <li>Calculation Methodology - How calculations work</li> </ul>"},{"location":"user-guide/regulatory/comparison/","title":"Framework Comparison","text":"<p>This page provides a comprehensive comparison between CRR (Basel 3.0) and Basel 3.1 frameworks.</p>"},{"location":"user-guide/regulatory/comparison/#overview","title":"Overview","text":"Aspect CRR (Basel 3.0) Basel 3.1 Effective Until 31 Dec 2026 From 1 Jan 2027 Philosophy Risk sensitivity Comparability + floors IRB Benefit Unlimited Floored at 72.5% of SA Supporting Factors SME + Infrastructure None Scaling 1.06 multiplier None"},{"location":"user-guide/regulatory/comparison/#irb-treatment","title":"IRB Treatment","text":""},{"location":"user-guide/regulatory/comparison/#scaling-factor","title":"Scaling Factor","text":"CRRBasel 3.1 <pre><code># 6% uplift on all IRB RWA\nRWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA \u00d7 1.06\n</code></pre> <pre><code># No scaling factor\nRWA = K \u00d7 12.5 \u00d7 EAD \u00d7 MA\n</code></pre> <p>Impact: ~5.7% reduction in IRB RWA (before output floor)</p>"},{"location":"user-guide/regulatory/comparison/#output-floor","title":"Output Floor","text":"CRRBasel 3.1 <p>No output floor. IRB RWA can be significantly below SA.</p> <pre><code>Example:\n- SA RWA: \u00a3100m\n- IRB RWA: \u00a330m\n- Final RWA: \u00a330m (70% capital saving)\n</code></pre> <p>72.5% floor limits IRB benefit.</p> <pre><code>Example:\n- SA RWA: \u00a3100m\n- IRB RWA: \u00a330m\n- Floor: \u00a3100m \u00d7 72.5% = \u00a372.5m\n- Final RWA: \u00a372.5m (27.5% capital saving only)\n</code></pre>"},{"location":"user-guide/regulatory/comparison/#pd-floors","title":"PD Floors","text":"Exposure Class CRR Basel 3.1 Corporate 0.03% 0.05% Large Corporate 0.03% 0.05% Institution/Bank 0.03% 0.05% Retail Mortgage 0.03% 0.05% Retail QRRE (Transactor) 0.03% 0.03% Retail QRRE (Revolver) 0.03% 0.10% Retail Other 0.03% 0.05%"},{"location":"user-guide/regulatory/comparison/#lgd-floors-a-irb-only","title":"LGD Floors (A-IRB Only)","text":"Collateral Type CRR Basel 3.1 Unsecured Senior None 25% Unsecured Subordinated None 50% Financial Collateral None 0% Receivables None 15% Commercial RE None 15% Residential RE None 10% Other Physical None 20%"},{"location":"user-guide/regulatory/comparison/#irb-approach-restrictions","title":"IRB Approach Restrictions","text":"Exposure Type CRR Basel 3.1 Large Corporate (&gt;\u00a3500m) F-IRB or A-IRB F-IRB only Bank/Institution F-IRB or A-IRB F-IRB only Equity IRB SA only"},{"location":"user-guide/regulatory/comparison/#supporting-factors","title":"Supporting Factors","text":""},{"location":"user-guide/regulatory/comparison/#sme-supporting-factor","title":"SME Supporting Factor","text":"CRR (Article 501)Basel 3.1 <p>Eligibility: - Turnover \u2264 EUR 50m - Corporate, Retail, or Real Estate secured</p> <p>Calculation: <pre><code># Tiered approach\nthreshold = EUR 2.5m  # GBP 2.2m\n\nif exposure &lt;= threshold:\n    factor = 0.7619  # 23.81% reduction\nelse:\n    factor = (threshold \u00d7 0.7619 + (exposure - threshold) \u00d7 0.85) / exposure\n</code></pre></p> Exposure Factor RWA Reduction \u00a31m 0.7619 23.81% \u00a32.2m 0.7619 23.81% \u00a35m 0.811 18.9% \u00a310m 0.831 16.9% <p>SME Supporting Factor: REMOVED</p> <p>No capital relief for SME exposures.</p>"},{"location":"user-guide/regulatory/comparison/#infrastructure-supporting-factor","title":"Infrastructure Supporting Factor","text":"CRRBasel 3.1 <p>Eligibility: - Qualifying infrastructure project finance - Revenues in EUR/GBP or hedged</p> <p>Calculation: <pre><code>factor = 0.75  # 25% reduction\nRWA_adjusted = RWA \u00d7 0.75\n</code></pre></p> <p>Infrastructure Factor: REMOVED</p> <p>No capital relief for infrastructure projects.</p>"},{"location":"user-guide/regulatory/comparison/#sa-risk-weights","title":"SA Risk Weights","text":""},{"location":"user-guide/regulatory/comparison/#corporate","title":"Corporate","text":"CQS CRR Basel 3.1 Change CQS1 (AAA-AA-) 20% 20% - CQS2 (A+-A-) 50% 50% - CQS3 (BBB+-BBB-) 75% 75% - CQS4 (BB+-BB-) 100% 100% - CQS5 (B+-B-) 150% 100% -50pp CQS6 (CCC+/Below) 150% 150% - Unrated 100% 100% -"},{"location":"user-guide/regulatory/comparison/#residential-real-estate","title":"Residential Real Estate","text":"Scenario CRR Basel 3.1 LTV \u2264 50% 35% 20% LTV 50-60% 35% 25% LTV 60-70% 35% 30% LTV 70-80% 35% 40% LTV 80-90% 75% 50% LTV 90-100% 75% 70% LTV &gt; 100% Cpty RW Cpty RW"},{"location":"user-guide/regulatory/comparison/#commercial-real-estate","title":"Commercial Real Estate","text":"Scenario CRR Basel 3.1 LTV \u2264 60%, Income-Producing 100% 70% LTV &gt; 60%, Income-Producing 100% 110%"},{"location":"user-guide/regulatory/comparison/#subordinated-debt","title":"Subordinated Debt","text":"Type CRR Basel 3.1 Subordinated Debt 100-150% 150% Equity-like 150% 250%"},{"location":"user-guide/regulatory/comparison/#credit-conversion-factors","title":"Credit Conversion Factors","text":"Item Type CRR Basel 3.1 Unconditionally Cancellable 0% 10% Other Commitments &lt; 1yr 20% 40% Other Commitments \u2265 1yr 50% 40% Trade Letters of Credit 20% 20% NIFs/RUFs 50% 50% Direct Credit Substitutes 100% 100%"},{"location":"user-guide/regulatory/comparison/#slotting-risk-weights","title":"Slotting Risk Weights","text":""},{"location":"user-guide/regulatory/comparison/#project-finance","title":"Project Finance","text":"Category CRR Basel 3.1 (Pre-Op) Basel 3.1 (Operational) Strong 70% 80% 70% Good 70% 100% 70% Satisfactory 115% 120% 115% Weak 250% 350% 250%"},{"location":"user-guide/regulatory/comparison/#other-specialised-lending","title":"Other Specialised Lending","text":"Category CRR Basel 3.1 Strong 70% 70% Good 70% 70% Satisfactory 115% 115% Weak 250% 250%"},{"location":"user-guide/regulatory/comparison/#hvcre","title":"HVCRE","text":"Category CRR Basel 3.1 Strong 70% 95% Good 70% 120% Satisfactory 115% 140% Weak 250% 250% <p>Note: Under CRR, HVCRE uses the same weights as standard specialised lending (Strong=Good=70%).</p>"},{"location":"user-guide/regulatory/comparison/#impact-analysis","title":"Impact Analysis","text":""},{"location":"user-guide/regulatory/comparison/#low-risk-portfolios-strong-irb-models","title":"Low-Risk Portfolios (Strong IRB Models)","text":"<pre><code>Scenario: High-quality corporate portfolio\n- PD: 0.10%\n- LGD: 40%\n- SA RW equivalent: 80%\n\nCRR:\n- IRB K: ~2%\n- IRB RW: ~25% (after 1.06)\n- Capital saving vs SA: 69%\n\nBasel 3.1:\n- IRB K: ~1.9% (no scaling)\n- IRB RW: ~24%\n- Floor: 80% \u00d7 72.5% = 58%\n- Final RW: 58%\n- Capital saving vs SA: 28%\n</code></pre>"},{"location":"user-guide/regulatory/comparison/#sme-portfolio","title":"SME Portfolio","text":"<pre><code>Scenario: \u00a35m SME exposure, 100% SA RW\n\nCRR:\n- SME Factor: 0.811\n- Effective RW: 81.1%\n- Saving: 18.9%\n\nBasel 3.1:\n- SME Factor: None\n- Effective RW: 100%\n- Saving: 0%\n</code></pre>"},{"location":"user-guide/regulatory/comparison/#infrastructure-project","title":"Infrastructure Project","text":"<pre><code>Scenario: Qualifying infrastructure, 100% SA RW\n\nCRR:\n- Infrastructure Factor: 0.75\n- Effective RW: 75%\n- Saving: 25%\n\nBasel 3.1:\n- Infrastructure Factor: None\n- Effective RW: 100%\n- Saving: 0%\n</code></pre>"},{"location":"user-guide/regulatory/comparison/#configuration-comparison","title":"Configuration Comparison","text":"CRRBasel 3.1 <pre><code>from datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\n\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n    apply_sme_supporting_factor=True,\n    apply_infrastructure_factor=True,\n)\n\n# Internally sets:\n# - scaling_factor: 1.06\n# - output_floor: None\n# - pd_floor: 0.0003 (uniform)\n# - lgd_floors: None\n</code></pre> <pre><code>from datetime import date\nfrom rwa_calc.contracts.config import CalculationConfig\n\nconfig = CalculationConfig.basel_3_1(\n    reporting_date=date(2027, 1, 1),\n    output_floor_percentage=0.725,\n)\n\n# Internally sets:\n# - scaling_factor: 1.0 (none)\n# - output_floor: 72.5%\n# - pd_floors: differentiated by class\n# - lgd_floors: by collateral type\n</code></pre>"},{"location":"user-guide/regulatory/comparison/#summary-of-capital-impact","title":"Summary of Capital Impact","text":"Exposure Type CRR \u2192 Basel 3.1 Impact Low-risk IRB Increase (output floor) SME Increase (factor removal) Infrastructure Increase (factor removal) High LTV Mortgages Decrease (better SA RWs) Low LTV Mortgages Decrease (better SA RWs) High-risk Corporate Decrease (CQS5 reduction) Standard Corporate Neutral"},{"location":"user-guide/regulatory/comparison/#transition-planning","title":"Transition Planning","text":""},{"location":"user-guide/regulatory/comparison/#key-dates","title":"Key Dates","text":"Date Event Sep 2024 PRA PS9/24 published 2025-2026 Parallel running recommended 1 Jan 2027 Basel 3.1 effective 2027-2032 Output floor phase-in"},{"location":"user-guide/regulatory/comparison/#recommended-actions","title":"Recommended Actions","text":"<ol> <li>Impact Assessment: Run calculations under both frameworks</li> <li>Data Quality: Ensure LTV data available for SA RE</li> <li>Model Updates: Review IRB models for floor compliance</li> <li>Process Changes: Update reporting for dual calculation</li> </ol>"},{"location":"user-guide/regulatory/comparison/#next-steps","title":"Next Steps","text":"<ul> <li>CRR Details - Current framework in depth</li> <li>Basel 3.1 Details - Future framework in depth</li> <li>Configuration Guide - Setting up both frameworks</li> </ul>"},{"location":"user-guide/regulatory/crr/","title":"CRR (Basel 3.0)","text":"<p>The Capital Requirements Regulation (CRR) is the current regulatory framework for UK credit risk capital requirements. It implements Basel 3.0 standards and remains in effect until 31 December 2026.</p>"},{"location":"user-guide/regulatory/crr/#legal-basis","title":"Legal Basis","text":"Document Reference Primary Legislation UK CRR (EU 575/2013 as onshored) PRA Rules PRA Rulebook - CRR Firms Key Articles Articles 111-191 (Credit Risk)"},{"location":"user-guide/regulatory/crr/#key-features","title":"Key Features","text":""},{"location":"user-guide/regulatory/crr/#106-scaling-factor","title":"1.06 Scaling Factor","text":"<p>All IRB RWA is multiplied by 1.06 (a 6% increase):</p> <pre><code>RWA_IRB = K \u00d7 12.5 \u00d7 EAD \u00d7 MA \u00d7 1.06\n</code></pre> <p>CRR Article 153</p> <p>The 1.06 scaling factor was introduced to provide a buffer during the transition to IRB approaches. It is removed under Basel 3.1.</p>"},{"location":"user-guide/regulatory/crr/#sme-supporting-factor","title":"SME Supporting Factor","text":"<p>The SME Supporting Factor reduces RWA for qualifying SME exposures.</p> <p>Eligibility Criteria: - Counterparty turnover \u2264 EUR 50m (GBP 44m) - Exposure classified as Corporate, Retail, or Secured by Real Estate</p> <p>Tiered Calculation (CRR2 Article 501):</p> <pre><code>Factor = [min(E, threshold) \u00d7 0.7619 + max(E - threshold, 0) \u00d7 0.85] / E\n</code></pre> <p>Where: - E = Total exposure to the counterparty - Threshold = EUR 2.5m (GBP 2.2m)</p> Exposure Amount Factor Applied \u2264 EUR 2.5m 0.7619 (23.81% reduction) &gt; EUR 2.5m Tiered blend <p>Example:</p> <p>For a GBP 5m exposure: <pre><code>Factor = [2.2m \u00d7 0.7619 + 2.8m \u00d7 0.85] / 5.0m\n       = [1.676m + 2.38m] / 5.0m\n       = 0.811 (18.9% reduction)\n</code></pre></p>"},{"location":"user-guide/regulatory/crr/#infrastructure-supporting-factor","title":"Infrastructure Supporting Factor","text":"<p>A 0.75 factor (25% reduction) applies to qualifying infrastructure project finance:</p> <p>Eligibility Criteria: - Project finance exposure - Exposure to an infrastructure project entity - Revenues predominantly in EUR/GBP or hedged</p> <pre><code>RWA_adjusted = RWA \u00d7 0.75\n</code></pre>"},{"location":"user-guide/regulatory/crr/#uniform-pd-floor","title":"Uniform PD Floor","text":"<p>All IRB exposures have a minimum PD of 0.03% (3 basis points):</p> <pre><code>PD_effective = max(PD_estimated, 0.0003)\n</code></pre>"},{"location":"user-guide/regulatory/crr/#no-output-floor","title":"No Output Floor","text":"<p>CRR does not apply an output floor. IRB RWA can be significantly lower than SA equivalent.</p>"},{"location":"user-guide/regulatory/crr/#risk-weight-tables","title":"Risk Weight Tables","text":""},{"location":"user-guide/regulatory/crr/#sovereign-exposures-sa","title":"Sovereign Exposures (SA)","text":"CQS Risk Weight CQS 1 0% CQS 2 20% CQS 3 50% CQS 4 100% CQS 5 100% CQS 6 150% Unrated 100%"},{"location":"user-guide/regulatory/crr/#institution-exposures-sa","title":"Institution Exposures (SA)","text":"CQS Risk Weight CQS 1 20% CQS 2 30% (UK deviation from 50%) CQS 3 50% CQS 4 100% CQS 5 100% CQS 6 150% Unrated See due diligence approach"},{"location":"user-guide/regulatory/crr/#corporate-exposures-sa","title":"Corporate Exposures (SA)","text":"CQS Risk Weight CQS 1 20% CQS 2 50% CQS 3 75% CQS 4 100% CQS 5 150% CQS 6 150% Unrated 100%"},{"location":"user-guide/regulatory/crr/#retail-exposures-sa","title":"Retail Exposures (SA)","text":"Type Risk Weight Retail - Residential Mortgage (LTV \u2264 80%) 35% Retail - Residential Mortgage (LTV &gt; 80%) Risk-weight varies Retail - QRRE 75% Retail - Other 75%"},{"location":"user-guide/regulatory/crr/#defaulted-exposures-sa","title":"Defaulted Exposures (SA)","text":"Provision Coverage Risk Weight &lt; 20% 150% \u2265 20% 100%"},{"location":"user-guide/regulatory/crr/#credit-conversion-factors-ccf","title":"Credit Conversion Factors (CCF)","text":"Item Type CCF Reference Unconditionally cancellable commitments 0% Art. 111(1)(a) Short-term trade letters of credit 20% Art. 111(1)(b) Undrawn credit facilities 20% Art. 111(1)(c) Note issuance facilities 50% Art. 111(1)(d) Underwriting facilities 50% Art. 111(1)(e) Direct credit substitutes 100% Art. 111(1)(f) Acceptances 100% Art. 111(1)(g)"},{"location":"user-guide/regulatory/crr/#f-irb-supervisory-lgd","title":"F-IRB Supervisory LGD","text":"Exposure Type Senior Unsecured Subordinated Corporate/Institution 45% 75% Secured - Financial Collateral 0% N/A Secured - Receivables 35% N/A Secured - CRE/RRE 35% N/A Secured - Other 40% N/A"},{"location":"user-guide/regulatory/crr/#crm-haircuts","title":"CRM Haircuts","text":""},{"location":"user-guide/regulatory/crr/#financial-collateral-haircuts","title":"Financial Collateral Haircuts","text":"Collateral Type Haircut Cash 0% Government bonds (\u22641y residual) 0.5% Government bonds (1-5y) 2% Government bonds (&gt;5y) 4% Corporate bonds AAA/AA (\u22641y) 1% Corporate bonds AAA/AA (1-5y) 4% Corporate bonds AAA/AA (&gt;5y) 8% Main index equities 15% Other equities 25% Currency mismatch +8%"},{"location":"user-guide/regulatory/crr/#maturity-mismatch-formula","title":"Maturity Mismatch Formula","text":"<p>When collateral maturity &lt; exposure maturity:</p> <pre><code>CRM_adjusted = CRM \u00d7 (t - 0.25) / (T - 0.25)\n</code></pre> <p>Where: - t = Residual maturity of collateral (years, min 0.25) - T = Residual maturity of exposure (years, min 0.25)</p>"},{"location":"user-guide/regulatory/crr/#slotting-risk-weights","title":"Slotting Risk Weights","text":"Category Strong Good Satisfactory Weak Project Finance 70% 90% 115% 250% Object Finance 70% 90% 115% 250% Commodities Finance 70% 90% 115% 250% IPRE 70% 90% 115% 250% HVCRE 95% 120% 140% 250%"},{"location":"user-guide/regulatory/crr/#irb-formulas","title":"IRB Formulas","text":""},{"location":"user-guide/regulatory/crr/#capital-requirement-k","title":"Capital Requirement (K)","text":"<pre><code>K = LGD \u00d7 N[(1-R)^(-0.5) \u00d7 G(PD) + (R/(1-R))^0.5 \u00d7 G(0.999)] - LGD \u00d7 PD\n</code></pre> <p>Where: - N() = Standard normal cumulative distribution - G() = Inverse standard normal distribution - R = Asset correlation</p>"},{"location":"user-guide/regulatory/crr/#asset-correlation-corporate","title":"Asset Correlation (Corporate)","text":"<pre><code>R = 0.12 \u00d7 (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50)) +\n    0.24 \u00d7 [1 - (1 - exp(-50 \u00d7 PD)) / (1 - exp(-50))]\n</code></pre> <p>With SME size adjustment: <pre><code>R_sme = R - 0.04 \u00d7 (1 - (S - 5) / 45)\n</code></pre></p> <p>Where S = Annual turnover (EUR millions, capped at 50)</p>"},{"location":"user-guide/regulatory/crr/#maturity-adjustment","title":"Maturity Adjustment","text":"<pre><code>b = (0.11852 - 0.05478 \u00d7 ln(PD))^2\n\nMA = (1 + (M - 2.5) \u00d7 b) / (1 - 1.5 \u00d7 b)\n</code></pre> <p>Where M = Effective maturity (years, 1-5)</p>"},{"location":"user-guide/regulatory/crr/#configuration-example","title":"Configuration Example","text":"<pre><code>from datetime import date\nfrom decimal import Decimal\nfrom rwa_calc.contracts.config import CalculationConfig\n\nconfig = CalculationConfig.crr(\n    reporting_date=date(2026, 12, 31),\n\n    # SME Supporting Factor\n    apply_sme_supporting_factor=True,\n\n    # Infrastructure Factor\n    apply_infrastructure_factor=True,\n\n    # EUR/GBP rate for threshold conversion\n    eur_gbp_rate=Decimal(\"0.88\"),\n)\n</code></pre>"},{"location":"user-guide/regulatory/crr/#regulatory-references","title":"Regulatory References","text":"Topic Article Exposure classes Art. 112 Risk weight assignment Art. 113-134 IRB approach Art. 142-191 Credit risk mitigation Art. 192-241 SME supporting factor Art. 501 CCFs Art. 111"},{"location":"user-guide/regulatory/crr/#next-steps","title":"Next Steps","text":"<ul> <li>Basel 3.1 - Future framework</li> <li>Framework Comparison - CRR vs Basel 3.1</li> <li>Calculation Methodology - Detailed calculations</li> </ul>"}]}